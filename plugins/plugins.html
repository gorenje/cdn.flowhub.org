
<!-- --- [red-plugin:@gregoriusrippenstein/node-red-contrib-flowhub/flowhub_sidebar] --- -->
<script src="FlowHubLib/jslib/diff.min.js"></script>

<script type="text/javascript">
(function() {
   var globalYourConfigNode = null;
      
   function escapeHtml(e){return String(e).replace(/[&<>"'`=\/]/g,function(e){return entityMap[e]})}function checkToken(e){$("#flowhubpush-check-token-result-content").fadeOut(300,()=>{$.get({url:"https://flowhub.org/integration/token/check?format=json&t="+e}).done(e=>{if(!e.data)return RED.notify("Check failed: "+e.msg,{type:"error",id:"FlowHubTokenCheck",timeout:2e3});RED.notify("FlowHub token is good!",{type:"success",id:"FlowHubTokenCheck",timeout:2e3}),$("#flowhubpush-check-token-result-content").find(".user").attr("href","mailto:"+e.data.email).html(e.data.name),$("#flowhubpush-check-token-result-content").find(".email").html(e.data.email),$("#flowhubpush-check-token-result-content").find(".repo").attr("href",e.data.repo_url).html(e.data.repo),$("#flowhubpush-check-token-result-content").find(".permission").html(e.data.permission),$("#flowhubpush-check-token-result-content").find(".branch").html(e.data.branch),$("#flowhubpush-check-token-result-content").fadeIn(300)}).fail(e=>{RED.notify("Check failed: "+e.msg,{type:"error",id:"FlowHubTokenCheck",timeout:2e3})})})}var entityMap={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"},descMap={z:"Flow Tab Id",g:"Group Id",d:"Disabled"},defaultRevertHandler=(e,t,o)=>{e=RED.nodes.node(e);e&&(e[t]=o,e.dirty=!0,RED.nodes.dirty(!0),RED.view.redraw())},revertableAttributes={},revertableAttributesNames=(["x","y","template","name","info","func","label","tooltip","timeout","repeat"].forEach(function(e){revertableAttributes[e]=defaultRevertHandler}),Object.keys(revertableAttributes));function attrDesc(e){return descMap[e]?" <i style='font-size: 80%;'>("+descMap[e]+")</i>":""}function clickBaitDiff(){$("th.revertable").on("click",e=>{e.preventDefault();var t,o=$($(e.target).parent()).data("attr");confirm('Really revert changes to attribute "'+o+'"?')&&(t=revertableAttributes[o])&&t($($(e.target).parent()).data("id"),o,JSON.parse(atob($($(e.target).parent()).data("oldval"))))})}function createDiff(l,s){var c=[],f=[];try{if(Object.keys(s).forEach(function(e){var t;Object.keys(l).indexOf(e)<0&&(t="object"==typeof s[e]?JSON.stringify(s[e]):s[e],c.push("<tr class='dv-removed'><th>"+e+attrDesc(e)+"</th><td><i>MISSING</i></td><td><code>"+escapeHtml(t)+"</code></td></tr>"),f.push(e))}),Object.keys(l).forEach(function(e){var t;Object.keys(s).indexOf(e)<0&&(t="object"==typeof l[e]?JSON.stringify(l[e]):l[e],c.push("<tr class='dv-added'><th>"+e+attrDesc(e)+"</th><td><code>"+escapeHtml(t)+"</code></td><td><i>ADDED</i></td></tr>"),f.push(e))}),Object.keys(l).forEach(function(n){if(-1<Object.keys(s).indexOf(n))if(JSON.stringify(l[n])!==JSON.stringify(s[n]))try{let o=null,t=void 0;f.push(n);try{t=Diff.diffLines(s[n],l[n])}catch(e){t=Diff.diffLines(JSON.stringify(s[n],void 0,1),JSON.stringify(l[n],void 0,1))}const r=document.createDocumentFragment();t.forEach(e=>{var t=e.added?"green":e.removed?"red":"#040506";(o=document.createElement("pre")).setAttribute("class","dv-pre-elem"),o.style.color=t,o.appendChild(document.createTextNode(e.value)),o.appendChild(document.createElement("br")),r.appendChild(o)});var i=-1<revertableAttributesNames.indexOf(n)?" revertable":"",e=document.createElement("tr");e.setAttribute("class","dv-differ"),e.setAttribute("data-id",l.id),e.setAttribute("data-attr",n);try{e.setAttribute("data-oldval",btoa(JSON.stringify(s[n])))}catch(e){i=""}var a,d=document.createElement("th");d.setAttribute("class",i),d.appendChild(document.createTextNode(n)),descMap[n]&&((a=document.createElement("i")).style["font-size"]="80%",a.appendChild(document.createTextNode("("+descMap[n]+")")),d.appendChild(a)),e.append(d),(d=document.createElement("td")).setAttribute("colspan","2"),d.append(r),e.append(d),c.push(e.outerHTML)}catch(e){console.log("--Exceeption",e),c.push("<tr><th class='dv-error'>"+n+" CAUSED EXCEP</th><td><code>"+escapeHtml(l[n])+"</code></td><td><code>"+escapeHtml(s[n])+"</code></td></tr>")}else c.push("<tr><th>"+n+"</th><td><code>"+escapeHtml(l[n])+"</code></td><td><code>"+escapeHtml(s[n])+"</code></td></tr>")}),0==f.length){let o=null;var e="OBJ",t=Diff.diffJson(s,l);const d=document.createDocumentFragment();t.forEach(e=>{var t=e.added?"green":e.removed?"red":"#040506";(o=document.createElement("pre")).setAttribute("class","dv-pre-elem"),o.style.color=t,o.appendChild(document.createTextNode(e.value)),o.appendChild(document.createElement("br")),d.appendChild(o)});var n,i=document.createElement("tr"),a=(i.setAttribute("class","dv-differ"),document.createElement("th"));return a.appendChild(document.createTextNode(e)),descMap[e]&&((n=document.createElement("i")).style["font-size"]="80%",n.appendChild(document.createTextNode("("+descMap[e]+")")),a.appendChild(n)),i.append(a),(a=document.createElement("td")).setAttribute("colspan","2"),a.append(d),i.append(a),{html:i.outerHTML,icon:"fa-question"}}}catch(e){console.log("Exception",e)}var o=["x","y","w","h","g"];return{html:c.join(""),icon:0==f.filter(e=>o.indexOf(e)<0).length?"fa-eye":"fa-pencil"}}function getInstalledNodeDetails(e){$.ajax({url:"nodes",headers:{Accept:"application/json"},success:e,error:()=>{e(["error"])}})}function doTokenCheck(e,t){$.ajax({url:"FlowHubTokenCheck",type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify({cfgnode:e}),success:function(e){t(e)},error:function(e,t,o){RED.notify("Check failed: "+t,{type:"error",id:"FlowHubTokenCheck",timeout:2e3})}})}function doPushSubmission(e,t,o,n){var i=RED.workspaces.active();let a=e.map(e=>e.type);n=n.filter(e=>-1<a.indexOf(e.types[0])),$.ajax({url:"FlowHubPush",type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify({flowid:i,flowdata:e||{},flowlabel:RED.nodes.workspace(i).label,cfgnode:t,svgdata:o,nodedetails:n}),success:function(e){RED.notify("Submission triggered",{type:"warning",id:"FlowHubPush",timeout:2e3}),obtainFhbToken(obtainConfigNode(),e=>{""!==e&&(e=e&&"?t="+tokenToUrl(e)),$("#flowhubpush-view-flow-link").attr("href","https://flowhub.org/f/"+i+e).show()})},error:function(e,t,o){RED.notify("Submission failed: "+t,{type:"error",id:"FlowHubPush",timeout:2e3}),console.log(t,o)}})}function getFlowDataFromCurrentWorkspace(e){var e=e||RED.workspaces.active(),t=RED.nodes.groups(e),e=(t=(t=t.concat(RED.nodes.junctions(e))).concat(RED.nodes.filterNodes({z:e})),RED.nodes.eachConfig(function(e){e.z===RED.workspaces.active()&&!1===e._def.hasUsers&&t.push(e)}),RED.nodes.workspace(e)||RED.nodes.subflow(e));return t.unshift(e),RED.nodes.createExportableNodeSet(t)}function iframeRemoveHighlight(){document.getElementById("flowhubdiff-svgimageiframe").contentWindow.postMessage({msg:"removehighlight"},"*")}function iframeHighlightItem(e){iframeRemoveHighlight(),document.getElementById("flowhubdiff-svgimageiframe").contentWindow.postMessage({item:{label:e.label,icon:e.icon,class:e.class,sublabel:e.sublabel,objid:e.objid},msg:"highlightitem"},"*")}function iframeHasBeenLoaded(e){let t=$(e).data("flowid");var o=getFlowDataFromCurrentWorkspace(t);setTimeout(()=>{e.contentWindow&&e.contentWindow.postMessage({nodes:o,msg:"renderlocalflow",flowid:t||RED.workspaces.active()},"*")},345)}function doComparison(e,t){var n=RED.workspaces.active();if(RED.nodes.workspace(n))RED.notify("Flow Comparison Triggered",{type:"warning",id:"FlowHubDiff",timeout:2e3}),$.ajax({url:"FlowHubDiff",type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify({flowid:n,flowhub:"submission from ",flowdata:e||{},flowlabel:RED.nodes.workspace(n).label,cfgnode:t}),success:function(t){var e,d=[],r={};if("failed"==t.status){RED.notify(t.msg||"This does not seem to be a FlowHub flow id: "+n,{type:"error",timeout:2e3}),$("#flowhubdiff-view-flow-link").hide();try{$("#node-input-flowhubdiff-diffcontainer").html(""),$("#node-input-flowhubdiff-svgcontainer").html(""),$("#node-input-flowhubdiff-target-container-div").treeList("empty")}catch(e){}}else if(t.revision&&""!=t.revision&&(e=ensureYourConfigNodeExists()).flowrevisions&&e.flowrevisions[t.flowid]&&e.flowrevisions[t.flowid].substr(0,8)!=t.revision.substr(0,8)&&RED.notify(`WARNING: Revision mismatch: Local: ${e.flowrevisions[t.flowid].substr(0,8)}, Remote: `+t.revision.substr(0,8),{type:"warning",timeout:4e3}),obtainFhbToken(obtainConfigNode(),e=>{(""!==e&&e?$("#flowhubdiff-view-flow-link").attr("href","https://flowhub.org/f/"+t.flowid+"?t="+tokenToUrl(e)):$("#flowhubdiff-view-flow-link").attr("href","https://flowhub.org/f/"+t.flowid)).show()}),t.changes.forEach(function(e){var t,o,n,i,a=e.id;"deleted"==e.type?(r[a]={label:e.oldObj.name||e.oldObj.type,icon:"fa fa-trash",class:"",diffcontent:createDiff({},e.oldObj).html,sublabel:e.oldObj.type,selected:!1,checkbox:!1,children:void 0,objid:a},d.push(r[a])):"added"==e.type?(r[a]={objid:a,label:e.newObj.name||e.newObj.type,icon:"fa fa-plus-square",class:"",diffcontent:createDiff(e.newObj,{}).html,sublabel:e.newObj.type,selected:!1,checkbox:!1,children:void 0},d.push(r[a])):"tab"==e.oldObj.type||"group"==e.oldObj.type||"junction"==e.oldObj.type?(i=createDiff(e.newObj,e.oldObj),r[a]={objid:a,label:e.oldObj.name||e.oldObj.type,icon:"fa "+i.icon,class:"",diffcontent:i.html,sublabel:e.type+" - "+e.oldObj.type,selected:!1,checkbox:!1,children:void 0},d.push(r[a])):(t=RED.nodes.node(a))?((o=RED.nodes.getType(t.type))&&(n=("function"==typeof(n=o.label)?n.call(t):n)||""),o&&n||(n=t.type),i=createDiff(e.newObj,e.oldObj),r[t.id]={node:t,objid:a,label:n,icon:"fa "+i.icon,class:"",diffcontent:i.html,sublabel:e.oldObj.type,selected:!1,checkbox:!1,children:void 0},d.push(r[t.id])):console.log("Node ignore, Type: "+e.type,e)}),t.ifurl&&$("#node-input-flowhubdiff-svgcontainer").html('<iframe id="flowhubdiff-svgimageiframe" width="100%" height="100%" src="'+t.ifurl+'" onload="window.iframeHasBeenLoaded(this)" style="border: none; min-height: 300px;" data-flowid="'+n+'"></iframe>'),0==d.length){RED.notify("No Flow Changes",{type:"warning",timeout:2e3});try{$("#node-input-flowhubdiff-diffcontainer").html(""),$("#node-input-flowhubdiff-target-container-div").treeList("empty")}catch(e){}}else{try{$("#node-input-flowhubdiff-target-container-div").treeList("empty")}catch(e){$("#node-input-flowhubdiff-target-container-div").css({width:"100%",height:"200px"}).treeList({multi:!1}).on("treelistitemmouseover",function(e,t){t.objid&&iframeHighlightItem(t)}).on("treelistitemmouseout",function(e,t){}).on("treelistselect",function(e,t){t.objid&&(RED.view.reveal(t.objid,!0),RED.view.redraw()),t.diffcontent?($("#node-input-flowhubdiff-diffcontainer").html(t.diffcontent),clickBaitDiff()):$("#node-input-flowhubdiff-diffcontainer").html("")}).on("treelistconfirm",function(e,t){var o;t.objid&&(o=t.objid,setTimeout(()=>{var e=RED.nodes.node(o);e&&(RED.view.reveal(e.id),RED.view.select(e.id),RED.editor.edit(e)),o==RED.workspaces.active()&&RED.workspaces.edit()},50))}),$("#node-input-flowhubdiff-target-filter").show();var o=$("#node-input-flowhubdiff-target-filter").searchBox({style:"compact",delay:300,change:function(){var e,t=$(this).val().trim().toLowerCase();""===t?($("#node-input-flowhubdiff-target-container-div").treeList("filter",null),o.searchBox("count","")):(e=$("#node-input-flowhubdiff-target-container-div").treeList("filter",function(e){return-1<e.label.toLowerCase().indexOf(t)||-1<e.node.type.toLowerCase().indexOf(t)}),o.searchBox("count",e+" / "+$("#node-input-flowhubdiff-target-container-div").treeList("data").length))}})}$("#node-input-flowhubdiff-target-container-div").treeList("data",d.sort((e,t)=>e.icon==t.icon?e.label.toLowerCase()>t.label.toLowerCase():e.icon>t.icon))}},error:function(e,t,o){$("#flowhubdiff-view-flow-link").hide();try{$("#node-input-flowhubdiff-diffcontainer").html(""),$("#node-input-flowhubdiff-svgcontainer").html(""),$("#node-input-flowhubdiff-target-container-div").treeList("empty")}catch(e){}404==e.status?RED.notify("Node has not yet been deployed, please deploy.","error"):405==e.status?RED.notify("Not Allowed.","error"):500==e.status?RED.notify("Not Allowed - 500.","error"):0==e.status?RED.notify("Not Allowed - 0.","error"):RED.notify("Not Allowed - Unexpected.","error")}});else{RED.notify("Comparing subflows not supported.",{type:"error",id:"FlowHubDiff",timeout:2e3}),$("#flowhubdiff-view-flow-link").hide();try{$("#node-input-flowhubdiff-diffcontainer").html(""),$("#node-input-flowhubdiff-svgcontainer").html(""),$("#node-input-flowhubdiff-target-container-div").treeList("empty")}catch(e){}}}function addTokenToList(e,t){$("#node-input-flowhubpush-token-list").append(`<tr class='${e}' data-type='${t.type}' data-name='${t.name}' data-token='${t.val}'>`+`<td><a class='flowhubpush-token-select-link' href='#'>${t.name}</a></td>`+"<td><a class='flowhubpush-token-select-link button' href='#'>Use</a></td><td><a class='flowhubpush-token-remove-link button' href='#'>Remove</a></td><td><a class='flowhubpush-token-hide-link button' href='#'>Hide</a></td><td><a class='flowhubpush-token-check-link button' href='#'>Check</a></td><td><a class='flowhubpush-token-copy-link button' href='#'>Copy</a></td></tr>")}function addEventHandlersToTokenList(n){$(".flowhubpush-token-copy-link").off("click"),$(".flowhubpush-token-copy-link").on("click",e=>{RED.clipboard.copyText($($(e.target).closest("tr")).data("token"))&&RED.notify("Token copied","success")}),$(".flowhubpush-token-check-link").off("click"),$(".flowhubpush-token-check-link").on("click",e=>{checkToken($($(e.target).closest("tr")).data("token"))}),$(".flowhubpush-token-hide-link").off("click"),$(".flowhubpush-token-hide-link").on("click",e=>{e&&e.preventDefault();let t=$($(e.target).closest("tr"));$($(e.target).closest("tr")).fadeOut(300,()=>{RED.notify("Hidden token <b>"+t.data("name")+"</b>, will reappear with reload","success")})}),$(".flowhubpush-token-remove-link").off("click"),$(".flowhubpush-token-remove-link").on("click",e=>{e&&e.preventDefault();let t=$($(e.target).closest("tr")),o=n;confirm(`Remove token "${t.data("name")}"?`)&&$($(e.target).closest("tr")).fadeOut(300,()=>{o.tokens=o.tokens.filter(e=>!(e.name==t.data("name")&&e.val==t.data("token")&&e.type==t.data("type"))),RED.nodes.dirty(!0),RED.notify("Removed token <b>"+t.data("name")+"</b>.","success")})}),$(".flowhubpush-token-select-link").off("click"),$(".flowhubpush-token-select-link").on("click",e=>{e&&e.preventDefault();e=$($(e.target).closest("tr"));$(".flowhub-token-selected").removeClass("flowhub-token-selected"),$("#node-input-flowhubpush-apiToken").typedInput("value",e.data("token")),$("#node-input-flowhubpush-apiToken").typedInput("type",e.data("type")),e.addClass("flowhub-token-selected"),RED.notify("Using token <b>"+e.data("name")+"</b>","success")})}window.iframeHasBeenLoaded=iframeHasBeenLoaded;

   function nr_intro_generate_svg_4_0(n){return t=>{try{handleSvgObject($($("#red-ui-workspace-chart").find("svg")[0]),t)}catch(e){var r="Error Generating SVG: "+JSON.stringify(e);n.notify(r,{type:"error"}),t('<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg width="1000" height="1000" viewBox="0 0 1000 1000" pointer-events="all" style="cursor: crosshair; touch-action: none;" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><style>.small { font: bold 20px sans-serif; fill: red;}</style><text x="10" y="30" class="small">'+r+"</text></svg>")}}}function nr_intro_generate_svg_3_1(n){return t=>{try{handleSvgObject($($("#red-ui-workspace-chart").find("svg")[0]),t)}catch(e){var r="Error Generating SVG: "+JSON.stringify(e);n.notify(r,{type:"error"}),t('<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg width="1000" height="1000" viewBox="0 0 1000 1000" pointer-events="all" style="cursor: crosshair; touch-action: none;" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><style>.small { font: bold 20px sans-serif; fill: red;}</style><text x="10" y="30" class="small">'+r+"</text></svg>")}}}function nr_intro_generate_svg_3_0(n){return t=>{try{handleSvgObject($($("svg")[0]),t)}catch(e){var r="Error Generating SVG: "+JSON.stringify(e);n.notify(r,{type:"error"}),t('<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg width="1000" height="1000" viewBox="0 0 1000 1000" pointer-events="all" style="cursor: crosshair; touch-action: none;" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><style>.small { font: bold 20px sans-serif; fill: red;}</style><text x="10" y="30" class="small">'+r+"</text></svg>")}}}function handleSvgObject(o,t){o.find("g.red-ui-flow-group-selected").removeClass("red-ui-flow-group-selected"),o.find("rect.red-ui-flow-group-outline-select").css("stroke-opacity","0"),o.find(".red-ui-flow-node-selected").removeClass("red-ui-flow-node-selected"),o.find(".red-ui-flow-link-selected").removeClass("red-ui-flow-link-selected");var e=o.clone(),r=(e.find("foreignObject").remove(),e.find("svg.__screenshot").remove(),'width="'+o.attr("width")+'" height="'+o.attr("height")+'"'),n=RED.settings.version.split("."),s=parseInt(n[0]),n=parseInt(n[1]);if(3==s&&1==n||4==s&&0==n){var i=$($($(o).children("g")[0]).children("g")[0]).children("g"),a={x:8e3,y:8e3,w:-1,h:-1};for(let e=1;e<i.length;e++){var l=i[e].getBBox();0==l.width&&0==l.height||(a.x=Math.min(l.x,a.x),a.y=Math.min(l.y,a.y),a.w=Math.max(l.width,a.w),a.h=Math.max(l.height,a.h))}r+=` viewBox='${a.x} ${a.y} ${a.w} ${a.h}'`}function g(e,t){for(var r=0;r<e.length;r++){var s=e.item(r),i=t[r];["stroke-width","fill-opacity","stroke-opacity","opacity","stroke-dasharray"].forEach(function(e){s.setAttribute(e,$(i).attr(e)||$(i).css(e))}),["fill","stroke"].forEach(function(e){var t,r,n=(t=$(i).attr(e)||$(i).css(e))&&null!==t&&"none"!=t?(r=t.match(/^#(.)(.)(.)$/))?"#"+r[1]+r[1]+r[2]+r[2]+r[3]+r[3]:(r=t.match(/^#......$/))?t:null===(r=t.match(/^rgb\(([0-9]+),\s+([0-9]+),\s+([0-9]+)/))?(n=t.match(/^rgba\(([0-9]+),\s+([0-9]+),\s+([0-9]+),\s+([0-9]+)/))?{clr:"#"+("0"+parseInt(n[1],10).toString(16)).slice(-2)+("0"+parseInt(n[2],10).toString(16)).slice(-2)+("0"+parseInt(n[3],10).toString(16)).slice(-2),opa:n[4]}:(console.log("Screenshot node: returned unknown color: "+t),t):"#"+("0"+parseInt(r[1],10).toString(16)).slice(-2)+("0"+parseInt(r[2],10).toString(16)).slice(-2)+("0"+parseInt(r[3],10).toString(16)).slice(-2):"none";"object"==typeof n?(s.setAttribute(e+"-opacity",n.opa),s.setAttribute(e,n.clr)):s.setAttribute(e,n)}),$(i).hasClass("hide")&&("g"==s.tagName&&s.setAttribute("opacity","0"),s.setAttribute("visibility","hidden"))}}var s='<?xml version="1.0" standalone="no"?>\r\n<svg '+r+' pointer-events="all" style="cursor: crosshair; touch-action: none;" xmlns="http://www.w3.org/2000/svg" class="__screenshot" xmlns:xlink="http://www.w3.org/1999/xlink">\r\n',n=e.html(),c=(new DOMParser).parseFromString(s+n+"\r\n</svg>","image/svg+xml"),h=t=>(["g","rect","line","path","circle","image","text"].forEach(e=>{$(t.getElementsByTagName(e)).each((e,t)=>{t.setAttribute("class",""),t.setAttribute("id","")})}),t),f=(["g","rect","line","path","circle","image"].forEach(function(e){g(c.getElementsByTagName(e),o.find(e))}),["text"].forEach(function(e){g(c.getElementsByTagName(e),o.find(e));for(var t=c.getElementsByTagName(e),r=o.find(e),n=0;n<t.length;n++){var s=t.item(n),i=r[n];["font-family","font-size","font-size-adjust","font-stretch","font-style","font-variant","font-weight","text-anchor","dominant-baseline"].forEach(function(e){s.setAttribute(e,$(i).attr(e)||$(i).css(e))})}}),c.getElementsByTagName("image")),v={},d=(r,n,s)=>{var i=r.getAttribute("xlink:href")||r.getAttribute("href");if(!i)return s(n-1);var o=i.substr(-4,4).toLowerCase(),a={".jpg":"jpeg",jpeg:"jpeg",".png":"png",".svg":"svg+xml"};if(v[i])return r.setAttribute("xlink:href","data:image/"+a[o]+";base64,"+v[i]),s(n-1);switch(o){case".jpg":case"jpeg":case".png":var l=new XMLHttpRequest;l.open("GET",i,!0),l.responseType="arraybuffer";l.onload=function(e){var t=l.response;t&&(t=(e=>{for(var t="",r=new Uint8Array(e),n=r.byteLength,s=0;s<n;s++)t+=String.fromCharCode(r[s]);return window.btoa(t)})(t),v[i]=t,r.setAttribute("xlink:href","data:image/"+a[o]+";base64,"+t)),s(n-1)},l.send(null);break;case".svg":$.get(i,function(e){var t=new XMLSerializer,t=btoa(t.serializeToString(e));v[i]=t,r.setAttribute("xlink:href","data:image/svg+xml;base64,"+t),s(n-1)})}},w=e=>{e<0?t((new XMLSerializer).serializeToString(h(c))):d(f.item(e),e,w)};0<f.length?d(f.item(f.length-1),f.length-1,w):t((new XMLSerializer).serializeToString(h(c)))}function svgGeneratorFunctionForVersion(e){var r,t=e.settings.version.split("."),n=t[0],t=t[1];if("3"==n){if("0"==t)return nr_intro_generate_svg_3_0(e);if("1"==t)return nr_intro_generate_svg_3_1(e)}return"4"==n&&"0"==t?nr_intro_generate_svg_4_0(e):(r=e,e=>{var t="Node-RED version ("+r.settings.version+") not supported";r.notify(t,{type:"error"}),e&&e('<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg width="1000" height="1000" viewBox="0 0 1000 1000" pointer-events="all" style="cursor: crosshair; touch-action: none;" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><style>.small { font: bold 20px sans-serif; fill: red;}</style><text x="10" y="30" class="small">'+t+"</text></svg>")})}
   
   function ensureYourConfigNodeExists() {
      // If we had found it previously, check if it has been deleted by the user behind our back
      if (globalYourConfigNode !== null) {
         var configNode = RED.nodes.node(globalYourConfigNode.id);
         if (configNode === null) { globalYourConfigNode = null; }
      }

      // If not found previously, let's go find it
      if (globalYourConfigNode === null) {
         var configNodes = [];
         RED.nodes.eachConfig(function(configNode) {
             if (configNode.type === 'FlowHubCfg') { 
                 configNodes.push(configNode); 
             }
         });

         // Make sure we only have 1 config node
         while (configNodes.length > 1) {
             var configNode = configNodes.pop();
             RED.nodes.remove(configNode.id);
             RED.nodes.dirty(true);
         }

         // When we found a config node, let's use that one
         if (configNodes.length === 1) { globalYourConfigNode = configNodes[0]; }
      }

      // When it doesn't exist yet, create it if required
      if (globalYourConfigNode === null) {

         let typ = RED.nodes.getType("FlowHubCfg");
         
         globalYourConfigNode = {
            id: RED.nodes.id(), // on the server side, this is called RED.util.generateId()
            _def: typ,
            type: "FlowHubCfg",
            hasUsers: false, 
            users: [],
            name: "FlowHubCfg",
            label: function() { return this.name || "FlowHubCfg"},
            /* default data */
            apiToken: typ.defaults.apiToken.value,
            apiTokenType: typ.defaults.apiTokenType.value,
            email: "",
            fullname: "",
            flowid: "",
            flowrevision: "",
            notab: false,
            pushcomment: "",
            pushnewflows: false,
            tokens: typ.defaults.tokens.value,
            flowrevisions: typ.defaults.flowrevisions.value,
            forcepush: false
         }

         // Add the new config node to the collection of Node-RED nodes
         RED.nodes.add(globalYourConfigNode);

         // Make sure the "Deploy" button becomes active
         RED.nodes.dirty(true);
      }    
      
      return globalYourConfigNode
   }

   function flowHubPullUpdateFlows(e=null,o=null){let t=t=>{if("failed"==t.status)return RED.notify(t.msg,{type:"error",id:"FlowHubPull",timeout:4e3});let i=[],r={},l=[];Object.keys(t.data).forEach(function(e){var o=t.data[e].name.match(/^(\[.+\])/);o?r[o[0]]?r[o[0]].push(t.data[e]):r[o[0]]=[t.data[e]]:l.push(t.data[e])}),Object.keys(r).sort((e,o)=>e<o?-1:1).forEach(e=>{var o=r[e].map(e=>({label:e.name,icon:"fa "+(RED.nodes.workspace(e.id)?"fa-check-circle-o":""),flowid:e.id,sublabel:e.id,selected:$("#node-input-flowhubpull-flowid").val()==e.id,checkbox:!1,children:void 0}));i.push({label:e,icon:"",flowid:"",sublabel:"",selected:!1,checkbox:!1,children:o.sort((e,o)=>e.label<o.label?-1:1)})}),l.sort((e,o)=>e.name<o.name?-1:1).forEach(e=>{i.push({label:e.name,icon:"fa "+(RED.nodes.workspace(e.id)?"fa-check-circle-o":""),flowid:e.id,sublabel:e.id,selected:$("#node-input-flowhubpull-flowid").val()==e.id,checkbox:!1,children:void 0})}),e&&e(i)};$.get({url:"https://api.flowhub.org/v1/flows?cb="+(new Date).getTime(),headers:{"X-FHB-TOKEN":o}}).done(e=>{t(e)}).fail(e=>{var i="";"rejected"==e.state()?$.ajax({url:"FlowHubCatalogue",type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify({token:o}),success:function(e){t(e)},error:function(e,o,t){i="<p>Failed to retrieve FlowHub catalogue, request blocked.</p><p>Request: <b>https://api.flowhub.org/v1/flows</b></p><p>AdBlocker or uBlock might have prevented request.</p><p>Please check browser console for more details.</p>",console.log("Error",o),RED.notify(i,{type:"error",id:"FlowHubPull",timeout:4e3})}}):(i="<p>Failed to retrieve FlowHub catalogue.</p><p>Check browser console for more details.</p>",console.warn("Error loading https://api.flowhub.org/v1/flows:",e),RED.notify(i,{type:"error",id:"FlowHubPull",timeout:4e3}))})}function obtainConfigNode(){let o=[];return RED.nodes.eachConfig(function(e){"FlowHubCfg"===e.type&&o.push(e)}),o[0]}function tokenToUrl(e){e=e.substring(4);var o="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-_".split("");let t=Object.fromEntries(o.map((e,o)=>[e,o])),i=Object.fromEntries(o.map((e,o)=>[o,e]));return e.replaceAll(/./gi,(e,o)=>i[(t[e]+o+1)%64])}function obtainFhbToken(e,i){$.ajax({url:"FlowHubToken",type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify({cfgnode:e}),success:function(e){i(e.token)},error:function(e,o,t){i("")}})}function doFlowImportForSidebar(i,e){RED.notify("Pull triggered",{type:"warning",timeout:3e3}),$.get({url:"https://api.flowhub.org/v3/flows/"+$("#node-input-flowhubpull-flowid").val().trim()+"?cb="+(new Date).getTime()+"&v="+$("#node-input-flowhubpull-flowrevision").val().trim(),headers:{"X-FHB-TOKEN":e,"User-Agent":"FlowHub.org Sidebar"}}).done((o,e)=>{try{if(!o||!o.flowdata||!Array.isArray(JSON.parse(o.flowdata)))return RED.notify("Access denied or revision not found.",{type:"error",timeout:3e3})}catch(e){return RED.notify("Access Denied, parse error.",{type:"error",timeout:3e3})}var t;RED.nodes.workspace(o.flowid)||((t=ensureYourConfigNodeExists()).flowrevisions||={},t.flowrevisions[o.flowid]!=o.revision&&(t.flowrevisions[o.flowid]=o.revision,RED.nodes.dirty(!0))),RED.clipboard.import(),setTimeout(()=>{var e=JSON.parse(o.flowdata);i&&(e=e.filter(function(e){return"tab"!=e.type})),$("#red-ui-clipboard-dialog-import-text").val(JSON.stringify(e)).trigger("paste")},300)}).fail(e=>{var o="<p>Failed to retrieve flow data from FlowHub, request blocked.</p><p>Request: https://api.flowhub.org/v3/flows/"+$("#node-input-flowhubpull-flowid").val().trim()+"</p><p>AdBlocker or uBlock might have prevented request.</p><p>Please check browser console for more details.</p>";RED.notify(o,{type:"error",id:"FlowHubPull",timeout:4e3})})}function doFlowImportForPullNode(e,o){RED.notify("Pull triggered",{type:"warning",timeout:3e3});$.get({url:"https://api.flowhub.org/v3/flows/"+$("#node-input-flowid").val().trim()+"?cb="+(new Date).getTime()+"&v="+$("#node-input-flowrevision").val().trim(),headers:{"X-FHB-TOKEN":o,"User-Agent":"FlowHub.org Pull Node"}}).done((o,e)=>{try{if(!o||!o.flowdata||!Array.isArray(JSON.parse(o.flowdata)))return RED.notify("Access denied or revision not found.",{type:"error",timeout:3e3})}catch(e){return RED.notify("Access Denied, parse error.",{type:"error",timeout:3e3})}var t;RED.nodes.workspace(o.flowid)||(t=(()=>{let o=void 0;return RED.nodes.eachConfig(function(e){"FlowHubCfg"===e.type&&(o=e)}),o})())&&(t.flowrevisions||={},t.flowrevisions[o.flowid]!=o.revision)&&(t.flowrevisions[o.flowid]=o.revision,RED.nodes.dirty(!0)),RED.clipboard.import(),setTimeout(()=>{var e=JSON.parse(o.flowdata);$("#red-ui-clipboard-dialog-import-text").val(JSON.stringify(e)).trigger("paste")},300)}).fail(e=>{var o="<p>Failed to retrieve flow data from FlowHub, request blocked.</p><p>Request: https://api.flowhub.org/v3/flows/"+$("#node-input-flowhubpull-flowid").val().trim()+"</p><p>AdBlocker or uBlock might have prevented request.</p><p>Please check browser console for more details.</p>";RED.notify(o,{type:"error",id:"FlowHubPull",timeout:4e3})})}function checkForDuplication(e){$.get({url:"https://api.flowhub.org/v1/flows/"+$("#node-input-flowhubpull-flowid").val()+"?cb="+(new Date).getTime()+"&v="+$("#node-input-flowhubpull-flowrevision").val(),headers:{"X-FHB-TOKEN":e}},function(e,o){let t=[];if(!Array.isArray(e))return RED.notify("Access denied or revision not found.","error");if(e.forEach((e,o)=>{"tab"==e.type?RED.nodes.workspace(e.id)&&t.push(e):"junction"==e.type?RED.nodes.junction(e.id)&&t.push(e):"group"==e.type?RED.nodes.group(e.id)&&t.push(e):"subflow"==e.type?RED.nodes.subflow(e.id)&&t.push(e):RED.nodes.node(e.id)&&t.push(e)}),0==t.length){RED.notify("Found no duplication.","success");try{$("#node-input-flowhubpull-sb-duplication-container-div").treeList("empty")}catch(e){}}else{RED.notify("Found "+t.length+" items of duplication","warning");try{$("#node-input-flowhubpull-sb-duplication-container-div").treeList("empty")}catch(e){$("#node-input-flowhubpull-sb-duplication-container-div").css({width:"100%",height:"calc(100%)"}).treeList({multi:!1}).on("treelistitemmouseover",function(e,o){}).on("treelistitemmouseout",function(e,o){}).on("treelistselect",function(e,o){o.node&&(RED.workspaces.show(o.node.z,!1,!1,!0),RED.view.reveal(o.node.id,!0),RED.view.redraw())}).on("treelistconfirm",function(e,o){var t;o.node&&(t=o.node.id,setTimeout(()=>{var e=RED.nodes.node(t);e&&(RED.view.reveal(e.id),RED.view.select(e.id),RED.editor.edit(e)),t==RED.workspaces.active()&&RED.workspaces.edit()},50))})}t=t.map(e=>({node:e,label:e.id,sublabel:e.type,selected:!1,checkbox:!1})),$("#node-input-flowhubpull-sb-duplication-container-div").treeList("data",t)}})}

   // Add your plugin as a new tabsheet in the right sidebar AFTER the flow editor is completely started
   var initialiseConfigNodeOnce = () => {
      RED.events.off('runtime-state', initialiseConfigNodeOnce);

      // The html content of the sidebar has been specified below as a data-template, from where it can be loaded:
      var content = $($('script[type="text/x-red"][data-template-name="FlowHubDiff"]').i18n().html());
    
      // Add a "Your sidebar" tabsheet to the right sidebar panel, in which this sidebar panel can be displayed
      // --> more details: https://nodered.org/docs/api/ui/sidebar/
      RED.sidebar.addTab({
         id: "FlowHubDiff",
         label: "FlowHub", // short name for the tab
         name: "FlowHub.org", // long name for the menu
         content: content,
         enableOnEdit: true,
         iconClass: "fa fa-window-minimize",
         visible: true
      });
      
      let cfgNode = ensureYourConfigNodeExists();

      /* for older config nodes, add new parameters */
      if ( cfgNode.forcepush == undefined) {
        cfgNode.forcepush = false
        RED.nodes.dirty(true)
      }
      if ( cfgNode.pushnewflows == undefined) {
        cfgNode.pushnewflows = false
        RED.nodes.dirty(true)
      }
      if ( cfgNode.tokens == undefined) {
        cfgNode.tokens = []
        RED.nodes.dirty(true)
      }
      if ( cfgNode.flowrevisions == undefined ) {
        cfgNode.flowrevisions = {}
        RED.nodes.dirty(true)
      }

      var tabs = RED.tabs.create({
            id: 'func-flowhub-tabs',
            onchange: function(tab) {
               $('#func-flowhub-tabs-content').children().hide();
               $('#' + tab.id).show();
            }
      });
      
      // Add first tab, pull
      tabs.addTab({
            id: 'func-flowhub-tab-pull',
            iconClass: 'fa fa-arrow-down',
            label: 'Pull'
      });

      // Add first tab, compare
      tabs.addTab({
            id: 'func-flowhub-tab-compare',
            iconClass: 'fa fa-clone',
            label: 'Compare'
      });
      
      // Add tab, push
      tabs.addTab({
            id: 'func-flowhub-tab-push',
            iconClass: 'fa fa-arrow-up',
            label: 'Push'
      });
      
      tabs.activateTab("func-flowhub-tab-pull");

      $('#node-input-flowhubdiff-compare-btn').on('click', (e) => {
         e.preventDefault();
         ensureYourConfigNodeExists();
         doComparison( getFlowDataFromCurrentWorkspace(), globalYourConfigNode)
      })

      $('#node-input-flowhubpush-push-btn').on('click', (e) => {
         if ( e ) { e.preventDefault(); }
         ensureYourConfigNodeExists();

         RED.notify("Preparing Submission", {
            type: "warning",
            id: "FlowHubPush",
            timeout: 2000
         });

         globalYourConfigNode.pushcomment = $('#node-input-flowhubpush-comment').val();

         svgGeneratorFunctionForVersion(RED)( (svgdata) => {
            getInstalledNodeDetails( (nodedetails) => {
               doPushSubmission(getFlowDataFromCurrentWorkspace(), globalYourConfigNode, svgdata, nodedetails)
            })
         });
      });

      if ( !globalYourConfigNode.tokens ) {
        globalYourConfigNode.tokens = []
        RED.nodes.dirty()
      }

      globalYourConfigNode.tokens.forEach( tk => {
        addTokenToList((tk.val == globalYourConfigNode.apiToken ? "flowhub-token-selected" : ""), tk)
      })
      addEventHandlersToTokenList(globalYourConfigNode)

      $("#node-input-flowhubpush-apiToken").typedInput({
          types:["env", "global", "cred"],
          typeField: "#node-input-flowhubpush-apiTokenType"
      });

      $("#node-input-flowhubpush-apiToken").typedInput( 'value', globalYourConfigNode.apiToken || globalYourConfigNode._def.defaults.apiToken.value );
      $("#node-input-flowhubpush-apiToken").typedInput( 'type', globalYourConfigNode.apiTokenType || globalYourConfigNode._def.defaults.apiTokenType.value);

      $("#node-input-flowhubpush-apiToken").on('change', () => {
         ensureYourConfigNodeExists();
         
         var val = $("#node-input-flowhubpush-apiToken").typedInput('value');
         var typ = $("#node-input-flowhubpush-apiToken").typedInput('type');

         if ( val != globalYourConfigNode.apiToken ) {
            globalYourConfigNode.apiToken = val;
            RED.nodes.dirty(true);
         }

         if ( typ != globalYourConfigNode.apiTokenType ) {
            globalYourConfigNode.apiTokenType = typ;
            RED.nodes.dirty(true);
         }
      })

      $('#node-input-flowhubpush-email').on('change', (e) => {
         if ( e ) { e.preventDefault(); }
         ensureYourConfigNodeExists();

         let val = $('#node-input-flowhubpush-email').val();
         if ( val != globalYourConfigNode.email ) { 
            globalYourConfigNode.email = val;
            RED.nodes.dirty(true);
         }
      })
      $('#node-input-flowhubpush-email').val(globalYourConfigNode.email)

      $('#node-input-flowhubpush-fullname').on('change', (e) => {
         if ( e ) { e.preventDefault(); }
         ensureYourConfigNodeExists();

         let val = $('#node-input-flowhubpush-fullname').val();
         if ( val != globalYourConfigNode.fullname ) { 
            globalYourConfigNode.fullname = val;
            RED.nodes.dirty(true);
         }
      })
      $('#node-input-flowhubpush-fullname').val(globalYourConfigNode.fullname)

      $('#node-input-flowhubpush-comment').on('change', (e) => {
         if ( e ) { e.preventDefault(); }
         ensureYourConfigNodeExists();

         let val = $('#node-input-flowhubpush-comment').val();
         if ( val != globalYourConfigNode.pushcomment ) { 
            globalYourConfigNode.pushcomment = val;
            RED.nodes.dirty(true);
         }
      })
      $('#node-input-flowhubpush-comment').val(globalYourConfigNode.pushcomment)

      RED.comms.subscribe('flowhub:submission-result', (event,data) => {
        RED.notify("Submission status: " + data.status, {
          type: data.statusType,
          id: "FlowHubPushResult",
          timeout: data.statusType == "error" ? 3000 : 2000
        });

        /* update an existing revision of a flow, this happens after the 
          flow was successfully submitted and updated */
        if ( data.flowid && data.flowrevision ) {
          let cfgNode = ensureYourConfigNodeExists();
          cfgNode.flowrevisions ||= {}

          if ( cfgNode.flowrevisions[data.flowid] != data.flowrevision ) {
            cfgNode.flowrevisions[data.flowid] = data.flowrevision
            cfgNode.pushcomment = ""
            $('#node-input-flowhubpush-comment').val(cfgNode.pushcomment)
            RED.nodes.dirty(true)
          }
        }
      });

      if ( globalYourConfigNode.notab ) {
         $('#flowhubpull-dialog-import-opt-sb-current').addClass('selected')
         $('#flowhubpull-dialog-import-opt-sb-new').removeClass('selected')
        } else {
         $('#flowhubpull-dialog-import-opt-sb-new').addClass('selected')
         $('#flowhubpull-dialog-import-opt-sb-current').removeClass('selected')
       }
       
       $('#flowhubpull-dialog-import-opt-sb-current').on('click', (e) => {
         e.preventDefault();

         ensureYourConfigNodeExists();
         globalYourConfigNode.notab = true
         RED.nodes.dirty(true);

         $('#flowhubpull-dialog-import-opt-sb-new').removeClass('selected')
         $('#flowhubpull-dialog-import-opt-sb-current').addClass('selected')
       })

       $('#flowhubpull-dialog-import-opt-sb-new').on('click', (e) => {
         e.preventDefault();

         ensureYourConfigNodeExists();
         globalYourConfigNode.notab = false;
         RED.nodes.dirty(true);

         $('#flowhubpull-dialog-import-opt-sb-current').removeClass('selected')
         $('#flowhubpull-dialog-import-opt-sb-new').addClass('selected')
       })

      var dirList = $("#node-input-flowhubpull-sb-target-container-div").css({
        width: "100%",
        height: "100%"
       }).treeList(
         {
           multi:false
         }
       ).on('treelistselect', function(event, item) {
         if ( item.flowid ) {
           $('#node-input-flowhubpull-flowid').val(item.flowid);

           ensureYourConfigNodeExists();
           globalYourConfigNode.flowid = item.flowid;
           RED.nodes.dirty(true);

           obtainFhbToken(globalYourConfigNode, (token) => {
              if ( token !== "" && token ) {
                token = "?t=" + tokenToUrl(token)
              }
              $('#flowhubpull-sb-view-flow-link').attr(
                'href', 'https://flowhub.org/f/' + item.flowid + token
              ).show();              
           })
           
           $('#node-input-flowhubpull-sb-import-flow-but').prop('disabled',false)
         }
       }).on('treelistconfirm', function(event, item) {
         if ( item.flowid ) {
           $('#node-input-flowhubpull-flowid').val(item.flowid);

           ensureYourConfigNodeExists();
           globalYourConfigNode.flowid = item.flowid;
           RED.nodes.dirty(true);

           obtainFhbToken(globalYourConfigNode, (token) => {
              if ( token !== "" && token ) {
                token = "?t=" + tokenToUrl(token)
              }

              $('#flowhubpull-sb-view-flow-link').attr(
                'href', 'https://flowhub.org/f/' + item.flowid + token
              ).show();
           })

           $('#node-input-flowhubpull-sb-import-flow-but').prop('disabled',false)
           $("#node-input-flowhubpull-sb-import-flow-but").trigger('click');
         }
       });

       if ( globalYourConfigNode.flowrevision != "" ) {
         $('#node-input-flowhubpull-flowrevision').val(globalYourConfigNode.flowrevision)
       }

       if ( globalYourConfigNode.flowid ) {
         $('#node-input-flowhubpull-flowid').val(globalYourConfigNode.flowid);

         obtainFhbToken(globalYourConfigNode, (token) => {
          if ( token !== "" && token ) {
            token = "?t=" + tokenToUrl(token)
          }
          $('#flowhubpull-sb-view-flow-link').attr(
              'href', 'https://flowhub.org/f/' + globalYourConfigNode.flowid + token
          ).show();
         })
       } else {
        $('#node-input-flowhubpull-sb-import-flow-but').prop('disabled',true)
       }

       obtainFhbToken(globalYourConfigNode, (token) => {
           flowHubPullUpdateFlows( (lst) => { dirList.treeList('data', lst) }, token);
       })

       var search = $("#node-input-flowhubpull-sb-target-filter").searchBox({
         style: "compact",
         delay: 300,
         change: function() {
           var val = $(this).val().trim().toLowerCase();
           if (val === "") {
             dirList.treeList("filter", null);
             search.searchBox("count","");
           } else {
             var count = dirList.treeList("filter", function(item) {
               return item.label.toLowerCase().indexOf(val) > -1 || item.sublabel.toLowerCase().indexOf(val) > -1
             });
             search.searchBox("count",count + " / " + dirList.treeList("data").length);
           }
         }
       });

       $('#node-input-flowhubpull-sb-refresh-list-but').on('click', function(e) {
        e.preventDefault();

        setTimeout( () => {
          ensureYourConfigNodeExists();

          obtainFhbToken(globalYourConfigNode, (token) => {
            flowHubPullUpdateFlows( (lst) => { 
              dirList.treeList('empty') 
              $('#flowhubpull-sb-view-flow-link').hide()
              setTimeout( () => {
                dirList.treeList('data', lst) 
              },300)
            }, token);
          })
        }, 300);
       });

      $('#node-input-flowhubpush-new-token-field').on('change', e => {
        checkToken($('#node-input-flowhubpush-new-token-field').val())
      })

      $('#node-input-flowhubpush-clear-token-btn').on('click', e => {
        if ( e ) { e.preventDefault() }      
        $('#node-input-flowhubpush-new-token-name-field').val("")
        $('#node-input-flowhubpush-new-token-field').val("")
        $('#node-input-flowhubpush-new-token-field').trigger('change')
      })
      
      $('#node-input-flowhubpush-add-token-btn').on('click', e => {
        if ( e ) { e.preventDefault() }

        ensureYourConfigNodeExists();

        if ( !globalYourConfigNode.tokens ) {
          globalYourConfigNode.tokens = []
        }

        let tk = {
          name: $('#node-input-flowhubpush-new-token-name-field').val(),
          type: "cred",
          val: $('#node-input-flowhubpush-new-token-field').val()
        }

        globalYourConfigNode.tokens.push(tk)
        RED.nodes.dirty(true);

        addTokenToList("",tk)
        addEventHandlersToTokenList(globalYourConfigNode)
      })

      $("#node-input-flowhubpull-sb-check-duplicates-flow-but").on("click", function(e) {
        if ( e ) { e.preventDefault(); }

        if ( $('#node-input-flowhubpull-flowid').val().trim() == "" ||
            !$('#node-input-flowhubpull-flowid').val() ) {
          return RED.notify(RED._("notification.warning", {
            message: "FlowID not provided, doing nothing."
          }), "warning");
        }

        RED.notify("Checking for flow duplication.", "success");

        ensureYourConfigNodeExists();

        obtainFhbToken(globalYourConfigNode, (token) => {
          checkForDuplication(token)
        })
      })

      $("#node-input-flowhubpull-sb-import-flow-but").on("click", function(e) {
        if ( e ) { e.preventDefault(); }

        if ( $('#node-input-flowhubpull-flowid').val().trim() == "" ||
            !$('#node-input-flowhubpull-flowid').val() ) {
          return RED.notify(RED._("notification.warning", {
            message: "FlowID not provided, doing nothing."
          }), "warning");
        }

        ensureYourConfigNodeExists();
        var notab = globalYourConfigNode.notab;

        obtainFhbToken(globalYourConfigNode, (token) => {
          doFlowImportForSidebar(notab, token)
        })
      });

      $('#node-input-flowhubpush-pushnewflows').prop('checked', globalYourConfigNode.pushnewflows)

      $('#node-input-flowhubpush-pushnewflows').on('change', () => {
        ensureYourConfigNodeExists();
        globalYourConfigNode.pushnewflows = $('#node-input-flowhubpush-pushnewflows').is(":checked")
        RED.nodes.dirty(true);
      })

      $('#node-input-flowhubpush-forcepush').prop('checked', globalYourConfigNode.forcepush)

      $('#node-input-flowhubpush-forcepush').on('change', () => {
        ensureYourConfigNodeExists();
        globalYourConfigNode.forcepush = $('#node-input-flowhubpush-forcepush').is(":checked")
        RED.nodes.dirty(true);
      })

      $('#node-input-flowhubpull-flowrevision').on('change', () => {
        ensureYourConfigNodeExists();
        let val = $('#node-input-flowhubpull-flowrevision').val();
        
        if (globalYourConfigNode.flowrevision != val ) {
          globalYourConfigNode.flowrevision = val
          RED.nodes.dirty(true);
        }
      })
   };
   
   RED.events.on('runtime-state', initialiseConfigNodeOnce);
})();
</script>

<style>
.diff-viewer{overflow:scroll;background-color:#f4f4f4;border:1px solid #c4c4c4;height:80vh;padding:20px;max-width:90vw;border-radius:5px}.dv-differ{background-color:rgba(244,170,23,.476)!important}.dv-removed{background-color:#cbcb26!important}.dv-added{background-color:#56de78!important}.dv-error{background-color:#ff4b09!important}.dv-pre-elem{page-break-inside:avoid;font-family:monospace;max-width:100%;overflow:auto;display:block;word-wrap:break-word;margin:0!important}.flowhublogo{background-image:url("icons/@gregoriusrippenstein/node-red-contrib-flowhub/flowhublogo.svg");background-size:cover;background-repeat:no-repeat;background-position-x:center;background-position-y:top}th.revertable:after{content:" ‚ü≤";color:"green"}.red-ui-tray-content #dialog-form{white-space:nowrap}.full-row .red-ui-typedInput-container{min-width:70%}.col input{min-width:100%}.sml-lbl{height:66px}.sml-lbl label{font-size:smaller;margin-bottom:0;display:block!important}.reg-lbl label{white-space:nowrap;margin-top:5px;height:0}.red-ui-editor .form-row label.full-lbl{white-space:normal;width:100%}.col{float:left;margin-right:5px;min-height:36px}.col .red-ui-typedInput-container{width:100%!important}.col-50{width:50%}.col-33{width:33%}.col-66{width:66%}.col-25{width:25%}.col-75{width:75%}.col-100 .red-ui-typedInput-container{width:70%!important}.col-100.no-label .red-ui-typedInput-container{width:100%!important}.txtarea{padding-bottom:26px}.txtarea label{vertical-align:top;margin-top:3px}.txtarea textarea{width:70%;margin-bottom:-28px!important}.btn-regular{margin-bottom:14px!important}.flowhub-token-selected{background-color:rgba(12,208,208,.709)}
</style>

<!-- The html for the right sidebar plugin screen -->
<script type="text/x-red" data-template-name="FlowHubDiff">
<div class="form-row func-flowhub-tabs-row">
   <ul style="min-width: 600px; margin-bottom: 20px;" id="func-flowhub-tabs"></ul>
</div>

<!--func-flowhub-tabs-row-->
<div id="func-flowhub-tabs-content" style="min-height: calc(100% - 95px);">

   <!--func-flowhub-tab-compare#-->
   <div id="func-flowhub-tab-compare" style="display:none">
      <div class="form-row">
         <div class="col-100">

            <div class="form-row" style="margin-left: 10px; margin-top: 30px;">
               <button id="node-input-flowhubdiff-compare-btn"
                                             class="red-ui-button"><i class="fa fa-balance-scale"></i> Compare Changes</button>
               <a id="flowhubdiff-view-flow-link" style="color: blue; display: none; margin-left: 40px;" target="_blank"
                  href="">Webiliser <i class="fa fa-external-link"></i></a>
            </div>

            <div class="form-row node-input-target-row node-input-target-list-row"
               style="min-height: 100px; margin-left: 10px; margin-right: 15px;">
               <div style="margin-right: 15px; margin-bottom: 5px; width: 35%; padding-left: 60%;">
                  <input type="text" id="node-input-flowhubdiff-target-filter" style="display: none;">
               </div>

               <div id="node-input-flowhubdiff-target-container-div" style="min-height: 100px"></div>
            </div>

            <div class="form-row" style="min-height: 300px; margin-left: 10px; margin-right: 15px;">
               <div id="node-input-flowhubdiff-svgcontainer"></div>
            </div>

            <div class="form-row" style="min-height: 100px; margin-left: 10px; margin-right: 15px;">
               <div id="node-input-flowhubdiff-diffcontainer" class="diff-viewer"></div>
            </div>

         </div>
      </div>
      <!--form-row-->
   </div>

   <!--func-flowhub-tab-pull#-->
   <div id="func-flowhub-tab-pull" style="display:none" style="min-height: calc(100% - 95px);">
      <div class="form-row">
         <div class="col-100">

            <div class="form-row" style="margin-left: 10px; margin-top: 30px;">
               <button id="node-input-flowhubpull-sb-refresh-list-but"
                        class="red-ui-button"><i class="fa fa-refresh"></i> Refresh Flow List</button>

               <a id="flowhubpull-sb-view-flow-link" style="color: blue; display: none; margin-left: 40px;"
                  target="_blank" href="">Webiliser <i class="fa fa-external-link"></i></a>
            </div>

            <div class="form-row node-input-target-row node-input-target-list-row"
               style="position: relative; min-height: 100px; height: 500px; margin-left: 10px; margin-right: 15px;">
               <div style="position: absolute; top: -30px; right: 0px;">
                  <input type="text" id="node-input-flowhubpull-sb-target-filter" placeholder="Name or Flow Id">
               </div>

               <div id="node-input-flowhubpull-sb-target-container-div" style="min-height: 500px;"></div>
            </div>

            <div class="form-row" style="margin-left: 10px; margin-top: 30px;">
               <label>
                 <span>Flow ID:</span>
               </label>
              <input type="text"
               disabled="disabled"
               id="node-input-flowhubpull-flowid"
               style="display:inline-block; width:40%; vertical-align:baseline;"
               placeholder="Flow ID to Import">
            </div>

            <div class="form-row" style="margin-left: 10px;">
               <label>
                <span>Import to:</span>
              </label>

              <span>
                 <a id="flowhubpull-dialog-import-opt-sb-current" class="red-ui-button toggle" href="#" data-i18n="clipboard.export.current">current flow tab</a>
                 <a id="flowhubpull-dialog-import-opt-sb-new" class="red-ui-button toggle" href="#" data-i18n="clipboard.import.newFlow">new flow tab</a>
              </span>
            </div>

            <div class="form-row" style="margin-left: 10px;">
               <label for="node-input-flowhubpull-flowrevision">Revision:</label>
               <input type="text" id="node-input-flowhubpull-flowrevision" placeholder="Revision"/>
            </div>

            <div class="form-row" style="margin-left: 10px;">
               <button id="node-input-flowhubpull-sb-import-flow-but"
                                             class="red-ui-button">Import Flow</button>
               <button id="node-input-flowhubpull-sb-check-duplicates-flow-but"
                                             class="red-ui-button">Duplication?</button>
            </div>


            <div class="form-row node-input-target-row node-input-target-list-row"
               style="position: relative; min-height: 100px; height: 300px; margin-left: 10px; margin-right: 15px;">            
               <div id="node-input-flowhubpull-sb-duplication-container-div" style="min-height: 300px;"></div>
            </div>
         </div>
      </div>
   </div>

   <!--func-flowhub-tab-push#-->
   <div id="func-flowhub-tab-push" style="display:none">
      <div class="form-row">
         <div class="col-100">

            <div class="form-row" style="margin-top: 30px; margin-left: 10px;">
               <input type="checkbox" id="node-input-flowhubpush-pushnewflows"
                  style="display:inline-block; width:15px; vertical-align:baseline;">
               <label for="node-input-flowhubpush-pushnewflows" style="width: 230px;">
                  <span>Create new flows when pushing?</span>
               </label>
            </div>

            <div class="form-row" style="margin-left: 10px;">
               <input type="checkbox" id="node-input-flowhubpush-forcepush"
                              style="display:inline-block; width:15px; vertical-align:baseline;">
               <label for="node-input-flowhubpush-forcepush" style="width: 230px;">
                  <span>Overwrite more recent changes?</span>
               </label>
            </div>

            <div class="form-row" style="margin-left: 10px;">
               <button id="node-input-flowhubpush-push-btn"
                                    class="red-ui-button"><i class="fa fa-share-square-o"></i> Push to GitHub</button>
               <a id="flowhubpush-view-flow-link" style="color: blue; display: none; margin-left: 80px;" target="_blank"
                  href="">Webiliser <i class="fa fa-external-link"></i></a>
            </div>

            <div class="form-row" style="margin-left: 10px;">
               <hr/>
            </div>
            
            <div class="form-row" style="margin-left: 10px;">
               <label for="node-input-flowhubpush-comment">
                  <i class="fa fa-tag"></i> Comment
               </label>
               <textarea id="node-input-flowhubpush-comment" placeholder="comment"></textarea>
            </div>

            <div class="form-row" style="margin-left: 10px;">
               Comment will be added to each push. Leave blank for a push to be commentless.
            </div>

            <div class="form-row" style="margin-left: 10px;">
               <hr />
            </div>

            <div class="form-row" style="margin-left: 10px; margin-top: 20px;">
               <label for="node-input-flowhubpush-apiToken">
                                    <i class="fa fa-key"></i>
                                    Current Token
                                 </label>
               <input type="text" id="node-input-flowhubpush-apiToken">
               <input type="hidden" id="node-input-flowhubpush-apiTokenType">
            </div>


            <div class="form-row" style="margin-left: 10px;">
               Check out the instructions for generating your own <a style="color: blue;" target="_blank"
                  href="https://flowhub.org/integration">FlowHub.org token <i class='fa fa-external-link'></i></a>. You will then be
               able to commit your Node-RED flows directly to your own GitHub repository - public or private. You will also be able
               to view those flows at FlowHub.org using the "View Flow" links.
            </div>

            <div class="form-row" style="margin-top: 30px; margin-left: 10px;">
               <input id="node-input-flowhubpush-new-token-field" placeholder="New token fhb_XXXX">
            </div>

            <div class="form-row" style="margin-left: 10px; display:none;" id="flowhubpush-check-token-result-content">
               Repo: <a target=_blank href="#" class="repo"></a> @ <span class="branch"></span><br>
               Permission: <span class="permission"></span><br>
               User: <a target=_blank href="#" class="user"></a>, <span class="email"></span>
            </div>

            <div class="form-row" style="margin-left: 10px;">
               <input id="node-input-flowhubpush-new-token-name-field" placeholder="Token Name" style="width: 250px;">
               <button id="node-input-flowhubpush-add-token-btn"
                                    class="red-ui-button"><i class="fa fa-plus"></i> Add</button>
               <button id="node-input-flowhubpush-clear-token-btn"
                                    class="red-ui-button"><i class="fa fa-times"></i> Clear</button>
            </div>

            <div class="form-row" style="margin-left: 10px;">
               <table border=0 id="node-input-flowhubpush-token-list" style="margin-left: 10px;">
              </table>
            </div>

         </div>
      </div>
      <!--form-row-->
   </div>
   <!--func-flowhub-tab-tab#-->
</div>
<!--func-flowhub-tabs-content-->
</script>

<!-- --- [red-plugin:@gregoriusrippenstein/node-red-contrib-introspection/screenshot] --- -->
<script type="text/javascript">
(function() {
   var globalRefToSvgData;

   let obfuscateHelpers={getFlowDataFromCurrentWorkspace:e=>{var e=e||RED.workspaces.active(),t=RED.nodes.groups(e),e=(t=(t=t.concat(RED.nodes.junctions(e))).concat(RED.nodes.filterNodes({z:e})),RED.nodes.eachConfig(function(e){e.z===RED.workspaces.active()&&!1===e._def.hasUsers&&t.push(e)}),RED.nodes.workspace(e)||RED.nodes.subflow(e));return t.unshift(e),RED.nodes.createExportableNodeSet(t)},openImportDialog:e=>{RED.clipboard.import();let t=e;setTimeout(()=>{$("#red-ui-clipboard-dialog-import-text").val(JSON.stringify(t)).trigger("paste")},300)}};function obfuscatieCurrentFlow(l){let p=obfuscateHelpers.getFlowDataFromCurrentWorkspace(),f=(l.remove_groups&&(p=p.filter(e=>"group"!=e.type)).forEach(e=>{delete e.g}),{}),t={},d={},c={},s=[],h={},r={};if(p.forEach(e=>{"subflow"==(f[e.id]=e).type&&(r[e.id]=e),"junction"==e.type&&(t[e.id]=e),"link out"==e.type&&(c[e.id]=e),"link in"==e.type&&(d[e.id]=e),"link call"==e.type&&s.push(e.id),"catch"==e.type&&(h[e.id]=(e.wires||[])[0]||[])}),l.remove_junctions&&(Object.keys(t).forEach(n=>{let s=t[n];r[s.z]||p.forEach(t=>{for(let e=0;e<(t.wires||[]).length;e++){var r=t.wires[e].indexOf(n);-1<r&&(t.wires[e].splice(r,1),t.wires[e].push(...s.wires[0]))}})}),p=p.filter(e=>!("junction"==e.type&&!r[e.z]))),l.remove_linkout_nodes||l.remove_linkcall_nodes){let r=[],n=[],i=[],a=(l.remove_linkout_nodes&&!l.copy_linkin_nodes&&Object.keys(c).forEach(n=>{var e=c[n];let s=e.links||[];s.reduce((e,t)=>e&&(!!d[t]||l.ignore_off_flow_links),!0)&&"return"!=e.mode&&(r.push(n),p.forEach(r=>{for(let t=0;t<(r.wires||[]).length;t++){var e=r.wires[t].indexOf(n);-1<e&&(r.wires[t].splice(e,1),s.forEach(e=>{d[e]&&r.wires[t].push(...d[e].wires[0])}))}}))}),(s,e)=>{if(!e)return!1;let t=[],o=[],r=[];function u(e){if(r.indexOf(e.id)<0)switch(r.push(e.id),t.push(e),e.type){case"link out":if("return"!=e.mode)throw"not handable";break;case"link call":throw"unhandled";default:RED.nodes.getNodeLinks(e).forEach(function(e){u(e.target)})}}try{RED.nodes.getNodeLinks(e).forEach(function(e){u(e.target),o.push(e.target.id)});if(Object.keys(h).forEach(e=>{((t,e)=>{try{return e.map(e=>e.id).forEach(e=>{if(t.includes(e))throw"yes"}),!1}catch(e){return!0}})(h[e],t)&&t.push(f[e])}),0==t.length)return!1;let r={};var i=t[0];let n={x:s.x-i.x,y:s.y-i.y};var a=t.map(e=>{var t=structuredClone(f[e.id]);return t||console.log("WARNING: nodeid not found",[e.id,f[e.id]]),t.id=RED.nodes.id(),t.x+=n.x,t.y+=n.y,r[e.id]=t});return a.forEach(e=>{"catch"==e.type&&Array.isArray(e.scope)&&(e.scope=e.scope.map(e=>{var t=r[e];return t&&t.id||e})),e.wires&&(e.wires=e.wires.map(e=>e.map(e=>{var t=r[e];return t&&"link out"==t.type?[...s.wires[0],(t||{}).id||e]:(t||{}).id||e}).flat()))}),{nodes:a.filter(e=>"link out"!=e.type),entryNodes:o.map(e=>r[e])}}catch(e){return!1}});l.remove_linkout_nodes&&l.copy_linkin_nodes&&Object.keys(c).forEach(s=>{let o=c[s],u=o.links||[];if("return"!=o.mode){let t=u.map(e=>{var t=d[e],t=a(o,t);return t?[e,t]:[void 0,void 0]});t.reduce((e,t)=>e&&(!!t[0]||l.ignore_off_flow_links),!0)&&(r.push(s),p.forEach(n=>{for(let r=0;r<(n.wires||[]).length;r++){var e=n.wires[r].indexOf(s);-1<e&&(n.wires[r].splice(e,1),(t=u.map(e=>{var t=d[e],t=a(o,t);return t?[e,t]:[void 0,void 0]})).forEach(([,e])=>{var t;e&&(t=e.entryNodes.map(e=>e.id),n.wires[r].push(...t),i.push(...e.nodes))}))}}))}}),l.remove_linkcall_nodes&&s.forEach(s=>{var e=f[s],t=d[e.links[0]];let o=a(e,t);t&&o&&(n.push(e.id),p.forEach(t=>{for(let e=0;e<(t.wires||[]).length;e++){var r,n=t.wires[e].indexOf(s);-1<n&&(r=o.entryNodes.map(e=>e.id),t.wires[e].splice(n,1),t.wires[e].push(...r),i.push(...o.nodes))}}))}),(p=p.filter(e=>r.indexOf(e.id)<0&&n.indexOf(e.id)<0)).push(...i)}if((p=l.remove_debugs?p.filter(e=>"debug"!=e.type&&"comment"!=e.type):p).forEach(e=>{l.name&&(e.name=RED.nodes.id()),l.shrink_node&&(e.l=!1),l.info&&(e.info="",delete e.outputLabels,delete e.inputLabels),l.add_license&&(l.append_license?e.info=(e.info||"")+"\n---\n\n"+l.license_text:e.info=l.license_text),l.position&&(e.x=150,e.y=150),l.remove_icons&&delete e.icon}),l.replace_switch){let n=(t,r)=>{for(let e=0;e<r.rules.length;e++){var n=r.rules[e];if("nnull"==n.t)t.push("if ( _propValue != null ) {  _returnValue.push(msg) ; return node.send(_returnValue) } else { _returnValue.push(undefined) }");else if("null"==n.t)t.push("if ( _propValue == null ) {  _returnValue.push(msg) ; return node.send(_returnValue) } else { _returnValue.push(undefined) }");else if("eq"==n.t&&"str"==n.vt){s=n.v;s=btoa(encodeURIComponent(s).replace(/%([0-9A-F]{2})/g,function(e,t){return String.fromCharCode("0x"+t)}));t.push("if ( _propValue === Buffer.from('"+s+"', 'base64').toString('utf-8') ) {  _returnValue.push(msg) ; return node.send(_returnValue) } else { _returnValue.push(undefined) }")}else if("gt"==n.t&&"num"==n.vt)t.push("if ( _propValue > "+n.v+" ) {  _returnValue.push(msg) ; return node.send(_returnValue) } else { _returnValue.push(undefined) }");else if("eq"==n.t&&"num"==n.vt)t.push("if ( _propValue == "+n.v+" ) {  _returnValue.push(msg) ; return node.send(_returnValue) } else { _returnValue.push(undefined) }");else if("empty"==n.t)t.push('let p = _propValue ;  if (  (Array.isArray(p) && p.length == 0) || ((typeof p === "object") && p != null && Object.keys(p).length == 0) || ((typeof p === "string") && p.length == 0) ) { _returnValue.push(msg) ; return node.send(_returnValue) } else {  _returnValue.push(undefined) }');else if("nempty"==n.t)t.push('let p = _propValue ;  if (  (Array.isArray(p) && p.length > 0) || ((typeof p === "object") && p != null && Object.keys(p).length > 0) || ((typeof p === "string") && p.length > 0) ) { _returnValue.push(msg) ; return node.send(_returnValue) } else {  _returnValue.push(undefined) }');else{if("else"!=n.t)throw"unhandled";t.push("_returnValue.push(msg)","return node.send(_returnValue)")}}var s};p=p.map(t=>{if("switch"!=t.type)return t;var e={id:t.id,name:t.name,type:"function",x:t.x,y:t.y,func:"",outputs:t.outputs,timeout:"",noerr:0,initialize:"",finalize:"",libs:[{var:"process",module:"process"},{var:"jsonata",module:"jsonata"}],wires:t.wires};t.hasOwnProperty("z")&&(e.z=t.z),t.hasOwnProperty("l")&&(e.l=t.l);try{var r=[];if(t.checkAll)throw"unhandled";if("msg"==t.propertyType)r.push("((msg,node) => {","let _propValue = undefined","try { _propValue = RED.util.getMessageProperty(msg, '"+t.property+"') } catch (ex) {}","let _returnValue = []"),n(r,t),r.push("})(msg,node);");else{if("jsonata"!=t.propertyType)throw"unhandled";r.push("jsonata('"+t.property+"').evaluate(msg).then(_propValue => {","let _returnValue = []"),n(r,t),r.push("})")}return e.func=r.join("\n"),e}catch(e){return t}})}if(l.replace_change){let s=e=>btoa(encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,function(e,t){return String.fromCharCode("0x"+t)}));p=p.map(t=>{if("change"!=t.type)return t;var e={id:t.id,name:t.name,type:"function",x:t.x,y:t.y,func:"",outputs:1,timeout:"",noerr:0,initialize:"",finalize:"",libs:[{var:"process",module:"process"},{var:"jsonata",module:"jsonata"}],wires:t.wires};t.hasOwnProperty("z")&&(e.z=t.z),t.hasOwnProperty("l")&&(e.l=t.l);try{var r=["(async (msg,node) => {","let __s = RED.util.setMessageProperty","let __g = RED.util.getMessageProperty"];for(let e=0;e<t.rules.length;e++){var n=t.rules[e];if("set"==n.t){if(n.dc)throw"unhandled";if("msg"==n.pt&&"str"==n.tot)r.push("__s(msg,'"+n.p+"', Buffer.from('"+s(n.to)+"', 'base64').toString('utf-8') )");else if("msg"==n.pt&&"bool"==n.tot)r.push("__s(msg,'"+n.p+"', "+n.to+")");else if("msg"==n.pt&&"num"==n.tot)r.push("__s(msg,'"+n.p+"', Number(Buffer.from('"+s(n.to)+"', 'base64').toString('utf-8')))");else if("msg"==n.pt&&"json"==n.tot)r.push("__s(msg,'"+n.p+"', JSON.parse(Buffer.from('"+s(n.to)+"', 'base64').toString('utf-8')))");else if("msg"==n.pt&&"msg"==n.tot)r.push("try { __s(msg,'"+n.p+"',  __g(msg, '"+n.to+"')) } catch (ex) {}");else if("msg"==n.pt&&"env"==n.tot)r.push("__s(msg,'"+n.p+"',  process.env['"+n.to+"'])");else{if("msg"!=n.pt||"jsonata"!=n.tot||!n.to.startsWith("/* @obfuscate-safe */"))throw"unhandlable";r.push("__s(msg,'"+n.p+"',  await jsonata(Buffer.from('"+s(n.to)+"', 'base64').toString('utf-8')).evaluate(msg) )")}}else{if("delete"!=n.t||"msg"!=n.pt)throw"unhandlable";r.push("delete msg."+n.p)}}return r.push("node.send(msg) })(msg,node);"),e.func=r.join("\n"),e}catch(e){return console.log(e),t}})}if(l.javascript){let r={},t=[];p.forEach(e=>{"javascript"!=(r[e.id]=e).format&&"function"!=e.type&&"css"!=e.format&&"json"!=e.format||t.push(e)});var e={parse:{bare_returns:!0,expression:!1},compress:{},mangle:{reserved:["$","export","require"]},output:null,sourceMap:null,nameCache:null,toplevel:!1,warnings:!1},o={compatibility:"*",level:2};$.ajax({url:"ClientCode/"+RED.nodes.id()+"/ugify",type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify({nodes:t,jscfg:e,csscfg:o}),success:function(e){e.forEach(e=>{var t=r[e.id];e._error&&console.log("ERROR NODE",e),"function"==t.type?t.func=e.func:"javascript"!=t.format&&"css"!=t.format&&"json"!=t.format||(t.template=e.template)}),obfuscateHelpers.openImportDialog(p)},error:function(e,t,r){RED.notify("ClientCode Communcation Failure: "+n.id+": "+t,{type:"error",timeout:3e3})}})}else obfuscateHelpers.openImportDialog(p)}
   
   function setupTreelist(){var e=collectOrphans();if(0==e.length){RED.notify("No Orphans Found",{type:"success",timeout:2e3});try{$("#node-input-orphan-target-container-div").treeList("empty")}catch(e){}}else{try{$("#node-input-orphan-target-container-div").treeList("empty")}catch(e){$("#node-input-orphan-target-container-div").css({width:"100%",height:"calc(100%)"}).treeList({multi:!1}).on("treelistitemmouseover",function(e,t){}).on("treelistitemmouseout",function(e,t){}).on("treelistselect",function(e,t){t.node&&(RED.workspaces.show(t.node.z,!1,!1,!0),RED.view.reveal(t.node.id,!0),RED.view.redraw())}).on("treelistconfirm",function(e,t){var n;t.node&&(n=t.node.id,setTimeout(()=>{var e=RED.nodes.node(n);e&&(RED.view.reveal(e.id),RED.view.select(e.id),RED.editor.edit(e)),n==RED.workspaces.active()&&RED.workspaces.edit()},50))}),$("#node-input-orphan-target-filter").show();var n=$("#node-input-orphan-target-filter").searchBox({style:"compact",delay:300,change:function(){var e,t=$(this).val().trim().toLowerCase();""===t?($("#node-input-orphan-target-container-div").treeList("filter",null),n.searchBox("count","")):(e=$("#node-input-orphan-target-container-div").treeList("filter",function(e){return-1<e.label.toLowerCase().indexOf(t)||-1<e.node.type.toLowerCase().indexOf(t)}),n.searchBox("count",e+" / "+$("#node-input-orphan-target-container-div").treeList("data").length))}})}$("#node-input-orphan-target-container-div").treeList("data",e.sort((e,t)=>e.node.z>t.node.z))}}function collectOrphans(){const t=new Set;var n=[],i=(RED.nodes.eachLink(e=>{t.add(e.source),t.add(e.target)}),RED.nodes.eachNode(e=>{(!t.has(e)||"link out"==e.type&&"link"==e.mode&&0==e.links.reduce((e,t)=>e||!!RED.nodes.node(t),!1))&&n.push(e)}),[]),r={};return n.forEach(function(e){var t=RED.nodes.getType(e.type);if(t){var n=t.label,n=("function"==typeof n?n.call(e):n)||"",o=e.type;if(0===o.indexOf("subflow:"))return}t&&n||(n=e.type),r[e.id]={node:e,label:n,sublabel:o,selected:!1,checkbox:!1},i.push(r[e.id])}),i}
   
   function nr_intro_generate_svg_4_0(r,t){return e=>{try{handleSvgObject($($("#red-ui-workspace-chart").find("svg")[0]),e,t)}catch(t){var n="Error Generating SVG: "+JSON.stringify(t);r.notify(n,{type:"error"}),e('<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg width="1000" height="1000" viewBox="0 0 1000 1000" pointer-events="all" style="cursor: crosshair; touch-action: none;" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><style>.small { font: bold 20px sans-serif; fill: red;}</style><text x="10" y="30" class="small">'+n+"</text></svg>")}}}function nr_intro_generate_svg_3_1(r,t){return e=>{try{handleSvgObject($($("#red-ui-workspace-chart").find("svg")[0]),e,t)}catch(t){var n="Error Generating SVG: "+JSON.stringify(t);r.notify(n,{type:"error"}),e('<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg width="1000" height="1000" viewBox="0 0 1000 1000" pointer-events="all" style="cursor: crosshair; touch-action: none;" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><style>.small { font: bold 20px sans-serif; fill: red;}</style><text x="10" y="30" class="small">'+n+"</text></svg>")}}}function nr_intro_generate_svg_3_0(r,t){return e=>{try{handleSvgObject($($("svg")[0]),e,t)}catch(t){var n="Error Generating SVG: "+JSON.stringify(t);r.notify(n,{type:"error"}),e('<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg width="1000" height="1000" viewBox="0 0 1000 1000" pointer-events="all" style="cursor: crosshair; touch-action: none;" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><style>.small { font: bold 20px sans-serif; fill: red;}</style><text x="10" y="30" class="small">'+n+"</text></svg>")}}}function handleSvgObject(a,e,t){var n=a.clone(),r=(n.find("foreignObject").remove(),n.find("svg.__screenshot").remove(),'width="'+a.attr("width")+'" height="'+a.attr("height")+'"'),s=RED.settings.version.split("."),i=parseInt(s[0]),s=parseInt(s[1]);if(3<=i&&1<=s){var o=$($($(a).children("g")[0]).children("g")[0]).children("g"),l={x:8e3,y:8e3,w:-1,h:-1};for(let t=1;t<o.length;t++){var g=o[t].getBBox();0==g.width&&0==g.height||(l.x=Math.min(g.x,l.x),l.y=Math.min(g.y,l.y),l.w=Math.max(g.width,l.w),l.h=Math.max(g.height,l.h))}r+=` viewBox='${l.x} ${l.y} ${l.w} ${l.h}'`}function c(t,e){for(var n=0;n<t.length;n++){var s=t.item(n),i=e[n];["stroke-width","fill-opacity","stroke-opacity","opacity","stroke-dasharray"].forEach(function(t){s.setAttribute(t,$(i).attr(t)||$(i).css(t))}),["fill","stroke"].forEach(function(t){var e,n,r=(e=$(i).attr(t)||$(i).css(t))&&null!==e&&"none"!=e?(n=e.match(/^#(.)(.)(.)$/))?"#"+n[1]+n[1]+n[2]+n[2]+n[3]+n[3]:(n=e.match(/^#......$/))?e:null===(n=e.match(/^rgb\(([0-9]+),\s+([0-9]+),\s+([0-9]+)/))?(r=e.match(/^rgba\(([0-9]+),\s+([0-9]+),\s+([0-9]+),\s+([0-9]+)/))?{clr:"#"+("0"+parseInt(r[1],10).toString(16)).slice(-2)+("0"+parseInt(r[2],10).toString(16)).slice(-2)+("0"+parseInt(r[3],10).toString(16)).slice(-2),opa:r[4]}:(console.log("Screenshot node: returned unknown color: "+e),e):"#"+("0"+parseInt(n[1],10).toString(16)).slice(-2)+("0"+parseInt(n[2],10).toString(16)).slice(-2)+("0"+parseInt(n[3],10).toString(16)).slice(-2):"none";"object"==typeof r?(s.setAttribute(t+"-opacity",r.opa),s.setAttribute(t,r.clr)):s.setAttribute(t,r)}),$(i).hasClass("hide")&&("g"==s.tagName&&s.setAttribute("opacity","0"),s.setAttribute("visibility","hidden"))}}var i='<?xml version="1.0" standalone="no"?>\r\n<svg '+r+' pointer-events="all" style="cursor: crosshair; touch-action: none;" xmlns="http://www.w3.org/2000/svg" class="__screenshot" xmlns:xlink="http://www.w3.org/1999/xlink">\r\n',s=n.html(),h=(new DOMParser).parseFromString(i+s+"\r\n</svg>","image/svg+xml"),v=t=>t,f=(t.rmidsandclasses&&(v=e=>(["g","rect","line","path","circle","image","text"].forEach(t=>{$(e.getElementsByTagName(t)).each((t,e)=>{e.setAttribute("class",""),e.setAttribute("id","")})}),e)),["g","rect","line","path","circle","image"].forEach(function(t){c(h.getElementsByTagName(t),a.find(t))}),["text"].forEach(function(t){c(h.getElementsByTagName(t),a.find(t));for(var e=h.getElementsByTagName(t),n=a.find(t),r=0;r<e.length;r++){var s=e.item(r),i=n[r];["font-family","font-size","font-size-adjust","font-stretch","font-style","font-variant","font-weight","text-anchor","dominant-baseline"].forEach(function(t){s.setAttribute(t,$(i).attr(t)||$(i).css(t))})}}),h.getElementsByTagName("image")),w={},m=(n,r,s)=>{var i=n.getAttribute("xlink:href")||n.getAttribute("href"),a=i.substr(-4,4).toLowerCase(),o={".jpg":"jpeg",jpeg:"jpeg",".png":"png",".svg":"svg+xml"};if(w[i])return n.setAttribute("xlink:href","data:image/"+o[a]+";base64,"+w[i]),s(r-1);switch(a){case".jpg":case"jpeg":case".png":var l=new XMLHttpRequest;l.open("GET",i,!0),l.responseType="arraybuffer";l.onload=function(t){var e=l.response;e&&(e=(t=>{for(var e="",n=new Uint8Array(t),r=n.byteLength,s=0;s<r;s++)e+=String.fromCharCode(n[s]);return window.btoa(e)})(e),w[i]=e,n.setAttribute("xlink:href","data:image/"+o[a]+";base64,"+e)),s(r-1)},l.send(null);break;case".svg":$.get(i,function(t){var e=new XMLSerializer,e=btoa(e.serializeToString(t));w[i]=e,n.setAttribute("xlink:href","data:image/svg+xml;base64,"+e),s(r-1)})}},d=t=>{t<0?e((new XMLSerializer).serializeToString(v(h))):m(f.item(t),t,d)};0<f.length?m(f.item(f.length-1),f.length-1,d):e((new XMLSerializer).serializeToString(v(h)))}function generatorFunctionForVersion(t,e){var n,r=t.settings.version.split("."),s=r[0],r=r[1];if("3"==s){if("0"==r)return nr_intro_generate_svg_3_0(t,e);if("1"==r)return nr_intro_generate_svg_3_1(t,e)}return"4"==s&&"0"==r?nr_intro_generate_svg_4_0(t,e):(n=t,t=>{var e="Node-RED version ("+n.settings.version+") not supported";n.notify(e,{type:"error"}),t&&t('<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg width="1000" height="1000" viewBox="0 0 1000 1000" pointer-events="all" style="cursor: crosshair; touch-action: none;" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><style>.small { font: bold 20px sans-serif; fill: red;}</style><text x="10" y="30" class="small">'+e+"</text></svg>")})}function addPanZoom(){var t=d3.select("#node-input-screenshot-svgcontainer svg"),e=(t.html("<g>"+t.html()+"</g>"),setTimeout(()=>{var t=$("#node-input-screenshot-svgcontainer svg"),e=$(t).attr("viewBox").split(" ");t.animate({height:parseInt(e[3]),width:parseInt(e[2])},800,"swing")},100),t.select("g")),n=d3.behavior.zoom().scaleExtent([.1,200]).on("zoom",function(t){e.attr({transform:"translate("+n.translate()+") scale("+n.scale()+")"})});t.call(n)}

   function setupTreelistInfoness(){var e=collectUndocumentedNodes();if(0==e.length){RED.notify("All nodes documented",{type:"success",timeout:2e3});try{$("#node-input-orphan-target-container-div").treeList("empty")}catch(e){}}else{try{$("#node-input-orphan-target-container-div").treeList("empty")}catch(e){$("#node-input-orphan-target-container-div").css({width:"100%",height:"calc(100%)"}).treeList({multi:!1}).on("treelistitemmouseover",function(e,t){}).on("treelistitemmouseout",function(e,t){}).on("treelistselect",function(e,t){t.node&&(RED.workspaces.show(t.node.z,!1,!1,!0),RED.view.reveal(t.node.id,!0),RED.view.redraw())}).on("treelistconfirm",function(e,t){var i;t.node&&(i=t.node.id,setTimeout(()=>{var e=RED.nodes.node(i);e&&(RED.view.reveal(e.id),RED.view.select(e.id),RED.editor.edit(e,"editor-tab-description")),i==RED.workspaces.active()&&RED.workspaces.edit()},50))}),$("#node-input-orphan-target-filter").show();var i=$("#node-input-orphan-target-filter").searchBox({style:"compact",delay:300,change:function(){var e,t=$(this).val().trim().toLowerCase();""===t?($("#node-input-orphan-target-container-div").treeList("filter",null),i.searchBox("count","")):(e=$("#node-input-orphan-target-container-div").treeList("filter",function(e){return-1<e.label.toLowerCase().indexOf(t)||-1<e.node.type.toLowerCase().indexOf(t)}),i.searchBox("count",e+" / "+$("#node-input-orphan-target-container-div").treeList("data").length))}})}$("#node-input-orphan-target-container-div").treeList("data",e.sort((e,t)=>e.node.z>t.node.z))}}function collectUndocumentedNodes(){let t=[];RED.nodes.eachNode(e=>{if($("#"+e.id).find(".red-ui-info-available-indicator").remove(),e.info&&e.info.trim()){var i=document.createElementNS("http://www.w3.org/2000/svg","g"),n=(i.setAttribute("class","red-ui-info-available-indicator"),document.createElementNS("http://www.w3.org/2000/svg","circle"));n.setAttribute("cx","5"),n.setAttribute("cy","5"),n.setAttribute("r","5"),n.setAttribute("fill","yellow"),n.setAttribute("id","infoclk-"+e.id),n.setAttribute("style","cursor: pointer;"),i.append(n),$(i).insertBefore($("#"+e.id).find(".red-ui-flow-node-changed"));let t=e.id;$("#infoclk-"+e.id).on("click",e=>{e&&e.preventDefault();e=RED.nodes.node(t);RED.editor.edit(e,"editor-tab-description"),RED.sidebar.show("info")})}else e.z==RED.workspaces.active()&&t.push(e)});var o=[],r={};return t.forEach(function(e){var t=RED.nodes.getType(e.type);if(t){var i,n=t.label,n=("function"==typeof n?n.call(e):n)||"";if(0===(i=e.type).indexOf("subflow:"))return}t&&n||(n=e.type),r[e.id]={node:e,label:n,sublabel:i,selected:!1,checkbox:!1},o.push(r[e.id])}),o}

   function highlightAllLinkCalls(){let e=[];RED.nodes.eachNode(t=>{t.z==RED.workspaces.active()&&"link call"==t.type&&e.push(t)}),e.forEach(t=>{$("#grplnkcallclk-"+t.id).remove();var e=document.createElementNS("http://www.w3.org/2000/svg","g"),l=(e.setAttribute("class","red-ui-linkcall-link-indicator"),e.setAttribute("transform","translate(12,0)"),e.setAttribute("id","grplnkcallclk-"+t.id),document.createElementNS("http://www.w3.org/2000/svg","circle")),i=(l.setAttribute("cx","5"),l.setAttribute("cy","5"),l.setAttribute("r","5"),l.setAttribute("id","lnkcallclk-"+t.id),l.setAttribute("style","cursor: pointer;"),t.links[0]);i?RED.nodes.node(i)?l.setAttribute("fill","green"):l.setAttribute("fill","red"):l.setAttribute("fill","orange"),e.append(l),$(e).insertBefore($("#"+t.id).find(".red-ui-flow-node-changed"));let r=t.id;$("#lnkcallclk-"+t.id).on("click",t=>{t&&t.preventDefault();t=RED.nodes.node(r);if(t){let l=t.links[0];1<t.links.length&&RED.notify("Multiple links, showing first","warning"),RED.nodes.node(l)?(RED.view.reveal(l),RED.view.select(l),setTimeout(()=>{$("#lnkcallclk-"+l).remove();var t=document.createElementNS("http://www.w3.org/2000/svg","g"),e=(t.setAttribute("class","red-ui-linkcall-link-indicator"),t.setAttribute("transform","translate(12,0)"),t.setAttribute("id","lnkcallclk-"+l),document.createElementNS("http://www.w3.org/2000/svg","circle"));e.setAttribute("cx","5"),e.setAttribute("cy","5"),e.setAttribute("r","5"),e.setAttribute("id","lnkcallclk-"+l),e.setAttribute("style","cursor: pointer;"),e.setAttribute("fill","green"),t.append(e),$(t).insertBefore($("#"+l).find(".red-ui-flow-node-changed")),$("#lnkcallclk-"+l).on("click",t=>{t&&t.preventDefault(),RED.view.reveal(r),RED.view.select(r),setTimeout(highlightAllLinkCalls,500)})},500)):RED.notify("Link in node not found","error")}else RED.notify("Node not found","error")})})}

   function setupTreelistAllLinksForLinkIn(e){e=collectAllLinksNodes(e);if(0==e.length){RED.notify("No links found",{type:"error",timeout:2e3});try{$("#node-input-orphan-target-container-div").treeList("empty")}catch(e){}}else{try{$("#node-input-orphan-target-container-div").treeList("empty")}catch(e){$("#node-input-orphan-target-container-div").css({width:"100%",height:"calc(100%)"}).treeList({multi:!1}).on("treelistitemmouseover",function(e,t){}).on("treelistitemmouseout",function(e,t){}).on("treelistselect",function(e,t){t.node&&(RED.workspaces.show(t.node.z,!1,!1,!0),RED.view.reveal(t.node.id,!0),RED.view.redraw())}).on("treelistconfirm",function(e,t){var n;t.node&&(n=t.node.id,setTimeout(()=>{var e=RED.nodes.node(n);e&&(RED.view.reveal(e.id),RED.view.select(e.id),RED.editor.edit(e,"editor-tab-description")),n==RED.workspaces.active()&&RED.workspaces.edit()},50))}),$("#node-input-orphan-target-filter").show();var n=$("#node-input-orphan-target-filter").searchBox({style:"compact",delay:300,change:function(){var e,t=$(this).val().trim().toLowerCase();""===t?($("#node-input-orphan-target-container-div").treeList("filter",null),n.searchBox("count","")):(e=$("#node-input-orphan-target-container-div").treeList("filter",function(e){return-1<e.label.toLowerCase().indexOf(t)||-1<e.node.type.toLowerCase().indexOf(t)}),n.searchBox("count",e+" / "+$("#node-input-orphan-target-container-div").treeList("data").length))}})}$("#node-input-orphan-target-container-div").treeList("data",e.sort((e,t)=>e.node.z>t.node.z))}}function collectAllLinksNodes(t){let n=[];RED.nodes.eachNode(e=>{"link call"!=e.type&&"link out"!=e.type||-1<e.links.indexOf(t)&&n.push(e)});var i=[],r={};return n.forEach(function(e){var t=RED.nodes.getType(e.type);if(t){var n,o=t.label,o=("function"==typeof o?o.call(e):o)||"";if(0===(n=e.type).indexOf("subflow:"))return}t&&o||(o=e.type),r[e.id]={node:e,label:o,sublabel:n,selected:!1,checkbox:!1},i.push(r[e.id])}),i}function collectNodeStats(){let t={},n=[],o={workspaces:0,junctions:0,subflows:0,configs:0,groups:0,wires:0,nodes:0},i=(RED.nodes.eachConfig(e=>{o.configs+=1}),RED.nodes.eachLink(e=>{o.wires+=1}),RED.nodes.eachJunction(e=>{o.junctions+=1}),RED.nodes.eachGroup(e=>{o.groups+=1}),RED.nodes.eachWorkspace(e=>{o.workspaces+=1}),RED.nodes.eachSubflow(e=>{o.subflows+=1}),RED.nodes.eachNode(e=>{o.nodes+=1,t[e.type]=(t[e.type]||0)+1}),Object.keys(t).forEach(e=>{n.push({label:e,sublabel:t[e],selected:!1,checkbox:!1})}),[]),r=0;return Object.keys(o).forEach(e=>{r+=o[e],i.push({label:e,sublabel:o[e],selected:!1,checkbox:!1})}),[{label:"__ TOTALS",sublabel:r,selected:!1,checkbox:!1,children:i}].concat(n.sort((e,t)=>e.label>t.label))}function setupTreeListForNodeStats(){var e=collectNodeStats();try{$("#node-input-orphan-target-container-div").treeList("empty")}catch(e){$("#node-input-orphan-target-container-div").css({width:"100%",height:"calc(100%)"}).treeList({multi:!1}).on("treelistitemmouseover",function(e,t){}).on("treelistitemmouseout",function(e,t){}).on("treelistselect",function(e,t){}).on("treelistconfirm",function(e,t){}),$("#node-input-orphan-target-filter").show();var n=$("#node-input-orphan-target-filter").searchBox({style:"compact",delay:300,change:function(){var e,t=$(this).val().trim().toLowerCase();""===t?($("#node-input-orphan-target-container-div").treeList("filter",null),n.searchBox("count","")):(e=$("#node-input-orphan-target-container-div").treeList("filter",function(e){return-1<e.label.toLowerCase().indexOf(t)}),n.searchBox("count",e+" / "+$("#node-input-orphan-target-container-div").treeList("data").length))}})}$("#node-input-orphan-target-container-div").treeList("data",e)}

   // Add your plugin as a new tabsheet in the right sidebar AFTER the flow editor is completely started
   var initialiseConfigNodeOnce = () => {
      RED.events.off('runtime-state', initialiseConfigNodeOnce);

      // The html content of the sidebar has been specified below as a data-template, from where it can be loaded:
      var content = $($('script[type="text/x-red"][data-template-name="Screenshot"]').i18n().html());
    
      // Add a "Your sidebar" tabsheet to the right sidebar panel, in which this sidebar panel can be displayed
      // --> more details: https://nodered.org/docs/api/ui/sidebar/
      RED.sidebar.addTab({
         id: "Introspection",
         label: "Introspection", // short name for the tab
         name: "Introspection", // long name for the menu
         content: content,
         enableOnEdit: true,
         iconClass: "fa fa-camera" // your fontawesome icon
      });

      var tabs = RED.tabs.create({
            id: 'func-introspection-tabs',
            onchange: function(tab) {
               $('#func-introspection-tabs-content').children().hide();
               $('#' + tab.id).show();
            }
      });
      
      // Add first tab, screenshot
      tabs.addTab({
            id: 'func-introspection-tab-screenshot',
            iconClass: 'fa fa-photo',
            label: 'Screenshot'
      });
      
      // Add tab, orphans
      tabs.addTab({
            id: 'func-introspection-tab-lint',
            iconClass: 'fa fa-eyedropper',
            label: 'Lint'
      });

      // Add tab, obfuscation
      tabs.addTab({
            id: 'func-introspection-tab-obfuscation',
            iconClass: 'fa fa-user-secret',
            label: 'Obfuscation'
      });
      
      $('#node-input-obfuscation-generate-btn').on("click", function (e) {
         if ( e ) { e.preventDefault() }
         
         obfuscatieCurrentFlow({
            name: $('#node-input-obfuscate-name').is(":checked"),
            info: $('#node-input-obfuscate-info').is(":checked"),
            position: $('#node-input-obfuscate-position').is(":checked"),
            
            shrink_node: $('#node-input-obfuscate-shrink-size').is(":checked"),
            remove_groups: $('#node-input-obfuscate-remove-groups').is(":checked"),
            javascript: $('#node-input-obfuscate-javascript').is(":checked"),

            remove_junctions: $('#node-input-obfuscate-remove-junctions').is(":checked"),
            remove_icons: $('#node-input-obfuscate-remove-icons').is(":checked"),
            remove_debugs: $('#node-input-obfuscate-remove-debugs').is(":checked"),

            remove_linkout_nodes: $('#node-input-obfuscate-remove-linknodes').is(":checked"),
            copy_linkin_nodes: $('#node-input-obfuscate-copy-linkin-nodes').is(":checked"),
            ignore_off_flow_links: $('#node-input-obfuscate-ignore-off-flow-links').is(':checked'),
            remove_linkcall_nodes: $("#node-input-obfuscate-remove-linkcall-nodes").is(":checked"),

            replace_switch: $('#node-input-obfuscate-replace-switch').is(":checked"),
            replace_change: $('#node-input-obfuscate-replace-change').is(":checked"),

            add_license: $('#node-input-obfuscate-add-license-text').is(":checked"),
            append_license: $('#node-input-obfuscate-append-license-text').is(":checked"),
            license_text: $('#node-input-obfuscate-license-text').val(),
         })
      })

      $('#node-input-obfuscate-add-license-text').on('change', (e) => {
         if ( $('#node-input-obfuscate-add-license-text').is(":checked") ) {
            $('#node-input-obfuscate-add-license-text-row').fadeIn(300)
         } else {
            $('#node-input-obfuscate-add-license-text-row').fadeOut(300)
         }
      })

      $('#node-input-obfuscate-remove-linknodes').on('change', (e) => {
         if ( $('#node-input-obfuscate-remove-linknodes').is(":checked") ) {
            $('#node-input-obfuscate-coalesce-link-out-options').fadeIn(300)
         } else {
            $('#node-input-obfuscate-coalesce-link-out-options').fadeOut(300)
         }
      })

      $('#node-screenshot-capture-btn').on("click", function (e) {
         if ( e ) { e.preventDefault() }

         $('#node-input-screenshot-svgcontainer').html( "" );

         RED.notify(
            "Please wait, screenshot being prepared ...", {
            type: "success"
            }
         );

         let opts = {
            rmidsandclasses: $('#node-input-screenshot-remove-classes-and-ids').is('checked')
         }
         generatorFunctionForVersion(RED, opts)( (svgdata) => {
            $('#node-input-screenshot-svgcontainer').html(svgdata);
            globalRefToSvgData = svgdata;
            setTimeout(() => {
               addPanZoom()
            },150)
         });
      })

      $('#node-screenshot-post-svg-to-endpoint').on('click', (e) => {
         if (e) { e.preventDefault(); }
         let postEndpoint = $('#node-input-svgpost-endpoint').val() || "/screenshot"

         RED.notify(
            "Posting to endpoint ...", {
            type: "success"
            }
         );
         
         $.ajax({
            type: "POST",
            url: postEndpoint,
            dataType: "application/json;charset=utf-8",
            data: {
               d: globalRefToSvgData
            },
            complete: (obj) => {
               switch( obj.status ) {
               case 413:
               // apiMaxLength in the settings.js is set to 5mb by default,
               // if svg larger than that, need to increase the limit.
               // Provide a hint to that setting in the error message.
               RED.notify(
                  "Screenshot too large, increase apiMaxLength in settings.js.", {
                     type: "error"
                  }
               );
               break;
               case 404:
               // Http-in POST node is missing
               RED.notify(
                  "Missing http-in node: method: POST, path: " + postEndpoint, {
                     type: "error"
                  }
               );
               break;
               case 200:
                  RED.notify("Screenshot successfully posted", {
                     type: "success"
                  });
               break;
               default:
               RED.notify(
                  "Screenshot failed: " + obj.statusText + "  " + obj.status, {
                     type: "error"
                  }
               );
               };
            },
         });
         
      })

      // handle the download button under the editor window.
      $('#node-screenshot-download-svg').on("click", function (e) {
        if (e) { e.preventDefault(); }
        var svgBlob = new Blob([globalRefToSvgData], {type:"image/svg+xml;charset=utf-8"});
        var svgUrl = URL.createObjectURL(svgBlob);
        var downloadLink = document.createElement("a");
        downloadLink.href = svgUrl;
        downloadLink.download = "screenshot.svg";
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
      });

      $('#node-screenshot-copy-to-clipboard-svg').on("click", function (e) {
        if (e) { e.preventDefault(); }
        if ( RED.clipboard.copyText(globalRefToSvgData) ) {
          RED.notify("SVG copied to clipboard", { type: "success" });
        }
      });

      // When the user has entered new data in the sidebar, then store it into the config node
      $("#node-input-orphan-find-btn").on("click", function(e) {
         if ( e ) { e.preventDefault() }
         setupTreelist();
      })

      $('#node-input-documentation-find-btn').on('click', (e) => {
         if ( e ) { e.preventDefault() }
         setupTreelistInfoness();
      })

      $('#node-input-linkin-nodes-find-btn').on('click', (e) => {
         if ( e ) { e.preventDefault() }

         let linkNodes = (RED.view.selection().nodes || []).filter( (e) => {
            return e.type == "link in"
         }).map( e => e.id )

         if ( linkNodes.length == 0 ) {
            RED.notify(
               "No link in node selected, selected exactly one.", {
                  type: "error"
               }
            );
         } else {
            setupTreelistAllLinksForLinkIn(linkNodes[0])
         }
      })

      $('#node-input-orphan-clear-workspace-btn').on('click', (e) => {
         if ( e ) { e.preventDefault() }
         $('.red-ui-linkcall-link-indicator').remove()
      })

      RED.actions.add( "introspection:show-link-call-links", highlightAllLinkCalls)
      
      $('#node-input-linkcalls-find-btn').on('click', (e) => {
         if ( e ) { e.preventDefault() }
         highlightAllLinkCalls()
         
         /*
         try {
            $("#node-input-orphan-target-container-div").treeList('empty')
         } catch (ex) { }
         */
      })

      $('#node-input-statistics-btn').on('click', (e) => {
         if ( e ) { e.preventDefault() }
         setupTreeListForNodeStats()
      })
   };
   RED.events.on('runtime-state', initialiseConfigNodeOnce);
})();
</script>

<style>
   .col-100 .red-ui-typedInput-container {
   width: 70% !important;
   }
   
   .col-100.no-label .red-ui-typedInput-container {
   width: 100% !important;
   }
   .w-30 {
      width: 40% !important;
      margin-left: 10px;
   }   
   .ml-30 {
      margin-left: 30px !important;
   }

</style>

<!-- The html for the right sidebar plugin screen -->
<script type="text/x-red" data-template-name="Screenshot">
<div class="form-row func-introspection-tabs-row">
   <ul style="min-width: 600px; margin-bottom: 20px;" id="func-introspection-tabs"></ul>
</div>

<div id="func-introspection-tabs-content" style="min-height: calc(100% - 95px);">

   <!-- Screenshot Tab in Sidebar -->

   <div id="func-introspection-tab-screenshot" style="display:none; min-height: calc(100%);">
      <div class="form-row">
         <div class="col-100">

            <div class="form-row" style="margin-left: 10px; margin-top: 30px;">
               <button type="button" id="node-screenshot-capture-btn"
                       class="red-ui-button red-ui-button-large"><i class="fa fa-camera"></i> Capture</button>

               <label for="node-input-screenshot-remove-classes-and-ids" class="ml-30" style="width: 200px">
                  <span>Remove Classes and Ids?</span>
               </label>
               <input type="checkbox" checked="checked" id="node-input-screenshot-remove-classes-and-ids"
                                             style="display:inline-block; width:15px; vertical-align:baseline;">                          
            </div>

            <div class="form-row" style="margin-left: 10px; margin-top: 30px;">
               Step 1: Capture a screen shot, Step 2: download it, copy it or post off.
            </div>


            <div class="form-row"
               style="min-height: 300px; height: 450px; overflow: hidden; margin-left: 10px; margin-right: 15px; border: 1px rgb(196, 196, 196) solid; border-radius: 5px;">
               <div id="node-input-screenshot-svgcontainer"></div>
            </div>

            <div class="form-row" style="margin-left: 10px; margin-top: 30px;">
               <button type="button" id="node-screenshot-download-svg"
                          class="red-ui-button red-ui-button-large"><i class="fa fa-download"></i> Download</button>
               <button type="button" id="node-screenshot-copy-to-clipboard-svg"
                           class="red-ui-button red-ui-button-large"><i class="fa fa-clipboard"></i> Copy to Clipboard</button>
            </div>

            <div class="form-row" style="margin-left: 10px; margin-top: 30px;">
               <input type="text" id="node-input-svgpost-endpoint" placeholder="/screenshot" style="width: 40% !important;">
               <button type="button" id="node-screenshot-post-svg-to-endpoint"
                       class="red-ui-button red-ui-button-large"><i class="fa fa-send-o"></i> Post to Endpoint</button>
            </div>

         </div>
      </div>
   </div>

   <!-- Lint Tab in Sidebar -->

   <div id="func-introspection-tab-lint" style="display:none; min-height: calc(100%);">
      <div class="form-row" style="margin-left: 10px; margin-top: 30px">
         <button id="node-input-orphan-find-btn"
                     class="red-ui-button"><i class="fa fa-life-ring"></i> Unconnected</button>
         <button id="node-input-documentation-find-btn"
                     class="red-ui-button"><i class="fa fa-cc"></i> Undocumented</button>
         <button id="node-input-linkin-nodes-find-btn"
                     class="red-ui-button"><i class="fa fa-link"></i> Link Ins</button>
         <button id="node-input-statistics-btn"
                     class="red-ui-button"><i class="fa fa-pie-chart"></i> Stats</button>
      </div>

      <div class="form-row"
         style="margin-left: 10px; position: relative; min-height: 200px; height: 450px; margin-right: 15px;">
         <div style="margin-bottom: 5px; width: 35%; padding-left: 60%;">
            <input type="text" id="node-input-orphan-target-filter" style="display: none;">
         </div>
         <div id="node-input-orphan-target-container-div"></div>
      </div>

      <div class="form-row" style="margin-left: 10px; margin-top: 40px">
         <button id="node-input-linkcalls-find-btn"
                           class="red-ui-button"><i class="fa fa-link"></i> Link Calls</button>
         <button id="node-input-orphan-clear-workspace-btn"
                           class="red-ui-button">Clear dots</button>
      </div>
   </div>

   <!-- Obfuscation Tab in Sidebar -->

   <div id="func-introspection-tab-obfuscation" style="display:none; min-height: calc(100%);">

      <div class="form-row">
         <label for="node-input-obfuscate-name" class="w-30">
               <i class="fa fa-tag"></i>
               <span>Obfuscate Name?</span>
            </label>
         <input type="checkbox" id="node-input-obfuscate-name"
                     style="display:inline-block; width:15px; vertical-align:baseline;">
      </div>

      <div class="form-row">
         <label for="node-input-obfuscate-position" class="w-30">
               <i class="fa fa-map-pin"></i>
               <span>Obfuscate Position?</span>
            </label>
         <input type="checkbox" id="node-input-obfuscate-position"
                   style="display:inline-block; width:15px; vertical-align:baseline;">
      </div>

      <div class="form-row">
         <label for="node-input-obfuscate-shrink-size" class="w-30">
                        <i class="fa fa-angle-down"></i>
                        <span>Shrink Nodes?</span>
                     </label>
         <input type="checkbox" id="node-input-obfuscate-shrink-size"
                            style="display:inline-block; width:15px; vertical-align:baseline;">
      </div>

      <div class="form-row">
         <label for="node-input-obfuscate-javascript" class="w-30">
               <i class="fa fa-code"></i>
               <span>Obfuscate Javascript?</span>
            </label>
         <input type="checkbox" id="node-input-obfuscate-javascript"
                              style="display:inline-block; width:15px; vertical-align:baseline;">
      </div>

      <div class="form-row col-100">
         <label for="node-input-obfuscate-remove-icons" class="w-30">
               <i class="fa fa-adjust"></i>
               <span>Remove Icon?</span>
            </label>
         <input type="checkbox" id="node-input-obfuscate-remove-icons"
                              style="display:inline-block; width:15px; vertical-align:baseline;">
      </div>

      <div class="form-row">
         <label for="node-input-obfuscate-info" class="w-30">
               <i class="fa fa-info"></i>
               <span>Remove Info?</span>
            </label>
         <input type="checkbox" id="node-input-obfuscate-info"
                              style="display:inline-block; width:15px; vertical-align:baseline;">
      </div>

      <div class="form-row">
         <label for="node-input-obfuscate-remove-groups" class="w-30">
               <i class="fa fa-object-group"></i>
               <span>Remove Groups?</span>
            </label>
         <input type="checkbox" id="node-input-obfuscate-remove-groups"
                              style="display:inline-block; width:15px; vertical-align:baseline;">
      </div>

      <div class="form-row">
         <label for="node-input-obfuscate-remove-debugs" class="w-30">
               <i class="fa fa-bug"></i>
               <span>Remove comment & debugs?</span>
            </label>
         <input type="checkbox" id="node-input-obfuscate-remove-debugs"
                                       style="display:inline-block; width:15px; vertical-align:baseline;">
      </div>

      <div class="form-row">
         <label for="node-input-obfuscate-remove-junctions" class="w-30">
                        <i class="fa fa-sitemap"></i>
                        <span>Coalesce Junctions?</span>
                     </label>
         <input type="checkbox" id="node-input-obfuscate-remove-junctions"
                                       style="display:inline-block; width:15px; vertical-align:baseline;">
      </div>

      <div class="form-row">
         <label for="node-input-obfuscate-remove-linkcall-nodes" class="w-30">
                        <i class="fa fa-unlink"></i>
                        <span>Coalesce Link Call Nodes?</span>
                     </label>
         <input type="checkbox" id="node-input-obfuscate-remove-linkcall-nodes" style="display:inline-block; width:15px; vertical-align:baseline;">
      </div>

      <div class="form-row">
         <label for="node-input-obfuscate-remove-linknodes" class="w-30">
               <i class="fa fa-unlink"></i>
               <span>Coalesce Link Out Nodes?</span>
         </label>
         <input type="checkbox" id="node-input-obfuscate-remove-linknodes"
                              style="display:inline-block; width:15px; vertical-align:baseline;">
      </div>

      <div id="node-input-obfuscate-coalesce-link-out-options" style="display: none;">
         <div class="form-row">
            <label for="node-input-obfuscate-copy-linkin-nodes" class="ml-30" style="width: 150px;">
                  <span>Copy Link-In Nodes?</span>
            </label>
            <input type="checkbox" id="node-input-obfuscate-copy-linkin-nodes" style="display:inline-block; width:15px; vertical-align:baseline;">
         </div>
         <div class="form-row">
            <label for="node-input-obfuscate-ignore-off-flow-links" class="ml-30" style="width: 150px;">
                  <span>Ignore off-flow links?</span>
            </label>
            <input type="checkbox" id="node-input-obfuscate-ignore-off-flow-links" style="display:inline-block; width:15px; vertical-align:baseline;">
         </div>
      </div>

      <div class="form-row">
         <label class='w-30'>
                        <i class="fa fa-refresh"></i>
                        <span>Replace Nodes:</span>
                     </label>
      </div>

      <div class="form-row">
         <label for="node-input-obfuscate-replace-switch" class="ml-30">
                        <span>Switch</span>
                     </label>
         <input type="checkbox" id="node-input-obfuscate-replace-switch"
                            style="display:inline-block; width:15px; vertical-align:baseline;">
      </div>

      <div class="form-row">
         <label for="node-input-obfuscate-replace-change" class="ml-30">
                       <span>Change</span>
                     </label>
         <input type="checkbox" id="node-input-obfuscate-replace-change"
                                        style="display:inline-block; width:15px; vertical-align:baseline;">
      </div>

      <div class="form-row">
         <label for="node-input-obfuscate-add-license-text" class="w-30">
            <i class="fa fa-gavel"></i>
            <span>Replace info with license?</span>
         </label>
         <input type="checkbox" id="node-input-obfuscate-add-license-text" style="display:inline-block; width:15px; vertical-align:baseline;">
      </div>
      
      <div id="node-input-obfuscate-add-license-text-row" style="display: none;">
         <div class="form-row ml-30">
            <label for="node-input-obfuscate-append-license-text" style="width: 150px">
               <span>Append to info?</span>
            </label>
            <input type="checkbox" id="node-input-obfuscate-append-license-text" style="display:inline-block; width:15px; vertical-align:baseline;">
         </div>
         <div class="form-row ml-30">
            <textarea id="node-input-obfuscate-license-text" placeholder="License Text"></textarea>
         </div>
      </div>

      <div class="form-row">
         <div class="col-100">
            <div class="form-row node-input-target-row" style="margin-left: 10px; margin-top: 30px">
               <button id="node-input-obfuscation-generate-btn"
                                         class="red-ui-button"><i class="fa fa-low-vision"></i> Obfuscate</button>
            </div>
         </div>
      </div>

      <div class="form-row" style="margin-left: 10px">
         <b>Warning</b>: No guarantee is made that the obfuscated flow still works. This has not be
         thoroughly tested. Ensure correctness by completely testing the resultant obfuscated flow.
         No warranty of success is provided, implied or expressed.
      </div>
   </div>
</script>
<!-- --- [red-plugin:@gregoriusrippenstein/node-red-contrib-flowcompare/sidebar-plugin] --- -->
<script src="FlowCompare/jslib/diff.min.js"></script>
<script src="FlowCompare/jslib/flowviewer.min.js"></script>

<script type="text/javascript">
(function() {
   var globalYourConfigNode = null;

   function escapeHtml(e){return String(e).replace(/[&<>"'`=\/]/g,function(e){return entityMap[e]})}function addPanZoom(){var e=$(".flowviewer svg"),t=(e.attr("width",""),e.attr("height",""),e.css("width",$(".flowviewer").width()+"px"),e.css("height","300px"),$(".flowviewer svg .containerGroup")[0].getBBox());e.attr("viewBox",[t.x,t.y,t.width,t.height].join(" "));(e=d3.select(".flowviewer svg")).html("<g>"+e.html()+"</g>");var o=e.select("g"),n=d3.behavior.zoom().scaleExtent([.3,100]).on("zoom",function(e){o.attr({transform:"translate("+n.translate()+") scale("+n.scale()+")"})});e.call(n)}var entityMap={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"},descMap={z:"Flow Tab Id",g:"Group Id",d:"Disabled",w:"Width",h:"Height"};function attrDesc(e){return descMap[e]?" <i style='font-size: 80%;'>("+descMap[e]+")</i>":""}function createDiff(r,c){var s=[],l=[];if(Object.keys(c).forEach(function(e){var t;Object.keys(r).indexOf(e)<0&&(t="object"==typeof c[e]?JSON.stringify(c[e]):c[e],s.push("<tr class='dv-removed'><th>"+e+attrDesc(e)+"</th><td><i>MISSING</i></td><td><code>"+escapeHtml(t)+"</code></td></tr>"),l.push(e))}),Object.keys(r).forEach(function(e){var t;Object.keys(c).indexOf(e)<0&&(t="object"==typeof r[e]?JSON.stringify(r[e]):r[e],s.push("<tr class='dv-added'><th>"+e+attrDesc(e)+"</th><td><code>"+escapeHtml(t)+"</code></td><td><i>ADDED</i></td></tr>"),l.push(e))}),Object.keys(r).forEach(function(n){if(-1<Object.keys(c).indexOf(n))if(JSON.stringify(r[n])!==JSON.stringify(c[n])){let o=null,t=void 0;l.push(n);try{t=Diff.diffLines(c[n],r[n])}catch(e){t=Diff.diffLines(JSON.stringify(c[n],void 0,1),JSON.stringify(r[n],void 0,1))}const a=document.createDocumentFragment();t.forEach(e=>{var t=e.added?"green":e.removed?"red":"#040506";(o=document.createElement("pre")).setAttribute("class","dv-pre-elem"),o.style.color=t,o.appendChild(document.createTextNode(e.value)),o.appendChild(document.createElement("br")),a.appendChild(o)});var e,d=document.createElement("tr"),i=(d.setAttribute("class","dv-differ"),document.createElement("th"));i.appendChild(document.createTextNode(n)),descMap[n]&&((e=document.createElement("i")).style["font-size"]="80%",e.appendChild(document.createTextNode("("+descMap[n]+")")),i.appendChild(e)),d.append(i),(i=document.createElement("td")).setAttribute("colspan","2"),i.append(a),d.append(i),s.push(d.outerHTML)}else s.push("<tr><th>"+n+"</th><td><code>"+escapeHtml(r[n])+"</code></td><td><code>"+escapeHtml(c[n])+"</code></td></tr>")}),0==l.length){let o=null;var e="OBJ",t=Diff.diffJson(c,r);const i=document.createDocumentFragment();t.forEach(e=>{var t=e.added?"green":e.removed?"red":"#040506";(o=document.createElement("pre")).setAttribute("class","dv-pre-elem"),o.style.color=t,o.appendChild(document.createTextNode(e.value)),o.appendChild(document.createElement("br")),i.appendChild(o)});var n,t=document.createElement("tr"),d=(t.setAttribute("class","dv-differ"),document.createElement("th"));return d.appendChild(document.createTextNode(e)),descMap[e]&&((n=document.createElement("i")).style["font-size"]="80%",n.appendChild(document.createTextNode("("+descMap[e]+")")),d.appendChild(n)),t.append(d),(d=document.createElement("td")).setAttribute("colspan","2"),d.append(i),t.append(d),{html:t.outerHTML,icon:"fa-question"}}var o=["x","y","w","h","g","wires"];return{html:s.join(""),icon:0==l.filter(e=>o.indexOf(e)<0).length?"fa-eye":"fa-pencil"}}function getFlowDataFromCurrentWorkspace(){var e=RED.workspaces.active(),t=RED.nodes.groups(e),e=(t=(t=t.concat(RED.nodes.junctions(e))).concat(RED.nodes.filterNodes({z:e})),RED.nodes.eachConfig(function(e){e.z===RED.workspaces.active()&&!1===e._def.hasUsers&&t.push(e)}),RED.nodes.workspace(e)||RED.nodes.subflow(e));return t.unshift(e),RED.nodes.createExportableNodeSet(t)}function doSubmission(n){var t=RED.workspaces.active(),e=n.filter(e=>e.z==t||e.id==t);$($($("#svgelem .container-diff02")[0]).find(".containerGroup")[0]).find("g").html(""),$($($("#svgelem .container-diff01")[0]).find(".containerGroup")[0]).find("g").html(""),$.ajax({url:"FlowCompareCfg",type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify({flowid:t,flowdata:e||{},flowlabel:(RED.nodes.workspace(t)||{label:"subflow"}).label}),success:function(e){var a=[],r={};if("failed"==e.status)RED.notify("Error happened, please check console",{type:"error",timeout:2e3}),console.error("Error in flow compare: ",e);else{renderFlow(e.flowid,e.nodes,$($("#svgelem .container-diff02")[0]),{arrows:!1,gridlines:!1,zoom:!1,images:!0,linklines:!0,dllink:!1,labels:!0}),renderFlow(e.flowid,n,$($("#svgelem .container-diff01")[0]),{arrows:!1,gridlines:!1,zoom:!1,images:!0,linklines:!0,dllink:!1,labels:!0});var t=$(".flowviewer svg"),o=(t.attr("width",""),t.attr("height",""),t.css("width",$(".flowviewer").width()+"px"),t.css("height","300px"),$(".flowviewer svg .containerGroup")[0].getBBox());if(t.attr("viewBox",[o.x,o.y,o.width,o.height].join(" ")),document.getElementById("node-input-compare-slider").oninput=function(){$(".container-diff01").css("opacity",this.value/100),$(".container-diff02").css("opacity",(100-this.value)/100)},e.changes.forEach(function(e){var t,o,n,d,i=e.id;"deleted"==e.type?(r[i]={label:e.oldObj.name||e.oldObj.type,icon:"fa fa-times",class:"",diffcontent:createDiff({},e.oldObj).html,sublabel:e.oldObj.type,selected:!1,checkbox:!1,children:void 0},$(".node-"+i).addClass("deleted"),$(".group-"+i).addClass("deleted"),a.push(r[i])):"added"==e.type?(r[i]={objid:i,label:e.newObj.name||e.newObj.type,icon:"fa fa-check",class:"",diffcontent:createDiff(e.newObj,{}).html,sublabel:e.newObj.type,selected:!1,checkbox:!1,children:void 0},$(".node-"+i).addClass("added"),$(".group-"+i).addClass("added"),a.push(r[i])):"tab"==e.oldObj.type||"group"==e.oldObj.type||"junction"==e.oldObj.type?(d=createDiff(e.newObj,e.oldObj),r[i]={objid:i,label:e.oldObj.name||e.oldObj.type,icon:"fa "+d.icon,class:"",diffcontent:d.html,sublabel:e.type+" - "+e.oldObj.type,selected:!1,checkbox:!1,children:void 0},"fa-eye"==d.icon&&($(".node-"+i).addClass("moved"),$(".group-"+i).addClass("moved")),"fa-pencil"==d.icon&&($(".node-"+i).addClass("changed"),$(".group-"+i).addClass("changed")),a.push(r[i])):((t=RED.nodes.node(i))||console.log("Node not found",e),(o=RED.nodes.getType(t.type))&&(n=("function"==typeof(n=o.label)?n.call(t):n)||""),o&&n||(n=t.type),d=createDiff(e.newObj,e.oldObj),r[t.id]={node:t,objid:i,label:n,icon:"fa "+d.icon,class:"",diffcontent:d.html,sublabel:e.oldObj.type,selected:!1,checkbox:!1,children:void 0},"fa-eye"==d.icon&&($(".node-"+i).addClass("moved"),$(".group-"+i).addClass("moved")),"fa-pencil"==d.icon&&($(".node-"+i).addClass("changed"),$(".group-"+i).addClass("changed")),a.push(r[t.id]))}),0==a.length){RED.notify("No Flow Changes",{type:"warning",timeout:2e3});try{$("#node-input-flowcompare-target-container-div").treeList("empty"),$("#node-input-flowcompare-diffcontainer").html("")}catch(e){}}else{try{$("#node-input-flowcompare-target-container-div").treeList("empty")}catch(e){$("#node-input-flowcompare-target-container-div").css({width:"100%",height:"200px"}).treeList({multi:!1}).on("treelistitemmouseover",function(e,t){$(".node-"+t.objid).addClass("highlight"),$(".group-"+t.objid).addClass("highlight")}).on("treelistitemmouseout",function(e,t){$(".node-"+t.objid).removeClass("highlight"),$(".group-"+t.objid).removeClass("highlight")}).on("treelistselect",function(e,t){t.diffcontent?($("#node-input-flowcompare-diffcontainer").html(t.diffcontent),t.objid&&(RED.view.reveal(t.objid,!0),RED.view.redraw())):$("#node-input-flowcompare-diffcontainer").html("")}).on("treelistconfirm",function(e,t){var o;t.objid&&(o=t.objid,setTimeout(()=>{var e=RED.nodes.node(o);e&&(RED.view.reveal(e.id),RED.view.select(e.id),RED.editor.edit(e)),o==RED.workspaces.active()&&RED.workspaces.edit()},50))})}$("#node-input-flowcompare-target-container-div").treeList("data",a.sort((e,t)=>e.icon>t.icon))}}},error:function(e,t,o){404==e.status?RED.notify("Node has not yet been deployed, please deploy.","error"):405==e.status?RED.notify("Not Allowed.","error"):500==e.status?RED.notify(node._("common.notification.error",{message:node._("inject.errors.failed")}),"error"):0==e.status?RED.notify(node._("common.notification.error",{message:node._("common.notification.errors.no-response")}),"error"):RED.notify(node._("common.notification.error",{message:node._("common.notification.errors.unexpected",{status:e.status,message:t})}),"error")}})}function flowCompareEventListener(e){$("#node-input-flowcompare-autoupdate-button").is(":checked")&&e.old!=e.workspace&&doSubmission(getFlowDataFromCurrentWorkspace())}

   function ensureYourConfigNodeExists() {
      // This function makes sure there is 1 instance of your config node is available, and that the globalYourConfigNode variable refers to it.
      // Explained in the next step of this tutorial... --> https://discourse.nodered.org/t/tutorial-create-a-sidebar-plugin-and-persist-the-data-in-a-config-node/82020

      // If we had found it previously, check if it has been deleted by the user behind our back
      if (globalYourConfigNode !== null) {
         var configNode = RED.nodes.node(globalYourConfigNode.id);
         if (configNode === null) { globalYourConfigNode = null; }
      }

      // If not found previously, let's go find it
      if (globalYourConfigNode === null) {
         var configNodes = [];
         RED.nodes.eachConfig(function(configNode) {
             if (configNode.type === 'FlowCompareCfg') { 
                 configNodes.push(configNode); 
             }
         });

         // Make sure we only have 1 config node
         while (configNodes.length > 1) {
             var configNode = configNodes.pop();
             RED.nodes.remove(configNode.id);
             RED.nodes.dirty(true);
         }

         // When we found a config node, let's use that one
         if (configNodes.length === 1) { globalYourConfigNode = configNodes[0]; }
      }

      // When it doesn't exist yet, create it if required
      if (globalYourConfigNode === null) {
         // Remark: since this config node is dynamically created (and only used in this sidebar which isn't another node), the config
         // node is in fact "unused".  But since we don't want it to appear "unused" in the "config nodes" panel, we need to set hasUsers
         // to false (see https://github.com/node-red/node-red/blob/master/CHANGELOG.md#0161-maintenance-release).
         // The hasUsers needs also to be specified in the RED.nodes.registerType statement!
         globalYourConfigNode = {
             id: RED.nodes.id(), // on the server side, this is called RED.util.generateId()
             _def: RED.nodes.getType("FlowCompareCfg"),
             type: "FlowCompareCfg",
             hasUsers: false, 
             users: [],
             name: "FlowCompare",
             label: function() { return this.name || "FlowCompare"},
             /* values and data defined by this config node */
             data: "some default value", // Default data
         }

         // Add the new config node to the collection of Node-RED nodes
         RED.nodes.add(globalYourConfigNode);

         // Make sure the "Deploy" button becomes active
         RED.nodes.dirty(true);
      }      
   }

   // Add your plugin as a new tabsheet in the right sidebar AFTER the flow editor is completely started
   var initialiseConfigNodeOnce = () => {
      RED.events.off('runtime-state', initialiseConfigNodeOnce);

      // The html content of the sidebar has been specified below as a data-template, from where it can be loaded:
      var content = $($('script[type="text/x-red"][data-template-name="FlowCompare"]').i18n().html());
    
      // Add a "Your sidebar" tabsheet to the right sidebar panel, in which this sidebar panel can be displayed
      // --> more details: https://nodered.org/docs/api/ui/sidebar/
      RED.sidebar.addTab({
         id: "FlowCompare",
         label: "Flow Compare", // short name for the tab
         name: "Flow Compare", // long name for the menu
         content: content,
         closeable: true,
         // disableOnEdit: true,
         enableOnEdit: true,
         iconClass: "fa fa-map" // your fontawesome icon
      });
      
      addPanZoom();
      ensureYourConfigNodeExists();

      RED.events.on('workspace:change', flowCompareEventListener);

      RED.actions.remove("flowcompare:compare-flow-to-remote")
      RED.actions.add("flowcompare:compare-flow-to-remote",function() {
        doSubmission(getFlowDataFromCurrentWorkspace())
      });

      $('#node-input-flowcompare-button').on('click', (e) => {
         if ( e ) { e.preventDefault(); }
         doSubmission(getFlowDataFromCurrentWorkspace())
      });
   };
   RED.events.on('runtime-state', initialiseConfigNodeOnce);
})();
</script>

<style>
.flow-description-text {
  font-family: monospace;
  font-size: 30px;
  dominant-baseline: middle;
}
.flowviewer {
  border: 1px rgb(196, 196, 196) solid;
  border-radius: 5px;
}

.deleted {
  fill: rgb(120, 68, 68);
  fill-opacity: 0.2;
  stroke: black;
  stroke-width: 2px;
}
.added {
  fill: rgb(64, 166, 98);
  fill-opacity: 0.4;
  stroke: rgb(10, 255, 23);
  stroke-width: 4px;
}
.changed {
  fill: rgb(126, 97, 208);
  fill-opacity: 0.6;
  stroke: rgb(229, 0, 156);
  stroke-width: 3px;
}
.moved {
  fill: rgb(210, 251, 89);
  fill-opacity: 0.3;
  stroke: rgb(0, 50, 249);
  stroke-width: 3px;
}

.highlight {
  stroke: rgb(255, 89, 89) !important;
  stroke-width: 10px !important;
}

.diff-viewer {
  overflow: scroll;
  background-color: rgb(244, 244, 244);
  border: 1px solid rgb(196, 196, 196);
  height: 80vh;
  padding: 20px;
  max-width: 90vw;
  border-radius: 5px;
}

.dv-differ {
  background-color: rgba(244, 170, 23, 0.476) !important;
}

.dv-removed {
  background-color: rgb(203, 203, 38) !important;
}

.dv-added {
  background-color: rgb(86, 222, 120) !important;
}

.dv-pre-elem {
  page-break-inside: avoid;
  font-family: monospace;
  max-width: 100%;
  overflow: auto;
  display: block;
  word-wrap: break-word;
  margin: 0px !important;
}


#diff-viewer{
  overflow:scroll;
  background-color:rgb(244, 244, 244);
  border: 2px solid #000;
  height:80vh;
  display:none;
  position:fixed;
  top:10vh;
  left:5vw;
  z-index: 1000;
  padding: 20px;
  max-width: 90vw;
}

.dv-differ {
  background-color: rgba(244, 170, 23, 0.476) !important;
}

.dv-removed {
  background-color: rgb(203, 203, 38) !important;
}

.dv-added {
  background-color: rgb(86, 222, 120) !important;
}

.dv-pre-elem {
    page-break-inside: avoid;
    font-family: monospace;
    max-width: 100%;
    overflow: auto;
    display: block;
    word-wrap: break-word;
    margin: 0px !important;
}

</style>

<!-- The html for the right sidebar plugin screen -->
<script type="text/x-red" data-template-name="FlowCompare">
  <div class="form-row" style="margin-left: 15px; margin-top: 30px; margin-right: 15px;">
    <button id="node-input-flowcompare-button"
                class="red-ui-button">Compare</button>
    <input type="checkbox" id="node-input-flowcompare-autoupdate-button"
               style="display:inline-block; width:15px; vertical-align:baseline; margin-left: 20px;">
    <label for="node-input-flowcompare-autoupdate-button">Auto Compare</label>
  </div>
    
  <div class="form-row node-input-target-row node-input-target-list-row" 
           style="position: relative; min-height: 100px; margin-left: 10px; margin-right: 15px;">  
    <div id="node-input-flowcompare-target-container-div" style="min-height: 100px"></div>
  </div>
  
  <div class="form-row" style="position: relative; min-height: 300px;  margin-left: 10px; margin-right: 15px;">
    <div id="node-input-flowcompare-svgcontainer" class="flowviewer">
      <svg id="svgelem" pointer-events="all" style="cursor: crosshair; min-height: 300px;"
        version="1.1" xmlns="http://www.w3.org/2000/svg">
        <!-- Use group elems to ensure that layering of shapes is correct, i.e. nodes always over wires -->
        <g class='container-gridlines'>
          <g class='flowGridlines'></g>
        </g>

        <g class='container-diff01' style="opacity: 0;">
          <g class="containerGroup">
            <g class="flowDescription"></g>
            <g class='flowGroups'></g>
            <g class='flowWires'></g>
            <g class='flowNodes'></g>
          </g>
        </g>
        <g class='container-diff02'  style="opacity: 1;">
          <g class="containerGroup">
            <g class="flowDescription"></g>
            <g class='flowGroups'></g>
            <g class='flowWires'></g>
            <g class='flowNodes'></g>
          </g>
        </g>
      </svg>
    </div>
    <input style="width: 100%; min-width: 300px;" id="node-input-compare-slider" type="range" min="0" max="100" step="1" value="0"></input>
  </div>
  
  <div class="form-row" style="position: relative; min-height: 100px;  margin-left: 10px; margin-right: 15px;">
    <div id="node-input-flowcompare-diffcontainer" class="diff-viewer"></div>
  </div>

</script>
<!-- --- [red-plugin:@gregoriusrippenstein/node-red-contrib-nodedev/nodefactory_sidebar] --- -->
<script type="text/javascript">
(function() {
   var globalYourConfigNode = null;

   function doGenerateOTP(cfgnode, cb) {
      ensureYourConfigNodeExists();

      $.ajax({
         url:         "NodeDevOtpGenerator",
         type:        "POST",
         contentType: "application/json; charset=utf-8",

         data: JSON.stringify({
            cfgnode: cfgnode
         }),

         success: function (resp) {
            $('#node-input-nodedev-sidebar-otp').val(resp.data.otp)
            cb(resp)
         },

         error: function (jqXHR, textStatus, errorThrown) {
            RED.notify("Generating failed: " + textStatus, {
               type: "error",
               id: "NodeFactorySidebar",
               timeout: 2000
            });
            console.log(textStatus,errorThrown )
         }
      });      

   }

   function doSubmission(pkgname,pkgversion) {
      ensureYourConfigNodeExists();

      $.ajax({
         url:         "NodeFactorySidebarCfg",
         type:        "POST",
         contentType: "application/json; charset=utf-8",

         data: JSON.stringify({
            pkgname: $("#node-input-nodefactorysidebar-package-name").val().trim(),
            pkgversion: $("#node-input-nodefactorysidebar-package-version").val().trim(),
            pkgregistry: $("#node-input-nodefactorysidebar-package-registry").val().trim()
         }),

         success: function (resp) {
            RED.notify("Submission triggered", {
               type: "warning",
               id: "NodeFactorySidebar",
               timeout: 2000
            });
         },

         error: function (jqXHR, textStatus, errorThrown) {
            RED.notify("Submission failed: " + textStatus, {
               type: "error",
               id: "NodeFactorySidebar",
               timeout: 2000
            });
            console.log(textStatus,errorThrown )
         }
      });      
   }

   function ensureYourConfigNodeExists() {
      // This function makes sure there is 1 instance of your config node is available, and that the globalYourConfigNode variable refers to it.
      // Explained in the next step of this tutorial... --> https://discourse.nodered.org/t/tutorial-create-a-sidebar-plugin-and-persist-the-data-in-a-config-node/82020

      // If we had found it previously, check if it has been deleted by the user behind our back
      if (globalYourConfigNode !== null) {
         var configNode = RED.nodes.node(globalYourConfigNode.id);
         if (configNode === null) { globalYourConfigNode = null; }
      }

      // If not found previously, let's go find it
      if (globalYourConfigNode === null) {
         var configNodes = [];
         RED.nodes.eachConfig(function(configNode) {
             if (configNode.type === 'NodeFactorySidebarCfg') { 
                 configNodes.push(configNode); 
             }
         });

         // Make sure we only have 1 config node
         while (configNodes.length > 1) {
             var configNode = configNodes.pop();
             RED.nodes.remove(configNode.id);
             RED.nodes.dirty(true);
         }

         // When we found a config node, let's use that one
         if (configNodes.length === 1) { globalYourConfigNode = configNodes[0]; }
      }

      // When it doesn't exist yet, create it if required
      if (globalYourConfigNode === null) {
         // Remark: since this config node is dynamically created (and only used in this sidebar which isn't another node), the config
         // node is in fact "unused".  But since we don't want it to appear "unused" in the "config nodes" panel, we need to set hasUsers
         // to false (see https://github.com/node-red/node-red/blob/master/CHANGELOG.md#0161-maintenance-release).
         // The hasUsers needs also to be specified in the RED.nodes.registerType statement!
         let typ = RED.nodes.getType("NodeFactorySidebarCfg");

         globalYourConfigNode = {
            id: RED.nodes.id(), // on the server side, this is called RED.util.generateId()
            _def: typ,
            type: "NodeFactorySidebarCfg",
            hasUsers: false, 
            users: [],
            name: "NodeFactorySidebar",
            label: function() { return this.name || "NodeFactorySidebar"},
            /* values and data defined by this config node */
            pkgname: typ.defaults.pkgname.value, 
            pkgversion: typ.defaults.pkgversion.value,
            otptype: typ.defaults.otptype.value,
            algorithm: typ.defaults.algorithm.value,
            secret: typ.defaults.secret.value,
            secretType: typ.defaults.secretType.value,
            issuer: typ.defaults.issuer.value,
            otplabel: typ.defaults.otplabel.value,
            digits: typ.defaults.digits.value,
            counter: typ.defaults.counter.value,
            period: typ.defaults.period.value
         }

         // Add the new config node to the collection of Node-RED nodes
         RED.nodes.add(globalYourConfigNode);

         // Make sure the "Deploy" button becomes active
         RED.nodes.dirty(true);
      }      
   }

   // Add your plugin as a new tabsheet in the right sidebar AFTER the flow editor is completely started
   var initialiseConfigNodeOnce = () => {
      RED.events.off('runtime-state', initialiseConfigNodeOnce);

      // The html content of the sidebar has been specified below as a data-template, from where it can be loaded:
      var content = $($('script[type="text/x-red"][data-template-name="NodeFactorySidebar"]').i18n().html());
    
      // Add a "Your sidebar" tabsheet to the right sidebar panel, in which this sidebar panel can be displayed
      // --> more details: https://nodered.org/docs/api/ui/sidebar/
      RED.sidebar.addTab({
         id: "NodeFactorySidebar",
         label: "Node Dev", // short name for the tab
         name: "Node Dev", // long name for the menu
         content: content,
         closeable: true,
         // disableOnEdit: true,
         enableOnEdit: true,
         iconClass: "fa fa-industry" // your fontawesome icon
      });

      var tabs = RED.tabs.create({
            id: 'func-nodedev-pkgimporter-tabs',
            onchange: function(tab) {
               $('#func-nodedev-pkgimporter-tabs-content').children().hide();
               $('#' + tab.id).show();
            }
      });
      
      // Add first tab, pkg importer
      tabs.addTab({
            id: 'func-nodedev-pkgimporter-tab-pkgimport',
            iconClass: 'fa fa-industry',
            label: 'PkgImporter'
      });

      // Add first tab, otp
      tabs.addTab({
            id: 'func-nodedev-pkgimporter-tab-otpgenerator',
            iconClass: 'fa fa-user-secret',
            label: 'OTP Generator'
      });

      ensureYourConfigNodeExists();

      /*
         ************ Package importer handlers
      */

      var doSomething = (e) => {
         if (e) { e.preventDefault(); }
         doSubmission()
      }

      $('#node-input-nodefactorysidebar-generate-btn').on('click', doSomething );

      $("#node-input-nodefactorysidebar-package-version").on("change", function() {
         ensureYourConfigNodeExists();

         let data = $(this).val();

         if (globalYourConfigNode.pkgversion != data) {
           globalYourConfigNode.pkgversion = data.trim();
           RED.nodes.dirty(true);
         }
      })
      $("#node-input-nodefactorysidebar-package-version").val(globalYourConfigNode.pkgversion);

      $("#node-input-nodefactorysidebar-package-name").on("change", function() {
        ensureYourConfigNodeExists();

        let data = $(this).val();

        if (globalYourConfigNode.pkgname != data) {
           globalYourConfigNode.pkgname = data.trim();
           RED.nodes.dirty(true);
        }
      })
      $("#node-input-nodefactorysidebar-package-name").val(globalYourConfigNode.pkgname);

      $("#node-input-nodefactorysidebar-package-registry").on("change", function() {
        ensureYourConfigNodeExists();

        let data = $(this).val();

        if (globalYourConfigNode.pkgregistry != data) {
           globalYourConfigNode.pkgregistry = data.trim();
           RED.nodes.dirty(true);
        }
      })
      $("#node-input-nodefactorysidebar-package-registry").val(globalYourConfigNode.pkgregistry);

      /*
      ************* OTP generator handlers
      */

      $("#node-input-nodedev-sidebar-otp-secret").typedInput({
         types:["env", "msg", "global", "cred"],
         typeField: "#node-input-nodedev-sidebar-otp-secretType"
      });

      $("#node-input-nodedev-sidebar-otp-secret").typedInput( 'value', globalYourConfigNode.secret || globalYourConfigNode._def.defaults.secret.value );
      $("#node-input-nodedev-sidebar-otp-secret").typedInput( 'type', globalYourConfigNode.secretType || globalYourConfigNode._def.defaults.secretType.value);


      $("#node-input-nodedev-sidebar-otp-secret").on('change', () => {
         ensureYourConfigNodeExists();
         
         let val = $("#node-input-nodedev-sidebar-otp-secret").typedInput('value');
         let typ = $("#node-input-nodedev-sidebar-otp-secret").typedInput('type');

         if ( val != globalYourConfigNode.secret ) {
            globalYourConfigNode.secret = val;
            RED.nodes.dirty(true);
         }

         if ( typ != globalYourConfigNode.secretType ) {
            globalYourConfigNode.secretType = typ;
            RED.nodes.dirty(true);
         }
      })

      $('#node-input-nodedev-sidebar-otp-otptype').val(globalYourConfigNode.otptype || globalYourConfigNode._def.defaults.otptype.value)
      $('#node-input-nodedev-sidebar-otp-algorithm').val(globalYourConfigNode.algorithm || globalYourConfigNode._def.defaults.algorithm.value)
      $('#node-input-nodedev-sidebar-otp-issuer').val(globalYourConfigNode.issuer || globalYourConfigNode._def.defaults.issuer.value)
      $('#node-input-nodedev-sidebar-otp-label').val(globalYourConfigNode.otplabel || globalYourConfigNode._def.defaults.otplabel.value)
      $('#node-input-nodedev-sidebar-otp-digits').val(globalYourConfigNode.digits || globalYourConfigNode._def.defaults.digits.value)
      $('#node-input-nodedev-sidebar-otp-period').val(globalYourConfigNode.period || globalYourConfigNode._def.defaults.period.value)
      $('#node-input-nodedev-sidebar-otp-counter').val(globalYourConfigNode.counter || globalYourConfigNode._def.defaults.counter.value)

      $('#node-input-nodedev-sidebar-otp-otptype').on('change', () => {
         ensureYourConfigNodeExists();
         let val =  $('#node-input-nodedev-sidebar-otp-otptype').val()

         if ( val != globalYourConfigNode.otptype) {
            globalYourConfigNode.otptype = val
            RED.nodes.dirty(true);
         }
      })

      $('#node-input-nodedev-sidebar-otp-algorithm').on('change', () => {
         ensureYourConfigNodeExists();
         let val =  $('#node-input-nodedev-sidebar-otp-algorithm').val()

         if ( val != globalYourConfigNode.algorithm) {
            globalYourConfigNode.algorithm = val
            RED.nodes.dirty(true);
         }
      })

      $('#node-input-nodedev-sidebar-otp-issuer').on('change', () => {
         ensureYourConfigNodeExists();
         let val =  $('#node-input-nodedev-sidebar-otp-issuer').val()

         if ( val != globalYourConfigNode.issuer) {
            globalYourConfigNode.issuer = val
            RED.nodes.dirty(true);
         }
      })

      $('#node-input-nodedev-sidebar-otp-label').on('change', () => {
         ensureYourConfigNodeExists();
         let val =  $('#node-input-nodedev-sidebar-otp-label').val()

         if ( val != globalYourConfigNode.otplabel) {
            globalYourConfigNode.otplabel = val
            RED.nodes.dirty(true);
         }
      })

      $('#node-input-nodedev-sidebar-otp-digits').on('change', () => {
         ensureYourConfigNodeExists();
         let val =  $('#node-input-nodedev-sidebar-otp-digits').val()

         if ( val != globalYourConfigNode.digits) {
            globalYourConfigNode.digits = val
            RED.nodes.dirty(true);
         }
      })

      $('#node-input-nodedev-sidebar-otp-period').on('change', () => {
         ensureYourConfigNodeExists();
         let val =  $('#node-input-nodedev-sidebar-otp-period').val()

         if ( val != globalYourConfigNode.period) {
            globalYourConfigNode.period = val
            RED.nodes.dirty(true);
         }
      })

      $('#node-input-nodedev-sidebar-otp-counter').on('change', () => {
         ensureYourConfigNodeExists();
         let val =  $('#node-input-nodedev-sidebar-otp-counter').val()

         if ( val != globalYourConfigNode.counter) {
            globalYourConfigNode.counter = val
            RED.nodes.dirty(true);
         }
      })

      $('#nodedev-sidebar-otp-generate-btn').on('click', e => {
         if ( e) { e.preventDefault()}
         ensureYourConfigNodeExists();

         doGenerateOTP(globalYourConfigNode, (resp) => {
            $('#node-input-nodedev-sidebar-otp').val(resp.data.otp)
         })
      })
   };

   RED.events.on('runtime-state', initialiseConfigNodeOnce);
})();
</script>

<!-- The html for the right sidebar plugin screen -->
<script type="text/x-red" data-template-name="NodeFactorySidebar">
<div class="form-row func-nodedev-pkgimporter-tabs-row">
    <ul style="min-width: 600px; margin-bottom: 20px;" id="func-nodedev-pkgimporter-tabs"></ul>
</div>

<div id="func-nodedev-pkgimporter-tabs-content" style="min-height: calc(100% - 95px);">

    <div id="func-nodedev-pkgimporter-tab-pkgimport" style="display:none">

        <div class="form-row" style="margin-left: 10px; margin-top: 30px;">
            Import <a href="https://npmjs.com" target=_blank>npmJs.com</a> packages as a flow. packages
            are imported as a collection of PkgFile nodes. This can help to learn from other
            peoples experiences and code.
        </div>

        <div class="form-row" style="margin-left: 10px;">
            Enter package details here:
        </div>

        <div class="form-row" style="margin-left: 10px;">
            <label for="node-input-nodefactorysidebar-package-name">
                <i class="fa fa-tag"></i>
                Name
            </label>
            <input type="text" id="node-input-nodefactorysidebar-package-name"
              placeholder="node-red-dashboard">
        </div>

        <div class="form-row" style="margin-left: 10px;">
            <label for="node-input-nodefactorysidebar-package-version">
                <i class="fa fa-tag"></i>
                Version
            </label>
            <input type="text" id="node-input-nodefactorysidebar-package-version"
           placeholder="3.5.0">
        </div>

        <div class="form-row" style="margin-left: 10px;">
            <label for="node-input-nodefactorysidebar-package-registry">
                                <i class="fa fa-tag"></i>
                                Registry
                            </label>
            <input type="text" id="node-input-nodefactorysidebar-package-registry"
                           placeholder="https://registry.npmjs.org">
        </div>

        <div class="form-row">
            <div style="position: relative; height: 100%; margin: 15px;">
                <button id="node-input-nodefactorysidebar-generate-btn"
                 class="red-ui-button"
                 style="width: 100%; margin-top: 30px">Import Package</button>
            </div>
        </div>

    </div>

    <div id="func-nodedev-pkgimporter-tab-otpgenerator" style="display:none">

        <div class="form-row" style="margin-left: 10px;">
            <label for="node-input-nodedev-sidebar-otp-otptype"><i class="fa fa-tag"></i> Type</label>
            <select id="node-input-nodedev-sidebar-otp-otptype">
                <option value="totp">Time-Based (TOTP)</option>
                <option value="hotp">HMAC-based (HOTP)</option>
            </select>
        </div>

        <div class="form-row" style="margin-left: 10px;">
            <label for="node-input-nodedev-sidebar-otp-secret">
                <i class="fa fa-key"></i>
                Secret
            </label>
            <input type="text" id="node-input-nodedev-sidebar-otp-secret">
            <input type="hidden" id="node-input-nodedev-sidebar-otp-secretType">
        </div>

        <div class="form-row" style="margin-left: 10px;">
            <label for="node-input-nodedev-sidebar-otp-algorithm"><i class="fa fa-tag"></i> Algorithm</label>
            <select id="node-input-nodedev-sidebar-otp-algorithm">
                    <option value="SHA1">SHA1</option>
                    <option value="SHA256">SHA256</option>
                    <option value="SHA512">SHA512</option>
            </select>
        </div>

        <div class="form-row" style="margin-left: 10px;">
            <label for="node-input-nodedev-sidebar-otp-issuer"><i class="fa fa-tag"></i> Issuer</label>
            <input type="text" id="node-input-nodedev-sidebar-otp-issuer" placeholder="Issuer">
        </div>

        <div class="form-row" style="margin-left: 10px;">
            <label for="node-input-nodedev-sidebar-otp-label"><i class="fa fa-tag"></i> Label</label>
            <input type="text" id="node-input-nodedev-sidebar-otp-label" placeholder="Label">
        </div>

        <div class="form-row" style="margin-left: 10px;">
            <label for="node-input-nodedev-sidebar-otp-digits"><i class="fa fa-tag"></i> Digits</label>
            <input type="text" id="node-input-nodedev-sidebar-otp-digits" placeholder="Digits">
        </div>

        <div class="form-row" style="margin-left: 10px;">
            <label for="node-input-nodedev-sidebar-otp-period"><i class="fa fa-tag"></i> Period</label>
            <input type="text" id="node-input-nodedev-sidebar-otp-period" placeholder="Period">
        </div>

        <div class="form-row" style="margin-left: 10px;">
            <label for="node-input-nodedev-sidebar-otp-counter"><i class="fa fa-tag"></i> Counter</label>
            <input type="text" id="node-input-nodedev-sidebar-otp-counter" placeholder="Counter">
        </div>

        <div class="form-row" style="margin-left: 10px;">
            <button id="nodedev-sidebar-otp-generate-btn" class="button">Generate</button>
            <input type="text" id="node-input-nodedev-sidebar-otp" placeholder="OTP...">
        </div>
    </div>
</div>
</script>

<!-- --- [red-plugin:@gregoriusrippenstein/node-red-contrib-flow2uml/sidebar-plugin] --- -->
<script type="text/javascript">
(function() {
   var globalYourConfigNode = null;

   window.FlowToMermaid={constructMermaid:function(e,l="TB",r=void 0){for(var n={payload:e},e=n.payload.filter(e=>"tab"!=e.type&&"group"!=e.type),t={},i=0;i<e.length;i++){var a=e[i];t[a.id]=a}var s=r,o=(r||(s={nodes:{node:e=>t[e],subflow:e=>t[e]}}),e=>e&&{nnull:"not null",eq:"==",neq:"!=",lt:"<",lte:"<=",gt:">",gte:">=",hask:"has key",cont:"contains"}[e]||e),c=e=>e.replaceAll("&","&amp;").replaceAll("#","#35;").replaceAll("[","#91;").replaceAll("]","#93;").replaceAll("(","#40;").replaceAll(")","#41;").replaceAll("|","#124;").replaceAll(">","&gt;").replaceAll("<","&lt;").replaceAll("{","#123;").replaceAll("}","#125;").replaceAll("/","#47;").replaceAll('"',"#34;"),p=(e,l=void 0)=>{if(!e)return"";var r=e.name||e.type;switch(l=l?'|"'+c(l)+'"| ':"",r=c(r),e.type){case"switch":case"join":case"split":return l+e.id+'{"'+r+'"}';case"link call":case"link out":if(e.mode&&"return"==e.mode)return l+e.id+"[\\Link Return/]";if(!e.name||e.name.match(/^link out/)){if("dynamic"==e.linkType)return l+e.id+'{{"'+(r="\\Dynamic Target/")+'"}}';var n=e.links&&0<e.links.length&&(t[e.links[0]]||s.nodes.node(e.links[0])),r=c(n&&n.name||e.type)}return l+e.id+'{{"'+r+'"}}';case"link in":return r=c(e.name||e.links&&0<e.links.length&&t[e.links[0]]&&t[e.links[0]].name||e.type),l+e.id+'{{"'+r+'"}}';case"junction":return l+e.id+'(("conn"))';case"inject":case"debug":return l+e.id+'(["'+r+'"])';case"http in":return l+e.id+'["'+c("["+e.method+"] "+e.url)+'"]';default:return e.type.startsWith("subflow:")&&(n=s.nodes.subflow(e.type.replace(/subflow:/,"")),r=c(n&&n.name||e.type)),l+e.id+'["'+r+'"]'}};n.mermaid=["%% change this to LR Node-RED like UML","graph "+l];for(var u,i=0;i<e.length;i++){var d=e[i];if(d.links&&0<d.links.length&&"link out"==d.type)for(var h=0;h<d.links.length;h++)t[d.links[h]]&&n.mermaid.push(p(d)+" -.-> "+d.links[h]);if(d.wires&&0<d.wires.length)if("switch"==d.type)for(var m=0;m<d.wires.length;m++)for(var f=0;f<d.wires[m].length;f++)t[d.wires[m][f]]&&n.mermaid.push(p(d)+" --\x3e "+p(t[d.wires[m][f]],(u=d.rules[m]).v&&u.t?o(u.t)+" "+u.v:u.v&&!u.t?u.v:o(u.t)));else{var k,w=d.outputLabels;d.type.startsWith("subflow:")&&(w=(k=s.nodes.subflow(d.type.replace(/subflow:/,"")))&&k.outputLabels||w);for(m=0;m<d.wires.length;m++)for(f=0;f<d.wires[m].length;f++)t[d.wires[m][f]]&&n.mermaid.push(p(d)+" --\x3e "+p(t[d.wires[m][f]],w&&w[m]||void 0))}}return n.mermaid.join("\n")}};
  
   function obtainCurrentActiveFlow() {
      // check whether there is a current selection of nodes: if so, use that instead
      // of the current active tab.
      if ( Object.keys(RED.view.selection()).length > 0 && RED.view.selection().nodes.length > 0 ) {
         return RED.nodes.createExportableNodeSet(RED.view.selection().nodes)
      }

      var activeWorkspace = RED.workspaces.active();
      var nodes = RED.nodes.groups(activeWorkspace);

      nodes = nodes.concat(RED.nodes.junctions(activeWorkspace));
      nodes = nodes.concat(RED.nodes.filterNodes({ z: activeWorkspace }));

      RED.nodes.eachConfig(function (n) {
        if (n.z === RED.workspaces.active() && n._def.hasUsers === false) {
          // Grab any config nodes scoped to this flow that don't
          // require any flow-nodes to use them
          nodes.push(n);
        }
      });

      var parentNode = RED.nodes.workspace(
        activeWorkspace
      ) || RED.nodes.subflow(activeWorkspace);

      nodes.unshift(parentNode);

      return RED.nodes.createExportableNodeSet(nodes)
   };

   function getMermaidLink(mermaidTxt) {
      /* 
       * this snippet isn't taken from
       *   https://github.com/mermaid-js/mermaid-live-editor/blob/develop/src/lib/util/serde.ts
       * but it comes from there. Using base64 instead of pako because
       * base64 does not require installing any extras.
       */
      let payload = {
         "code":mermaidTxt,
         "mermaid":"{\n  \"theme\": \"default\"\n}",
         "autoSync":false,
         "updateDiagram":false,
         "panZoom":true,
         "pan": {
            "x":261.5279541015625,
            "y":80.74539184570312
         },
         "zoom": 0.829212067225414,
         "editorMode":"code"
      }
      return "https://mermaid.live/edit#base64:" + btoa( JSON.stringify(payload) )
   };
   
   function ensureYourConfigNodeExists() {
      // This function makes sure there is 1 instance of your config node is available, and that the globalYourConfigNode variable refers to it.
      // Explained in the next step of this tutorial... --> https://discourse.nodered.org/t/tutorial-create-a-sidebar-plugin-and-persist-the-data-in-a-config-node/82020

      // If we had found it previously, check if it has been deleted by the user behind our back
      if (globalYourConfigNode !== null) {
         var configNode = RED.nodes.node(globalYourConfigNode.id);
         if (configNode === null) { globalYourConfigNode = null; }
      }

      // If not found previously, let's go find it
      if (globalYourConfigNode === null) {
         var configNodes = [];
         RED.nodes.eachConfig(function(configNode) {
             if (configNode.type === 'Flow2MermaidCfg') { 
                 configNodes.push(configNode); 
             }
         });

         // Make sure we only have 1 config node
         while (configNodes.length > 1) {
             var configNode = configNodes.pop();
             RED.nodes.remove(configNode.id);
             RED.nodes.dirty(true);
         }

         // When we found a config node, let's use that one
         if (configNodes.length === 1) { globalYourConfigNode = configNodes[0]; }
      }

      // When it doesn't exist yet, create it if required
      if (globalYourConfigNode === null) {
         // Remark: since this config node is dynamically created (and only used in this sidebar which isn't another node), the config
         // node is in fact "unused".  But since we don't want it to appear "unused" in the "config nodes" panel, we need to set hasUsers
         // to false (see https://github.com/node-red/node-red/blob/master/CHANGELOG.md#0161-maintenance-release).
         // The hasUsers needs also to be specified in the RED.nodes.registerType statement!
         globalYourConfigNode = {
             id: RED.nodes.id(), // on the server side, this is called RED.util.generateId()
             _def: RED.nodes.getType("Flow2MermaidCfg"),
             type: "Flow2MermaidCfg",
             hasUsers: false, 
             users: [],
             name: "Flow2Uml",
             label: function() { return this.name || "Flow2Uml"},
             /* values and data defined by this config node */
             direction: "TB", // Default data
             genmereditor: ""
         }

         // Add the new config node to the collection of Node-RED nodes
         RED.nodes.add(globalYourConfigNode);

         // Make sure the "Deploy" button becomes active
         RED.nodes.dirty(true);
      }      
   }

   // Add your plugin as a new tabsheet in the right sidebar AFTER the flow editor is completely started
   var initialiseConfigNodeOnce = () => {
      RED.events.off('runtime-state', initialiseConfigNodeOnce);

      // The html content of the sidebar has been specified below as a data-template, from where it can be loaded:
      var content = $($('script[type="text/x-red"][data-template-name="Flow2Mermaid"]').i18n().html());
    
      // Add a "Your sidebar" tabsheet to the right sidebar panel, in which this sidebar panel can be displayed
      // --> more details: https://nodered.org/docs/api/ui/sidebar/
      RED.sidebar.addTab({
         id: "Flow2Mermaid",
         label: "Flow2Uml", // short name for the tab
         name: "Flow to UML", // long name for the menu
         content: content,
         closeable: false,
         enableOnEdit: true,
         iconClass: "fa fa-shower", // your fontawesome icon
         onchange: () => { } /* called when tab becomes visible */
      });

      ensureYourConfigNodeExists();
      /* Upgrading node causes errors here since the genmereditor attribute is defined on the "old" config
         node. Hence define it here incase this is the "old" config ndoe. The new config node has this
         attribute *but* has the same type so the new config isn't installed.
      */
      if ( !globalYourConfigNode.genmereditor ) { globalYourConfigNode.genmereditor = ""; RED.nodes.dirty(true); }

      $('#node-input-genmereditor-mermaid-code').html("<code>" + globalYourConfigNode.genmereditor.replaceAll("\n","<br>") + "</code>");
      $('#node-input-genmereditor-mermaid-code').data('mermaid', btoa(globalYourConfigNode.genmereditor))
      $('#genmermaid-view-uml-link').attr('href', getMermaidLink(globalYourConfigNode.genmereditor));

      $("#btn_genmercopy").on('click', (e) => {
         if ( e ) e.preventDefault();
         RED.clipboard.copyText(atob($('#node-input-genmereditor-mermaid-code').data('mermaid')))
         RED.notify("Mermaid UML has been copied to pasteboard.", "success");
      })

      $("#btn_genmersave").on('click', (e) => {
         var data = atob($('#node-input-genmereditor-mermaid-code').data('mermaid'));
         ensureYourConfigNodeExists();
         
         if (globalYourConfigNode.genmereditor != data) {
            globalYourConfigNode.genmereditor = data;
            $('#genmermaid-view-uml-link').attr('href', getMermaidLink(data));
            RED.nodes.dirty(true);
         }
      })

      var doSomething = (e) => {
         if (e) { e.preventDefault(); }
         ensureYourConfigNodeExists();

         var mermaidTxt = FlowToMermaid.constructMermaid(obtainCurrentActiveFlow(), globalYourConfigNode.direction, RED);         

         try {
            /*
            * using encode and unescape here becuase the contents can cause an error:
            * ==> Uncaught DOMException: String contains an invalid character
            * from Stackoverflow, unescape & encode can fix that:
            * ==> https://stackoverflow.com/questions/23223718/failed-to-execute-btoa-on-window-the-string-to-be-encoded-contains-characte
            * But this can alter the text because the encoding isn't Utf8 but encode & unescape forces the encoding to become Utf8.
            */
            $('#node-input-genmereditor-mermaid-code').data('mermaid', btoa(mermaidTxt))
         } catch (ex) {
            $('#node-input-genmereditor-mermaid-code').data('mermaid', btoa(unescape(encodeURIComponent(mermaidTxt))))
         }

         try {
            $('#genmermaid-view-uml-link').attr('href', getMermaidLink(mermaidTxt));
         } catch (ex ) {
            $('#genmermaid-view-uml-link').attr('href', getMermaidLink(unescape(encodeURIComponent(mermaidTxt))))
         }

         try {
            $('#btn_genmersave').attr('href', "data:text/plain;base64," + btoa(mermaidTxt));
         } catch (ex ) {
         }

         try {
            $('#node-input-genmereditor-mermaid-code').html("<code>" + mermaidTxt.replaceAll("\n","<br>") + "</code>");
         } catch ( ex ) {
            $('#node-input-genmereditor-mermaid-code').html("<code>" + unescape(encodeURIComponent(mermaidTxt)).replaceAll("\n","<br>") + "</code>");
         }
      }

      RED.actions.remove("flow2mermaid:convert-flow-to-uml")
      RED.actions.add("flow2mermaid:convert-flow-to-uml",function() {
        doSomething();
        var data = atob($('#node-input-genmereditor-mermaid-code').data('mermaid'));

        RED.clipboard.copyText(data)
        $('#genmermaid-view-uml-link').attr('href', getMermaidLink(data));

        RED.notify("Mermaid UML has been copied to pasteboard.", "success");
      });

      $('#node-input-generate-diagram-but').on('click', (e) => {
         doSomething(e);
      })

      // When the user has entered new data in the sidebar, then store it into the config node
      $("#node-input-genmerdirection").on("change", function() {
        ensureYourConfigNodeExists();

        let data = $(this).val();

         if (globalYourConfigNode.direction != data) {
            globalYourConfigNode.direction = data;
            // Since the config node has been updated, the 'Deploy' button should become active
            RED.nodes.dirty(true);
         }
      })

      $("#node-input-genmerdirection").typedInput({
            types: [
               {
                  value: "genmerdirection",
                  
                  options: [
                        { "value":"TB", "label": "Top to Bottom"},
                        { "value":"LR", "label": "Left to Right"},
                        { "value":"BT", "label": "Bottom to Top"},
                        { "value":"RL", "label": "Right to Left"}
                 ]
               }
            ]
      });
      // At startup load your config node data into the plugin sidebar html elements
      $('#node-input-genmerdirection').val(globalYourConfigNode.direction)

      // Allow dynamic re-size after init. appearance 
      setTimeout(function () {
            $('#node-props').css('width', '100%');
      }, 30);
   };
   RED.events.on('runtime-state', initialiseConfigNodeOnce);
})();
</script>

<style>
   .red-ui-tray-content #dialog-form {
    white-space: nowrap;
}

.full-row .red-ui-typedInput-container {
    min-width: 70%;
}

.col input {
    min-width: 100%;
}

.sml-lbl {
    height: 66px;
}

.sml-lbl label {
    font-size: smaller;
    margin-bottom: 0px;
    display: block !important;
}

.reg-lbl label {
    white-space: nowrap;
    margin-top: 5px;
    height: 0px;
}

.red-ui-editor .form-row label.full-lbl {
    white-space: normal;
    width: 100%;
}

.col {
    float: left;
    margin-right: 5px;
    min-height: 36px;
}

.col .red-ui-typedInput-container {
    width: 100% !important;
}

.col-50 {
    width: 50%;
}

.col-33 {
    width: 33%;
}

.col-66 {
    width: 66%;
}

.col-25 {
    width: 25%;
}

.col-75 {
    width: 75%;
}

.col-100 .red-ui-typedInput-container {
    width: 70% !important;
}

.col-100.no-label .red-ui-typedInput-container {
    width: 100% !important;
}

.txtarea {
    padding-bottom: 26px;
}

.txtarea label {
    vertical-align: top;
    margin-top: 3px;
}

.txtarea textarea {
    width: 70%;
    margin-bottom: -28px !important;
}

.btn-regular {
    margin-bottom: 14px !important;
}

</style>

<!-- The html for the right sidebar plugin screen -->
<script type="text/x-red" data-template-name="Flow2Mermaid">
   <div id="node-props" style="width: 460px; height: 100%; margin-left: 10px; margin-right: 15px; margin-top: 30px;">
      <div class="form-row" style="margin-left: 10px; margin-right: 15px;">
         <button id="node-input-generate-diagram-but" type="button" class="red-ui-button btn-regular"><i class="fa fa-plug"></i> Generate Mermaid Diagram</button>
      </div>

      <!--form-row-->
      <div class="form-row" style="margin-left: 10px; margin-right: 15px;">
         <div class="col-100">
            <label for="node-input-genmerdirection"><i class="fa fa-compass"></i> Direction</label>
            <input type="text" id="node-input-genmerdirection">
         </div>
      </div>

      <!--form-row-->
      <div class="form-row"
         style="min-height: 300px; overflow: scroll; margin-left: 10px; margin-right: 15px; height: calc(100% - 210px); overflow: hidden;">
         <label for="node-input-genmereditor-mermaid-code"><i class="fa fa-pencil"></i> Mermaid</label>
         <div id="node-input-genmereditor-mermaid-code" style="border: 1px rgb(196, 196, 196) solid; border-radius: 5px; overflow: scroll; height: calc(100% - 40px);"></div>
      </div>

      <!--form-row-->
      <div class="form-row" style="margin-left: 10px; margin-right: 15px;">
            <a href="#" download="uml.txt" id="btn_genmersave" type="button"
               class="red-ui-button btn-regular"><i class="fa fa-save"></i> Save</a>
            <button id="btn_genmercopy" style="margin-left: 40px;" type="button" class="red-ui-button btn-regular"><i class="fa fa-copy"></i> Copy to Clipboard</button>
            <a id="genmermaid-view-uml-link" style="color: blue; margin-left: 40px;" target="_blank" href="#">View UML <i class="fa fa-external-link"></i></a>
      </div>
   </div>
   <!--node-props-->

</script>
<!-- --- [red-plugin:@gregoriusrippenstein/node-red-contacts/addressbook_sidebar] --- -->
<script type="text/javascript">
(function() {
   var globalYourConfigNode = null;

   function setupTreelistForSearch(e){e=findSearchResults(e);if(0==e.length){RED.notify("No Contacts Found",{type:"success",timeout:2e3});try{$("#node-input-search-results-target-container-div").treeList("empty")}catch(e){}}else{try{$("#node-input-search-results-target-container-div").treeList("empty")}catch(e){$("#node-input-search-results-target-container-div").css({width:"100%",height:"calc(100%)"}).treeList({multi:!1}).on("treelistitemmouseover",function(e,t){}).on("treelistitemmouseout",function(e,t){}).on("treelistselect",function(e,t){t.node&&(RED.workspaces.show(t.node.z,!1,!1,!0),RED.view.reveal(t.node.id,!0),RED.view.redraw())}).on("treelistconfirm",function(e,t){var r;t.node&&(r=t.node.id,setTimeout(()=>{var e=RED.nodes.node(r);e&&(RED.view.reveal(e.id),RED.view.select(e.id),RED.editor.edit(e)),r==RED.workspaces.active()&&RED.workspaces.edit()},50))}),$("#node-input-search-results-target-filter").show();var r=$("#node-input-search-results-target-filter").searchBox({style:"compact",delay:300,change:function(){var e,t=$(this).val().trim().toLowerCase();""===t?($("#node-input-search-results-target-container-div").treeList("filter",null),r.searchBox("count","")):(e=$("#node-input-search-results-target-container-div").treeList("filter",function(e){return-1<e.label.toLowerCase().indexOf(t)||-1<e.node.type.toLowerCase().indexOf(t)}),r.searchBox("count",e+" / "+$("#node-input-search-results-target-container-div").treeList("data").length))}})}$("#node-input-search-results-target-container-div").treeList("data",e.sort((e,t)=>e.label>t.label))}}function findSearchResults(e){var n=[];let i=e.term,s=e.attr,r=e.currentOnly,a=e.inverse,o=RED.workspaces.active();RED.nodes.eachNode(e=>{if("Contact"==e.type&&(!r||e.z==o)){var t=JSON.parse(e.rawJsonData);let r=!1;t[1].forEach(e=>{var t=Array.isArray(e[3])?e[3].join(";"):e[3]||"";r=r||e[0]==s&&t.match(RegExp(i,"i"))}),(r&&!a||!r&&a)&&n.push(e)}});var c=[],l={};return n.forEach(e=>{var t=RED.nodes.getType(e.type);if(t){var r=t.label,r=("function"==typeof r?r.call(e):r)||"",n=e.type;if(0===n.indexOf("subflow:"))return}t&&r||(r=e.type),l[e.id]={node:e,label:r,sublabel:n,selected:!1,checkbox:!1},c.push(l[e.id])}),c}

   function setupTreelistForDuplicates(e){e=findDuplicatesResults(e);if(0==e.length){RED.notify("No Contacts Found",{type:"success",timeout:2e3});try{$("#node-input-search-results-target-container-div").treeList("empty")}catch(e){}}else{try{$("#node-input-search-results-target-container-div").treeList("empty")}catch(e){$("#node-input-search-results-target-container-div").css({width:"100%",height:"calc(100%)"}).treeList({multi:!1}).on("treelistitemmouseover",function(e,t){}).on("treelistitemmouseout",function(e,t){}).on("treelistselect",function(e,t){t.node&&(RED.workspaces.show(t.node.z,!1,!1,!0),RED.view.reveal(t.node.id,!0),RED.view.redraw())}).on("treelistconfirm",function(e,t){var r;t.node&&(r=t.node.id,setTimeout(()=>{var e=RED.nodes.node(r);e&&(RED.view.reveal(e.id),RED.view.select(e.id),RED.editor.edit(e)),r==RED.workspaces.active()&&RED.workspaces.edit()},50))}),$("#node-input-search-results-target-filter").show();var r=$("#node-input-search-results-target-filter").searchBox({style:"compact",delay:300,change:function(){var e,t=$(this).val().trim().toLowerCase();""===t?($("#node-input-search-results-target-container-div").treeList("filter",null),r.searchBox("count","")):(e=$("#node-input-search-results-target-container-div").treeList("filter",function(e){return-1<e.label.toLowerCase().indexOf(t)||-1<e.node.type.toLowerCase().indexOf(t)}),r.searchBox("count",e+" / "+$("#node-input-search-results-target-container-div").treeList("data").length))}})}$("#node-input-search-results-target-container-div").treeList("data",e.sort((e,t)=>e.sublabel>t.sublabel))}}function findDuplicatesResults(e){let t=[];e.term;let r=e.attr,s=e.currentOnly;e=e.inverse;let n=RED.workspaces.active(),i={},a,o=new Set,c=(RED.nodes.eachNode(t=>{var e;"Contact"!=t.type||s&&t.z!=n||(e=JSON.parse(t.rawJsonData),o.add(t.id),e[1].forEach(e=>{e[0]==r&&""!=(a=Array.isArray(e[3])?e[3].join(";"):e[3]||"")&&(i[a]||=new Set,i[a].add(t.id))}))}),{}),d=new Set;Object.keys(i).forEach(t=>{1<i[t].size&&i[t].forEach(e=>{c[e]=t,d.add(e)})}),e?o.forEach(e=>{d.has(e)||t.push(RED.nodes.node(e))}):d.forEach(e=>{t.push(RED.nodes.node(e))});var l=[],u={};return t.forEach(e=>{var t=RED.nodes.getType(e.type);if(t){var r=t.label,r=("function"==typeof r?r.call(e):r)||"",s=e.type;if(0===s.indexOf("subflow:"))return}t&&r||(r=e.type),u[e.id]={node:e,label:r,sublabel:c[e.id]||s,selected:!1,checkbox:!1},l.push(u[e.id])}),l}

   function selectAllNodesInTreeList(){try{var t=$("#node-input-search-results-target-container-div").treeList("data");if(0==t.length)return RED.notify("No Contacts Found",{type:"success",timeout:2e3});RED.view.select({nodes:t.map(t=>t.node)})}catch(t){return RED.notify("No Contacts Found",{type:"success",timeout:2e3})}}function selectAllNodesInTreeListInCurrentTab(){let e=RED.workspaces.active();try{var t=$("#node-input-search-results-target-container-div").treeList("data");if(0==t.length)return RED.notify("No Contacts Found",{type:"success",timeout:2e3});RED.view.select({nodes:t.map(t=>t.node).filter(t=>t.z==e)})}catch(t){return RED.notify("No Contacts Found",{type:"success",timeout:2e3})}}

   function setupTreelistForNonPrefixedPhones(e){e=findNonPrefixedPhones(e);if(0==e.length){RED.notify("No Contacts Found",{type:"success",timeout:2e3});try{$("#node-input-search-results-target-container-div").treeList("empty")}catch(e){}}else{try{$("#node-input-search-results-target-container-div").treeList("empty")}catch(e){$("#node-input-search-results-target-container-div").css({width:"100%",height:"calc(100%)"}).treeList({multi:!1}).on("treelistitemmouseover",function(e,t){}).on("treelistitemmouseout",function(e,t){}).on("treelistselect",function(e,t){t.node&&(RED.workspaces.show(t.node.z,!1,!1,!0),RED.view.reveal(t.node.id,!0),RED.view.redraw())}).on("treelistconfirm",function(e,t){var n;t.node&&(n=t.node.id,setTimeout(()=>{var e=RED.nodes.node(n);e&&(RED.view.reveal(e.id),RED.view.select(e.id),RED.editor.edit(e)),n==RED.workspaces.active()&&RED.workspaces.edit()},50))}),$("#node-input-search-results-target-filter").show();var n=$("#node-input-search-results-target-filter").searchBox({style:"compact",delay:300,change:function(){var e,t=$(this).val().trim().toLowerCase();""===t?($("#node-input-search-results-target-container-div").treeList("filter",null),n.searchBox("count","")):(e=$("#node-input-search-results-target-container-div").treeList("filter",function(e){return-1<e.label.toLowerCase().indexOf(t)||-1<e.node.type.toLowerCase().indexOf(t)}),n.searchBox("count",e+" / "+$("#node-input-search-results-target-container-div").treeList("data").length))}})}$("#node-input-search-results-target-container-div").treeList("data",e.sort((e,t)=>e.sublabel>t.sublabel))}}function findNonPrefixedPhones(e){let t=[],n=e.currentOnly;e=e.inverse;let r=RED.workspaces.active(),s=[],o=new Set,i=void 0;RED.nodes.eachNode(t=>{var e;"Contact"!=t.type||n&&t.z!=r||(e=JSON.parse(t.rawJsonData),s.push(t.id),e[1].forEach(e=>{"tel"!=e[0]||""==(i=Array.isArray(e[3])?e[3].join(";"):e[3]||"")||i.match(/^[\s\t\n]*[+]/)||i.match(/^[\s\t\n]*00/)||o.add(t.id)}))}),e?s.forEach(e=>{o.has(e)||t.push(RED.nodes.node(e))}):o.forEach(e=>{t.push(RED.nodes.node(e))});var a=[],c={};return t.forEach(e=>{var t=RED.nodes.getType(e.type);if(t){var n=t.label,n=("function"==typeof n?n.call(e):n)||"",r=e.type;if(0===r.indexOf("subflow:"))return}t&&n||(n=e.type),c[e.id]={node:e,label:n,sublabel:r,selected:!1,checkbox:!1},a.push(c[e.id])}),a}
   
   function ensureYourConfigNodeExists() {
      // This function makes sure there is 1 instance of your config node is available, and that the globalYourConfigNode variable refers to it.
      // Explained in the next step of this tutorial... --> https://discourse.nodered.org/t/tutorial-create-a-sidebar-plugin-and-persist-the-data-in-a-config-node/82020

      // If we had found it previously, check if it has been deleted by the user behind our back
      if (globalYourConfigNode !== null) {
         var configNode = RED.nodes.node(globalYourConfigNode.id);
         if (configNode === null) { globalYourConfigNode = null; }
      }

      // If not found previously, let's go find it
      if (globalYourConfigNode === null) {
         var configNodes = [];
         RED.nodes.eachConfig(function(configNode) {
             if (configNode.type === 'AdressBookCfg') { 
                 configNodes.push(configNode); 
             }
         });

         // Make sure we only have 1 config node
         while (configNodes.length > 1) {
             var configNode = configNodes.pop();
             RED.nodes.remove(configNode.id);
             RED.nodes.dirty(true);
         }

         // When we found a config node, let's use that one
         if (configNodes.length === 1) { globalYourConfigNode = configNodes[0]; }
      }

      // When it doesn't exist yet, create it if required
      if (globalYourConfigNode === null) {
         // Remark: since this config node is dynamically created (and only used in this sidebar which isn't another node), the config
         // node is in fact "unused".  But since we don't want it to appear "unused" in the "config nodes" panel, we need to set hasUsers
         // to false (see https://github.com/node-red/node-red/blob/master/CHANGELOG.md#0161-maintenance-release).
         // The hasUsers needs also to be specified in the RED.nodes.registerType statement!
         globalYourConfigNode = {
             id: RED.nodes.id(), // on the server side, this is called RED.util.generateId()
             _def: RED.nodes.getType("AdressBookCfg"),
             type: "AdressBookCfg",
             hasUsers: false, 
             users: [],
             name: "AdressBook",
             label: function() { return this.name || "AdressBook"},
             /* values and data defined by this config node */
             data: "some default value", // Default data
             inverseSearch: false,
             currentTabOnly: false,
         }

         // Add the new config node to the collection of Node-RED nodes
         RED.nodes.add(globalYourConfigNode);

         // Make sure the "Deploy" button becomes active
         RED.nodes.dirty(true);
      }      
   }

   function doSubmission(e){ensureYourConfigNodeExists(),$.ajax({url:"vCardContactSidebarCfg",type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify({rawjsondata:e}),success:function(e){var e=new Blob([e.data.vcards],{type:"text/vcard;charset=utf-8"}),e=URL.createObjectURL(e),t=document.createElement("a");t.href=e,t.download="contacts.vcf",document.body.appendChild(t),t.click(),document.body.removeChild(t)},error:function(e,t,o){RED.notify("Submission failed: "+t,{type:"error",id:"AdressBook",timeout:2e3}),console.log(t,o)}})}

   // Add your plugin as a new tabsheet in the right sidebar AFTER the flow editor is completely started
   var initialiseConfigNodeOnce = () => {
      RED.events.off('runtime-state', initialiseConfigNodeOnce);

      // The html content of the sidebar has been specified below as a data-template, from where it can be loaded:
      var content = $($('script[type="text/x-red"][data-template-name="AdressBook"]').i18n().html());
    
      // Add a "Your sidebar" tabsheet to the right sidebar panel, in which this sidebar panel can be displayed
      // --> more details: https://nodered.org/docs/api/ui/sidebar/
      RED.sidebar.addTab({
         id: "AdressBook",
         label: "adressbook", // short name for the tab
         name: "AdressBook", // long name for the menu
         content: content,
         closeable: true,
         // disableOnEdit: true,
         enableOnEdit: true,
         iconClass: "fa fa-address-card" // your fontawesome icon
      });

      ensureYourConfigNodeExists();

      // At startup load your config node data into the plugin sidebar html elements
      $("#node-input-data").val(globalYourConfigNode.data);
      $('#only-current-tab').prop("checked", globalYourConfigNode.currentTabOnly),
      $('#inverse-search-results').prop("checked", globalYourConfigNode.inverseSearch)

      $('#inverse-search-results').on('change', () => {
         ensureYourConfigNodeExists();
         
         let data = $(this).is(":checked");
         
         if (globalYourConfigNode.inverseSearch != data) {
            globalYourConfigNode.inverseSearch = data;
            RED.nodes.dirty(true);
         }
      })

      $('#only-current-tab').on('change', () => {
         ensureYourConfigNodeExists();
         
         let data = $(this).is(":checked");
         
         if (globalYourConfigNode.currentTabOnly != data) {
            console.log( "UPDATE" )
            globalYourConfigNode.currentTabOnly = data;
            RED.nodes.dirty(true);
         }
      })

      $("#node-input-data").on("change", function() {
        ensureYourConfigNodeExists();

        let data = $(this).val();

         if (globalYourConfigNode.data != data) {
            globalYourConfigNode.data = data;
            // Since the config node has been updated, the 'Deploy' button should become active
            RED.nodes.dirty(true);
         }
      })
      
      $('button.search-button').click( e => {
         if ( e ) { e.preventDefault() }
         
         setupTreelistForSearch( { 
            term: $('#node-input-data').val(), 
            attr: $(e.target).data('attr'), 
            currentOnly: $('#only-current-tab').is(":checked"),
            inverse: $('#inverse-search-results').is(":checked")
         })
      })

      $('button.duplicate-button').click( e => {
         if ( e ) { e.preventDefault() }
         setupTreelistForDuplicates( { 
            term: $('#node-input-data').val(), 
            attr: $(e.target).data('attr'), 
            currentOnly: $('#only-current-tab').is(":checked"),
            inverse: $('#inverse-search-results').is(":checked")
         })
      })

      $('button#non-prefixed-telephone-numbers').click( e => {
         if ( e ) { e.preventDefault() }
         setupTreelistForNonPrefixedPhones({
            currentOnly: $('#only-current-tab').is(":checked"),
            inverse: $('#inverse-search-results').is(":checked")
         })
      })

      $('#select-all-contacts').click( e => {
         if ( e ) { e.preventDefault() }

         selectAllNodesInTreeList()
      })

      $('#select-all-contacts-in-current-tab').click( e => {
         if ( e ) { e.preventDefault() }
         selectAllNodesInTreeListInCurrentTab()
      })

      $('#export-as-vcards').click( e => {
        if ( e ) { e.preventDefault() }

         doSubmission( (RED.view.selection().nodes || []).filter( nd => nd.type == "Contact" ).map( nd => nd.rawJsonData ) )
      })

   };
   RED.events.on('runtime-state', initialiseConfigNodeOnce);
})();
</script>


<!-- The html for the right sidebar plugin screen -->
<script type="text/x-red" data-template-name="AdressBook">
   <div class="form-row">
   <div style="position: relative; height: 100%; margin: 15px;">
      <label for="node-input-data"><i class="fa fa-search"></i> Term</label>
      <input type="text" id="node-input-data" style="width: 100%; margin-top: 30px"/>
   </div>
</div>

<div class="form-row" style="margin-left: 10px; margin-top: 15px">
   <label for="only-current-tab" style="width: 40%;"><i class="fa fa-search" ></i> Only current tab?</label>
   <input style="width: 10%;" type="checkbox" id="only-current-tab"/>
</div>

<div class="form-row" style="margin-left: 10px; margin-top: 15px">
   <label for="inverse-search-results" style="width: 40%;"><i class="fa fa-search" ></i> Inverse Results?</label>
   <input style="width: 10%;" type="checkbox" id="inverse-search-results"/>
</div>

<div class="form-row" style="margin-left: 10px; margin-top: 15px">
   <button class="red-ui-button search-button" data-attr="org"><i class="fa fa-industry"></i> Companies</button>
   <button class="red-ui-button search-button" data-attr="tel"><i class="fa fa-phone"></i> Tel</button>
   <button class="red-ui-button search-button" data-attr="fn"><i class="fa fa-tag"></i> Name</button>
   <button class="red-ui-button search-button" data-attr="note"><i class="fa fa-sticky-note-o"></i> Notes</button>
   <button class="red-ui-button search-button" data-attr="url"><i class="fa fa-link"></i> URL</button>
</div>

<div class="form-row" style="margin-left: 10px; margin-top: 15px">   
   <button class="red-ui-button duplicate-button" data-attr="fn"><i class="fa fa-tag"></i> Duplicate - Fullname</button>
   <button class="red-ui-button duplicate-button" data-attr="url"><i class="fa fa-link"></i> Duplicate - Url</button>
   <button class="red-ui-button duplicate-button" data-attr="tel"><i class="fa fa-phone"></i> Duplicate - Phone</button>
   <button class="red-ui-button duplicate-button" data-attr="email"><i class="fa fa-envelope"></i> Duplicate - Email</button>
</div>

<div class="form-row" style="margin-left: 10px; margin-top: 15px">
   <button id="non-prefixed-telephone-numbers" class="red-ui-button" data-attr="tel"><i class="fa fa-phone"></i> Non-Prefixed - Phone</button>
</div>

<div class="form-row"
   style="margin-left: 10px; position: relative; min-height: 200px; height: 450px; margin-right: 15px;">
   <div style="margin-bottom: 5px; width: 35%; padding-left: 60%;">
      <input type="text" id="node-input-search-results-target-filter" style="display: none;">
   </div>
   <div id="node-input-search-results-target-container-div"></div>
</div>

<div class="form-row" style="margin-left: 10px; margin-top: 40px">
   <button id="select-all-contacts" class="red-ui-button" data-attr="fn"><i class="fa fa-tag"></i> Select All</button>
   <button id="select-all-contacts-in-current-tab" class="red-ui-button" data-attr="fn"><i class="fa fa-tag"></i> Select All in Current Tab</button>
   <button id="export-as-vcards" class="red-ui-button" data-attr="fn"><i class="fa fa-download"></i> Export Selected</button>   
</div>
</script>


<!-- --- [red-plugin:@bartbutenaers/node-red-autolayout-sidebar/sidebar-plugin] --- -->
<!--
  Copyright 2023, Bart Butenaers & Gerrit Riessen
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at
  http://www.apache.org/licenses/LICENSE-2.0
  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<script src="auto_layout_config/lib/elkjs"></script>
<script src="auto_layout_config/lib/dagrejs"></script>

<script type="text/javascript">
(function() {
    var globalAutoLayoutConfigNode = null;
    
    function findSelectedNodes(/*thisNode*/) {
        /*
         * Take the selection and create a nodeset from it.
         */
        var selection = RED.view.selection();
        var fixedNodeId = undefined;
        var ns = undefined;

        if (!selection.nodes || selection.nodes.length == 0) {
            RED.notify("Select exactly one node.");
            return;
        }

        if ( selection.nodes.length == 1 ) {
            // This is not applicable for the sidebar plugin
            //if (selection.nodes[0].id == thisNode.id || selection.nodes[0].type == thisNode.type) {
            //    RED.notify("Please do not select the align node.");
            //    return;
            //}

            if ( selection.nodes[0].type == "group") {
                ns = RED.group.getNodes(selection.nodes[0])
                if ( ns.length == 0 ) {
                    RED.notify("Empty group selected, very funny.");
                    return;
                }
                fixedNodeId = ns[0].id;
            } else {
                ns = RED.nodes.getAllFlowNodes(selection.nodes[0])
                fixedNodeId = selection.nodes[0].id;
            }
        }

        if ( selection.nodes.length > 1 ) {
            ns = []
            for ( var idx = 0 ; idx < selection.nodes.length ; idx++ ) {
                if ( selection.nodes[idx].type == "group") {
                    ns = ns.concat(RED.group.getNodes(selection.nodes[idx]))
                } else {
                    ns.push(selection.nodes[idx])
                    fixedNodeId ||= selection.nodes[idx].id;
                }
          }

          fixedNodeId ||= ns[0].id;
        }

        if ( !ns ) {
            RED.notify("No nodes selected.");
            return;
        }

        /* 
         * From here it's all nodeset based.
         */

        // Convert nodes to flows.json format since all the wires, i.e. links, are 
        // contained in one simple json format.
        let fixedNode = RED.nodes.node(fixedNodeId)
        var allnodes = RED.nodes.createExportableNodeSet(ns).filter((n) => {
            return n.type != "tab" && n.type != 'subflow' && n.type != "group" && n.z == fixedNode.z
        });

        var alledges = [];
        var allNodeIds = allnodes.map( d => d.id);

        allnodes.forEach((n) => {
            // Only continue if the node has wires (e.g. a ui_group has no wires)
            if (n.wires) {
                for (var widx = 0; widx < (n.wires || []).length; widx++) {
                    for (var xidx = 0; xidx < n.wires[widx].length; xidx++) {
                        if ( allNodeIds.indexOf(n.wires[widx][xidx])> -1){
                            alledges.push({
                                id: n.id + n.wires[widx][xidx],
                                sources: [n.id],
                                targets: [n.wires[widx][xidx]]
                            });
                        }
                    }
                }
            }
        })

        allnodes = allnodes.map((n) => {
            let bbox = ( ( document.getElementById(n.id) && document.getElementById(n.id).getBBox && document.getElementById(n.id) ) || {
              getBBox: () => {
                return {
                  width: 0,
                  height: 0
                }
              }
            });

            return {
                id: n.id,
                width: bbox.getBBox().width + 3,
                height: bbox.getBBox().height + 3,
            }
        });

        return {
            allnodes: allnodes,
            alledges: alledges,
            fixedNodeId: fixedNodeId
        };
    }
    
    function moveNodes(fixedNodeId, children) {
        //var children = payload.nodes;
        //var fixedNodeId = payload.fixedNodeId;

        var changedNodes = [];

        // Before moving anything we get the offset (x,y) - this is the amount that our
        // fixed Node moved - our fixed node does not move, this means everything is offset
        // by the distance it moved.
        var offsetX = 0;
        var offsetY = 0;
        children.forEach((c) => {
            if (c.id == fixedNodeId) {
                var nd = RED.nodes.node(c.id) || RED.nodes.junction(c.id);
                offsetX = c.x - nd.x;
                offsetY = c.y - nd.y;
            }
        });

        children.forEach((c) => {
            var nd = RED.nodes.node(c.id) || RED.nodes.junction(c.id);

            changedNodes.push({
                n: nd,
                ox: nd.x,
                oy: nd.y,
                moved: nd.moved
            });

            nd.x = c.x - offsetX;
            nd.y = c.y - offsetY;
            nd.dirty = true;
        });

        RED.history.push({ t: "move", nodes: changedNodes, dirty: RED.nodes.dirty() });
        RED.nodes.dirty(true);
        RED.view.redraw(true);
    }
    
    function getDefaultSettings() {
        return {
            "dagre_lr": {
                "rankdir": "LR",
                "marginx": 20,
                "marginy": 20,
                "nodesep": 30,
                "ranksep": 50
            },
            "dagre_longest_path": {
                "rankdir": "LR",
                "marginx": 2,
                "marginy": 2,
                "ranker": "longest-path",
                "nodesep": 2,
                "ranksep": 2
            },
            "elkjs_mr_tree": {
                "algorithm": "mrtree",
                "childAreaHeight": 4500,
                "childAreaWidth": 4500,
                "org.eclipse.elk.direction": "RIGHT"
            },
            "elkjs_layered_upwards": {
                "algorithm": "org.eclipse.elk.layered",
                "elk.direction": "UP",
                "cycleBreaking.strategy": "INTERACTIVE",
                "layering.strategy": "INTERACTIVE",
                "crossingMinimization.semiInteractive": true,
                "separateConnectedComponents": true,
                "nodePlacement.strategy": "NETWORK_SIMPLEX",
                "spacing.nodeNode": 70,
                "spacing.nodeNodeBetweenLayers": 25,
                "spacing.edgeNode": 25,
                "spacing.edgeNodeBetweenLayers": 20,
                "spacing.edgeEdge": 20,
                "spacing.edgeEdgeBetweenLayers": 15,
                "elk.hierarchyHandling": "INCLUDE_CHILDREN",
                "elk.layered.spacing.edgeNodeBetweenLayers": 40,
                "elk.layered.nodePlacement.bk.fixedAlignment": "BALANCED",
                "layering.layerConstraint": "FIRST"
            },
            "elkjs_layered_downwards": {
                "algorithm": "org.eclipse.elk.layered",
                "elk.direction": "DOWN",
                "cycleBreaking.strategy": "INTERACTIVE",
                "layering.strategy": "INTERACTIVE",
                "crossingMinimization.semiInteractive": true,
                "separateConnectedComponents": true,
                "nodePlacement.strategy": "NETWORK_SIMPLEX",
                "spacing.nodeNode": 70,
                "spacing.nodeNodeBetweenLayers": 25,
                "spacing.edgeNode": 25,
                "spacing.edgeNodeBetweenLayers": 20,
                "spacing.edgeEdge": 20,
                "spacing.edgeEdgeBetweenLayers": 15
            },
            "elkjs_box": {
                "algorithm": "org.eclipse.elk.box",
                "childAreaHeight": 3000,
                "childAreaWidth": 3000
            },
            "pull_request_2267": {
                // TODO
            }
        }
    }
  
    // Ensure that the globalAutoLayoutConfigNode (still) exists, because the user might have deleted it meanwhile...
    // !!!!!!!!!!!!!!! CALL THIS FUNCTION EVERYWHERE THE globalAutoLayoutConfigNode IS BEING USED !!!!!!!!!!!!!!!
    function ensureAutoLayoutConfigNode() {
        // If we had found it previously, check if it has been deleted by the user behind our back
        if (globalAutoLayoutConfigNode !== null) {
            var configNode = RED.nodes.node(globalAutoLayoutConfigNode.id);
            if (configNode === null) { globalAutoLayoutConfigNode = null; }
        }

        // If not found previously, let's go find it
        if (globalAutoLayoutConfigNode === null) {
            var configNodes = [];
            console.log("=======================> HIER configNodes via eachConfig nodig")
            RED.nodes.eachConfig(function(configNode) {
                if (configNode.type === 'auto_layout_config') { 
                    configNodes.push(configNode); 
                }
            });

            // Make sure we only have 1 config node
            while (configNodes.length > 1) {
                var configNode = configNodes.pop();
                RED.nodes.remove(configNode.id);
                RED.nodes.dirty(true);
            }

            // When we found a config node, let's use that one
            if (configNodes.length === 1) { globalAutoLayoutConfigNode = configNodes[0]; }
        }

        // When it doesn't exist yet, create it if required
        if (globalAutoLayoutConfigNode === null) {
            // TODO controleren of de defaults door de config node code zelf toegepast worden????

            // Remark: since this config node is dynamically created (and only used in this sidebar which isn't another node), the config
            // node is in fact "unused".  But since we don't want it to appear "unused" in the "config nodes" panel, we need to set hasUsers
            // to false (see https://github.com/node-red/node-red/blob/master/CHANGELOG.md#0161-maintenance-release).
            // The hasUsers needs also to be specified in the RED.nodes.registerType statement!
            globalAutoLayoutConfigNode = {
                id: RED.nodes.id(),
                _def: RED.nodes.getType("auto_layout_config"),
                type: "auto_layout_config",
                hasUsers: false, 
                users: [],
                // TODO default values for all properties
                name: "AutoLayout",
                label: function() { return this.name || "AutoLayout"},
                algorithm: "dagre_lr", // Default algorithm
                settings: JSON.stringify(getDefaultSettings()) // Start with the default settings per algorithm
            }

            // Add the new config node to the collection of Node-RED nodes
            RED.nodes.add(globalAutoLayoutConfigNode);

            // Make sure the "Deploy" button becomes active
            RED.nodes.dirty(true);
        }
    }

    function executeAutoLayout() {
        ensureAutoLayoutConfigNode();

        let currentAlgorithm = globalAutoLayoutConfigNode.algorithm;
        let currentAlgorithmSettings = JSON.parse(globalAutoLayoutConfigNode.settings)[currentAlgorithm];

        let selection = findSelectedNodes();

        if (!selection) {
            return;
        }

        switch(currentAlgorithm) {
            case "dagre_lr":
            case "dagre_longest_path":
                // Code take from https://pastebin.com/TJRFD3mg
                // Which came from https://discourse.nodered.org/t/read-flows-json-and-position-the-nodes-in-most-efficient-readable-way/78158/12
                var g = new dagre.graphlib.Graph();
                g.setGraph(currentAlgorithmSettings);
                g.setDefaultEdgeLabel(function () { return {}; });                       

                for (var idx = 0; idx < selection.allnodes.length; idx++) {
                    var n = selection.allnodes[idx];
                    g.setNode(n.id, {
                        ...n,
                    })
                }
                
                // The above loop can be replaced by :
                // for (var idx = 0; idx < selection.allnodes.length; idx++) {
                //     var node = selection.allnodes[idx];
                //     var clonedNode = Object.assign({}, node);
                //     g.setNode(n.id, clonedNode);
                // }


                for (var idx = 0; idx < selection.alledges.length; idx++) {
                    var e = selection.alledges[idx];
                    g.setEdge(e.sources[0], e.targets[0])
                }

                dagre.layout(g);
                
                var nodes = g.nodes().map(function (v) {
                     return {
                          ...g.node(v)
                        }
                })   
                
                try {
                    moveNodes(selection.fixedNodeId, nodes);
                } catch ( ex ) {
                    console.error( "Dagre exception moving nodes", ex)
                    // ensure that dagre errors are also shown as notifications in Node-RED.
                    RED.notify("Dagre autoroute error: " + ex);
                }
                break;
            case "elkjs_mr_tree": 
            case "elkjs_layered_upwards": 
            case "elkjs_layered_downwards": 
            case "elkjs_box": 
                // see https://github.com/kieler/elkjs#api for more details
                var graph = {
                    id: "root",
                    layoutOptions: currentAlgorithmSettings,
                    children: selection.allnodes,
                    edges: selection.alledges
                };

                const elk = new ELK();

                elk.layout(graph)
                    .then((g) => {
                        moveNodes(selection.fixedNodeId, g.children);
                    })
                    .catch((ex) => {
                        console.error( "ELKjs exception moving nodes", ex)
                        RED.notify("ElkJs autoroute error: " + ex);
                    });
                break;
            
            case "pull_request_2267": 
                // Code Taken from https://github.com/node-red/node-red/pull/2267/files
                // I only replaced 'selection' by 'selection_', but it would be better to use the above 'selection' variable.
                var selection_ = RED.view.selection();
                
                if (!selection_.nodes || selection_.nodes.length !== 1) {
                    RED.notify("Select exactly one node");
                    return;
                }
                
                var ns = undefined;
                if (selection_.nodes[0].type == "group") {
                    ns = RED.group.getNodes(selection_.nodes[0])
                } else {
                    ns = RED.nodes.getAllFlowNodes(selection_.nodes[0]);
                }

                // Find Input node

                var nodes = {};
                var minRank = 0;
                var stack = [];
                var candidateInputs = {};
                var candidateOutputs = {};
                ns.forEach(function (n) {
                    candidateInputs[n.id] = n;
                    candidateOutputs[n.id] = n;
                    nodes[n.id] = {
                        n: n,
                        i: [],
                        o: [],
                        d: -1, // depth from start
                        r: -1, // rank order at that depth
                        downstream: 0
                    }
                });
                RED.nodes.eachLink(function (link) {
                    if (nodes[link.source.id] || nodes[link.target.id]) {
                        nodes[link.source.id].o.push(link.target.id);
                        nodes[link.target.id].i.push(link.source.id);
                        delete candidateInputs[link.target.id]
                        delete candidateOutputs[link.source.id]
                    }
                })

                var inputs = Object.keys(candidateInputs);
                var outputs = Object.keys(candidateOutputs);

                if (inputs.length > 1) {
                    RED.notify("Multiple start points - bailing")
                    return;
                }

                if (outputs.length === 0) {
                    RED.notify("No outputs - is this a big loop? Bailing");
                    return;
                }

                function applyDepth(id, d) {
                    if (nodes[id].d < d) {
                        nodes[id].d = d;
                        nodes[id].o.forEach(function (nid) {
                            applyDepth(nid, d + 1);
                        })
                    }
                }
                applyDepth(inputs[0], 0)

                function calculateDownstream(id, downstream) {
                    nodes[id].downstream += downstream;
                    nodes[id].i.forEach(function (nid) {
                        calculateDownstream(nid, nodes[id].downstream + 1);
                    })
                }
                outputs.forEach(function (id) {
                    calculateDownstream(id, 0)
                })

                var ranks = {};
                function rankNodes(node) {
                    if (node.r === -1) {
                        ranks[node.d] = ranks[node.d] || [];
                        node.r = ranks[node.d].length;
                        ranks[node.d].push(node);
                        node.o.sort(function (a, b) {
                            return nodes[b].downstream - nodes[a].downstream
                        })
                        node.o.forEach(function (nid) {
                            rankNodes(nodes[nid])
                        })
                    }
                }
                rankNodes(nodes[inputs[0]]);
                function shuffleRanks(node) {
                    var pushed = false;
                    if (node.o.length > 1) {
                        var outputs = node.o.slice(0);
                        outputs.sort(function (a, b) {
                            if (nodes[a].d === nodes[b].d) {
                                return nodes[a].r - nodes[b].r;
                            } else {
                                return nodes[b].d - nodes[a].d;
                            }
                        })
                        // outputs.forEach(function(o,i) { console.log(" ",i," + "+nodes[o].n.type," d:",nodes[o].d," r:",nodes[o].r)});
                        var rank = nodes[outputs[0]].r;
                        var depth = nodes[outputs[0]].d;
                        for (var i = 1; i < outputs.length; i++) {
                            // console.log(outputs[i]);
                            var n = nodes[outputs[i]];
                            if (n.d !== depth && n.r === rank) {
                                // need to move n down one.
                                var r = n.r;
                                ns.forEach(function (_n) {
                                    var nn = nodes[_n.id];
                                    if (nn.d >= n.d && nn.d < depth && nn.r >= r) {
                                        pushed = true;
                                        nn.r++;
                                    }
                                })
                            }
                            depth = n.d;
                            rank = n.r;
                        }
                    }
                    node.o.forEach(function (n) {
                        pushed = pushed || shuffleRanks(nodes[n])
                    })
                    return pushed;
                }
                var shuffle = function () {
                    if (shuffleRanks(nodes[inputs[0]])) {
                        shuffle();
                    }
                }
                shuffle();


                var x = nodes[inputs[0]].n.x;
                var y = nodes[inputs[0]].n.y;
                var changedNodes = [];
                ns.forEach(function (n) {
                    var d = nodes[n.id].d;
                    var r = nodes[n.id].r;

                    changedNodes.push({
                        n: n,
                        ox: n.x,
                        oy: n.y,
                        moved: n.moved
                    });

                    n.x = x + d * 200;
                    n.y = y + r * 50;
                    n.dirty = true;
                    // n.dirtyStatus = true;
                    // n.status = {
                    //     text:"d"+d+" : r"+r+" : ds"+nodes[n.id].downstream
                    // }
                });

                if (changedNodes.length > 0) {
                    RED.history.push({ t: "move", nodes: changedNodes, dirty: RED.nodes.dirty() });
                    RED.nodes.dirty(true);
                    RED.view.redraw(true);
                }
                
                break;

        }
    }

    RED.plugins.registerPlugin("autolayout-sidebar-plugin", {});

    // Make sure the editor is completely loaded, before filling the sidebar with content.
    // Because only just before that, RED.nodes will be loaded.  Otherwise RED.nodes.getType("auto_layout_config") would 
    // return undefined, and RED.nodes.add would throw an exception...
    // The problem is that Node-RED does not offer an "editor-loaded" event.
    // I did a feature request for that, but for some obscure reason it was not accepted...
    // (see https://discourse.nodered.org/t/new-editor-event-when-all-nodes-have-been-loaded/60314)
    // On Discourse there was a workaround shared, but the 'workspace:change' is emitted a bit too early.
    // Because it is emitted just before the config nodes are loaded, so RED.nodes.eachConfig above would not find our config node.
    // (see https://discourse.nodered.org/t/add-sidebar-tab-on-app-start-not-working/64726/4).
    // I found that the 'runtime-state' event is triggered just after the config nodes are loaded, so it works fine. 
    // But it is a non-official unpublished event, so it might be changed or removed in the future...
    var dothisOneTimePlease = () => {
        RED.events.off('runtime-state', dothisOneTimePlease )

        // Register an action so the user could bind a keyboard shortcut to show the auto-layout sidebar
        // but avoid an "Error: Cannot override existing action" error in the browser console:
        if( RED.actions.list().filter( (d) => { return d.id == "core:auto-layout-flow"} ).length == 0 ) {
            RED.actions.add("core:auto-layout-flow", executeAutoLayout);
        }
        
        // The html content of the sidebar has been specified below as a data-template, from where it can be loaded:
        var content = $($('script[type="text/x-red"][data-template-name="auto_layout_sidebar"]').i18n().html());
       
        // Add a "Auto Layout" tabsheet to the right sidebar panel, in which this sidebar panel can be displayed
        RED.sidebar.addTab({
            id: "sidebar-auto-layout",
            label: "auto_layout", // short name for the tab
            name: "Auto Layout", // long name for the menu
            content: content,
            closeable: true,
            disableOnEdit: true,
            iconClass: "fa fa-outdent"
        });

        // Show the algorithm settings as json in a typedinput element (in the sidebar)
        $("#node-input-settings").typedInput({
            default: 'json',
            types:['json']
        });

        // When the algorithm properties are changed in the sidebar, then store them into the config node
        $("#node-input-settings").on("change", function() {
            ensureAutoLayoutConfigNode();

            let currentAlgorithmSettings = $(this).typedInput('value');
            let currentAlgorithm = globalAutoLayoutConfigNode.algorithm;

            // When the property value has changed, save it in the config node and activate the 'deploy' button.
            // Remark: don't check the input type (i.e. use != instead of  !==) because we will get the number values as strings...
            //if (globalAutoLayoutConfigNode.settings[currentAlgorithm] != currentAlgorithmSettings) {
                let settingsObj = JSON.parse(globalAutoLayoutConfigNode.settings);
                settingsObj[currentAlgorithm] = JSON.parse(currentAlgorithmSettings);
                globalAutoLayoutConfigNode.settings = JSON.stringify(settingsObj);
                RED.nodes.dirty(true);
            //}
        })

        // When the algorithm is changed in the sidebar, then store it into the config node
        $("#node-input-algorithm").on("change", function() {
            ensureAutoLayoutConfigNode();

            let currentAlgorithm = $(this).val();
            let currentAlgorithmSettings = JSON.parse(globalAutoLayoutConfigNode.settings)[currentAlgorithm];

            // When the property value has changed, save it in the config node and activate the 'deploy' button.
            // Remark: don't check the input type (i.e. use != instead of  !==) because we will get the number values as strings...
            if (globalAutoLayoutConfigNode.algorithm != currentAlgorithm) {
                globalAutoLayoutConfigNode.algorithm = currentAlgorithm;
                RED.nodes.dirty(true);
            }
            
            $("#node-input-settings").typedInput('value', JSON.stringify(currentAlgorithmSettings));
        })
        $("#node-input-algorithm").change();

        $("#auto-layout-button").click( executeAutoLayout );

        $("#auto-layout-revert-button").click(function() {
            // revert the last change by calling undo but also maintain the 
            // original selection, making it easier to try out different 
            // algorithms.
            var sle = RED.view.selection();

            // this will clear the selection, hence make a copy beforehand
            RED.actions.invoke("core:undo");

            RED.view.select(sle);
        })
    };
    RED.events.on('runtime-state', dothisOneTimePlease )
})();
</script>

<script type="text/x-red" data-template-name="auto_layout_sidebar">
    <div style="position: relative; height: 100%; margin: 15px;">
        <label for="node-input-algorithm" style="margin-top: 25px"><i class="fa fa-terminal"></i> Algorithm</label>
        <select id="node-input-algorithm">
            <option value="dagre_lr">Dagre LR</option>
            <option value="dagre_longest_path">Dagre Longest Path</option>
            <option value="elkjs_mr_tree">ELKjs Mr. Tree</option>
            <option value="elkjs_layered_upwards">ELKjs Layered Upwards</option>
            <option value="elkjs_layered_downwards">ELKjs Layered Downwards</option>
            <option value="elkjs_box">ELKjs Box</option>
            <option value="pull_request_2267">Pull Request 2267</option></select>
        </select>

        <label for="node-input-settings" style="margin-top: 15px"><i class="fa fa-cog"></i> Settings</label>
        <input type="text" id="node-input-settings" style="width: 100%; margin-top: 30px">
        
        <button type="button" id="auto-layout-button" style="font-size: larger;width:100%;background-color: yellowgreen;color:white;border: none;height: 32px;margin-top: 30px;">Execute auto-layout</button>

        <button type="button" id="auto-layout-revert-button" style="font-size: smaller;width:50%;background-color: rgb(225, 119, 129); color: rgb(246, 246, 246); border: 1px solid rgb(173, 22, 37); height: 32px; margin-top: 30px;"><i class="fa fa-undo"></i> Undo</button>
    </div>
</script>

<!-- --- [red-plugin:@gregoriusrippenstein/node-red-scratchpad/sidebar-plugin] --- -->
<script src="ScratchPad/jslib/diff.min.js"></script>

<script type="text/javascript">
(function() {

   var globalYourConfigNode=null;function generateDiff(e,t){e=Diff.diffLines(e,t);let c=document.createDocumentFragment();var t=document.createElement("button"),a=(t.setAttribute("onclick","window.scratchPadResetDiff.map( d => d() ); "),t.setAttribute("class","button"),t.setAttribute("title","Clear"),document.createElement("i"));a.setAttribute("class","fa fa-close"),t.appendChild(a),c.append(t),c.append(document.createElement("br")),e.forEach(e=>{var t=e.added?"green":e.removed?"red":"#040506",a=document.createElement("pre");a.setAttribute("class","dv-pre-elem"),a.style.color=t,a.appendChild(document.createTextNode(e.value)),a.appendChild(document.createElement("br")),c.appendChild(a)}),$("#node-input-scratchpad-diff-content").html(c)}function addEventHandlers(c){let t=void 0;window.scratchPadResetDiff.push(()=>{t=void 0}),$(".scratchpad-compare-btn").off("click"),$(".scratchpad-compare-btn").on("click",e=>{e&&e.preventDefault();e=$(e.target).closest("button");(t?(generateDiff($($(t).closest(".scratchpad-content")).find(".scratchpad-content-field").val(),$($(e).closest(".scratchpad-content")).find(".scratchpad-content-field").val()),$(e)):(t=e,$(t))).addClass("selected-for-compare")}),$(".scratchpad-save-btn").off("click"),$(".scratchpad-save-btn").on("click",e=>{e&&e.preventDefault(),c.scratches||=[],$(".scratchpad-content").map((e,t)=>{c.scratches[e]=$(t).find(".scratchpad-content-field").val()}),RED.nodes.dirty(!0)}),$(".scratchpad-close-btn").off("click"),$(".scratchpad-close-btn").on("click",a=>{a&&a.preventDefault(),$(".scratchpad-close-btn").map((e,t)=>{t==a.target&&(delete c.scratches[e],$($(a.target).closest(".scratchpad-content")).fadeOut(300,()=>{$($(a.target).closest(".scratchpad-content")).remove(),RED.nodes.dirty(!0)}))})}),$(".scratchpad-clear-btn").off("click"),$(".scratchpad-clear-btn").on("click",a=>{a&&a.preventDefault(),$(".scratchpad-clear-btn").map((e,t)=>{t==a.target&&($($($(a.target).closest(".scratchpad-content")).find(".scratchpad-content-field")).val(""),""!==c.scratches[e])&&(c.scratches[e]="",RED.nodes.dirty(!0))})})}function addScratch(){$("#node-input-scratchpad-fields").append($($('[data-template-name="ScratchPad-empty-field"]').html()).data("shown",!0)[0].outerHTML)}function ensureYourConfigNodeExists(){if(null===(globalYourConfigNode=null!==globalYourConfigNode&&null===(e=RED.nodes.node(globalYourConfigNode.id))?null:globalYourConfigNode)){var t=[];for(RED.nodes.eachConfig(function(e){"ScratchPadCfg"===e.type&&t.push(e)});1<t.length;){var e=t.pop();RED.nodes.remove(e.id),RED.nodes.dirty(!0)}1===t.length&&(globalYourConfigNode=t[0])}null===globalYourConfigNode&&(globalYourConfigNode={id:RED.nodes.id(),_def:RED.nodes.getType("ScratchPadCfg"),type:"ScratchPadCfg",hasUsers:!1,users:[],name:"ScratchPad",label:function(){return this.name||"ScratchPad"},scratches:[]},RED.nodes.add(globalYourConfigNode),RED.nodes.dirty(!0))}window.scratchPadResetDiff=[()=>{$("#node-input-scratchpad-diff-content").html(""),$(".selected-for-compare").removeClass("selected-for-compare")}];

   // Add your plugin as a new tabsheet in the right sidebar AFTER the flow editor is completely started
   var initialiseConfigNodeOnce = () => {
      RED.events.off('runtime-state', initialiseConfigNodeOnce);

      // The html content of the sidebar has been specified below as a data-template, from where it can be loaded:
      var content = $($('script[type="text/x-red"][data-template-name="ScratchPad"]').i18n().html());
    
      // Add a "Your sidebar" tabsheet to the right sidebar panel, in which this sidebar panel can be displayed
      // --> more details: https://nodered.org/docs/api/ui/sidebar/
      RED.sidebar.addTab({
         id: "ScratchPad",
         label: "*scratch*", // short name for the tab
         name: "Scratch Pad", // long name for the menu
         content: content,
         closeable: true,
         enableOnEdit: true,
         iconClass: "fa fa-pencil-square-o" // your fontawesome icon
      });

      ensureYourConfigNodeExists();

      globalYourConfigNode.scratches.forEach( sth => {
         addScratch()
      })

      $(".scratchpad-content").map( (idx,obj) => {
         $(obj).find(".scratchpad-content-field").val( globalYourConfigNode.scratches[idx] )
      })

      addEventHandlers(globalYourConfigNode)

      $('#node-input-scratchpad-add-btn').on('click', e => {
         if ( e ) { e.preventDefault() }

         addScratch()
         addEventHandlers(globalYourConfigNode)
      })
   };

   RED.events.on('runtime-state', initialiseConfigNodeOnce);
})();
</script>

<style>
.selected-for-compare {
    background-color: rgba(235, 108, 108, 0.387) !important;
    color: green !important;
}

.button-icon {
    pointer-events: none;
}

</style>

<!-- The html for the right sidebar plugin screen -->
<script type="text/x-red" data-template-name="ScratchPad-empty-field">
   <div class="scratchpad-content">
      <div class="form-row" style="margin-left: 10px;">
         <textarea class="scratchpad-content-field" placeholder="*scratch*" style="width: 360px; height: 150px;"></textarea>
      </div>
      <div class="form-row scratchpad-content-container" style="margin-left: 10px; margin-top: -15px; margin-bottom: 20px;">
         <button title="Clear" class="scratchpad-clear-btn button"><i class="fa fa-shower button-icon"></i></button>
         <button title="Save" class="scratchpad-save-btn button"><i class="fa fa-save button-icon"></i></button>
         <button title="Compare" class="scratchpad-compare-btn button"><i class="fa fa-balance-scale button-icon"></i></button>
         <button title="Delete" class="scratchpad-close-btn button"><i class="fa fa-close button-icon"></i></button>
      </div>
   </div>
</script>

<script type="text/x-red" data-template-name="ScratchPad">
   <div class="form-row" style="margin-left: 10px; margin-top: 30px;">
      <button title="Add Scratch" class="button" id="node-input-scratchpad-add-btn"><i class="fa fa-plus"></i></button>
   </div>

   <div style="margin: 10px;" id="node-input-scratchpad-diff-content">
   </div>

   <div id="node-input-scratchpad-fields">
   </div>
</script>