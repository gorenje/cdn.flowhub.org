
<!-- --- [red-module:node-red/junction] --- -->
<!--
  05-junction.html
  This file exists so that the runtime loads the Junction node into the registry,
  but it is empty so it doesn't appear in the editor palette
-->

<!-- --- [red-module:node-red/inject] --- -->
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-template-name="inject">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>

    <div class="form-row node-input-property-container-row">
        <ol id="node-input-property-container"></ol>
    </div>

    <div class="form-row" id="node-once">
        <label for="node-input-once">&nbsp;</label>
        <input type="checkbox" id="node-input-once" style="display:inline-block; width:15px; vertical-align:baseline;">
        <span data-i18n="inject.onstart"></span>&nbsp;
        <input type="text" id="node-input-onceDelay" placeholder="0.1" style="width:45px; height:28px;">&nbsp;
        <span data-i18n="inject.onceDelay"></span>
    </div>

    <div class="form-row">
        <label for=""><i class="fa fa-repeat"></i> <span data-i18n="inject.label.repeat"></span></label>
        <select id="inject-time-type-select">
            <option value="none" data-i18n="inject.none"></option>
            <option value="interval" data-i18n="inject.interval"></option>
            <option value="interval-time" data-i18n="inject.interval-time"></option>
            <option value="time" data-i18n="inject.time"></option>
        </select>
        <input type="hidden" id="node-input-repeat">
        <input type="hidden" id="node-input-crontab">
    </div>

    <div class="form-row inject-time-row hidden" id="inject-time-row-interval">
        <span data-i18n="inject.every"></span>
        <input id="inject-time-interval-count" class="inject-time-count" value="1"></input>
        <select style="width:100px" id="inject-time-interval-units">
            <option value="s" data-i18n="inject.seconds"></option>
            <option value="m" data-i18n="inject.minutes"></option>
            <option value="h" data-i18n="inject.hours"></option>
        </select><br/>
    </div>

    <div class="form-row inject-time-row hidden" id="inject-time-row-interval-time">
        <span data-i18n="inject.every"></span> <select style="width:90px; margin-left:20px;" id="inject-time-interval-time-units" class="inject-time-int-count" value="1">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="10">10</option>
            <option value="12">12</option>
            <option value="15">15</option>
            <option value="20">20</option>
            <option value="30">30</option>
            <option value="0">60</option>
        </select> <span data-i18n="inject.minutes"></span><br/>
        <span data-i18n="inject.between"></span> <select id="inject-time-interval-time-start" class="inject-time-times"></select>
        <span data-i18n="inject.and"></span> <select id="inject-time-interval-time-end" class="inject-time-times"></select><br/>
        <div id="inject-time-interval-time-days" class="inject-time-days" style="margin-top:5px">
            <div style="display:inline-block; vertical-align:top; margin-right:5px;" data-i18n="inject.on">on</div>
            <div style="display:inline-block;">
                <div>
                    <label><input type='checkbox' checked value='1'/> <span data-i18n="inject.days.0"></span></label>
                    <label><input type='checkbox' checked value='2'/> <span data-i18n="inject.days.1"></span></label>
                    <label><input type='checkbox' checked value='3'/> <span data-i18n="inject.days.2"></span></label>
                </div>
                <div>
                    <label><input type='checkbox' checked value='4'/> <span data-i18n="inject.days.3"></span></label>
                    <label><input type='checkbox' checked value='5'/> <span data-i18n="inject.days.4"></span></label>
                    <label><input type='checkbox' checked value='6'/> <span data-i18n="inject.days.5"></span></label>
                </div>
                <div>
                    <label><input type='checkbox' checked value='0'/> <span data-i18n="inject.days.6"></span></label>
                </div>
            </div>
        </div>
    </div>

    <div class="form-row inject-time-row hidden" id="inject-time-row-time">
        <span data-i18n="inject.at"></span> <input type="text" id="inject-time-time" value="12:00"></input><br/>
        <div id="inject-time-time-days" class="inject-time-days">
            <div style="display:inline-block; vertical-align:top; margin-right:5px;" data-i18n="inject.on"></div>
            <div style="display:inline-block;">
                <div>
                    <label><input type='checkbox' checked value='1'/> <span data-i18n="inject.days.0"></span></label>
                    <label><input type='checkbox' checked value='2'/> <span data-i18n="inject.days.1"></span></label>
                    <label><input type='checkbox' checked value='3'/> <span data-i18n="inject.days.2"></span></label>
                </div>
                <div>
                    <label><input type='checkbox' checked value='4'/> <span data-i18n="inject.days.3"></span></label>
                    <label><input type='checkbox' checked value='5'/> <span data-i18n="inject.days.4"></span></label>
                    <label><input type='checkbox' checked value='6'/> <span data-i18n="inject.days.5"></span></label>
                </div>
                <div>
                    <label><input type='checkbox' checked value='0'/> <span data-i18n="inject.days.6"></span></label>
                </div>
            </div>
        </div>
    </div>

</script>
<style>
    .inject-time-row {
        padding-left: 110px;
    }
    .inject-time-row:not(#inject-time-row-interval) select {
        margin: 3px 0;
    }
    .inject-time-days label {
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        vertical-align: baseline;
        width: 100px;
    }
    .inject-time-days input {
        width: auto !important;
        vertical-align: baseline !important;
    }
    .inject-time-times {
        width: 90px !important;
    }
    #inject-time-time {
        width: 75px;
        margin-left: 8px;
        margin-bottom: 8px;
    }
    .inject-time-count {
        padding-left: 3px !important;
        width: 80px !important;
    }
</style>

<script type="text/javascript">
(function() {

    function resizeDialog(size) {
        size = size || { height: $(".red-ui-tray-content form").height() }
        var rows = $("#dialog-form>div:not(.node-input-property-container-row):visible");
        var height = size.height;
        for (var i=0; i<rows.length; i++) {
            height -= $(rows[i]).outerHeight(true);
        }
        var editorRow = $("#dialog-form>div.node-input-property-container-row");
        height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));
        height += 16;
        $("#node-input-property-container").editableList('height',height);
    }
    /** Retrieve editableList items (refactored for re-use in the form inject button)*/
    function getProps(el, legacy) {
        var result = {
            props: []
        }
        el.each(function(i) {
            var prop = $(this);
            var p = {
                p:prop.find(".node-input-prop-property-name").typedInput('value')
            };
            if (p.p) {
                p.v = prop.find(".node-input-prop-property-value").typedInput('value');
                p.vt = prop.find(".node-input-prop-property-value").typedInput('type');
                if(legacy) {
                    if (p.p === "payload") { // save payload to old "legacy" property
                        result.payloadType = p.vt;
                        result.payload = p.v;
                        delete p.v;
                        delete p.vt;
                    } else if (p.p === "topic" && p.vt === "str") {
                        result.topic = p.v;
                        delete p.v;
                    }
                }
                result.props.push(p);
            }
        });
        return result;
    }
    /** Perform inject, optionally sending a custom msg (refactored for re-use in the form inject button)*/
    function doInject(node, customMsg) {
        var label = node._def.label.call(node,customMsg?customMsg.__user_inject_props__:undefined);
        if (label.length > 30) {
            label = label.substring(0, 50) + "...";
        }
        label = label.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        $.ajax({
            url: "inject/" + node.id,
            type: "POST",
            data: JSON.stringify(customMsg||{}),
            contentType: "application/json; charset=utf-8",
            success: function (resp) {
                RED.notify(node._("inject.success", { label: label }), { type: "success", id: "inject", timeout: 2000 });
            },
            error: function (jqXHR, textStatus, errorThrown) {
                if (jqXHR.status == 404) {
                    RED.notify(node._("common.notification.error", { message: node._("common.notification.errors.not-deployed") }), "error");
                } else if (jqXHR.status == 500) {
                    RED.notify(node._("common.notification.error", { message: node._("inject.errors.failed") }), "error");
                } else if (jqXHR.status == 0) {
                    RED.notify(node._("common.notification.error", { message: node._("common.notification.errors.no-response") }), "error");
                } else {
                    RED.notify(node._("common.notification.error", { message: node._("common.notification.errors.unexpected", { status: jqXHR.status, message: textStatus }) }), "error");
                }
            }
        });
    }
    RED.nodes.registerType('inject',{  
        category: 'common',
        color:"#a6bbcf",
        defaults: {
            name: {value:""},
            props:{value:[{p:"payload"},{p:"topic",vt:"str"}], validate:function(v, opt) {
                    if (!v || v.length === 0) { return true }
                    for (var i=0;i<v.length;i++) {
                        if (/msg|flow|global/.test(v[i].vt)) {
                            if (!RED.utils.validatePropertyExpression(v[i].v)) {
                                return RED._("node-red:inject.errors.invalid-prop", { prop: 'msg.'+v[i].p, error: v[i].v });
                            }
                        } else if (v[i].vt === "jsonata") {
                            try{ jsonata(v[i].v); }
                            catch(e){
                                return RED._("node-red:inject.errors.invalid-jsonata", { prop: 'msg.'+v[i].p, error: e.message });
                            }
                        } else if (v[i].vt === "json") {
                            try{ JSON.parse(v[i].v); }
                            catch(e){
                                return RED._("node-red:inject.errors.invalid-json", { prop: 'msg.'+v[i].p, error: e.message });
                            }
                        } else if (v[i].vt === "num"){
                            if (!/^[+-]?[0-9]*\.?[0-9]*([eE][-+]?[0-9]+)?$/.test(v[i].v)) {
                                return RED._("node-red:inject.errors.invalid-prop", { prop: 'msg.'+v[i].p, error: v[i].v });
                            }
                        }
                    }
                    return true;
                }
            },
            repeat: {
                value:"", validate: function(v, opt) {
                    if ((v === "") ||
                        (RED.validators.number(v) &&
                         (v >= 0) && (v <= 2147483))) {
                        return true;
                    }
                    return RED._("node-red:inject.errors.invalid-repeat");
                }
            },
            crontab: {value:""},
            once: {value:false},
            onceDelay: {value:0.1},
            topic: {value:""},
            payload: {value:"", validate: RED.validators.typedInput("payloadType", false) },
            payloadType: {value:"date"},
        },
        icon: "inject.svg",
        inputs:0,
        outputs:1,
        outputLabels: function(index) {
            var lab = '';

            // if only payload and topic - display payload type
            // if only one property - show it's type
            // if more than one property (other than payload and topic) - show "x properties" where x is the number of properties.
            // this.props will not be an array for legacy inject nodes until they are re-deployed
            //
            var props = this.props;
            if (!Array.isArray(props)) {
                props = [
                    { p:"payload", v: this.payload, vt: this.payloadType },
                    { p:"topic", v: this.topic, vt: "str" }
                ]
            }
            if (props) {
                for (var i=0,l=props.length; i<l; i++) {
                    if (i > 0) lab += "\n";
                    if (i === 5) {
                        lab += "... +"+(props.length-5);
                        break;
                    }
                    lab += props[i].p+": ";

                    var propType = props[i].p === "payload"? this.payloadType : props[i].vt;
                    if (propType === "json") {
                        try {
                            var parsedProp = JSON.parse(props[i].p === "payload"? this.payload : props[i].v);
                            propType = typeof parsedProp;
                            if (propType === "object" && Array.isArray(parsedProp)) {
                                propType = "Array";
                            }
                        } catch(e) {
                            propType = "invalid";
                        }
                    }
                    lab += this._("inject.label."+propType);
                }
            }
            return lab;
        },
        label: function(customProps) {
            var suffix = "";
            // if fire once then add small indication
            if (this.once) {
                suffix = " ¹";
            }
            // but replace with repeat one if set to repeat
            if ((this.repeat && this.repeat != 0) || this.crontab) {
                suffix = "\t↻";
            }
            if (this.name) {
                return this.name+suffix;
            }
            var payload = "";
            var payloadType = "str";
            var topic = "";
            if (customProps) {
                for (var i=0;i<customProps.length;i++) {
                    if (customProps[i].p === "payload") {
                        payload = customProps[i].v;
                        payloadType = customProps[i].vt;
                    } else if (customProps[i].p === "topic") {
                        topic = customProps[i].v;
                    }
                }
            } else {
                payload = this.payload || "";
                payloadType = this.payloadType || "str";
                topic = this.topic || "";
            }
            if (payloadType === "string" ||
                    payloadType === "str" ||
                    payloadType === "num" ||
                    payloadType === "bool" ||
                    payloadType === "json") {
                if ((topic !== "") && ((topic.length + payload.length) <= 32)) {
                    return topic + ":" + payload+suffix;
                } else if (payload.length > 0 && payload.length < 24) {
                    return payload+suffix;
                } else {
                    return this._("inject.inject")+suffix;
                }
            } else if (payloadType === 'date' || payloadType === 'bin' || payloadType === 'env') {
                if ((topic !== "") && (topic.length <= 16)) {
                    return topic + ":" + this._('inject.label.'+payloadType)+suffix;
                } else {
                    return this._('inject.label.'+payloadType)+suffix;
                }
            } else if (payloadType === 'flow' || payloadType === 'global') {
                var key = RED.utils.parseContextKey(payload);
                return payloadType+"."+key.key+suffix;
            } else {
                return this._("inject.inject")+suffix;
            }
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            var node = this;
            var payloadType = node.payloadType;

            if (node.payloadType == null) {
                if (node.payload == "") {
                    payloadType = "date";
                } else {
                    payloadType = "str";
                }
            } else if (node.payloadType === 'string' || node.payloadType === 'none') {
                payloadType = "str";
            }

            $("#inject-time-type-select").on("change", function() {
                $("#node-input-crontab").val('');
                var id = $("#inject-time-type-select").val();
                $(".inject-time-row").hide();
                $("#inject-time-row-"+id).show();

                // Scroll down
                var scrollDiv = $("#dialog-form").parent();
                scrollDiv.scrollTop(scrollDiv.prop('scrollHeight'));
                resizeDialog();
            });

            $("#node-input-once").on("change", function() {
                $("#node-input-onceDelay").attr('disabled', !$("#node-input-once").prop('checked'));
            })

            $(".inject-time-times").each(function() {
                for (var i=0; i<24; i++) {
                    var l = (i<10?"0":"")+i+":00";
                    $(this).append($("<option></option>").val(i).text(l));
                }
            });
            $("<option></option>").val(24).text("00:00").appendTo("#inject-time-interval-time-end");
            $("#inject-time-interval-time-start").on("change", function() {
                var start = Number($("#inject-time-interval-time-start").val());
                var end = Number($("#inject-time-interval-time-end").val());
                $("#inject-time-interval-time-end option").remove();
                for (var i=start+1; i<25; i++) {
                    var l = (i<10?"0":"")+i+":00";
                    if (i==24) {
                        l = "00:00";
                    }
                    var opt = $("<option></option>").val(i).text(l).appendTo("#inject-time-interval-time-end");
                    if (i === end) {
                        opt.attr("selected","selected");
                    }
                }
            });

            $(".inject-time-count").spinner({
                //max:60,
                min:1
            });

            var repeattype = "none";
            if (node.repeat != "" && node.repeat != 0) {
                repeattype = "interval";
                var r = "s";
                var c = node.repeat;
                if (node.repeat % 60 === 0) { r = "m"; c = c/60; }
                if (node.repeat % 1440 === 0) { r = "h"; c = c/60; }
                $("#inject-time-interval-count").val(c);
                $("#inject-time-interval-units").val(r);
                $("#inject-time-interval-days").prop("disabled","disabled");
            } else if (node.crontab) {
                var cronparts = node.crontab.split(" ");
                var days = cronparts[4];
                if (!isNaN(cronparts[0]) && !isNaN(cronparts[1])) {
                    repeattype = "time";
                    // Fixed time
                    var time = cronparts[1]+":"+cronparts[0];
                    $("#inject-time-time").val(time);
                    $("#inject-time-type-select").val("s");
                    if (days == "*") {
                        $("#inject-time-time-days input[type=checkbox]").prop("checked",true);
                    } else {
                        $("#inject-time-time-days input[type=checkbox]").removeAttr("checked");
                        days.split(",").forEach(function(v) {
                            $("#inject-time-time-days [value=" + v + "]").prop("checked", true);
                        });
                    }
                } else {
                    repeattype = "interval-time";
                    // interval - time period
                    var minutes = cronparts[0].slice(2);
                    if (minutes === "") { minutes = "0"; }
                    $("#inject-time-interval-time-units").val(minutes);
                    if (days == "*") {
                        $("#inject-time-interval-time-days input[type=checkbox]").prop("checked",true);
                    } else {
                        $("#inject-time-interval-time-days input[type=checkbox]").removeAttr("checked");
                        days.split(",").forEach(function(v) {
                            $("#inject-time-interval-time-days [value=" + v + "]").prop("checked", true);
                        });
                    }
                    var time = cronparts[1];
                    var timeparts = time.split(",");
                    var start;
                    var end;
                    if (timeparts.length == 1) {
                        // 0 or 0-10
                        var hours = timeparts[0].split("-");
                        if (hours.length == 1) {
                            if (hours[0] === "") {
                                start = "0";
                                end = "0";
                            }
                            else {
                                start = hours[0];
                                end = Number(hours[0])+1;
                            }
                        } else {
                            start = hours[0];
                            end = Number(hours[1])+1;
                        }
                    } else {
                        // 23,0 or 17-23,0-10 or 23,0-2 or 17-23,0
                        var startparts = timeparts[0].split("-");
                        start = startparts[0];

                        var endparts = timeparts[1].split("-");
                        if (endparts.length == 1) {
                            end = Number(endparts[0])+1;
                        } else {
                            end = Number(endparts[1])+1;
                        }
                    }
                    $("#inject-time-interval-time-end").val(end);
                    $("#inject-time-interval-time-start").val(start);

                }
            } else {
                $("#inject-time-type-select").val("none");
            }

            $(".inject-time-row").hide();
            $("#inject-time-type-select").val(repeattype);
            $("#inject-time-row-"+repeattype).show();

            /* */

            var eList = $('#node-input-property-container').css('min-height','120px').css('min-width','450px');

            eList.editableList({
                buttons: [
                    {
                        id: "node-inject-test-inject-button",
                        label: node._("inject.injectNow"),
                        click: function(e) {
                            var items = eList.editableList('items');
                            var props = getProps(items);
                            var m = {__user_inject_props__: props.props};
                            doInject(node, m);
                        }
                    }
                ],
                addItem: function(container,i,opt) {
                    var prop = opt;
                    if (!prop.hasOwnProperty('p')) {
                        prop = {p:"",v:"",vt:"str"};
                    }
                    container.css({
                        overflow: 'hidden',
                        whiteSpace: 'nowrap'
                    });
                    var row = $('<div/>').appendTo(container);

                    var propertyName = $('<input/>',{class:"node-input-prop-property-name",type:"text"})
                        .css("width","30%")
                        .appendTo(row)
                        .typedInput({types:['msg']});

                    $('<div/>',{style: 'display:inline-block; padding:0px 6px;'})
                        .text('=')
                        .appendTo(row);

                    var propertyValue = $('<input/>',{class:"node-input-prop-property-value",type:"text"})
                        .css("width","calc(70% - 30px)")
                        .appendTo(row)
                        .typedInput({default:prop.vt || 'str',types:['flow','global','str','num','bool','json','bin','date','jsonata','env','msg']});

                    propertyName.typedInput('value',prop.p);
                    propertyValue.typedInput('value',prop.v);
                },
                removable: true,
                sortable: true
            });
            $('#node-inject-test-inject-button').css("float", "right").css("margin-right", "unset");

            if (RED.nodes.subflow(node.z)) {
                $('#node-inject-test-inject-button').attr("disabled",true);
            }

            if (!node.props) {
                var payload = {
                    p:'payload',
                    v: node.payload ? node.payload : '',
                    vt:payloadType ? payloadType : 'date'
                };
                var topic = {
                    p:'topic',
                    v: node.topic ? node.topic : '',
                    vt:'str'
                }
                node.props = [payload,topic];
            }

            for (var i=0; i<node.props.length; i++) {
                var prop = node.props[i];
                var newProp = { p: prop.p, v: prop.v, vt: prop.vt };
                if (newProp.v === undefined) {
                    if (prop.p === 'payload') {
                        newProp.v = node.payload ? node.payload : '';
                        newProp.vt = payloadType ? payloadType : 'date';
                    } else if (prop.p === 'topic' && prop.vt === "str") {
                        newProp.v =  node.topic ? node.topic : '';
                    }
                }
                if (newProp.vt === "string") {
                    // Fix bug in pre 2.1 where an old Inject node might have
                    // a migrated rule with type 'string' not 'str'
                    newProp.vt = "str";
                }
                eList.editableList('addItem',newProp);
            }

            $("#inject-time-type-select").trigger("change");
            $("#inject-time-interval-time-start").trigger("change");

        },
        oneditsave: function() {
            var repeat = "";
            var crontab = "";
            var type = $("#inject-time-type-select").val();
            if (type == "none") {
                // nothing
            } else if (type == "interval") {
                var count = $("#inject-time-interval-count").val();
                var units = $("#inject-time-interval-units").val();
                if (units == "s") {
                    repeat = count;
                } else {
                    if (units == "m") {
                        //crontab = "*/"+count+" * * * "+days;
                        repeat = count * 60;
                    } else if (units == "h") {
                        //crontab = "0 */"+count+" * * "+days;
                        repeat = count * 60 * 60;
                    }
                }
            } else if (type == "interval-time") {
                repeat = "";
                var count = $("#inject-time-interval-time-units").val();
                var startTime = Number($("#inject-time-interval-time-start").val());
                var endTime = Number($("#inject-time-interval-time-end").val());
                var days = $('#inject-time-interval-time-days input[type=checkbox]:checked').map(function(_, el) {
                    return $(el).val()
                }).get();
                if (days.length == 0) {
                    crontab = "";
                } else {
                    if (days.length == 7) {
                        days="*";
                    } else {
                        days = days.join(",");
                    }
                    var timerange = "";
                    if (endTime == 0) {
                        timerange = startTime+"-23";
                    } else if (startTime+1 < endTime) {
                        timerange = startTime+"-"+(endTime-1);
                    } else if (startTime+1 == endTime) {
                        timerange = startTime;
                    } else {
                        var startpart = "";
                        var endpart = "";
                        if (startTime == 23) {
                            startpart = "23";
                        } else {
                            startpart = startTime+"-23";
                        }
                        if (endTime == 1) {
                            endpart = "0";
                        } else {
                            endpart = "0-"+(endTime-1);
                        }
                        timerange = startpart+","+endpart;
                    }
                    if (count === "0") {
                        crontab = count+" "+timerange+" * * "+days;
                    } else {
                        crontab = "*/"+count+" "+timerange+" * * "+days;
                    }
                }
            } else if (type == "time") {
                var time = $("#inject-time-time").val();
                var days = $('#inject-time-time-days  input[type=checkbox]:checked').map(function(_, el) {
                    return $(el).val()
                }).get();
                if (days.length == 0) {
                    crontab = "";
                } else {
                    if (days.length == 7) {
                        days="*";
                    } else {
                        days = days.join(",");
                    }
                    var parts = time.split(":");
                    if (parts.length === 2) {
                        repeat = "";
                        parts[1] = ("00" + (parseInt(parts[1]) % 60)).substr(-2);
                        parts[0] = ("00" + (parseInt(parts[0]) % 24)).substr(-2);
                        crontab = parts[1]+" "+parts[0]+" * * "+days;
                    }
                    else { crontab = ""; }
                }
            }

            $("#node-input-repeat").val(repeat);
            $("#node-input-crontab").val(crontab);

            /* Gather the properties */
            var items = $("#node-input-property-container").editableList('items');
            delete this.payloadType;
            delete this.payload;
            this.topic = "";
            var result = getProps(items, true);
            this.props = result.props;
            if(result.hasOwnProperty('payloadType')) { this.payloadType = result.payloadType; };
            if(result.hasOwnProperty('payload')) { this.payload = result.payload; };
            if(result.hasOwnProperty('topic')) { this.topic = result.topic; };
        },
        button: {
            enabled: function() {
                return !this.changed
            },
            onclick: function () {
                if (this.changed) {
                    return RED.notify(RED._("notification.warning", { message: RED._("notification.warnings.undeployedChanges") }), "warning");
                }
                doInject(this);
            }
        },
        oneditresize: resizeDialog
    });
})();
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="inject">
<p>Injects a message into a flow either manually or at regular intervals. The message
payload can be a variety of types, including strings, JavaScript objects or the current time.</p>
<h3>Outputs</h3>
<dl class="message-properties">
    <dt>payload<span class="property-type">various</span></dt>
    <dd>The configured payload of the message.</dd>
    <dt class="optional">topic <span class="property-type">string</span></dt>
    <dd>An optional property that can be configured in the node.</dd>
</dl>
<h3>Details</h3>
<p>The Inject node can initiate a flow with a specific payload value.
The default payload is a timestamp of the current time in millisecs since January 1st, 1970.</p>
<p>The node also supports injecting strings, numbers, booleans, JavaScript objects, or flow/global context values.</p>
<p>By default, the node is triggered manually by clicking on its button within the editor. It can also be set to
inject at regular intervals or according to a schedule.</p>
<p>It can also be configured to inject once each time the flows are started.</p>
<p>The maximum <i>Interval</i> that can be specified is about 596 hours / 24 days. However if you are looking at intervals
greater than one day you should consider using a scheduler node that can cope with power outages and restarts.</p>
<p><b>Note</b>: The <i>"Interval between times"</i> and <i>"at a specific time"</i> options use the standard cron system.
This means that 20 minutes will be at the next hour, 20 minutes past and 40 minutes past - not in 20 minutes time.
If you want every 20 minutes from now - use the <i>"interval"</i> option.</p>
<p><b>Note</b>: To include a newline in a string you must use the Function or Template node to create the payload.</p>
</script>

<!-- --- [red-module:node-red/debug] --- -->

<script type="text/html" data-template-name="debug">
    <div class="form-row">
        <label for="node-input-typed-complete"><i class="fa fa-list"></i> <span data-i18n="debug.output"></span></label>
        <input id="node-input-typed-complete" type="text" style="width: 70%">
        <input id="node-input-complete" type="hidden">
        <input id="node-input-targetType" type="hidden">
    </div>
    <div class="form-row">
        <label for="node-input-tosidebar"><i class="fa fa-random"></i> <span data-i18n="debug.to"></span></label>
        <label for="node-input-tosidebar" style="width:70%">
        <input type="checkbox" id="node-input-tosidebar" style="display:inline-block; width:22px; vertical-align:top;"><span data-i18n="debug.toSidebar"></span>
        </label>
    </div>
    <div class="form-row">
        <label for="node-input-console"> </label>
        <label for="node-input-console" style="width:70%">
        <input type="checkbox" id="node-input-console" style="display:inline-block; width:22px; vertical-align:top;"><span data-i18n="debug.toConsole"></span>
        </label>
    </div>
    <div class="form-row">
    <label for="node-input-tostatus"> </label>
    <label for="node-input-tostatus" style="width:70%">
        <input type="checkbox" id="node-input-tostatus" style="display:inline-block; width:22px; vertical-align:top;"><span data-i18n="debug.toStatus"></span>
    </label>
    </div>
    <div class="form-row" id="node-tostatus-line">
        <label for="node-input-typed-status"></label>
        <input id="node-input-typed-status" type="text" style="width: 70%">
        <input id="node-input-statusVal" type="hidden">
        <input id="node-input-statusType" type="hidden">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
</script>

<script src="debug/view/debug-utils.js"></script>

<script type="text/javascript">
(function() {
    var subWindow = null;

    function activateAjaxCall(node, active, successCallback) {
        var url;
        var body;

        if (Array.isArray(node)) {
            url = "debug/"+(active?"enable":"disable");
            body = {nodes: node.map(function(n) { return n.id})}
            node = node[0];
        } else {
            url = "debug/"+node.id+"/"+(active?"enable":"disable");
        }
        $.ajax({
            url: url,
            type: "POST",
            data: body,
            success: successCallback,
            error: function(jqXHR,textStatus,errorThrown) {
                if (jqXHR.status == 404) {
                    RED.notify(node._("common.notification.error", {message: node._("common.notification.errors.not-deployed")}),"error");
                } else if (jqXHR.status === 0) {
                    RED.notify(node._("common.notification.error", {message: node._("common.notification.errors.no-response")}),"error");
                } else {
                    // TODO where is the err.status comming from?
                    RED.notify(node._("common.notification.error",{message:node._("common.notification.errors.unexpected",{status:err.status,message:err.response})}),"error");
                }
            }
        });
    }

    RED.nodes.registerType('debug',{
        category: 'common',
        defaults: {
            name: {value:"_DEFAULT_"},
            active: {value:true},
            tosidebar: {value:true},
            console: {value:false},
            tostatus: {value:false},
            complete: {value:"false", required:true},
            targetType: {value:undefined},
            statusVal: {value:""},
            statusType: {value:"auto"}
        },
        label: function() {
            var suffix = "";
            if (this.console === true || this.console === "true") { suffix = "\t⇲"; }
            if (this.targetType === "jsonata") {
                return (this.name || "JSONata") + suffix;
            }
            if (this.complete === true || this.complete === "true") {
                return (this.name||"msg") + suffix;
            } else {
                return (this.name || "msg." + ((!this.complete || this.complete === "false") ? "payload" : this.complete)) + suffix;
            }
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        color:"#87a980",
        inputs:1,
        outputs:0,
        icon: "debug.svg",
        align: "right",
        button: {
            toggle: "active",
            visible: function() { return this.tosidebar; },
            onclick: function() {
                var label = RED.utils.sanitize(this.name||"debug");
                var node = this;
                activateAjaxCall(node, node.active, function(resp, textStatus, xhr) {
                    var historyEvent = {
                        t:'edit',
                        node:node,
                        changes:{
                            active:!node.active
                        },
                        dirty:node.dirty,
                        changed:node.changed,
                        callback: function(ev) {
                            activateAjaxCall(ev.node, ev.node.active);
                        }
                    };
                    node.changed = true;
                    node.dirty = true;
                    RED.nodes.dirty(true);
                    RED.history.push(historyEvent);
                    RED.view.redraw();
                    if (xhr.status == 200) {
                        RED.notify(node._("debug.notification.activated",{label:label}),{type: "success", timeout: 2000});
                    } else if (xhr.status == 201) {
                        RED.notify(node._("debug.notification.deactivated",{label:label}),{type: "success", timeout: 2000});
                    }
                });
            }
        },
        onpaletteadd: function() {
            var options = {
                messageMouseEnter: function(sourceId) {
                    if (sourceId) {
                        var n = RED.nodes.node(sourceId);
                        if (n) {
                            n.highlighted = true;
                            n.dirty = true;
                        }
                        RED.view.redraw();
                    }
                },
                messageMouseLeave: function(sourceId) {
                    if (sourceId) {
                        var n = RED.nodes.node(sourceId);
                        if (n) {
                            n.highlighted = false;
                            n.dirty = true;
                        }
                        RED.view.redraw();
                    }
                },
                messageSourceClick: function(sourceId, aliasId, path) {
                    // Get all of the nodes that could have logged this message
                    if (RED.nodes.workspace(sourceId)) {
                        RED.view.reveal(sourceId);
                        return
                    }
                    var candidateNodes = [RED.nodes.node(sourceId)]
                    if (path) {
                        for (var i=2;i<path.length;i++) {
                            candidateNodes.push(RED.nodes.node(path[i]))
                        }
                    }
                    if (aliasId) {
                        candidateNodes.push(RED.nodes.node(aliasId));
                    }
                    if (candidateNodes.length > 1) {
                        // The node is in a subflow. Check to see if the active
                        // workspace is a subflow in the node's parentage. If
                        // so, reveal the relevant subflow instance node.
                        var ws = RED.workspaces.active();
                        for (var i=0;i<candidateNodes.length;i++) {
                            if (candidateNodes[i].z === ws) {
                                RED.view.reveal(candidateNodes[i].id);
                                return
                            }
                        }
                        // The active workspace is unrelated to the node. So
                        // fall back to revealing the top most node
                    }
                    RED.view.reveal(candidateNodes[0].id);
                },
                clear: function() {
                    RED.nodes.eachNode(function(node) {
                        node.highlighted = false;
                        node.dirty = true;
                    });
                    RED.view.redraw();
                },
                requestDebugNodeList: function(filteredNodes) {
                    var workspaceOrder = RED.nodes.getWorkspaceOrder();
                    var workspaceOrderMap = {};
                    workspaceOrder.forEach(function(ws,i) {
                        workspaceOrderMap[ws] = i;
                    });

                    var candidateNodes = [];
                    var candidateSFs = [];
                    var subflows = {};
                    RED.nodes.eachNode(function (n) {
                        var nt = n.type;
                        if (nt === "debug") {
                            if (n.z in workspaceOrderMap) {
                                candidateNodes.push(n);
                            }
                            else {
                                var sf = RED.nodes.subflow(n.z);
                                if (sf) {
                                    subflows[sf.id] = {
                                        debug: true,
                                        subflows: {}
                                    };
                                }
                            }
                        }
                        else if(nt.substring(0, 8) === "subflow:") {
                            if (n.z in workspaceOrderMap) {
                                candidateSFs.push(n);
                            }
                            else {
                                var psf = RED.nodes.subflow(n.z);
                                if (psf) {
                                    var sid = nt.substring(8);
                                    var item = subflows[psf.id];
                                    if (!item) {
                                        item = {
                                            debug: undefined,
                                            subflows: {}
                                        };
                                        subflows[psf.id] = item;
                                    }
                                    item.subflows[sid] = true;
                                }
                            }
                        }
                    });
                    candidateSFs.forEach(function (sf) {
                        var sid = sf.type.substring(8);
                        if (containsDebug(sid, subflows)) {
                            candidateNodes.push(sf);
                        }
                    });

                    candidateNodes.sort(function(A,B) {
                        var wsA = workspaceOrderMap[A.z];
                        var wsB = workspaceOrderMap[B.z];
                        if (wsA !== wsB) {
                            return wsA-wsB;
                        }
                        var labelA = RED.utils.getNodeLabel(A,A.id);
                        var labelB = RED.utils.getNodeLabel(B,B.id);
                        return labelA.localeCompare(labelB);
                    });
                    var currentWs = null;
                    var data = [];
                    var currentFlow;
                    var currentSelectedCount = 0;
                    candidateNodes.forEach(function(node) {
                        if (currentWs !== node.z) {
                            if (currentFlow && currentFlow.checkbox) {
                                currentFlow.selected = currentSelectedCount === currentFlow.children.length
                            }
                            currentSelectedCount = 0;
                            currentWs = node.z;
                            var parent = RED.nodes.workspace(currentWs) || RED.nodes.subflow(currentWs);
                            currentFlow = {
                                label: RED.utils.getNodeLabel(parent, currentWs),
                            }
                            if (!parent.disabled) {
                                currentFlow.children = [];
                                currentFlow.checkbox = true;
                            } else {
                                currentFlow.class = "disabled"
                            }
                            data.push(currentFlow);
                        }
                        if (currentFlow.children) {
                            if (!filteredNodes[node.id]) {
                                currentSelectedCount++;
                            }
                            currentFlow.children.push({
                                label: RED.utils.getNodeLabel(node,node.id),
                                node: {
                                    id: node.id
                                },
                                checkbox: true,
                                selected: !filteredNodes[node.id]
                            });
                        }
                    });
                    if (currentFlow && currentFlow.checkbox) {
                        currentFlow.selected = currentSelectedCount === currentFlow.children.length
                    }
                    if (subWindow) {
                        try {
                            subWindow.postMessage({event:"refreshDebugNodeList", nodes:data},"*");
                        } catch(err) {
                            console.log(err);
                        }
                    }
                    RED.debug.refreshDebugNodeList(data)
                }
            };

            var uiComponents = RED.debug.init(options);

            RED.sidebar.addTab({
                id: "debug",
                label: this._("debug.sidebar.label"),
                name: this._("debug.sidebar.name"),
                content: uiComponents.content,
                toolbar: uiComponents.footer,
                enableOnEdit: true,
                pinned: true,
                iconClass: "fa fa-bug",
                action: "core:show-debug-tab"
            });
            RED.actions.add("core:show-debug-tab",function() { RED.sidebar.show('debug'); });

            var that = this;
            RED._debug = function(msg) {
                that.handleDebugMessage("", {
                    name:"debug",
                    msg:msg
                });
            };

            this.refreshMessageList = function() {
                RED.debug.refreshMessageList(RED.workspaces.active());
                if (subWindow) {
                    try {
                        subWindow.postMessage({event:"workspaceChange",activeWorkspace:RED.workspaces.active()},"*");
                    } catch(err) {
                        console.log(err);
                    }
                }
            };
            RED.events.on("workspace:change", this.refreshMessageList);

            this.handleDebugMessage = function(t,o) {
                // console.log("->",o.id,o.z,o._alias);
                //
                // sourceNode should be the top-level node - one that is on a flow.
                var sourceNode;
                var pathParts;
                var pathHierarchy;
                if (o.path) {
                    // Path is a `/`-separated list of ids that identifies the
                    // complete parentage of the node that generated this message.
                    //    flow-id/subflow-A-instance/subflow-B-instance

                    // If it has one id, that is a top level flow or config node/global
                    // each subsequent id is the instance id of a subflow node
                    //
                    pathParts = o.path.split("/");
                    if (pathParts.length === 1) {
                        // The source node is on a flow or is a global/config - so can use its id to find
                        sourceNode = RED.nodes.node(o.id);
                    } else if (pathParts.length > 1) {
                        // Highlight the subflow instance node.
                        sourceNode = RED.nodes.node(pathParts[1]);
                    }
                    const getNodeLabel = (n) => n.name || (typeof n.label === "function" && n.label())  || (typeof n.label === "string" && n.label) || (n.type + ":" + n.id);
                    pathHierarchy = pathParts.map((id,index) => {
                        if (index === 0) {
                            if (id === "global") {
                                return { id: sourceNode.id, label: getNodeLabel(sourceNode) }
                            } 
                            return { id: id, label: RED.nodes.workspace(id).label } //flow id + name
                        } else {
                            const instanceNode = RED.nodes.node(id)
                            const pathLabel = (instanceNode.name || RED.nodes.subflow(instanceNode.type.substring(8)).name)
                            return { id: id, label: pathLabel }
                        }
                    })
                    if (pathParts.length === 1 && pathParts[0] !== "global") {
                        pathHierarchy.push({ id: o.id, label: getNodeLabel(sourceNode) })
                    }
                    if (o._alias) {
                        let aliasNode = RED.nodes.node(o._alias)
                        if (aliasNode) {
                            pathHierarchy.push({ id: o._alias, label: getNodeLabel(aliasNode) })
                        }
                    }
                } else {
                    // This is probably redundant...
                    sourceNode = RED.nodes.node(o.id) || RED.nodes.node(o.z);
                }
                if (sourceNode) {
                    var sourceFlow = RED.nodes.workspace(sourceNode.z)
                    o._source = {
                        id:sourceNode.id,
                        z:sourceNode.z,
                        name:sourceNode.name,
                        type:sourceNode.type,
                        // _alias identifies the actual logging node. This is
                        // not necessarily the same as sourceNode, which will be
                        // the top-level subflow instance node.
                        // This means the node's name is displayed in the sidebar.
                        _alias:o._alias,
                        flowName: sourceFlow?(sourceFlow.label||sourceNode.z):sourceNode.z,
                        path: pathParts,
                        pathHierarchy: pathHierarchy
                    };
                }
                RED.debug.handleDebugMessage(o);
                if (subWindow) {
                    try {
                        subWindow.postMessage({event:"message",msg:o},"*");
                    } catch(err) {
                        console.log(err);
                    }
                }
            };
            RED.comms.subscribe("debug",this.handleDebugMessage);

            this.clearMessageList = function() {
                RED.debug.clearMessageList(true);
                if (subWindow) {
                    try {
                        subWindow.postMessage({event:"projectChange"},"*");
                    } catch(err) {
                        console.log(err);
                    }
                }
            };
            RED.events.on("project:change", this.clearMessageList);
            RED.actions.add("core:clear-debug-messages", function() { RED.debug.clearMessageList(true) });
            RED.actions.add("core:clear-filtered-debug-messages", function() { RED.debug.clearMessageList(true, true) });

            RED.actions.add("core:activate-selected-debug-nodes", function() { setDebugNodeState(getSelectedDebugNodes(true), true); });
            RED.actions.add("core:activate-all-debug-nodes", function() { setDebugNodeState(getMatchingDebugNodes(true, true),true); });
            RED.actions.add("core:activate-all-flow-debug-nodes", function() { setDebugNodeState(getMatchingDebugNodes(true, false),true); });

            RED.actions.add("core:deactivate-selected-debug-nodes", function() { setDebugNodeState(getSelectedDebugNodes(false), false); });
            RED.actions.add("core:deactivate-all-debug-nodes", function() { setDebugNodeState(getMatchingDebugNodes(false, true),false); });
            RED.actions.add("core:deactivate-all-flow-debug-nodes", function() { setDebugNodeState(getMatchingDebugNodes(false, false),false); });

            function getSelectedDebugNodes(state) {
                var nodes = [];
                var selection = RED.view.selection();
                if (selection.nodes) {
                    selection.nodes.forEach(function(n) {
                        if (RED.nodes.subflow(n.z)) {
                            return;
                        }
                        if (n.type === 'debug' && n.active !== state) {
                            nodes.push(n);
                        } else if (n.type === 'group') {
                            nodes = nodes.concat( RED.group.getNodes(n,true).filter(function(n) {
                                return n.type === 'debug' && n.active !== state
                            }));
                        }
                    });
                }
                return nodes;

            }
            function getMatchingDebugNodes(state,globally) {
                var nodes = [];
                var filter = {type:"debug"};
                if (!globally) {
                    filter.z = RED.workspaces.active();
                }
                var candidateNodes = RED.nodes.filterNodes(filter);
                nodes = candidateNodes.filter(function(n) {
                    return n.active !== state && !RED.nodes.subflow(n.z)
                })
                return nodes;
            }

            function setDebugNodeState(nodes,state) {
                var historyEvents = [];
                if (nodes.length > 0) {
                    activateAjaxCall(nodes,false, function(resp, textStatus, xhr) {
                        nodes.forEach(function(n) {
                            historyEvents.push({
                                t: "edit",
                                node: n,
                                changed: n.changed,
                                changes: {
                                    active: n.active
                                }
                            });
                            n.active = state;
                            n.changed = true;
                            n.dirty = true;
                        })
                        RED.history.push({
                            t: "multi",
                            events: historyEvents,
                            dirty: RED.nodes.dirty(),
                            callback: function() {
                                activateAjaxCall(nodes,nodes[0].active);
                            }
                        });
                        RED.nodes.dirty(true);
                        RED.view.redraw();
                    });
                }
            }

            function containsDebug(sid, map) {
                var item = map[sid];
                if (item) {
                    if (item.debug === undefined) {
                        var sfs = Object.keys(item.subflows);
                        var contain = false;
                        for (var i = 0; i < sfs.length; i++) {
                            var sf = sfs[i];
                            if (containsDebug(sf, map)) {
                                contain = true;
                                break;
                            }
                        }
                        item.debug = contain;
                    }
                    return item.debug;
                }
                return false;
            }

            $("#red-ui-sidebar-debug-open").on("click", function(e) {
                e.preventDefault();
                subWindow = window.open(document.location.toString().replace(/[?#].*$/,"")+"debug/view/view.html"+document.location.search,"nodeREDDebugView","menubar=no,location=no,toolbar=no,chrome,height=500,width=600");
                subWindow.onload = function() {
                    subWindow.postMessage({event:"workspaceChange",activeWorkspace:RED.workspaces.active()},"*");
                };
            });
            RED.popover.tooltip($("#red-ui-sidebar-debug-open"),RED._('node-red:debug.sidebar.openWindow'));



            $(window).on('beforeunload',function() {
                if (subWindow) {
                    try {
                        subWindow.close();
                    } catch(err) {
                        console.log(err);
                    }
                }
            });

            this.handleWindowMessage = function(evt) {
                var msg = evt.data;
                if (msg.event === "mouseEnter") {
                    options.messageMouseEnter(msg.id);
                } else if (msg.event === "mouseLeave") {
                    options.messageMouseLeave(msg.id);
                } else if (msg.event === "mouseClick") {
                    options.messageSourceClick(msg.id,msg._alias,msg.path);
                } else if (msg.event === "clear") {
                    options.clear();
                } else if (msg.event === "requestDebugNodeList") {
                    options.requestDebugNodeList(msg.filteredNodes)
                }
            };
            window.addEventListener('message',this.handleWindowMessage);
        },
        onpaletteremove: function() {
            RED.comms.unsubscribe("debug",this.handleDebugMessage);
            RED.sidebar.removeTab("debug");
            RED.events.off("workspace:change", this.refreshMessageList);
            window.removeEventListener("message",this.handleWindowMessage);
            RED.actions.remove("core:show-debug-tab");
            RED.actions.remove("core:clear-debug-messages");
            delete RED._debug;
        },
        oneditprepare: function() {
            var autoType = {
                value: "auto",
                label: RED._("node-red:debug.autostatus"),
                hasValue: false
            };

            var counter = {
                value: "counter",
                label: RED._("node-red:debug.messageCount"),
                hasValue: false
            };

            $("#node-input-typed-status").typedInput({
                default: "auto",
                types:[autoType, "msg", "jsonata", counter],
                typeField: $("#node-input-statusType")
            });
            var that = this;
            var none = {
                value: "none",
                label: RED._("node-red:debug.none"),
                hasValue: false
            };
            if (this.tosidebar === undefined) {
                this.tosidebar = true;
                $("#node-input-tosidebar").prop('checked', true);
            }
            if (this.statusVal === undefined) {
                this.statusVal = (this.complete === "false") ? "payload" : ((this.complete === "true") ? "payload" : this.complete+"");
                $("#node-input-typed-status").typedInput('value',this.statusVal || "");
            }
            if (this.statusType === undefined) {
                this.statusType = "auto";
                $("#node-input-typed-status").typedInput('type',this.statusType || "auto");
            }
            if (typeof this.console === "string") {
                this.console = (this.console == 'true');
                $("#node-input-console").prop('checked', this.console);
                $("#node-input-tosidebar").prop('checked', true);
            }
            var fullType = {
                value: "full",
                label: RED._("node-red:debug.msgobj"),
                hasValue: false
            };

            $("#node-input-typed-complete").typedInput({
                default: "msg",
                types:['msg', fullType, "jsonata"],
                typeField: $("#node-input-targetType")
            });
            if (this.targetType === "jsonata") {
                var property = this.complete || "";
                $("#node-input-typed-complete").typedInput('type','jsonata');
                $("#node-input-typed-complete").typedInput('value',property);
            } else if ((this.targetType === "full") || this.complete === "true" || this.complete === true) {
                // show complete message object
                $("#node-input-typed-complete").typedInput('type','full');
            } else {
                var property = (!this.complete||(this.complete === "false")) ? "payload" : this.complete+"";
                $("#node-input-typed-complete").typedInput('type','msg');
                $("#node-input-typed-complete").typedInput('value',property);
            }
            $("#node-input-typed-complete").on('change',function() {
                if ($("#node-input-typed-complete").typedInput('type') === 'msg' &&
                    $("#node-input-typed-complete").typedInput('value') === ''
                ) {
                    $("#node-input-typed-complete").typedInput('value','payload');
                }
            });

            $("#node-input-tostatus").on('change',function() {
                if ($(this).is(":checked")) {
                    if (that.statusType === "counter") {
                        that.statusVal = "";
                    }
                    else if (!that.hasOwnProperty("statusVal") || that.statusVal === "") {
                        var type = $("#node-input-typed-complete").typedInput('type');
                        var comp = "payload";
                        if (type !== 'full') {
                            comp = $("#node-input-typed-complete").typedInput('value');
                        }
                        that.statusType = "auto";
                        that.statusVal = comp;
                    }
                    $("#node-input-typed-status").typedInput('type',that.statusType);
                    $("#node-input-typed-status").typedInput('value',that.statusVal);
                    $("#node-tostatus-line").show();
                }
                else {
                    $("#node-tostatus-line").hide();
                    that.statusType = "auto";
                    that.statusVal = "";
                    $("#node-input-typed-status").typedInput('type',that.statusType);
                    $("#node-input-typed-status").typedInput('value',that.statusVal);
                }
            });
        },
        oneditsave: function() {
            var type = $("#node-input-typed-complete").typedInput('type');
            if (type === 'full') {
                $("#node-input-complete").val("true");
            } else {
                $("#node-input-complete").val($("#node-input-typed-complete").typedInput('value'));
            }
            $("#node-input-statusVal").val($("#node-input-typed-status").typedInput('value'));
        },
        onadd: function() {
            if (this.name === '_DEFAULT_') {
                this.name = ''
                RED.actions.invoke("core:generate-node-names", this, {generateHistory: false})
            }
        }
    });
})();
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="debug">
    <p>Displays selected message properties in the debug sidebar tab and optionally the runtime log. By default it displays <code>msg.payload</code>, but can be configured to display any property, the full message or the result of a JSONata expression.</p>
    <h3>Details</h3>
    <p>The debug sidebar provides a structured view of the messages it is sent, making it easier to understand their structure.</p>
    <p>JavaScript objects and arrays can be collapsed and expanded as required. Buffer objects can be displayed as raw data or as a string if possible.</p>
    <p>Alongside each message, the debug sidebar includes information about the time the message was received, the node that sent it and the type of the message.
       Clicking on the source node id will reveal that node within the workspace.</p>
    <p>The button on the node can be used to enable or disable its output. It is recommended to disable or remove any Debug nodes that are not being used.</p>
    <p>The node can also be configured to send all messages to the runtime log, or to send short (32 characters) to the status text under the debug node.</p>
</script>

<!-- --- [red-module:node-red/complete] --- -->
<script type="text/html" data-template-name="complete">
    <div class="form-row node-input-target-row">
        <button type="button" id="node-input-complete-target-select" class="red-ui-button" data-i18n="common.label.selectNodes"></button>
    </div>
    <div class="form-row node-input-target-row node-input-target-list-row" style="position: relative; min-height: 100px">
        <div style="position: absolute; top: -30px; right: 0;"><input type="text" id="node-input-complete-target-filter"></div>
        <div id="node-input-complete-target-container-div"></div>
    </div>

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
</script>
<script type="text/javascript">
    RED.nodes.registerType('complete',{
        category: 'common',
        color:"#c0edc0",
        defaults: {
            name: {value:""},
            scope: {
                value: [],
                type: "*[]",
                validate: function (v, opt) {
                    if (v.length > 0) {
                        return true;
                    }
                    return RED._("node-red:complete.errors.scopeUndefined");
                }
            },
            uncaught: {value:false}
        },
        inputs:0,
        outputs:1,
        icon: "alert.svg",
        label: function() {
            if (this.name) {
                return this.name;
            }
            return this._("complete.completeNodes",{number:this.scope.length});
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            var node = this;
            var scope = node.scope || [];

            this._resize = function() {
                var rows = $("#dialog-form>div:not(.node-input-target-list-row)");
                var height = $("#dialog-form").height();
                for (var i=0;i<rows.length;i++) {
                    height -= $(rows[i]).outerHeight(true);
                }
                var editorRow = $("#dialog-form>div.node-input-target-list-row");
                editorRow.css("height",height+"px");
            };
            var search = $("#node-input-complete-target-filter").searchBox({
                style: "compact",
                delay: 300,
                change: function() {
                    var val = $(this).val().trim().toLowerCase();
                    if (val === "") {
                        dirList.treeList("filter", null);
                        search.searchBox("count","");
                    } else {
                        var count = dirList.treeList("filter", function(item) {
                            return item.label.toLowerCase().indexOf(val) > -1 || item.node.type.toLowerCase().indexOf(val) > -1
                        });
                        search.searchBox("count",count+" / "+candidateNodes.length);
                    }
                }
            });

            var dirList = $("#node-input-complete-target-container-div").css({width: "100%", height: "100%"})
                .treeList({multi:true}).on("treelistitemmouseover", function(e, item) {
                    item.node.highlighted = true;
                    item.node.dirty = true;
                    RED.view.redraw();
                }).on("treelistitemmouseout", function(e, item) {
                    item.node.highlighted = false;
                    item.node.dirty = true;
                    RED.view.redraw();
                })
            var candidateNodes = RED.nodes.filterNodes({z:node.z});
            var allChecked = true;
            var items = [];
            var nodeItemMap = {};

            candidateNodes.forEach(function(n) {
                if (n.id === node.id) {
                    return;
                }
                var isChecked = scope.indexOf(n.id) !== -1;

                allChecked = allChecked && isChecked;

                var nodeDef = RED.nodes.getType(n.type);
                var label;
                var sublabel;
                if (nodeDef) {
                    var l = nodeDef.label;
                    label = (typeof l === "function" ? l.call(n) : l)||"";
                    sublabel = n.type;
                    if (sublabel.indexOf("subflow:") === 0) {
                        var subflowId = sublabel.substring(8);
                        var subflow = RED.nodes.subflow(subflowId);
                        sublabel = "subflow : "+subflow.name;
                    }
                }
                if (!nodeDef || !label) {
                    label = n.type;
                }
                nodeItemMap[n.id] = {
                    node: n,
                    label: label,
                    sublabel: sublabel,
                    selected: isChecked,
                    checkbox: true
                };
                items.push(nodeItemMap[n.id]);
            });
            dirList.treeList('data',items);

            $("#node-input-complete-target-select").on("click", function(e) {
                e.preventDefault();
                var preselected = dirList.treeList('selected').map(function(n) {return n.node.id});
                RED.tray.hide();
                RED.view.selectNodes({
                    selected: preselected,
                    onselect: function(selection) {
                        RED.tray.show();
                        var newlySelected = {};
                        selection.forEach(function(n) {
                            newlySelected[n.id] = true;
                            if (nodeItemMap[n.id]) {
                                nodeItemMap[n.id].treeList.select(true);
                            }
                        })
                        preselected.forEach(function(id) {
                            if (!newlySelected[id]) {
                                nodeItemMap[id].treeList.select(false);
                            }
                        })
                    },
                    oncancel: function() {
                        RED.tray.show();
                    },
                    filter: function(n) {
                        return n.id !== node.id;
                    }
                });
            })

        },
        oneditsave: function() {
            this.scope = $("#node-input-complete-target-container-div").treeList('selected').map(function(i) { return i.node.id})
        },
        oneditresize: function(size) {
            this._resize();
        }
    });
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="complete">
    <p>Trigger a flow when another node completes its handling of a message.</p>
    <h3>Details</h3>
    <p>If a node tells the runtime when it has finished handling a message,
        this node can be used to trigger a second flow.</p>
    <p>For example, this can be used alongside a node with no output port,
        such as the Email sending node, to continue the flow.</p>
    <p>This node must be configured to handle the event for selected nodes in the
        flow. Unlike the Catch node, it does not provide a 'handle all' mode automatically
        applies to all nodes in the flow.</p>
    <p>Not all nodes will trigger this event - it will depend on whether they
        have been implemented to support this feature as introduced in Node-RED 1.0.</p>
</script>

<!-- --- [red-module:node-red/catch] --- -->

<script type="text/html" data-template-name="catch">
    <div class="form-row">
        <label style="width: auto" for="node-input-scope" data-i18n="catch.label.source"></label>
        <select id="node-input-scope-select">
            <option value="all" data-i18n="catch.scope.all"></option>
            <option value="group" data-i18n="catch.scope.group"></option>
            <option value="target" data-i18n="catch.scope.selected"></option>
        </select>
    </div>
    <div class="form-row node-input-uncaught-row">
        <input type="checkbox" id="node-input-uncaught" style="display: inline-block; width: auto; vertical-align: top; margin-left: 30px; margin-right: 5px;">
        <label for="node-input-uncaught" style="width: auto" data-i18n="catch.label.uncaught"></label>
    </div>
    <div class="form-row node-input-target-row">
        <button type="button" id="node-input-catch-target-select" class="red-ui-button" data-i18n="common.label.selectNodes"></button>
    </div>
    <div class="form-row node-input-target-row node-input-target-list-row" style="position: relative; min-height: 100px">
        <div style="position: absolute; top: -30px; right: 0;"><input type="text" id="node-input-catch-target-filter"></div>
        <div id="node-input-catch-target-container-div"></div>
    </div>

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
</script>
<script type="text/javascript">
    RED.nodes.registerType('catch',{
        category: 'common',
        color:"#e49191",
        defaults: {
            name: {value:""},
            scope: {value:null, type:"*[]"},
            uncaught: {value:false}
        },
        inputs:0,
        outputs:1,
        icon: "alert.svg",
        label: function() {
            if (this.name) {
                return this.name;
            }
            if (this.scope === "group") {
                return this._("catch.catchGroup");
            } else if (Array.isArray(this.scope)) {
                return this._("catch.catchNodes",{number:this.scope.length});
            }
            return this.uncaught?this._("catch.catchUncaught"):this._("catch.catch")
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            var node = this;
            var scope = node.scope || [];

            this._resize = function() {
                var rows = $("#dialog-form>div:not(.node-input-target-list-row)");
                var height = $("#dialog-form").height();
                for (var i=0;i<rows.length;i++) {
                    height -= $(rows[i]).outerHeight(true);
                }
                var editorRow = $("#dialog-form>div.node-input-target-list-row");
                editorRow.css("height",height+"px");
            };
            var search = $("#node-input-catch-target-filter").searchBox({
                style: "compact",
                delay: 300,
                change: function() {
                    var val = $(this).val().trim().toLowerCase();
                    if (val === "") {
                        dirList.treeList("filter", null);
                        search.searchBox("count","");
                    } else {
                        var count = dirList.treeList("filter", function(item) {
                            return item.label.toLowerCase().indexOf(val) > -1 || item.node.type.toLowerCase().indexOf(val) > -1
                        });
                        search.searchBox("count",count+" / "+candidateNodes.length);
                    }
                }
            });
            var dirList = $("#node-input-catch-target-container-div").css({width: "100%", height: "100%"})
                .treeList({multi:true}).on("treelistitemmouseover", function(e, item) {
                    item.node.highlighted = true;
                    item.node.dirty = true;
                    RED.view.redraw();
                }).on("treelistitemmouseout", function(e, item) {
                    item.node.highlighted = false;
                    item.node.dirty = true;
                    RED.view.redraw();
                })
            var candidateNodes = RED.nodes.filterNodes({z:node.z});
            var allChecked = true;
            var items = [];
            var nodeItemMap = {};

            candidateNodes.forEach(function(n) {
                if (n.id === node.id) {
                    return;
                }
                var isChecked = scope.indexOf(n.id) !== -1;

                allChecked = allChecked && isChecked;

                var nodeDef = RED.nodes.getType(n.type);
                var label;
                var sublabel;
                if (nodeDef) {
                    var l = nodeDef.label;
                    label = (typeof l === "function" ? l.call(n) : l)||"";
                    sublabel = n.type;
                    if (sublabel.indexOf("subflow:") === 0) {
                        var subflowId = sublabel.substring(8);
                        var subflow = RED.nodes.subflow(subflowId);
                        sublabel = "subflow : "+subflow.name;
                    }
                }
                if (!nodeDef || !label) {
                    label = n.type;
                }
                nodeItemMap[n.id] = {
                    node: n,
                    label: label,
                    sublabel: sublabel,
                    selected: isChecked,
                    checkbox: true
                };
                items.push(nodeItemMap[n.id]);
            });
            dirList.treeList('data',items);

            $("#node-input-catch-target-select").on("click", function(e) {
                e.preventDefault();
                var preselected = dirList.treeList('selected').map(function(n) {return n.node.id});
                RED.tray.hide();
                RED.view.selectNodes({
                    selected: preselected,
                    onselect: function(selection) {
                        RED.tray.show();
                        var newlySelected = {};
                        selection.forEach(function(n) {
                            newlySelected[n.id] = true;
                            if (nodeItemMap[n.id]) {
                                nodeItemMap[n.id].treeList.select(true);
                            }
                        })
                        preselected.forEach(function(id) {
                            if (!newlySelected[id]) {
                                nodeItemMap[id].treeList.select(false);
                            }
                        })
                    },
                    oncancel: function() {
                        RED.tray.show();
                    },
                    filter: function(n) {
                        return n.id !== node.id;
                    }
                });
            })

            $("#node-input-scope-select").on("change", function(e) {
                var scope = $(this).val();
                if (scope === "target") {
                    $(".node-input-target-row").show();
                    $(".node-input-uncaught-row").hide();
                } else {
                    $(".node-input-target-row").hide();
                    $(".node-input-uncaught-row").show();
                }
                node._resize();
            });
            if (this.scope === null) {
                $("#node-input-scope-select").val("all");
            } else if(this.scope === "group"){
                $("#node-input-scope-select").val("group");
            } else {
                $("#node-input-scope-select").val("target");
            }
            $("#node-input-scope-select").trigger("change");
        },
        oneditsave: function() {
            var scope = $("#node-input-scope-select").val();
            if (scope === 'all') {
                this.scope = null;
            } else if(scope === 'group') {
                this.scope = "group";
            } else {
                $("#node-input-uncaught").prop("checked",false);
                this.scope = $("#node-input-catch-target-container-div").treeList('selected').map(function(i) { return i.node.id})
            }
        },
        oneditresize: function(size) {
            this._resize();
        }
    });
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="catch">
    <p>Catch errors thrown by nodes on the same tab.</p>
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>error.message <span class="property-type">string</span></dt>
        <dd>the error message.</dd>
        <dt>error.source.id <span class="property-type">string</span></dt>
        <dd>the id of the node that threw the error.</dd>
        <dt>error.source.type <span class="property-type">string</span></dt>
        <dd>the type of the node that threw the error.</dd>
        <dt>error.source.name <span class="property-type">string</span></dt>
        <dd>the name, if set, of the node that threw the error.</dd>
    </dl>
    <h3>Details</h3>
    <p>If a node throws an error whilst handling a message, the flow will typically
       halt. This node can be used to catch those errors and handle them with a
       dedicated flow.</p>
    <p>By default, the node will catch errors thrown by any node on the same tab. Alternatively
    it can be targetted at specific nodes, or configured to only catch errors that
    have not already been caught by a 'targeted' catch node.</p>
    <p>When an error is thrown, all matching catch nodes will receive the message.</p>
    <p>If an error is thrown within a subflow, the error will get handled by any
       catch nodes within the subflow. If none exists, the error will be propagated
       up to the tab the subflow instance is on.</p>
   <p>If the message already has a <code>error</code> property, it is copied to <code>_error</code>.</p>
</script>

<!-- --- [red-module:node-red/status] --- -->

<script type="text/html" data-template-name="status">
    <div class="form-row">
        <label style="width: auto" for="node-input-scope" data-i18n="status.label.source"></label>
        <select id="node-input-scope-select">
            <option value="all" data-i18n="status.scope.all"></option>
            <option value="group" data-i18n="status.scope.group"></option>
            <option value="target" data-i18n="status.scope.selected"></option>
        </select>
    </div>
    <div class="form-row node-input-target-row">
        <button type="button" id="node-input-status-target-select" class="red-ui-button" data-i18n="common.label.selectNodes"></button>
    </div>
    <div class="form-row node-input-target-row node-input-target-list-row" style="position: relative; min-height: 100px">
        <div style="position: absolute; top: -30px; right: 0;"><input type="text" id="node-input-status-target-filter"></div>
        <div id="node-input-status-target-container-div"></div>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('status',{
        category: 'common',
        color:"#94c1d0",
        defaults: {
            name: {value:""},
            scope: {value:null, type:"*[]"}
        },
        inputs:0,
        outputs:1,
        icon: "status.svg",
        label: function() {
            if (this.name) {
                return this.name;
            }
            if (this.scope === "group") {
                return this._("status.statusGroup");
            } else if (Array.isArray(this.scope)) {
                return this._("status.statusNodes",{number:this.scope.length});
            }
            return this._("status.status")
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            var node = this;
            var scope = node.scope || [];
            this._resize = function() {
                var rows = $("#dialog-form>div:not(.node-input-target-list-row)");
                var height = $("#dialog-form").height();
                for (var i=0;i<rows.length;i++) {
                    height -= $(rows[i]).outerHeight(true);
                }
                var editorRow = $("#dialog-form>div.node-input-target-list-row");
                editorRow.css("height",height+"px");
            };
            var search = $("#node-input-status-target-filter").searchBox({
                style: "compact",
                delay: 300,
                change: function() {
                    var val = $(this).val().trim().toLowerCase();
                    if (val === "") {
                        dirList.treeList("filter", null);
                        search.searchBox("count","");
                    } else {
                        var count = dirList.treeList("filter", function(item) {
                            return item.label.toLowerCase().indexOf(val) > -1 || item.node.type.toLowerCase().indexOf(val) > -1
                        });
                        search.searchBox("count",count+" / "+candidateNodes.length);
                    }
                }
            });

            var dirList = $("#node-input-status-target-container-div").css({width: "100%", height: "100%"})
                .treeList({multi:true}).on("treelistitemmouseover", function(e, item) {
                    item.node.highlighted = true;
                    item.node.dirty = true;
                    RED.view.redraw();
                }).on("treelistitemmouseout", function(e, item) {
                    item.node.highlighted = false;
                    item.node.dirty = true;
                    RED.view.redraw();
                })
            var candidateNodes = RED.nodes.filterNodes({z:node.z});
            var allChecked = true;
            var items = [];
            var nodeItemMap = {};

            candidateNodes.forEach(function(n) {
                if (n.id === node.id) {
                    return;
                }
                var isChecked = scope.indexOf(n.id) !== -1;

                allChecked = allChecked && isChecked;

                var nodeDef = RED.nodes.getType(n.type);
                var label;
                var sublabel;
                if (nodeDef) {
                    var l = nodeDef.label;
                    label = (typeof l === "function" ? l.call(n) : l)||"";
                    sublabel = n.type;
                    if (sublabel.indexOf("subflow:") === 0) {
                        var subflowId = sublabel.substring(8);
                        var subflow = RED.nodes.subflow(subflowId);
                        sublabel = "subflow : "+subflow.name;
                    }
                }
                if (!nodeDef || !label) {
                    label = n.type;
                }
                nodeItemMap[n.id] = {
                    node: n,
                    label: label,
                    sublabel: sublabel,
                    selected: isChecked,
                    checkbox: true
                };
                items.push(nodeItemMap[n.id]);
            });
            dirList.treeList('data',items);

            $("#node-input-status-target-select").on("click", function(e) {
                e.preventDefault();
                var preselected = dirList.treeList('selected').map(function(n) {return n.node.id});
                RED.tray.hide();
                RED.view.selectNodes({
                    selected: preselected,
                    onselect: function(selection) {
                        RED.tray.show();
                        var newlySelected = {};
                        selection.forEach(function(n) {
                            newlySelected[n.id] = true;
                            if (nodeItemMap[n.id]) {
                                nodeItemMap[n.id].treeList.select(true);
                            }
                        })
                        preselected.forEach(function(id) {
                            if (!newlySelected[id]) {
                                nodeItemMap[id].treeList.select(false);
                            }
                        })
                    },
                    oncancel: function() {
                        RED.tray.show();
                    },
                    filter: function(n) {
                        return n.id !== node.id;
                    }
                });
            })

            $("#node-input-scope-select").on("change", function(e) {
                var scope = $(this).val();
                if (scope === "target") {
                    $(".node-input-target-row").show();
                } else {
                    $(".node-input-target-row").hide();
                }
                node._resize();
            });
            if (this.scope === null) {
                $("#node-input-scope-select").val("all");
            } else if(this.scope === "group"){
                $("#node-input-scope-select").val("group");
            } else {
                $("#node-input-scope-select").val("target");
            }
            $("#node-input-scope-select").trigger("change");
        },
        oneditsave: function() {
            var scope = $("#node-input-scope-select").val();
            if (scope === 'all') {
                this.scope = null;
            } else if(scope === 'group') {
                this.scope = "group";
            } else {
                this.scope = $("#node-input-status-target-container-div").treeList('selected').map(function(i) { return i.node.id})
            }
        },
        oneditresize: function(size) {
            this._resize();
        }
    });
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="status">
    <p>Report status messages from other nodes on the same tab.</p>
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>status.text <span class="property-type">string</span></dt>
        <dd>the status text.</dd>
        <dt>status.source.type <span class="property-type">string</span></dt>
        <dd>the type of the node that reported status.</dd>
        <dt>status.source.id <span class="property-type">string</span></dt>
        <dd>the id of the node that reported status.</dd>
        <dt>status.source.name <span class="property-type">string</span></dt>
        <dd>the name, if set, of the node that reported status.</dd>
    </dl>
    <h3>Details</h3>
   <p>This node does not produce a <code>payload</code>.</p>
   <p>By default the node reports status for all nodes on the same workspace tab.
   It can be configured to selectively report status for individual nodes.</p>
</script>

<!-- --- [red-module:node-red/link] --- -->
<script type="text/html" data-template-name="link in">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
    <div style="position:relative; height: 30px; text-align: right;"><div style="display:inline-block"><input type="text" id="node-input-link-target-filter"></div></div>
    <div class="form-row node-input-link-row"></div>
</script>
<script type="text/html" data-template-name="link out">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
    <div class="form-row">
        <label for="node-input-mode"><span data-i18n="link.outMode"></span></label>
        <select id="node-input-mode" style="width: 70%">
            <option value="link" selected data-i18n="link.sendToAll"></option>
            <option value="return" data-i18n="link.returnToCaller"></option>
        </select>
    </div>
    <div class="node-input-link-rows" style="position:relative; height: 30px; text-align: right;"><div style="display:inline-block"><input type="text" id="node-input-link-target-filter"></div></div>
    <div class="form-row node-input-link-row node-input-link-rows"></div>
</script>

<script type="text/html" data-template-name="link call">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
    <div class="form-row">
        <label for="node-input-timeout"><i class="fa fa-clock-o"></i> <span data-i18n="exec.label.timeout"></span></label>
        <input type="text" id="node-input-timeout" placeholder="30" style="width: 70px; margin-right: 5px;"><span data-i18n="inject.seconds"></span>
    </div>
    <div class="form-row">
        <label for="node-input-linkType" data-i18n="link.linkCallType"></label>
        <select id="node-input-linkType" style="width: 70%">
            <option value="static" data-i18n="link.staticLinkCall"></option>
            <option value="dynamic" data-i18n="link.dynamicLinkCall"></option>
        </select>
    </div>
    <div class="link-call-target-tree" style="position:relative; height: 30px; text-align: right;">
        <div style="display:inline-block"><input type="text" id="node-input-link-target-filter"></div>
    </div>
    <div class="form-row node-input-link-row link-call-target-tree"></div>
</script>

<script type="text/javascript">
(function() {

    let treeList;

    function onEditPrepare(node,targetType) {
        if (!node.links) {
            node.links = [];
        }
        node.oldLinks = [];

        const activeSubflow = RED.nodes.subflow(node.z);

        treeList = $("<div>")
            .css({width: "100%", height: "100%"})
            .appendTo(".node-input-link-row")
            .treeList({autoSelect:false})
            .on('treelistitemmouseover',function(e,item) {
                if (item.node) {
                    item.node.highlighted = true;
                    item.node.dirty = true;
                    RED.view.redraw();
                }
            })
            .on('treelistitemmouseout',function(e,item) {
                if (item.node) {
                    item.node.highlighted = false;
                    item.node.dirty = true;
                    RED.view.redraw();
                }
            });
        const candidateNodes = RED.nodes.filterNodes({type:targetType});
        let candidateNodesCount = 0;

        const search = $("#node-input-link-target-filter").searchBox({
            style: "compact",
            delay: 300,
            change: function() {
                var val = $(this).val().trim().toLowerCase();
                if (val === "") {
                    treeList.treeList("filter", null);
                    search.searchBox("count","");
                } else {
                    const count = treeList.treeList("filter", function(item) {
                        return item.label.toLowerCase().indexOf(val) > -1 || (item.node && item.node.type.toLowerCase().indexOf(val) > -1)
                    });
                    search.searchBox("count",count+" / "+candidateNodesCount);
                }
            }
        });

        const flows = [];
        const flowMap = {};

        if (activeSubflow) {
            flowMap[activeSubflow.id] = {
                id: activeSubflow.id,
                class: 'red-ui-palette-header',
                label: "Subflow : " + (activeSubflow.name || activeSubflow.id),
                expanded: true,
                children: []
            };
            flows.push(flowMap[activeSubflow.id])
        }
        if (!activeSubflow || node.type === "link call") {
            // Only "Link Call" can look outside of its own subflow
            // Link In and Link Out nodes outside of a subflow should be ignored
            RED.nodes.eachWorkspace(function (ws) {
                flowMap[ws.id] = {
                    id: ws.id,
                    class: 'red-ui-palette-header',
                    label: (ws.label || ws.id) + (node.z === ws.id ? " *" : ""),
                    expanded: true,
                    children: []
                }
                flows.push(flowMap[ws.id])
            })
        }

        candidateNodes.forEach(function (n) {
            if (flowMap[n.z]) {
                if (targetType === "link out" && n.mode === 'return') {
                    // Link In nodes looking for Link Out nodes should not
                    // include return-mode nodes.
                    return;
                }
                const isChecked = (node.links.indexOf(n.id) !== -1) || (n.links || []).indexOf(node.id) !== -1;
                if (isChecked) {
                    node.oldLinks.push(n.id);
                }
                flowMap[n.z].children.push({
                    id: n.id,
                    node: n,
                    label: n.name || n.id,
                    selected: isChecked,
                    checkbox: node.type !== "link call",
                    radio: node.type === "link call"
                })
                candidateNodesCount++;
            }
        });
        const flowsFiltered = flows.filter(function(f) { return f.children.length > 0 })
        treeList.treeList('data',flowsFiltered);
        setTimeout(function() {
            treeList.treeList('show',node.z);
        },100);
    }

    function resizeNodeList() {
        var rows = $("#dialog-form>div:not(.node-input-link-row)");
        var height = $("#dialog-form").height();
        for (var i=0;i<rows.length;i++) {
            height -= $(rows[i]).outerHeight(true);
        }
        var editorRow = $("#dialog-form>div.node-input-link-row");
        height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));
        $(".node-input-link-row").css("height",height+"px");
    }

    function onEditSave(node) {
        var flows = treeList.treeList('data');
        node.links = [];
        if (node.type !== "link out" || $("#node-input-mode").val() === 'link') {
            flows.forEach(function(f) {
                f.children.forEach(function(n) {
                    if (n.selected) {
                        node.links.push(n.id);
                    }
                })
            })
        }
        node.oldLinks.sort();
        node.links.sort();

        if (node.type === "link call") {
            return
        }

        var nodeMap = {};
        var length = Math.max(node.oldLinks.length,node.links.length);
        for (var i=0;i<length;i++) {
            if (i<node.oldLinks.length) {
                nodeMap[node.oldLinks[i]] = nodeMap[node.oldLinks[i]]||{};
                nodeMap[node.oldLinks[i]].old = true;
            }
            if (i<node.links.length) {
                nodeMap[node.links[i]] = nodeMap[node.links[i]]||{};
                nodeMap[node.links[i]].new = true;
            }
        }
        var n;
        for (var id in nodeMap) {
            if (nodeMap.hasOwnProperty(id)) {
                n = RED.nodes.node(id);
                if (n) {
                    if (nodeMap[id].old && !nodeMap[id].new) {
                        // Removed id
                        i = n.links.indexOf(node.id);
                        if (i > -1) {
                            n.links.splice(i,1);
                        }
                    } else if (!nodeMap[id].old && nodeMap[id].new) {
                        // Added id
                        i = n.links.indexOf(id);
                        if (i === -1) {
                            n.links.push(node.id);
                        }
                    }
                }
            }
        }
    }

    function onAdd() {
        if (this.name === '_DEFAULT_') {
            this.name = ''
            RED.actions.invoke("core:generate-node-names", this, {generateHistory: false})
        }
        for (var i=0;i<this.links.length;i++) {
            var n = RED.nodes.node(this.links[i]);
            if (n && n.links.indexOf(this.id) === -1) {
                n.links.push(this.id);
            }
        }
    }

    RED.nodes.registerType('link in',{
        category: 'common',
        color:"#ddd",//"#87D8CF",
        defaults: {
            name: { value: "_DEFAULT_" },
            links: { value: [], type:"link out[]" }
        },
        inputs:0,
        outputs:1,
        icon: "link-out.svg",
        outputLabels: function(i) {
            return this.name||this._("link.linkIn");
        },
        showLabel: false,
        label: function() {
            return this.name||this._("link.linkIn");
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            onEditPrepare(this,"link out");
        },
        oneditsave: function() {
            onEditSave(this);
            // In case the name has changed, ensure any link call nodes on this
            // tab are redrawn with the updated name
            var localCallNodes = RED.nodes.filterNodes({z:RED.workspaces.active(), type:"link call"});
            localCallNodes.forEach(function(node) {
                node.dirty = true;
            });
        },
        onadd: onAdd,
        oneditresize: resizeNodeList
    });

    RED.nodes.registerType('link call',{
        category: 'common',
        color:"#ddd",//"#87D8CF",
        defaults: {
            name: { value: "" },
            links: {
                value: [],
                type: "link in[]",
                validate: function (v, opt) {
                    if (((this.linkType || "static") === "static" && v.length > 0)
                      || this.linkType === "dynamic") {
                        return true;
                    }
                    return RED._("node-red:link.errors.linkUndefined");
                }
            },
            linkType: { value:"static" },
            timeout: {
                value: "30",
                label: RED._("node-red:link.timeout"),
                validate:RED.validators.number(true)
            }
        },
        inputs: 1,
        outputs: 1,
        icon: "link-call.svg",
        inputLabels: function(i) {
            return this.name||this._("link.linkCall");
        },
        label: function() {
            if (this.name) {
                return this.name;
            }
            if (this.linkType === "dynamic") {
                return this._("link.dynamicLinkLabel");
            } else if (this.links.length > 0) {
                var targetNode = RED.nodes.node(this.links[0]);
                return targetNode && (targetNode.name || this._("link.linkCall"));
            }
            return this._("inject.none");
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            const updateVisibility = function() {
                const static = $('#node-input-linkType').val() !== "dynamic";
                if(static) {
                    $("div.link-call-target-tree").show();
                } else {
                    $("div.link-call-target-tree").hide();
                }
            }
            $("#node-input-linkType").on("change",function(d){
                updateVisibility();
            });
            if (["static","dynamic"].indexOf(this.linkType) < 0) {
                $("#node-input-linkType").val('static');
            }
            updateVisibility();
            onEditPrepare(this,"link in");
        },
        oneditsave: function() {
            onEditSave(this);
        },
        oneditresize: resizeNodeList
    });

    RED.nodes.registerType('link out',{
        category: 'common',
        color:"#ddd",//"#87D8CF",
        defaults: {
            name: { value:"_DEFAULT_" },
            mode: { value: "link" },// link || return
            links: { value: [], type:"link in[]" }
        },
        align:"right",
        inputs:1,
        outputs:0,
        icon: function() {
            if (this.mode === "return") {
                return "link-return.svg";
            } else {
                return "link-out.svg";
            }
        },
        inputLabels: function(i) {
            return this.name||(this.mode === "return" ?this._("link.linkOutReturn"):this._("link.linkOut"));
        },
        showLabel: false,
        label: function() {
            return this.name||(this.mode === "return" ?this._("link.linkOutReturn"):this._("link.linkOut"));
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            onEditPrepare(this,"link in");
            $("#node-input-mode").on("change", function() {
                $(".node-input-link-rows").toggle(this.value === "link")
            })
            if (!this.mode) {
                $("#node-input-mode").val('link').trigger("change");
            }

        },
        oneditsave: function() {
            onEditSave(this);
        },
        onadd: onAdd,
        oneditresize: resizeNodeList
    });



})();
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="link in">
    <p>Create virtual wires between flows.</p>
    <h3>Details</h3>
    <p>The node can be connected to any <code>link out</code> node that exists on any tab.
       Once connected, they behave as if they were wired together.</p>
    <p>The wires between link nodes are only displayed when a link node is selected.
       If there are any wires to other tabs, a virtual node is shown that can be clicked
       on to jump to the appropriate tab.</p>
    <p><b>Note: </b>Links cannot be created going into, or out of, a subflow.</p>
</script>

<script type="text/html" data-help-name="link out">
    <p>Create virtual wires between flows.</p>
    <h3>Details</h3>
    <p>This node can be configured to either send messages to all <code>link in</code>
       nodes it is connected to, or to send a response back to the <code>link call</code>
       node that triggered the flow.</p>
    <p>When in 'send to all' mode, the wires between link nodes are only displayed when
       the node is selected. If there are any wires to other tabs, a virtual node
       is shown that can be clicked on to jump to the appropriate tab.</p>
    <p><b>Note: </b>Links cannot be created going into, or out of, a subflow.</p>
</script>

<script type="text/html" data-help-name="link call">
    <p>Calls a flow that starts with a <code>link in</code> node and passes on the response.</p>
    <h3>Inputs</h3>
    <dl class="message-properties">
      <dt class="optional">target<span class="property-type">string</span></dt>
      <dd>When the option <b>Link Type</b> is set to "Dynamic target", set <code>msg.target</code> to the name of the
          <code>link in</code> node you wish to call.</dd>
    </dl>
    <h3>Details</h3>
    <p>This node can be connected to a <code>link in</code> node that exists on any tab.
       The flow connected to that node must end with a <code>link out</code> node configured
       in 'return' mode.</p>
    <p>When this node receives a message, it is passed to the connected <code>link in</code> node.
       It then waits for a response which it then sends on.</p>
    <p>If no response is received within the configured timeout, default 30 seconds, the node
       will log an error that can be caught using the <code>catch</code> node.</p>
    <p>When the option <b>Link Type</b> is set to "Dynamic target" <code>msg.target</code> can be used to call a
       <code>link in</code> by name or id. 
    <ul>
      <li>If there is a <code>link in</code> nodes with the same id, it will be called</li>
      <li>If there are two or more <code>link in</code> nodes with the same name, an error will be raised</li>
      <li>A <code>link call</code> cannot call a <code>link in</code> node inside a subflow</li>
    </ul>
    </p>
    The flow connected to that node must end with a <code>link out</code> node configured
    in 'return' mode.</p>
</script>

<!-- --- [red-module:node-red/comment] --- -->

<script type="text/html" data-template-name="comment">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
    <div class="form-row node-text-editor-row">
        <input type="hidden" id="node-input-info" autofocus="autofocus">
        <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-info-editor"></div>
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('comment',{
        category: 'common',
        color:"#ffffff",
        defaults: {
            name: {value:""},
            info: {value:""}
        },
        inputs:0,
        outputs:0,
        icon: "comment.svg",
        label: function() {
            return this.name||this._("comment.comment");
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        info: function() {
            return this.name?"# "+this.name+"\n\n---\n\n":"";
        },
        oneditprepare: function() {
            var that = this;
            this.editor = RED.editor.createEditor({
                id: 'node-input-info-editor',
                mode: 'ace/mode/markdown',
                value: $("#node-input-info").val()
            });
            this.editor.focus();
        },
        oneditsave: function() {
            $("#node-input-info").val(this.editor.getValue());
            this.editor.destroy();
            delete this.editor;
        },
        oneditcancel: function() {
            this.editor.destroy();
            delete this.editor;
        },
        oneditresize: function(size) {
            var rows = $("#dialog-form>div:not(.node-text-editor-row)");
            var height = $("#dialog-form").height();
            for (var i=0; i<rows.length; i++) {
                height -= $(rows[i]).outerHeight(true);
            }
            var editorRow = $("#dialog-form>div.node-text-editor-row");
            height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));
            $(".node-text-editor").css("height",height+"px");
            this.editor.resize();
        }
    });
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="comment">
    <p>A node you can use to add comments to your flows.</p>
    <h3>Details</h3>
    <p>The edit panel will accept Markdown syntax. The text will be rendered into
    the information side panel.</p>
</script>

<!-- --- [red-module:node-red/global-config] --- -->
<script type="text/html" data-template-name="global-config">
　　<div class="form-row">
        <label style="width: 100%"><span data-i18n="global-config.label.open-conf"></span>:</label>
    </div>
    <div class="form-row">
        <button class="red-ui-button" type="button" id="node-input-edit-env-var" data-i18n="editor:env-var.header" style="margin-left: 20px"></button>
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('global-config',{
        category: 'config',
        defaults: {
            name: { value: "" },
            env: { value: [] },
        },
        credentials: {
            map: { type: "map" }
        },
        oneditprepare: function() {
            $('#node-input-edit-env-var').on('click', function(evt) {
                RED.actions.invoke('core:show-user-settings', 'envvar')
            });
        },
        hasUsers: false
    });
</script>
<script type="text/html" data-help-name="global-config">
    <p>A node for holding global configuration of flows.</p>
</script>

<!-- --- [red-module:node-red/unknown] --- -->

<script type="text/html" data-template-name="unknown">
    <div class="form-tips"><span data-i18n="[html]unknown.tip"></span></div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('unknown',{
        category: 'unknown',
        color:"#fff0f0",
        defaults: {
            name: {value:""}
        },
        inputs:1,
        outputs:1,
        icon: "",
        label: function() {
            return "("+this.name+")"||this._("unknown.label.unknown");
        },
        labelStyle: function() {
            return "node_label_unknown";
        }
    });
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="unknown">
    <p>This node is a type unknown to your installation of Node-RED.</p>
    <h3>Details</h3>
    <p><i>If you deploy with the node in this state, its configuration will be preserved, but
    the flow will not start until the missing type is installed.</i></p>
    <p>Use the <code>Menu - Manage Palette</code> option
    to search for and install nodes, or <b>npm install &lt;module&gt;</b> to
    install, any missing modules and restart Node-RED and reimport the nodes.</p>
    <p>It is possible this node type is already installed, but is missing a dependency. Check the Node-RED start-up
    log for any error messages associated with the missing node type.</p>
    <p>Otherwise, you should contact the author of the flow to obtain a copy of the missing node type.</p>
</script>

<!-- --- [red-module:node-red/function] --- -->
<script type="text/html" data-template-name="function">
    <style>
        .func-tabs-row {
            margin-bottom: 0;
        }
        #node-input-libs-container-row .red-ui-editableList-container {
            padding: 0px;
        }
        #node-input-libs-container-row .red-ui-editableList-container li {
            padding:0px;
        }
        #node-input-libs-container-row .red-ui-editableList-item-remove {
            right: 5px;
        }

        #node-input-libs-container-row .red-ui-editableList-header {
            display: flex;
            background: var(--red-ui-tertiary-background);
            padding-right: 75px;
            border-top-left-radius: 3px;
            border-top-right-radius: 3px;
        }
        #node-input-libs-container-row .red-ui-editableList-header > div {
            flex-grow: 1;
        }

        .node-libs-entry {
            display: flex;
        }

        .node-libs-entry .red-ui-typedInput-container {
            border-radius: 0;
            border: none;
        }
        .node-libs-entry .red-ui-typedInput-type-select {
            border-radius: 0 !important;
            height: 34px;
        }
        .node-libs-entry > span > input[type=text] {
            border-radius: 0;
            border-top-color: var(--red-ui-form-background);
            border-bottom-color: var(--red-ui-form-background);
            border-right-color: var(--red-ui-form-background);
        }
        .node-libs-entry > span > input[type=text].input-error {
        }
        .node-libs-entry > span {
            flex-grow: 1;
            width: 50%;
            position: relative;
        }
        .node-libs-entry span .node-input-libs-var, .node-libs-entry span .red-ui-typedInput-container {
            width: 100%;
        }
        .node-libs-entry > span > span > i {
            display: none;
        }
        .node-libs-entry > span > span.input-error > i {
            display: inline;
        }

    </style>
    <input type="hidden" id="node-input-func">
    <input type="hidden" id="node-input-noerr">
    <input type="hidden" id="node-input-finalize">
    <input type="hidden" id="node-input-initialize">

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <div style="display: inline-block; width: calc(100% - 105px)"><input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name"></div>
    </div>


    <div class="form-row func-tabs-row">
        <ul style="min-width: 600px; margin-bottom: 20px;" id="func-tabs"></ul>
    </div>
    <div id="func-tabs-content" style="min-height: calc(100% - 95px);">

        <div id="func-tab-config" style="display:none">
            <div>
                <div class="form-row" style="display: inline-block; margin-right: 50px;">
                    <label for="node-input-outputs"><i class="fa fa-random"></i> <span data-i18n="function.label.outputs"></span></label>
                    <input id="node-input-outputs" style="width: 60px;" value="1">
                </div>
                <div class="form-row" style="display: inline-block;">
                    <label for="node-input-timeout"><i class="fa fa-clock-o"></i> <span data-i18n="function.label.timeout"></span></label>
                    <input id="node-input-timeout" style="width: 60px;" data-i18n="[placeholder]join.seconds">
                </div>
            </div>

            <div class="form-row node-input-libs-row hide" style="margin-bottom: 0px;">
                <label><i class="fa fa-cubes"></i> <span data-i18n="function.label.modules"></span></label>
            </div>
            <div class="form-row node-input-libs-row hide" id="node-input-libs-container-row">
                <ol id="node-input-libs-container"></ol>
            </div>
        </div>

        <div id="func-tab-init" style="display:none">
            <div class="form-row node-text-editor-row" style="position:relative">
                <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-init-editor" ></div>
                <div style="position: absolute; right:0; bottom: calc(100% - 20px); z-Index: 10;"><button type="button" id="node-init-expand-js" class="red-ui-button red-ui-button-small"><i class="fa fa-expand"></i></button></div>
            </div>
        </div>

        <div id="func-tab-body" style="display:none">
            <div class="form-row node-text-editor-row" style="position:relative">
                <div style="height: 220px; min-height:150px;" class="node-text-editor" id="node-input-func-editor" ></div>
                <div style="position: absolute; right:0; bottom: calc(100% - 20px); z-Index: 10;"><button type="button" id="node-function-expand-js" class="red-ui-button red-ui-button-small"><i class="fa fa-expand"></i></button></div>
            </div>
        </div>

        <div id="func-tab-finalize" style="display:none">
            <div class="form-row node-text-editor-row" style="position:relative">
                <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-finalize-editor" ></div>
                <div style="position: absolute; right:0; bottom: calc(100% - 20px); z-Index: 10;"><button type="button" id="node-finalize-expand-js" class="red-ui-button red-ui-button-small"><i class="fa fa-expand"></i></button></div>
            </div>
        </div>

    </div>
</script>

<script type="text/javascript">

(function() {

    var invalidModuleVNames = [
        'console',
        'util',
        'Buffer',
        'Date',
        'RED',
        'node',
        '__node__',
        'context',
        'flow',
        'global',
        'env',
        'setTimeout',
        'clearTimeout',
        'setInterval',
        'clearInterval',
        'promisify'
    ]

    var knownFunctionNodes = {};
    RED.events.on("nodes:add", function(n) {
        if (n.type === "function") {
            knownFunctionNodes[n.id] = n;
        }
    })
    RED.events.on("nodes:remove", function(n) {
        if (n.type === "function") {
            delete knownFunctionNodes[n.id];
        }
    })

    var missingModules = [];
    var missingModuleReasons = {};
    RED.events.on("runtime-state", function(event) {
        if (event.error === "missing-modules") {
            missingModules = event.modules.map(function(m) { missingModuleReasons[m.module] = m.error; return m.module });
            for (var id in knownFunctionNodes) {
                if (knownFunctionNodes.hasOwnProperty(id) && knownFunctionNodes[id].libs && knownFunctionNodes[id].libs.length > 0) {
                    RED.editor.validateNode(knownFunctionNodes[id])
                }
            }
        } else if (!event.text) {
            missingModuleReasons = {};
            missingModules = [];
            for (var id in knownFunctionNodes) {
                if (knownFunctionNodes.hasOwnProperty(id) && knownFunctionNodes[id].libs && knownFunctionNodes[id].libs.length > 0) {
                    RED.editor.validateNode(knownFunctionNodes[id])
                }
            }
        }
        RED.view.redraw();
    });

    var installAllowList = ['*'];
    var installDenyList = [];

    var modulesEnabled = true;
    if (RED.settings.get('externalModules.modules.allowInstall', true) === false) {
        modulesEnabled = false;
    }
    var settingsAllowList = RED.settings.get("externalModules.modules.allowList")
    var settingsDenyList = RED.settings.get("externalModules.modules.denyList")
    if (settingsAllowList || settingsDenyList) {
        installAllowList = settingsAllowList;
        installDenyList = settingsDenyList
    }
    installAllowList = RED.utils.parseModuleList(installAllowList);
    installDenyList = RED.utils.parseModuleList(installDenyList);


    // object that maps from library name to its descriptor
    var allLibs = [];

    function moduleName(module) {
        var match = /^([^@]+)@(.+)/.exec(module);
        if (match) {
            return [match[1], match[2]];
        }
        return [module, undefined];
    }

    function getAllUsedModules() {
        var moduleSet = new Set();
        for (var id in knownFunctionNodes) {
            if (knownFunctionNodes.hasOwnProperty(id)) {
                if (knownFunctionNodes[id].libs) {
                    for (var i=0, l=knownFunctionNodes[id].libs.length; i<l; i++) {
                        if (RED.utils.checkModuleAllowed(knownFunctionNodes[id].libs[i].module,null,installAllowList,installDenyList)) {
                            moduleSet.add(knownFunctionNodes[id].libs[i].module);
                        }
                    }
                }
            }
        }
        var modules = Array.from(moduleSet);
        modules.sort();
        return modules;
    }

    function prepareLibraryConfig(node) {
        $(".node-input-libs-row").show();
        var usedModules = getAllUsedModules();
        var typedModules = usedModules.map(function(l) {
            return {icon:"fa fa-cube", value:l,label:l,hasValue:false}
        })
        typedModules.push({
            value:"_custom_", label:RED._("editor:subflow.licenseOther"), icon:"red/images/typedInput/az.svg"
        })

        var libList = $("#node-input-libs-container").css('min-height','100px').css('min-width','450px').editableList({
            header: $('<div><div data-i18n="node-red:function.require.moduleName"></div><div data-i18n="node-red:function.require.importAs"></div></div>'),
            addItem: function(container,i,opt) {
                var parent = container.parent();
                var row0 = $("<div/>").addClass("node-libs-entry").appendTo(container);
                var fmoduleSpan = $("<span>").appendTo(row0);
                var fmodule = $("<input/>", {
                    class: "node-input-libs-val",
                    placeholder: RED._("node-red:function.require.module"),
                    type: "text"
                }).css({
                }).appendTo(fmoduleSpan).typedInput({
                    types: typedModules,
                    default: usedModules.indexOf(opt.module) > -1 ? opt.module : "_custom_"
                });
                if (usedModules.indexOf(opt.module) === -1) {
                    fmodule.typedInput('value', opt.module);
                }
                var moduleWarning = $('<span style="position: absolute;right:2px;top:7px; display:inline-block; width: 16px;"><i class="fa fa-warning"></i></span>').appendTo(fmoduleSpan);
                RED.popover.tooltip(moduleWarning.find("i"),function() {
                    var val = fmodule.typedInput("type");
                    if (val === "_custom_") {
                        val = fmodule.val();
                    }
                    var errors = [];

                    if (!RED.utils.checkModuleAllowed(val,null,installAllowList,installDenyList)) {
                        return RED._("node-red:function.error.moduleNotAllowed",{module:val});
                    } else {
                        return RED._("node-red:function.error.moduleLoadError",{module:val,error:missingModuleReasons[val]});
                    }
                })

                var fvarSpan = $("<span>").appendTo(row0);

                var fvar = $("<input/>", {
                    class: "node-input-libs-var red-ui-font-code",
                    placeholder: RED._("node-red:function.require.var"),
                    type: "text"
                }).css({
                }).appendTo(fvarSpan).val(opt.var);
                var vnameWarning = $('<span style="position: absolute; right:2px;top:7px;display:inline-block; width: 16px;"><i class="fa fa-warning"></i></span>').appendTo(fvarSpan);
                RED.popover.tooltip(vnameWarning.find("i"),function() {
                    var val = fvar.val();
                    if (invalidModuleVNames.indexOf(val) !== -1) {
                        return RED._("node-red:function.error.moduleNameReserved",{name:val})
                    } else {
                        return RED._("node-red:function.error.moduleNameError",{name:val})
                    }
                })



                fvar.on("change keyup paste", function (e) {
                    var v = $(this).val().trim();
                    if (v === "" || / /.test(v) || invalidModuleVNames.indexOf(v) !== -1) {
                        fvar.addClass("input-error");
                        vnameWarning.addClass("input-error");
                    } else {
                        fvar.removeClass("input-error");
                        vnameWarning.removeClass("input-error");
                    }
                });

                fmodule.on("change keyup paste", function (e) {
                    var val = $(this).typedInput("type");
                    if (val === "_custom_") {
                        val = $(this).val();
                    }
                    var varName = val.trim().replace(/^@/,"").replace(/@.*$/,"").replace(/[-_/\.].?/g, function(v) { return v[1]?v[1].toUpperCase():"" });
                    fvar.val(varName);
                    fvar.trigger("change");

                    if (RED.utils.checkModuleAllowed(val,null,installAllowList,installDenyList) && (missingModules.indexOf(val) === -1)) {
                        fmodule.removeClass("input-error");
                        moduleWarning.removeClass("input-error");
                    } else {
                        fmodule.addClass("input-error");
                        moduleWarning.addClass("input-error");
                    }
                });
                if (RED.utils.checkModuleAllowed(opt.module,null,installAllowList,installDenyList) && (missingModules.indexOf(opt.module) === -1)) {
                    fmodule.removeClass("input-error");
                    moduleWarning.removeClass("input-error");
                } else {
                    fmodule.addClass("input-error");
                    moduleWarning.addClass("input-error");
                }
                if (opt.var) {
                    fvar.trigger("change");
                }
            },
            removable: true
        });

        var libs = node.libs || [];
        for (var i=0,l=libs.length;i<l; i++) {
            libList.editableList('addItem',libs[i])
        }

    }

    function getLibsList() {
        var _libs = [];
        if (RED.settings.functionExternalModules !== false) {
            var libs = $("#node-input-libs-container").editableList("items");
            libs.each(function(i) {
                var item = $(this);
                var v = item.find(".node-input-libs-var").val();
                var n = item.find(".node-input-libs-val").typedInput("type");
                if (n === "_custom_") {
                    n = item.find(".node-input-libs-val").val();
                }
                if ((!v || (v === "")) ||
                    (!n || (n === ""))) {
                    return;
                }
                _libs.push({
                    var: v,
                    module: n
                });
            });
        }
        return _libs;
    }

    RED.nodes.registerType('function',{
        color:"#fdd0a2",
        category: 'function',
        defaults: {
            name: {value:"_DEFAULT_"},
            func: {value:"\nreturn msg;"},
            outputs: {value:1},
            timeout:{value:RED.settings.functionTimeout || 0},
            noerr: {value:0,required:true,
                    validate: function(v, opt) {
                        if (!v) {
                            return true;
                        }
                        return RED._("node-red:function.error.invalid-js");
                    }},
            initialize: {value:""},
            finalize: {value:""},
            libs: {value: [], validate: function(v, opt) {
                if (!v) { return true; }
                for (var i=0,l=v.length;i<l;i++) {
                    var m = v[i];
                    if (!RED.utils.checkModuleAllowed(m.module,null,installAllowList,installDenyList)) {
                        return RED._("node-red:function.error.moduleNotAllowed", {
                            module: m.module
                        });
                    }
                    if (m.var === "" || / /.test(m.var)) {
                        return RED._("node-red:function.error.moduleNameError", {
                            name: m.var
                        });
                    }
                    if (missingModules.indexOf(m.module) > -1) {
                        return RED._("node-red:function.error.missing-module", {
                            module: m.module
                        });
                    }
                    if (invalidModuleVNames.indexOf(m.var) !== -1){
                        return RED._("node-red:function.error.moduleNameError", {
                            name: m.var
                        });
                    }
                }
                return true;
            }}
        },
        inputs:1,
        outputs:1,
        icon: "function.svg",
        label: function() {
            return this.name||this._("function.function");
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            var that = this;

            var tabs = RED.tabs.create({
                id: "func-tabs",
                onchange: function(tab) {
                    $("#func-tabs-content").children().hide();
                    $("#" + tab.id).show();
                    let editor = $("#" + tab.id).find('.monaco-editor').first();
                    if(editor.length) {
                        if(that.editor.nodered && that.editor.type == "monaco") {
                            that.editor.nodered.refreshModuleLibs(getLibsList());
                        }
                        RED.tray.resize();
                        //auto focus editor on tab switch
                        if (that.initEditor.getDomNode() == editor[0]) {
                            that.initEditor.focus();
                        } else if (that.editor.getDomNode() == editor[0]) {
                            that.editor.focus();
                        } else if (that.finalizeEditor.getDomNode() == editor[0]) {
                            that.finalizeEditor.focus();
                        }
                    }
                }
            });
            tabs.addTab({
                id: "func-tab-config",
                iconClass: "fa fa-cog",
                label: that._("function.label.setup")
            });

            tabs.addTab({
                id: "func-tab-init",
                label: that._("function.label.initialize")
            });
            tabs.addTab({
                id: "func-tab-body",
                label: that._("function.label.function")
            });
            tabs.addTab({
                id: "func-tab-finalize",
                label: that._("function.label.finalize")
            });

            tabs.activateTab("func-tab-body");

            $( "#node-input-outputs" ).spinner({
                min: 0,
                max: 500,
                change: function(event, ui) {
                    var value = parseInt(this.value);
                    value = isNaN(value) ? 1 : value;
                    value = Math.max(value, parseInt($(this).attr("aria-valuemin")));
                    value = Math.min(value, parseInt($(this).attr("aria-valuemax")));
                    if (value !== this.value) { $(this).spinner("value", value); }
                }
            });

            // 4294967 is max in node.js timeout.
            $( "#node-input-timeout" ).spinner({
                min: 0,
                max: 4294967,
                change: function(event, ui) {
                    var value = this.value;
                    if(value == ""){
                        value = 0;
                    }
                    else
                    {
                        value = parseInt(value);
                    }
                    value = isNaN(value) ? 1 : value;
                    value = Math.max(value, parseInt($(this).attr("aria-valuemin")));
                    value = Math.min(value, parseInt($(this).attr("aria-valuemax")));
                    if (value !== this.value) { $(this).spinner("value", value); }
                }
            });

            var buildEditor = function(id, stateId, focus, value, defaultValue, extraLibs, offset) {
                var editor = RED.editor.createEditor({
                    id: id,
                    mode: 'ace/mode/nrjavascript',
                    value: value || defaultValue || "",
                    stateId: stateId,
                    focus: true,
                    globals: {
                        msg:true,
                        context:true,
                        RED: true,
                        util: true,
                        flow: true,
                        global: true,
                        console: true,
                        Buffer: true,
                        setTimeout: true,
                        clearTimeout: true,
                        setInterval: true,
                        clearInterval: true
                    },
                    extraLibs: extraLibs
                });
                if (defaultValue && value === "") {
                    editor.moveCursorTo(defaultValue.split("\n").length +offset, 0);
                }
                editor.__stateId = stateId;
                return editor;
            }
            this.initEditor = buildEditor('node-input-init-editor', this.id + "/" + "initEditor", false, $("#node-input-initialize").val(), RED._("node-red:function.text.initialize"), undefined, 0);
            this.editor = buildEditor('node-input-func-editor', this.id + "/" + "editor", true, $("#node-input-func").val(), undefined, that.libs || [], undefined, -1);
            this.finalizeEditor = buildEditor('node-input-finalize-editor', this.id + "/" + "finalizeEditor", false, $("#node-input-finalize").val(), RED._("node-red:function.text.finalize"), undefined, 0);

            RED.library.create({
                url:"functions", // where to get the data from
                type:"function", // the type of object the library is for
                editor:this.editor, // the field name the main text body goes to
                mode:"ace/mode/nrjavascript",
                fields:[
                    'name', 'outputs', 'timeout',
                    {
                        name: 'initialize',
                        get: function() {
                            return that.initEditor.getValue();
                        },
                        set: function(v) {
                            that.initEditor.setValue(v||RED._("node-red:function.text.initialize"), -1);
                        }
                    },
                    {
                        name: 'finalize',
                        get: function() {
                            return that.finalizeEditor.getValue();
                        },
                        set: function(v) {
                            that.finalizeEditor.setValue(v||RED._("node-red:function.text.finalize"), -1);
                        }
                    },
                    {
                        name: 'info',
                        get: function() {
                            return that.infoEditor.getValue();
                        },
                        set: function(v) {
                            that.infoEditor.setValue(v||"", -1);
                        }
                    }
                ],
                ext:"js"
            });

            var expandButtonClickHandler = function(editor) {
                return function (e) {
                    e.preventDefault();
                    var value = editor.getValue();
                    editor.saveView(`inside function-expandButtonClickHandler ${editor.__stateId}`);
                    var extraLibs = that.libs || [];
                    RED.editor.editJavaScript({
                        value: value,
                        width: "Infinity",
                        stateId: editor.__stateId,
                        mode: "ace/mode/nrjavascript",
                        focus: true,
                        cancel: function () {
                            setTimeout(function () {
                                editor.focus();
                            }, 250);
                        },
                        complete: function (v, cursor) {
                            editor.setValue(v, -1);
                            setTimeout(function () {
                                editor.restoreView();
                                editor.focus();
                            }, 250);
                        },
                        extraLibs: extraLibs
                    });
                }
            }
            $("#node-init-expand-js").on("click", expandButtonClickHandler(this.initEditor));
            $("#node-function-expand-js").on("click", expandButtonClickHandler(this.editor));
            $("#node-finalize-expand-js").on("click", expandButtonClickHandler(this.finalizeEditor));

            RED.popover.tooltip($("#node-init-expand-js"), RED._("node-red:common.label.expand"));
            RED.popover.tooltip($("#node-function-expand-js"), RED._("node-red:common.label.expand"));
            RED.popover.tooltip($("#node-finalize-expand-js"), RED._("node-red:common.label.expand"));

            if (RED.settings.functionExternalModules !== false) {
                prepareLibraryConfig(that);
            }
        },
        oneditsave: function() {
            var node = this;
            var noerr = 0;
            $("#node-input-noerr").val(0);

            var disposeEditor = function(editorName,targetName,defaultValue) {
                var editor = node[editorName];
                var annot = editor.getSession().getAnnotations();
                for (var k=0; k < annot.length; k++) {
                    if (annot[k].type === "error") {
                        noerr += annot.length;
                        break;
                    }
                }
                var val = editor.getValue();
                if (defaultValue) {
                    if (val.trim() == defaultValue.trim()) {
                        val = "";
                    }
                }
                editor.destroy();
                delete node[editorName];
                $("#"+targetName).val(val);
            }
            disposeEditor("editor","node-input-func");
            disposeEditor("initEditor","node-input-initialize", RED._("node-red:function.text.initialize"));
            disposeEditor("finalizeEditor","node-input-finalize", RED._("node-red:function.text.finalize"));

            $("#node-input-noerr").val(noerr);
            this.noerr = noerr;
            node.libs = getLibsList();
        },
        oneditcancel: function() {
            var node = this;

            node.editor.destroy();
            delete node.editor;

            node.initEditor.destroy();
            delete node.initEditor;

            node.finalizeEditor.destroy();
            delete node.finalizeEditor;
        },
        oneditresize: function(size) {
            var rows = $("#dialog-form>div:not(.node-text-editor-row)");
            var height = $("#dialog-form").height();
            for (var i=0; i<rows.length; i++) {
                height -= $(rows[i]).outerHeight(true);
            }
            var editorRow = $("#dialog-form>div.node-text-editor-row");
            height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));
            $("#dialog-form .node-text-editor").css("height",height+"px");

            var height = size.height;
            $("#node-input-init-editor").css("height", (height - 83)+"px");
            $("#node-input-func-editor").css("height", (height - 83)+"px");
            $("#node-input-finalize-editor").css("height", (height - 83)+"px");

            this.initEditor.resize();
            this.editor.resize();
            this.finalizeEditor.resize();

            $("#node-input-libs-container").css("height", (height - 192)+"px");
        },
        onadd: function() {
            if (this.name === '_DEFAULT_') {
                this.name = ''
                RED.actions.invoke("core:generate-node-names", this, {generateHistory: false})
            }
        }
    });
})();
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="function">
    <p>A JavaScript function to run against the messages being received by the node.</p>
    <p>The messages are passed in as a JavaScript object called <code>msg</code>.</p>
    <p>By convention it will have a <code>msg.payload</code> property containing
       the body of the message.</p>
    <p>The function is expected to return a message object (or multiple message objects), but can choose
       to return nothing in order to halt a flow.</p>
    <p>The <b>On Start</b> tab contains code that will be run whenever the node is started.
        The <b>On Stop</b> tab contains code that will be run when the node is stopped.</p>
    <p>If the On Start code returns a Promise object, the node will not start handling messages
        until the promise is resolved.</p>
    <h3>Details</h3>
    <p>See the <a target="_blank" href="https://nodered.org/docs/writing-functions.html">online documentation</a>
    for more information on writing functions.</p>
    <h4>Sending messages</h4>
    <p>The function can either return the messages it wants to pass on to the next nodes
    in the flow, or can call <code>node.send(messages)</code>.</p>
    <p>It can return/send:</p>
    <ul>
      <li>a single message object - passed to nodes connected to the first output</li>
      <li>an array of message objects - passed to nodes connected to the corresponding outputs</li>
    </ul>
    <p>Note: The setup code is executed during the initialization of nodes. Therefore, if <code>node.send</code> is called in the setup tab, subsequent nodes may not be able to receive the message.</p>
    <p>If any element of the array is itself an array of messages, multiple
          messages are sent to the corresponding output.</p>
    <p>If null is returned, either by itself or as an element of the array, no
          message is passed on.</p>
    <h4>Logging and Error Handling</h4>
    <p>To log any information, or report an error, the following functions are available:</p>
      <ul>
          <li><code>node.log("Log message")</code></li>
          <li><code>node.warn("Warning")</code></li>
          <li><code>node.error("Error")</code></li>
      </ul>
    </p>
    <p>The Catch node can also be used to handle errors. To invoke a Catch node,
    pass <code>msg</code> as a second argument to <code>node.error</code>:</p>
    <pre>node.error("Error",msg);</pre>
    <h4>Accessing Node Information</h4>
    <p>The following properties are available to access information about the node:</p>
    <ul>
        <li><code>node.id</code> - id of the node</li>
        <li><code>node.name</code> - name of the node</li>
        <li><code>node.outputCount</code> - number of node outputs</li>
    </ul>
    <h4>Using environment variables</h4>
    <p>Environment variables can be accessed using <code>env.get("MY_ENV_VAR")</code>.</p>
</script>

<!-- --- [red-module:node-red/switch] --- -->
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-template-name="switch">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" style="width: calc(100% - 105px)" data-i18n="[placeholder]common.label.name">
    </div>
    <div class="form-row">
        <label for="node-input-property"><i class="fa fa-ellipsis-h"></i> <span data-i18n="switch.label.property"></span></label>
        <input type="text" id="node-input-property" style="width: calc(100% - 105px)"/>
        <input type="hidden" id="node-input-outputs"/>
    </div>
    <div class="form-row node-input-rule-container-row">
        <ol id="node-input-rule-container"></ol>
    </div>
    <div class="form-row">
        <select id="node-input-checkall" style="width:100%; margin-right:5px;">
            <option value="true" data-i18n="switch.checkall"></option>
            <option value="false" data-i18n="switch.stopfirst"></option>
        </select>
    </div>
    <div class="form-row">
        <input type="checkbox" id="node-input-repair" style="display: inline-block; width: auto; vertical-align: top;">
        <label style="width: auto;" for="node-input-repair"><span data-i18n="switch.label.repair"></span></label></input>
    </div>
</script>

<script type="text/javascript">
(function() {
    var operators = [
        {v:"eq",t:"==",kind:'V'},
        {v:"neq",t:"!=",kind:'V'},
        {v:"lt",t:"<",kind:'V'},
        {v:"lte",t:"<=",kind:'V'},
        {v:"gt",t:">",kind:'V'},
        {v:"gte",t:">=",kind:'V'},
        {v:"hask",t:"switch.rules.hask",kind:'V'},
        {v:"btwn",t:"switch.rules.btwn",kind:'V'},
        {v:"cont",t:"switch.rules.cont",kind:'V'},
        {v:"regex",t:"switch.rules.regex",kind:'V'},
        {v:"true",t:"switch.rules.true",kind:'V'},
        {v:"false",t:"switch.rules.false",kind:'V'},
        {v:"null",t:"switch.rules.null",kind:'V'},
        {v:"nnull",t:"switch.rules.nnull",kind:'V'},
        {v:"istype",t:"switch.rules.istype",kind:'V'},
        {v:"empty",t:"switch.rules.empty",kind:'V'},
        {v:"nempty",t:"switch.rules.nempty",kind:'V'},
        {v:"head",t:"switch.rules.head",kind:'S'},
        {v:"index",t:"switch.rules.index",kind:'S'},
        {v:"tail",t:"switch.rules.tail",kind:'S'},
        {v:"jsonata_exp",t:"switch.rules.exp",kind:'O'},
        {v:"else",t:"switch.rules.else",kind:'O'}
    ];

    var previousValueType = {value:"prev",label:RED._("node-red:switch.previous"),hasValue:false};
    function clipValueLength(v) {
        if (v.length > 15) {
            return v.substring(0,15)+"...";
        }
        return v;
    }
    function prop2name(key) {
        var result = RED.utils.parseContextKey(key);
        return result.key;
    }
    function getValueLabel(t,v) {
        if (t === 'str') {
            return '"'+clipValueLength(v)+'"';
        } else if (t === 'msg') {
            return t+"."+clipValueLength(v);
        } else if (t === 'flow' || t === 'global') {
            return t+"."+clipValueLength(prop2name(v));
        }
        return clipValueLength(v);
    }

    function exportRule(rule) {
        var type = rule.find("select").val();
        var r = {t:type};
        if (!(type === "true" || type === "false" || type === "null" || type === "nnull" || type === "empty" || type === "nempty" || type === "else")) {
            if ((type === "btwn") || (type === "index")) {
                r.v = rule.find(".node-input-rule-btwn-value").typedInput('value');
                r.vt = rule.find(".node-input-rule-btwn-value").typedInput('type');
                r.v2 = rule.find(".node-input-rule-btwn-value2").typedInput('value');
                r.v2t = rule.find(".node-input-rule-btwn-value2").typedInput('type');
            } else if ((type === "head") || (type === "tail")) {
                r.v = rule.find(".node-input-rule-num-value").typedInput('value');
                r.vt = rule.find(".node-input-rule-num-value").typedInput('type');
            } else if (type === "istype") {
                r.v = rule.find(".node-input-rule-type-value").typedInput('type');
                r.vt = rule.find(".node-input-rule-type-value").typedInput('type');
            } else if (type === "jsonata_exp") {
                r.v = rule.find(".node-input-rule-exp-value").typedInput('value');
                r.vt = rule.find(".node-input-rule-exp-value").typedInput('type');
            } else {
                r.v = rule.find(".node-input-rule-value").typedInput('value');
                r.vt = rule.find(".node-input-rule-value").typedInput('type');
            }
            if (type === "regex") {
                r.case = rule.find(".node-input-rule-case").prop("checked");
            }
        }
        return r;
    }

    function createValueField(row, defaultType){
        return $('<input/>',{class:"node-input-rule-value",type:"text",style:"width: 100%;"}).appendTo(row)
            .typedInput({default:defaultType||'str',types:['msg','flow','global','str','num','jsonata','env',previousValueType]});
    }

    function createNumValueField(row, defaultType){
        return $('<input/>',{class:"node-input-rule-num-value",type:"text",style:"width: 100%;"}).appendTo(row)
            .typedInput({default:defaultType||'num',types:['flow','global','num','jsonata','env']});
    }

    function createExpValueField(row){
        return $('<input/>',{class:"node-input-rule-exp-value",type:"text",style:"width: 100%;"}).appendTo(row)
            .typedInput({default:'jsonata',types:['jsonata']});
    }

    function createBtwnValueField(row, defaultType){
        return $('<input/>',{class:"node-input-rule-btwn-value",type:"text",style:"width: 100%;"}).appendTo(row)
                .typedInput({default:defaultType||'num',types:['msg','flow','global','str','num','jsonata','env',previousValueType]});
    }

    function createBtwnValue2Field(row3, andLabel, defaultType){
        $('<div/>',{class:"node-input-rule-btwn-label", style:"width: 120px; text-align: right;"}).text(" "+andLabel+" ").appendTo(row3);
        var row3InputCell = $('<div/>',{style:"flex-grow:1; margin-left: 5px;"}).appendTo(row3);
        return $('<input/>',{class:"node-input-rule-btwn-value2",type:"text",style:"width: 100%"}).appendTo(row3InputCell)
            .typedInput({default:defaultType||'num',types:['msg','flow','global','str','num','jsonata','env',previousValueType]});
    }

    function createTypeValueField(row, defaultType){
        return $('<input/>',{class:"node-input-rule-type-value",type:"text",style:"width: 100%;"}).appendTo(row).typedInput({default:defaultType || 'string',types:[
            {value:"string",label:RED._("common.type.string"),hasValue:false,icon:"red/images/typedInput/az.svg"},
            {value:"number",label:RED._("common.type.number"),hasValue:false,icon:"red/images/typedInput/09.svg"},
            {value:"boolean",label:RED._("common.type.boolean"),hasValue:false,icon:"red/images/typedInput/bool.svg"},
            {value:"array",label:RED._("common.type.array"),hasValue:false,icon:"red/images/typedInput/json.svg"},
            {value:"buffer",label:RED._("common.type.buffer"),hasValue:false,icon:"red/images/typedInput/bin.svg"},
            {value:"object",label:RED._("common.type.object"),hasValue:false,icon:"red/images/typedInput/json.svg"},
            {value:"json",label:RED._("common.type.jsonString"),hasValue:false,icon:"red/images/typedInput/json.svg"},
            {value:"undefined",label:RED._("common.type.undefined"),hasValue:false},
            {value:"null",label:RED._("common.type.null"),hasValue:false}
        ]});
    }

    RED.nodes.registerType('switch', {
        color: "#E2D96E",
        category: 'function',
        defaults: {
            name: {value:""},
            property: {value:"payload", required:true,
                       label:RED._("node-red:common.label.payload"),
                       validate: RED.validators.typedInput("propertyType", false)},
            propertyType: { value:"msg" },
            rules: {
                value:[{t:"eq", v:"", vt:"str"}],
                validate: function (rules, opt) {
                    let msg;
                    const errors = []
                    if (!rules || rules.length === 0) { return true }
                    for (var i=0;i<rules.length;i++) {
                        const opt = { label: RED._('node-red:switch.label.rule')+' '+(i+1) }
                        const r = rules[i];
                        if (r.t !== 'istype') {
                            if (r.hasOwnProperty('v')) {
                                if ((msg = RED.utils.validateTypedProperty(r.v,r.vt,opt)) !== true) {
                                    errors.push(msg)
                                }
                            }
                            if (r.hasOwnProperty('v2')) {
                                if ((msg = RED.utils.validateTypedProperty(r.v2,r.v2t,opt)) !== true) {
                                    errors.push(msg)
                                }
                            }
                        }
                    }
                    if (errors.length) {
                        console.log(errors)
                        return errors
                    }
                    return true;
                }
            },
            checkall: {value:"true", required:true},
            repair: {value:false},
            outputs: {value:1}
        },
        inputs: 1,
        outputs: 1,
        outputLabels: function(index) {
            var rule = this.rules[index];
            var label = "";
            if (rule) {
                for (var i=0;i<operators.length;i++) {
                    if (operators[i].v === rule.t) {
                        label = /^switch/.test(operators[i].t)?this._(operators[i].t):operators[i].t;
                        break;
                    }
                }
                if ((rule.t === 'btwn') || (rule.t === 'index')) {
                    label += " "+getValueLabel(rule.vt,rule.v)+" & "+getValueLabel(rule.v2t,rule.v2);
                } else if (rule.t !== 'true' && rule.t !== 'false' && rule.t !== 'null' && rule.t !== 'nnull' && rule.t !== 'empty' && rule.t !== 'nempty' && rule.t !== 'else' ) {
                    label += " "+getValueLabel(rule.vt,rule.v);
                }
                return label;
            }
        },
        icon: "switch.svg",
        label: function() {
            return this.name||this._("switch.switch");
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            var node = this;


            $("#node-input-property").typedInput({default:this.propertyType||'msg',types:['msg','flow','global','jsonata','env']});
            var outputCount = $("#node-input-outputs").val("{}");

            var andLabel = this._("switch.and");
            var caseLabel = this._("switch.ignorecase");

            $("#node-input-rule-container").css('min-height','150px').css('min-width','450px').editableList({
                addItem: function(container,i,opt) {
                    var focusValueField = false;
                    if (!opt.hasOwnProperty('r')) {
                        opt.r = {};
                        if (i > 0) {
                            var lastRule = $("#node-input-rule-container").editableList('getItemAt',i-1);
                            var exportedRule = exportRule(lastRule.element);
                            if (exportedRule.t === "istype") {
                                opt.r.vt = (exportedRule.vt === "number") ? "num" : "str";
                            } else {
                                opt.r.vt = exportedRule.vt;
                            }
                            opt.r.v = "";
                            // We could copy the value over as well and preselect it (see the 'activeElement' code below)
                            // But not sure that feels right. Is copying over the last value 'expected' behaviour?
                            // It would make sense for an explicit 'copy' action, but not sure where the copy button would
                            // go for each rule without being wasted space for most users.
                            // opt.r.v = exportedRule.v;
                            focusValueField = true;
                        }
                    }

                    opt.element = container;
                    var rule = opt.r;
                    if (!rule.hasOwnProperty('t')) {
                        rule.t = 'eq';
                    }
                    if (!opt.hasOwnProperty('i')) {
                        opt._i = Math.floor((0x99999-0x10000)*Math.random()).toString();
                    }
                    container.css({
                        overflow: 'hidden',
                        whiteSpace: 'nowrap',
                        display: "flex",
                        "align-items":"center"
                    });
                    var inputRows = $('<div></div>',{style:"flex-grow:1"}).appendTo(container);
                    var row = $('<div></div>',{style:"display: flex;"}).appendTo(inputRows);
                    var row2 = $('<div/>',{style:"display: flex; padding-top: 5px; padding-left: 175px;"}).appendTo(inputRows);
                    var row3 = $('<div/>',{style:"display: flex; padding-top: 5px; align-items: center"}).appendTo(inputRows);

                    var row4 = $('<div/>',{style:"visibility: hidden; height: 0px;"}).appendTo(inputRows);
                    var textSpan = $("<span/>").appendTo(row4);
                    var selectField = $('<select/>',{style:"width:120px; text-align: center;"}).appendTo(row);
                    var group0 = $('<optgroup/>', { label: RED._("node-red:switch.label.value-rules") }).appendTo(selectField);
                    for (var d in operators) {
                        if(operators[d].kind === 'V') {
                            group0.append($("<option></option>").val(operators[d].v).text(/^switch/.test(operators[d].t)?node._(operators[d].t):operators[d].t));
                        }
                    }
                    var group1 = $('<optgroup/>', { label: RED._("node-red:switch.label.sequence-rules") }).appendTo(selectField);
                    for (var d in operators) {
                        if(operators[d].kind === 'S') {
                            group1.append($("<option></option>").val(operators[d].v).text(/^switch/.test(operators[d].t)?node._(operators[d].t):operators[d].t));
                        }
                    }
                    for (var d in operators) {
                        if(operators[d].kind === 'O') {
                            selectField.append($("<option></option>").val(operators[d].v).text(/^switch/.test(operators[d].t)?node._(operators[d].t):operators[d].t));
                        }
                    }

                    var rowInputCell = $('<div>',{style:"flex-grow:1; margin-left: 5px;"}).appendTo(row);


                    var valueField = null;
                    var numValueField = null;
                    var expValueField = null;
                    var btwnAndLabel = null;
                    var btwnValueField = null;
                    var btwnValue2Field = null;
                    var typeValueField = null;

                    var finalspan = $('<span/>',{style:"margin-left: 5px;"}).appendTo(container);
                    finalspan.append(' &#8594; <span class="node-input-rule-index">'+(i+1)+'</span> ');

                    var caseSensitive = $('<input/>',{id:"node-input-rule-case-"+i,class:"node-input-rule-case",type:"checkbox",style:"width:auto;vertical-align:top"}).appendTo(row2);
                    $('<label/>',{for:"node-input-rule-case-"+i,style:"margin-left: 3px;"}).text(caseLabel).appendTo(row2);

                    selectField.on("change", function() {
                        var fieldToFocus;
                        var type = selectField.val();
                        if (valueField) { valueField.typedInput('hide'); }
                        if (expValueField) { expValueField.typedInput('hide'); }
                        if (numValueField) { numValueField.typedInput('hide'); }
                        if (typeValueField) { typeValueField.typedInput('hide'); }
                        if (btwnValueField) { btwnValueField.typedInput('hide'); }
                        if (btwnValue2Field) { btwnValue2Field.typedInput('hide'); }

                        if ((type === "btwn") || (type === "index")) {
                            if (!btwnValueField){
                                btwnValueField = createBtwnValueField(rowInputCell);
                            }
                            btwnValueField.typedInput('show');
                            fieldToFocus = btwnValueField;
                        } else if ((type === "head") || (type === "tail")) {
                            if (!numValueField){
                                numValueField = createNumValueField(rowInputCell);
                            }
                            numValueField.typedInput('show');
                            fieldToFocus = numValueField;
                        } else if (type === "jsonata_exp") {
                            if (!expValueField){
                                expValueField = createExpValueField(rowInputCell);
                            }
                            expValueField.typedInput('show');
                            fieldToFocus = expValueField;

                        } else if (type === "istype") {
                            if (!typeValueField){
                                typeValueField = createTypeValueField(rowInputCell);
                            }
                            typeValueField.typedInput('show');
                            fieldToFocus = typeValueField;
                        } else if (! (type === "true" || type === "false" || type === "null" || type === "nnull" || type === "empty" || type === "nempty" || type === "else" )) {
                                if (!valueField){
                                    valueField = createValueField(rowInputCell);
                                }
                                valueField.typedInput('show');
                                fieldToFocus = valueField;
                        }
                        if (type === "regex") {
                            row2.show();
                            row3.hide();
                        } else if ((type === "btwn") || (type === "index")) {
                            row2.hide();
                            row3.show();
                            if (!btwnValue2Field){
                                btwnValue2Field = createBtwnValue2Field(row3, andLabel);
                            }
                            btwnValue2Field.typedInput('show');
                        } else {
                            row2.hide();
                            row3.hide();
                        }
                        var selectedLabel = selectField.find("option:selected").text();

                        textSpan.text(selectedLabel);
                        var width = textSpan.width();
                        if (width <= 30) {
                            selectField.outerWidth(60);
                        } else if (width <= 85) {
                            selectField.outerWidth(120);
                        } else {
                            selectField.width("auto")
                        }
                        if (fieldToFocus) {
                            fieldToFocus.typedInput("focus");
                        }
                        // Preselect the contents of the element
                        // if (focusValueField && document.activeElement) {
                        //     document.activeElement.selectionStart = 0;
                        //     document.activeElement.selectionEnd = document.activeElement.value.length;
                        // }
                    });
                    selectField.val(rule.t);

                    if ((rule.t == "btwn") || (rule.t == "index")) {
                        btwnValueField = createBtwnValueField(rowInputCell,rule.vt||'num');
                        btwnValueField.typedInput('value',rule.v);
                        btwnValue2Field = createBtwnValue2Field(row3, andLabel,rule.v2t||'num');
                        btwnValue2Field.typedInput('value',rule.v2);
                    } else if ((rule.t === "head") || (rule.t === "tail")) {
                        numValueField = createNumValueField(rowInputCell,rule.vt||'num');
                        numValueField.typedInput('value',rule.v);
                    } else if (rule.t === "istype") {
                        typeValueField = createTypeValueField(rowInputCell,rule.vt);
                        typeValueField.typedInput('value',rule.vt);
                    } else if (rule.t === "jsonata_exp") {
                        expValueField = createExpValueField(rowInputCell,rule.vt||'jsonata');
                        expValueField.typedInput('value',rule.v);
                    } else if (typeof rule.v != "undefined") {
                        valueField = createValueField(rowInputCell,rule.vt||'str');
                        valueField.typedInput('value',rule.v);
                    }
                    caseSensitive.prop('checked',!!rule.case);
                    selectField.change();

                    var currentOutputs = JSON.parse(outputCount.val()||"{}");
                    currentOutputs[opt.hasOwnProperty('i')?opt.i:opt._i] = i;
                    outputCount.val(JSON.stringify(currentOutputs));
                },
                removeItem: function(opt) {
                    var currentOutputs = JSON.parse(outputCount.val()||"{}");
                    if (opt.hasOwnProperty('i')) {
                        currentOutputs[opt.i] = -1;
                    } else {
                        delete currentOutputs[opt._i];
                    }
                    var rules = $("#node-input-rule-container").editableList('items');
                    rules.each(function(i) {
                        $(this).find(".node-input-rule-index").html(i+1);
                        var data = $(this).data('data');
                        currentOutputs[data.hasOwnProperty('i')?data.i:data._i] = i;
                    });
                    outputCount.val(JSON.stringify(currentOutputs));
                },
                sortItems: function(rules) {
                    var currentOutputs = JSON.parse(outputCount.val()||"{}");
                    var rules = $("#node-input-rule-container").editableList('items');
                    rules.each(function(i) {
                        $(this).find(".node-input-rule-index").html(i+1);
                        var data = $(this).data('data');
                        currentOutputs[data.hasOwnProperty('i')?data.i:data._i] = i;
                    });
                    outputCount.val(JSON.stringify(currentOutputs));
                },
                sortable: true,
                removable: true
            });

            for (var i=0;i<this.rules.length;i++) {
                var rule = this.rules[i];
                $("#node-input-rule-container").editableList('addItem',{r:rule,i:i});
            }
        },
        oneditsave: function() {
            var rules = $("#node-input-rule-container").editableList('items');
            var node = this;
            node.rules = [];
            rules.each(function(i) {
                node.rules.push(exportRule($(this)));
            });
            this.propertyType = $("#node-input-property").typedInput('type');
        },
        oneditresize: function(size) {
            var rows = $("#dialog-form>div:not(.node-input-rule-container-row)");
            var height = size.height;
            for (var i=0;i<rows.length;i++) {
                height -= $(rows[i]).outerHeight(true);
            }
            var editorRow = $("#dialog-form>div.node-input-rule-container-row");
            height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));
            height += 16;
            $("#node-input-rule-container").editableList('height',height);
        }
    });
})();
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="switch">
    <p>Route messages based on their property values or sequence position.</p>
    <h3>Details</h3>
    <p>When a message arrives, the node will evaluate each of the defined rules
    and forward the message to the corresponding outputs of any matching rules.</p>
    <p>Optionally, the node can be set to stop evaluating rules once it finds one
    that matches.</p>
    <p>The rules can be evaluated against an individual message property, a flow or global
    context property, environment variable or the result of a JSONata expression.</p>
    <h4>Rules</h4>
    <p>There are four types of rule:</p>
    <ol>
        <li><b>Value</b> rules are evaluated against the configured property</li>
        <li><b>Sequence</b> rules can be used on message sequences, such as those
            generated by the Split node</li>
        <li>A JSONata <b>Expression</b> can be provided that will be evaluated
            against the whole message and will match if the expression returns
            a true value.</li>
        <li>An <b>Otherwise</b> rule can be used to match if none of the preceeding
            rules have matched.</li>
    </ol>
    <h4>Notes</h4>
    <p>The <code>is true/false</code> and <code>is null</code> rules perform strict
       comparisons against those types. They do not convert between types.</p>
    <p>The <code>is empty</code> and <code>is not empty</code> rules can be used to test the length of Strings, Arrays and Buffers, or the number of properties an Object has. Neither rule will pass if the property being tested has a <code>boolean</code>, <code>null</code> 
       or <code>undefined</code> value.</p>
    <h4>Handling message sequences</h4>
    <p>By default, the node does not modify the <code>msg.parts</code> property of messages
       that are part of a sequence.</p>
    <p>The <b>recreate message sequences</b> option can be enabled to generate new message sequences
       for each rule that matches. In this mode, the node will buffer the entire incoming
       sequence before sending the new sequences on. The runtime setting <code>nodeMessageBufferMaxLength</code>
       can be used to limit how many messages nodes will buffer.</p>
</script>

<!-- --- [red-module:node-red/change] --- -->

<script type="text/html" data-template-name="change">
    <style>
        ol#node-input-rule-container .red-ui-typedInput-container {
            flex:1;
        }
    </style>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" style="width: calc(100% - 105px)"  data-i18n="[placeholder]common.label.name">
    </div>
    <div class="form-row" style="margin-bottom:0;">
        <label><i class="fa fa-list"></i> <span data-i18n="change.label.rules"></span></label>
    </div>
    <div class="form-row node-input-rule-container-row">
        <ol id="node-input-rule-container"></ol>
    </div>
</script>

<script type="text/javascript">
(function() {
    RED.nodes.registerType('change', {
        color: "#E2D96E",
        category: 'function',
        defaults: {
            name: {value:""},
            rules:{
                value:[{t:"set",p:"payload",pt:"msg",to:"",tot:"str"}],
                validate: function(rules, opt) {
                    let msg;
                    const errors = []
                    if (!rules || rules.length === 0) { return true }
                    for (var i=0;i<rules.length;i++) {
                        const opt = { label: RED._('node-red:change.label.rule')+' '+(i+1) }
                        const r = rules[i];
                        if (r.t === 'set' || r.t === 'change' || r.t === 'delete' || r.t === 'move') {
                            if ((msg = RED.utils.validateTypedProperty(r.p,r.pt,opt)) !== true) {
                                errors.push(msg)
                            }
                        }
                        if (r.t === 'set' || r.t === 'change' || r.t === 'move') {
                            if ((msg = RED.utils.validateTypedProperty(r.to,r.tot,opt)) !== true) {
                                errors.push(msg)
                            }
                        }
                        if (r.t === 'change') {
                            if ((msg = RED.utils.validateTypedProperty(r.from,r.fromt,opt)) !== true) {
                                errors.push(msg)
                            }
                        }
                    }
                    if (errors.length) {
                        return errors
                    }
                    return true;
                }
            },
            // legacy
            action: {value:""},
            property: {value:""},
            from: {value:""},
            to: {value:""},
            reg: {value:false}
        },
        inputs: 1,
        outputs: 1,
        icon: "swap.svg",
        label: function() {
            function prop2name(type, key) {
                var result = RED.utils.parseContextKey(key);
                return type +"." +result.key;
            }
            if (this.name) {
                return this.name;
            }
            if (!this.rules) {
                if (this.action === "replace") {
                    return this._("change.label.set",{property:"msg."+this.property});
                } else if (this.action === "change") {
                    return this._("change.label.change",{property:"msg."+this.property});
                } else if (this.action === "move") {
                    return this._("change.label.move",{property:"msg."+this.property});
                } else {
                    return this._("change.label.delete",{property:"msg."+this.property});
                }
            } else {
                if (this.rules.length == 1) {
                    if (this.rules[0].t === "set") {
                        return this._("change.label.set",{property:prop2name((this.rules[0].pt||"msg"), this.rules[0].p)});
                    } else if (this.rules[0].t === "change") {
                        return this._("change.label.change",{property:prop2name((this.rules[0].pt||"msg"), this.rules[0].p)});
                    } else if (this.rules[0].t === "move") {
                        return this._("change.label.move",{property:prop2name((this.rules[0].pt||"msg"), this.rules[0].p)});
                    } else {
                        return this._("change.label.delete",{property:prop2name((this.rules[0].pt||"msg"), this.rules[0].p)});
                    }
                } else {
                    return this._("change.label.changeCount",{count:this.rules.length});
                }
            }
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function() {
            var set = this._("change.action.set");
            var change = this._("change.action.change");
            var del = this._("change.action.delete");
            var move = this._("change.action.move");
            var to = this._("change.action.to");
            var toValueLabel = this._("change.action.toValue",to);
            var search = this._("change.action.search");
            var replace = this._("change.action.replace");
            var regex = this._("change.label.regex");
            var deepCopyLabel = this._("change.label.deepCopy");

            function createPropertyValue(row2_1, row2_2, defaultType) {
                var propValInput = $('<input/>',{class:"node-input-rule-property-value",type:"text"})
                    .appendTo(row2_1)
                    .typedInput({default:defaultType||'str',types:['msg','flow','global','str','num','bool','json','bin','date','jsonata','env']});

                var dcLabel = $('<label style="padding-left: 130px;"></label>').appendTo(row2_2);
                var deepCopy = $('<input type="checkbox" class="node-input-rule-property-deepCopy" style="width: auto; margin: 0 6px 0 0">').appendTo(dcLabel)
                $('<span>').text(deepCopyLabel).appendTo(dcLabel)

                propValInput.on("change", function(evt,type,val) {
                    row2_2.toggle(type === "msg" || type === "flow" || type === "global" || type === "env");
                })
                return [propValInput, deepCopy];
            }
            function createFromValue(row3_1, defaultType) {
                return $('<input/>',{class:"node-input-rule-property-search-value",type:"text"})
                .appendTo(row3_1)
                .typedInput({default:defaultType||'str',types:['msg','flow','global','str','re','num','bool','env']});
            }
            function createToValue(row3_2, defaultType) {
                return $('<input/>',{class:"node-input-rule-property-replace-value",type:"text"})
                .appendTo(row3_2)
                .typedInput({default:defaultType||'str',types:['msg','flow','global','str','num','bool','json','bin','env']});
            }
            function createMoveValue(row4, defaultType) {
                return $('<input/>',{class:"node-input-rule-property-move-value",type:"text"})
                .appendTo(row4)
                .typedInput({default:defaultType||'msg',types:['msg','flow','global']});
            }

            $('#node-input-rule-container').css('min-height','150px').css('min-width','450px').editableList({
                addItem: function(container,i,opt) {
                    var rule = opt;
                    if (!rule.hasOwnProperty('t')) {
                        rule = {t:"set",p:"payload",to:"",tot:"str"};
                    }
                    if (rule.t === "change" && rule.re) {
                        rule.fromt = 're';
                        delete rule.re;
                    }
                    if (rule.t === "set" && !rule.tot) {
                        if (rule.to.indexOf("msg.") === 0 && !rule.tot) {
                            rule.to = rule.to.substring(4);
                            rule.tot = "msg";
                        } else {
                            rule.tot = "str";
                        }
                    }
                    if (rule.t === "move" && !rule.tot) {
                        rule.tot = "msg";
                    }
                    container.css({
                        overflow: 'hidden',
                        whiteSpace: 'nowrap'
                    });
                    let fragment = document.createDocumentFragment();
                    var row1 = $('<div/>',{style:"display:flex; align-items: baseline"}).appendTo(fragment);
                    var row2 = $('<div/>',{style:"margin-top:8px;"}).appendTo(fragment);
                    var row3 = $('<div/>',{style:"margin-top:8px;"}).appendTo(fragment);
                    var row4 = $('<div/>',{style:"display:flex;margin-top:8px;align-items: baseline"}).appendTo(fragment);

                    var selectField = $('<select/>',{class:"node-input-rule-type",style:"width:110px; margin-right:10px;"}).appendTo(row1);
                    var selectOptions = [{v:"set",l:set},{v:"change",l:change},{v:"delete",l:del},{v:"move",l:move}];
                    for (var i=0; i<4; i++) {
                        selectField.append($("<option></option>").val(selectOptions[i].v).text(selectOptions[i].l));
                    }

                    var propertyName = $('<input/>',{class:"node-input-rule-property-name",type:"text"})
                        .appendTo(row1)
                        .typedInput({types:['msg','flow','global']});

                    var row2_1 = $('<div/>', {style:"display:flex;align-items: baseline"}).appendTo(row2);
                    $('<div/>',{style:"display:inline-block;text-align:right; width:120px; padding-right:10px; box-sizing:border-box;"})
                        .text(toValueLabel)
                        .appendTo(row2_1);

                    var row2_2 = $('<div/>', {style:"margin-top: 4px;"}).appendTo(row2);

                    var row3_1 = $('<div/>', {style:"display:flex;align-items: baseline"}).appendTo(row3);
                    $('<div/>',{style:"display:inline-block;text-align:right; width:120px; padding-right:10px; box-sizing:border-box;"})
                        .text(search)
                        .appendTo(row3_1);

                    var row3_2 = $('<div/>',{style:"display:flex;margin-top:8px;align-items: baseline"}).appendTo(row3);
                    $('<div/>',{style:"display:inline-block;text-align:right; width:120px; padding-right:10px; box-sizing:border-box;"})
                        .text(replace)
                        .appendTo(row3_2);

                    $('<div/>',{style:"display:inline-block;text-align:right; width:120px; padding-right:10px; box-sizing:border-box;"})
                        .text(to)
                        .appendTo(row4);

                    let propertyValue = null;
                    let fromValue = null;
                    let toValue = null;
                    let moveValue = null;

                    selectField.on("change", function() {
                        var type = $(this).val();
                        if (propertyValue) {
                            propertyValue.typedInput('hide');
                        }
                        if (fromValue) {
                            fromValue.typedInput('hide');
                        }
                        if (toValue) {
                            toValue.typedInput('hide');
                        }
                        if (moveValue) {
                            moveValue.typedInput('hide');
                        }

                        if (type == "set") {
                            if(!propertyValue) {
                                var parts = createPropertyValue(row2_1, row2_2);
                                propertyValue = parts[0];
                                deepCopy = parts[1];
                            }
                            propertyValue.typedInput('show');
                            row2.show();
                            row3.hide();
                            row4.hide();
                        } else if (type == "change") {
                            if(!fromValue) {
                                fromValue = createFromValue(row3_1);
                            }
                            fromValue.typedInput('show');
                            if(!toValue) {
                                toValue = createToValue(row3_2);
                            }
                            toValue.typedInput('show');
                            row2.hide();
                            row3.show();
                            row4.hide();
                        } else if (type == "delete") {
                            row2.hide();
                            row3.hide();
                            row4.hide();
                        } else if (type == "move") {
                            if(!moveValue) {
                                moveValue = createMoveValue(row4);
                            }
                            moveValue.typedInput('show');
                            row2.hide();
                            row3.hide();
                            row4.show();
                        }
                    });

                    selectField.val(rule.t);
                    propertyName.typedInput('value',rule.p);
                    propertyName.typedInput('type',rule.pt);
                    if (rule.t == "set") {
                        var parts = createPropertyValue(row2_1, row2_2, rule.tot);
                        propertyValue = parts[0];
                        deepCopy = parts[1];
                        propertyValue.typedInput('value',rule.to);
                        deepCopy.prop("checked", !!rule.dc);
                    }
                    if (rule.t == "move") {
                        moveValue = createMoveValue(row4,rule.tot);
                        moveValue.typedInput('value',rule.to);
                    }
                    if (rule.t == "change") {
                        fromValue = createFromValue(row3_1, rule.fromt);
                        fromValue.typedInput('value',rule.from);

                        toValue = createToValue(row3_2,rule.tot);
                        toValue.typedInput('value',rule.to);
                    }
                    selectField.change();
                    container[0].appendChild(fragment);
                },
                removable: true,
                sortable: true
            });

            if (!this.rules) {
                var rule = {
                    t:(this.action=="replace"?"set":this.action),
                    p:this.property,
                    pt:"msg"
                };

                if ((rule.t === "set")||(rule.t === "move")) {
                    rule.to = this.to;
                } else if (rule.t === "change") {
                    rule.from = this.from;
                    rule.to = this.to;
                    rule.re = this.reg;
                }

                delete this.to;
                delete this.from;
                delete this.reg;
                delete this.action;
                delete this.property;

                this.rules = [rule];
            }

            for (var i=0; i<this.rules.length; i++) {
                var rule = this.rules[i];
                $("#node-input-rule-container").editableList('addItem',rule);
            }
        },
        oneditsave: function() {
            var rules = $("#node-input-rule-container").editableList('items');
            var node = this;
            node.rules= [];
            rules.each(function(i) {
                var rule = $(this);
                var type = rule.find(".node-input-rule-type").val();
                var r = {
                    t:type,
                    p:rule.find(".node-input-rule-property-name").typedInput('value'),
                    pt:rule.find(".node-input-rule-property-name").typedInput('type')
                };
                if (type === "set") {
                    r.to = rule.find(".node-input-rule-property-value").typedInput('value');
                    r.tot = rule.find(".node-input-rule-property-value").typedInput('type');
                    if (rule.find(".node-input-rule-property-deepCopy").prop("checked")) {
                        r.dc = true;
                    }
                } else if (type === "move") {
                    r.to = rule.find(".node-input-rule-property-move-value").typedInput('value');
                    r.tot = rule.find(".node-input-rule-property-move-value").typedInput('type');
                } else if (type === "change") {
                    r.from = rule.find(".node-input-rule-property-search-value").typedInput('value');
                    r.fromt = rule.find(".node-input-rule-property-search-value").typedInput('type');
                    r.to = rule.find(".node-input-rule-property-replace-value").typedInput('value');
                    r.tot = rule.find(".node-input-rule-property-replace-value").typedInput('type');
                }
                node.rules.push(r);
            });
        },
        oneditresize: function(size) {
            var rows = $("#dialog-form>div:not(.node-input-rule-container-row)");
            var height = size.height;
            for (var i=0; i<rows.length; i++) {
                height -= $(rows[i]).outerHeight(true);
            }
            var editorRow = $("#dialog-form>div.node-input-rule-container-row");
            height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));
            height += 16;
            $("#node-input-rule-container").editableList('height',height);
        }
    });
})();
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="change">
    <p>Set, change, delete or move properties of a message, flow context or global context.</p>
    <p>The node can specify multiple rules that will be applied in the order they are defined.</p>
    <h3>Details</h3>
    <p>The available operations are:</p>
    <dl class="message-properties">
    <dt>Set</dt>
    <dd>set a property. The value can be a variety of different types, or
            can be taken from an existing message or context property.</dd>
    <dt>Change</dt>
    <dd>search &amp; replace parts of the property. If regular expressions
        are enabled, the "replace with" property can include capture groups, for
        example <code>$1</code>. Replace will only change the type if there
        is a complete match.</dd>
    <dt>Delete</dt>
    <dd>delete a property.</dd>
    <dt>Move</dt>
    <dd>move or rename a property.</dd>
    </dl>
    <p>The "expression" type uses the <a href="http://jsonata.org/" target="_new">JSONata</a>
    query and expression language.
    </p>
</script>

<!-- --- [red-module:node-red/range] --- -->

<script type="text/html" data-template-name="range">
    <div class="form-row">
        <label for="node-input-property"><i class="fa fa-ellipsis-h"></i> <span data-i18n="common.label.property"></span></label>
        <input type="text" id="node-input-property" style="width:calc(70% - 1px)"/>
    </div>
    <div class="form-row">
        <label for="node-input-action"><i class="fa fa-dot-circle-o"></i> <span data-i18n="range.label.action"></span></label>
        <select id="node-input-action" style="width:70%;">
            <option value="scale" data-i18n="range.scale.payload"></option>
            <option value="clamp" data-i18n="range.scale.limit"></option>
            <option value="roll" data-i18n="range.scale.wrap"></option>
            <option value="drop" data-i18n="range.scale.drop"></option>
        </select>
    </div>
    <br/>
    <div class="form-row"><i class="fa fa-sign-in"></i> <span data-i18n="range.label.inputrange"></span>:</div>
    <div class="form-row"><label></label>
        <span data-i18n="range.label.from"></span>: <input type="text" id="node-input-minin" data-i18n="[placeholder]range.placeholder.min" style="width:100px;"/>
        &nbsp;&nbsp;<span data-i18n="range.label.to"></span>: <input type="text" id="node-input-maxin" data-i18n="[placeholder]range.placeholder.maxin" style="width:100px;"/>
    </div>
    <div class="form-row"><i class="fa fa-sign-out"></i> <span data-i18n="range.label.resultrange"></span>:</div>
    <div class="form-row"><label></label>
        <span data-i18n="range.label.from"></span>: <input type="text" id="node-input-minout" data-i18n="[placeholder]range.placeholder.min" style="width:100px;"/>
        &nbsp;&nbsp;<span data-i18n="range.label.to"></span>: <input type="text" id="node-input-maxout" data-i18n="[placeholder]range.placeholder.maxout" style="width:100px;"/>
    </div>
    <br/>
    <div class="form-row"><label></label>
        <input type="checkbox" id="node-input-round" style="display: inline-block; width: auto; vertical-align: top;">
        <label style="width: auto;" for="node-input-round"><span data-i18n="range.label.roundresult"></span></label></input>
    </div>
    <br/>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
    <div class="form-tips" id="node-tip"><span data-i18n="range.tip"></span></div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('range', {
        color: "#E2D96E",
        category: 'function',
        defaults: {
            minin: {value:"", required: true,
                    label:RED._("node-red:range.label.minin"),
                    validate:RED.validators.number(false)},
            maxin: {value:"", required: true,
                    label:RED._("node-red:range.label.maxin"),
                    validate:RED.validators.number(false)},
            minout: {value:"", required:true,
                     label:RED._("node-red:range.label.minout"),
                     validate:RED.validators.number(false)},
            maxout: {value:"", required:true,
                     label:RED._("node-red:range.label.maxout"),
                     validate:RED.validators.number(false)},
            action: {value:"scale"},
            round: {value:false},
            property: {value:"payload",required:true,
                       label:RED._("node-red:common.label.property"),
                       validate: RED.validators.typedInput({ type: 'msg', allowBlank: true })
                    },
            name: {value:""}
        },
        inputs: 1,
        outputs: 1,
        icon: "range.svg",
        label: function() {
            if (this.minout !== "" && this.maxout !== "") { return this.name||this.minout + " - " + this.maxout; }
            else { return this.name||this._("range.range"); }
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function() {
            if (this.property === undefined) {
                $("#node-input-property").val("payload");
            }
            $("#node-input-property").typedInput({default:'msg',types:['msg']});
        }
    });
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="range">
    <p>Maps a numeric value to a different range.</p>
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">number</span></dt>
        <dd>The payload <i>must</i> be a number. Anything else will try to be
        parsed into a number and rejected if that fails.</dd>
    </dl>
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">number</span></dt>
        <dd>The value mapped to the new range.</dd>
    </dl>
    <h3>Details</h3>
    <p>This node will linearly scale the received value. By default, the result
    is not constrained to the range defined in the node.</p>
    <p><i>Scale and limit to target range</i> means that the result will never be outside
    the range specified within the target range.</p>
    <p><i>Scale and wrap within the target range</i> means that the result will
    be wrapped within the target range.</p>
    <p><i>Scale, but drop if outside input range</i> means that the result will
    be scaled, but any inputs outside of the inout range will be dropped.</p>
    <p>For example an input 0 - 10 mapped to 0 - 100.</p>
    <table style="outline-width:#888 solid thin">
        <tr><th width="80px">mode</th><th width="80px">input</th><th width="80px">output</th></tr>
        <tr><td><center>scale</center></td><td><center>12</center></td><td><center>120</center></td></tr>
        <tr><td><center>limit</center></td><td><center>12</center></td><td><center>100</center></td></tr>
        <tr><td><center>wrap</center></td><td><center>12</center></td><td><center>20</center></td></tr>
        <tr><td><center>drop</center></td><td><center>12</center></td><td><center><i>(no output)</i></center></td></tr>
    </table>
</script>

<!-- --- [red-module:node-red/template] --- -->

<script type="text/html" data-template-name="template">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <div style="display: inline-block; width: calc(100% - 105px)"><input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name"></div>
    </div>
    <div class="form-row">
        <label for="node-input-field"><i class="fa fa-ellipsis-h"></i> <span data-i18n="template.label.property"></span></label>
        <input type="text" id="node-input-field" placeholder="payload" style="width:250px;">
        <input type="hidden" id="node-input-fieldType">
    </div>
    <div class="form-row" style="position: relative; margin-bottom: 0px;">
        <label for="node-input-template"><i class="fa fa-file-code-o"></i> <span data-i18n="template.label.template"></span></label>
        <input type="hidden" id="node-input-template" autofocus="autofocus">
        <div style="position: absolute; right:0;display:inline-block; text-align: right; font-size: 0.8em;">
            <span data-i18n="template.label.format"></span>:
            <select id="node-input-format" style="width:110px; font-size: 10px !important;  height: 24px; padding:0;">
                <option value="handlebars">mustache</option>
                <option value="html">HTML</option>
                <option value="json">JSON</option>
                <option value="javascript">JavaScript</option>
                <option value="css">CSS</option>
                <option value="markdown">Markdown</option>
                <option value="php">PHP</option>
                <option value="python">Python</option>
                <option value="sql">SQL</option>
                <option value="yaml">YAML</option>
                <option value="text" data-i18n="template.label.none"></option>
            </select>
            <button type="button" id="node-template-expand-editor" class="red-ui-button red-ui-button-small"><i class="fa fa-expand"></i></button>
        </div>
    </div>
    <div class="form-row node-text-editor-row">
        <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-template-editor" ></div>
    </div>
    <div class="form-row">
        <label for="node-input-syntax"><i class="fa fa-code"></i> <span data-i18n="template.label.syntax"></span></label>
        <select id="node-input-syntax" style="width:180px;">
            <option value="mustache" data-i18n="template.label.mustache"></option>
            <option value="plain" data-i18n="template.label.plain"></option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-output"><i class="fa fa-long-arrow-right"></i> <span data-i18n="template.label.output"></span></label>
        <select id="node-input-output" style="width:180px;">
            <option value="str" data-i18n="template.label.plain"></option>
            <option value="json" data-i18n="template.label.json"></option>
            <option value="yaml" data-i18n="template.label.yaml"></option>
        </select>
    </div>

</script>

<script type="text/javascript">
    RED.nodes.registerType('template',{
        color:"rgb(243, 181, 103)",
        category: 'function',
        defaults: {
            name: {value:""},
            field: {value:"payload",
                    label:"payload",
                    validate:RED.validators.typedInput("fieldType", false)},
            fieldType: {value:"msg"},
            format: {value:"handlebars"},
            syntax: {value:"mustache"},
            template: {value:"This is the payload: {{payload}} !"},
            output: {value:"str"}
        },
        inputs:1,
        outputs:1,
        icon: "template.svg",
        label: function() {
            return this.name||this._("template.template");;
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            const that = this;
            const stateId = RED.editor.generateViewStateId("node", this, "");
            if (!this.field) {
                this.field = 'payload';
                $("#node-input-field").val("payload");
            }
            if (!this.fieldType) {
                this.fieldType = 'msg';
            }
            if (!this.syntax) {
                this.syntax = 'mustache';
                $("#node-input-syntax").val(this.syntax);
            }
            $("#node-input-field").typedInput({
                default: 'msg',
                types: ['msg','flow','global'],
                typeField: $("#node-input-fieldType")
            });
            this.editor = RED.editor.createEditor({
                id: 'node-input-template-editor',
                mode: 'ace/mode/html',
                stateId: stateId,
                value: $("#node-input-template").val()
            });
            RED.library.create({
                url:"templates", // where to get the data from
                type:"template", // the type of object the library is for
                editor:that.editor, // the field name the main text body goes to
                fields:['name','format','output','syntax'],
                ext: "txt"
            });

            $("#node-input-format").on("change", function() {
                var mod = "ace/mode/"+$("#node-input-format").val();
                that.editor.getSession().setMode({
                    path: mod,
                    v: Date.now()
                });
            });
            RED.popover.tooltip($("#node-template-expand-editor"), RED._("node-red:common.label.expand"));
            $("#node-template-expand-editor").on("click", function (e) {
                e.preventDefault();
                const value = that.editor.getValue();
                that.editor.saveView();
                RED.editor.editText({
                    mode: $("#node-input-format").val(),
                    value: value,
                    stateId: stateId,
                    width: "Infinity",
                    focus: true,
                    complete: function (v, cursor) {
                        that.editor.setValue(v, -1);
                        setTimeout(function () {
                            that.editor.restoreView();
                            that.editor.focus();
                        }, 250);
                    }
                })
            })
        },
        oneditsave: function() {
            $("#node-input-template").val(this.editor.getValue());
            this.editor.destroy();
            delete this.editor;
        },
        oneditcancel: function() {
            this.editor.destroy();
            delete this.editor;
        },
        oneditresize: function(size) {
            var rows = $("#dialog-form>div:not(.node-text-editor-row)");
            var height = $("#dialog-form").height();
            for (var i=0; i<rows.length; i++) {
                height -= $(rows[i]).outerHeight(true);
            }
            var editorRow = $("#dialog-form>div.node-text-editor-row");
            height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));
            $("#dialog-form .node-text-editor").css("height",height+"px");
            this.editor.resize();
        }
    });
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="template">
    <p>Sets a property based on the provided template.</p>
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>msg <span class="property-type">object</span></dt>
        <dd>A msg object containing information to populate the template.</dd>
        <dt class="optional">template <span class="property-type">string</span></dt>
        <dd>A template to be populated from <code>msg.payload</code>. If not configured in the edit panel,
         this can be set as a property of msg.</dd>
    </dl>
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>msg <span class="property-type">object</span></dt>
        <dd>a msg with a property set by populating the configured template with properties from the incoming msg.</dd>
    </dl>
    <h3>Details</h3>
    <p>By default this uses the <i><a href="http://mustache.github.io/mustache.5.html" target="_blank">mustache</a></i>
    format, but this can be switched off if required.</p>
    <p>For example, when a template of:
    <pre>Hello {{payload.name}}. Today is {{date}}</pre>
    <p>receives a message containing:
    <pre>{
  date: "Monday",
  payload: {
    name: "Fred"
  }
}</pre>
    <p>The resulting property will be:
    <pre>Hello Fred. Today is Monday</pre>
    <p>It is possible to use a property from the flow context or global context. Just use <code>{{flow.name}}</code> or
    <code>{{global.name}}</code>, or for persistable store <code>store</code> use <code>{{flow[store].name}}</code> or
    <code>{{global[store].name}}</code>.
    <p><b>Note: </b>By default, <i>mustache</i> will escape any non-alphanumeric or HTML entities in the values it substitutes.
       To prevent this, use <code>{{{triple}}}</code> braces.</p>
    <p>If you need to use <code>{{ }}</code> within your content, you can change the characters
       used to mark the templated sections. For example, to use <code>[[ ]]</code>
       instead, add the following line to the top of the template:</p>
    <pre>{{=[[ ]]=}}</pre>
    <h4>Using environment variables</h4>
    <p>The template node can access environment variables using the syntax:</p>
    <pre>My favourite colour is {{env.COLOUR}}.</pre>
</script>

<!-- --- [red-module:node-red/delay] --- -->
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-template-name="delay">
    <div class="form-row">
        <label for="node-input-delay-action"><i class="fa fa-tasks"></i> <span data-i18n="delay.action"></span></label>
        <select id="node-input-delay-action" style="width:270px !important">
            <option value="delay" data-i18n="delay.delaymsg"></option>
            <option value="rate" data-i18n="delay.limitrate"></option>
        </select>
    </div>

    <div id="delay-details">
        <div class="form-row">
            <label></label>
            <select id="node-input-delay-type" style="width:270px !important">
                <option value="delay" data-i18n="delay.delayfixed"></option>
                <option value="random" data-i18n="delay.randomdelay"></option>
                <option value="delayv" data-i18n="delay.delayvarmsg"></option>
            </select>
        </div>
        <div class="form-row" id="delay-details-for">
            <label for="node-input-timeout"><i class="fa fa-clock-o"></i> <span data-i18n="delay.for"></span></label>
            <input type="text" id="node-input-timeout" style="text-align:end; width:50px !important">
            <select id="node-input-timeoutUnits" style="width:200px !important">
              <option value="milliseconds" data-i18n="delay.milisecs"></option>
              <option value="seconds" data-i18n="delay.secs"></option>
              <option value="minutes" data-i18n="delay.mins"></option>
              <option value="hours" data-i18n="delay.hours"></option>
              <option value="days" data-i18n="delay.days"></option>
            </select>
        </div>
        <div id="random-details" class="form-row">
            <label for="node-input-randomFirst"><i class="fa fa-clock-o"></i> <span data-i18n="delay.between"></span></label>
            <input type="text" id="node-input-randomFirst" placeholder="" style="text-align:end; width:50px !important">
            &nbsp;<span data-i18n="delay.and"></span>&nbsp;
            <input type="text" id="node-input-randomLast" placeholder="" style="text-align:end; width:50px !important">
            <select id="node-input-randomUnits" style="width:140px !important">
              <option value="milliseconds" data-i18n="delay.milisecs"></option>
              <option value="seconds" data-i18n="delay.secs"></option>
              <option value="minutes" data-i18n="delay.mins"></option>
              <option value="hours" data-i18n="delay.hours"></option>
              <option value="days" data-i18n="delay.days"></option>
            </select>
        </div>
    </div>

    <div id="rate-details">
        <div class="form-row">
            <label></label>
            <select id="node-input-rate-type" style="width:270px !important">
                <option value="all" data-i18n="delay.limitall"></option>
                <option value="topic" data-i18n="delay.limittopic"></option>
            </select>
        </div>
        <div class="form-row">
            <label for="node-input-rate"><i class="fa fa-clock-o"></i> <span data-i18n="delay.rate"></span></label>
            <input type="text" id="node-input-rate" placeholder="1" style="text-align:end; width:40px !important">
            <label for="node-input-rateUnits"><span data-i18n="delay.msgper"></span></label>
            <input type="text" id="node-input-nbRateUnits" placeholder="1" style="text-align:end; width:40px !important">
            <select id="node-input-rateUnits" style="width:90px !important">
              <option value="second" data-i18n="delay.label.units.second.singular"></option>
              <option value="minute" data-i18n="delay.label.units.minute.singular"></option>
              <option value="hour" data-i18n="delay.label.units.hour.singular"></option>
              <option value="day" data-i18n="delay.label.units.day.singular"></option>
            </select>
        </div>
        <div class="form-row" id="rate-override" style="display: flex; align-items: center">
            <label></label><input style="width:30px; margin:0" type="checkbox" id="node-input-allowrate"><label style="margin:0;width: auto;" for="node-input-allowrate" data-i18n="delay.allowrate"></label>
        </div>
        <div class="form-row" id="rate-details-drop">
            <input type="hidden" id="node-input-outputs" value="1">
            <label></label>
            <select id="node-input-drop-select" style="width: 70%">
                <option id="node-input-drop-select-queue" value="queue" data-i18n="delay.queuemsg"></option>
                <option value="drop" data-i18n="delay.dropmsg"></option>
                <option value="emit" data-i18n="delay.sendmsg"></option>
            </select>
        </div>
        <div class="form-row" id="rate-details-per-topic">
            <label></label>
            <select id="node-input-rate-topic-type" style="width:270px !important">
                <option value="queue" data-i18n="delay.fairqueue"></option>
                <option value="timed" data-i18n="delay.timedqueue"></option>
            </select>
        </div>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('delay',{
        category: 'function',
        color:"#E6E0F8",
        defaults: {
            name: {value:""},
            pauseType: {value:"delay", required:true},
            timeout: {
                value:"5", required:true,
                label:RED._("node-red:delay.label.delay"),
                validate:function(v,opt) {
                    if (RED.validators.number(v) && (v >= 0)) {
                        return true;
                    }
                    return RED._("node-red:delay.errors.invalid-timeout");
                }},
            timeoutUnits: {value:"seconds"},
            rate: {
                value:"1",
                required:true,
                label:RED._("node-red:delay.label.rate"),
                validate:function(v,opt) {
                    if (RED.validators.number(v) && (v >= 0)) {
                        return true;
                    }
                    return RED._("node-red:delay.errors.invalid-rate");
                }
            },
            nbRateUnits: {
                value:"1",
                required:false,
                validate:function(v,opt) {
                    if (v === undefined || (RED.validators.number(v) && (v >= 0))) {
                        return true;
                    }
                    return RED._("node-red:delay.errors.invalid-rate-unit");
                }
            },
            rateUnits: {value: "second"},
            randomFirst: {
                value:"1", required:true,
                validate:function(v,opt) {
                    if (RED.validators.number(v) && (v >= 0)) {
                        return true;
                    }
                    return RED._("node-red:delay.errors.invalid-random-first");
                }},
            randomLast: {
                value:"5", required:true,
                validate:function(v,opt) {
                    if (RED.validators.number(v) && (v >= 0)) {
                        return true;
                    }
                    return RED._("node-red:delay.errors.invalid-random-last");
                }},
            randomUnits: {value: "seconds"},
            drop: {value:false},
            allowrate: {value:false},
            outputs: { value: 1},
        },
        inputs:1,
        outputs:1,
        icon: "timer.svg",
        label: function() {
            if (this.name) {
                return this.name;
            }
            if (this.pauseType == "delayv") {
                return this._("delay.label.variable");
            } else if (this.pauseType == "delay") {
                var units = this.timeoutUnits ? this.timeoutUnits.charAt(0) : "s";
                if (this.timeoutUnits == "milliseconds") { units = "ms"; }
                return this._("delay.label.delay")+" "+this.timeout+units;
            } else if (this.pauseType == "random") {
                return this._("delay.label.random");
            } else {
                var rate = this.rate+" msg/"+(this.rateUnits ? (this.nbRateUnits > 1 ? this.nbRateUnits : '') + this.rateUnits.charAt(0) : "s");
                if (this.pauseType == "rate") {
                    return this._("delay.label.limit")+" "+rate;
                } else if (this.pauseType == "timed") {
                    return this._("delay.label.limitTopic")+" "+rate;
                } else {
                    return this._("delay.label.limitTopic")+" "+rate;
                }
            }
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            var node = this;
            $( "#node-input-timeout" ).spinner({min:1});
            $( "#node-input-rate" ).spinner({min:1});
            $( "#node-input-nbRateUnits" ).spinner({min:1});

            $( "#node-input-randomFirst" ).spinner({min:0});
            $( "#node-input-randomLast" ).spinner({min:1});

            $('.ui-spinner-button').on("click", function() {
                $(this).siblings('input').trigger("change");
            });

            $( "#node-input-nbRateUnits" ).on('change keyup', function() {
                var $this = $(this);
                var val = parseInt($this.val());
                var type = "singular";
                if (val > 1) {
                    type = "plural";
                }
                if ($this.attr("data-type") == type) {
                    return;
                }
                $this.attr("data-type", type);
                $("#node-input-rateUnits option").each(function () {
                    var $option = $(this);
                    var key = "delay.label.units." + $option.val() + "." + type;
                    $option.attr('data-i18n', 'node-red:' + key);
                    $option.html(node._(key));
                });
            });

            if (this.pauseType == "delay") {
                $("#node-input-delay-action").val('delay');
                $("#node-input-delay-type").val('delay');
            } else if (this.pauseType == "delayv") {
                $("#node-input-delay-action").val('delay');
                $("#node-input-delay-type").val('delayv');
            } else if (this.pauseType == "random") {
                $("#node-input-delay-action").val('delay');
                $("#node-input-delay-type").val('random');
            } else if (this.pauseType == "rate") {
                $("#node-input-delay-action").val('rate');
                $("#node-input-rate-type").val('all');
            } else if (this.pauseType == "queue") {
                $("#node-input-delay-action").val('rate');
                $("#node-input-rate-type").val('topic');
                $("#node-input-rate-topic-type").val('queue');
            } else if (this.pauseType == "timed") {
                $("#node-input-delay-action").val('rate');
                $("#node-input-rate-type").val('topic');
                $("#node-input-rate-topic-type").val('timed');
            }

            if (!this.timeoutUnits) {
                $("#node-input-timeoutUnits option").filter(function() {
                    return $(this).val() == 'seconds';
                }).attr('selected', true);
            }

            if (!this.randomUnits) {
                $("#node-input-randomUnits option").filter(function() {
                    return $(this).val() == 'seconds';
                }).attr('selected', true);
            }

            $("#node-input-delay-action").on("change",function() {
                if (this.value === "delay") {
                    $("#delay-details").show();
                    $("#rate-details").hide();
                } else if (this.value === "rate") {
                    $("#delay-details").hide();
                    $("#rate-details").show();
                }
            }).trigger("change");

            $("#node-input-delay-type").on("change", function() {
                if (this.value === "delay") {
                    $("#delay-details-for").show();
                    $("#random-details").hide();
                } else if (this.value === "delayv") {
                    $("#delay-details-for").show();
                    $("#random-details").hide();
                } else if (this.value === "random") {
                    $("#delay-details-for").hide();
                    $("#random-details").show();
                }
            }).trigger("change");

            if (this.outputs === 2) {
                $("#node-input-drop-select").val("emit");
            } else if (this.drop) {
                $("#node-input-drop-select").val("drop");
            } else {
                $("#node-input-drop-select").val("queue");
            }

            $("#node-input-rate-type").on("change", function() {
                if (this.value === "all") {
                    $("#rate-details-per-topic").hide();
                    $("#node-input-drop-select-queue").attr('disabled', false);
                } else if (this.value === "topic") {
                    if ($("#node-input-drop-select").val() === "queue") {
                        $("#node-input-drop-select").val("drop");
                    }
                    $("#node-input-drop-select-queue").attr('disabled', true);
                    $("#rate-details-per-topic").show();
                }
            }).trigger("change");
        },
        oneditsave: function() {
            var action = $("#node-input-delay-action").val();
            if (action === "delay") {
                this.pauseType = $("#node-input-delay-type").val();
                $("#node-input-outputs").val(1);
            } else if (action === "rate") {
                action = $("#node-input-rate-type").val();
                if (action === "all") {
                    this.pauseType = "rate";
                } else {
                    this.pauseType = $("#node-input-rate-topic-type").val();
                }
                var dropType = $("#node-input-drop-select").val();
                this.drop = dropType !== "queue";
                $("#node-input-outputs").val(dropType === "emit"?2:1);
            }
        }
    });
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="delay">
    <p>Delays each message passing through the node or limits the rate at which they can pass.</p>
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt class="optional">delay <span class="property-type">number</span></dt>
        <dd>Sets the delay, in milliseconds, to be applied to the message. This
            option only applies if the node is configured to allow the message to
            override the configured default delay interval.</dd>
        <dt class="optional">rate <span class="property-type">number</span></dt>
        <dd>Sets the rate value in milliseconds between messages.
            This node overwrites the existing rate value defined in the node configuration
            when it receives the message which contains <code>msg.rate</code> value in milliSeconds.
            This option only applies if the node is configured to allow the message to
            override the configured default rate interval.</dd>
        <dt class="optional">reset</dt>
        <dd>If the received message has this property set to any value, all
            outstanding messages held by the node are cleared without being sent.</dd>
        <dt class="optional">flush</dt>
        <dd>If the received message has this property set to a numeric value then that many messages
            will be released immediately. If set to any other type (e.g. boolean), then all
            outstanding messages held by the node are sent immediately.</dd>
        <dt class="optional">toFront</dt>
        <dd>When in rate limit mode, if the received message has this property set to boolean <code>true</code>,
            then the message is pushed to the front of the queue and will be released next.
            This can be used in combination with <code>msg.flush=1</code> to resend immediately.
        </dd>
    </dl>
    <h3>Details</h3>
    <p>When configured to delay messages, the delay interval can be a fixed value,
        a random value within a range or dynamically set for each message.
        Each message is delayed independently of any other message, based on
        the time of its arrival.
    </p>
    <p>When configured to rate limit messages, their delivery is spread across
        the configured time period. The status shows the number of messages currently in the queue.
        It can optionally discard intermediate messages as they arrive.</p>
    </p>
    <p>If set to allow override of the rate, the new rate will be applied immediately,
        and will remain in effect until changed again, the node is reset, or the flow is restarted.</p>
    <p>The rate limiting can be applied to all messages, or group them according to
        their <code>msg.topic</code> value. When grouping, intermediate messages are
        automatically dropped. At each time interval, the node can either release
        the most recent message for all topics, or release the most recent message
        for the next topic.
    </p>
    <p><b>Note</b>: In rate limit mode the maximum queue depth can be set by a property in your
        <i>settings.js</i> file. For example <code>nodeMessageBufferMaxLength: 1000,</code></p>
</script>

<!-- --- [red-module:node-red/trigger] --- -->
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-template-name="trigger">
    <div class="form-row">
        <label data-i18n="trigger.send" for="node-input-op1"></label>
        <input type="hidden" id="node-input-op1type">
        <input style="width:70%" type="text" id="node-input-op1" placeholder="1">
    </div>
    <div class="form-row">
        <label data-i18n="trigger.then"></label>
        <select id="node-then-type" style="width:70%;">
            <option value="block" data-i18n="trigger.wait-reset"></option>
            <option value="wait" data-i18n="trigger.wait-for"></option>
            <option id="node-trigger-wait-loop" value="loop" data-i18n="trigger.wait-loop"></option>
        </select>
    </div>
    <div class="form-row node-type-duration">
        <label></label>
        <input type="text" id="node-input-duration" style="text-align:end; width:70px !important">
        <select id="node-input-units" style="width:140px !important">
            <option value="ms" data-i18n="trigger.duration.ms"></option>
            <option value="s" data-i18n="trigger.duration.s"></option>
            <option value="min" data-i18n="trigger.duration.m"></option>
            <option value="hr" data-i18n="trigger.duration.h"></option>
        </select>
    </div>
    <div class="form-row node-type-wait">
    <label></label>
        <input type="checkbox" id="node-input-extend" style="margin-left:0px; vertical-align:top; width:auto !important;"> <label style="width:auto !important;" for="node-input-extend" data-i18n="trigger.extend"></label>
    </div>
    <div class="form-row node-type-override">
    <label></label>
        <input type="checkbox" id="node-input-overrideDelay" style="margin-left:0px; vertical-align:top; width:auto !important;"> <label style="width:auto !important;" for="node-input-overrideDelay" data-i18n="trigger.override"></label>
    </div>
    <div class="form-row node-type-wait">
        <label data-i18n="trigger.then-send"></label>
        <input type="hidden" id="node-input-op2type">
        <input style="width:70%" type="text" id="node-input-op2" placeholder="0">
    </div>
    <div class="form-row" id="node-second-output">
        <label></label>
            <input type="checkbox" id="node-input-second" style="margin-left: 0px; vertical-align: top; width: auto !important;"> <label style="width:auto !important;" for="node-input-second" data-i18n="trigger.second"></label>
        </div>
    <div class="form-row">
        <label data-i18n="trigger.label.reset" style="width:auto"></label>
        <div style="display:inline-block; width:70%;vertical-align:top">
        <ul>
            <li data-i18n="trigger.label.resetMessage"></li>
            <li><span data-i18n="trigger.label.resetPayload"></span> <input type="text" id="node-input-reset" style="width:150px" data-i18n="[placeholder]trigger.label.resetprompt"></li>
        </ul>
    </div>
    <br/>
    <div class="form-row">
        <label data-i18n="trigger.for" for="node-input-bytopic"></label>
        <select id="node-input-bytopic" style="width:120px;">
            <option value="all" data-i18n="trigger.alltopics"></option>
            <option value="topic" data-i18n="trigger.bytopics"></option>
        </select>
        <span class="form-row" id="node-stream-topic">
            <input type="text" id="node-input-topic" style="width:46%;"/>
        </span>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name"></input>
        <input type="hidden" id="node-input-outputs" value="1">
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('trigger',{
        category: 'function',
        color:"#E6E0F8",
        defaults: {
            name: {value:""},
            op1: {value:"1",
                  label: RED._("node-red:trigger.send"),
                  validate: RED.validators.typedInput("op1type", false)},
            op2: {value:"0",
                  label: RED._("node-red:trigger.then-send"),
                  validate: RED.validators.typedInput("op2type", false)},
            op1type: {value:"val"},
            op2type: {value:"val"},
            duration: {
                value:"250", required:true,
                label:RED._("node-red:trigger.label.duration"),
                validate:RED.validators.number(false)},
            extend: {value:"false"},
            overrideDelay: {value:"false"},
            units: {value:"ms"},
            reset: {value:""},
            bytopic: {value:"all"},
            topic: {value:"topic", required:true,
                    label:RED._("node-red:trigger.label.topic")},
            outputs: {value:1}
        },
        inputs:1,
        outputs:1,
        icon: "trigger.svg",
        label: function() {
            if (this.duration > 0) {
                return this.name|| this._("trigger.label.trigger")+" "+this.duration+this.units;
            }
            if (this.duration < 0) {
                return this.name|| this._("trigger.label.trigger-loop")+" "+(this.duration * -1)+this.units;
            }
            else {
                return this.name|| this._("trigger.label.trigger-block");
            }
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            var that = this;
            if (this.topic === undefined) { $("#node-input-topic").val("topic"); }
            $("#node-input-topic").typedInput({default:'msg',types:['msg']});
            $("#node-input-bytopic").on("change", function() {
                if ($("#node-input-bytopic").val() === "all") {
                    $("#node-stream-topic").hide();
                } else {
                    $("#node-stream-topic").show();
                }
            });

            if (this.outputs == 2) { $("#node-input-second").prop('checked', true) }
            else { $("#node-input-second").prop('checked', false) }

            $("#node-input-second").change(function() {
                if ($("#node-input-second").is(":checked")) {
                    $("#node-input-outputs").val(2);
                }
                else  {
                    $("#node-input-outputs").val(1);
                }
            });
            $("#node-then-type").on("change", function() {
                if ($(this).val() == "block") {
                    $(".node-type-wait").hide();
                    $(".node-type-override").hide();
                    $(".node-type-duration").hide();
                    $("#node-second-output").hide();
                    $("#node-input-second").prop('checked', false);
                    $("#node-input-outputs").val(1);
                }
                else if ($(this).val() == "loop") {
                    if ($("#node-input-duration").val() == 0) { $("#node-input-duration").val(250); }
                    $(".node-type-wait").hide();
                    $(".node-type-override").show();
                    $(".node-type-duration").show();
                    $("#node-second-output").hide();
                    $("#node-input-second").prop('checked', false);
                    $("#node-input-outputs").val(1);
                } else {
                    if ($("#node-input-duration").val() == 0) { $("#node-input-duration").val(250); }
                    $(".node-type-wait").show();
                    $(".node-type-override").show();
                    $(".node-type-duration").show();
                    $("#node-second-output").show();
                }
            });

            if (this.op1type === 'val') {
                $("#node-input-op1type").val('str');
            }
            if (this.op2type === 'val') {
                $("#node-input-op2type").val('str');
            }

            $("#node-input-op1").on("change", function() {
                if ($("#node-input-op1type").val() === "nul") {
                    $("#node-trigger-wait-loop").hide();
                }
                else { $("#node-trigger-wait-loop").show(); }
            });

            var optionNothing = {value:"nul",label:this._("trigger.output.nothing"),hasValue:false};
            var optionPayload = {value:"pay",label:this._("trigger.output.existing"),hasValue:false};
            var optionOriginalPayload = {value:"pay",label:this._("trigger.output.original"),hasValue:false};
            var optionLatestPayload = {value:"payl",label:this._("trigger.output.latest"),hasValue:false};

            $("#node-input-op1").typedInput({
                default: 'str',
                typeField: $("#node-input-op1type"),
                types:['flow','global','str','num','bool','json','bin','date','env',
                    optionPayload,
                    optionNothing
                ]
            });
            $("#node-input-op2").typedInput({
                default: 'str',
                typeField: $("#node-input-op2type"),
                types:['flow','global','str','num','bool','json','bin','date','env',
                    optionOriginalPayload,
                    optionLatestPayload,
                    optionNothing
                ]
            });

            if (this.bytopic === undefined) {
                $("#node-input-bytopic").val("all");
            }

            if (this.duration == "0") {
                $("#node-then-type").val("block");
            }
            else if ((this.duration * 1) < 0) {
                $("#node-then-type").val("loop");
                $("#node-input-duration").val(this.duration*-1);
            } else {
                $("#node-then-type").val("wait");
            }
            $("#node-then-type").trigger("change");

            if (this.extend === "true" || this.extend === true) {
                $("#node-input-extend").prop("checked",true);
            } else {
                $("#node-input-extend").prop("checked",false);
            }
            if (this.overrideDelay === "true" || this.overrideDelay === true) {
                $("#node-input-overrideDelay").prop("checked",true);
            } else {
                $("#node-input-overrideDelay").prop("checked",false);
            }
        },
        oneditsave: function() {
            if ($("#node-then-type").val() == "block") {
                $("#node-input-duration").val("0");
            }
            if ($("#node-then-type").val() == "loop") {
                $("#node-input-duration").val($("#node-input-duration").val() * -1);
            }
        }
    });
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="trigger">
    <p>When triggered, can send a message, and then optionally a second message, unless extended or reset.</p>

    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt class="optional">delay <span class="property-type">number</span></dt>
        <dd>Sets the delay, in milliseconds, to be applied to the message. This option only applies if the node is configured to allow the message to override the configured default delay interval.</dd>
        <dt class="optional">reset</dt>
        <dd>If a message is received with this property, any timeout or repeat
        currently in progress will be cleared and no message triggered.</dd>
    </dl>

    <h3>Details</h3>
    <p>This node can be used to create a timeout within a flow. By default, when
    it receives a message, it sends on a message with a <code>payload</code> of <code>1</code>.
    It then waits 250ms before sending a second message with a <code>payload</code> of <code>0</code>.
    This could be used, for example, to blink an LED attached to a Raspberry Pi GPIO pin.</p>
    <p>The payloads of each message sent can be configured to a variety of values, including
    the option to not send anything. For example, setting the initial message to <i>nothing</i> and
    selecting the option to extend the timer with each received message, the node will
    act as a watchdog timer; only sending a message if nothing is received within the
    set interval.</p>
    <p>If set to a <i>string</i> type, the node supports the mustache template syntax.</p>
    <p>The delay between sending messages can be overridden by <code>msg.delay</code> if that option is enabled in the node. The value must be provided in milliseconds.</p>
    <p>If the node receives a message with a <code>reset</code> property, or a <code>payload</code>
    that matches that configured in the node, any timeout or repeat currently in
    progress will be cleared and no message triggered.</p>
    <p>The node can be configured to resend a message at a regular interval until it
    is reset by a received message.</p>
    <p>Optionally, the node can be configured to treat messages as if they are separate streams,
    using a msg property to identify each stream. Default <code>msg.topic</code>.</p>
    <p>The status indicates the node is currently active. If multiple streams are used the status
    indicates the number of streams being held.</p>
</script>

<!-- --- [red-module:node-red/exec] --- -->
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-template-name="exec">
    <div class="form-row">
        <label for="node-input-command"><i class="fa fa-file"></i> <span data-i18n="exec.label.command"></span></label>
        <input type="text" id="node-input-command" data-i18n="[placeholder]exec.label.command">
    </div>
    <div class="form-row">
        <label><i class="fa fa-plus"></i> <span data-i18n="exec.label.append"></span></label>
        <input type="checkbox" id="node-input-addpay-cb" style="display:inline-block; width:auto;">
        <input type="text" id="node-input-addpay" style="margin-left: 5px; width:160px;">
    </div>
    <div class="form-row">
        <label for="node-input-append"> </label>
        <input type="text" id="node-input-append" data-i18n="[placeholder]exec.placeholder.extraparams">
    </div>
    <div class="form-row">
        <label><i class="fa fa-sign-out"></i> <span data-i18n="exec.label.return"></span></label>
        <select type="text" id="node-input-useSpawn" style="width:70%">
            <option value="false" data-i18n="exec.opt.exec"></option>
            <option value="true" data-i18n="exec.opt.spawn"></option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-timer"><i class="fa fa-clock-o"></i> <span data-i18n="exec.label.timeout"></span></label>
        <input type="text" id="node-input-timer" style="width:65px;" data-i18n="[placeholder]exec.label.timeoutplace">
        <span data-i18n="exec.label.seconds"></span>
    </div>
    <div class="form-row">
        <label for="node-input-winHide" style="width: auto !important; padding-right:10px"><i class="fa fa-windows"></i> <span data-i18n="exec.label.winHide"></span></label>
        <input type="checkbox" id="node-input-winHide" style="margin-top: 0; display:inline-block; width:auto;">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('exec',{
        category: 'function',
        color:"darksalmon",
        defaults: {
            command: {value:""},
            addpay: {value:"", validate: RED.validators.typedInput({ type: 'msg', allowBlank: true })},
            append: {value:""},
            useSpawn: {value:"false"},
            timer: {value:""},
            winHide: {value:false},
            oldrc: {value:false},
            name: {value:""}
        },
        inputs:1,
        outputs:3,
        outputLabels: function(i) {
            return [
                this._("exec.label.stdout"),
                this._("exec.label.stderr"),
                this._("exec.label.retcode")
            ][i];
        },
        icon: "cog.svg",
        label: function() {
            return this.name||this.command.replace(/\\n /g,"\\\\n ")||(this.useSpawn=="true"?this._("exec.spawn"):this._("exec.exec"));
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            if ($("#node-input-useSpawn").val() === null) {
                $("#node-input-useSpawn").val(this.useSpawn.toString());
            }
            $("#node-input-addpay-cb").prop("checked", this.addpay === true || (this.addpay !== false && this.addpay !== ""))
            var addpayValue = (this.addpay === true)?"payload":((this.addpay === false || this.addpay === "")?"payload":this.addpay);
            $("#node-input-addpay-cb").on("change", function(evt) {
                $("#node-input-addpay").typedInput("disable",!$("#node-input-addpay-cb").prop("checked"));
            });

            $("#node-input-addpay").val(addpayValue);
            $("#node-input-addpay").typedInput({
                default: "msg",
                types: ["msg"]
            });

            $("#node-input-addpay-cb").trigger("change")

            if (this.winHide === "true" || this.winHide === true) {
                $("#node-input-winHide").prop("checked",true);
            } else {
                $("#node-input-winHide").prop("checked",false);
            }
        },
        oneditsave: function() {
            if (!$("#node-input-addpay-cb").prop("checked")) {
                $("#node-input-addpay").val("");
            }
        }
    });
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="exec">
    <p>Runs a system command and returns its output.</p>
    <p>The node can be configured to either wait until the command completes, or to
    send its output as the command generates it.</p>
    <p>The command that is run can be configured in the node or provided by the received
    message.</p>

    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt class="optional">payload <span class="property-type">string</span></dt>
        <dd>if configured to do so, will be appended to the executed command.</dd>
        <dt class="optional">kill <span class="property-type">string</span></dt>
        <dd>the type of kill signal to send an existing exec node process.</dd>
        <dt class="optional">pid <span class="property-type">number|string</span></dt>
        <dd>the process ID of an existing exec node process to kill.</dd>
    </dl>

    <h3>Outputs</h3>
    <ol class="node-ports">
        <li>Standard output
            <dl class="message-properties">
                <dt>payload <span class="property-type">string</span></dt>
                <dd>the standard output of the command.</dd>
            </dl>
            <dl class="message-properties">
                <dt>rc <span class="property-type">object</span></dt>
                <dd>exec mode only, a copy of the return code object (also available on port 3)</dd>
            </dl>
        </li>
        <li>Standard error
            <dl class="message-properties">
                <dt>payload <span class="property-type">string</span></dt>
                <dd>the standard error of the command.</dd>
            </dl>
            <dl class="message-properties">
                <dt>rc <span class="property-type">object</span></dt>
                <dd>exec mode only, a copy of the return code object (also available on port 3)</dd>
            </dl>
        </li>
        <li>Return code
            <dl class="message-properties">
                <dt>payload <span class="property-type">object</span></dt>
                <dd>an object containing the return code, and possibly <code>message</code>, <code>signal</code> properties.</dd>
            </dl>
        </li>
    </ol>
    <h3>Details</h3>
    <p>By default uses the <code>exec</code> system call which calls the command, waits for it to complete, and then
    returns the output. For example a successful command should have a return code of <code>{ code: 0 }</code>.</p>
    <p>Optionally can use <code>spawn</code> instead, which returns the output from stdout and stderr
    as the command runs, usually one line at a time. On completion it then returns an object
    on the 3rd port. For example, a successful command should return <code>{ code: 0 }</code>.</p>
    <p>Errors may return extra information on the 3rd port <code>msg.payload</code>, such as a <code>message</code> string,
    <code>signal</code> string.</p>
    <p>The command that is run is defined within the node, with an option to append <code>msg.payload</code> and a further set of parameters.</p>
    <p>Commands or parameters with spaces should be enclosed in quotes - <code>"This is a single parameter"</code></p>
    <p>The returned <code>payload</code> is usually a <i>string</i>, unless non-UTF8 characters are detected, in which
    case it is a <i>buffer</i>.</p>
    <p>The node&apos;s status icon and PID will be visible while the node is active. Changes to this can be read by the <code>Status</code> node.</p>
    <p>The <code>Hide console</code> option will hide the process console normally shown on Windows systems.</p>
    <h4>Killing processes</h4>
    <p>Sending <code>msg.kill</code> will kill a single active process. <code>msg.kill</code> should be a string containing
    the type of signal to be sent, for example, <code>SIGINT</code>, <code>SIGQUIT</code> or <code>SIGHUP</code>.
    Defaults to <code>SIGTERM</code> if set to an empty string.</p>
    <p>If the node has more than one process running then <code>msg.pid</code> must also be set with the value of the PID to be killed.</p>
    <p>If a value is provided in the <code>Timeout</code> field then, if the process has not completed when the specified number of seconds has elapsed, the process will be killed automatically</p>
    <p>Tip: if running a Python app you may need to use the <code>-u</code> parameter to stop the output being buffered.</p>
</script>

<!-- --- [red-module:node-red/rbe] --- -->

<script type="text/html" data-template-name="rbe">
    <div class="form-row">
        <label for="node-input-func"><i class="fa fa-wrench"></i> <span data-i18n="rbe.label.func"></span></label>
        <select type="text" id="node-input-func" style="width:70%;">
            <option value="rbe" data-i18n="rbe.opts.rbe"></option>
            <option value="rbei" data-i18n="rbe.opts.rbei"></option>
            <option value="deadbandEq" data-i18n="rbe.opts.deadbandEq"></option>
            <option value="deadband" data-i18n="rbe.opts.deadband"></option>
            <option value="narrowbandEq" data-i18n="rbe.opts.narrowbandEq"></option>
            <option value="narrowband" data-i18n="rbe.opts.narrowband"></option>
        </select>
    </div>
    <div class="form-row" id="node-bandgap">
        <label for="node-input-gap">&nbsp;</label>
        <input type="text" id="node-input-gap" data-i18n="[placeholder]rbe.placeholder.bandgap" style="width:95px;">
        <select type="text" id="node-input-inout" style="width:54%;">
            <option value="out" data-i18n="rbe.opts.out"></option>
            <option value="in" data-i18n="rbe.opts.in"></option>
        </select>
    </div>
    <div class="form-row" id="node-startvalue">
        <label for="node-input-start"><i class="fa fa-thumb-tack"></i> <span data-i18n="rbe.label.start"></span></label>
        <input type="text" id="node-input-start" data-i18n="[placeholder]rbe.placeholder.start" style="width:70%;">
    </div>
    <div class="form-row">
        <label for="node-input-property"><i class="fa fa-ellipsis-h"></i> <span data-i18n="node-red:common.label.property"></span></label>
        <input type="text" id="node-input-property" style="width:70%;"/>
    </div>
    <div class="form-row" style="margin-bottom: 0px;">
        <label> </label>
        <input type="checkbox" id="node-input-septopics" style="display:inline-block; width:20px; vertical-align:baseline;">
        <label style="width: auto" for="node-input-septopics" data-i18n="rbe.label.septopics"></label>
    </div>
    <div class="form-row">
        <label> </label>
        <input type="text" id="node-input-topi"  style="width:70%;"/>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="rbe.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]rbe.label.name" style="width:70%;">
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType("rbe", {
        color:"#E2D96E",
        category: 'function',
        defaults: {
            name: {value:""},
            func: {value:"rbe"},
            gap: {value:"",
                  label: RED._("node-red:rbe.label.gap"),
                  validate:RED.validators.regex(/^(\d*[.]*\d*|)(%|)$/)},
            start: {value:""},
            inout: {value:"out"},
            septopics: {value:true},
            property: {value:"payload", required:true,
                       label:RED._("node-red:rbe.label.property"),
                       validate: RED.validators.typedInput({ type: 'msg', allowUndefined: true })},
            topi: {value:"topic", required:true,
                   label:RED._("node-red:rbe.label.topic"),
                   validate: RED.validators.typedInput({ type: 'msg', allowUndefined: true })}
        },
        inputs:1,
        outputs:1,
        icon: "rbe.png",
        paletteLabel: "filter",
        label: function() {
            var ll = (this.func||"").replace("Eq","").replace("rbei",this._("rbe.rbe")).replace("rbe",this._("rbe.rbe"))||this._("rbe.rbe");
            return this.name||ll||this._("rbe.rbe");
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            if (this.property === undefined) {
                $("#node-input-property").val("payload");
            }
            if (this.septopics === undefined) {
                $("#node-input-septopics").prop('checked', true);
            }
            if (this.topi === undefined) {
                $("#node-input-topi").val("topic");
            }

            $("#node-input-property").typedInput({default:'msg',types:['msg']});
            $("#node-input-topi").typedInput({default:'msg',types:['msg']});
            //$( "#node-input-gap" ).spinner({min:0});
            if ($("#node-input-inout").val() === null) {
                $("#node-input-inout").val("out");
            }
            $("#node-input-func").on("change",function() {
                if (($("#node-input-func").val() === "rbe")||($("#node-input-func").val() === "rbei")) {
                    $("#node-bandgap").hide();
                } else {
                    $("#node-bandgap").show();
                }
                if (($("#node-input-func").val() === "narrowband")||($("#node-input-func").val() === "narrowbandEq")) {
                    $("#node-startvalue").show();
                } else {
                    $("#node-startvalue").hide();
                }
            });
            $("#node-input-septopics").on("change", function() {
                $("#node-input-topi").typedInput("disable",!this.checked);
            })
            $("#node-input-topi").typedInput("disable",!!!this.septopics);

        }
    });
</script>
<script type="text/html" data-help-name="rbe">
    <p>Report by Exception (RBE) node - only passes on data if the payload has changed.
       It can also block unless, or ignore if the value changes by a specified amount (Dead- and Narrowband mode).</p>
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>payload
            <span class="property-type">number | string | (object)</span>
        </dt>
        <dd>RBE mode will accept numbers, strings, and simple objects.
            Other modes must provide a parseable number.</dd>
        <dt class="optional">topic <span class="property-type">string</span>
        </dt>
        <dd>if specified the function will work on a per topic basis. This property can be set by configuration.</dd>
        <dt class="optional">reset<span class="property-type">any</span></dt>
        <dd>if set clears the stored value for the specified msg.topic, or
            all topics if msg.topic is not specified.</dd>
    </dl>
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>payload
            <span class="property-type">as per input</span>
        </dt>
        <dd>If triggered the output will be the same as the input.</dd>
    </dl>
    <h3>Details</h3>
    <p>In RBE mode this node will block until the <code>msg.payload</code>,
       (or selected property) value is different to the previous one.
       If required it can ignore the initial value, so as not to send anything at start.</p>
    <p>The <a href="https://en.wikipedia.org/wiki/Deadband" target="_blank">Deadband</a> modes will block the incoming value
       <i>unless</i> its change is greater or greater-equal than &plusmn; the band gap away from a previous value.</p>
    <p>The Narrowband modes will block the incoming value,
       <i>if</i> its change is greater or greater-equal than &plusmn; the band gap away from the previous value.
       It is useful for ignoring outliers from a faulty sensor for example.</p>
    <p>Both in Deadband and Narrowband modes the incoming value must contain a parseable number and
       both also supports % - only sends if/unless the input differs by more than x% of the original value.</p>
    <p>Both Deadband and Narrowband allow comparison against either the previous valid output value, thus
    ignoring any values out of range, or the previous input value, which resets the set point, thus allowing
    gradual drift (deadband), or a step change (narrowband).</p>
    <p><b>Note:</b> This works on a per <code>msg.topic</code> basis, though this can be changed to another property if desired.
       This means that a single filter node can handle multiple different topics at the same time.</p>
</script>

<!-- --- [red-module:node-red/tls] --- -->
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-template-name="tls-config">
    <div class="form-row" class="hide" id="node-config-row-uselocalfiles">
        <input type="checkbox" id="node-config-input-uselocalfiles" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-config-input-uselocalfiles" style="width: 70%;"><span data-i18n="tls.label.use-local-files"></label>
    </div>
    <div class="form-row">
        <label style="width: 120px;"><i class="fa fa-file-text-o"></i> <span data-i18n="tls.label.cert"></span></label>
        <span class="tls-config-input-data">
            <label class="red-ui-button" for="node-config-input-certfile"><i class="fa fa-upload"></i> <span data-i18n="tls.label.upload"></span></label>
            <input class="hide" type="file" id="node-config-input-certfile">
            <span id="tls-config-certname" style="width: calc(100% - 280px); overflow: hidden; line-height:34px; height:34px; text-overflow: ellipsis; white-space: nowrap; display: inline-block; vertical-align: middle;"> </span>
            <button type="button" class="red-ui-button red-ui-button-small" id="tls-config-button-cert-clear" style="margin-left: 10px"><i class="fa fa-times"></i></button>
        </span>
        <input type="hidden" id="node-config-input-certname">
        <input type="hidden" id="node-config-input-certdata">
        <input class="hide tls-config-input-path" style="width: calc(100% - 170px);" type="text" id="node-config-input-cert" data-i18n="[placeholder]tls.placeholder.cert">
    </div>
    <div class="form-row">
        <label style="width: 120px;" for="node-config-input-key"><i class="fa fa-file-text-o"></i> <span data-i18n="tls.label.key"></span></label>
        <span class="tls-config-input-data">
            <label class="red-ui-button" for="node-config-input-keyfile"><i class="fa fa-upload"></i> <span data-i18n="tls.label.upload"></span></label>
            <input class="hide" type="file" id="node-config-input-keyfile">
            <span id="tls-config-keyname" style="width: calc(100% - 280px); overflow: hidden; line-height:34px; height:34px; text-overflow: ellipsis; white-space: nowrap; display: inline-block; vertical-align: middle;"> </span>
            <button type="button" class="red-ui-button red-ui-button-small" id="tls-config-button-key-clear" style="margin-left: 10px"><i class="fa fa-times"></i></button>
        </span>
        <input type="hidden" id="node-config-input-keyname">
        <input type="hidden" id="node-config-input-keydata">
        <input class="hide tls-config-input-path" style="width: calc(100% - 170px);" type="text" id="node-config-input-key" data-i18n="[placeholder]tls.placeholder.key">
    </div>
    <div class="form-row">
        <label style="width: 100px; margin-left: 20px;" for="node-config-input-passphrase"> <span data-i18n="tls.label.passphrase"></span></label>
        <input type="password" style="width: calc(100% - 170px);" id="node-config-input-passphrase" data-i18n="[placeholder]tls.placeholder.passphrase">
    </div>
    <div class="form-row">
        <label style="width: 120px;" for="node-config-input-ca"><i class="fa fa-file-text-o"></i> <span data-i18n="tls.label.ca"></span></label>
        <span class="tls-config-input-data">
            <label class="red-ui-button" for="node-config-input-cafile"><i class="fa fa-upload"></i> <span data-i18n="tls.label.upload"></span></label>
            <input class="hide" type="file" title=" " id="node-config-input-cafile">
            <span id="tls-config-caname" style="width: calc(100% - 280px); overflow: hidden; line-height:34px; height:34px; text-overflow: ellipsis; white-space: nowrap; display: inline-block; vertical-align: middle;"> </span>
            <button type="button" class="red-ui-button red-ui-button-small" id="tls-config-button-ca-clear" style="margin-left: 10px"><i class="fa fa-times"></i></button>
        </span>
        <input type="hidden" id="node-config-input-caname">
        <input type="hidden" id="node-config-input-cadata">
        <input class="hide tls-config-input-path" style="width: calc(100% - 170px);" type="text" id="node-config-input-ca" data-i18n="[placeholder]tls.placeholder.ca">
    </div>
    <div class="form-row">
        <input type="checkbox" id="node-config-input-verifyservercert" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-config-input-verifyservercert" style="width: calc(100% - 170px);" data-i18n="tls.label.verify-server-cert"></label>
    </div>
    <div class="form-row">
        <label style="width: 126px;" for="node-config-input-servername"><i class="fa fa-server"></i> <span data-i18n="tls.label.servername"></span></label>
        <input style="width: calc(100% - 176px);" type="text" id="node-config-input-servername" data-i18n="[placeholder]tls.placeholder.servername">
    </div>
    <div class="form-row">
        <label style="width: 126px;" for="node-config-input-alpnprotocol"><i class="fa fa-cogs"></i> <span data-i18n="tls.label.alpnprotocol"></span></label>
        <input style="width: calc(100% - 176px);" type="text" id="node-config-input-alpnprotocol" data-i18n="[placeholder]tls.placeholder.alpnprotocol">
    </div>
    <hr>
    <div class="form-row">
        <label style="width: 120px;" for="node-config-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input style="width: calc(100% - 170px);" type="text" id="node-config-input-name" data-i18n="[placeholder]common.label.name">
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('tls-config',{
        category: 'config',
        defaults: {
            name: {value:""},
            cert: {value:"", validate: function(v,opt) {
                var currentKey = $("#node-config-input-key").val();
                if (currentKey === undefined) {
                    currentKey = this.key;
                }
                if (currentKey === '' || v != '') {
                    return true;
                }
                return RED._("node-red:tls.error.invalid-cert");
            }},
            key: {value:"", validate: function(v,opt) {
                var currentCert = $("#node-config-input-cert").val();
                if (currentCert === undefined) {
                    currentCert = this.cert;
                }
                if (currentCert === '' || v != '') {
                    return true;
                }
                return RED._("node-red:tls.error.invalid-key");
            }},
            ca: {value:""},
            certname: {value:""},
            keyname: {value:""},
            caname: {value:""},
            servername: {value:""},
            verifyservercert: {value: true},
            alpnprotocol: {value: ""}
        },
        credentials: {
            certdata: {type:"text"},
            keydata: {type:"text"},
            cadata: {type:"text"},
            passphrase: {type:"password"}
        },
        label: function() {
            return this.name || this._("tls.tls");
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            function updateFileUpload() {
                if ($("#node-config-input-uselocalfiles").is(':checked')) {
                    $(".tls-config-input-path").show();
                    $(".tls-config-input-data").hide();
                } else {
                    $(".tls-config-input-data").show();
                    $(".tls-config-input-path").hide();
                }
            }
            $("#node-config-input-uselocalfiles").on("click",function() {
                updateFileUpload();
            });

            function saveFile(property, file) {
                var dataInputId = "#node-config-input-"+property+"data";
                var filenameInputId = "#node-config-input-"+property+"name";
                var filename = file.name;
                var reader = new FileReader();
                reader.onload = function(event) {
                    $("#tls-config-"+property+"name").text(filename);
                    $(filenameInputId).val(filename);
                    $(dataInputId).val(event.target.result);
                }
                reader.readAsText(file,"UTF-8");
            }
            $("#node-config-input-certfile" ).on("change", function() {
                saveFile("cert", this.files[0]);
            });
            $("#node-config-input-keyfile" ).on("change", function() {
                saveFile("key", this.files[0]);
            });
            $("#node-config-input-cafile" ).on("change", function() {
                saveFile("ca", this.files[0]);
            });

            function clearNameData(prop) {
                $("#tls-config-"+prop+"name").text("");
                $("#node-config-input-"+prop+"data").val("");
                $("#node-config-input-"+prop+"name").val("");
            }
            $("#tls-config-button-cert-clear").on("click", function() {
                clearNameData("cert");
            });
            $("#tls-config-button-key-clear").on("click", function() {
                clearNameData("key");
            });
            $("#tls-config-button-ca-clear").on("click", function() {
                clearNameData("ca");
            });

            if (RED.settings.tlsConfigDisableLocalFiles) {
                $("#node-config-row-uselocalfiles").hide();
            } else {
                $("#node-config-row-uselocalfiles").show();
            }
            // in case paths were set from old TLS config
            if(this.cert || this.key || this.ca) {
                $("#node-config-input-uselocalfiles").prop('checked',true);
            }
            $("#tls-config-certname").text(this.certname);
            $("#tls-config-keyname").text(this.keyname);
            $("#tls-config-caname").text(this.caname);
            updateFileUpload();
        },
        oneditsave: function() {
            if ($("#node-config-input-uselocalfiles").is(':checked')) {
                clearNameData("ca");
                clearNameData("cert");
                clearNameData("key");
            } else {
                $("#node-config-input-ca").val("");
                $("#node-config-input-cert").val("");
                $("#node-config-input-key").val("");
            }
        }
    });
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="tls-config">
    <p>Configuration options for TLS connections.</p>
</script>

<!-- --- [red-module:node-red/httpproxy] --- -->
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-template-name="http proxy">
    <div class="form-row">
        <label for="node-config-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-config-input-name">
    </div>
    <div class="form-row">
        <label for="node-config-input-url"><i class="fa fa-globe"></i> <span data-i18n="httpin.label.url"></span></label>
        <input type="text" id="node-config-input-url" placeholder="http://hostname:port">
    </div>
    <div class="form-row">
        <input type="checkbox" id="node-config-input-useAuth" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-config-input-useAuth" style="width: 70%;"><span data-i18n="httpin.use-proxyauth"></span></label>
        <div style="margin-left: 20px" class="node-config-input-useAuth-row hide">
            <div class="form-row">
                <label for="node-config-input-username"><i class="fa fa-user"></i> <span data-i18n="common.label.username"></span></label>
                <input type="text" id="node-config-input-username">
            </div>
            <div class="form-row">
                <label for="node-config-input-password"><i class="fa fa-lock"></i> <span data-i18n="common.label.password"></span></label>
                <input type="password" id="node-config-input-password">
            </div>
        </div>
    </div>
    <div class="form-row" style="margin-bottom:0;">
        <label><i class="fa fa-list"></i> <span data-i18n="httpin.noproxy-hosts"></span></label>
    </div>
    <div class="form-row node-config-input-noproxy-container-row">
        <ol id="node-config-input-noproxy-container"></ol>
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('http proxy', {
        category: 'config',
        defaults: {
            name: {value:''},
            url: {
                value:'',
                validate:function(v, opt) {
                    if ((v && (v.indexOf('://') !== -1) &&
                         (v.trim().indexOf('http') === 0))) {
                        return true;
                    }
                    return RED._("node-red:httpin.errors.invalid-url");
                }
            },
            noproxy: {value:[]}
        },
        credentials: {
            username: {type:'text'},
            password: {type:'password'}
        },
        label: function() {
            return this.name || this.url || ('http proxy:' + this.id);
        },
        oneditprepare: function() {
            $('#node-config-input-useAuth').on("change", function() {
                if ($(this).is(":checked")) {
                    $('.node-config-input-useAuth-row').show();
                } else {
                    $('.node-config-input-useAuth-row').hide();
                    $('#node-config-input-username').val('');
                    $('#node-config-input-password').val('');
                }
            });
            if (this.credentials.username || this.credentials.has_password) {
                $('#node-config-input-useAuth').prop('checked', true);
            } else {
                $('#node-config-input-useAuth').prop('checked', false);
            }
            $('#node-config-input-useAuth').change();

            var hostList = $('#node-config-input-noproxy-container')
                .css({'min-height':'150px','min-width':'450px'})
                .editableList({
                    addItem: function(container, index, data) {
                        var row = $('<div/>')
                            .css({overflow: 'hidden',whiteSpace: 'nowrap'})
                            .appendTo(container);

                        var hostField = $('<input/>',{class:'node-config-input-host',type:'text',placeholder:'hostname'})
                            .css({width:'100%'})
                            .appendTo(row);
                        if (data.host) {
                            hostField.val(data.host);
                        }
                    },
                    sortable: true,
                    removable: true
                });
            if (this.noproxy) {
                for (var i in this.noproxy) {
                    hostList.editableList('addItem', {host:this.noproxy[i]});
                }
            }
            if (hostList.editableList('items').length == 0) {
                hostList.editableList('addItem', {host:''});
            }
        },
        oneditsave: function() {
            var hosts = $('#node-config-input-noproxy-container').editableList('items');
            var node = this;
            node.noproxy = [];
            hosts.each(function(i) {
                var host = $(this).find('.node-config-input-host').val().trim();
                if (host) {
                    node.noproxy.push(host);
                }
            });
        },
        oneditresize: function(size) {
            var rows = $('#node-config-dialog-edit-form>div:not(.node-config-input-noproxy-container-row)');
            var height = size.height;
            for (var i = 0; i < rows.length; i++) {
                height -= $(rows[i]).outerHeight(true);
            }

            var editorRow = $('#node-config-dialog-edit-form>div.node-config-input-noproxy-container-row');
            height -= (parseInt(editorRow.css('margin-top')) + parseInt(editorRow.css('margin-bottom')));
            $('#node-config-input-noproxy-container').editableList('height',height);
        }
    });
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="http proxy">
    <p>Configuration options for HTTP proxy.</p>

    <h3>Details</h3>
    <p>When accessing to the host in the ignored host list, no proxy will be used.</p>
</script>

<!-- --- [red-module:node-red/mqtt] --- -->
<!--
  Copyright JS Foundation and other contributors, http://js.foundation
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at
  http://www.apache.org/licenses/LICENSE-2.0
  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<style>

    .mqtt-form-row-cols2 > input.mqtt-form-row-col1 {
        width: calc(35% - 75px);
    }
    .mqtt-form-row-cols2 > select.mqtt-form-row-col1 {
        width: calc(35% - 75px);
    }

    .mqtt-form-row-cols2 > label.mqtt-form-row-col2 {
        width: 100px;
        margin-left: 42px;
        display: inline-block;
    }
    .mqtt-form-row-cols2 > input.mqtt-form-row-col2 {
        width: calc(35% - 75px);
        display: inline-block;
    }
    .mqtt-form-row-cols2 > select.mqtt-form-row-col2 {
        width: calc(35% - 75px);
        display: inline-block;
    }
    .form-row.mqtt5-out > label {
        width: 130px;
    }
    .form-row.mqtt-flags-row > label {
        vertical-align: top;
    }
    .form-row.mqtt-flags-row > .mqtt-flags {
        display: inline-block;
        width: 70%
    }

    .form-row.mqtt-flags-row > .mqtt-flags > .mqtt-flag > label {
        display: block;
        width: 100%;
    }
    .form-row.mqtt-flags-row > .mqtt-flags > .mqtt-flag > label > input {
        position: relative;
        vertical-align: bottom;
        top: -2px;
        width: 15px;
        height: 15px;
    }
    .form-row-mqtt5 {
        display: none;
    }
    .form-row-mqtt5.form-row-mqtt5-active:not(.form-row-mqtt-static-disabled) {
        display: block
    }
    .form-row-mqtt-static-disabled {
        display: none;
        /* opacity: 0.3;
        pointer-events: none; */
    }
    .form-row.form-row-mqtt-datatype-tip > .form-tips {
        width: calc(70% - 18px);
        display: inline-block;
        margin-top: -8px;
    }

</style>

<script type="text/html" data-template-name="mqtt in">
    <div class="form-row">
        <label for="node-input-broker"><i class="fa fa-globe"></i> <span data-i18n="mqtt.label.broker"></span></label>
        <input type="text" id="node-input-broker">
    </div>
    <div class="form-row">
        <label for="node-input-topicType" data-i18n="mqtt.label.action"></label>
        <select id="node-input-topicType" style="width: 70%">
            <option value="topic" data-i18n="mqtt.label.staticTopic"></option>
            <option value="dynamic" data-i18n="mqtt.label.dynamicTopic"></option>
        </select>
        <input type="hidden" id="node-input-inputs">
    </div>
    <div class="form-row form-row-mqtt-static">
        <label for="node-input-topic"><i class="fa fa-tasks"></i> <span data-i18n="common.label.topic"></span></label>
        <input type="text" id="node-input-topic" data-i18n="[placeholder]common.label.topic">
    </div>
    <div class="form-row form-row-mqtt-static">
        <label for="node-input-qos"><i class="fa fa-empire"></i> <span data-i18n="mqtt.label.qos"></span></label>
        <select id="node-input-qos" style="width:125px !important">
            <option value="0">0</option>
            <option value="1">1</option>
            <option value="2">2</option>
        </select>
    </div>
    <div class="form-row mqtt-flags-row form-row-mqtt5 form-row-mqtt-static">
        <label for="node-input-nl" ><i class="fa fa-flag"></i> <span data-i18n="mqtt.label.flags">Flags</span></label>
        <div class="mqtt-flags">
            <div class="mqtt-flag">
                <label for="node-input-nl">
                    <input type="checkbox" id="node-input-nl">
                    <span data-i18n="mqtt.label.nl"></span>
                </label>
            </div>
            <div class="mqtt-flag">
                <label for="node-input-rap">
                    <input type="checkbox" id="node-input-rap">
                    <span data-i18n="mqtt.label.rap"></span>
                </label>
            </div>
        </div>
    </div>
    <div class="form-row form-row-mqtt5 form-row-mqtt-static">
        <label for="node-input-rh" style="width:100%"><i class="fa fa-tag"></i> <span data-i18n="mqtt.label.rh"></span></label>
        <select id="node-input-rh" style="margin-left: 104px; width: 70%">
            <option value="0" data-i18n="mqtt.label.rh0"></option>
            <option value="1" data-i18n="mqtt.label.rh1"></option>
            <option value="2" data-i18n="mqtt.label.rh2"></option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-datatype"><i class="fa fa-sign-out"></i> <span data-i18n="mqtt.label.output"></span></label>
        <select id="node-input-datatype" style="width:70%;">
            <option value="auto-detect" data-i18n="mqtt.output.auto-detect"></option>
            <option value="auto" data-i18n="mqtt.output.auto"></option>
            <option value="buffer" data-i18n="mqtt.output.buffer"></option>
            <option value="utf8" data-i18n="mqtt.output.string"></option>
            <option value="json" data-i18n="mqtt.output.json"></option>
            <option value="base64" data-i18n="mqtt.output.base64"></option>
        </select>
    </div>
    <div class="form-row form-row-mqtt-datatype-tip">
        <label> &nbsp; </label>
        <div class="form-tips" id="mqtt-in-datatype-depreciated-tip"><span data-i18n="mqtt.label.auto-mode-depreciated"></span></div>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
</script>

<script type="text/html" data-template-name="mqtt out">
    <div class="form-row">
        <label for="node-input-broker"><i class="fa fa-globe"></i> <span data-i18n="mqtt.label.broker"></span></label>
        <input type="text" id="node-input-broker">
    </div>
    <div class="form-row">
        <label for="node-input-topic"><i class="fa fa-tasks"></i> <span data-i18n="common.label.topic"></span></label>
        <input type="text" id="node-input-topic" data-i18n="[placeholder]common.label.topic">
    </div>

    <div class="form-row mqtt-form-row-cols2">
        <label for="node-input-qos" class="mqtt-form-row-col1"><i class="fa fa-empire"></i> <span data-i18n="mqtt.label.qos"></span></label>
        <select id="node-input-qos" class="mqtt-form-row-col1">
            <option value=""></option>
            <option value="0">0</option>
            <option value="1">1</option>
            <option value="2">2</option>
        </select>

        <label for="node-input-retain" class="mqtt-form-row-col2"><i class="fa fa-history"></i> <span data-i18n="mqtt.retain"></span></label>
        <select id="node-input-retain" class="mqtt-form-row-col2" >
            <option value=""></option>
            <option value="false" data-i18n="mqtt.false"></option>
            <option value="true" data-i18n="mqtt.true"></option>
        </select>
    </div>
    <div class="form-row mqtt5 mqtt5-out">
        <label for="node-input-userProps"><span data-i18n="mqtt.label.userProperties"></span></label>
        <input type="text" id="node-input-userProps" style="width: calc(100% - 166px);">
    </div>
    <div class="form-row mqtt5 mqtt5-out">
        <label for="node-input-respTopic"><span data-i18n="mqtt.label.responseTopic"></span></label>
        <input type="text" id="node-input-respTopic" style="width: calc(100% - 166px);">
    </div>
    <div class="form-row mqtt5 mqtt5-out">
        <label for="node-input-correl"><span data-i18n="mqtt.label.correlationData"></span></label>
        <input type="text" id="node-input-correl" style="width: calc(100% - 166px);">
    </div>
    <div class="form-row mqtt5 mqtt5-out">
        <label for="node-input-contentType"><span data-i18n="mqtt.label.contentType"></span></label>
        <input type="text" id="node-input-contentType" style="width: calc(100% - 166px);">
    </div>

    <div class="form-row mqtt-form-row-cols2 mqtt5 mqtt5-out">
        <label for="node-input-expiry" class="mqtt-form-row-col1"><span data-i18n="mqtt.label.expiry"></span></label>
        <input id="node-input-expiry"  style="width: calc(100% - 166px);" class="mqtt-form-row-col1" >
    </div>

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
    <div class="form-tips"><span data-i18n="mqtt.tip"></span></div>
</script>

<script type="text/html" data-template-name="mqtt-broker">
    <div class="form-row">
        <label for="node-config-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-config-input-name" data-i18n="[placeholder]common.label.name">
    </div>
    <div class="form-row">
        <ul style="min-width: 600px; margin-bottom: 20px;" id="node-config-mqtt-broker-tabs"></ul>
    </div>
    <div id="node-config-mqtt-broker-tabs-content" style="min-height:150px;">
        <div id="mqtt-broker-tab-connection" style="display:none">
            <div class="form-row node-input-broker">
                <label for="node-config-input-broker"><i class="fa fa-globe"></i> <span data-i18n="mqtt.label.broker"></span></label>
                <input type="text" id="node-config-input-broker" style="width: calc(100% - 300px);" data-i18n="[placeholder]mqtt.label.example">
                <label for="node-config-input-port" style="margin-left:20px; width:43px; "> <span data-i18n="mqtt.label.port"></span></label>
                <input type="text" id="node-config-input-port" data-i18n="[placeholder]mqtt.label.port" style="width:55px">
            </div>
            <div class="form-row" style="margin-bottom:0">
                <input type="checkbox" id="node-config-input-autoConnect" style="margin: 0 5px 0 104px; display: inline-block; width: auto;">
                <label for="node-config-input-autoConnect" style="width: auto"><span data-i18n="mqtt.label.auto-connect"></span></label>
            </div>
            <div class="form-row" style="height: 34px;">
                <input type="checkbox" id="node-config-input-usetls" style="height: 34px; margin: 0 5px 0 104px; display: inline-block; width: auto; vertical-align: top;">
                <label for="node-config-input-usetls" style="width: 100px; line-height: 34px;"><span data-i18n="mqtt.label.use-tls"></span></label>
                <span id="node-config-row-tls" class="hide"><input style="width: 320px;" type="text" id="node-config-input-tls"></span>
            </div>
            <div class="form-row">
                <label for="node-config-input-protocolVersion"><i class="fa fa-cog"></i> <span data-i18n="mqtt.label.protocolVersion"></span></label>
                <select id="node-config-input-protocolVersion" style="width:70%;">
                    <option value="3" data-i18n="mqtt.label.protocolVersion3"></option>
                    <option value="4" data-i18n="mqtt.label.protocolVersion4"></option>
                    <option value="5" data-i18n="mqtt.label.protocolVersion5"></option>
                </select>
            </div>
            <div class="form-row">
                <label for="node-config-input-clientid"><i class="fa fa-tag"></i> <span data-i18n="mqtt.label.clientid"></span></label>
                <input type="text" id="node-config-input-clientid" data-i18n="[placeholder]mqtt.placeholder.clientid">
            </div>
            <div class="form-row">
                <label for="node-config-input-keepalive"><i class="fa fa-heartbeat"></i> <span data-i18n="mqtt.label.keepalive"></span></label>
                <input type="number" min="0" id="node-config-input-keepalive" style="width: 100px">
            </div>
            <div class="form-row" style="margin-bottom:0">
                <label style="vertical-align:top;"><i class="fa fa-info"></i> <span data-i18n="mqtt.label.session"></span></label>
                <div style="display: inline-block; width:calc(100% - 110px)">
                    <div class="form-row">
                        <label for="node-config-input-cleansession" style="width: auto;">
                            <input type="checkbox" id="node-config-input-cleansession" style="position: relative;vertical-align: bottom; top: -2px; width: 15px;height: 15px;">
                            <span id="node-config-input-cleansession-label" data-i18n="mqtt.label.cleansession"></span>
                        </label>
                    </div>
                    <div class="form-row mqtt-persistence">
                        <label for="node-config-input-autoUnsubscribe" style="width: auto;">
                            <input type="checkbox" id="node-config-input-autoUnsubscribe" style="position: relative;vertical-align: bottom; top: -2px; width: 15px;height: 15px;">
                            <span id="node-config-input-autoUnsubscribe-label" data-i18n="mqtt.label.autoUnsubscribe"></span>
                        </label>
                    </div>
                    <div class="form-row mqtt5">
                        <label style="width:auto" for="node-config-input-sessionExpiry"><span data-i18n="mqtt.label.sessionExpiry"></span></label>
                        <input type="number" min="0" id="node-config-input-sessionExpiry" style="width: 100px" >
                    </div>
                </div>
            </div>
            <div class="form-row mqtt5">
                <label style="width: 125px;" for="node-config-input-userProps"><span data-i18n="mqtt.label.userProperties"></span></label>
                <input type="text" id="node-config-input-userProps" style="width: calc(100% - 166px);">
            </div>
            <br>
        </div>
        <div id="mqtt-broker-tab-security" style="display:none">
            <div class="form-row">
                <label for="node-config-input-user"><i class="fa fa-user"></i> <span data-i18n="common.label.username"></span></label>
                <input type="text" id="node-config-input-user">
            </div>
            <div class="form-row">
                <label for="node-config-input-password"><i class="fa fa-lock"></i> <span data-i18n="common.label.password"></span></label>
                <input type="password" id="node-config-input-password">
            </div>
        </div>
        <div id="mqtt-broker-tab-messages" style="display:none">
            <div id="mqtt-broker-section-birth">
                <div class="red-ui-palette-header">
                    <i class="fa fa-angle-down"></i><span data-i18n="mqtt.sections-label.birth-message"></span>
                </div>
                <div class="section-content" style="padding:10px 0 0 10px">
                    <div class="form-row">
                        <label style="width: 100px !important;" for="node-config-input-birthTopic"><i class="fa fa-tasks"></i> <span data-i18n="common.label.topic"></span></label>
                        <input style="width: calc(100% - 300px) !important" type="text" id="node-config-input-birthTopic" data-i18n="[placeholder]mqtt.placeholder.birth-topic">
                        <label style="margin-left: 10px; width: 90px !important;" for="node-config-input-birthRetain"><i class="fa fa-history"></i> <span data-i18n="mqtt.label.retain"></span></label>
                        <select id="node-config-input-birthRetain" style="width:75px !important">
                            <option value="false" data-i18n="mqtt.false"></option>
                            <option value="true" data-i18n="mqtt.true"></option>
                        </select>
                    </div>
                    <div class="form-row">
                        <label style="width: 100px !important;" for="node-config-input-birthPayload"><i class="fa fa-envelope"></i> <span data-i18n="common.label.payload"></span></label>
                        <input style="width: calc(100% - 300px) !important" type="text" id="node-config-input-birthPayload" style="width:300px" data-i18n="[placeholder]common.label.payload">
                        <label style="margin-left: 10px; width: 90px !important;" for="node-config-input-birthQos"><i class="fa fa-empire"></i> <span data-i18n="mqtt.label.qos"></span></label>
                        <select id="node-config-input-birthQos" style="width:75px !important">
                            <option value="0">0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                        </select>
                    </div>
                    <div class="form-row mqtt5 mqtt5-out">
                        <label for="node-config-input-birth-contentType" data-i18n="mqtt.label.contentType"></label>
                        <input type="text" style="width:calc(100% - 200px);" id="node-config-input-birth-contentType">
                    </div>
                    <div class="form-row mqtt5 mqtt5-out">
                        <label for="node-config-input-birth-props" data-i18n="mqtt.label.userProperties"></label>
                        <input type="text" style="width:calc(100% - 200px);" id="node-config-input-birth-props">
                    </div>
                    <div class="form-row mqtt5 mqtt5-out">
                        <label for="node-config-input-birth-respTopic"><span data-i18n="mqtt.label.responseTopic"></span></label>
                        <input type="text" id="node-config-input-birth-respTopic" style="width: calc(100% - 200px);">
                    </div>
                    <div class="form-row mqtt5 mqtt5-out">
                        <label for="node-config-input-birth-correl"><span data-i18n="mqtt.label.correlationData"></span></label>
                        <input type="text" id="node-config-input-birth-correl" style="width: calc(100% - 200px);">
                    </div>
                    <div class="form-row mqtt5 mqtt5-out">
                        <label for="node-config-input-birth-expiry"><span data-i18n="mqtt.label.expiry"></span></label>
                        <input id="node-config-input-birth-expiry"  style="width: calc(100% - 200px);">
                    </div>
                </div>
            </div>
            <div id="mqtt-broker-section-close">
                <div class="red-ui-palette-header">
                    <i class="fa fa-angle-down"></i><span data-i18n="mqtt.sections-label.close-message"></span>
                </div>
                <div class="section-content" style="padding:10px 0 0 10px">
                    <div class="form-row">
                        <label style="width: 100px !important;" for="node-config-input-closeTopic"><i class="fa fa-tasks"></i> <span data-i18n="common.label.topic"></span></label>
                        <input style="width: calc(100% - 300px) !important" type="text" id="node-config-input-closeTopic" style="width:300px" data-i18n="[placeholder]mqtt.placeholder.close-topic">
                        <label style="margin-left: 10px; width: 90px !important;" for="node-config-input-closeRetain"><i class="fa fa-history"></i> <span data-i18n="mqtt.label.retain"></span></label>
                        <select id="node-config-input-closeRetain" style="width:75px !important">
                            <option value="false" data-i18n="mqtt.false"></option>
                            <option value="true" data-i18n="mqtt.true"></option>
                        </select>
                    </div>
                    <div class="form-row">
                        <label style="width: 100px !important;" for="node-config-input-closePayload"><i class="fa fa-envelope"></i> <span data-i18n="common.label.payload"></span></label>
                        <input style="width: calc(100% - 300px) !important" type="text" id="node-config-input-closePayload" style="width:300px" data-i18n="[placeholder]common.label.payload">
                        <label style="margin-left: 10px; width: 90px !important;" for="node-config-input-closeQos"><i class="fa fa-empire"></i> <span data-i18n="mqtt.label.qos"></span></label>
                        <select id="node-config-input-closeQos" style="width:75px !important">
                            <option value="0">0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                        </select>
                    </div>
                    <div class="form-row mqtt5 mqtt5-out">
                        <label for="node-config-input-close-contentType" data-i18n="mqtt.label.contentType"></label>
                        <input type="text" style="width:calc(100% - 200px);" id="node-config-input-close-contentType">
                    </div>
                    <div class="form-row mqtt5 mqtt5-out">
                        <label for="node-config-input-close-props" data-i18n="mqtt.label.userProperties"></label>
                        <input type="text" style="width:calc(100% - 200px);" id="node-config-input-close-props">
                    </div>
                    <div class="form-row mqtt5 mqtt5-out">
                        <label for="node-config-input-close-respTopic"><span data-i18n="mqtt.label.responseTopic"></span></label>
                        <input type="text" id="node-config-input-close-respTopic" style="width: calc(100% - 200px);">
                    </div>
                    <div class="form-row mqtt5 mqtt5-out">
                        <label for="node-config-input-close-correl"><span data-i18n="mqtt.label.correlationData"></span></label>
                        <input type="text" id="node-config-input-close-correl" style="width: calc(100% - 200px);">
                    </div>
                    <div class="form-row mqtt5 mqtt5-out">
                        <label for="node-config-input-close-expiry"><span data-i18n="mqtt.label.expiry"></span></label>
                        <input id="node-config-input-close-expiry"  style="width: calc(100% - 200px);">
                    </div>
                </div>
            </div>
            <div id="mqtt-broker-section-will">
                <div class="red-ui-palette-header">
                    <i class="fa fa-angle-down"></i><span data-i18n="mqtt.sections-label.will-message"></span>
                </div>
                <div class="section-content" style="padding:10px 0 0 10px">
                    <div class="form-row">
                        <label style="width: 100px !important;" for="node-config-input-willTopic"><i class="fa fa-tasks"></i> <span data-i18n="common.label.topic"></span></label>
                        <input style="width: calc(100% - 300px) !important" type="text" id="node-config-input-willTopic" style="width:300px" data-i18n="[placeholder]mqtt.placeholder.will-topic">
                        <label style="margin-left: 10px; width: 90px !important;" for="node-config-input-willRetain"><i class="fa fa-history"></i> <span data-i18n="mqtt.label.retain"></span></label>
                        <select id="node-config-input-willRetain" style="width:75px !important">
                            <option value="false" data-i18n="mqtt.false"></option>
                            <option value="true" data-i18n="mqtt.true"></option>
                        </select>
                    </div>
                    <div class="form-row">
                        <label style="width: 100px !important;" for="node-config-input-willPayload"><i class="fa fa-envelope"></i> <span data-i18n="common.label.payload"></span></label>
                        <input style="width: calc(100% - 300px) !important" type="text" id="node-config-input-willPayload" style="width:300px" data-i18n="[placeholder]common.label.payload">
                        <label style="margin-left: 10px; width: 90px !important;" for="node-config-input-willQos"><i class="fa fa-empire"></i> <span data-i18n="mqtt.label.qos"></span></label>
                        <select id="node-config-input-willQos" style="width:75px !important">
                            <option value="0">0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                        </select>
                    </div>
                    <div class="form-row mqtt5">
                        <label><span data-i18n="mqtt.label.delay"></span></label>
                        <input type="number" min="0" id="node-config-input-will-delay" style="width: 100px" >
                    </div>
                    <div class="form-row mqtt5 mqtt5-out">
                        <label for="node-config-input-will-contentType" data-i18n="mqtt.label.contentType"></label>
                        <input type="text" style="width:calc(100% - 200px);" id="node-config-input-will-contentType">
                    </div>
                    <div class="form-row mqtt5 mqtt5-out">
                        <label for="node-config-input-will-props" data-i18n="mqtt.label.userProperties"></label>
                        <input type="text" style="width:calc(100% - 200px);" id="node-config-input-will-props">
                    </div>
                    <div class="form-row mqtt5 mqtt5-out">
                        <label for="node-config-input-will-respTopic"><span data-i18n="mqtt.label.responseTopic"></span></label>
                        <input type="text" id="node-config-input-will-respTopic" style="width: calc(100% - 200px);">
                    </div>
                    <div class="form-row mqtt5 mqtt5-out">
                        <label for="node-config-input-will-correl"><span data-i18n="mqtt.label.correlationData"></span></label>
                        <input type="text" id="node-config-input-will-correl" style="width: calc(100% - 200px);">
                    </div>
                    <div class="form-row mqtt5 mqtt5-out">
                        <label for="node-config-input-will-expiry"><span data-i18n="mqtt.label.expiry"></span></label>
                        <input id="node-config-input-will-expiry"  style="width: calc(100% - 200px);">
                    </div>
                </div>
            </div>
        </div>
    </div>
</script>

<script type="text/javascript">
(function() {

    var typedInputNoneOpt = {
        value: 'none',
        label: RED._("node-red:mqtt.label.none"),
        hasValue: false
    };
    var makeTypedInputOpt = function(value){
        return {
            value: value,
            label:value,
            hasValue: false
        }
    }
    var contentTypeOpts = [
        typedInputNoneOpt,
        makeTypedInputOpt("application/json"),
        makeTypedInputOpt("application/octet-stream"),
        makeTypedInputOpt("text/csv"),
        makeTypedInputOpt("text/html"),
        makeTypedInputOpt("text/plain"),
        {
            value: "other",
            label: RED._("node-red:mqtt.label.other"),
            icon: "red/images/typedInput/az.svg"
        }
    ];

    function getDefaultContentType(value) {
        var defaultContentType;
        var matchedContentType = contentTypeOpts.filter(function(v) {
            return v.value === value;
        })
        if (matchedContentType.length > 0) {
            defaultContentType = matchedContentType[0].value;
        }
        if (value && !defaultContentType) {
            defaultContentType = 'other';
        }
        return defaultContentType || 'none'
    }
    /**
     * Test a topic string is valid for publishing
     * @param {string} topic
     * @returns `true` if it is a valid topic
     */
    function validateMQTTPublishTopic(topic, opts) {
        if(!topic || topic == "" || !/[\+#\b\f\n\r\t\v\0]/.test(topic)) {
            return true;
        }
        return RED._("node-red:mqtt.errors.invalid-topic");
    }
    RED.nodes.registerType('mqtt-broker',{
        category: 'config',
        defaults: {
            name: {value:""},
            broker: {value:"",required:true},
            port: {
                value:1883,required:false,
                label: RED._("node-red:mqtt.label.port"),
                validate:RED.validators.number(true)},
            tls: {type:"tls-config",required: false,
                  label:RED._("node-red:mqtt.label.use-tls") },
            clientid: {value:"", validate: function(v, opt) {
                let ok = true;
                if ($("#node-config-input-clientid").length) {
                    // Currently editing the node
                    let needClientId = !$("#node-config-input-cleansession").is(":checked")
                    if (needClientId) {
                        ok = (v||"").length > 0;
                    }
                } else {
                    let needClientId = !(this.cleansession===undefined || this.cleansession)
                    if (needClientId) {
                        ok = (v||"").length > 0;
                    }
                }
                if (!ok) {
                    return RED._("node-red:mqtt.errors.invalid-client-id");
                }
                return true;
            }},
            autoConnect: {value: true},
            usetls: {value: false},
            verifyservercert: { value: false},
            compatmode: { value: false},
            protocolVersion: { value: 4},
            keepalive: {
                value:60,
                label: RED._("node-red:mqtt.label.keepalive"),
                validate:RED.validators.number(false)},
            cleansession: {value: true},
            autoUnsubscribe: {value: true},
            birthTopic: {value:"", validate:validateMQTTPublishTopic},
            birthQos: {value:"0"},
            birthRetain: {value:"false"},
            birthPayload: {value:""},
            birthMsg: { value: {}},
            closeTopic: {value:"", validate:validateMQTTPublishTopic},
            closeQos: {value:"0"},
            closeRetain: {value:"false"},
            closePayload: {value:""},
            closeMsg: { value: {}},
            willTopic: {value:"", validate:validateMQTTPublishTopic},
            willQos: {value:"0"},
            willRetain: {value:"false"},
            willPayload: {value:""},
            willMsg: { value: {}},
            userProps: { value: ""},
            sessionExpiry: {value:0}
        },
        credentials: {
            user: {type:"text"},
            password: {type: "password"}
        },
        label: function() {
            if (this.name) {
                return this.name;
            }
            var b = this.broker;
            if (!b) { b = "undefined"; }
            var lab = "";
            lab = (this.clientid?this.clientid+"@":"")+b;
            if (b.indexOf("://") === -1){
                if (!this.port){ lab = lab + ":1883"; }
                else { lab = lab + ":" + this.port; }
            }
            return lab;
        },
        oneditprepare: function () {
            var tabs = RED.tabs.create({
                id: "node-config-mqtt-broker-tabs",
                onchange: function(tab) {
                    $("#node-config-mqtt-broker-tabs-content").children().hide();
                    $("#" + tab.id).show();
                }
            });
            tabs.addTab({
                id: "mqtt-broker-tab-connection",
                label: this._("mqtt.tabs-label.connection")
            });
            tabs.addTab({
                id: "mqtt-broker-tab-security",
                label: this._("mqtt.tabs-label.security")
            });

            tabs.addTab({
                id: "mqtt-broker-tab-messages",
                label: this._("mqtt.tabs-label.messages")
            });

            function setUpSection(sectionId, v5Opts, isExpanded) {
                var birthMessageSection = $("#mqtt-broker-section-"+sectionId);
                var paletteHeader = birthMessageSection.find('.red-ui-palette-header');
                var twistie = paletteHeader.find('i');
                var sectionContent = birthMessageSection.find('.section-content');

                function toggleSection(expanded) {
                    twistie.toggleClass('expanded', expanded);
                    sectionContent.toggle(expanded);
                }
                paletteHeader.on("click", function(e) {
                    e.preventDefault();
                    var isExpanded = twistie.hasClass('expanded');
                    toggleSection(!isExpanded);
                });
                toggleSection(isExpanded);
                $("#node-config-input-"+sectionId+"-contentType").val(v5Opts?v5Opts.contentType:"").typedInput({
                    default: getDefaultContentType(v5Opts?v5Opts.contentType:""),
                    types: contentTypeOpts,
                });

                $("#node-config-input-"+sectionId+"-props").val(v5Opts?v5Opts.userProps:"").typedInput({
                    default:  !(v5Opts?v5Opts.userProps:null)? 'none':'json',
                    types: [typedInputNoneOpt, 'json'],
                });
                $("#node-config-input-"+sectionId+"-respTopic").val(v5Opts?v5Opts.respTopic:"").typedInput({
                    default:  !(v5Opts?v5Opts.respTopic:null)? 'none':'str',
                    types: [typedInputNoneOpt, 'str'],
                });
                $("#node-config-input-"+sectionId+"-correl").val(v5Opts?v5Opts.correl:"").typedInput({
                    default:  !(v5Opts?v5Opts.correl:null)? 'none':'str',
                    types: [typedInputNoneOpt, 'str'],
                });
                $("#node-config-input-"+sectionId+"-expiry").val(v5Opts?v5Opts.expiry:"").typedInput({
                    default:  !(v5Opts?v5Opts.expiry:null)? 'none':'num',
                    types: [typedInputNoneOpt, 'num'],
                });
            }

            // show first section if none are set so the user gets the idea
            var showBirthSection = this.birthTopic !== ""
                || this.willTopic === ""
                && this.birthTopic === ""
                && this.closeTopic == "";
            setUpSection('birth', this.birthMsg, showBirthSection);
            setUpSection('close', this.closeMsg, this.closeTopic !== "");
            setUpSection('will', this.willMsg, this.willTopic !== "");

            if (this.willMsg) {
                $("#node-config-input-will-delay").val(this.willMsg.delay);
            }

            setTimeout(function() { tabs.resize(); },0);
            if (typeof this.cleansession === 'undefined') {
                this.cleansession = true;
                $("#node-config-input-cleansession").prop("checked",true);
            }
            if (typeof this.autoUnsubscribe === 'undefined') {
                this.autoUnsubscribe = true;
                $("#node-config-input-autoUnsubscribe").prop("checked",true);
            }
            if (typeof this.usetls === 'undefined') {
                this.usetls = false;
                $("#node-config-input-usetls").prop("checked",false);
            }
            if (typeof this.autoConnect === 'undefined') {
                this.autoConnect = true;
                $("#node-config-input-autoConnect").prop("checked",true);
            }
            if (this.compatmode === 'true' || this.compatmode === true) {
                delete this.compatmode;
                this.protocolVersion = 4;
            }
            if (typeof this.protocolVersion === 'undefined') {
                this.protocolVersion = 4;
            }
            $("#node-config-input-cleansession").on("change", function() {
                const useCleanSession = $("#node-config-input-cleansession").is(':checked');
                if(useCleanSession) {
                    $("div.form-row.mqtt-persistence").hide();
                } else {
                    $("div.form-row.mqtt-persistence").show();
                }
            });
            $("#node-config-input-protocolVersion").on("change", function() {
                var v5 = $("#node-config-input-protocolVersion").val() == "5";
                if(v5) {
                    $("#node-config-input-cleansession-label").text(RED._("node-red:mqtt.label.cleanstart"))
                    $("div.form-row.mqtt5").show();
                } else {
                    $("#node-config-input-cleansession-label").text(RED._("node-red:mqtt.label.cleansession"))
                    $("div.form-row.mqtt5").hide();
                }
            });
            $("#node-config-input-protocolVersion").val(this.protocolVersion);
            $("#node-config-input-userProps").typedInput({
                default:  !this.userProps ? 'none':'json',
                types: [typedInputNoneOpt, 'json']
            });
            $("#node-config-input-userProps").typedInput('value',this.userProps);
            if (typeof this.keepalive === 'undefined') {
                this.keepalive = 15;
                $("#node-config-input-keepalive").val(this.keepalive);
            }
            if (typeof this.birthQos === 'undefined') {
                this.birthQos = "0";
                $("#node-config-input-birthQos").val("0");
            }
            if (typeof this.closeQos === 'undefined') {
                this.willQos = "0";
                $("#node-config-input-willQos").val("0");
            }
            if (typeof this.willQos === 'undefined') {
                this.willQos = "0";
                $("#node-config-input-willQos").val("0");
            }


            function updateTLSOptions() {
                if ($("#node-config-input-usetls").is(':checked')) {
                    $("#node-config-row-tls").show();
                } else {
                    $("#node-config-row-tls").hide();
                }
            }
            updateTLSOptions();
            $("#node-config-input-usetls").on("click",function() {
                updateTLSOptions();
            });
            var node = this;
            function updateClientId() {
                if ($("#node-config-input-cleansession").is(":checked")) {
                    $("#node-config-input-clientid").attr("placeholder",node._("mqtt.placeholder.clientid"));
                } else {
                    $("#node-config-input-clientid").attr("placeholder",node._("mqtt.placeholder.clientid-nonclean"));
                }
                $("#node-config-input-clientid").trigger("change");
            }
            setTimeout(updateClientId,0);
            $("#node-config-input-cleansession").on("click",function() {
                updateClientId();
            });

            function updatePortEntry(){
                var disabled = $("#node-config-input-port").prop("disabled");
                if ($("#node-config-input-broker").val().indexOf("://") === -1){
                    if (disabled){
                        $("#node-config-input-port").prop("disabled", false);
                    }
                }
                else {
                    if (!disabled){
                        $("#node-config-input-port").prop("disabled", true);
                    }
                }
            }
            $("#node-config-input-broker").on("change", function() {
                updatePortEntry();
            });
            $("#node-config-input-broker").on( "keyup", function() {
                updatePortEntry();
            });
            setTimeout(updatePortEntry,50);
            setTimeout(function() {
                $("#node-config-input-protocolVersion").trigger("change");
            },50);

        },
        oneditsave: function() {
            if (!$("#node-config-input-usetls").is(':checked')) {
                $("#node-config-input-tls").val("");
            }

            var v5 = $("#node-config-input-protocolVersion").val() == "5";

            function saveV5Message(section) {
                var msg = {};
                if ($("#node-config-input-"+section+"Topic").val().trim().length > 0) {
                    var contentType = $("#node-config-input-"+section+"-contentType").val().trim();
                    if (contentType === '') {
                        contentType = $("#node-config-input-"+section+"-contentType").typedInput('type');
                        if (contentType === 'none' || contentType === 'other') {
                            contentType = "";
                        }
                    }
                    if (contentType) {
                        msg.contentType = contentType;
                    }
                    var props = $("#node-config-input-"+section+"-props").val().trim();
                    if (props) {
                        msg.userProps = props;
                    }
                    var resp = $("#node-config-input-"+section+"-respTopic").val().trim();
                    if (props) {
                        msg.respTopic = resp;
                    }
                    var correl = $("#node-config-input-"+section+"-correl").val().trim();
                    if (correl) {
                        msg.correl = correl;
                    }
                    var expiry = $("#node-config-input-"+section+"-expiry").val().trim();
                    if (expiry) {
                        msg.expiry = expiry;
                    }
                }
                return msg;
            }

            if (v5) {
                this.userProps = "";
                const userPropsType = $("#node-config-input-userProps").typedInput("type");
                if(userPropsType == "json") {
                    const userProps = $("#node-config-input-userProps").val();
                    if (userProps && typeof userProps === "string") {
                        this.userProps = userProps.trim();
                    }
                }
                this.birthMsg = saveV5Message("birth");
                this.closeMsg = saveV5Message("close");
                this.willMsg = saveV5Message("will");
                var willDelay = $("#node-config-input-will-delay").val();
                if (willDelay) {
                    this.willMsg.delay = willDelay;
                }
            } else {
                this.willMsg = {};
                this.birthMsg = {};
                this.closeMsg = {};
            }

        }
    });

    RED.nodes.registerType('mqtt in',{
        category: 'network',
        defaults: {
            name: {value:""},
            topic: {
                value:"",
                validate: function(v, opt) {
                    var isDynamic = this.inputs === 1;
                    var topicTypeSelect = $("#node-input-topicType");
                    if (topicTypeSelect.length) {
                        isDynamic = topicTypeSelect.val()==='dynamic'
                    }
                    if (isDynamic || ((!!v) && RED.validators.regex(/^(#$|(\+|[^+#]*)(\/(\+|[^+#]*))*(\/(\+|#|[^+#]*))?$)/)(v))) {
                        return true;
                    }
                    return RED._("node-red:mqtt.errors.invalid-topic");
                }
            },
            qos: {value: "2"},
            datatype: {value:"auto-detect",required:true},
            broker: {type:"mqtt-broker", required:true, label:RED._("node-red:mqtt.label.broker")},
            // subscriptionIdentifier: {value:0},
            nl: {value:false},
            rap: {value:true},
            rh: {value:0},
            inputs: {value:0},
        },
        color:"#d8bfd8",
        inputs:0,
        outputs:1,
        icon: "bridge.svg",
        label: function() {
            var label = "mqtt";
            if(this.topicType !== "dynamic" && this.topic) {
                label = this.topic;
            }
            return this.name || label;
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            const node = this;
            const isV5Broker = function() {
                var confNode = RED.nodes.node($("#node-input-broker").val());
                return confNode && confNode.protocolVersion === "5";
            }
            const isDynamic = function() {
                return $('#node-input-topicType').val() === "dynamic";
            }
            const updateVisibility = function() {
                var v5 = isV5Broker();
                var dynamic = isDynamic();
                $("div.form-row-mqtt5").toggleClass("form-row-mqtt5-active",!!v5);
                $("div.form-row.form-row-mqtt-static").toggleClass("form-row-mqtt-static-disabled", !!dynamic)
            }

            $("#node-input-datatype").on("change", function() {
                if($(this).val() === "auto") {
                    $(".form-row.form-row-mqtt-datatype-tip").show();
                } else {
                    $(".form-row.form-row-mqtt-datatype-tip").hide();
                }
            })
            $("#node-input-datatype").trigger("change");

            $("#node-input-broker").on("change",function(d){
                updateVisibility();
            });

            $('#node-input-topicType').on("change", function () {
                $("#node-input-inputs").val(isDynamic() ? 1 : 0);
                updateVisibility();
            });

            if (this.inputs === 1) {
                $('#node-input-topicType').val('dynamic')
            } else {
                $('#node-input-topicType').val('topic')
            }
            $('#node-input-topicType').trigger("change");

            if (this.qos === undefined) {
                $("#node-input-qos").val("2");
            }
            if (this.datatype === undefined) {
                $("#node-input-datatype").val("auto-detect");
            }
        },
        oneditsave: function() {
            if ($('#node-input-topicType').val() === "dynamic") {
                $('#node-input-topic').val("");
            }
        }
    });

    RED.nodes.registerType('mqtt out',{
        category: 'network',
        defaults: {
            name: {value:""},
            topic: {value:"", validate:validateMQTTPublishTopic},
            qos: {value:""},
            retain: {value:""},
            respTopic: {value:""},
            contentType: {value:""},
            userProps: {value:''},
            correl: {value:''},
            expiry: {value:''},
            broker: {type:"mqtt-broker", required:true,
                     label:RED._("node-red:mqtt.label.broker") }
        },
        color:"#d8bfd8",
        inputs:1,
        outputs:0,
        icon: "bridge.svg",
        align: "right",
        label: function() {
            return this.name||this.topic||"mqtt";
        },
        oneditprepare: function() {
            var that = this;

            function showHideDynamicFields() {
                var confNode = RED.nodes.node($("#node-input-broker").val());
                var v5 = confNode && confNode.protocolVersion == "5";
                if(v5) {
                    $("div.form-row.mqtt5").show();
                    var t = $("#node-input-respTopic").typedInput("type");
                    if (t == 'none') {
                        $("#node-input-correl").parent().hide();
                    } else {
                        $("#node-input-correl").parent().show();
                    }
                } else {
                    $("div.form-row.mqtt5").hide();
                }
            }

            $("#node-input-broker").on("change",function(d){
                showHideDynamicFields();
            });

            var respTopicTI = $("#node-input-respTopic").typedInput({
                default: !this.respTopic ? 'none':'str',
                types: [typedInputNoneOpt,  'str'],
            });

            var correlTI = $("#node-input-correl").typedInput({
                default: !this.correl ? 'none':'str',
                types: [typedInputNoneOpt,  'str']
            });
            //show / hide correlation data depending on respTopic
            respTopicTI.on("change", showHideDynamicFields);
            respTopicTI.triggerHandler("change");

            $("#node-input-userProps").typedInput({
                default:  !this.userProps ? 'none':'json',
                types: [typedInputNoneOpt, 'json'],
            });
            $("#node-input-expiry").typedInput({
                default: !this.expiry ? 'none':'num',
                types: [typedInputNoneOpt,  'num']
            });
            $("#node-input-contentType").typedInput({
                default: getDefaultContentType(this.contentType),
                types: contentTypeOpts
            })
        },
        oneditsave: function() {

            var contentType = $("#node-input-contentType").val().trim();
            if (contentType === '') {
                contentType = $("#node-input-contentType").typedInput('type');
                if (contentType === 'none' || contentType === 'other') {
                    contentType = "";
                }
            }
            $("#node-input-contentType").val(contentType)

        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        }
    });
})();
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at
  http://www.apache.org/licenses/LICENSE-2.0
  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="mqtt in">
<p>Connects to a MQTT broker and subscribes to messages from the specified topic.</p>
    <h3>Outputs</h3>
    <dl class="message-properties">
       <dt>payload <span class="property-type">string | buffer</span></dt>
       <dd>a string unless detected as a binary buffer.</dd>
       <dt>topic <span class="property-type">string</span></dt>
       <dd>the MQTT topic, uses / as a hierarchy separator.</dd>
       <dt>qos <span class="property-type">number</span> </dt>
       <dd>0, fire and forget - 1, at least once - 2, once and once only.</dd>
       <dt>retain <span class="property-type">boolean</span></dt>
       <dd>true indicates the message was retained and may be old.</dd>

       <dt class="optional">responseTopic <span class="property-type">string</span></dt>
       <dd><b>MQTTv5</b>: the MQTT response topic for the message</dd>
       <dt class="optional">correlationData <span class="property-type">Buffer</span></dt>
       <dd><b>MQTTv5</b>: the correlation data for the message</dd>
       <dt class="optional">contentType <span class="property-type">string</span></dt>
       <dd><b>MQTTv5</b>: the content-type of the payload</dd>
       <dt class="optional">userProperties <span class="property-type">object</span></dt>
       <dd><b>MQTTv5</b>: any user properties of the message</dd>
       <dt class="optional">messageExpiryInterval <span class="property-type">number</span></dt>
       <dd><b>MQTTv5</b>: the expiry time, in seconds, of the message</dd>
    </dl>
    <h3>Details</h3>
    The subscription topic can include MQTT wildcards, + for one level, # for multiple levels.</p>
    <p>This node requires a connection to a MQTT broker to be configured. This is configured by clicking
    the pencil icon.</p>
    <p>Several MQTT nodes (in or out) can share the same broker connection if required.</p>
    <h4>Dynamic Subscription</h4>
    The node can be configured to dynamically control the MQTT connection and its subscriptions. When
    enabled, the node will have an input and can be controlled by passing it messages.
    <h3>Inputs</h3>
    <p>These only apply when the node has been configured for dynamic subscriptions.</p>
    <dl class="message-properties">
       <dt>action <span class="property-type">string</span></dt>
       <dd>the name of the action the node should perform. Available actions are: <code>"connect"</code>,
       <code>"disconnect"</code>, <code>"subscribe"</code> and <code>"unsubscribe"</code>.</dd>
       <dt class="optional">topic <span class="property-type">string|object|array</span></dt>
       <dd>For the <code>"subscribe"</code> and <code>"unsubscribe"</code> actions, this property
           provides the topic. It can be set as either:<ul>
           <li>a String containing the topic filter</li>
           <li>an Object containing <code>topic</code> and <code>qos</code> properties</li>
           <li>an array of either strings or objects to handle multiple topics in one</li>
            </ul>
        </dd>
       <dt class="optional">broker <span class="property-type">broker</span> </dt>
       <dd>For the <code>"connect"</code> action, this property can override any
           of the individual broker configuration settings, including: <ul>
               <li><code>broker</code></li>
               <li><code>port</code></li>
               <li><code>url</code> - overrides broker/port to provide a complete connection url</li>
               <li><code>username</code></li>
               <li><code>password</code></li>
           </ul>
           <p>If this property is set and the broker is already connected an error
              will be logged unless it has the <code>force</code> property set - in which case it will
              disconnect from the broker, apply the new settings and reconnect.</p>
       </dd>
    </dl>

</script>

<script type="text/html" data-help-name="mqtt out">
    <p>Connects to a MQTT broker and publishes messages.</p>
    <h3>Inputs</h3>
    <dl class="message-properties">
       <dt>payload <span class="property-type">string | buffer</span></dt>
       <dd> the payload to publish. If this property is not set, no message will be sent. To send a blank message, set this property to an empty String.</dd>
       <dt class="optional">topic <span class="property-type">string</span></dt>
       <dd> the MQTT topic to publish to.</dd>
       <dt class="optional">qos <span class="property-type">number</span></dt>
       <dd>0, fire and forget - 1, at least once - 2, once and once only. Default 0.</dd>
       <dt class="optional">retain <span class="property-type">boolean</span></dt>
       <dd>set to true to retain the message on the broker. Default false.</dd>
       <dt class="optional">responseTopic <span class="property-type">string</span></dt>
       <dd><b>MQTTv5</b>: the MQTT response topic for the message</dd>
       <dt class="optional">correlationData <span class="property-type">Buffer</span></dt>
       <dd><b>MQTTv5</b>: the correlation data for the message</dd>
       <dt class="optional">contentType <span class="property-type">string</span></dt>
       <dd><b>MQTTv5</b>: the content-type of the payload</dd>
       <dt class="optional">userProperties <span class="property-type">object</span></dt>
       <dd><b>MQTTv5</b>: any user properties of the message</dd>
       <dt class="optional">messageExpiryInterval <span class="property-type">number</span></dt>
       <dd><b>MQTTv5</b>: the expiry time, in seconds, of the message</dd>
       <dt class="optional">topicAlias <span class="property-type">number</span></dt>
       <dd><b>MQTTv5</b>: the MQTT topic alias to use</dd>
    </dl>
    <h3>Details</h3>
    <code>msg.payload</code> is used as the payload of the published message.
    If it contains an Object it will be converted to a JSON string before being sent.
    If it contains a binary Buffer the message will be published as-is.</p>
    <p>The topic used can be configured in the node or, if left blank, can be set by <code>msg.topic</code>.</p>
    <p>Likewise the QoS and retain values can be configured in the node or, if left
    blank, set by <code>msg.qos</code> and <code>msg.retain</code> respectively. To clear a previously
    retained topic from the broker, send a blank message to that topic with the retain flag set.</p>
    <p>This node requires a connection to a MQTT broker to be configured. This is configured by clicking
    the pencil icon.</p>
    <p>Several MQTT nodes (in or out) can share the same broker connection if required.</p>

    <h4>Dynamic Control</h4>
    The connection shared by the node can be controlled dynamically. If the node receives
    one of the following control messages, it will not publish the message payload as well.
    <h3>Inputs</h3>
    <dl class="message-properties">
       <dt>action <span class="property-type">string</span></dt>
       <dd>the name of the action the node should perform. Available actions are: <code>"connect"</code>,
       and <code>"disconnect"</code>.</dd>
       <dt class="optional">broker <span class="property-type">broker</span> </dt>
       <dd>For the <code>"connect"</code> action, this property can override any
           of the individual broker configuration settings, including: <ul>
               <li><code>broker</code></li>
               <li><code>port</code></li>
               <li><code>url</code> - overrides broker/port to provide a complete connection url</li>
               <li><code>username</code></li>
               <li><code>password</code></li>
           </ul>
           <p>If this property is set and the broker is already connected an error
              will be logged unless it has the <code>force</code> property set - in which case it will
              disconnect from the broker, apply the new settings and reconnect.</p>
       </dd>
    </dl>

</script>

<script type="text/html" data-help-name="mqtt-broker">
    <p>Configuration for a connection to an MQTT broker.</p>
    <p>This configuration will create a single connection to the broker which can
       then be reused by <code>MQTT In</code> and <code>MQTT Out</code> nodes.</p>
    <p>The node will generate a random Client ID if one is not set and the
       node is configured to use a Clean Session connection. If a Client ID is set,
       it must be unique to the broker you are connecting to.</p>
    <h4>Birth Message</h4>
    <p>This is a message that will be published on the configured topic whenever the
       connection is established.</p>
    <h4>Close Message</h4>
    <p>This is a message that will be published on the configured topic before the
       connection is closed normally, either by re-deploying the node, or by shutting down.</p>
    <h4>Will Message</h4>
    <p>This is a message that will be published by the broker in the event the node
       unexpectedly loses its connection.</p>
    <h4>WebSockets</h4>
    <p>The node can be configured to use a WebSocket connection. To do so, the Server
       field should be configured with a full URI for the connection. For example:</p>
    <pre>ws://example.com:4000/mqtt</pre>

</script>

<!-- --- [red-module:node-red/httpin] --- -->
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-template-name="http in">
    <div class="form-row">
        <label for="node-input-method"><i class="fa fa-tasks"></i> <span data-i18n="httpin.label.method"></span></label>
        <select type="text" id="node-input-method" style="width:70%;">
        <option value="get">GET</option>
        <option value="post">POST</option>
        <option value="put">PUT</option>
        <option value="delete">DELETE</option>
        <option value="patch">PATCH</option>
        </select>
    </div>
    <div class="form-row form-row-http-in-upload hide">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-upload" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-upload" style="width: 70%;" data-i18n="httpin.label.upload"></label>
    </div>
    <div class="form-row">
        <label for="node-input-url"><i class="fa fa-globe"></i> <span data-i18n="httpin.label.url"></span></label>
        <input id="node-input-url" type="text" placeholder="/url">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
    <div class="form-row row-swagger-doc">
        <label for="node-input-swaggerDoc"><i class="fa fa-file-text-o"></i> <span data-i18n="httpin.label.doc"></span></label>
        <input type="text" id="node-input-swaggerDoc">
    </div>
    <div id="node-input-tip" class="form-tips"><span data-i18n="httpin.tip.in"></span><code><span id="node-input-path"></span></code>.</div>
</script>

<script type="text/html" data-template-name="http response">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
    <div class="form-row">
        <label for="node-input-statusCode"><i class="fa fa-long-arrow-left"></i> <span data-i18n="httpin.label.status"></span></label>
        <input type="text" id="node-input-statusCode" placeholder="msg.statusCode">
    </div>
    <div class="form-row" style="margin-bottom:0;">
        <label><i class="fa fa-list"></i> <span data-i18n="httpin.label.headers"></span></label>
    </div>
    <div class="form-row node-input-headers-container-row">
        <ol id="node-input-headers-container"></ol>
    </div>
    <div class="form-tips"><span data-i18n="[html]httpin.tip.res"></span></div>
</script>

<script type="text/javascript">
(function() {
    RED.nodes.registerType('http in',{
        category: 'network',
        color:"rgb(231, 231, 174)",
        defaults: {
            name: {value:""},
            url: {value:"", required:true,
                  label:RED._("node-red:httpin.label.url")},
            method: {value:"get",required:true},
            upload: {value:false},
            swaggerDoc: {type:"swagger-doc", required:false}
        },
        inputs:0,
        outputs:1,
        icon: "white-globe.svg",
        label: function() {
            if (this.name) {
                return this.name;
            } else if (this.url) {
                var root = RED.settings.httpNodeRoot;
                if (root.slice(-1) != "/") {
                    root = root+"/";
                }
                if (this.url.charAt(0) == "/") {
                    root += this.url.slice(1);
                } else {
                    root += this.url;
                }
                return "["+this.method+"] "+root;
            } else {
                return "http";
            }
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            var root = RED.settings.httpNodeRoot;
            if (root.slice(-1) == "/") {
                root = root.slice(0,-1);
            }
            if (root == "") {
                $("#node-input-tip").hide();
            } else {
                $("#node-input-path").html(root);
                $("#node-input-tip").show();
            }
            if(!RED.nodes.getType("swagger-doc")){
                $('.row-swagger-doc').hide();
            }
            $("#node-input-method").on("change", function() {
                if ($(this).val() === "post") {
                    $(".form-row-http-in-upload").show();
                } else {
                    $(".form-row-http-in-upload").hide();
                }
            }).change();


        }

    });
    var headerTypes = [
        {value:"content-type",label:"Content-Type",hasValue: false},
        {value:"location",label:"Location",hasValue: false},
        {value:"other",label:RED._("node-red:httpin.label.other"),icon:"red/images/typedInput/az.svg"}
       ]
    var contentTypes = [
        {value:"application/json",label:"application/json",hasValue: false},
        {value:"application/xml",label:"application/xml",hasValue: false},
        {value:"text/css",label:"text/css",hasValue: false},
        {value:"text/html",label:"text/html",hasValue: false},
        {value:"text/plain",label:"text/plain",hasValue: false},
        {value:"image/gif",label:"image/gif",hasValue: false},
        {value:"image/png",label:"image/png",hasValue: false},
        {value:"other",label:RED._("node-red:httpin.label.other"),icon:"red/images/typedInput/az.svg"}
    ];

    RED.nodes.registerType('http response',{
        category: 'network',
        color:"rgb(231, 231, 174)",
        defaults: {
            name: {value:""},
            statusCode: {
                value:"",
                label: RED._("node-red:httpin.label.status"),
                validate: RED.validators.number(true)},
            headers: {value:{}}
        },
        inputs:1,
        outputs:0,
        align: "right",
        icon: "white-globe.svg",
        label: function() {
            return this.name||("http"+(this.statusCode?" ("+this.statusCode+")":""));
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            var headerList = $("#node-input-headers-container").css('min-height','150px').css('min-width','450px').editableList({
                addItem: function(container,i,header) {
                    var row = $('<div/>').css({
                        overflow: 'hidden',
                        whiteSpace: 'nowrap',
                        display: 'flex'
                    }).appendTo(container);
                    var propertNameCell = $('<div/>').css({'flex-grow':1}).appendTo(row);
                    var propertyName = $('<input/>',{class:"node-input-header-name",type:"text", style:"width: 100%"})
                        .appendTo(propertNameCell)
                        .typedInput({types:headerTypes});

                    var propertyValueCell = $('<div/>').css({'flex-grow':1,'margin-left':'10px'}).appendTo(row);
                    var propertyValue = $('<input/>',{class:"node-input-header-value",type:"text",style:"width: 100%"})
                        .appendTo(propertyValueCell)
                        .typedInput({types:
                            header.h === 'content-type'?contentTypes:[{value:"other",label:"other",icon:"red/images/typedInput/az.svg"}]
                        });

                    var matchedType = headerTypes.filter(function(ht) {
                        return ht.value === header.h
                    });
                    if (matchedType.length === 0) {
                        propertyName.typedInput('type','other');
                        propertyName.typedInput('value',header.h);
                        propertyValue.typedInput('value',header.v);
                    } else {
                        propertyName.typedInput('type',header.h);

                        if (header.h === "content-type") {
                            matchedType = contentTypes.filter(function(ct) {
                                return ct.value === header.v;
                            });
                            if (matchedType.length === 0) {
                                propertyValue.typedInput('type','other');
                                propertyValue.typedInput('value',header.v);
                            } else {
                                propertyValue.typedInput('type',header.v);
                            }
                        } else {
                            propertyValue.typedInput('value',header.v);
                        }
                    }

                    matchedType = headerTypes.filter(function(ht) {
                        return ht.value === header.h
                    });
                    if (matchedType.length === 0) {
                        propertyName.typedInput('type','other');
                        propertyName.typedInput('value',header.h);
                    } else {
                        propertyName.typedInput('type',header.h);
                    }

                    propertyName.on('change',function(event) {
                        var type = propertyName.typedInput('type');
                        if (type === 'content-type') {
                            propertyValue.typedInput('types',contentTypes);
                        } else {
                            propertyValue.typedInput('types',[{value:"other",label:"other",icon:"red/images/typedInput/az.svg"}]);
                        }
                    });
                },
                sortable: true,
                removable: true
            });

            if (this.headers) {
                for (var key in this.headers) {
                    if (this.headers.hasOwnProperty(key)) {
                        headerList.editableList('addItem',{h:key,v:this.headers[key]});
                    }
                }
            }
        },
        oneditsave: function() {
            var headers = $("#node-input-headers-container").editableList('items');
            var node = this;
            node.headers = {};
            headers.each(function(i) {
                var header = $(this);
                var keyType = header.find(".node-input-header-name").typedInput('type');
                var keyValue = header.find(".node-input-header-name").typedInput('value');
                var valueType = header.find(".node-input-header-value").typedInput('type');
                var valueValue = header.find(".node-input-header-value").typedInput('value');
                var key = keyType;
                var value = valueType;
                if (keyType === 'other') {
                    key = keyValue;
                }
                if (valueType === 'other') {
                    value = valueValue;
                }
                if (key !== '') {
                    node.headers[key] = value;
                }
            });
        },
        oneditresize: function(size) {
            var rows = $("#dialog-form>div:not(.node-input-headers-container-row)");
            var height = size.height;
            for (var i=0; i<rows.length; i++) {
                height -= $(rows[i]).outerHeight(true);
            }
            var editorRow = $("#dialog-form>div.node-input-headers-container-row");
            height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));

            $("#node-input-headers-container").editableList('height',height);
        }
    });
})();
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="http in">
    <p>Creates an HTTP end-point for creating web services.</p>
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>payload</dt>
        <dd>For a GET request, contains an object of any query string parameters.
            Otherwise, contains the body of the HTTP request.</dd>
        <dt>req<span class="property-type">object</span></dt>
        <dd>An HTTP request object. This object contains multiple properties that
            provide information about the request.
            <ul>
             <li><code>body</code> - the body of the incoming request. The format
                 will depend on the request.</li>
             <li><code>headers</code> - an object containing the HTTP request headers.</li>
             <li><code>query</code> - an object containing any query string parameters.</li>
             <li><code>params</code> - an object containing any route parameters.</li>
             <li><code>cookies</code> - an object containing the cookies for the request.</li>
             <li><code>files</code> - if enabled within the node, an object containing
                 any files uploaded as part of a POST request.</li>
            </ul>
        </dd>
        <dt>res<span class="property-type">object</span></dt>
        <dd>An HTTP response object. This property should not be used directly;
            the <code>HTTP Response</code> node documents how to respond to a request.
            This property must remain attached to the message passed to the response node.</dd>
    </dl>
    <h3>Details</h3>
    <p>The node will listen on the configured path for requests of a particular type.
       The path can be fully specified, such as <code>/user</code>, or include
       named parameters that accept any value, such as <code>/user/:name</code>.
       When named parameters are used, their actual value in a request can be accessed under <code>msg.req.params</code>.</p>
    <p>For requests that include a body, such as a POST or PUT, the contents of
       the request is made available as <code>msg.payload</code>.</p>
    <p>If the content type of the request can be determined, the body will be parsed to
       any appropriate type. For example, <code>application/json</code> will be parsed to
       its JavaScript object representation.</p>
    <p><b>Note:</b> this node does not send any response to the request. The flow
       must include an HTTP Response node to complete the request.</p>
</script>

<script type="text/html" data-help-name="http response">
    <p>Sends responses back to requests received from an HTTP Input node.</p>

    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">string</span></dt>
        <dd>The body of the response.</dd>
        <dt class="optional">statusCode <span class="property-type">number</span></dt>
        <dd>If set, this is used as the response status code. Default: 200.</dd>
        <dt class="optional">headers <span class="property-type">object</span></dt>
        <dd>If set, provides HTTP headers to include in the response.</dd>
        <dt class="optional">cookies <span class="property-type">object</span></dt>
        <dd>If set, can be used to set or delete cookies.</dd>
    </dl>
    <h3>Details</h3>
    <p>The <code>statusCode</code> and <code>headers</code> can also be set within
    the node itself. If a property is set within the node, it cannot be overridden
    by the corresponding message property.</p>
    <h4>Cookie handling</h4>
    <p>The <code>cookies</code> property must be an object of name/value pairs.
    The value can be either a string to set the value of the cookie with default
    options, or it can be an object of options.</p>
    <p>The following example sets two cookies - one called <code>name</code> with
    a value of <code>nick</code>, the other called <code>session</code> with a
    value of <code>1234</code> and an expiry set to 15 minutes.</p>
    <pre>
msg.cookies = {
    name: 'nick',
    session: {
        value: '1234',
        maxAge: 900000
    }
}</pre>
    <p>The valid options include:</p>
    <ul>
    <li><code>domain</code> - (String) domain name for the cookie</li>
    <li><code>expires</code> - (Date) expiry date in GMT. If not specified or set to 0, creates a session cookie</li>
    <li><code>maxAge</code> - (String) expiry date as relative to the current time in milliseconds</li>
    <li><code>path</code> - (String) path for the cookie. Defaults to /</li>
    <li><code>value</code> - (String) the value to use for the cookie</li>
    </ul>
    <p>To delete a cookie, set its <code>value</code> to <code>null</code>.</p>

</script>

<!-- --- [red-module:node-red/httprequest] --- -->
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-template-name="http request">
    <div class="form-row">
        <label for="node-input-method"><i class="fa fa-tasks"></i> <span data-i18n="httpin.label.method"></span></label>
        <select type="text" id="node-input-method" style="width:70%;">
        <option value="GET">GET</option>
        <option value="POST">POST</option>
        <option value="PUT">PUT</option>
        <option value="DELETE">DELETE</option>
        <option value="HEAD">HEAD</option>
        <option value="use" data-i18n="httpin.setby"></option>
        </select>
    </div>

    <div class="form-row">
        <label for="node-input-url"><i class="fa fa-globe"></i> <span data-i18n="httpin.label.url"></span></label>
        <input id="node-input-url" type="text" placeholder="http://">
    </div>

    <div class="form-row node-input-paytoqs-row">
        <label for="node-input-paytoqs"><span data-i18n="common.label.payload"></span></label>
        <select id="node-input-paytoqs" style="width: 70%;">
            <option value="ignore" data-i18n="httpin.label.paytoqs.ignore"></option>
            <option value="query" data-i18n="httpin.label.paytoqs.query"></option>
            <option value="body" data-i18n="httpin.label.paytoqs.body"></option>
        </select>
    </div>

    <div class="form-row">
        <input type="checkbox" id="node-input-usetls" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-usetls" style="width: auto" data-i18n="httpin.use-tls"></label>
        <div id="node-row-tls" class="hide">
            <label style="width: auto; margin-left: 20px; margin-right: 10px;" for="node-input-tls"><span data-i18n="httpin.tls-config"></span></label><input type="text" style="width: 300px" id="node-input-tls">
        </div>
    </div>

    <div class="form-row">
        <input type="checkbox" id="node-input-useAuth" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-useAuth" style="width: 70%;"><span data-i18n="httpin.basicauth"></span></label>
        <div style="margin-left: 20px" class="node-input-useAuth-row hide">
            <div class="form-row">
                <label for="node-input-authType-select"><i class="fa fa-user-secret "></i> <span data-i18n="httpin.label.authType"></span></label>
                <select type="text" id="node-input-authType-select" style="width:70%;">
                    <option value="basic"  data-i18n="httpin.basic"></option>
                    <option value="digest" data-i18n="httpin.digest"></option>
                    <option value="bearer" data-i18n="httpin.bearer"></option>
                </select>
                <input type="hidden" id="node-input-authType">
            </div>
            <div class="form-row node-input-basic-row">
                <label for="node-input-user"><i class="fa fa-user"></i> <span data-i18n="common.label.username"></span></label>
                <input type="text" id="node-input-user">
            </div>
            <div class="form-row">
                <label for="node-input-password"> <i class="fa fa-lock"></i> <span data-i18n="common.label.password" id="node-span-password"></span><span data-i18n="httpin.label.bearerToken" id="node-span-token" style="display:none"></span></label>
                <input type="password" id="node-input-password">
            </div>
        </div>
    </div>

    <div class="form-row">
        <input type="checkbox" id="node-input-persist" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-persist" style="width: auto" data-i18n="httpin.persist"></label>
    </div>

    <div class="form-row">
        <input type="checkbox" id="node-input-useProxy" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-useProxy" style="width: auto;"><span data-i18n="httpin.use-proxy"></span></label>
        <div id="node-input-useProxy-row" class="hide">
            <label style="width: auto; margin-left: 20px; margin-right: 10px;" for="node-input-proxy"><i class="fa fa-globe"></i> <span data-i18n="httpin.proxy-config"></span></label><input type="text" style="width: 270px" id="node-input-proxy">
        </div>
    </div>

    <div class="form-row">
        <input type="checkbox" id="node-input-senderr" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-senderr" style="width: auto" data-i18n="httpin.senderr"></label>
    </div>

    <div class="form-row">
        <input type="checkbox" id="node-input-insecureHTTPParser" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-insecureHTTPParser" style="width: auto;" data-i18n="httpin.insecureHTTPParser"></label>
    </div>


    <div class="form-row">
        <label for="node-input-ret"><i class="fa fa-arrow-left"></i> <span data-i18n="httpin.label.return"></span></label>
        <select type="text" id="node-input-ret" style="width:70%;">
        <option value="txt" data-i18n="httpin.utf8"></option>
        <option value="bin" data-i18n="httpin.binary"></option>
        <option value="obj" data-i18n="httpin.json"></option>
        </select>
    </div>

    <div class="form-row form-tips" id="tip-json" hidden><span data-i18n="httpin.tip.req"></span></div>

    <div class="form-row" style="margin-bottom:0;">
        <label><i class="fa fa-list"></i> <span data-i18n="httpin.label.headers"></span></label>
    </div>
    <div class="form-row node-input-headers-container-row">
        <ol id="node-input-headers-container"></ol>
    </div>

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
</script>

<script type="text/javascript">
(function() {
    const headerTypes = [
        { value: "Accept", label: "Accept", hasValue: false },
        { value: "Accept-Encoding", label: "Accept-Encoding", hasValue: false },
        { value: "Accept-Language", label: "Accept-Language", hasValue: false },
        { value: "Authorization", label: "Authorization", hasValue: false },
        { value: "Content-Type", label: "Content-Type", hasValue: false },
        { value: "Cache-Control", label: "Cache-Control", hasValue: false },
        { value: "User-Agent", label: "User-Agent", hasValue: false },
        { value: "Location", label: "Location", hasValue: false },
        { value: "other", label: RED._("node-red:httpin.label.other"),
          hasValue: true, icon: "red/images/typedInput/az.svg" },
        { value: "msg", label: "msg.", hasValue: true },
    ]
    const headerOptions = {};
    const defaultOptions = [
        { value: "other", label: RED._("node-red:httpin.label.other"),
          hasValue: true, icon: "red/images/typedInput/az.svg" },
        { value: "msg", label: "msg.", hasValue: true },
    ];
    headerOptions["accept"] = [
        { value: "text/plain", label: "text/plain", hasValue: false },
        { value: "text/html", label: "text/html", hasValue: false },
        { value: "application/json", label: "application/json", hasValue: false },
        { value: "application/xml", label: "application/xml", hasValue: false },
        ...defaultOptions,
    ];
    headerOptions["accept-encoding"] = [
        { value: "gzip", label: "gzip", hasValue: false },
        { value: "deflate", label: "deflate", hasValue: false },
        { value: "compress", label: "compress", hasValue: false },
        { value: "br", label: "br", hasValue: false },
        { value: "gzip, deflate", label: "gzip, deflate", hasValue: false },
        { value: "gzip, deflate, br", label: "gzip, deflate, br", hasValue: false },
        ...defaultOptions,
    ];
    headerOptions["accept-language"] = [
        { value: "*", label: "*", hasValue: false },
        { value: "en-GB, en-US, en;q=0.9", label: "en-GB, en-US, en;q=0.9", hasValue: false },
        { value: "de-AT, de-DE;q=0.9, en;q=0.5", label: "de-AT, de-DE;q=0.9, en;q=0.5", hasValue: false },
        { value: "es-mx,es,en;q=0.5", label: "es-mx,es,en;q=0.5", hasValue: false },
        { value: "fr-CH, fr;q=0.9, en;q=0.8", label: "fr-CH, fr;q=0.9, en;q=0.8", hasValue: false },
        { value: "zh-CN, zh-TW; q = 0.9, zh-HK; q = 0.8, zh; q = 0.7, en; q = 0.6", label: "zh-CN, zh-TW; q = 0.9, zh-HK; q = 0.8, zh; q = 0.7, en; q = 0.6", hasValue: false },
        { value: "ja-JP, jp", label: "ja-JP, jp", hasValue: false },
        ...defaultOptions,
    ];
    headerOptions["content-type"] = [
        { value: "text/css", label: "text/css", hasValue: false },
        { value: "text/plain", label: "text/plain", hasValue: false },
        { value: "text/html", label: "text/html", hasValue: false },
        { value: "application/json", label: "application/json", hasValue: false },
        { value: "application/octet-stream", label: "application/octet-stream", hasValue: false },
        { value: "application/pdf", label: "application/pdf", hasValue: false },
        { value: "application/xml", label: "application/xml", hasValue: false },
        { value: "application/zip", label: "application/zip", hasValue: false },
        { value: "multipart/form-data", label: "multipart/form-data", hasValue: false },
        { value: "audio/aac", label: "audio/aac", hasValue: false },
        { value: "audio/ac3", label: "audio/ac3", hasValue: false },
        { value: "audio/basic", label: "audio/basic", hasValue: false },
        { value: "audio/mp4", label: "audio/mp4", hasValue: false },
        { value: "audio/ogg", label: "audio/ogg", hasValue: false },
        { value: "image/bmp", label: "image/bmp", hasValue: false },
        { value: "image/gif", label: "image/gif", hasValue: false },
        { value: "image/jpeg", label: "image/jpeg", hasValue: false },
        { value: "image/png", label: "image/png", hasValue: false },
        { value: "image/tiff", label: "image/tiff", hasValue: false },
        ...defaultOptions,
    ];
    headerOptions["cache-control"] = [
        { value: "max-age=0", label: "max-age=0", hasValue: false },
        { value: "max-age=86400", label: "max-age=86400", hasValue: false },
        { value: "no-cache", label: "no-cache", hasValue: false },
        ...defaultOptions,
    ];

    headerOptions["user-agent"] = [
        { value: "Mozilla/5.0", label: "Mozilla/5.0", hasValue: false },
        ...defaultOptions,
    ];

    function getHeaderOptions(headerName) {
        const lc = (headerName || "").toLowerCase();
        let opts = headerOptions[lc];
        return opts || defaultOptions;
    }

    RED.nodes.registerType('http request',{
        category: 'network',
        color:"rgb(231, 231, 174)",
        defaults: {
            name: {value:""},
            method:{value:"GET"},
            ret: {value:"txt"},
            paytoqs: {value: false},
            url:{
                value:"",
                validate: function(v, opt) {
                    if ((v.trim().length === 0) ||
                        (v.indexOf("://") === -1) ||
                        (v.trim().indexOf("http") === 0)) {
                        return true;
                    }
                    return RED._("node-red:httpin.errors.invalid-url");
                }
            },
            tls: {type:"tls-config",required: false,
                  label:RED._("node-red:httpin.tls-config") },
            persist: {value:false},
            proxy: {type:"http proxy",required: false,
                    label:RED._("node-red:httpin.proxy-config") },
            insecureHTTPParser: {value: false},
            authType: {value: ""},
            senderr: {value: false},
            headers: { value: [] }
        },
        credentials: {
            user: {type:"text"},
            password: {type: "password"}
        },
        inputs:1,
        outputs:1,
        outputLabels: function(i) {
            return ({
                txt: this._("httpin.label.utf8String"),
                bin: this._("httpin.label.binaryBuffer"),
                obj: this._("httpin.label.jsonObject")
            }[this.ret]);
        },
        icon: "white-globe.svg",
        label: function() {
            return this.name||this._("httpin.httpreq");
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            const node = this;
            $("#node-input-useAuth").on("change", function() {
                if ($(this).is(":checked")) {
                    $(".node-input-useAuth-row").show();
                    // Nodes (< version 0.20.x) with credentials but without authentication type, need type 'basic'
                    if (!$('#node-input-authType').val()) {
                        $("#node-input-authType-select").val('basic').trigger("change");
                    }
                } else {
                    $(".node-input-useAuth-row").hide();
                    $('#node-input-authType').val('');
                    $('#node-input-user').val('');
                    $('#node-input-password').val('');
                }
                RED.tray.resize();
            });
            $("#node-input-authType-select").on("change", function() {
                const val = $(this).val();
                $("#node-input-authType").val(val);
                if (val === "basic" || val === "digest") {
                    $(".node-input-basic-row").show();
                    $('#node-span-password').show();
                    $('#node-span-token').hide();
                } else if (val === "bearer") {
                    $(".node-input-basic-row").hide();
                    $('#node-span-password').hide();
                    $('#node-span-token').show();
                    $('#node-input-user').val('');
                }
                RED.tray.resize();
            });
            $("#node-input-method").on("change", function() {
                if ($(this).val() == "GET") {
                    $(".node-input-paytoqs-row").show();
                } else {
                    $(".node-input-paytoqs-row").hide();
                }
                RED.tray.resize();
            });
            if (node.paytoqs === true || node.paytoqs == "query") {
                $("#node-input-paytoqs").val("query");
            } else if (node.paytoqs === "body") {
                $("#node-input-paytoqs").val("body");
            } else {
                $("#node-input-paytoqs").val("ignore");
            }
            if (node.authType) {
                $('#node-input-useAuth').prop('checked', true);
                $("#node-input-authType-select").val(node.authType);
                $("#node-input-authType-select").change();
            } else {
                $('#node-input-useAuth').prop('checked', false);
            }
            $("#node-input-useAuth").change();

            function updateTLSOptions() {
                if ($("#node-input-usetls").is(':checked')) {
                    $("#node-row-tls").show();
                } else {
                    $("#node-row-tls").hide();
                }
                RED.tray.resize();
            }
            if (node.tls) {
                $('#node-input-usetls').prop('checked', true);
            } else {
                $('#node-input-usetls').prop('checked', false);
            }
            updateTLSOptions();
            $("#node-input-usetls").on("click",function() {
                updateTLSOptions();
            });

            function updateProxyOptions() {
                if ($("#node-input-useProxy").is(":checked")) {
                    $("#node-input-useProxy-row").show();
                } else {
                    $("#node-input-useProxy-row").hide();
                }
                RED.tray.resize();
            }
            if (node.proxy) {
                $("#node-input-useProxy").prop("checked", true);
            } else {
                $("#node-input-useProxy").prop("checked", false);
            }

            if (node.insecureHTTPParser) {
                $("node-intput-insecureHTTPParser").prop("checked", true)
            } else {
                $("node-intput-insecureHTTPParser").prop("checked", false)
            }
            updateProxyOptions();
            $("#node-input-useProxy").on("click", function() {
                updateProxyOptions();
            });

            $("#node-input-ret").on("change", function() {
                if ($("#node-input-ret").val() === "obj") {
                    $("#tip-json").show();
                } else {
                    $("#tip-json").hide();
                }
                RED.tray.resize();
            });
            const hasMatch = function (arr, value) {
                return arr.some(function (ht) {
                    return ht.value === value
                });
            }
            const headerList = $("#node-input-headers-container").css('min-height', '150px').css('min-width', '450px').editableList({
                addItem: function (container, i, header) {
                    const row = $('<div/>').css({
                        overflow: 'hidden',
                        whiteSpace: 'nowrap',
                        display: 'flex'
                    }).appendTo(container);
                    const propertNameCell = $('<div/>').css({ 'flex-grow': 1 }).appendTo(row);
                    const propertyName = $('<input/>', { class: "node-input-header-name", type: "text", style: "width: 100%" })
                        .appendTo(propertNameCell)
                        .typedInput({ types: headerTypes });

                    const propertyValueCell = $('<div/>').css({ 'flex-grow': 1, 'margin-left': '10px' }).appendTo(row);
                    const propertyValue = $('<input/>', { class: "node-input-header-value", type: "text", style: "width: 100%" })
                        .appendTo(propertyValueCell)
                        .typedInput({
                            types: getHeaderOptions(header.keyType)
                        });

                    const setup = function(_header) {
                        const headerTypeIsAPreset = function(h) {return hasMatch(headerTypes, h) };
                        const headerValueIsAPreset = function(h, v) {return hasMatch(getHeaderOptions(h), v) };
                        const {keyType, keyValue, valueType, valueValue} = header;
                        if(keyType == "msg" || keyType == "other") {
                            propertyName.typedInput('type', keyType);
                            propertyName.typedInput('value', keyValue);
                        } else if (headerTypeIsAPreset(keyType)) {
                            propertyName.typedInput('type', keyType);
                        } else {
                            propertyName.typedInput('type', "other");
                            propertyName.typedInput('value', keyValue);
                        }
                        if(valueType == "msg" || valueType == "other") {
                            propertyValue.typedInput('type', valueType);
                            propertyValue.typedInput('value', valueValue);
                        } else if (headerValueIsAPreset(propertyName.typedInput('type'), valueType)) {
                            propertyValue.typedInput('type', valueType);
                        } else {
                            propertyValue.typedInput('type', "other");
                            propertyValue.typedInput('value', valueValue);
                        }
                    }
                    setup(header);

                    propertyName.on('change', function (event) {
                        propertyValue.typedInput('types', getHeaderOptions(propertyName.typedInput('type')));
                    });

                },
                sortable: true,
                removable: true
            });
            if (node.headers) {
                for (let index = 0; index < node.headers.length; index++) {
                    const element = node.headers[index];
                    headerList.editableList('addItem', node.headers[index]);
                }
            }
        },
        oneditsave: function() {
            if (!$("#node-input-usetls").is(':checked')) {
                $("#node-input-tls").val("_ADD_");
            }
            if (!$("#node-input-useProxy").is(":checked")) {
                $("#node-input-proxy").val("_ADD_");
            }
            const headers = $("#node-input-headers-container").editableList('items');
            const node = this;
            node.headers = [];
            headers.each(function(i) {
                const header = $(this);
                const keyType = header.find(".node-input-header-name").typedInput('type');
                const keyValue = header.find(".node-input-header-name").typedInput('value');
                const valueType = header.find(".node-input-header-value").typedInput('type');
                const valueValue = header.find(".node-input-header-value").typedInput('value');
                if (keyType !== '' || keyType === 'other' || keyType === 'msg') {
                    node.headers.push({
                        keyType, keyValue, valueType, valueValue
                    })
                }
            });
        },
        oneditresize: function(size) {
            const dlg = $("#dialog-form");
            const expandRow = dlg.find('.node-input-headers-container-row');
            let height = dlg.height() - 5;
            if(expandRow && expandRow.length){
                const siblingRows = dlg.find('> .form-row:not(.node-input-headers-container-row)');
                for (let i = 0; i < siblingRows.size(); i++) {
                    const cr = $(siblingRows[i]);
                    if(cr.is(":visible"))
                        height -= cr.outerHeight(true);
                }
                $("#node-input-headers-container").editableList('height',height);
            } 
        }
    });
})();    
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="http request">
    <p>Sends HTTP requests and returns the response.</p>

    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt class="optional">url <span class="property-type">string</span></dt>
        <dd>If not configured in the node, this optional property sets the url of the request.</dd>
        <dt class="optional">method <span class="property-type">string</span></dt>
        <dd>If not configured in the node, this optional property sets the HTTP method of the request.
            Must be one of <code>GET</code>, <code>PUT</code>, <code>POST</code>, <code>PATCH</code> or <code>DELETE</code>.</dd>
        <dt class="optional">headers <span class="property-type">object</span></dt>
        <dd>Sets the HTTP headers of the request. NOTE: Any headers set in the node configuration will overwrite any matching headers in <code>msg.headers</code> </dd>
        <dt class="optional">cookies <span class="property-type">object</span></dt>
        <dd>If set, can be used to send cookies with the request.</dd>
        <dt class="optional">payload</dt>
        <dd>Sent as the body of the request.</dd>
        <dt class="optional">rejectUnauthorized</dt>
        <dd>If set to <code>false</code>, allows requests to be made to https sites that use
            self signed certificates.</dd>
        <dt class="optional">followRedirects</dt>
        <dd>If set to <code>false</code> prevent following Redirect (HTTP 301).<code>true</code> by default</dd>
        <dt class="optional">requestTimeout</dt>
        <dd>If set to a positive number of milliseconds, will override the globally set <code>httpRequestTimeout</code> parameter.</dd>
    </dl>
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">string | object | buffer</span></dt>
        <dd>The body of the response. The node can be configured to return the body
             as a string, attempt to parse it as a JSON string or leave it as a
             binary buffer.</dd>
        <dt>statusCode <span class="property-type">number</span></dt>
        <dd>The status code of the response, or the error code if the request could not be completed.</dd>
        <dt>headers <span class="property-type">object</span></dt>
        <dd>An object containing the response headers.</dd>
        <dt>responseUrl <span class="property-type">string</span></dt>
        <dd>In case any redirects occurred while processing the request, this property is the final redirected url.
            Otherwise, the url of the original request.</dd>
        <dt>responseCookies <span class="property-type">object</span></dt>
        <dd>If the response includes cookies, this property is an object of name/value pairs for each cookie.</dd>
        <dt>redirectList <span class="property-type">array</span></dt>
        <dd>If the request was redirected one or more times, the accumulated information will be added to this property. `location` is the next redirect destination. `cookies` is the cookies returned from the redirect source.</dd>
    </dl>
    <h3>Details</h3>
    <p>When configured within the node, the URL property can contain <a href="http://mustache.github.io/mustache.5.html" target="_blank">mustache-style</a> tags. These allow the
    url to be constructed using values of the incoming message. For example, if the url is set to
    <code>example.com/{{{topic}}}</code>, it will have the value of <code>msg.topic</code> automatically inserted.
    Using {{{...}}} prevents mustache from escaping characters like / & etc.</p>
    <p>The node can optionally automatically encode <code>msg.payload</code> as query string parameters for a GET request, in which case <code>msg.payload</code> has to be an object.</p>
    <p><b>Note</b>: If running behind a proxy, the standard <code>http_proxy=...</code> environment variable should be set and Node-RED restarted, or use Proxy Configuration. If Proxy Configuration was set, the configuration take precedence over environment variable.</p>
    <h4>Using multiple HTTP Request nodes</h4>
    <p>In order to use more than one of these nodes in the same flow, care must be taken with
    the <code>msg.headers</code> property. The first node will set this property with
    the response headers. The next node will then use those headers for its request - this
    is not usually the right thing to do. If <code>msg.headers</code> property is left unchanged
    between nodes, it will be ignored by the second node. To set custom headers, <code>msg.headers</code>
    should first be deleted or reset to an empty object: <code>{}</code>.
    <h4>Cookie handling</h4>
    <p>The <code>cookies</code> property passed to the node must be an object of name/value pairs.
    The value can be either a string to set the value of the cookie or it can be an
    object with a single <code>value</code> property.</p>
    <p>Any cookies returned by the request are passed back under the <code>responseCookies</code> property.</p>
    <h4>Content type handling</h4>
    <p>If <code>msg.payload</code> is an Object, the node will automatically set the content type
    of the request to <code>application/json</code> and encode the body as such.</p>
    <p>To encode the request as form data, <code>msg.headers["content-type"]</code> should be set to <code>application/x-www-form-urlencoded</code>.</p>
    <h4>File Upload</h4>
    <p>To perform a file upload, <code>msg.headers["content-type"]</code> should be set to <code>multipart/form-data</code>
        and the <code>msg.payload</code> passed to the node must be an object with the following structure:</p>
    <pre><code>{
    "KEY": {
        "value": FILE_CONTENTS,
        "options": {
            "filename": "FILENAME"
        }
    }
}</code></pre>
    <p>The values of <code>KEY</code>, <code>FILE_CONTENTS</code> and <code>FILENAME</code>
    should be set to the appropriate values.</p>

</script>

<!-- --- [red-module:node-red/websocket] --- -->
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<!-- WebSocket Input Node -->
<script type="text/html" data-template-name="websocket in">
    <div class="form-row">
        <label for="node-input-mode"><i class="fa fa-dot-circle-o"></i> <span data-i18n="websocket.label.type"></span></label>
        <select id="node-input-mode">
            <option value="server" data-i18n="websocket.listenon"></option>
            <option value="client" data-i18n="websocket.connectto"></option>
        </select>
    </div>
    <div class="form-row" id="websocket-server-row">
        <label for="node-input-server"><i class="fa fa-bookmark"></i> <span data-i18n="websocket.label.path"></span></label>
        <input type="text" id="node-input-server">
    </div>
    <div class="form-row" id="websocket-client-row">
        <label for="node-input-client"><i class="fa fa-bookmark"></i> <span data-i18n="websocket.label.url"></span></label>
        <input type="text" id="node-input-client">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
</script>

<script type="text/javascript">

(function() {

    function ws_oneditprepare() {
        $("#websocket-client-row").hide();
        $("#node-input-mode").on("change", function() {
            if ( $("#node-input-mode").val() === 'client') {
                $("#websocket-server-row").hide();
                $("#websocket-client-row").show();
            }
            else {
                $("#websocket-server-row").show();
                $("#websocket-client-row").hide();
            }
        });

        if (this.client) {
            $("#node-input-mode").val('client').change();
        }
        else {
            $("#node-input-mode").val('server').change();
        }
    }

    function ws_oneditsave() {
        if ($("#node-input-mode").val() === 'client') {
            $("#node-input-server").append('<option value="">Dummy</option>');
            $("#node-input-server").val('');
        }
        else {
            $("#node-input-client").append('<option value="">Dummy</option>');
            $("#node-input-client").val('');
        }
    }

    function ws_label() {
        var nodeid = (this.client)?this.client:this.server;
        var wsNode = RED.nodes.node(nodeid);
        return this.name||(wsNode?"[ws] "+wsNode.label():"websocket");
    }

    function ws_validateserver() {
        if ($("#node-input-mode").val() === 'client' || (this.client && !this.server)) {
            return true;
        }
        else {
            if (RED.nodes.node(this.server) != null) {
                return true;
            }
            return RED._("node-red:websocket.errors.missing-server");
        }
    }

    function ws_validateclient() {
        if ($("#node-input-mode").val() === 'client' || (this.client && !this.server)) {
            if (RED.nodes.node(this.client) != null) {
                return true;
            }
            return RED._("node-red:websocket.errors.missing-client");
        }
        else {
            return true;
        }
    }

    RED.nodes.registerType('websocket in',{
        category: 'network',
        defaults: {
            name: {value:""},
            server: {type:"websocket-listener", validate: ws_validateserver},
            client: {type:"websocket-client", validate: ws_validateclient}
        },
        color:"rgb(215, 215, 160)",
        inputs:0,
        outputs:1,
        icon: "white-globe.svg",
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        label: ws_label,
        oneditsave: ws_oneditsave,
        oneditprepare: ws_oneditprepare
    });

    RED.nodes.registerType('websocket out',{
        category: 'network',
        defaults: {
            name: {value:""},
            server: {type:"websocket-listener", validate: ws_validateserver},
            client: {type:"websocket-client", validate: ws_validateclient}
        },
        color:"rgb(215, 215, 160)",
        inputs:1,
        outputs:0,
        icon: "white-globe.svg",
        align: "right",
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        label: ws_label,
        oneditsave: ws_oneditsave,
        oneditprepare: ws_oneditprepare
    });

    RED.nodes.registerType('websocket-listener',{
        category: 'config',
        defaults: {
            path: {value:"",required:true,
                   label:RED._("node-red:websocket.label.path"),
                   validate:RED.validators.regex(/^((?!\/debug\/ws).)*$/)},
            wholemsg: {value:"false"}
        },
        inputs:0,
        outputs:0,
        label: function() {
            var root = RED.settings.httpNodeRoot;
            if (root.slice(-1) != "/") {
                root = root+"/";
            }
            if (this.path) {
                if (this.path.charAt(0) == "/") {
                    root += this.path.slice(1);
                } else {
                    root += this.path;
                }
            }
            return root;
        },
        oneditprepare: function() {
            var root = RED.settings.httpNodeRoot;
            if (root.slice(-1) == "/") {
                root = root.slice(0,-1);
            }
            if (root === "") {
                $("#node-config-ws-tip").hide();
            } else {
                $("#node-config-ws-path").html(RED._("node-red:websocket.tip.path2", { path: root }));
                $("#node-config-ws-tip").show();
            }
        }
    });

    RED.nodes.registerType('websocket-client',{
        category: 'config',
        defaults: {
            path: {
                value:"",required:true,
                label:RED._("node-red:websocket.label.path"),
                validate:RED.validators.regex(/^((?!\/debug\/ws).)*$/)},
            tls: {type:"tls-config",required: false},
            wholemsg: {value:"false"},
            hb: {
                value: "",
                label:RED._("node-red:websocket.sendheartbeat"),
                validate: RED.validators.number(/*blank allowed*/true) },
            subprotocol: {value:"",required: false}
        },
        inputs:0,
        outputs:0,
        label: function() {
            return this.path;
        },
        oneditprepare: function() {
            $("#node-config-input-path").on("change keyup paste",function() {
                $(".node-config-row-tls").toggle(/^wss:/i.test($(this).val()))
            });
            $("#node-config-input-path").change();

            var heartbeatActive = (this.hb && this.hb != "0");
            $("#node-config-input-hb-cb").prop("checked",heartbeatActive);
            $("#node-config-input-hb-cb").on("change", function(evt) {
                $("#node-config-input-hb-row").toggle(this.checked);
            })
            $("#node-config-input-hb-cb").trigger("change");
            if (!heartbeatActive) {
                $("#node-config-input-hb").val("");
            }
        },
        oneditsave: function() {
            if (!/^wss:/i.test($("#node-config-input-path").val())) {
                $("#node-config-input-tls").val("_ADD_");
            }
            if (!$("#node-config-input-hb-cb").prop("checked")) {
                $("#node-config-input-hb").val("0");
            }
        }
    });

})();
</script>

<!-- WebSocket out Node -->
<script type="text/html" data-template-name="websocket out">
    <div class="form-row">
        <label for="node-input-mode"><i class="fa fa-dot-circle-o"></i> <span data-i18n="websocket.label.type"></span></label>
        <select id="node-input-mode">
            <option value="server" data-i18n="websocket.listenon"></option>
            <option value="client" data-i18n="websocket.connectto"></option>
        </select>
    </div>
    <div class="form-row" id="websocket-server-row">
        <label for="node-input-server"><i class="fa fa-bookmark"></i> <span data-i18n="websocket.label.path"></span></label>
        <input type="text" id="node-input-server">
    </div>
    <div class="form-row" id="websocket-client-row">
        <label for="node-input-client"><i class="fa fa-bookmark"></i> <span data-i18n="websocket.label.url"></span></label>
        <input type="text" id="node-input-client">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
</script>

<!-- WebSocket Server configuration node -->
<script type="text/html" data-template-name="websocket-listener">
    <div class="form-row">
        <label for="node-config-input-path"><i class="fa fa-bookmark"></i> <span data-i18n="websocket.label.path"></span></label>
        <input id="node-config-input-path" type="text" placeholder="/ws/example">
    </div>
    <div class="form-row">
        <label for="node-config-input-wholemsg" data-i18n="websocket.sendrec"></label>
        <select type="text" id="node-config-input-wholemsg" style="width: 70%;">
            <option value="false" data-i18n="websocket.payload"></option>
            <option value="true" data-i18n="websocket.message"></option>
        </select>
    </div>
    <div class="form-tips">
        <span data-i18n="[html]websocket.tip.path1"></span>
        <p id="node-config-ws-tip"><span id="node-config-ws-path"></span></p>
    </div>
</script>

<!-- WebSocket Client configuration node -->
<script type="text/html" data-template-name="websocket-client">
    <div class="form-row">
        <label for="node-config-input-path"><i class="fa fa-bookmark"></i> <span data-i18n="websocket.label.url"></span></label>
        <input id="node-config-input-path" type="text" placeholder="ws://example.com/ws">
    </div>
    <div class="form-row node-config-row-tls hide">
        <label for="node-config-input-tls" data-i18n="httpin.tls-config"></label>
        <input type="text" id="node-config-input-tls">
    </div>
    <div class="form-row">
        <label for="node-config-input-subprotocol"><i class="fa fa-tag"></i> <span data-i18n="websocket.label.subprotocol"></span></label>
        <input type="text" id="node-config-input-subprotocol">
    </div>
    <div class="form-row">
        <label for="node-config-input-wholemsg" data-i18n="websocket.sendrec"></label>
        <select type="text" id="node-config-input-wholemsg" style="width: 70%;">
            <option value="false" data-i18n="websocket.payload"></option>
            <option value="true" data-i18n="websocket.message"></option>
        </select>
    </div>
    <div class="form-row" style="display: flex; align-items: center; min-height: 34px">
        <label for="node-config-input-hb-cb" data-i18n="websocket.sendheartbeat"></label>
        <input type="checkbox" style="margin: 0 8px; width:auto" id="node-config-input-hb-cb">
        <span id="node-config-input-hb-row" class="hide" >
            <input type="text" style="width: 70px; margin-right: 3px" id="node-config-input-hb">
            <span  data-i18n="inject.seconds"></span>
        </span>
    </div>
    <div class="form-tips">
        <p><span data-i18n="[html]websocket.tip.url1"></span></p>
        <span data-i18n="[html]websocket.tip.url2"></span>
    </div>
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="websocket in">
    <p>WebSocket input node.</p>
    <p>By default, the data received from the WebSocket will be in <code>msg.payload</code>.
    The socket can be configured to expect a properly formed JSON string, in which
    case it will parse the JSON and send on the resulting object as the entire message.</p>
</script>

<script type="text/html" data-help-name="websocket out">
    <p>WebSocket out node.</p>
    <p>By default, <code>msg.payload</code> will be sent over the WebSocket. The socket
    can be configured to encode the entire <code>msg</code> object as a JSON string and send that
    over the WebSocket.</p>

    <p>If the message arriving at this node started at a WebSocket In node, the message
    will be sent back to the client that triggered the flow. Otherwise, the message
    will be broadcast to all connected clients.</p>
    <p>If you want to broadcast a message that started at a WebSocket In node, you
    should delete the <code>msg._session</code> property within the flow.</p>
</script>

<script type="text/html" data-help-name="websocket-listener">
   <p>This configuration node creates a WebSocket Server endpoint using the specified path.</p>
</script>

<script type="text/html" data-help-name="websocket-client">
   <p>This configuration node connects a WebSocket client to the specified URL.</p>
</script>

<!-- --- [red-module:node-red/tcpin] --- -->
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-template-name="tcp in">
    <div class="form-row">
        <label for="node-input-server"><i class="fa fa-dot-circle-o"></i> <span data-i18n="tcpin.label.type"></span></label>
        <select id="node-input-server" style="width:120px; margin-right:5px;">
            <option value="server" data-i18n="tcpin.type.listen"></option>
            <option value="client" data-i18n="tcpin.type.connect"></option>
        </select>
        <span data-i18n="tcpin.label.port"></span> <input type="text" id="node-input-port" style="width:65px">
    </div>
    <div class="form-row hidden" id="node-input-host-row" style="padding-left:110px;">
        <span data-i18n="tcpin.label.host"></span> <input type="text" id="node-input-host" placeholder="localhost" style="width: 60%;">
    </div>
    <div class="form-row" id="node-input-tls-enable">
        <label> </label>
        <input type="checkbox" id="node-input-usetls" style="display: inline-block; width:auto; vertical-align:top;">
        <label for="node-input-usetls" style="width:auto" data-i18n="httpin.use-tls"></label>
        <div id="node-row-tls" class="hide">
            <label style="width:auto; margin-left:20px; margin-right:10px;" for="node-input-tls"><span data-i18n="httpin.tls-config"></span></label><input type="text" style="width: 300px" id="node-input-tls">
        </div>
    </div>

    <div class="form-row">
        <label><i class="fa fa-sign-out"></i> <span data-i18n="tcpin.label.output"></span></label>
        <select id="node-input-datamode" style="width:110px;">
            <option value="stream" data-i18n="tcpin.output.stream"></option>
            <option value="single" data-i18n="tcpin.output.single"></option>
        </select>
        <select id="node-input-datatype" style="width:140px;">
            <option value="buffer" data-i18n="tcpin.output.buffer"></option>
            <option value="utf8" data-i18n="tcpin.output.string"></option>
            <option value="base64" data-i18n="tcpin.output.base64"></option>
        </select>
        <span data-i18n="tcpin.label.payload"></span>
    </div>

    <div id="node-row-newline" class="form-row hidden" style="padding-left:110px;">
        <span data-i18n="tcpin.label.delimited"></span> <input type="text" id="node-input-newline" style="width:110px;" data-i18n="[placeholder]tcpin.label.optional"><br/>
        <input type="checkbox" id="node-input-trim" style="display:inline-block; width:auto; vertical-align:top;"> <span data-i18n="tcpin.label.reattach"></span>
    </div>

    <div class="form-row">
        <label for="node-input-topic"><i class="fa fa-tasks"></i> <span data-i18n="common.label.topic"></span></label>
        <input type="text" id="node-input-topic" data-i18n="[placeholder]common.label.topic">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('tcp in',{
        category: 'network',
        color: "Silver",
        defaults: {
            name: {value:""},
            server: {value:"server", required:true},
            host: {
                value:"",
                validate:function(v, opt) {
                    if ((this.server == "server")||v.length > 0) {
                        return true;
                    }
                    return RED._("node-red:tcpin.errors.invalid-host");
                }
            },
            port: {
                value:"", required:true,
                label:RED._("node-red:tcpin.label.port"),
                validate:RED.validators.number(false)},
            datamode:{value:"stream"},
            datatype:{value:"buffer"},
            newline:{value:""},
            topic: {value:""},
            trim: {value:false},
            base64: {/*deprecated*/ value:false, required:true},
            tls: {type:"tls-config", value:'', required:false,
                  label:RED._("node-red:httpin.tls-config") }
        },
        inputs:0,
        outputs:1,
        icon: "bridge-dash.svg",
        label: function() {
            return this.name || "tcp:"+(this.host?this.host+":":"")+this.port;
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function() {
            var updateOptions = function() {
                var sockettype = $("#node-input-server").val();
                if (sockettype == "client") {
                    $("#node-input-host-row").show();
                } else {
                    $("#node-input-host-row").hide();
                }
                var datamode = $("#node-input-datamode").val();
                var datatype = $("#node-input-datatype").val();
                if (datamode == "stream") {
                    if (datatype == "utf8") {
                        $("#node-row-newline").show();
                    } else {
                        $("#node-row-newline").hide();
                    }
                } else {
                    $("#node-row-newline").hide();
                }
            };
            updateOptions();
            $("#node-input-server").change(updateOptions);
            $("#node-input-datatype").change(updateOptions);
            $("#node-input-datamode").change(updateOptions);
            function updateTLSOptions() {
                if ($("#node-input-usetls").is(':checked')) {
                    $("#node-row-tls").show();
                } else {
                    $("#node-row-tls").hide();
                }
            }
            if (this.tls) {
                $('#node-input-usetls').prop('checked', true);
            } else {
                $('#node-input-usetls').prop('checked', false);
            }
            updateTLSOptions();
            $("#node-input-usetls").on("click",function() {
                updateTLSOptions();
            });
        },
        oneditsave: function() {
            if (!$("#node-input-usetls").is(':checked')) {
                $("#node-input-tls").val("_ADD_");
            }
        }
    });
</script>


<script type="text/html" data-template-name="tcp out">
    <div class="form-row">
        <label for="node-input-beserver"><i class="fa fa-dot-circle-o"></i> <span data-i18n="tcpin.label.type"></span></label>
        <select id="node-input-beserver" style="width:150px; margin-right:5px;">
            <option value="server" data-i18n="tcpin.type.listen"></option>
            <option value="client" data-i18n="tcpin.type.connect"></option>
            <option value="reply" data-i18n="tcpin.type.reply"></option>
        </select>
        <span id="node-input-port-row"><span data-i18n="tcpin.label.port"></span> <input type="text" id="node-input-port" style="width: 65px"></span>
    </div>

    <div class="form-row hidden" id="node-input-host-row" style="padding-left: 110px;">
        <span data-i18n="tcpin.label.host"></span> <input type="text" id="node-input-host" style="width: 60%;">
    </div>

    <div class="form-row" id="node-input-tls-enable">
        <label> </label>
        <input type="checkbox" id="node-input-usetls" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-usetls" style="width: auto" data-i18n="httpin.use-tls"></label>
        <div id="node-row-tls" class="hide">
            <label style="width: auto; margin-left: 20px; margin-right: 10px;" for="node-input-tls"><span data-i18n="httpin.tls-config"></span></label><input type="text" style="width: 300px" id="node-input-tls">
        </div>
    </div>

    <div class="form-row hidden" id="node-input-end-row">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-end" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-end" style="width: 70%;"><span data-i18n="tcpin.label.close-connection"></span></label>
    </div>

    <div class="form-row">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-base64" placeholder="base64" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-base64" style="width: 70%;"><span data-i18n="tcpin.label.decode-base64"></span></label>
    </div>

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('tcp out',{
        category: 'network',
        color: "Silver",
        defaults: {
            name: {value:""},
            host: {
                value:"",
                validate:function(v, opt) {
                    if ((this.beserver != "client")||v.length > 0) {
                        return true;
                    }
                    return RED._("node-red:tcpin.errors.invalid-host");
                }
            },
            port: {
                value:"",
                validate:function(v) {
                    if ((this.beserver == "reply")||RED.validators.number()(v)) {
                        return true;
                    }
                    return RED._("node-red:tcpin.errors.invalid-port");
                }
            },
            beserver: {value:"client", required:true},
            base64: {value:false, required:true},
            end: {value:false, required:true},
            tls: {type:"tls-config", value:'', required:false,
                  label:RED._("node-red:httpin.tls-config") }
        },
        inputs:1,
        outputs:0,
        icon: "bridge-dash.svg",
        align: "right",
        label: function() {
            return this.name || "tcp:"+(this.host?this.host+":":"")+this.port;
        },
        labelStyle: function() {
            return (this.name)?"node_label_italic":"";
        },
        oneditprepare: function() {
            var updateOptions = function() {
                var sockettype = $("#node-input-beserver").val();
                if (sockettype == "reply") {
                    $("#node-input-port-row").hide();
                    $("#node-input-host-row").hide();
                    $("#node-input-end-row").hide();
                    $("#node-input-tls-enable").hide();
                } else if (sockettype == "client"){
                    $("#node-input-port-row").show();
                    $("#node-input-host-row").show();
                    $("#node-input-end-row").show();
                    $("#node-input-tls-enable").show();
                } else {
                    $("#node-input-port-row").show();
                    $("#node-input-host-row").hide();
                    $("#node-input-end-row").show();
                    $("#node-input-tls-enable").show();
                }
            };
            updateOptions();
            $("#node-input-beserver").change(updateOptions);
            function updateTLSOptions() {
                if ($("#node-input-usetls").is(':checked')) {
                    $("#node-row-tls").show();
                } else {
                    $("#node-row-tls").hide();
                }
            }
            if (this.tls) {
                $('#node-input-usetls').prop('checked', true);
            } else {
                $('#node-input-usetls').prop('checked', false);
            }
            updateTLSOptions();
            $("#node-input-usetls").on("click",function() {
                updateTLSOptions();
            });
        },
        oneditsave: function() {
            if (!$("#node-input-usetls").is(':checked')) {
                $("#node-input-tls").val("_ADD_");
            }
        }
    });
</script>


<script type="text/html" data-template-name="tcp request">
    <div class="form-row">
        <label for="node-input-server"><i class="fa fa-globe"></i> <span data-i18n="tcpin.label.server"></span></label>
        <input type="text" id="node-input-server" placeholder="ip.address" style="width:45%">
        <span data-i18n="tcpin.label.port"></span>
        <input type="text" id="node-input-port" style="width:60px">
    </div>
    <div class="form-row" id="node-input-tls-enable">
        <label> </label>
        <input type="checkbox" id="node-input-usetls" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-usetls" style="width: auto" data-i18n="httpin.use-tls"></label>
        <div id="node-row-tls" class="hide">
            <label style="width: auto; margin-left: 20px; margin-right: 10px;" for="node-input-tls"><span data-i18n="httpin.tls-config"></span></label><input type="text" style="width: 300px" id="node-input-tls">
        </div>
    </div>
    <div class="form-row">
        <label for="node-input-ret"><i class="fa fa-sign-out"></i> <span data-i18n="tcpin.label.return"></span></label>
        <select type="text" id="node-input-ret" style="width:54%;">
            <option value="buffer" data-i18n="tcpin.output.buffer"></option>
            <option value="string" data-i18n="tcpin.output.string"></option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-out"><i class="fa fa-sign-out fa-rotate-90"></i> <span data-i18n="tcpin.label.close"></span></label>
        <select type="text" id="node-input-out" style="width:54%;">
            <option value="time" data-i18n="tcpin.return.timeout"></option>
            <option value="char" data-i18n="tcpin.return.character"></option>
            <option value="count" data-i18n="tcpin.return.number"></option>
            <option value="sit" data-i18n="tcpin.return.never"></option>
            <option value="immed" data-i18n="tcpin.return.immed"></option>
        </select>
        <input type="text" id="node-input-splitc" style="width:50px;">
        <span id="node-units"></span>
    </div>
    <div id="node-row-newline" class="form-row hidden" style="padding-left:162px;">
        <span data-i18n="tcpin.label.delimited"></span> <input type="text" id="node-input-newline" style="width:110px;" data-i18n="[placeholder]tcpin.label.optional"><br/>
        <input type="checkbox" id="node-input-trim" style="display:inline-block; width:auto; vertical-align:top;"> <span data-i18n="tcpin.label.reattach"></span>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('tcp request',{
        category: 'network',
        color: "Silver",
        defaults: {
            name: {value:""},
            server: {value:""},
            port: {
                value:"",
                label: RED._("node-red:tcpin.label.port"),
                validate:RED.validators.regex(/^(\d*|)$/)
            },
            out: {value:"time", required:true},
            ret: {value:"buffer"},
            splitc: {value:"0", required:true},
            newline: {value:""},
            trim: {value:false},
            tls: {type:"tls-config", value:'', required:false, label:RED._("node-red:httpin.tls-config")}
        },
        inputs:1,
        outputs:1,
        icon: "bridge-dash.svg",
        label: function() {
            return this.name || "tcp:"+(this.server?this.server+":":"")+this.port;
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            var previous = null;
            if ($("#node-input-ret").val() == undefined) {
                $("#node-input-ret").val("buffer");
                this.ret = "buffer";
            }
            $("#node-input-ret").on("change", function() {
                if ($("#node-input-ret").val() === "string" && $("#node-input-out").val() === "sit") { $("#node-row-newline").show(); }
                else { $("#node-row-newline").hide(); }
            });
            $("#node-input-out").on("change", function() {
                if ($("#node-input-ret").val() === "string" && $("#node-input-out").val() === "sit") { $("#node-row-newline").show(); }
                else { $("#node-row-newline").hide(); }
            });
            $("#node-input-out").on('focus', function () { previous = this.value; }).on("change", function() {
                $("#node-input-splitc").show();
                if (previous === null) { previous = $("#node-input-out").val(); }
                if ($("#node-input-out").val() == "char") {
                    if (previous != "char") { $("#node-input-splitc").val("\\n"); }
                    $("#node-units").text("");
                }
                else if ($("#node-input-out").val() == "time") {
                    if (previous != "time") { $("#node-input-splitc").val("0"); }
                    $("#node-units").text(RED._("node-red:tcpin.label.ms"));
                }
                else if ($("#node-input-out").val() == "immed") {
                    if (previous != "immed") { $("#node-input-splitc").val(" "); }
                    $("#node-units").text("");
                    $("#node-input-splitc").hide();
                }
                else if ($("#node-input-out").val() == "count") {
                    if (previous != "count") { $("#node-input-splitc").val("12"); }
                    $("#node-units").text(RED._("node-red:tcpin.label.chars"));
                }
                else {
                    if (previous != "sit") { $("#node-input-splitc").val(" "); }
                    $("#node-units").text("");
                    $("#node-input-splitc").hide();
                }
            });
            function updateTLSOptions() {
                if ($("#node-input-usetls").is(':checked')) {
                    $("#node-row-tls").show();
                } else {
                    $("#node-row-tls").hide();
                }
            }
            if (this.tls) {
                $('#node-input-usetls').prop('checked', true);
            } else {
                $('#node-input-usetls').prop('checked', false);
            }
            updateTLSOptions();
            $("#node-input-usetls").on("click",function() {
                updateTLSOptions();
            });
        },
        oneditsave: function() {
            if (!$("#node-input-usetls").is(':checked')) {
                $("#node-input-tls").val("_ADD_");
            }
        }
    });
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="tcp in">
    <p>Provides a choice of TCP inputs. Can either connect to a remote TCP port,
       or accept incoming connections.</p>
    <p><b>Note: </b>On some systems you may need root or administrator access
    to access ports below 1024.</p>
</script>

<script type="text/html" data-help-name="tcp out">
    <p>Provides a choice of TCP outputs. Can either connect to a remote TCP port,
    accept incoming connections, or reply to messages received from a TCP In node.</p>
    <p>Only the <code>msg.payload</code> is sent.</p>
    <p>If <code>msg.payload</code> is a string containing a Base64 encoding of binary
    data, the Base64 decoding option will cause it to be converted back to binary
    before being sent.</p>
    <p>If <code>msg._session</code> is not present the payload is
    sent to <b>all</b> connected clients.</p>
    <p><b>Note: </b>On some systems you may need root or administrator access
    to access ports below 1024.</p>
</script>

<script type="text/html" data-help-name="tcp request">
    <p>A simple TCP request node - sends the <code>msg.payload</code> to a server tcp port and expects a response.</p>
    <p>Connects, sends the "request", and reads the "response". It can either count a number of
    returned characters into a fixed buffer, match a specified character before returning,
    wait a fixed timeout from first reply and then return, sit and wait for data, or send then close the connection
    immediately, without waiting for a reply.</p>
    <p>The response will be output in <code>msg.payload</code> as a buffer, so you may want to .toString() it.</p>
    <p>If you leave tcp host or port blank they must be set by using the <code>msg.host</code> and <code>msg.port</code> properties in every message sent to the node.</p>
</script>

<!-- --- [red-module:node-red/udp] --- -->
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<!--  The Input Node  -->
<script type="text/html" data-template-name="udp in">
    <div class="form-row">
        <label for="node-input-port"><i class="fa fa-sign-in"></i> <span data-i18n="udp.label.listen"></span></label>
        <select id="node-input-multicast" style='width:70%'>
          <option value="false" data-i18n="udp.udpmsgs"></option>
          <option value="true" data-i18n="udp.mcmsgs"></option>
        </select>
    </div>
    <div class="form-row node-input-group">
        <label for="node-input-group"><i class="fa fa-list"></i> <span data-i18n="udp.label.group"></span></label>
        <input type="text" id="node-input-group" placeholder="225.0.18.83">
    </div>
    <div class="form-row node-input-iface">
        <label for="node-input-iface"><i class="fa fa-random"></i> <span data-i18n="udp.label.interface"></span></label>
        <input type="text" id="node-input-iface" data-i18n="[placeholder]udp.placeholder.interfaceprompt">
    </div>
    <div class="form-row">
        <label for="node-input-port"><i class="fa fa-sign-in"></i> <span data-i18n="udp.label.onport"></span></label>
        <input type="text" id="node-input-port" style="width:80px">
        &nbsp;&nbsp;<span data-i18n="udp.label.using"></span> <select id="node-input-ipv" style="width:80px">
          <option value="udp4">ipv4</option>
          <option value="udp6">ipv6</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-datatype"><i class="fa fa-sign-out"></i> <span data-i18n="udp.label.output"></span></label>
        <select id="node-input-datatype" style="width:70%;">
            <option value="buffer" data-i18n="udp.output.buffer"></option>
            <option value="utf8" data-i18n="udp.output.string"></option>
            <option value="base64" data-i18n="udp.output.base64"></option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
    <div class="form-tips"><span data-i18n="udp.tip.in"></span></div>
    <div class="form-tips" id="udpporttip"><span data-i18n="[html]udp.tip.port"></span></div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('udp in',{
        category: 'network',
        color:"Silver",
        defaults: {
            name: {value:""},
            iface: {value:""},
            port: {
                value:"", required:true,
                label:RED._("node-red:udp.label.port"),
                validate:RED.validators.number(false)
            },
            ipv: {value:"udp4"},
            multicast: {value:"false"},
            group: {
                value:"",
                validate:function(v,opt) {
                    if ((this.multicast !== "true")||v.length > 0) {
                        return true;
                    }
                    return RED._("node-red:udp.errors.invalid-group");
                }
            },
            datatype: {value:"buffer",required:true}
        },
        inputs:0,
        outputs:1,
        icon: "bridge-dash.svg",
        label: function() {
            if (this.multicast=="false") {
                return this.name||"udp "+this.port;
            }
            else {
                return this.name||"udp "+(this.group+":"+this.port);
            }
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            $("#node-input-multicast").on("change", function() {
                var id = $("#node-input-multicast").val();
                if (id == "false") {
                    $(".node-input-group").hide();
                    $(".node-input-iface").hide();
                }
                else {
                    $(".node-input-group").show();
                    $(".node-input-iface").show();
                }
            });
            $("#node-input-multicast").change();

            var porttip = this._("udp.tip.port");
            var alreadyused = this._("udp.errors.alreadyused");
            var portsInUse = {};
            $.getJSON('udp-ports/'+this.id,function(data) {
                portsInUse = data || {};
                $('#udpporttip').html(porttip + data);
            });
            $("#node-input-port").on("change", function() {
                var portnew = $("#node-input-port").val();
                if (portsInUse.hasOwnProperty($("#node-input-port").val())) {
                    RED.notify(alreadyused+" "+$("#node-input-port").val(),"warn");
                }
            });
        }
    });
</script>


<!--  The Output Node  -->
<script type="text/html" data-template-name="udp out">
    <div class="form-row">
        <label for="node-input-port"><i class="fa fa-envelope"></i> <span data-i18n="udp.label.send"></span></label>
        <select id="node-input-multicast" style="width:40%">
          <option value="false" data-i18n="udp.udpmsg"></option>
          <option value="broad" data-i18n="udp.bcmsg"></option>
          <option value="multi" data-i18n="udp.mcmsg"></option>
        </select>
        <span data-i18n="udp.label.toport"></span> <input type="text" id="node-input-port" style="width:70px">
    </div>
    <div class="form-row node-input-addr">
        <label for="node-input-addr" id="node-input-addr-label"><i class="fa fa-list"></i> <span data-i18n="udp.label.address"></span></label>
        <input type="text" id="node-input-addr" data-i18n="[placeholder]udp.placeholder.address" style="width:50%;">
        <select id="node-input-ipv" style="width:70px">
          <option value="udp4">ipv4</option>
          <option value="udp6">ipv6</option>
        </select>
    </div>
    <div class="form-row node-input-iface">
        <label for="node-input-iface"><i class="fa fa-random"></i> <span data-i18n="udp.label.interface"></span></label>
        <input type="text" id="node-input-iface" data-i18n="[placeholder]udp.placeholder.interface">
    </div>
    <div class="form-row">
        <label for="node-input-outport-type">&nbsp;</label>
        <select id="node-input-outport-type">
          <option id="node-input-outport-type-random" value="random" data-i18n="udp.bind.random"></option>
          <option value="fixed" data-i18n="udp.bind.local"></option>
        </select>
        <input type="text" id="node-input-outport" style="width:70px;">
    </div>
    <div class="form-row">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-base64" style="display:inline-block; width:auto; vertical-align:top;">
        <label for="node-input-base64" style="width:70%;"><span data-i18n="udp.label.decode-base64"></span></label>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
    <div class="form-tips"><span data-i18n="[html]udp.tip.out"></span></div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('udp out',{
        category: 'network',
        color:"Silver",
        defaults: {
            name: {value:""},
            addr: {value:""},
            iface: {value:""},
            port: {value:""},
            ipv: {value:"udp4"},
            outport: {value:""},
            base64: {value:false,required:true},
            multicast: {value:"false"}
        },
        inputs:1,
        outputs:0,
        icon: "bridge-dash.svg",
        align: "right",
        label: function() {
            return this.name||"udp "+(this.addr+":"+this.port);
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            var addresslabel = this._("udp.label.address");
            var addressph = this._("udp.placeholder.address");
            var grouplabel = this._("udp.label.group");
            var bindrandom = this._("udp.bind.random");
            var bindtarget = this._("udp.bind.target");

            var type = this.outport===""?"random":"fixed";
            $("#node-input-outport-type").val(type);

            $("#node-input-outport-type").on("change", function() {
                var type = $(this).val();
                if (type == "random") {
                    $("#node-input-outport").val("").hide();
                } else {
                    $("#node-input-outport").show();
                }
            });
            $("#node-input-outport-type").change();

            $("#node-input-multicast").on("change", function() {
                var id = $("#node-input-multicast").val();
                if (id === "multi") {
                    $(".node-input-iface").show();
                    $("#node-input-addr-label").html('<i class="fa fa-list"></i> ' + grouplabel);
                    $("#node-input-addr")[0].placeholder = '225.0.18.83';
                }
                else if (id === "broad") {
                    $(".node-input-iface").hide();
                    $("#node-input-addr-label").html('<i class="fa fa-list"></i> ' + addresslabel);
                    $("#node-input-addr")[0].placeholder = '255.255.255.255';
                }
                else {
                    $(".node-input-iface").hide();
                    $("#node-input-addr-label").html('<i class="fa fa-list"></i> ' + addresslabel);
                    $("#node-input-addr")[0].placeholder = addressph;
                }
                var type = $(this).val();
                if (type == "false") {
                    $("#node-input-outport-type-random").html(bindrandom);
                } else {
                    $("#node-input-outport-type-random").html(bindtarget);
                }
            });
            $("#node-input-multicast").change();
        }
    });
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="udp in">
    <p>A UDP input node, that produces a <code>msg.payload</code> containing a
    Buffer, string, or base64 encoded string. Supports multicast.</p>
    <p>It also provides <code>msg.ip</code> and <code>msg.port</code> set to the
    ip address and port from which the message was received.</p>
    <p><b>Note</b>: On some systems you may need root or administrator access to use
    ports below 1024 and/or broadcast.</p>
</script>

<script type="text/html" data-help-name="udp out">
    <p>This node sends <code>msg.payload</code> to the designated UDP host and port. Supports multicast.</p>
    <p>You may also use <code>msg.ip</code> and <code>msg.port</code> to set the destination values, but the statically configured values have precedence.</p>
    <p>If you select broadcast either set the address to the local broadcast ip address, or maybe try 255.255.255.255, which is the global broadcast address.</p>
    <p><b>Note</b>: On some systems you may need to be root to use ports below 1024 and/or broadcast.</p>
</script>

<!-- --- [red-module:node-red/CSV] --- -->

<script type="text/html" data-template-name="csv">
    <div class="form-row">
        <label for="node-input-temp"><i class="fa fa-list"></i> <span data-i18n="csv.label.columns"></span></label>
        <input type="text" id="node-input-temp" data-i18n="[placeholder]csv.placeholder.columns">
    </div>
    <div class="form-row">
        <label for="node-input-select-sep"><i class="fa fa-text-width"></i> <span data-i18n="csv.label.separator"></span></label>
            <select style="width:150px" id="node-input-select-sep">
                <option value="," data-i18n="csv.separator.comma"></option>
                <option value="\t" data-i18n="csv.separator.tab"></option>
                <option value=" " data-i18n="csv.separator.space"></option>
                <option value=";" data-i18n="csv.separator.semicolon"></option>
                <option value=":" data-i18n="csv.separator.colon"></option>
                <option value="#" data-i18n="csv.separator.hashtag"></option>
                <option value="" data-i18n="csv.separator.other"></option>
           </select>
           <input style="width:40px;" type="text" id="node-input-sep" pattern=".">
    </div>

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
    <hr align="middle"/>
    <div class="form-row">
        <label style="width:100%;"><span data-i18n="csv.label.c2o"></span></label>
    </div>
    <div class="form-row" style="padding-left:20px;">
        <label><i class="fa fa-sign-in"></i> <span data-i18n="csv.label.input"></span></label>
        <span data-i18n="csv.label.skip-s"></span>&nbsp;<input type="text" id="node-input-skip" style="width:40px; height:25px;"/>&nbsp;<span data-i18n="csv.label.skip-e"></span><br/>
        <label>&nbsp;</label>
        <input style="width:20px; vertical-align:baseline; margin-right:5px;" type="checkbox" id="node-input-hdrin"><label style="width:auto; margin-top:7px;" for="node-input-hdrin"><span data-i18n="csv.label.firstrow"></span></label><br/>
        <label>&nbsp;</label>
        <input style="width:20px; vertical-align:baseline; margin-right:5px;" type="checkbox" id="node-input-strings"><label style="width:auto; margin-top:7px;" for="node-input-strings"><span data-i18n="csv.label.usestrings"></span></label><br/>
        <label>&nbsp;</label>
        <input style="width:20px; vertical-align:baseline; margin-right:5px;" type="checkbox" id="node-input-include_empty_strings"><label style="width:auto; margin-top:7px;" for="node-input-include_empty_strings"><span data-i18n="csv.label.include_empty_strings"></span></label><br/>
        <label>&nbsp;</label>
        <input style="width:20px; vertical-align:baseline; margin-right:5px;" type="checkbox" id="node-input-include_null_values"><label style="width:auto; margin-top:7px;" for="node-input-include_null_values"><span data-i18n="csv.label.include_null_values"></span></label><br/>
    </div>
    <div class="form-row" style="padding-left:20px;">
        <label><i class="fa fa-sign-out"></i> <span data-i18n="csv.label.output"></span></label>
        <select type="text" id="node-input-multi" style="width:250px;">
            <option value="one" data-i18n="csv.output.row"></option>
            <option value="mult" data-i18n="csv.output.array"></option>
        </select>
    </div>
    <div class="form-row" style="margin-top:20px">
        <label style="width:100%;"><span data-i18n="csv.label.o2c"></span></label>
    </div>
    <div class="form-row" style="padding-left:20px;">
        <label><i class="fa fa-sign-out"></i> <span data-i18n="csv.label.output"></span></label>
        <!-- <input style="width:20px; vertical-align:top; margin-right:5px;" type="checkbox" id="node-input-hdrout"><label style="width:auto;" for="node-input-hdrout"><span data-i18n="csv.label.includerow"></span></span> -->
        <select style="width:60%" id="node-input-hdrout">
            <option value="none" data-i18n="csv.hdrout.none"></option>
            <option value="all" data-i18n="csv.hdrout.all"></option>
            <option value="once" data-i18n="csv.hdrout.once"></option>
        </select>
    </div>
    <div class="form-row" style="padding-left:20px;">
        <label></label>
        <label style="width:auto; margin-right:10px;" for="node-input-ret"><span data-i18n="csv.label.newline"></span></label>
        <select style="width:150px;" id="node-input-ret">
            <option value='\n' data-i18n="csv.newline.linux"></option>
            <option value='\r' data-i18n="csv.newline.mac"></option>
            <option value='\r\n' data-i18n="csv.newline.windows"></option>
       </select>
    </div>
</script>


<script type="text/javascript">
    RED.nodes.registerType('csv',{
        category: 'parser',
        color:"#DEBD5C",
        defaults: {
            name: {value:""},
            sep: {
                value:',', required:true,
                label:RED._("node-red:csv.label.separator"),
                validate:RED.validators.regex(/^.{1,2}$/)},
            //quo: {value:'"',required:true},
            hdrin: {value:""},
            hdrout: {value:"none"},
            multi: {value:"one",required:true},
            ret: {value:'\\n'},
            temp: {value:""},
            skip: {value:"0"},
            strings: {value:true},
            include_empty_strings: {value:""},
            include_null_values: {value:""}
        },
        inputs:1,
        outputs:1,
        icon: "parser-csv.svg",
        label: function() {
            return this.name||"csv";
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            if (this.hdrout === false) { this.hdrout = "none"; $("#node-input-hdrout").val("none"); }
            if (this.hdrout === true) { this.hdrout = "all"; $("#node-input-hdrout").val("all");}
            if (this.strings === undefined) { this.strings = true; $("#node-input-strings").prop('checked', true); }
            if (this.skip === undefined) { this.skip = 0; $("#node-input-skip").val("0");}
            $("#node-input-skip").spinner({ min:0 });
            if (this.sep == "," || this.sep == "\\t" || this.sep == ";" || this.sep == ":" || this.sep == " " || this.sep == "#") {
                $("#node-input-select-sep").val(this.sep);
                $("#node-input-sep").hide();
            } else {
                $("#node-input-select-sep").val("");
                $("#node-input-sep").val(this.sep);
                $("#node-input-sep").show();
            }
            $("#node-input-select-sep").on("change", function() {
                var v = $("#node-input-select-sep").val();
                $("#node-input-sep").val(v);
                if (v == "") {
                    $("#node-input-sep").val("");
                    $("#node-input-sep").show().focus();
                } else {
                    $("#node-input-sep").hide();
                }
            });
        }
    });
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="csv">
    <p>Converts between a CSV formatted string and its JavaScript object representation, in either direction.</p>
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>payload<span class="property-type">object | array | string</span></dt>
        <dd>A JavaScript object, array or CSV string.</dd>
    </dl>
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>payload<span class="property-type">object | array | string</span></dt>
        <dd>
        <ul>
            <li>If the input is a string it tries to parse it as CSV and creates a JavaScript object of key/value pairs for each line.
                The node will then either send a message for each line, or a single message containing an array of objects.</li>
            <li>If the input is a JavaScript object it tries to build a CSV string.</li>
            <li>If the input is an array of simple values, it builds a single line CSV string.</li>
            <li>If the input is an array of arrays, or an array of objects, a multiple-line CSV string is created.</li>
        </ul>
        </dd>
    </dl>
    <h3>Details</h3>
    <p>The column template can contain an ordered list of column names. When converting CSV to an object, the column names
    will be used as the property names. Alternatively, the column names can be taken from the first row of the CSV.</p>
    <p>When converting to CSV, the columns template is used to identify which properties to extract from the object and in what order.</p>
    <p>If the columns template is blank then you can use a simple comma separated list of properties supplied in <code>msg.columns</code> to
    determine what to extract and in what order. If neither are present then all the object properties are output in the order
    in which the properties are found in the first row.</p>
    <p>If the input is an array then the columns template is only used to optionally generate a row of column titles.</p>
    <p>If 'parse numerical values' option is checked, string numerical values will be returned as numbers, ie. middle value '1,"1.5",2'.</p>
    <p>If 'include empty strings' option is checked, empty strings will be returned in result, ie. middle value '"1","",3'.</p>
    <p>If 'include null values' option is checked, null values will be returned in result, ie. middle value '"1",,3'.</p>
    <p>The node can accept a multi-part input as long as the <code>parts</code> property is set correctly, for example from a file-in node or split node.</p>
    <p>If outputting multiple messages they will have their <code>parts</code> property set and form a complete message sequence.</p>
    <p>If the node is set to only send column headers once, then setting <code>msg.reset</code> to any value will cause the node to resend the headers.</p>
    <p><b>Note:</b> the column template must be comma separated - even if a different separator is chosen for the data.</p>
</script>

<!-- --- [red-module:node-red/HTML] --- -->

<script type="text/html" data-template-name="html">
    <div class="form-row">
        <label for="node-input-property"><i class="fa fa-ellipsis-h"></i> <span data-i18n="common.label.property"></span></label>
        <input type="text" id="node-input-property" style="width:70%">
    </div>
    <div class="form-row">
        <label for="node-input-tag"><i class="fa fa-filter"></i> <span data-i18n="html.label.select"></span></label>
        <input type="text" id="node-input-tag" placeholder="h1">
    </div>
    <div class="form-row">
        <label for="node-input-ret"><i class="fa fa-sign-out"></i> <span data-i18n="html.label.output"></span></label>
        <select id="node-input-ret" style="width:70%">
            <option value="html" data-i18n="html.output.html"></option>
            <option value="text" data-i18n="html.output.text"></option>
            <option value="attr" data-i18n="html.output.attr"></option>
            <!-- <option value="val">return the value from a form element</option> -->
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-as">&nbsp;</label>
        <select id="node-input-as" style="width:70%">
            <option value="single" data-i18n="html.format.single"></option>
            <option value="multi" data-i18n="html.format.multi"></option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-outproperty">&nbsp;</label>
        <span data-i18n="html.label.in" style="padding-left:8px; padding-right:2px; vertical-align:-1px;"></span> <input type="text" id="node-input-outproperty" style="width:64%">
    </div>
    <br/>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" style="width:70%" data-i18n="[placeholder]common.label.name">
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('html',{
        category: 'parser',
        color:"#DEBD5C",
        defaults: {
            name: {value:""},
            property: {value:"payload", validate: RED.validators.typedInput({ type: 'msg', allowUndefined: true }) },
            outproperty: {value:"payload", validate: RED.validators.typedInput({ type: 'msg', allowUndefined: true }) },
            tag: {value:""},
            ret: {value:"html"},
            as: {value:"single"}
        },
        inputs:1,
        outputs:1,
        icon: "parser-html.svg",
        label: function() {
            return this.name||this.tag||"html";
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            $("#node-input-property").typedInput({default:'msg',types:['msg']});
            $("#node-input-outproperty").typedInput({default:'msg',types:['msg']});
        }
    });
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="html">
    <p>Extracts elements from an html document held in <code>msg.payload</code> using a CSS selector.</p>
    <h3>Inputs</h3>
    <dl class="message-properties">
    <dt>payload <span class="property-type">string</span></dt>
    <dd>the html string from which to extract elements.</dd>
    <dt class="optional">select <span class="property-type">string</span></dt>
    <dd>if not configured in the edit panel the selector can be set as a property of msg.</dd>
</dl>
    <h3>Output</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">array | string</span></dt>
        <dd>the result can be either a single message with a payload containing an array of the matched elements, or multiple
           messages that each contain a matched element. If multiple messages are sent they will also have <code>parts</code> set.</dd>
    </dl>
    <h3>Details</h3>
    <p>This node supports a combination of CSS and jQuery selectors. See the
    <a href="https://github.com/fb55/CSSselect#user-content-supported-selectors" target="_blank">css-select documentation</a> for more information
    on the supported syntax.</p>
</script>

<!-- --- [red-module:node-red/JSON] --- -->

<script type="text/html" data-template-name="json">
    <div class="form-row">
        <label for="node-input-action"><i class="fa fa-dot-circle-o"></i> <span data-i18n="json.label.action"></span></label>
        <select style="width:70%" id="node-input-action">
            <option value=""    data-i18n="json.label.actions.toggle"></option>
            <option value="str" data-i18n="json.label.actions.str"></option>
            <option value="obj" data-i18n="json.label.actions.obj"></option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-property"><i class="fa fa-ellipsis-h"></i> <span data-i18n="json.label.property"></span></label>
        <input type="text" id="node-input-property" style="width:70%;"/>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
    <hr align="middle"/>
    <div class="form-row node-json-to-json-options">
        <label style="width:100%;"><span data-i18n="json.label.o2j"></span></label>
    </div>
    <div class="form-row node-json-to-json-options" style="padding-left: 20px;">
        <input style="width:20px; vertical-align:top; margin-right: 5px;" type="checkbox" id="node-input-pretty"><label style="width: auto;" for="node-input-pretty" data-i18n="json.label.pretty"></label>
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('json',{
        category: 'parser',
        color:"#DEBD5C",
        defaults: {
            name: {value:""},
            property: {value:"payload",required:true,
                       validate: RED.validators.typedInput({ type: 'msg', allowUndefined: true}),
                       label:RED._("node-red:json.label.property")},
            action: {value:""},
            pretty: {value:false}
        },
        inputs:1,
        outputs:1,
        icon: "parser-json.svg",
        label: function() {
            return this.name||"json";
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            if (this.property === undefined) {
                $("#node-input-property").val("payload");
            }
            $("#node-input-property").typedInput({default:'msg',types:['msg']});
            $("#node-input-action").on("change", function() {
                if (this.value === "" || this.value === "str") {
                    $(".node-json-to-json-options").show();
                } else {
                    $(".node-json-to-json-options").hide();
                }
            });
            $("#node-input-action").change();
        }
    });
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="json">
    <p>Converts between a JSON string and its JavaScript object representation, in either direction.</p>
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>payload<span class="property-type">object | string</span></dt>
        <dd>A JavaScript object or JSON string.</dd>
        <dt>schema<span class="property-type">object</span></dt>
        <dd>An optional JSON Schema object to validate the payload against.
        The property will be deleted before the <code>msg</code> is sent to the next node.</dd>
    </dl>
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>payload<span class="property-type">object | string</span></dt>
        <dd>
            <ul>
                <li>If the input is a JSON string it tries to parse it to a JavaScript object.</li>
                <li>If the input is a JavaScript object it creates a JSON string. The string can optionally be well-formatted.</li>
            </ul>
        </dd>
        <dt>schemaError<span class="property-type">array</span></dt>
        <dd>If JSON schema validation fails, the catch node will have a <code>schemaError</code> property
            containing an array of errors.</dd>
    </dl>
    <h3>Details</h3>
    <p>By default, the node operates on <code>msg.payload</code>, but can be configured
       to convert any message property.</p>
    <p>The node can also be configured to ensure a particular encoding instead of toggling
       between the two. This can be used, for example, with the <code>HTTP In</code>
       node to ensure the payload is a parsed object even if an incoming request
       did not set its content-type correctly for the HTTP In node to do the conversion.</p>
    <p>If the node is configured to ensure the property is encoded as a String and it
       receives a String, no further checks will be made of the property. It will
       not check the String is valid JSON nor will it reformat it if the format option
       is selected.</p>
    <p>For more details about JSON Schema you can consult the specification
    <a href="http://json-schema.org/latest/json-schema-validation.html">here</a>.</p>
</script>

<!-- --- [red-module:node-red/XML] --- -->

<script type="text/html" data-template-name="xml">
    <div class="form-row">
        <label for="node-input-property"><i class="fa fa-ellipsis-h"></i> <span data-i18n="common.label.property"></span></label>
        <input type="text" id="node-input-property" style="width:70%;"/>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
    <hr align="middle"/>
    <div class="form-row">
        <label style="width:100%;"><span data-i18n="xml.label.x2o"></span></label>
    </div>
    <div class="form-row" style="padding-left: 20px;">
        <label style="width:250px;" for="node-input-attr" data-i18n="xml.label.represent"></label> <input type="text" id="node-input-attr" style="text-align:center; width:40px" placeholder="$">
    </div>
    <div class="form-row" style="padding-left: 20px;">
        <label style="width:250px;" for="node-input-chr" data-i18n="xml.label.prefix"></label> <input type="text" id="node-input-chr" style="text-align:center; width:40px" placeholder="_">
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('xml',{
        category: 'parser',
        color:"#DEBD5C",
        defaults: {
            name: {value:""},
            property: {value:"payload",required:true,
                       label:RED._("node-red:common.label.property"),
                       validate: RED.validators.typedInput({ type: 'msg', allowUndefined: true })},
            attr: {value:""},
            chr: {value:""}
        },
        inputs:1,
        outputs:1,
        icon: "parser-xml.svg",
        label: function() {
            return this.name||"xml";
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            if (this.property === undefined) {
                $("#node-input-property").val("payload");
            }
            $("#node-input-property").typedInput({default:'msg',types:['msg']});
        }
    });
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="xml">
    <p>Converts between an XML string and its JavaScript object representation, in either direction.</p>
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>payload<span class="property-type">object | string</span></dt>
        <dd>A JavaScript object or XML string.</dd>
        <dt class="optional">options <span class="property-type">object</span></dt>
        <dd>This optional property can be used to pass in any of the options supported by the underlying
            library used to convert to and from XML. See <a href="https://github.com/Leonidas-from-XIV/node-xml2js/blob/master/README.md#options" target="_blank">the xml2js docs</a>
            for more information.</dd>
    </dl>
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>payload<span class="property-type">object | string</span></dt>
        <dd>
            <ul>
                <li>If the input is a string it tries to parse it as XML and creates a JavaScript object.</li>
                <li>If the input is a JavaScript object it tries to build an XML string.</li>
            </ul>
        </dd>
    </dl>
    <h3>Details</h3>
    <p>When converting between XML and an object, any XML attributes are added as a property named <code>$</code> by default.
    Any text content is added as a property named <code>_</code>. These property names can be specified in the node configuration.</p>
    <p>For example, the following XML will be converted as shown:</p>
    <pre>&lt;p class="tag"&gt;Hello World&lt;/p&gt;</pre>
    <pre>{
  "p": {
    "$": {
      "class": "tag"
    },
    "_": "Hello World"
  }
}</pre>
</script>

<!-- --- [red-module:node-red/YAML] --- -->

<script type="text/html" data-template-name="yaml">
    <div class="form-row">
        <label for="node-input-property"><i class="fa fa-ellipsis-h"></i> <span data-i18n="common.label.property"></span></label>
        <input type="text" id="node-input-property" style="width:70%;"/>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('yaml',{
        category: 'parser',
        color:"#DEBD5C",
        defaults: {
            property: {value:"payload",required:true,
                       validate: RED.validators.typedInput({ type: 'msg', allowUndefined: true }),
                       label:RED._("node-red:common.label.property")},
            name: {value:""}
        },
        inputs:1,
        outputs:1,
        icon: "parser-yaml.svg",
        label: function() {
            return this.name||"yaml";
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            if (this.property === undefined) {
                $("#node-input-property").val("payload");
            }
            $("#node-input-property").typedInput({default:'msg',types:['msg']});
        }
    });
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="yaml">
    <p>Converts between a YAML formatted string and its JavaScript object representation, in either direction.</p>
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>payload<span class="property-type">object | string</span></dt>
        <dd>A JavaScript object or YAML string.</dd>
    </dl>
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>payload<span class="property-type">object | string</span></dt>
        <dd>
            <ul>
                <li>If the input is a YAML string it tries to parse it to a JavaScript object.</li>
                <li>If the input is a JavaScript object it creates a YAML string.</li>
            </ul>
        </dd>
    </dl>
</script>

<!-- --- [red-module:node-red/split] --- -->
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-template-name="split">
    <div class="form-row"><span data-i18n="[html]split.intro"></span></div>
    <div class="form-row"><span data-i18n="[html]split.strBuff"></span></div>
    <div class="form-row">
        <label for="node-input-splt" style="padding-left:10px; margin-right:-10px;" data-i18n="split.splitUsing"></label>
        <input type="text" id="node-input-splt" style="width:70%">
        <input type="hidden" id="node-input-spltType">
    </div>
    <div class="form-row">
        <input type="checkbox" id="node-input-stream" style="margin-left:10px; vertical-align:top; width:auto;">
        <label for="node-input-stream" style="width:auto;" data-i18n="split.stream"></label>
    </div>
    <div class="form-row"><span data-i18n="[html]split.array"></span></div>
    <div class="form-row">
        <label for="node-input-arraySplt" style="padding-left:10px; margin-right:-10px;" data-i18n="split.splitUsing"></label>
        <input type="text" id="node-input-arraySplt" style="width:70%">
        <input type="hidden" id="node-input-arraySpltType">
    </div>
    <div class="form-row"><span data-i18n="[html]split.object"></span></div>
    <div class="form-row" style="padding-left: 10px"><span data-i18n="[html]split.objectSend"></span></div>
    <div class="form-row">
        <input type="checkbox" id="node-input-addname-cb" style="margin-left:10px; vertical-align:baseline; width:auto;">
        <label for="node-input-addname-cb" style="width:auto;" data-i18n="split.addname"></label>
        <input type="text" id="node-input-addname" style="width:70%">
    </div>
    <hr/>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('split',{
        category: 'sequence',
        color:"#E2D96E",
        defaults: {
            name: {value:""},
            splt: {value:"\\n"},
            spltType: {value:"str"},
            arraySplt: {value:1},
            arraySpltType: {value:"len"},
            stream: {value:false},
            addname: {value:"", validate: RED.validators.typedInput({ type: 'msg', allowBlank: true })}
        },
        inputs:1,
        outputs:1,
        icon: "split.svg",
        label: function() {
            return this.name||this._("split.split");
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            $("#node-input-splt").typedInput({
                default: 'str',
                typeField: $("#node-input-spltType"),
                types:[
                    'str',
                    'bin',
                    {value:"len", label:RED._("node-red:split.splitLength"),validate:/^\d+$/}
                ]
            });
            if (this.arraySplt === undefined) {
                $("#node-input-arraySplt").val(1);
            }
            $("#node-input-arraySplt").typedInput({
                default: 'len',
                typeField: $("#node-input-arraySpltType"),
                types:[
                    {value:"len", label:RED._("node-red:split.splitLength"),validate:/^\d+$/}
                ]
            });
            $("#node-input-addname").typedInput({
                typeField: $("#node-input-fnameType"),
                types:['msg']
            });

            $("#node-input-addname-cb").on("change", function() {
                $("#node-input-addname").prop('disabled',!this.checked);
            })
            if (this.addname === "") {
                $("#node-input-addname-cb").prop('checked',false);
                $("#node-input-addname").val('topic');
            } else {
                $("#node-input-addname-cb").prop('checked',true);
            }
            $("#node-input-addname-cb").change();
        },
        oneditsave: function() {
            if (!$("#node-input-addname-cb").prop('checked')) {
                $("#node-input-addname").val('');
            }
        }
    });
</script>


<script type="text/html" data-template-name="join">
    <div class="form-row">
        <label data-i18n="join.mode.mode"></label>
        <select id="node-input-mode" style="width:200px;">
            <option value="auto" data-i18n="join.mode.auto"></option>
            <option value="custom" data-i18n="join.mode.custom"></option>
            <option value="reduce" data-i18n="join.mode.reduce"></option>
        </select>
    </div>
    <div class="node-row-custom">
        <div class="form-row node-row-property">
            <label data-i18n="join.combine"> </label>
            <input type="text" id="node-input-property" style="width:70%;">
            <input type="hidden" id="node-input-propertyType">
        </div>
        <div class="form-row">
            <label data-i18n="join.create"></label>
            <select id="node-input-build" style="width:70%;">
                <option value="string" data-i18n="join.type.string"></option>
                <option value="buffer" data-i18n="join.type.buffer"></option>
                <option value="array" data-i18n="join.type.array"></option>
                <option value="object" data-i18n="join.type.object"></option>
                <option value="merged" data-i18n="join.type.merged"></option>
            </select>
        </div>
        <div class="form-row node-row-key">
            <label style="vertical-align:top; margin-top:7px; width:auto; margin-right: 5px;" data-i18n="join.using"></label>
            <div style="display:inline-block">
                <input type="text" id="node-input-key" style="width:220px;"> <span data-i18n="join.key"></span>
            </div>
        </div>
        <div class="form-row node-row-joiner">
            <label for="node-input-joiner" data-i18n="join.joinedUsing"></label>
            <input type="text" id="node-input-joiner" style="width:70%">
            <input type="hidden" id="node-input-joinerType">
        </div>
        <div class="form-row node-row-trigger" id="trigger-row">
            <label style="width:auto;" data-i18n="join.send"></label>
            <ul>
                <li>
                    <label style="width:280px;" for="node-input-count" data-i18n="join.afterCount"></label> <input id="node-input-count" data-i18n="[placeholder]join.count" type="text" style="width:75px;">
                </li>
                <li class="node-row-accumulate" style="list-style-type:none;">
                    <input type="checkbox" id="node-input-accumulate" style="display:inline-block; width:20px; margin-left:20px; vertical-align:top;">  <label style="width: auto" for="node-input-accumulate" data-i18n="join.subsequent"></label>
                </li>
                <li>
                    <label style="width:280px;" for="node-input-timeout" data-i18n="join.afterTimeout"></label> <input id="node-input-timeout" data-i18n="[placeholder]join.seconds" type="text" style="width:75px;">
                </li>
                <li>
                    <label style="width:auto; padding-top:6px;" data-i18n="[html]join.complete"></label>
                </li>
            </ul>
        </div>
    </div>
    <div class="node-row-reduce">
        <div class="form-row">
            <label for="node-input-reduceExp" data-i18n="join.reduce.exp" style="margin-left:10px;"></label>
            <input type="text" id="node-input-reduceExp" data-i18n="[placeholder]join.reduce.exp-value" style="width:65%">
        </div>
        <div class="form-row">
            <label for="node-input-reduceInit" data-i18n="join.reduce.init" style="margin-left:10px;"></label>
            <input type="text" id="node-input-reduceInit" data-i18n="[placeholder]join.reduce.init" style="width:65%">
            <input type="hidden" id="node-input-reduceInitType">
        </div>
        <div class="form-row">
            <label for="node-input-reduceFixup" data-i18n="join.reduce.fixup" style="margin-left:10px;"></label>
            <input type="text" id="node-input-reduceFixup" data-i18n="[placeholder]join.reduce.exp-value" style="width:65%">
        </div>
        <div class="form-row">
            <label>&nbsp;</label>
            <input type="checkbox" id="node-input-reduceRight" style="display:inline-block; width:auto; vertical-align:top; margin-left:10px;">
            <label for="node-input-reduceRight" style="width:70%;" data-i18n="join.reduce.right" style="margin-left:10px;"/>
        </div>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
    <div class="form-tips form-tips-auto hide" data-i18n="[html]join.tip"></div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('join',{
        category: 'sequence',
        color:"#E2D96E",
        defaults: {
            name: {value:""},
            mode: {value:"auto"},
            build: { value:"object"},
            property: {
                value:"payload",
                label: RED._("node-red:join.message-prop"),
                validate:RED.validators.typedInput("propertyType", false)
            },
            propertyType: { value:"msg"},
            key: {value:"topic", validate: (function () {
                const typeValidator = RED.validators.typedInput({ type: 'msg' })
                return function(v, opt) {
                    const joinMode = $("#node-input-mode").val() || this.mode
                    if (joinMode !== 'custom') {
                        return true
                    }
                    const buildType = $("#node-input-build").val() || this.build
                    if (buildType !== 'object') {
                        return true
                    } else {
                        return typeValidator(v, opt)
                    }
                }
                })()
            },
            joiner: { value:"\\n"},
            joinerType: { value:"str"},
            accumulate: { value:"false" },
            timeout: {value:""},
            count: {value:""},
            reduceRight: {value:false},
            reduceExp: {value:undefined},
            reduceInit: {value:undefined},
            reduceInitType: {value:undefined},
            reduceFixup: {value:undefined}
        },
        inputs:1,
        outputs:1,
        icon: "join.svg",
        label: function() {
            var nam = this.name||this._("join.join");
            if (this.mode === "custom" && !isNaN(Number(this.count))) {
                nam += " "+this.count;
                if (this.accumulate === true) { nam+= "+"; }
            }
            return nam;
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            var node = this;

            $("#node-input-mode").on("change", function(e) {
                var val = $(this).val();
                $(".node-row-custom").toggle(val==='custom');
                $(".node-row-reduce").toggle(val==='reduce');
                $(".form-tips-auto").toggle((val==='auto') || (val==='reduce'));
                if (val === "auto") {
                    $("#node-input-accumulate").attr('checked', false);
                }
                else if (val === "custom") {
                    $("#node-input-build").change();
                }
                else if (val === "reduce") {
                    var jsonata_or_empty = {
                        value: "jsonata",
                        label: "expression",
                        icon: "red/images/typedInput/expr.svg",
                        validate: function(v) {
                            try{
                                if(v !== "") {
                                    jsonata(v);
                                }
                                return true;
                            }
                            catch(e){
                                return false;
                            }
                        },
                        expand:function() {
                            var that = this;
                            RED.editor.editExpression({
                                value: this.value().replace(/\t/g,"\n"),
                                complete: function(v) {
                                    that.value(v.replace(/\n/g,"\t"));
                                }
                            })
                        }
                    };
                    $("#node-input-reduceExp").typedInput({types:[jsonata_or_empty]});
                    $("#node-input-reduceInit").typedInput({
                        default: 'num',
                        types:['flow','global','str','num','bool','json','bin','date','jsonata','env'],
                        typeField: $("#node-input-reduceInitType")
                    });
                    $("#node-input-reduceFixup").typedInput({types:[jsonata_or_empty]});
                }
            });

            $("#node-input-build").on("change", function(e) {
                var val = $(this).val();
                $(".node-row-key").toggle(val==='object');
                $(".node-row-accumulate").toggle(val==='object' || val==='merged');
                $(".node-row-joiner").toggle(val==='string' || val==='buffer');
                $(".node-row-trigger").toggle(val!=='auto');
                if (val === 'string' || val==='buffer') {
                    $("#node-input-property").typedInput('types',['msg']);
                    $("#node-input-joiner").typedInput("show");
                } else {
                    $("#node-input-property").typedInput('types', ['msg', {
                        value: "full",
                        label: RED._("node-red:join.completeMessage"),
                        hasValue: false
                    }]);
                }
            });

            $("#node-input-joiner").typedInput({
                default: 'str',
                typeField: $("#node-input-joinerType"),
                types:['str', 'bin']
            });

            $("#node-input-property").typedInput({
                typeField: $("#node-input-propertyType"),
                types: ['msg', {
                    value: "full",
                    label: RED._("node-red:join.completeMessage"),
                    hasValue: false
                }]
            });

            $("#node-input-key").typedInput({
                types:['msg']
            });

            $("#node-input-build").change();
            $("#node-input-mode").change();
        },
        oneditsave: function() {
            var build = $("#node-input-build").val();
            if (build !== 'object' && build !== 'merged') {
                $("#node-input-accumulate").prop("checked",false);
            }
        }
    });
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="split">
    <p>Splits a message into a sequence of messages.</p>

    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>payload<span class="property-type">object | string | array | buffer</span></dt>
        <dd>The behaviour of the node is determined by the type of <code>msg.payload</code>:
            <ul>
                <li><b>string</b>/<b>buffer</b> - the message is split using the specified character (default: <code>\n</code>), buffer sequence or into fixed lengths.</li>
                <li><b>array</b> - the message is split into either individual array elements, or arrays of a fixed-length.</li>
                <li><b>object</b> - a message is sent for each key/value pair of the object.</li>
            </ul>
        </dd>
    </dl>
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>parts<span class="property-type">object</span></dt>
        <dd>This property contains information about how the message was split from
        the original message. If passed to the <b>join</b> node, the sequence can be
        reassembled into a single message. The property has the following properties:
        <ul>
            <li><code>id</code> - an identifier for the group of messages</li>
            <li><code>index</code> - the position within the group</li>
            <li><code>count</code> - if known, the total number of messages in the group. See 'streaming mode' below.</li>
            <li><code>type</code> - the type of message - string/array/object/buffer</li>
            <li><code>ch</code> - for a string or buffer, the data used to the split the message as either the string or an array of bytes</li>
            <li><code>key</code> - for an object, the key of the property this message was created from. The node can be configured to also copy this value to another message properties, such as <code>msg.topic</code>.</li>
            <li><code>len</code> - the length of each message when split using a fixed length value</li>
        </ul>
        </dd>
    </dl>
    <h3>Details</h3>
    <p>This node makes it easy to create a flow that performs common actions across
    a sequence of messages before, using the <b>join</b> node, recombining the
    sequence into a single message.</p>
    <p>It uses the <code>msg.parts</code> property to track the individual parts
    of a sequence.</p>
    <h4>Streaming mode</h4>
    <p>The node can also be used to reflow a stream of messages. For example, a
    serial device that sends newline-terminated commands may deliver a single message
    with a partial command at its end. In 'streaming mode', this node will split
    a message and send each complete segment. If there is a partial segment at the end,
    the node will hold on to it and prepend it to the next message that is received.
    </p>
    <p>When operating in this mode, the node will not set the <code>msg.parts.count</code>
    property as it does not know how many messages to expect in the stream. This
    means it cannot be used with the <b>join</b> node in its automatic mode.</p>
</script>

<script type="text/html" data-help-name="join">
    <p>Joins sequences of messages into a single message.</p>
    <p>There are three modes available:</p>
    <dl>
        <dt>automatic</dt>
        <dd>When paired with the <b>split</b> node, it will automatically join the messages to reverse the split that was performed.</dd>
        <dt>manual</dt>
        <dd>Join sequences of messages in a variety of ways.</dd>
        <dt>reduce sequence</dt>
        <dd>Apply an expression against all messages in a sequence to reduce it to a single message.</dd>
    </dl>
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt class="optional">parts<span class="property-type">object</span></dt>
        <dd>To automatically join a sequence of messages, they should all have
        this property set. The <b>split</b> node generates this property but it
        can be manually created. It has the following properties:
        <ul>
            <li><code>id</code> - an identifier for the group of messages</li>
            <li><code>index</code> - the position within the group</li>
            <li><code>count</code> - the total number of messages in the group</li>
            <li><code>type</code> - the type of message - string/array/object/buffer</li>
            <li><code>ch</code> - for a string or buffer, the data used to the split the message as either the string or an array of bytes</li>
            <li><code>key</code> - for an object, the key of the property this message was created from</li>
            <li><code>len</code> - the length of each message when split using a fixed length value</li>
        </ul>
        </dd>
        <dt class="optional">complete</dt>
        <dd>If set, the node will append the payload, and then send the output message in its current state.
            If you don't wish to append the payload, delete it from the msg.</dd>
        <dt class="optional">reset</dt>
        <dd>If set, the node will clear any partially complete message and not send it.</dd>
        <dt class="optional">restartTimeout</dt>
        <dd>If set, and the node has a timeout configured, that timeout will be restarted.</dd>
    </dl>
    <h3>Details</h3>

    <h4>Automatic mode</h4>
    <p>Automatic mode uses the <code>parts</code> property of incoming messages to
       determine how the sequence should be joined. This allows it to automatically
       reverse the action of a <b>split</b> node.

    <h4>Manual mode</h4>
    <p>When configured to join in manual mode, the node is able to join sequences
     of messages into a number of different results:</p>
    <ul>
        <li>a <b>string</b> or <b>buffer</b> - created by joining the selected property of each message with the specified join characters or buffer.</li>
        <li>an <b>array</b> - created by adding each selected property, or entire message, to the output array.</li>
        <li>a <b>key/value object</b> - created by using a property of each message to determine the key under which
        the required value is stored.</li>
        <li>a <b>merged object</b> - created by merging the property of each message under a single object.</li>
    </ul>
    <p>The other properties of the output message are taken from the last message received before the result is sent.</p>
    <p>A <i>count</i> can be set for how many messages should be received before generating the output message.
    For object outputs, once this count has been reached, the node can be configured to send a message for each subsequent message
    received.</p>
    <p>A <i>timeout</i> can be set to trigger sending the new message using whatever has been received so far.
     This timeout can be restarted by sending a message with the <code>msg.restartTimeout</code> property set.</p>
    <p>If a message is received with the <code>msg.complete</code> property set, the output message is finalised and sent.
    This resets any part counts.</p>
    <p>If a message is received with the <code>msg.reset</code> property set, the partly complete message is deleted and not sent.
    This resets any part counts.</p>

    <h4>Reduce Sequence mode</h4>
    <p>When configured to join in reduce mode, an expression is applied to each
       message in a sequence and the result accumulated to produce a single message.</p>

    <dl class="message-properties">
        <dt>Initial value</dt>
        <dd>The initial value of the accumulated value (<code>$A</code>).</dd>
        <dt>Reduce expression</dt>
        <dd>A JSONata expression that is called for each message in the sequence.
            The result is passed to the next call of the expression as the accumulated value.
            In the expression, the following special variables can be used:
            <ul>
                <li><code>$A</code>: the accumulated value, </li>
                <li><code>$I</code>: index of the message in the sequence, </li>
                <li><code>$N</code>: number of messages in the sequence.</li>
            </ul>
        </dd>
        <dt>Fix-up expression</dt>
        <dd>An optional JSONata expression that is applied after the reduce expression
            has been applied to all messages in the sequence.
            In the expression, following special variables can be used:
            <ul>
                <li><code>$A</code>: the accumulated value, </li>
                <li><code>$N</code>: number of messages in the sequence.</li>
            </ul>
        </dd>
        <p>By default, the reduce expression is applied in order, from the first
           to the last message of the sequence. It can optionally be applied in
           reverse order.</p>
        <p>$N is the number of messages that arrive - even if they are identical.</p>
    </dl>
    <p><b>Example:</b> the following settings, given a sequence of numeric values,
       calculates the average value:
        <ul>
            <li><b>Reduce expression</b>: <code>$A+payload</code></li>
            <li><b>Initial value</b>: <code>0</code></li>
            <li><b>Fix-up expression</b>: <code>$A/$N</code></li>
        </ul>
    </p>
    <h4>Storing messages</h4>
    <p>This node will buffer messages internally in order to work across sequences. The
       runtime setting <code>nodeMessageBufferMaxLength</code> can be used to limit how many messages nodes
       will buffer.</p>
</script>

<!-- --- [red-module:node-red/sort] --- -->
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-template-name="sort">

    <div class="form-row">
        <label for="node-input-target"><i class="fa fa-dot-circle-o"></i> <span data-i18n="sort.target"></span></label>
        <input type="text" id="node-input-target" style="width:70%;">
        <input type="hidden" id="node-input-targetType">
    </div>

    <div class="node-row-sort-msg-key">
        <div class="form-row">
            <label for="node-input-msgKey"><i class="fa fa-filter"></i> <span data-i18n="sort.key"></span></label>
            <input type="text" id="node-input-msgKey" style="width:70%;">
            <input type="hidden" id="node-input-msgKeyType">
        </div>
    </div>

    <div class="node-row-sort-seq-key">
        <div class="form-row">
            <label for="node-input-seqKey"><i class="fa fa-filter"></i> <span data-i18n="sort.key"></span></label>
            <input type="text" id="node-input-seqKey" style="width:70%;">
            <input type="hidden" id="node-input-seqKeyType">
        </div>
    </div>

    <div class="form-row">
        <label><i class="fa fa-random"></i>  <span data-i18n="sort.order"></span></label>
        <select id="node-input-order" style="width:200px;">
            <option value="ascending" data-i18n="sort.ascending"></option>
            <option value="descending" data-i18n="sort.descending"></option>
        </select>
    </div>

    <div class="form-row" id="node-as_num">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-as_num" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-as_num" style="width: 70%;" data-i18n="sort.as-number"></label>
    </div>

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('sort',{
        category: 'sequence',
        color:"#E2D96E",
        defaults: {
            name: { value:"" },
            order: { value:"ascending" },
            as_num: { value:false },
            target: { value:"payload" },
            targetType: { value:"msg" },
            msgKey: { value:"payload" },
            msgKeyType: { value:"elem" },
            seqKey: { value:"payload" },
            seqKeyType: { value:"msg" }
        },
        inputs:1,
        outputs:1,
        icon: "sort.svg",
        label: function() {
            return this.name||this._("sort.sort");
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function() {
            var seq = {
                value: "seq",
                label: RED._("node-red:sort.seq"),
                hasValue: false
            };
            var elem = {
                value: "elem",
                label: RED._("node-red:sort.elem"),
                hasValue: false
            };
            $("#node-input-target").typedInput({
                default:'msg',
                typeField: $("#node-input-targetType"),
                types:['msg', seq]
            });
            $("#node-input-msgKey").typedInput({
                default:'elem',
                typeField: $("#node-input-msgKeyType"),
                types:[elem, 'jsonata']
            });
            $("#node-input-seqKey").typedInput({
                default:'msg',
                typeField: $("#node-input-seqKeyType"),
                types:['msg', 'jsonata']
            });
            $("#node-input-target").on("change", function(e) {
                var val = $("#node-input-target").typedInput('type');
                $(".node-row-sort-msg-key").toggle(val === "msg");
                $(".node-row-sort-seq-key").toggle(val === "seq");
            });
            $("#node-input-target").change();
        }
    });
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="sort">
    <p>A function that sorts message property or a sequence of messages.</p>
    <p>When configured to sort message property, the node sorts array data pointed to by specified message property.</p>
    <p>When configured to sort a sequence of messages, it will reorder the messages.</p>
    <p>The sorting order can be:</p>
    <ul>
        <li><b>ascending</b>,</li>
        <li><b>descending</b>.</li>
    </ul>
    <p>For numbers, numerical ordering can be specified by a checkbox.</p>
    <p>Sort key can be element value or JSONata expression for sorting property value, or message property or JSONata expression for sorting a message sequence.<p>
    <p>When sorting a message sequence, the sort node relies on the received messages to have <code>msg.parts</code> set.  The split node generates this property, but can be manually created.  It has the following properties:</p>
    <p>
        <ul>
            <li><code>id</code> - an identifier for the group of messages</li>
            <li><code>index</code> - the position within the group</li>
            <li><code>count</code> - the total number of messages in the group</li>
        </ul>
    </p>
    <p><b>Note:</b> This node internally keeps messages for its operation.  In order to prevent unexpected memory usage, maximum number of messages kept can be specified.  Default is no limit on number of messages.
        <ul>
            <li><code>nodeMessageBufferMaxLength</code> property set in <b>settings.js</b>.</li>
        </ul>
    </p>
</script>

<!-- --- [red-module:node-red/batch] --- -->
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-template-name="batch">
    <div class="form-row">
        <label for="node-input-mode"><span data-i18n="batch.mode.label"></span></label>
        <select type="text" id="node-input-mode" style="width: 300px;">
            <option value="count" data-i18n="batch.mode.num-msgs"></option>
            <option value="interval" data-i18n="batch.mode.interval"></option>
            <option value="concat" data-i18n="batch.mode.concat"></option>
        </select>
    </div>

    <div class="node-row-msg-count">
        <div class="form-row node-row-count">
            <label style="margin-left: 10px; width: 175px;" for="node-input-count" data-i18n="batch.count.label"></label>
            <input type="text" id="node-input-count" style="width: 50px;">
        </div>
    </div>

    <div class="node-row-msg-overlap">
        <div class="form-row node-row-overlap">
            <label style="margin-left: 10px; width: 175px;" for="node-input-overlap" data-i18n="batch.count.overlap"></label>
            <input type="text" id="node-input-overlap" style="width: 50px;">
        </div>
    </div>

    <div class="node-row-msg-interval">
        <div class="form-row node-row-interval">
            <label style="margin-left: 10px; width: 175px;" for="node-input-interval"> <span data-i18n="batch.interval.label"></span></label>
            <input type="text" id="node-input-interval" style="width: 50px;">
            <span data-i18n="batch.interval.seconds"></span>
        </div>
        <div class="form-row">
            <input type="checkbox" id="node-input-allowEmptySequence" style="margin-left:20px; margin-right: 10px; vertical-align:top; width:auto;">
            <label for="node-input-allowEmptySequence" style="width:auto;" data-i18n="batch.interval.empty"></label>
        </div>
    </div>

    <div class="node-row-msg-concat">
        <div class="form-row">
            <label data-i18n="batch.concat.topics-label"></label>
            <div class="form-row node-input-topics-container-row">
                <ol id="node-input-topics-container"></ol>
            </div>
        </div>
    </div>

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>

</script>

<script type="text/javascript">
    RED.nodes.registerType("batch",{
        category: "sequence",
        color:"#E2D96E",
        defaults: {
            name: {value:""},
            mode: {value:"count"},
            count: {
                value:10,
                validate:function(v, opt) {
                    if (RED.validators.number(v) && (v >= 1)) {
                        return true;
                    }
                    return RED._("node-red:batch.error.invalid-count");
                }
            },
            overlap: {
                value:0,
                validate:function(v, opt) {
                    if (RED.validators.number(v) && (v >= 0)) {
                        return true;
                    }
                    return RED._("node-red:batch.error.invalid-overlap");
                }
            },
            interval: {
                value:10,
                validate:function(v, opt) {
                    if (RED.validators.number(v) && (v >= 1)) {
                        return true;
                    }
                    return RED._("node-red:batch.error.invalid-interval");
                }
            },
            allowEmptySequence: {value:false},
            topics: {value:[{topic:""}]}
        },
        inputs:1,
        outputs:1,
        icon: "batch.svg",
        label: function() {
            var nam = this.name||this._("batch.batch");
            if (this.mode === "count" && !isNaN(Number(this.count))) {
                nam += " "+this.count;
            }
            if (this.mode === "interval" && !isNaN(Number(this.interval))) {
                nam += " "+this.interval+"s";
            }
            return nam;
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function() {
            var node = this;
            var topic_str = node._("batch.concat.topic");

            function resizeTopics(topic) {
                var newWidth = topic.width();
                topic.find('.red-ui-typedInput')
                     .typedInput("width",newWidth-15);
            }

            $("#node-input-topics-container")
                .css('min-height','150px').css('min-width','430px')
                .editableList({
                    addItem: function(container, i, opt) {
                        if (!opt.hasOwnProperty('topic')) {
                            opt.topic = "";
                        }
                        var row = $('<div/>').appendTo(container);
                        var valueField = $('<input/>',{
                            class:"node-input-topic-value",
                            type:"text",
                            style:"margin-left: 5px;"
                        }).appendTo(row)
                        .typedInput({default:'str', types:['str']});
                        valueField.typedInput('value', opt.topic);
                        valueField.typedInput('type', 'str');
                        valueField.attr('placeholder', topic_str);
                        resizeTopics(container);
                    },
                    resizeItem: resizeTopics,
                    sortable: true,
                    removable: true
                });

            $("#node-input-count").spinner({min:1});
            $("#node-input-overlap").spinner({min:0});
            $("#node-input-interval").spinner({min:1});
            $("#node-input-mode").on("change", function(e) {
                var val = $(this).val();
                $(".node-row-msg-count").toggle(val==="count");
                $(".node-row-msg-overlap").toggle(val==="count");
                $(".node-row-msg-interval").toggle(val==="interval");
                $(".node-row-msg-concat").toggle(val==="concat");
                if (val==="concat") {
                    var topics = node.topics;
                    var container = $("#node-input-topics-container");
                    container.editableList('empty');
                    for (var i = 0; i < topics.length; i++) {
                        var topic = topics[i];
                        container.editableList('addItem', topic);
                    }
                }
            });
        },
        oneditsave: function() {
            var topics = $("#node-input-topics-container").editableList('items');
            var node = this;
            node.topics = [];
            topics.each(function(i) {
                var topicData = $(this).data('data');
                var topic = $(this);
                var vf = topic.find(".node-input-topic-value");
                var value = vf.typedInput('value');
                var type = vf.typedInput('type');
                var r = {topic:value};
                node.topics.push(r);
            });
        },
        oneditresize: function(size) {
            var rows = $("#dialog-form>div:not(.node-input-topics-container-row)");
            var height = size.height;
            for (var i = 0; i < rows.length; i++) {
                height -= $(rows[i]).outerHeight(true);
            }
            var editorRow = $("#dialog-form>div.node-input-topics-container-row");
            height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));
            $("#node-input-topics-container").editableList('height',height);
        }
    });
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="batch">
    <p>Creates sequences of messages based on various rules.</p>
    <h3>Details</h3>
    <p>There are three modes for creating message sequences:</p>
    <dl>
        <dt>Number of messages</dt>
        <dd>groups messages into sequences of a given length. The <b>overlap</b>
        option specifies how many messages at the end of one sequence should be
        repeated at the start of the next sequence.</dd>

        <dt>Time interval</dt>
        <dd>groups messages that arrive within the specified interval. If no messages
            arrive within the interval, the node can optionally send on an empty message.</dd>

        <dt>Concatenate Sequences</dt>
        <dd>creates a message sequence by concatenating incoming sequences. Each message
            must have a <code>msg.topic</code> property and a <code>msg.parts</code> property
            identifying its sequence. The node is configured with a list of <code>topic</code>
            values to identify the order sequences are concatenated.
        </dd>
    </dl>
    <h4>Storing messages</h4>
    <p>This node will buffer messages internally in order to work across sequences. The
       runtime setting <code>nodeMessageBufferMaxLength</code> can be used to limit how many messages nodes
       will buffer.</p>
    <p>If a message is received with the <code>msg.reset</code> property set, the buffered messages are deleted and not sent.</p>
</script>

<!-- --- [red-module:node-red/file] --- -->

<script type="text/html" data-template-name="file">
    <div class="form-row node-input-filename">
         <label for="node-input-filename"><i class="fa fa-file"></i> <span data-i18n="file.label.filename"></span></label>
         <input id="node-input-filename" type="text">
         <input type="hidden" id="node-input-filenameType">
    </div>
    <div class="form-row">
        <label for="node-input-overwriteFile"><i class="fa fa-random"></i> <span data-i18n="file.label.action"></span></label>
        <select type="text" id="node-input-overwriteFile" style="width: 250px;">
            <option value="false" data-i18n="file.action.append"></option>
            <option value="true" data-i18n="file.action.overwrite"></option>
            <option value="delete" data-i18n="file.action.delete"></option>
        </select>
    </div>
    <div class="form-row form-row-file-write-options">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-appendNewline" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-appendNewline" style="width: 70%;"><span data-i18n="file.label.addnewline"></span></label>
    </div>
    <div class="form-row form-row-file-write-options">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-createDir" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-createDir" style="width: 70%;"><span data-i18n="file.label.createdir"></span></label>
    </div>
    <div class="form-row form-row-file-encoding">
        <label for="node-input-encoding"><i class="fa fa-flag"></i> <span data-i18n="file.label.encoding"></span></label>
        <select type="text" id="node-input-encoding" style="width: 250px;">
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name">
    </div>
    <div class="form-tips"><span data-i18n="file.tip"></span></div>
</script>

<script type="text/html" data-template-name="file in">
    <div class="form-row">
         <label for="node-input-filename"><i class="fa fa-file"></i> <span data-i18n="file.label.filename"></span></label>
         <input id="node-input-filename" type="text">
         <input type="hidden" id="node-input-filenameType">
    </div>
    <div class="form-row">
        <label for="node-input-format"><i class="fa fa-sign-out"></i> <span data-i18n="file.label.outputas"></span></label>
        <select id="node-input-format" style="width: 250px;">
            <option value="utf8" data-i18n="file.output.utf8"></option>
            <option value="lines" data-i18n="file.output.lines"></option>
            <option value="" data-i18n="file.output.buffer"></option>
            <option value="stream" data-i18n="file.output.stream"></option>
        </select>
    </div>
    <div class="form-row" id="file-allprops">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-allProps" style="display:inline-block; width:auto; vertical-align:top;">
        <label for="node-input-allProps" style="width: 70%;"><span data-i18n="file.label.allProps"></span></label>
    </div>
    <div class="form-row" id="encoding-spec">
        <label for="node-input-encoding"><i class="fa fa-flag"></i> <span data-i18n="file.label.encoding"></span></label>
        <select type="text" id="node-input-encoding" style="width:250px;">
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name">
    </div>
    <div class="form-tips"><span data-i18n="file.tip"></span></div>
</script>

<script type="text/javascript">
(function(){
    var encodings = [
        [ "file.encoding.native",
          "utf8",
          "ucs2",
          "utf-16le",
          "ascii",
          "binary",
          "base64",
          "hex"
        ],
        [ "file.encoding.unicode",
          "utf-16be",
        ],
        [ "file.encoding.japanese",
          "Shift_JIS",
          "Windows-31j",
          "Windows932",
          "EUC-JP"
        ],
        [ "file.encoding.chinese",
          "GB2312",
          "GBK",
          "GB18030",
          "Windows936",
          "EUC-CN"
        ],
        [ "file.encoding.korean",
          "KS_C_5601",
          "Windows949",
          "EUC-KR"
        ],
        [ "file.encoding.taiwan",
          "Big5",
          "Big5-HKSCS",
          "Windows950"
        ],
        [ "file.encoding.windows",
          "cp874",
          "cp1250",
          "cp1251",
          "cp1252",
          "cp1253",
          "cp1254",
          "cp1255",
          "cp1256",
          "cp1257",
          "cp1258"
        ],
        [ "file.encoding.iso",
          "ISO-8859-1",
          "ISO-8859-2",
          "ISO-8859-3",
          "ISO-8859-4",
          "ISO-8859-5",
          "ISO-8859-6",
          "ISO-8859-7",
          "ISO-8859-8",
          "ISO-8859-9",
          "ISO-8859-10",
          "ISO-8859-11",
          "ISO-8859-12",
          "ISO-8859-13",
          "ISO-8859-14",
          "ISO-8859-15",
          "ISO-8859-16"
        ],
        [ "file.encoding.ibm",
          "cp437",
          "cp737",
          "cp775",
          "cp808",
          "cp850",
          "cp852",
          "cp855",
          "cp856",
          "cp857",
          "cp858",
          "cp860",
          "cp861",
          "cp866",
          "cp869",
          "cp922",
          "cp1046",
          "cp1124",
          "cp1125",
          "cp1129",
          "cp1133",
          "cp1161",
          "cp1162",
          "cp1163"
        ],
        [ "file.encoding.mac",
          "maccroatian",
          "maccyrillic",
          "macgreek",
          "maciceland",
          "macroman",
          "macromania",
          "macthai",
          "macturkish",
          "macukraine",
          "maccenteuro",
          "macintosh"
        ],
        [ "file.encoding.koi8",
          "koi8-r",
          "koi8-u",
          "koi8-ru",
          "koi8-t"
        ],
        [ "file.encoding.misc",
          "armscii8",
          "rk1048",
          "tcvn",
          "georgianacademy",
          "georgianps",
          "pt154",
          "viscii",
          "iso646cn",
          "iso646jp",
          "hproman8",
          "tis620"
        ]
    ];

    RED.nodes.registerType('file',{
        category: 'storage',
        defaults: {
            name: {value:""},
            filename: {value:"", validate: RED.validators.typedInput({ typeField: 'filenameType' })},
            filenameType: {value:"str"},
            appendNewline: {value:true},
            createDir: {value:false},
            overwriteFile: {value:"false"},
            encoding: {value:"none"}
        },
        color:"BurlyWood",
        inputs:1,
        outputs:1,
        icon: "file-out.svg",
        label: function() {
            var fn = this.filename;
            if(this.filenameType != "str" && this.filenameType != "env" ) { fn = ""; }
            if(this.filenameType === "env") { fn = "env."+fn; }
            if (this.overwriteFile === "delete") {
                return this.name||this._("file.label.deletelabel",{file:fn});
            } else {
                return this.name||fn||this._("file.label.write");
            }
        },
        paletteLabel: RED._("node-red:file.label.write"),
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            var node = this;
            var encSel = $("#node-input-encoding");
            var label = node._("file.encoding.none");
            $("<option/>", {
                value: "none",
                label: label
            }).text(label).appendTo(encSel);
            $("<option/>", {
                value: "setbymsg",
                label: node._("file.encoding.setbymsg")
            }).text(label).appendTo(encSel);
            $("#node-input-filename").typedInput({
                default: "str",
                types: [{label:RED._("node-red:file.label.path"), value:"str", icon:""}, "msg", "jsonata", "env"],
                typeField: $("#node-input-filenameType")
            });
            if(typeof node.filenameType == 'undefined') {
                //existing node AND filenameType is not set - inplace (compatible) upgrade to new typedInput
                if(node.filename == "") { //was using empty value to denote msg.filename - set typedInput to match
                    node.filename = "filename";
                    node.filenameType = "msg";
                    $("#node-input-filename").typedInput("type", node.filenameType);
                    $("#node-input-filename").typedInput("value", node.filename);
                } else if(/^\${[^}]+}$/.test(node.filename)) { //was using an ${ENV_VAR}
                    node.filenameType = "env";
                    node.filename = node.filename.replace(/\${([^}]+)}/g, function(match, name) {
                        return (name === undefined)?"":name;
                    });
                    $("#node-input-filename").typedInput("type", node.filenameType);
                    $("#node-input-filename").typedInput("value", node.filename);
                } else { //was using a static filename - set typedInput type to str
                    node.filenameType = "str";
                    $("#node-input-filename").typedInput("type", node.filenameType);
                    $("#node-input-filename").typedInput("value", node.filename);
                }
            }
            encodings.forEach(function(item) {
                if(Array.isArray(item)) {
                    var group = $("<optgroup/>", {
                        label: node._(item[0])
                    }).appendTo(encSel);
                    for (var i = 1; i < item.length; i++) {
                        var enc = item[i];
                        $("<option/>", {
                            value: enc,
                            label: enc
                        }).text(enc).appendTo(group);
                    }
                }
                else {
                    $("<option/>", {
                        value: item,
                        label: item
                    }).text(item).appendTo(encSel);
                }
            });
            encSel.val(node.encoding);
            $("#node-input-overwriteFile").on("change",function() {
                if (this.value === "delete") {
                    $(".form-row-file-write-options").hide();
                    $(".form-row-file-encoding").hide();
                } else {
                    $(".form-row-file-write-options").show();
                    $(".form-row-file-encoding").show();
                }
            });
        }
    });

    RED.nodes.registerType('file in',{
        category: 'storage',
        defaults: {
            name: {value:""},
            filename: {value:"", validate: RED.validators.typedInput({ typeField: 'filenameType' }) },
            filenameType: {value:"str"},
            format: {value:"utf8"},
            chunk: {value:false},
            sendError: {value: false},
            encoding: {value: "none"},
            allProps: {value: false}
        },
        color:"BurlyWood",
        inputs:1,
        outputs:1,
        outputLabels: function(i) {
            var l;
            if (this.format === "utf8") {
                l = "file.label.utf8String";
            } else if (this.format === "lines") {
                l = "file.label.utf8String_plural";
            } else if (this.format === "stream") {
                l = "file.label.binaryBuffer_plural";
            } else {
                l = "file.label.binaryBuffer";
            }
            return this._(l);
        },
        icon: "file-in.svg",
        label: function() {
            var fn = this.filename;
            if(this.filenameType != "str" && this.filenameType != "env" ) { fn = ""; }
            if(this.filenameType === "env") { fn = "env."+fn; }
            return this.name||fn||this._("file.label.read");
        },
        paletteLabel: RED._("node-red:file.label.read"),
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            var node = this;
            var encSel = $("#node-input-encoding");
            var label = node._("file.encoding.none");
            $("<option/>", {
                value: "none",
                label: label
            }).text(label).appendTo(encSel);
            $("#node-input-filename").typedInput({
                default: "str",
                types: [{label:RED._("node-red:file.label.path"), value:"str", icon:""}, "msg", "jsonata", "env"],
                typeField: $("#node-input-filenameType")
            });
            if(typeof node.filenameType == 'undefined') {
                //existing node AND filenameType is not set - inplace (compatible) upgrade to new typedInput
                if(node.filename == "") { //was using empty value to denote msg.filename - set typedInput to match
                    node.filename = "filename";
                    node.filenameType = "msg";
                    $("#node-input-filename").typedInput("type", node.filenameType);
                    $("#node-input-filename").typedInput("value", node.filename);
                } else if(/^\${[^}]+}$/.test(node.filename)) { //was using an ${ENV_VAR}
                    node.filenameType = "env";
                    node.filename = node.filename.replace(/\${([^}]+)}/g, function(match, name) {
                        return (name === undefined)?"":name;
                    });
                    $("#node-input-filename").typedInput("type", node.filenameType);
                    $("#node-input-filename").typedInput("value", node.filename);
                } else { //was using a static filename - set typedInput type to str
                    node.filenameType = "str";
                    $("#node-input-filename").typedInput("type", node.filenameType);
                    $("#node-input-filename").typedInput("value", node.filename);
                }
            }
            encodings.forEach(function(item) {
                if(Array.isArray(item)) {
                    var group = $("<optgroup/>", {
                        label: node._(item[0])
                    }).appendTo(encSel);
                    for (var i = 1; i < item.length; i++) {
                        var enc = item[i];
                        $("<option/>", {
                            value: enc,
                            label: enc
                        }).text(enc).appendTo(group);
                    }
                }
                else {
                    $("<option/>", {
                        value: item,
                        label: item
                    }).text(item).appendTo(encSel);
                }
            });
            encSel.val(node.encoding);
            $("#node-input-format").on("change",function() {
                var format = $("#node-input-format").val();
                if ((format === "utf8") || (format === "lines")) {
                    $("#encoding-spec").show();
                }
                else {
                    $("#encoding-spec").hide();
                }
                if ((format === "lines") || (format === "stream")) {
                    $("#file-allprops").show();
                }
                else {
                    $("#file-allprops").hide();
                }
            });
        }
    });
})();
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="file">
    <p>Writes <code>msg.payload</code> to a file, either adding to the end or replacing the existing content.
       Alternatively, it can delete the file.</p>
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt class="optional">filename <span class="property-type">string</span></dt>
        <dd>The name of the file to be updated can be provided in the node configuration, or as a message property. 
            By default it will use <code>msg.filename</code> but this can be customised in the node.
        </dd>
        <dt class="optional">encoding <span class="property-type">string</span></dt>
        <dd>If encoding is configured to be set by msg, then this optional property can set the encoding.</dt>
    </dl>
    <h3>Output</h3>
    <p>On completion of write, input message is sent to output port.</p>
    <h3>Details</h3>
    <p>Each message payload will be added to the end of the file, optionally appending
    a newline (\n) character between each one.</p>
    <p>If <code>msg.filename</code> is used the file will be closed after every write.
    For best performance use a fixed filename.</p>
    <p>It can be configured to overwrite the entire file rather than append. For example,
    when writing binary data to a file, such as an image, this option should be used
    and the option to append a newline should be disabled.</p>
    <p>Encoding of data written to a file can be specified from list of encodings.</p>
    <p>Alternatively, this node can be configured to delete the file.</p>
</script>

<script type="text/html" data-help-name="file in">
    <p>Reads the contents of a file as either a string or binary buffer.</p>
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt class="optional">filename <span class="property-type">string</span></dt>
        <dd>The name of the file to be read can be provided in the node configuration, or as a message property. 
            By default it will use <code>msg.filename</code> but this can be customised in the node.
        </dd>
    </dl>
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">string | buffer</span></dt>
        <dd>The contents of the file as either a string or binary buffer.</dd>
        <dt class="optional">filename <span class="property-type">string</span></dt>
        <dd>If not configured in the node, this optional property sets the name of the file to be read.</dd>
    </dl>
    <h3>Details</h3>
    <p>The filename should be an absolute path, otherwise it will be relative to
    the working directory of the Node-RED process.</p>
    <p>On Windows, path separators may need to be escaped, for example: <code>\\Users\\myUser</code>.</p>
    <p>Optionally, a text file can be split into lines, outputting one message per line, or a binary file
    split into smaller buffer chunks - the chunk size being operating system dependant, but typically 64k (Linux/Mac) or 41k (Windows).</p>
    <p>When split into multiple messages, each message will have a <code>parts</code>
    property set, forming a complete message sequence.</p>
    <p>Encoding of input data can be specified from list of encodings if output format is string.</p>
    <p>Errors should be caught and handled using a Catch node.</p>
</script>

<!-- --- [red-module:node-red/watch] --- -->
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-template-name="watch">
    <div class="form-row node-input-filename">
         <label for="node-input-files"><i class="fa fa-file"></i> <span data-i18n="watch.label.files"></span></label>
         <input id="node-input-files" type="text" tabindex="1" data-i18n="[placeholder]watch.placeholder.files">
    </div>
    <div class="form-row">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-recursive" style="display:inline-block; width:auto; vertical-align:top;">
        <label for="node-input-recursive" style="width:70%;"> <span data-i18n="watch.label.recursive"></span></label>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
     <div id="node-input-tip" class="form-tips"><span data-i18n="watch.tip"></span></div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('watch',{
        category: 'storage',
        defaults: {
            name: {value:""},
            files: {value:"",required:true,
                    label:RED._("node-red:watch.label.files")},
            recursive: {value:""}
        },
        color:"BurlyWood",
        inputs:0,
        outputs:1,
        icon: "watch.svg",
        label: function() {
            return this.name||this.files||this._("watch.watch");
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        }
    });
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="watch">
    <p>Watches a directory or file for changes.</p>
    <p>You can enter a list of comma separated directories and/or files. You will
    need to put quotes "..." around any that have spaces in.</p>
    <p>On Windows you must use double back-slashes \\ in any directory names.</p>
    <p>The full filename of the file that actually changed is put into <code>msg.payload</code> and <code>msg.filename</code>,
    while a stringified version of the watch list is returned in <code>msg.topic</code>.</p>
    <p><code>msg.file</code> contains just the short filename of the file that changed.
    <code>msg.type</code> has the type of thing changed, usually <i>file</i> or <i>directory</i>,
    while <code>msg.size</code> holds the file size in bytes.</p>
    <p>Of course in Linux, <i>everything</i> is a file and thus can be watched...</p>
    <p><b>Note: </b>The directory or file must exist in order to be watched. If the file
    or directory gets deleted it may no longer be monitored even if it gets re-created.</p>
</script>

<!-- --- [red-module:@bartbutenaers/node-red-autolayout-sidebar/auto_layout_config] --- -->
<!--
  Copyright 2023, Bart Butenaers & Gerrit Riessen
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at
  http://www.apache.org/licenses/LICENSE-2.0
  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<script type="text/javascript">
(function ($) {
    RED.nodes.registerType('auto_layout_config', {
        category: 'config',
        hasUsers: false,
        defaults: {
            name: { value: "AutoLayout" },
            algorithm: { value: "dagre_lr" },
            settings: { value: {} }
        },
        paletteLabel: 'AutoLayout',
        label: function () {
            return this.name;
        }
    });
})(jQuery);
</script>

<!-- The html for the config node does NOT include input fields, because the data only arrives from user input in the sidebar screen. -->
<script type="text/x-red" data-template-name="auto_layout_config">
    <div class="form-tips">This config node is read-only, because it stores the information entered in the 'Auto Layout' sidebar.</div>
</script>


<script type="text/x-red" data-help-name="auto_layout_config">
    <p>Configuration for the 'Auto Layout' sidebar.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-contrib-writermap-mindmap/base] --- -->
<script type="text/javascript">
  /*
   * Can use https://colordesigner.io/gradient-generator to generate gradient
   * steps
   */
  window.wmPaletteColours = {
    "50-topic":         '#d0c9f6',
    "30-observation":   '#f4adf3',
    "32-question":      '#e0a4f3',
    "35-thought":       '#cb9cf3',
    "25-idea":          '#88baff',
    "40-analogy":       '#86bfff',
    "45-aphorism":      '#84c3ff',
    "20-poesie":        '#83c7ff',
    "22-humour":        '#81ccff',
    "23-treasure":      '#7fd0ff',
    "37-consequence":   '#f6c1cc',
    "38-advantage":     '#efacbf',
    "39-disadvantage":  '#e796b1',
    "05-text":          '#c8ffb5',
    "10-blog-post":     '#d0fdc2',
    "15-comment":       '#d9fcce',
    "55-code-base":     '#e1fbda',
    "56-sketch":        '#e1fbda',
    "60-inspiration":   '#dfdfb6',
    "65-quote":         '#e5e5c0',
    "70-definition":    '#eaebca',
    "75-book":          '#f0f0d4',
    "80-author":        '#f5f6de',
  };

/*
  window.wmPaletteColours = {
    "50-topic":         '#fdfdfa',
    "30-observation":   '#fdfdfa',
    "32-question":      '#fdfdfa',
    "35-thought":       '#fdfdfa',
    "25-idea":          '#fdfdfa',
    "40-analogy":       '#fdfdfa',
    "45-aphorism":      '#fdfdfa',
    "20-poesie":        '#fdfdfa',
    "22-humour":        '#fdfdfa',
    "23-treasure":      '#fdfdfa',
    "37-consequence":   '#fdfdfa',
    "38-advantage":     '#fdfdfa',
    "39-disadvantage":  '#fdfdfa',
    "05-text":          '#fdfdfa',
    "10-blog-post":     '#fdfdfa',
    "15-comment":       '#fdfdfa',
    "55-code-base":     '#fdfdfa',
    "56-sketch":        '#fdfdfa',
    "60-inspiration":   '#fdfdfa',
    "65-quote":         '#fdfdfa',
    "70-definition":    '#fdfdfa',
    "75-book":          '#fdfdfa',
    "80-author":        '#fdfdfa',
  };
*/
  window.mmDefaults = {
    category: 'mindmap',
    _collection: 'writermap',
    defaults: {
      name: {
        value:""
      },
      info: {
        value:""
      },

      sumPass: {
        value: false
      },
      sumPassPrio: {
        value: 0,
      },
      sumPassNodeId: {
        value: ""
      },

      /* createdAt and updatedAt are "internal" attributes that track just
         that: when the node was created and the last time it was updated.
         These aren't shown in the edit window because they are maintained
         internally. These are managed by BlogChanges node (onpaletteadd has
         event listeners for updating these values).
      */
      createdAt: {
        value: "",
      },
      updatedAt: {
        value: "",
      },
    },

    inputs:1,
    outputs:1,

    labelStyle: function() {
      return (this.name || this.info) ? "node_label_italic" : "";
    },

    info: function() {
      return this.name ? "# "+this.name+"\n\n---\n\n" : "";
    },

    label: function() {
      return ( (this.name ||
                this.info.replace(/(.{40,60})([ \n\t])/g,"$1\\n$2")) ||
               this._def.paletteLabel || this.type) +
        (this.sumPassPrio && parseInt(this.sumPassPrio) != 0 ? " (" + this.sumPassPrio + ")" : "") +
        (this.sumPass ? " ⭄" : "");
    },

    oneditprepare: function() {
      var that = this;

      this.editor = RED.editor.createEditor({
        id: 'node-input-info-editor',
        mode: 'ace/mode/markdown',
        value: $("#node-input-info").val()
      });
      this.editor.focus();

      writerMapUtils.fillSumPassPrioSelection(that);

      if ( $('#node-input-sumPass').is(":checked") ) {
        writerMapUtils.fillSumPassNodeSelection(that);
        $('#sumpass-node-selection').show()
        $('#node-input-sumPassNodeId').val(that.sumPassNodeId);
      } else {
        $('#sumpass-node-selection').hide()
      }

      $('#node-input-sumPass').on( 'change', function() {
        if ( $('#node-input-sumPass').is(":checked") ) {
          writerMapUtils.fillSumPassNodeSelection(that);
          $('#sumpass-node-selection').show()
          $('#node-input-sumPassNodeId').val(that.sumPassNodeId);
        } else {
          $('#sumpass-node-selection').hide()
        }
      });

      writerMapUtils.fillTypeDropDown(that);
    },

    oneditsave: function() {
      $("#node-input-info").val(this.editor.getValue());
      this.editor.destroy();
      delete this.editor;

      var newType = $('#node-input-typeDropdown').val();
      if ( newType && newType != this.type ) {
        var nde = RED.nodes.node(this.id);
        nde.type = newType;

        this.changed = true;
        nde.dirty = true;

        RED.nodes.dirty(true)
        RED.view.redraw()
      }
    },

    oneditcancel: function() {
      this.editor.destroy();
      delete this.editor;
    },

    oneditresize: function(size) {
      var rows = $("#dialog-form>div:not(.node-text-editor-row)");
      var height = $("#dialog-form").height();
      for (var i=0; i<rows.length; i++) {
        height -= $(rows[i]).outerHeight(true);
      }
      var editorRow = $("#dialog-form>div.node-text-editor-row");
      height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));
      $(".node-text-editor").css("height",height+"px");
      this.editor.resize();
    }
  };


  const writerMapUtils = {
    one: undefined,

    fillSumPassPrioSelection: (that) => {
      var sltObj = $('#node-input-sumPassPrio');
      sltObj.html("");

      for ( var idx = 20; idx > -21; idx-- ) {
        sltObj.append($('<option></option>').val(idx).html(idx));
      };

      sltObj.val(that.sumPassPrio || 0);
    },

    fillSumPassNodeSelection: (nde) => {
      var sltObj = $('#node-input-sumPassNodeId');
      sltObj.html("");

      sltObj.append(
        $('<option></option>').val("").html(" -- All -- ")
      );

      RED.nodes.eachLink( function(lnk) {
        if ( lnk.source.id == nde.id &&
             lnk.target.d != true ) {
          sltObj.append(
            $('<option></option>').val(lnk.target.id).html(
              ( ( typeof lnk.target._def.label == "function") ?
                lnk.target._def.label.call(lnk.target) :
                "NO LABEL FOR " + lnk.target.id
              )
            )
          );
        }
      });
    },

    addTargetToExternalLinks: function(el) {
      $(el).find("a").each(function(el) {
        var href = $(this).attr('href');
        if (/^https?:/.test(href)) {
          $(this).attr('target','_blank');
        }
      });
      return el;
    },

    setInfoText: function(infoText,target) {
      var info = writerMapUtils.addTargetToExternalLinks($('<div class="red-ui-help"><span class="red-ui-text-bidi-aware" dir=\"'+RED.text.bidi.resolveBaseTextDir(infoText)+'">'+infoText+'</span></div>')).appendTo(target);
      info.find(".red-ui-text-bidi-aware").contents().filter(function() { return this.nodeType === 3 && this.textContent.trim() !== "" }).wrap( "<span></span>" );
      var foldingHeader = "H3";
      info.find(foldingHeader).wrapInner('<a class="red-ui-help-info-header expanded" href="#"></a>')
        .find("a").prepend('<i class="fa fa-angle-right">').on("click", function(e) {
          e.preventDefault();
          var isExpanded = $(this).hasClass('expanded');
          var el = $(this).parent().next();
          while(el.length === 1 && el[0].nodeName !== foldingHeader) {
            el.toggle(!isExpanded);
            el = el.next();
          }
          $(this).toggleClass('expanded',!isExpanded);
        })
    },

    allWriterMapTypes: function () {
      var tes = []

      RED.nodes.registry.getNodeList().forEach( nd => {
        nd.types.forEach( typ => {
          let typDef = RED.nodes.registry.getNodeType(typ) || {};
          if ( typDef._collection == "writermap" ) {
            tes.push( typ )
          }
        })
      })

      return tes;
    },

    fillTypeDropDown: function (nde) {
      var sltObj = $('#node-input-typeDropdown');
      sltObj.html("");

      writerMapUtils.allWriterMapTypes().forEach( (typ) => {
        sltObj.append(
          $('<option></option>').val(typ).html(typ)
        )
      });

      sltObj.val(nde.type);
    }
  };

  // Hide the tip box underneath the info box - no one needs it!
  setTimeout(function () {
    if ( $(".red-ui-sidebar-info").hasClass('show-tips') ) {
      RED.actions.invoke("core:toggle-show-tips")
    }
  }, 1250);

  // This event is triggered once a node is highlighted or unhighlighted. Use
  // it to show a popup (only on mobile) containing the info of the writermap
  // node. On a desktop it shows the info box and makes it larger so that
  // so the info is highlighted.
  // To ensure that the "popup" with info is readable, the node is pushed to
  // the front, causing the deploy button to become active. This is a hack
  // to ensure that the popup is above other nodes. The popup is attached to the
  // node in SVG so that the popup comes along when moving a node.
  RED.events.on("view:selection-changed", function(selection) {
    if ( writerMapUtils['one'] ) {
      document.getElementById(writerMapUtils['one']).remove()
			delete writerMapUtils['one'];
    }

    if ( selection.nodes && selection.nodes.length == 1 &&
      selection.nodes[0]._def &&
      selection.nodes[0]._def._collection == 'writermap' ) {

      if ( !(RED.utils.getBrowserInfo().mobile > 0) && !window.matchMedia('only screen and (max-width: 890px)').matches ) {
        // open the info box on desktop, only mobile shows the info box under
        // the node.
        // RED.sidebar.info.show()
        $($('.red-ui-sidebar-info-stack > .red-ui-panel')[0]).css(
          'height', '150px'
        )
        return;
      }

      var nde = selection.nodes[0];

      var container = document.getElementById(nde.id);
      if ( !container ) {
        return
      }

      var bbbox = container.getBoundingClientRect();
			var newDiv = document.createElement("div")

      writerMapUtils['one'] = 'writermap-info-box-' + nde.id;

			newDiv.setAttribute('class', 'red-ui-editor red-ui-panel')
      newDiv.setAttribute('style', "flex: 1 1 auto; overflow-y: scroll;");
      newDiv.setAttribute('xmlns', "http://www.w3.org/1999/xhtml" );
      newDiv.setAttribute('pointer-events',"all");

			$(newDiv).css('display', 'flex')

			$(newDiv).css('height', '290')
			$(newDiv).css('color',  'rgb(85,85,85)')
			$(newDiv).css('border', '1px solid rgb(85,85,85)')
			$(newDiv).css('background-color', 'white')

      $(newDiv).css('border-radius',  '6px');
      $(newDiv).css('padding-bottom', '3px');
      $(newDiv).css('padding-left',   '6px');
      $(newDiv).css('padding-right',  '3px');
      $(newDiv).css('padding-top',    '3px');

			var forObj = document.createElementNS("http://www.w3.org/2000/svg",
                                            'foreignObject')
			forObj.setAttribute('id',     writerMapUtils['one'])
			forObj.setAttribute('x',      '0')
			forObj.setAttribute('y',      bbbox.height + 2)
      forObj.setAttribute('width',  bbbox.width );
      forObj.setAttribute('height', "300" );
      forObj.setAttribute('pointer-events',"all");

      var infoText = "";

      if (nde._def && nde._def.info) {
        var info = nde._def.info;
        var textInfo = (typeof info === "function" ? info.call(nde) : info);
        infoText = infoText + RED.utils.renderMarkdown(textInfo);
      }
      if (nde.info) {
        infoText = infoText + RED.utils.renderMarkdown(nde.info || "")
      }

      writerMapUtils.setInfoText(infoText, newDiv);

      forObj.appendChild( newDiv );

      // we add the foreignObject to the node container so that if the node
      // is moved, the foreignObject is moved along with it. Alternative
      // would be that if the node is moved while the popup div is being
      // shown, the node would move and the popup would stay - not a good look.
			container.insertBefore(forObj, container.lastChild.nextSibling)

      // ensure that the popup is not obscured by other nodes, push the parent
      // node to the front, making it be above all other nodes.
      RED.actions.invoke("core:move-selection-to-front")
    }
  })
</script>

<!-- --- [red-module:@gorenje/node-red-contrib-writermap-mindmap/topic] --- -->
<script type="text/javascript">
  RED.nodes.registerType('Topic',{ ...window.mmDefaults, ...{
    color: window.wmPaletteColours["50-topic"],
    icon: "font-awesome/fa-text-width",
  }});
</script>

<script type="text/html" data-template-name="Topic">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>

  <div class="form-row">
    <label style="display: inline-block; width: 40%;"
           for="node-input-sumPass">
      <i class="fa fa-filter"></i>
      <span>Summaries subnodes?</span>
    </label>
    <input type="checkbox" id="node-input-sumPass"
           style="display:inline-block; width:35px; vertical-align:baseline;">

    <label style="display: inline-block; width: 10%; padding-left: 100px;"
           for="node-input-sumPassPrio">
      <span>Priority: </span>
    </label>
    <select id="node-input-sumPassPrio" style="width: 50px;"></select>
  </div>

  <div id="sumpass-node-selection" class="hide">
    <div class="form-row">
      <select id="node-input-sumPassNodeId" style="width: 100%">
      </select>
    </div>
  </div>

  <div class="form-row node-text-editor-row">
    <input type="hidden" id="node-input-info" autofocus="autofocus">
    <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-info-editor"></div>
  </div>
  <div class="form-row">
    <label for="node-input-typeDropdown">Change Type</label>
    <select id="node-input-typeDropdown">
    </select>
  </div>
</script>


<script type="text/html" data-help-name="Topic">
  <p>A writermap node.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-contrib-writermap-mindmap/observation] --- -->
<script type="text/javascript">
  RED.nodes.registerType('Observation',{ ...window.mmDefaults, ...{
    color: window.wmPaletteColours["30-observation"],
    icon: "font-awesome/fa-binoculars",
  }});
</script>

<script type="text/html" data-template-name="Observation">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>

  <div class="form-row">
    <label style="display: inline-block; width: 40%;"
           for="node-input-sumPass">
      <i class="fa fa-filter"></i>
      <span>Summaries subnodes?</span>
    </label>
    <input type="checkbox" id="node-input-sumPass"
           style="display:inline-block; width:35px; vertical-align:baseline;">

    <label style="display: inline-block; width: 10%; padding-left: 100px;"
           for="node-input-sumPassPrio">
      <span>Priority: </span>
    </label>
    <select id="node-input-sumPassPrio" style="width: 50px;"></select>
  </div>

  <div id="sumpass-node-selection" class="hide">
    <div class="form-row">
      <select id="node-input-sumPassNodeId" style="width: 100%">
      </select>
    </div>
  </div>

  <div class="form-row node-text-editor-row">
    <input type="hidden" id="node-input-info" autofocus="autofocus">
    <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-info-editor"></div>
  </div>

  <div class="form-row">
    <label for="node-input-typeDropdown">Change Type</label>
    <select id="node-input-typeDropdown">
    </select>
  </div>
</script>


<script type="text/html" data-help-name="Observation">
  <p>A writermap node.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-contrib-writermap-mindmap/question] --- -->
<script type="text/javascript">
  RED.nodes.registerType('Question',{ ...window.mmDefaults, ...{
    color: window.wmPaletteColours["32-question"],
    icon: "font-awesome/fa-question",
  }});
</script>

<script type="text/html" data-template-name="Question">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>

  <div class="form-row">
    <label style="display: inline-block; width: 40%;"
           for="node-input-sumPass">
      <i class="fa fa-filter"></i>
      <span>Summaries subnodes?</span>
    </label>
    <input type="checkbox" id="node-input-sumPass"
           style="display:inline-block; width:35px; vertical-align:baseline;">

    <label style="display: inline-block; width: 10%; padding-left: 100px;"
           for="node-input-sumPassPrio">
      <span>Priority: </span>
    </label>
    <select id="node-input-sumPassPrio" style="width: 50px;"></select>
  </div>

  <div id="sumpass-node-selection" class="hide">
    <div class="form-row">
      <select id="node-input-sumPassNodeId" style="width: 100%">
      </select>
    </div>
  </div>

  <div class="form-row node-text-editor-row">
    <input type="hidden" id="node-input-info" autofocus="autofocus">
    <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-info-editor"></div>
  </div>
  <div class="form-row">
    <label for="node-input-typeDropdown">Change Type</label>
    <select id="node-input-typeDropdown">
    </select>
  </div>
</script>


<script type="text/html" data-help-name="Question">
  <p>A writermap node.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-contrib-writermap-mindmap/thought] --- -->
<script type="text/javascript">
  RED.nodes.registerType('Thought',{ ...window.mmDefaults, ...{
    color: window.wmPaletteColours["35-thought"],
    icon: "node-red/alert.svg",
  }});
</script>

<script type="text/html" data-template-name="Thought">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>

  <div class="form-row">
    <label style="display: inline-block; width: 40%;"
           for="node-input-sumPass">
      <i class="fa fa-filter"></i>
      <span>Summaries subnodes?</span>
    </label>
    <input type="checkbox" id="node-input-sumPass"
           style="display:inline-block; width:35px; vertical-align:baseline;">

    <label style="display: inline-block; width: 10%; padding-left: 100px;"
           for="node-input-sumPassPrio">
      <span>Priority: </span>
    </label>
    <select id="node-input-sumPassPrio" style="width: 50px;"></select>
  </div>

  <div id="sumpass-node-selection" class="hide">
    <div class="form-row">
      <select id="node-input-sumPassNodeId" style="width: 100%">
      </select>
    </div>
  </div>

  <div class="form-row node-text-editor-row">
    <input type="hidden" id="node-input-info" autofocus="autofocus">
    <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-info-editor"></div>
  </div>
  <div class="form-row">
    <label for="node-input-typeDropdown">Change Type</label>
    <select id="node-input-typeDropdown">
    </select>
  </div>
</script>


<script type="text/html" data-help-name="Thought">
  <p>A writermap node.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-contrib-writermap-mindmap/idea] --- -->
<script type="text/javascript">
  RED.nodes.registerType('Idea',{ ...window.mmDefaults, ...{
    color: window.wmPaletteColours["25-idea"],
    icon: "node-red/light.svg",
  }});
</script>

<script type="text/html" data-template-name="Idea">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>

  <div class="form-row">
    <label style="display: inline-block; width: 40%;"
           for="node-input-sumPass">
      <i class="fa fa-filter"></i>
      <span>Summaries subnodes?</span>
    </label>
    <input type="checkbox" id="node-input-sumPass"
           style="display:inline-block; width:35px; vertical-align:baseline;">

    <label style="display: inline-block; width: 10%; padding-left: 100px;"
           for="node-input-sumPassPrio">
      <span>Priority: </span>
    </label>
    <select id="node-input-sumPassPrio" style="width: 50px;"></select>
  </div>

  <div id="sumpass-node-selection" class="hide">
    <div class="form-row">
      <select id="node-input-sumPassNodeId" style="width: 100%">
      </select>
    </div>
  </div>

  <div class="form-row node-text-editor-row">
    <input type="hidden" id="node-input-info" autofocus="autofocus">
    <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-info-editor"></div>
  </div>

  <div class="form-row">
    <label for="node-input-typeDropdown">Change Type</label>
    <select id="node-input-typeDropdown">
    </select>
  </div>
</script>


<script type="text/html" data-help-name="Idea">
  <p>A mindmap Idea node.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-contrib-writermap-mindmap/analogy] --- -->
<script type="text/javascript">
  RED.nodes.registerType('Analogy',{ ...window.mmDefaults, ...{
    color: window.wmPaletteColours["40-analogy"],
    icon: "font-awesome/fa-balance-scale",
  }});
</script>

<script type="text/html" data-template-name="Analogy">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>

  <div class="form-row">
    <label style="display: inline-block; width: 40%;"
           for="node-input-sumPass">
      <i class="fa fa-filter"></i>
      <span>Summaries subnodes?</span>
    </label>
    <input type="checkbox" id="node-input-sumPass"
           style="display:inline-block; width:35px; vertical-align:baseline;">

    <label style="display: inline-block; width: 10%; padding-left: 100px;"
           for="node-input-sumPassPrio">
      <span>Priority: </span>
    </label>
    <select id="node-input-sumPassPrio" style="width: 50px;"></select>
  </div>

  <div id="sumpass-node-selection" class="hide">
    <div class="form-row">
      <select id="node-input-sumPassNodeId" style="width: 100%">
      </select>
    </div>
  </div>

  <div class="form-row node-text-editor-row">
    <input type="hidden" id="node-input-info" autofocus="autofocus">
    <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-info-editor"></div>
  </div>
  <div class="form-row">
    <label for="node-input-typeDropdown">Change Type</label>
    <select id="node-input-typeDropdown">
    </select>
  </div>
</script>


<script type="text/html" data-help-name="Analogy">
  <p>A writermap node.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-contrib-writermap-mindmap/aphorism] --- -->
<script type="text/javascript">
  RED.nodes.registerType('Aphorism',{ ...window.mmDefaults, ...{
    color: window.wmPaletteColours["45-aphorism"],
    icon: "font-awesome/fa-window-minimize",
  }});
</script>

<script type="text/html" data-template-name="Aphorism">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>

  <div class="form-row">
    <label style="display: inline-block; width: 40%;"
           for="node-input-sumPass">
      <i class="fa fa-filter"></i>
      <span>Summaries subnodes?</span>
    </label>
    <input type="checkbox" id="node-input-sumPass"
           style="display:inline-block; width:35px; vertical-align:baseline;">

    <label style="display: inline-block; width: 10%; padding-left: 100px;"
           for="node-input-sumPassPrio">
      <span>Priority: </span>
    </label>
    <select id="node-input-sumPassPrio" style="width: 50px;"></select>
  </div>

  <div id="sumpass-node-selection" class="hide">
    <div class="form-row">
      <select id="node-input-sumPassNodeId" style="width: 100%">
      </select>
    </div>
  </div>

  <div class="form-row node-text-editor-row">
    <input type="hidden" id="node-input-info" autofocus="autofocus">
    <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-info-editor"></div>
  </div>
  <div class="form-row">
    <label for="node-input-typeDropdown">Change Type</label>
    <select id="node-input-typeDropdown">
    </select>
  </div>
</script>


<script type="text/html" data-help-name="Aphorism">
  <p>A writermap node.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-contrib-writermap-mindmap/poesie] --- -->
<script type="text/javascript">
  RED.nodes.registerType('Poesie',{ ...window.mmDefaults, ...{
    color: window.wmPaletteColours["20-poesie"],
    icon: "font-awesome/fa-file-powerpoint-o",
  }});
</script>

<script type="text/html" data-template-name="Poesie">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>

  <div class="form-row">
    <label style="display: inline-block; width: 40%;"
           for="node-input-sumPass">
      <i class="fa fa-filter"></i>
      <span>Summaries subnodes?</span>
    </label>
    <input type="checkbox" id="node-input-sumPass"
           style="display:inline-block; width:35px; vertical-align:baseline;">

    <label style="display: inline-block; width: 10%; padding-left: 100px;"
           for="node-input-sumPassPrio">
      <span>Priority: </span>
    </label>
    <select id="node-input-sumPassPrio" style="width: 50px;"></select>
  </div>

  <div id="sumpass-node-selection" class="hide">
    <div class="form-row">
      <select id="node-input-sumPassNodeId" style="width: 100%">
      </select>
    </div>
  </div>

  <div class="form-row node-text-editor-row">
    <input type="hidden" id="node-input-info" autofocus="autofocus">
    <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-info-editor"></div>
  </div>

  <div class="form-row">
    <label for="node-input-typeDropdown">Change Type</label>
    <select id="node-input-typeDropdown">
    </select>
  </div>
</script>


<script type="text/html" data-help-name="Poesie">
  <p>A writermap node.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-contrib-writermap-mindmap/humour] --- -->
<script type="text/javascript">
  RED.nodes.registerType('Humour',{ ...window.mmDefaults, ...{
    color: window.wmPaletteColours["22-humour"],
    icon: "font-awesome/fa-smile-o",
  }});
</script>

<script type="text/html" data-template-name="Humour">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>

  <div class="form-row">
    <label style="display: inline-block; width: 40%;"
           for="node-input-sumPass">
      <i class="fa fa-filter"></i>
      <span>Summaries subnodes?</span>
    </label>
    <input type="checkbox" id="node-input-sumPass"
           style="display:inline-block; width:35px; vertical-align:baseline;">

    <label style="display: inline-block; width: 10%; padding-left: 100px;"
           for="node-input-sumPassPrio">
      <span>Priority: </span>
    </label>
    <select id="node-input-sumPassPrio" style="width: 50px;"></select>
  </div>

  <div id="sumpass-node-selection" class="hide">
    <div class="form-row">
      <select id="node-input-sumPassNodeId" style="width: 100%">
      </select>
    </div>
  </div>

  <div class="form-row node-text-editor-row">
    <input type="hidden" id="node-input-info" autofocus="autofocus">
    <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-info-editor"></div>
  </div>

  <div class="form-row">
    <label for="node-input-typeDropdown">Change Type</label>
    <select id="node-input-typeDropdown">
    </select>
  </div>
</script>


<script type="text/html" data-help-name="Humour">
  <p>A writermap node.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-contrib-writermap-mindmap/treasure] --- -->
<script type="text/javascript">
  RED.nodes.registerType('Treasure',{ ...window.mmDefaults, ...{
    color: window.wmPaletteColours["23-treasure"],
    icon: "font-awesome/fa-heart-o",
  }});
</script>

<script type="text/html" data-template-name="Treasure">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>

  <div class="form-row">
    <label style="display: inline-block; width: 40%;"
           for="node-input-sumPass">
      <i class="fa fa-filter"></i>
      <span>Summaries subnodes?</span>
    </label>
    <input type="checkbox" id="node-input-sumPass"
           style="display:inline-block; width:35px; vertical-align:baseline;">

    <label style="display: inline-block; width: 10%; padding-left: 100px;"
           for="node-input-sumPassPrio">
      <span>Priority: </span>
    </label>
    <select id="node-input-sumPassPrio" style="width: 50px;"></select>
  </div>

  <div id="sumpass-node-selection" class="hide">
    <div class="form-row">
      <select id="node-input-sumPassNodeId" style="width: 100%">
      </select>
    </div>
  </div>

  <div class="form-row node-text-editor-row">
    <input type="hidden" id="node-input-info" autofocus="autofocus">
    <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-info-editor"></div>
  </div>

  <div class="form-row">
    <label for="node-input-typeDropdown">Change Type</label>
    <select id="node-input-typeDropdown">
    </select>
  </div>
</script>


<script type="text/html" data-help-name="Treasure">
  <p>A writermap node.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-contrib-writermap-mindmap/consequence] --- -->
<script type="text/javascript">
  RED.nodes.registerType('Consequence',{ ...window.mmDefaults, ...{
    color: window.wmPaletteColours["37-consequence"],
    icon: "font-awesome/fa-gavel",
  }});
</script>

<script type="text/html" data-template-name="Consequence">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>

  <div class="form-row">
    <label style="display: inline-block; width: 40%;"
           for="node-input-sumPass">
      <i class="fa fa-filter"></i>
      <span>Summaries subnodes?</span>
    </label>
    <input type="checkbox" id="node-input-sumPass"
           style="display:inline-block; width:35px; vertical-align:baseline;">

    <label style="display: inline-block; width: 10%; padding-left: 100px;"
           for="node-input-sumPassPrio">
      <span>Priority: </span>
    </label>
    <select id="node-input-sumPassPrio" style="width: 50px;"></select>
  </div>

  <div id="sumpass-node-selection" class="hide">
    <div class="form-row">
      <select id="node-input-sumPassNodeId" style="width: 100%">
      </select>
    </div>
  </div>

  <div class="form-row node-text-editor-row">
    <input type="hidden" id="node-input-info" autofocus="autofocus">
    <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-info-editor"></div>
  </div>
  <div class="form-row">
    <label for="node-input-typeDropdown">Change Type</label>
    <select id="node-input-typeDropdown">
    </select>
  </div>
</script>


<script type="text/html" data-help-name="Consequence">
  <p>A writermap node.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-contrib-writermap-mindmap/advantage] --- -->
<script type="text/javascript">
  RED.nodes.registerType('Advantage',{ ...window.mmDefaults, ...{
    color: window.wmPaletteColours["38-advantage"],
    icon: "font-awesome/fa-thumbs-o-up",
  }});
</script>

<script type="text/html" data-template-name="Advantage">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>

  <div class="form-row">
    <label style="display: inline-block; width: 40%;"
           for="node-input-sumPass">
      <i class="fa fa-filter"></i>
      <span>Summaries subnodes?</span>
    </label>
    <input type="checkbox" id="node-input-sumPass"
           style="display:inline-block; width:35px; vertical-align:baseline;">

    <label style="display: inline-block; width: 10%; padding-left: 100px;"
           for="node-input-sumPassPrio">
      <span>Priority: </span>
    </label>
    <select id="node-input-sumPassPrio" style="width: 50px;"></select>
  </div>

  <div id="sumpass-node-selection" class="hide">
    <div class="form-row">
      <select id="node-input-sumPassNodeId" style="width: 100%">
      </select>
    </div>
  </div>

  <div class="form-row node-text-editor-row">
    <input type="hidden" id="node-input-info" autofocus="autofocus">
    <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-info-editor"></div>
  </div>
  <div class="form-row">
    <label for="node-input-typeDropdown">Change Type</label>
    <select id="node-input-typeDropdown">
    </select>
  </div>
</script>


<script type="text/html" data-help-name="Advantage">
  <p>A writermap node.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-contrib-writermap-mindmap/disadvantage] --- -->
<script type="text/javascript">
  RED.nodes.registerType('Disadvantage',{ ...window.mmDefaults, ...{
    color: window.wmPaletteColours["39-disadvantage"],
    icon: "font-awesome/fa-thumbs-o-down",
  }});
</script>

<script type="text/html" data-template-name="Disadvantage">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>

  <div class="form-row">
    <label style="display: inline-block; width: 40%;"
           for="node-input-sumPass">
      <i class="fa fa-filter"></i>
      <span>Summaries subnodes?</span>
    </label>
    <input type="checkbox" id="node-input-sumPass"
           style="display:inline-block; width:35px; vertical-align:baseline;">

    <label style="display: inline-block; width: 10%; padding-left: 100px;"
           for="node-input-sumPassPrio">
      <span>Priority: </span>
    </label>
    <select id="node-input-sumPassPrio" style="width: 50px;"></select>
  </div>

  <div id="sumpass-node-selection" class="hide">
    <div class="form-row">
      <select id="node-input-sumPassNodeId" style="width: 100%">
      </select>
    </div>
  </div>

  <div class="form-row node-text-editor-row">
    <input type="hidden" id="node-input-info" autofocus="autofocus">
    <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-info-editor"></div>
  </div>
  <div class="form-row">
    <label for="node-input-typeDropdown">Change Type</label>
    <select id="node-input-typeDropdown">
    </select>
  </div>
</script>


<script type="text/html" data-help-name="Disadvantage">
  <p>A writermap node.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-contrib-writermap-mindmap/text] --- -->
<script type="text/javascript">
  RED.nodes.registerType('Text',{ ...window.mmDefaults, ...{
    color: window.wmPaletteColours["05-text"],
    icon: "font-awesome/fa-file-text-o"
  }});
</script>

<script type="text/html" data-template-name="Text">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>


  <div class="form-row">
    <label style="display: inline-block; width: 40%;"
           for="node-input-sumPass">
      <i class="fa fa-filter"></i>
      <span>Summaries subnodes?</span>
    </label>

    <input type="checkbox" id="node-input-sumPass"
           style="display:inline-block; width:35px; vertical-align:baseline;">

    <label style="display: inline-block; width: 10%; padding-left: 100px;"
           for="node-input-sumPassPrio">
      <span>Priority: </span>
    </label>
    <select id="node-input-sumPassPrio" style="width: 50px;"></select>
  </div>

  <div id="sumpass-node-selection" class="hide">
    <div class="form-row">
      <select id="node-input-sumPassNodeId" style="width: 100%">
      </select>
    </div>
  </div>

  <div class="form-row node-text-editor-row">
    <input type="hidden" id="node-input-info" autofocus="autofocus">
    <div style="height: 250px; min-height:150px;"
         class="node-text-editor" id="node-input-info-editor">
    </div>
  </div>

  <div class="form-row">
    <label for="node-input-typeDropdown">Change Type</label>
    <select id="node-input-typeDropdown">
    </select>
  </div>

</script>


<script type="text/html" data-help-name="Text">
    <p>A writermap node.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-contrib-writermap-mindmap/blog-post] --- -->
<script type="text/javascript">
  RED.nodes.registerType('Blog-Post',{ ...window.mmDefaults, ...{
    color: window.wmPaletteColours["10-blog-post"],
    icon: "font-awesome/fa-external-link",
    paletteLabel: "Post"
  }});
</script>

<script type="text/html" data-template-name="Blog-Post">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>

  <div class="form-row">
    <label style="display: inline-block; width: 40%;"
           for="node-input-sumPass">
      <i class="fa fa-filter"></i>
      <span>Summaries subnodes?</span>
    </label>

    <input type="checkbox" id="node-input-sumPass"
           style="display:inline-block; width:35px; vertical-align:baseline;">

    <label style="display: inline-block; width: 10%; padding-left: 100px;"
           for="node-input-sumPassPrio">
      <span>Priority: </span>
    </label>
    <select id="node-input-sumPassPrio" style="width: 50px;"></select>
  </div>

  <div id="sumpass-node-selection" class="hide">
    <div class="form-row">
      <select id="node-input-sumPassNodeId" style="width: 100%">
      </select>
    </div>
  </div>

  <div class="form-row node-text-editor-row">
    <input type="hidden" id="node-input-info" autofocus="autofocus">
    <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-info-editor"></div>
  </div>

  <div class="form-row">
    <label for="node-input-typeDropdown">Change Type</label>
    <select id="node-input-typeDropdown">
    </select>
  </div>

</script>


<script type="text/html" data-help-name="Blog-Post">
  <p>A writermap node.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-contrib-writermap-mindmap/comment] --- -->
<script type="text/javascript">
  RED.nodes.registerType('Comment',{ ...window.mmDefaults, ...{
    color: window.wmPaletteColours["15-comment"],
    icon: "font-awesome/fa-commenting-o",
  }});
</script>

<script type="text/html" data-template-name="Comment">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>

  <div class="form-row">
    <label style="display: inline-block; width: 40%;"
           for="node-input-sumPass">
      <i class="fa fa-filter"></i>
      <span>Summaries subnodes?</span>
    </label>
    <input type="checkbox" id="node-input-sumPass"
           style="display:inline-block; width:35px; vertical-align:baseline;">

    <label style="display: inline-block; width: 10%; padding-left: 100px;"
           for="node-input-sumPassPrio">
      <span>Priority: </span>
    </label>
    <select id="node-input-sumPassPrio" style="width: 50px;"></select>
  </div>

  <div id="sumpass-node-selection" class="hide">
    <div class="form-row">
      <select id="node-input-sumPassNodeId" style="width: 100%">
      </select>
    </div>
  </div>

  <div class="form-row node-text-editor-row">
    <input type="hidden" id="node-input-info" autofocus="autofocus">
    <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-info-editor"></div>
  </div>

  <div class="form-row">
    <label for="node-input-typeDropdown">Change Type</label>
    <select id="node-input-typeDropdown">
    </select>
  </div>
</script>


<script type="text/html" data-help-name="Comment">
  <p>A writermap node.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-contrib-writermap-mindmap/codebase] --- -->
<script type="text/javascript">
  RED.nodes.registerType('Code-Base',{ ...window.mmDefaults, ...{
    color: window.wmPaletteColours["55-code-base"],
    icon: "font-awesome/fa-code",
    paletteLabel: 'Code'
  }});
</script>

<script type="text/html" data-template-name="Code-Base">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>

  <div class="form-row">
    <label style="display: inline-block; width: 40%;"
           for="node-input-sumPass">
      <i class="fa fa-filter"></i>
      <span>Summaries subnodes?</span>
    </label>
    <input type="checkbox" id="node-input-sumPass"
           style="display:inline-block; width:35px; vertical-align:baseline;">

    <label style="display: inline-block; width: 10%; padding-left: 100px;"
           for="node-input-sumPassPrio">
      <span>Priority: </span>
    </label>
    <select id="node-input-sumPassPrio" style="width: 50px;"></select>
  </div>

  <div id="sumpass-node-selection" class="hide">
    <div class="form-row">
      <select id="node-input-sumPassNodeId" style="width: 100%">
      </select>
    </div>
  </div>

  <div class="form-row node-text-editor-row">
    <input type="hidden" id="node-input-info" autofocus="autofocus">
    <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-info-editor"></div>
  </div>
  <div class="form-row">
    <label for="node-input-typeDropdown">Change Type</label>
    <select id="node-input-typeDropdown">
    </select>
  </div>
</script>


<script type="text/html" data-help-name="Code-Base">
  <p>A writermap node.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-contrib-writermap-mindmap/sketch] --- -->
<script type="text/javascript">
  RED.nodes.registerType('Sketch',{ ...window.mmDefaults, ...{
    color: window.wmPaletteColours["56-sketch"],
    icon: "font-awesome/fa-image",
  }});
</script>

<script type="text/html" data-template-name="Sketch">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>

  <div class="form-row">
    <label style="display: inline-block; width: 40%;"
           for="node-input-sumPass">
      <i class="fa fa-filter"></i>
      <span>Summaries subnodes?</span>
    </label>
    <input type="checkbox" id="node-input-sumPass"
           style="display:inline-block; width:35px; vertical-align:baseline;">

    <label style="display: inline-block; width: 10%; padding-left: 100px;"
           for="node-input-sumPassPrio">
      <span>Priority: </span>
    </label>
    <select id="node-input-sumPassPrio" style="width: 50px;"></select>
  </div>

  <div id="sumpass-node-selection" class="hide">
    <div class="form-row">
      <select id="node-input-sumPassNodeId" style="width: 100%">
      </select>
    </div>
  </div>

  <div class="form-row node-text-editor-row">
    <input type="hidden" id="node-input-info" autofocus="autofocus">
    <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-info-editor"></div>
  </div>
  <div class="form-row">
    <label for="node-input-typeDropdown">Change Type</label>
    <select id="node-input-typeDropdown">
    </select>
  </div>
</script>


<script type="text/html" data-help-name="Sketch">
  <p>A writermap node.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-contrib-writermap-mindmap/inspiration] --- -->
<script type="text/javascript">
  RED.nodes.registerType('Inspiration',{ ...window.mmDefaults, ...{
    color: window.wmPaletteColours["60-inspiration"],
    icon: "font-awesome/fa-info",
  }});
</script>

<script type="text/html" data-template-name="Inspiration">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>

  <div class="form-row">
    <label style="display: inline-block; width: 40%;"
           for="node-input-sumPass">
      <i class="fa fa-filter"></i>
      <span>Summaries subnodes?</span>
    </label>
    <input type="checkbox" id="node-input-sumPass"
           style="display:inline-block; width:35px; vertical-align:baseline;">

    <label style="display: inline-block; width: 10%; padding-left: 100px;"
           for="node-input-sumPassPrio">
      <span>Priority: </span>
    </label>
    <select id="node-input-sumPassPrio" style="width: 50px;"></select>
  </div>

  <div id="sumpass-node-selection" class="hide">
    <div class="form-row">
      <select id="node-input-sumPassNodeId" style="width: 100%">
      </select>
    </div>
  </div>

  <div class="form-row node-text-editor-row">
    <input type="hidden" id="node-input-info" autofocus="autofocus">
    <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-info-editor"></div>
  </div>
  <div class="form-row">
    <label for="node-input-typeDropdown">Change Type</label>
    <select id="node-input-typeDropdown">
    </select>
  </div>
</script>


<script type="text/html" data-help-name="Inspiration">
  <p>A writermap node.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-contrib-writermap-mindmap/quote] --- -->
<script type="text/javascript">
  RED.nodes.registerType('Quote',{ ...window.mmDefaults, ...{
    color: window.wmPaletteColours["65-quote"],
    icon: "font-awesome/fa-quote-left",
  }});
</script>

<script type="text/html" data-template-name="Quote">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>

  <div class="form-row">
    <label style="display: inline-block; width: 40%;"
           for="node-input-sumPass">
      <i class="fa fa-filter"></i>
      <span>Summaries subnodes?</span>
    </label>
    <input type="checkbox" id="node-input-sumPass"
           style="display:inline-block; width:35px; vertical-align:baseline;">

    <label style="display: inline-block; width: 10%; padding-left: 100px;"
           for="node-input-sumPassPrio">
      <span>Priority: </span>
    </label>
    <select id="node-input-sumPassPrio" style="width: 50px;"></select>
  </div>

  <div id="sumpass-node-selection" class="hide">
    <div class="form-row">
      <select id="node-input-sumPassNodeId" style="width: 100%">
      </select>
    </div>
  </div>

  <div class="form-row node-text-editor-row">
    <input type="hidden" id="node-input-info" autofocus="autofocus">
    <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-info-editor"></div>
  </div>
  <div class="form-row">
    <label for="node-input-typeDropdown">Change Type</label>
    <select id="node-input-typeDropdown">
    </select>
  </div>
</script>


<script type="text/html" data-help-name="Quote">
  <p>A writermap node.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-contrib-writermap-mindmap/definition] --- -->
<script type="text/javascript">
  RED.nodes.registerType('Definition',{ ...window.mmDefaults, ...{
    color: window.wmPaletteColours["70-definition"],
    icon: "font-awesome/fa-file-text-o",
  }});
</script>

<script type="text/html" data-template-name="Definition">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>

  <div class="form-row">
    <label style="display: inline-block; width: 40%;"
           for="node-input-sumPass">
      <i class="fa fa-filter"></i>
      <span>Summaries subnodes?</span>
    </label>
    <input type="checkbox" id="node-input-sumPass"
           style="display:inline-block; width:35px; vertical-align:baseline;">

    <label style="display: inline-block; width: 10%; padding-left: 100px;"
           for="node-input-sumPassPrio">
      <span>Priority: </span>
    </label>
    <select id="node-input-sumPassPrio" style="width: 50px;"></select>
  </div>

  <div id="sumpass-node-selection" class="hide">
    <div class="form-row">
      <select id="node-input-sumPassNodeId" style="width: 100%">
      </select>
    </div>
  </div>

  <div class="form-row node-text-editor-row">
    <input type="hidden" id="node-input-info" autofocus="autofocus">
    <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-info-editor"></div>
  </div>
  <div class="form-row">
    <label for="node-input-typeDropdown">Change Type</label>
    <select id="node-input-typeDropdown">
    </select>
  </div>
</script>


<script type="text/html" data-help-name="Definition">
  <p>A writermap node.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-contrib-writermap-mindmap/book] --- -->
<script type="text/javascript">
  RED.nodes.registerType('Book',{ ...window.mmDefaults, ...{
    color: window.wmPaletteColours["75-book"],
    icon: "font-awesome/fa-book",
  }});
</script>

<script type="text/html" data-template-name="Book">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>

  <div class="form-row">
    <label style="display: inline-block; width: 40%;"
           for="node-input-sumPass">
      <i class="fa fa-filter"></i>
      <span>Summaries subnodes?</span>
    </label>
    <input type="checkbox" id="node-input-sumPass"
           style="display:inline-block; width:35px; vertical-align:baseline;">

    <label style="display: inline-block; width: 10%; padding-left: 100px;"
           for="node-input-sumPassPrio">
      <span>Priority: </span>
    </label>
    <select id="node-input-sumPassPrio" style="width: 50px;"></select>
  </div>

  <div id="sumpass-node-selection" class="hide">
    <div class="form-row">
      <select id="node-input-sumPassNodeId" style="width: 100%">
      </select>
    </div>
  </div>

  <div class="form-row node-text-editor-row">
    <input type="hidden" id="node-input-info" autofocus="autofocus">
    <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-info-editor"></div>
  </div>
  <div class="form-row">
    <label for="node-input-typeDropdown">Change Type</label>
    <select id="node-input-typeDropdown">
    </select>
  </div>
</script>


<script type="text/html" data-help-name="Book">
  <p>A writermap node.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-contrib-writermap-mindmap/author] --- -->
<script type="text/javascript">
  RED.nodes.registerType('Author',{ ...window.mmDefaults, ...{
    color: window.wmPaletteColours["80-author"],
    icon: "font-awesome/fa-pencil",
  }});
</script>

<script type="text/html" data-template-name="Author">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>

  <div class="form-row">
    <label style="display: inline-block; width: 40%;"
           for="node-input-sumPass">
      <i class="fa fa-filter"></i>
      <span>Summaries subnodes?</span>
    </label>
    <input type="checkbox" id="node-input-sumPass"
           style="display:inline-block; width:35px; vertical-align:baseline;">

    <label style="display: inline-block; width: 10%; padding-left: 100px;"
           for="node-input-sumPassPrio">
      <span>Priority: </span>
    </label>
    <select id="node-input-sumPassPrio" style="width: 50px;"></select>
  </div>

  <div id="sumpass-node-selection" class="hide">
    <div class="form-row">
      <select id="node-input-sumPassNodeId" style="width: 100%">
      </select>
    </div>
  </div>

  <div class="form-row node-text-editor-row">
    <input type="hidden" id="node-input-info" autofocus="autofocus">
    <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-info-editor"></div>
  </div>
  <div class="form-row">
    <label for="node-input-typeDropdown">Change Type</label>
    <select id="node-input-typeDropdown">
    </select>
  </div>
</script>


<script type="text/html" data-help-name="Author">
  <p>A writermap node.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-contrib-writermap-mindmap/blogchanges] --- -->
<script type="text/javascript">
  RED.nodes.registerType('BlogChanges',{
    color: '#ddeeff',
    icon: "font-awesome/fa-tty",
    category: 'blog',
    defaults: {
      name: { value: "" },
    },

    inputs: 1,
    outputs: 1,

    label: function() {
      return (this.name || this._def.paletteLabel);
    },

    oneditresize: function(size) {
    },

    /* This is used to update the createdAt and updatedAt fields on the
       writermap nodes. This is done here since they have become part
       of the blog framework.
    */
    onpaletteadd: () => {
      RED.events.on("nodes:change", (node) => {
        if ( node._def &&
             node._def.defaults &&
             node._def.defaults.hasOwnProperty("updatedAt") &&
             node.changed ) {
          node.updatedAt = (new Date()).toISOString();
        }
      });

      RED.events.on("nodes:add", (node) => {
        var dtStamp = (new Date()).toISOString();

        if ( !node._config && node._def && node._def.defaults ) {

          if ( node._def.defaults.hasOwnProperty("createdAt") ) {
            node.createdAt = dtStamp;
          }

          if ( node._def.defaults.hasOwnProperty("updatedAt") ) {
            node.updatedAt = dtStamp;
          }
        }
      });
    },

    oneditprepare: function() {
    },

    oneditcancel: function() {
    },

    oneditsave: function() {
    },

    labelStyle: function() {
      return this.name?"node_label_italic":"";
    },
  });
</script>

<script type="text/html" data-template-name="BlogChanges">
  <div class="form-row">
      <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name">Name</span></label>
      <input type="text" id="node-input-name" placeholder="Name">
  </div>
</script>


<script type="text/html" data-help-name="BlogChanges">
    <p>Keep tabs on changes to the blog pages and content.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-contrib-writermap-mindmap/blogdetails] --- -->
<script type="text/javascript">
  RED.nodes.registerType('BlogDetails',{
    color: '#ddeeff',
    icon: "font-awesome/fa-cog",
    category: 'blog',
    defaults: {
      name: { value: "" },

      authorName:  { value: "" },
      authorEmail: { value: "" },
      authorUrl:   { value: "" },

      blogUrl:            { value: "" },
      blogCdnUrl:         { value: "" },
      blogPathPrefix:     { value: "/" },
      blogTitle:          { value: "" },
      blogSubtitle:       { value: "" },
      blogContact:        { value: "" },
      blogCopyrightOwner: { value: "" },
    },
    inputs: 1,
    outputs: 1,
    label: function() {
      return (this.name || this._def.paletteLabel);
    },

    labelStyle: function() {
      return this.name?"node_label_italic":"";
    },

    onpaletteadd: () => {
      /** Hack solution to replace the monaco editor on mobile with the
          ace editor. Monaco has a long standing problem with mobile over
          which many people have complained. Microsoft does not seem to
          care --> https://github.com/Microsoft/monaco-editor/issues/246
      ***/
      if ( (RED.utils.getBrowserInfo().mobile > 0) ||
           window.matchMedia('only screen and (max-width: 890px)').matches ) {
        var editorSettings = RED.settings.get("codeEditor")
        RED.settings.set("codeEditor", {
          lib: "ace",
          options: {
            ...{
              "editor": {
                "highlightActiveLine": false
              },
            },
            ...editorSettings.options
          }
        });
        RED.editor.codeEditor.init();
        RED.settings.set("codeEditor", editorSettings);
      }
    },
  });
</script>

<script type="text/html" data-template-name="BlogDetails">
  <div class="form-row">
    <label for="node-input-name">
      <i class="fa fa-tag"></i>
      <span data-i18n="common.label.name">Name</span>
    </label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>

  <div class="form-row">
    <label>Blog</label>
  </div>

  <div class="form-row">
    <label for="node-input-blogUrl"><i class="fa fa-link"></i> Url</label>
    <input type="text" id="node-input-blogUrl" placeholder="URL">
  </div>

  <div class="form-row">
    <label for="node-input-blogCdnUrl">
      <i class="fa fa-database"></i>
      Cdn
    </label>
    <input type="text" id="node-input-blogCdnUrl" placeholder="URL">
  </div>

  <div class="form-row">
    <label for="node-input-blogPathPrefix">
      <i class="fa fa-link"></i>
      Path Prefix
    </label>
    <input type="text" id="node-input-blogPathPrefix" placeholder="/">
  </div>

  <div class="form-row">
    <label for="node-input-blogTitle">
      <i class="fa fa-tag"></i>
      Title
    </label>
    <input type="text" id="node-input-blogTitle" placeholder="Title">
  </div>

  <div class="form-row">
    <label for="node-input-blogSubtitle">
      <i class="fa fa-tag"></i>
      Subtitle
    </label>
    <input type="text" id="node-input-blogSubtitle" placeholder="Subtitle">
  </div>

  <div class="form-row">
    <label for="node-input-blogContact">
      <i class="fa fa-envelope"></i>
      Contact
    </label>
    <input type="text" id="node-input-blogContact" placeholder="Email">
  </div>

  <div class="form-row">
    <label for="node-input-blogCopyrightOwner">
      <i class="fa fa-copyright"></i>
      Copyright
    </label>
    <input type="text" id="node-input-blogCopyrightOwner" placeholder="Copyright">
  </div>

  <div class="form-row">
    <label>Author</label>
  </div>

  <div class="form-row">
    <label for="node-input-authorName">
      <i class="fa fa-tag"></i>
      <span data-i18n="common.label.name">Name</span>
    </label>
    <input type="text" id="node-input-authorName" placeholder="Name">
  </div>

  <div class="form-row">
    <label for="node-input-authorEmail">
      <i class="fa fa-envelope"></i>
      Email
    </label>
    <input type="text" id="node-input-authorEmail" placeholder="Email">
  </div>

  <div class="form-row">
    <label for="node-input-authorUrl">
      <i class="fa fa-link"></i>
      Website
    </label>
    <input type="text" id="node-input-authorUrl" placeholder="Url">
  </div>

</script>


<script type="text/html" data-help-name="BlogDetails">
    <p>Define some blog configuration stuff.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-contrib-writermap-mindmap/blogpages] --- -->

<style>
.duplicate-path {
  background-color: #f6c1cc !important;
}
</style>

<script type="text/javascript">
  RED.nodes.registerType('BlogPages',{
    color: '#ddeeff',
    icon: "font-awesome/fa-sitemap",
    category: 'blog',
    defaults: {
      name: { value: "", },
    },
    inputs: 1,
    outputs: 1,

    label: function() {
      return (this.name || this._def.paletteLabel);
    },

    labelStyle: function() {
      return this.name?"node_label_italic":"";
    },

    oneditprepare: function() {
    },

    oneditresize: function(size) {
    }
  });
</script>

<script type="text/html" data-template-name="BlogPages">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name">Name</span></label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>
</script>


<script type="text/html" data-help-name="BlogPages">
    <p>Return an array of all blog pages.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-contrib-writermap-mindmap/blogpageinfo] --- -->
<script type="text/javascript">
(function(){
  var obtainAllLinkIns = function(thisNode) {
    var linkIns = [];
    RED.nodes.eachLink( function(lnk) {
      if ( lnk.target.id == thisNode.id &&
           lnk.source.type == "link in"  &&
           lnk.source.name.match(/^(\[[^\]]+\][ \t\n]+)([^ ]+)/) ) {
        linkIns.push({
          n: lnk.source,
          p: lnk.source.name.match(/^(\[[^\]]+\][ \t\n]+)([^ ]+)/)[2],
          d: lnk.source.d || false,
        });
      }
    });

    return linkIns;
  };

  var obtainPathsFromLinkIns = function(linkIns) {
    if ( linkIns.length == 0 ) {
      return undefined
    } else {
      return linkIns.map( (n) => { return n.p }).join(", ");
    }
  };

  var blgPgInfofillDropNodeList = function(that) {
    var sltObj = $('#node-input-redirectNodeId');
    sltObj.html("");

    sltObj.append(
      $('<option></option>').val("status-404").html("404 Not Found")
    );
    sltObj.append(
      $('<option></option>').val("blog-home").html("Blog Home (/)")
    );

    var checkLinkInNodeConnectedToBlogInfoNode = (nde, thisNode) => {
      return RED.nodes.getNodeLinks(nde.id).filter( function (b) {
        return (b.target.type == "BlogPageInfo" && b.target.id != thisNode.id)
      }).length > 0;
    };

    RED.nodes.eachNode( function(n) {
      if ( n.type == "link in" &&
           n.name.match( /^(\[[^\]]+\][ \t\n]+)([^ ]+)/) &&
           n.d != true &&
           n.id != that.id &&
           checkLinkInNodeConnectedToBlogInfoNode(n, that) ) {
        sltObj.append($('<option></option>').val(n.id).html(
          n.name.match( /^(\[[^\]]+\][ \t\n]+)([^ ]+)/)[2] + " (" +
            n.name.match( /^\[([^\]]+)][ \t\n]+/)[1] + ")"
        ));
      }
    });
  };

  RED.nodes.registerType('BlogPageInfo',{
    color: '#ddeeff',
    icon: "font-awesome/fa-info",
    category: 'blog',
    defaults: {},
    inputs: 1,
    outputs: 1,
    defaults: {
      name:        { value: "" },
      image:       { value: "" },
      summary:     { value: "" },
      title:       { value: "" },
      tags:        { value: "" },
      publishedAt: { value: undefined },
      updatedOn:   { value: undefined },

      incRss:     { value: false },
      incSitemap: { value: false },
      incIndex:   { value: false },
      draft:      { value: true },

      shrHackerNews:      { value: false },
      shrLinkedIn:        { value: false },
      supportNodeRedJson: { value: false },
      reloadOnEdit:       { value: false },
      editbutton:         { value: false },

      redirectToNode: { value: false },
      redirectNodeId: { value: "status-404" },
      redirectStatusCode: { value: "301" }
    },

    label: function() {
      var txt = (this.name || obtainPathsFromLinkIns(obtainAllLinkIns(this)) ||
                 this._def.paletteLabel || this._def.type);

      return txt + (
        (this.redirectToNode ? " ↗" : "") +
        (this.reloadOnEdit   ? " ↻" : "") +
        (this.draft          ? " Ɛ" : "")
      );
    },

    labelStyle: function() {
      return this.name ? "node_label_italic" : "";
    },

    oneditprepare: function() {
      var linkIns = obtainAllLinkIns(this);

      if ( linkIns.length > 0 ) {
        if ( linkIns.length == 1 ) {
          var nde = linkIns[0];
          $("#node-input-infoPath").val(
            (nde.d ? "✕ " : "") + nde.p
          ).prop("readonly", "readonly");
        } else {
          var opts = [];

          linkIns.forEach( function(nde) {
            opts.push( {
              value: nde.p,
              label: (nde.d ? "✕ " : "") + nde.p
            })
          });

          $("#node-input-infoPath").typedInput({
            types: [
              {
                value: linkIns[0].p,
                options: opts
              }
            ]
          });
        }
      } else {
        $("#node-input-infoPath-row").hide();
      }

      if ( !this.publishedAt || this.publishedAt == "") {
        $('#node-input-publishedAt').val(
          (new Date()).toISOString().substring(0,16)
        );
      }

      if ( !this.updatedOn || this.updatedOn == "") {
        $('#node-input-updatedOn').val(
          (new Date()).toISOString().substring(0,16)
        );
      }

      this.editor = RED.editor.createEditor({
        id: 'node-input-summary',
        mode: 'ace/mode/markdown',
        value: $("#node-input-summary").val()
      });

      var node = this;

      if ( $('#node-input-redirectToNode').is(":checked") ) {
        blgPgInfofillDropNodeList(node);
        $('#redirect-target').show()
        $('#node-input-redirectNodeId').val(node.redirectNodeId || "status-404");
      } else {
        $('#redirect-target').hide()
      }

      $('#node-input-redirectToNode').on( 'change', function() {
        if ( $('#node-input-redirectToNode').is(":checked") ) {
          blgPgInfofillDropNodeList(node);
          $('#redirect-target').show()
          $('#node-input-redirectNodeId').val(node.redirectNodeId || "status-404");
        } else {
          $('#redirect-target').hide()
        }
      });

      $(
        '#node-input-redirectStatusCode-' + (this.redirectStatusCode || "302")
      ).prop('checked','checked');

      $('#node-input-draft').on('change', function() {
        if ( $('#node-input-draft').prop('checked') ) {
          $('#node-input-incRss'    ).prop('checked',false);
          $('#node-input-incIndex'  ).prop('checked',false);
          $('#node-input-incSitemap').prop('checked',false);

          $('#node-input-shrHackerNews').prop('checked',false);
          $('#node-input-shrLinkedIn'  ).prop('checked',false);
        }
      });
    },

    oneditsave: function() {
      this.redirectStatusCode = $(
        'input[name="node-input-redirectStatusCode"]:checked'
      ).val();

      $("#node-input-summary").val(this.editor.getValue());
      this.editor.destroy();
      delete this.editor;
    },
    oneditcancel: function() {
      this.editor.destroy();
      delete this.editor;
    },

  });
})();
</script>

<script type="text/html" data-template-name="BlogPageInfo">
  <div class="form-row">
    <label for="node-input-name">
      <i class="fa fa-tag"></i>
      <span data-i18n="common.label.name">Name</span>
    </label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>

  <hr>

  <div class="form-row" id="node-input-infoPath-row">
    <label for="node-input-infoPath">
      <i class="fa fa-tag"></i>
      <span data-i18n="common.label.name">Path</span>
    </label>
    <input type="text" id="node-input-infoPath">
  </div>

  <div class="form-row">
    <label for="node-input-title">
      <i class="fa fa-tag"></i>
      <span>Title</span>
    </label>
    <input type="text" id="node-input-title" placeholder="Title">
  </div>

  <div class="form-row">
    <label for="node-input-summary">
      <i class="fa fa-tag"></i>
      <span>Summary</span>
    </label>
    <div style="height: 150px; min-height:150px; max-height: 150px;"
         class="node-text-editor" id="node-input-summary"></div>
  </div>

  <div class="form-row">
    <label for="node-input-publishedAt">
      <i class="fa fa-clock-o"></i>
      <span>Published</span>
    </label>
    <input type="datetime-local" id="node-input-publishedAt">
  </div>

  <div class="form-row">
    <label for="node-input-updatedOn">
      <i class="fa fa-clock-o"></i>
      <span>Updated</span>
    </label>
    <input type="datetime-local" id="node-input-updatedOn">
  </div>

  <div class="form-row">
    <label for="node-input-image">
      ⊞
      <span>Preview</span>
    </label>
    <input type="text" id="node-input-image" placeholder="Image Filename">
  </div>

  <div class="form-row">
    <label for="node-input-tags">
      <i class="fa fa-hashtag"></i>
      <span>Tags</span>
    </label>
    <input type="text" id="node-input-tags" placeholder="Comma,Separated,Tags">
  </div>

  <hr>

  <div class="form-row">
    <label>Include in ...</label>
  </div>

  <div class="form-row">
    <label for="node-input-incIndex">
      ⌂
      <span>Index?</span>
    </label>
    <input type="checkbox" id="node-input-incIndex" style="display:inline-block; width:15px; vertical-align:baseline;">
  </div>

  <div class="form-row">
    <label for="node-input-incRss">
      ⋔
      <span>RSS Feed</span>
    </label>
    <input type="checkbox" id="node-input-incRss" style="display:inline-block; width:15px; vertical-align:baseline;">
  </div>

  <div class="form-row">
    <label for="node-input-incSitemap">
      ⅄
      <span>Sitemap?</span>
    </label>
    <input type="checkbox" id="node-input-incSitemap" style="display:inline-block; width:15px; vertical-align:baseline;">

    <label for="node-input-draft" style="margin-left: 120px;">
      Ɛ
      <span>Draft?</span>
    </label>
    <input type="checkbox" id="node-input-draft" style="display:inline-block; width:85px; vertical-align:baseline;">
  </div>

  <hr>

  <div class="form-row">
    <label for="node-input-shrLinkedIn"
           style="display: inline-block; width: 45%;">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" data-supported-dps="24x24" fill="white" width="24" height="24" focusable="false" style="background-color: blue; transform: scale(0.8); translate: 0px 7px;">
          <path d="M20.5 2h-17A1.5 1.5 0 002 3.5v17A1.5 1.5 0 003.5 22h17a1.5 1.5 0 001.5-1.5v-17A1.5 1.5 0 0020.5 2zM8 19H5v-9h3zM6.5 8.25A1.75 1.75 0 118.3 6.5a1.78 1.78 0 01-1.8 1.75zM19 19h-3v-4.74c0-1.42-.6-1.93-1.38-1.93A1.74 1.74 0 0013 14.19a.66.66 0 000 .14V19h-3v-9h2.9v1.3a3.11 3.11 0 012.7-1.4c1.55 0 3.36.86 3.36 3.66z"></path>
        </svg>
      <span>Share link for LinkedIn?</span>
    </label>
    <input type="checkbox" id="node-input-shrLinkedIn" style="display:inline-block; width:15px; vertical-align:baseline;">

    <label for="node-input-shrHackerNews"
           style="display: inline-block; width: 31%; margin-left: 10px;">
        <svg viewBox="0 0 100 100" width="22" height="22" xmlns="http://www.w3.org/2000/svg" style="background-color: #ff6600; transform: scale(0.8); translate: 0px 7px;">
            <path d="M 50 77 L 50 50 " fill="none" stroke="rgb(255, 255, 255)" stroke-width="8.78662150719729" stroke-linecap="butt">
            </path>
            <path d="M 94.93056731583404 35.622745513916016 L 71.2454833984375 71.2454833984375 " fill="none" stroke="rgb(255, 255, 255)" stroke-width="8.78662150719729" stroke-linecap="butt" transform="matrix(1 0 0 1 -21.2455 -21.2455)">
            </path>
            <path d="M -78.93056731583404 36.17028045654297 L -55.67118835449219 71.79300689697266 " fill="none" stroke="rgb(255, 255, 255)" stroke-width="8.78662150719729" stroke-linecap="butt" transform="matrix(1 0 0 1 105.396 -21.7213)">
            </path>
        </svg>
      <span>Submit HN?</span>
    </label>
    <input type="checkbox" id="node-input-shrHackerNews" style="display:inline-block; width:15px; vertical-align:baseline;">
  </div>

  <div class="form-row">
    <label style="display: inline-block; width: 45%;"
           for="node-input-reloadOnEdit">
      <i class="fa fa-repeat"></i>
      <span>Reload on edit?</span>
    </label>
    <input type="checkbox" id="node-input-reloadOnEdit"
           style="display:inline-block; width:15px; vertical-align:baseline;">

    <label style="display: inline-block; width: 30%; margin-left: 15px;"
           for="node-input-editbutton">
      <i class="fa fa-pencil"></i>
      <span>Editbutton?</span>
    </label>
    <input type="checkbox" id="node-input-editbutton"
           style="display:inline-block; width:15px; vertical-align:baseline;">
  </div>

  <div class="form-row">
    <label style="display: inline-block; width: 45%;"
           for="node-input-supportNodeRedJson">
      <i class="fa fa-code-fork"></i>
      Support <tt>&#96;&#96;&#96;noderedjson</tt>?
    </label>
    <input type="checkbox" id="node-input-supportNodeRedJson"
           style="display:inline-block; width:15px; vertical-align:baseline;">
  </div>

  <hr>
  <div class="form-row">
    <label for="node-input-redirectToNode">
      <i class="fa fa-external-link"></i>
      <span>Redirect?</span>
    </label>
    <input type="checkbox" id="node-input-redirectToNode" style="display:inline-block; width:15px; vertical-align:baseline;">
  </div>

  <div id="redirect-target" class="hidden">
    <div class="form-row">
      <input type="radio" id="node-input-redirectStatusCode-302"
             name="node-input-redirectStatusCode" value="302"
             style="width: 50px">
      <label for="node-input-redirectStatusCode-302"
             style="width: 130px">Temporary (302)</label>
      <input type="radio" id="node-input-redirectStatusCode-301"
             name="node-input-redirectStatusCode" value="301"
             style="width: 50px">
      <label for="node-input-redirectStatusCode-301"
             style="width: 130px">Permament (301)</label>
    </div>

    <div class="form-row">
      <select id="node-input-redirectNodeId" style="width: 100%">
      </select>
    </div>
  </div>


</script>


<script type="text/html" data-help-name="BlogPageInfo">
    <p>Set features for the blog page.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-contrib-writermap-mindmap/blogcontent] --- -->
<script type="text/javascript">
 (function($){
   const writerMapUtils = {
     one: undefined,

     fillSumPassPrioSelection: (that) => {
       var sltObj = $('#node-input-sumPassPrio');
       sltObj.html("");

       for ( var idx = 20; idx > -21; idx-- ) {
         sltObj.append($('<option></option>').val(idx).html(idx));
       };

       sltObj.val(that.sumPassPrio || 0);
     },

     fillSumPassNodeSelection: (nde) => {
       var sltObj = $('#node-input-sumPassNodeId');
       sltObj.html("");

       sltObj.append(
         $('<option></option>').val("").html(" -- All -- ")
       );

       RED.nodes.eachLink( function(lnk) {
         if ( lnk.source.id == nde.id &&
              lnk.target.d != true ) {
           sltObj.append(
             $('<option></option>').val(lnk.target.id).html(
               ( ( typeof lnk.target._def.label == "function") ?
                 lnk.target._def.label.call(lnk.target) :
                 "NO LABEL FOR " + lnk.target.id
               )
             )
           );
         }
       });
     },

     addTargetToExternalLinks: function(el) {
       $(el).find("a").each(function(el) {
         var href = $(this).attr('href');
         if (/^https?:/.test(href)) {
           $(this).attr('target','_blank');
         }
       });
       return el;
     },

     setInfoText: function(infoText,target) {
       var info = writerMapUtils.addTargetToExternalLinks($('<div class="red-ui-help"><span class="red-ui-text-bidi-aware" dir=\"'+RED.text.bidi.resolveBaseTextDir(infoText)+'">'+infoText+'</span></div>')).appendTo(target);

       info.find(".red-ui-text-bidi-aware").contents().filter(function() {
         return this.nodeType === 3 && this.textContent.trim() !== ""
       }).wrap( "<span></span>" );

       var foldingHeader = "H3";
       info.find(foldingHeader).wrapInner(
         '<a class="red-ui-help-info-header expanded" href="#"></a>'
       ).find("a").prepend(
         '<i class="fa fa-angle-right">'
       ).on("click", function(e) {
             e.preventDefault();
             var isExpanded = $(this).hasClass('expanded');
             var el = $(this).parent().next();
             while(el.length === 1 && el[0].nodeName !== foldingHeader) {
               el.toggle(!isExpanded);
               el = el.next();
             }
             $(this).toggleClass('expanded',!isExpanded);
           })
     },

     allWriterMapTypes: function () {
       var tes = []

       RED.nodes.registry.getNodeList().forEach( nd => {
         nd.types.forEach( typ => {
           let typDef = RED.nodes.registry.getNodeType(typ) || {};
           if ( typDef._collection == "writermap" ) {
             tes.push( typ )
           }
         })
       })

       return tes;
     },

     fillTypeDropDown: function (nde) {
       var sltObj = $('#node-input-typeDropdown');
       sltObj.html("");

       writerMapUtils.allWriterMapTypes().forEach( (typ) => {
         sltObj.append(
           $('<option></option>').val(typ).html(typ)
         )
       });

       sltObj.val(nde.type);
     }
   };

   RED.nodes.registerType('BlogContent', {
     color: "#c8ffb5",
     icon: "font-awesome/fa-file-text-o",
     category: "blog",
     _collection: 'writermap',

     defaults: {
       name: {
         value:""
       },
       info: {
         value:""
       },

       sumPass: {
         value: false
       },
       sumPassPrio: {
         value: 0,
       },
       sumPassNodeId: {
         value: ""
       },

       /* createdAt and updatedAt are "internal" attributes that track just
          that: when the node was created and the last time it was updated.
          These aren't shown in the edit window because they are maintained
          internally. These are managed by BlogChanges node (onpaletteadd has
          event listeners for updating these values).
        */
       createdAt: {
         value: "",
       },
       updatedAt: {
         value: "",
       },
     },

     inputs:1,
     outputs:1,

     labelStyle: function() {
       return (this.name || this.info) ? "node_label_italic" : "";
     },

     info: function() {
       return this.name ? "# "+this.name+"\n\n---\n\n" : "";
     },

     label: function() {
       return ( (this.name ||
                 this.info.replace(/(.{40,60})([ \n\t])/g,"$1\\n$2")) ||
                this._def.paletteLabel || this.type) +
           (this.sumPassPrio && parseInt(this.sumPassPrio) != 0 ? " (" + this.sumPassPrio + ")" : "") +
           (this.sumPass ? " ⭄" : "");
     },

     oneditprepare: function() {
       var that = this;

       this.editor = RED.editor.createEditor({
         id: 'node-input-info-editor',
         mode: 'ace/mode/markdown',
         value: $("#node-input-info").val()
       });
       this.editor.focus();

       writerMapUtils.fillSumPassPrioSelection(that);

       if ( $('#node-input-sumPass').is(":checked") ) {
         writerMapUtils.fillSumPassNodeSelection(that);
         $('#sumpass-node-selection').show()
         $('#node-input-sumPassNodeId').val(that.sumPassNodeId);
       } else {
         $('#sumpass-node-selection').hide()
       }

       $('#node-input-sumPass').on( 'change', function() {
         if ( $('#node-input-sumPass').is(":checked") ) {
           writerMapUtils.fillSumPassNodeSelection(that);
           $('#sumpass-node-selection').show()
           $('#node-input-sumPassNodeId').val(that.sumPassNodeId);
         } else {
           $('#sumpass-node-selection').hide()
         }
       });

       writerMapUtils.fillTypeDropDown(that);
     },

     oneditsave: function() {
       $("#node-input-info").val(this.editor.getValue());
       this.editor.destroy();
       delete this.editor;

       var newType = $('#node-input-typeDropdown').val();
       if ( newType && newType != this.type ) {
         var nde = RED.nodes.node(this.id);
         nde.type = newType;

         this.changed = true;
         nde.dirty = true;

         RED.nodes.dirty(true)
         RED.view.redraw()
       }
     },

     oneditcancel: function() {
       this.editor.destroy();
       delete this.editor;
     },

     oneditresize: function(size) {
       var rows = $("#dialog-form>div:not(.node-text-editor-row)");
       var height = $("#dialog-form").height();
       for (var i=0; i<rows.length; i++) {
         height -= $(rows[i]).outerHeight(true);
       }
       var editorRow = $("#dialog-form>div.node-text-editor-row");
       height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));
       $(".node-text-editor").css("height",height+"px");
       this.editor.resize();
     }

   });
 })(jQuery);
</script>

<script type="text/html" data-template-name="BlogContent">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>

    <div class="form-row">
        <label style="display: inline-block; width: 40%;"
               for="node-input-sumPass">
            <i class="fa fa-filter"></i>
            <span>Summaries subnodes?</span>
        </label>
        <input type="checkbox" id="node-input-sumPass"
               style="display:inline-block; width:35px; vertical-align:baseline;">

        <label style="display: inline-block; width: 10%; padding-left: 100px;"
               for="node-input-sumPassPrio">
            <span>Priority: </span>
        </label>
        <select id="node-input-sumPassPrio" style="width: 50px;"></select>
    </div>

    <div id="sumpass-node-selection" class="hide">
        <div class="form-row">
            <select id="node-input-sumPassNodeId" style="width: 100%">
            </select>
        </div>
    </div>

    <div class="form-row node-text-editor-row">
        <input type="hidden" id="node-input-info" autofocus="autofocus">
        <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-info-editor"></div>
    </div>

    <div class="form-row">
        <label for="node-input-typeDropdown">Change Type</label>
        <select id="node-input-typeDropdown">
        </select>
    </div>
</script>


<script type="text/html" data-help-name="BlogContent">
    <p>Content for a blog.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-contrib-writermap-mindmap/pubmedium] --- -->
<script type="text/javascript">
  RED.nodes.registerType('PubMedium',{
    color: '#ddee44',
    icon: "icons/medium.svg",
    category: 'blog',
    defaults: {
      name: {
        value: "",
      },

      apiToken: {
        value: ""
      },
      apiTokenType: {
        value: ""
      },

      title: {
        value: "",
      },
      contentFormat: {
        value: "markdown"
      },
      content: {
        value: ""
      },
      tags: {
        value: ""
      },
      canonicalUrl: {
        value: ""
      },
      publishStatus: {
        value: "draft",
      },
      license: {
        value: "all-rights-reserved"
      },
      notifyFollowers: {
        value: false,
      }
    },
    inputs: 1,
    outputs: 1,

    label: function() {
      return (this.name || this._def.paletteLabel);
    },

    labelStyle: function() {
      return this.name?"node_label_italic":"";
    },

    oneditprepare: function() {
      $("#node-input-apiToken").typedInput({
        types:["env", "msg", "flow","global", "cred"],
        typeField: "#node-input-apiTokenType"
      });
    },

    oneditsave: function() {
    },

    oneditresize: function(size) {
    }
  });
</script>

<script type="text/html" data-template-name="PubMedium">

  <div class="form-row">
    <label for="node-input-apiToken">
      <i class="fa fa-tag"></i>
      API Token
    </label>
    <input type="text" id="node-input-apiToken">
    <input type="hidden" id="node-input-apiTokenType">
  </div>

  <hr>

  <div class="form-row">
    <label for="node-input-name">
      <i class="fa fa-tag"></i>
      <span data-i18n="common.label.name">Name</span>
    </label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>

  <div class="form-row">
    <label for="node-input-title">
      <i class="fa fa-tag"></i> <span>Title</span>
    </label>
    <input type="text" id="node-input-title" placeholder="msg.medium.title">
  </div>

  <div class="form-row">
    <label for="node-input-contentFormat">
      <i class="fa fa-code"></i> <span>Content Format</span>
    </label>
    <select id="node-input-contentFormat">
      <option value="markdown" selected=selected>Markdown</option>
      <option value="html">Html</option>
    </select>
  </div>

  <div class="form-row">
    <label for="node-input-content">
      <i class="fa fa-tag"></i> <span>Content</span>
    </label>
    <input type="text" id="node-input-content" placeholder="msg.medium.content">
  </div>

  <div class="form-row">
    <label for="node-input-tags">
      <i class="fa fa-tag"></i> <span>Tags</span>
    </label>
    <input type="text" id="node-input-tags" placeholder="msg.medium.tags">
  </div>

  <div class="form-row">
    <label for="node-input-canonicalUrl">
      <i class="fa fa-link"></i> <span>Canonical Url</span>
    </label>
    <input type="text" id="node-input-canonicalUrl" placeholder="msg.medium.canonicalUrl">
  </div>

  <div class="form-row">
    <label for="node-input-publishStatus">
      <i class="fa fa-tag"></i> <span>Publish Status</span>
    </label>
    <select id="node-input-publishStatus">
      <option value="draft" selected=selected>Draft</option>
      <option value="public">Public</option>
      <option value="unlisted">Unlisted</option>
    </select>
  </div>

  <div class="form-row">
    <label for="node-input-license">
      <i class="fa fa-tag"></i> <span>License</span>
    </label>
    <select id="node-input-license">
      <option value="all-rights-reserved" selected=selected>All rights reserved</option>
      <option value="cc-40-by">cc-40-by</option>
      <option value="cc-40-by-sa">cc-40-by-sa</option>
      <option value="cc-40-by-nd">cc-40-by-nd</option>
      <option value="cc-40-by-nc">cc-40-by-nc</option>
      <option value="cc-40-by-nc-nd">cc-40-by-nc-nd</option>
      <option value="cc-40-by-nc-sa">cc-40-by-nc-sa</option>
      <option value="cc-40-zero">cc-40-zero</option>
      <option value="public-domain">Public Domain</option>
    </select>
  </div>

  <div class="form-row">
    <label for="node-input-notifyFollowers">
      <i class="fa "></i> <span>Notify Followers?</span>
    </label>
    <input type="checkbox" id="node-input-notifyFollowers" style="display:inline-block; width:15px; vertical-align:baseline;">
  </div>

</script>


<script type="text/html" data-help-name="PubMedium">
    <p>Publish content to Medium.com. A Medium API token is recommended else this will not work.</p>
</script>
<!-- --- [red-module:@gregoriusrippenstein/node-red-contrib-aisbreaker/aisbreaker] --- -->
<script type="text/javascript">
(function(){
  
  RED.nodes.registerType('AIsBreaker',{
    color: '#1AE0F0',
    icon: "logo.png",
    category: 'algintell',
    defaults: {
      name: {
        value:"",
      },
      apiToken: {
        value: "",
      },
      apiTokenType: {
        value: "cred",
      },
      serviceid: {
        value: "chat:dummy"
      },
      endpoint: {
        value: "https://api.demo.aisbreaker.org"
      },
      servicejson: {
        value: '{ "serviceId": "chat:dummy"}'
      }
    },

    inputs: 1,

    outputs: 1,

    label: function() {
      return (this.name || this._def.paletteLabel);
    },

    labelStyle: function() {
      return this.name?"node_label_italic":"";
    },

    onpaletteadd: function() {
    },

    oneditprepare: function() {
      $("#node-input-apiToken").typedInput({
        types:["env", "global", "cred"],
        typeField: "#node-input-apiTokenType"
      });
      
      let jssn = JSON.parse(this.servicejson)

      this.editor = RED.editor.createEditor({
        id: 'node-input-servicejson-editor',
        mode: 'ace/mode/json',
        value: JSON.stringify(jssn,null,2)
      });
      
      $('#node-input-serviceid').val( this.serviceid );

      // delay this listener so as not to overwrite the default
      // value of the editor. This is a stupid solution but the
      // servicejson is the default value which is overwritten
      // with the serviceid value is set... because this onchange event
      // is triggered. so setup this listener _after_ setting
      // the value of the selector, i.e. $('#..serviceid').val(..) above
      // the servicejson _may_ have been altered by the user 
      // directly, hence it's the single source of truth even if the
      // serviceid is set.
      setTimeout( () => {
        $('#node-input-serviceid').on('change', (e) => {
          if (e) { e.preventDefault(); }
          
          let v = {
            serviceId: $('#node-input-serviceid').val()
          }

          if ( $('#node-input-serviceid').val() == "aisbreaker:mirror") {
            v = {
              "serviceId": "aisbreaker:mirror",
              "forward2ServiceProps": { 
                  "serviceId": "chat:echo" 
              }
            }
          }

          if ( $('#node-input-serviceid').val() == "chat:openai.com/compatible-version" ) {
            v = {
              "serviceId": "chat:openai.com",
              "url": "https://api.openai.compatible.example.com/v1/chat/completions"
            }
          }

          if ( $('#node-input-serviceid').val() == "chat:gemini.vertexai.google.com/<INSTANCE>") {
            v = {
              "serviceId": "chat:gemini.vertexai.google.com",
              "project": "<YOUR-GOOGLE-CLOUD-PROJECT>",
              "location": "<YOUR-GOOGLE-CLOUD-LOCATION, e.g. 'us-central1'>"
            }
          }
          
          this.editor.setValue(JSON.stringify(v,null,2))
        })
      }, 300);
    },

    oneditcancel: function() {
      this.editor.destroy();
      delete this.editor;
    },

    oneditsave: function() {
      $("#node-input-servicejson").val(this.editor.getValue());
      this.editor.destroy();
      delete this.editor;
    },

    onpaletteremove: function() {
    },
  });
})();
</script>

<script type="text/html" data-template-name="AIsBreaker">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
    <input type="text" id="node-input-name" data-i18n="[placeholder]node-red:common.label.name">
  </div>

  <div class="form-row">
    <label for="node-input-apiToken">
      <i class="fa fa-key"></i>
      <span data-i18n="aisbreaker.access_token.label"></span>
    </label>
    <input type="text" id="node-input-apiToken" data-i18n="[placeholder]aisbreaker.access_token.placeholder">
    <input type="hidden" id="node-input-apiTokenType">
  </div>

  <div class="form-row">
    <label for="node-input-serviceid">
      <i class="fa fa-fax"></i>
      <span data-i18n="aisbreaker.serviceid.label"></span>
    </label>
    <select id="node-input-serviceid">
      <option value="chat:dummy" data-i18n="aisbreaker.serviceid.chat_dummy"></option>
      <option value="aisbreaker:mirror" data-i18n="aisbreaker.serviceid.chat_echo_mirror"></option>

      <option value="chat:openai.com" data-i18n="aisbreaker.serviceid.chat_openai_com"></option>
      <option value="chat:openai.com/gpt-3.5-turbo" data-i18n="aisbreaker.serviceid.chat_openai_com_gpt_3_5_turbo"></option>
      <option value="chat:openai.com/gpt-4" data-i18n="aisbreaker.serviceid.chat_openai_com_gpt_4"></option>
      <option value="chat:openai.com/compatible-version" data-i18n="aisbreaker.serviceid.chat_gtp_compatiable"></option>
      <option value="chat:huggingface.co/microsoft/DialoGPT-large" data-i18n="aisbreaker.serviceid.chat_huggingface_co_microsoft_dialogpt_large"></option>
      <option value="chat:huggingface.co/microsoft/DialoGPT-small" data-i18n="aisbreaker.serviceid.chat_huggingface_co_microsoft_dialogpt_small"></option>
      <option value="chat:huggingface.co/<HF_ACCOUNT>/<HF_MODEL>" data-i18n="aisbreaker.serviceid.chat_huggingface_co_any_model"></option>
      <option value="chat:gemini.vertexai.google.com" data-i18n="aisbreaker.serviceid.chat_google_gemini"></option>
      <option value="chat:gemini.vertexai.google.com/<INSTANCE>" data-i18n="aisbreaker.serviceid.chat_google_gemini_with_own_instance"></option>
      <option value="text-to-image:dummy" data-i18n="aisbreaker.serviceid.text_to_image_dummy"></option>
      <option value="text-to-image:openai.com" data-i18n="aisbreaker.serviceid.text_to_image_openai_com"></option>
      <option value="text-to-image:stability.ai" data-i18n="aisbreaker.serviceid.text_to_image_stability_ai"></option>
    </select>
  </div>

  <div class="form-row node-text-editor-row">
    <input type="hidden" id="node-input-servicejson" autofocus="autofocus">
    <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-servicejson-editor"></div>
  </div>

  <div class="form-row">
    <label for="node-input-endpoint"><i class="fa fa-server"></i> <span data-i18n="aisbreaker.endpoint.label"></span></label>
    <input type="text" id="node-input-endpoint" data-i18n="[placeholder]aisbreaker.endpoint.placeholder">
  </div>
</script>
<script type="text/html" data-help-name="AIsBreaker">
  <p>Wrapper Node around AIsBreaker.org</p>
  Wrapper Node around AIsBreaker.org which itself is a wrapper around several AI chatbots.
</script>

<!-- --- [red-module:@gregoriusrippenstein/node-red-contrib-flow2uml/flowtomermaid] --- -->
<script type="text/javascript">
(function ($) {
   RED.nodes.registerType('Flow2MermaidCfg', {
      category: 'config',
      hasUsers: false,
      defaults: {
         name: { value: "" },
         direction: { value: "" },
         genmereditor: {value:""},
      },
      paletteLabel: 'Flow2MermaidCfg',
      label: function () {
         return this.name;
      }
  });
})(jQuery);
</script>

<!-- The html for the config node info panel (in right sidebar) -->
<script type="text/x-red" data-template-name="Flow2MermaidCfg">
   <p>Generate a Mermaid flowchart diagram from the active flow tab.</p>

   <h3>Description</h3>
   Convert the current flow tabl a work-flow UML diagram in Mermaid syntax. The result is stored in the pasteboard - Ctrl/Cmd-V can be used to paste the Mermaid diagram into the <a style="color: blue;" target=_blank href="https://mermaid.live/edit">live editor <i class="fa fa-external-link"></i></a>.
</script>

<!-- --- [red-module:@gregoriusrippenstein/node-red-contrib-flowcompare/flowcompare] --- -->
<script type="text/javascript">
(function ($) {
   RED.nodes.registerType('FlowCompareCfg', {
      category: 'config',
      hasUsers: false,
      defaults: {
         name: { value: "" },
         data: { value: "" }
      },
      paletteLabel: 'FlowCompareCfg',
      label: function () {
         return this.name;
      }
  });
})(jQuery);
</script>

<!-- The html for the config node info panel (in right sidebar) -->
<script type="text/x-red" data-template-name="FlowCompareCfg">
   <p>Visually compare local flow with flow deployed on the server.</p>
   Viusal comparison of flows being edited and flow that has been deployed.
</script>

<!-- --- [red-module:@gregoriusrippenstein/node-red-contrib-flowhub/flowhubpull] --- -->
<script type="text/javascript">
 (function(){
   function flowHubUpdateFlows(cb=null) {
     $.get(
       "https://api.flowhub.org/v1/flows?cb=" + new Date().getTime()
     ).done( (resp) => {
       var treeListItems = [];

       Object.keys( resp.data ).forEach( function(key) {
         treeListItems.push( {
           label:    resp.data[key].name,
           icon:     "fa fa-eye",
           flowid:   key,
           sublabel: key,
           selected: $('#node-input-flowid').val() == key,
           checkbox: false,
           children: undefined
         });
       });

       if ( cb ) {
         treeListItems.sort( (a,b) => {
           return a.label < b.label ? -1 : 1;
         });

         cb(treeListItems)
       };
     }).fail( (e) => {
       var msg = "";

       if ( e.state() == "rejected" ) {
         msg = "<p>Failed to retrieve FlowHub catalogue, request blocked.</p>"+
               "<p>AdBlocker or uBlock might have prevented request.</p>"+
               "<p>Please check browser console for more details.</p>";
       } else {
         msg = "<p>Failed to retrieve FlowHub catalogue.</p>" +
               "<p>Check browser console for more details.</p>";
       }

       console.warn("Error loading https://api.flowhub.org/v1/flows:",e);
       RED.notify(msg, {
           type: "error",
           id: "FlowHubPull",
           timeout: 4000
         }
       );
     });
   };

   RED.nodes.registerType('FlowHubPull',{
     color: '#44eeff',
     icon: "flowhubpull.svg",
     category: 'flowhub',
     defaults: {
       name: { value: ""},
       notab: { value: false },
       flowid: { value: "" },
       flowname: { value: "" },
       flowrevision: { value: "" }
     },
     inputs: 1,
     outputs: 1,

     label: function() {
       return (this.name || this.flowname || this.flowid || this._def.paletteLabel);
     },

     onpaletteadd: () => {
     },

     oneditresize: function(size) {
       if ( this._resize ) { this._resize(); };
     },

     oneditprepare: function() {
       var dirList = $("#node-input-flowhubpull-target-container-div").css({
        width: "100%",
        height: "100%"
       }).treeList(
         {
           multi:false
         }
       ).on('treelistselect', function(event, item) {
         if ( item.flowid ) {
           $('#node-input-flowid').val(item.flowid);
           $('#node-input-flowname').val(item.label);

           $('#flowhubpull-view-flow-link').attr(
             'href', 'https://flowhub.org/f/'+item.flowid
           ).show();
           
           $('#node-input-import-flow-but').prop('disabled',false)
         }
       }).on('treelistconfirm', function(event, item) {
         if ( item.flowid ) {
           $('#node-input-flowid').val(item.flowid);
           $('#node-input-flowname').val(item.label);

           $('#flowhubpull-view-flow-link').attr(
             'href', 'https://flowhub.org/f/'+item.flowid
           ).show();

           $('#node-input-import-flow-but').prop('disabled',false)
           $("#node-input-import-flow-but").trigger('click');
         }
       });

       var items = [];

       if ( this.flowid ) {
         setTimeout( () => {
           $('#flowhubpull-view-flow-link').attr(
             'href', 'https://flowhub.org/f/' + $('#node-input-flowid').val()
           ).show();
         }, 200);
       } else {
        $('#node-input-import-flow-but').prop('disabled',true)
       }

       this._resize = function() {
         var rows = $("#dialog-form>div:not(.node-input-target-list-row)");
         var height = $("#dialog-form").height();
         for (var i=0;i<rows.length;i++) {
           height -= $(rows[i]).outerHeight(true);
         }
         var editorRow = $("#dialog-form>div.node-input-target-list-row");
         editorRow.css("height",height+"px");
       };

       var search = $("#node-input-flowhubpull-target-filter").searchBox({
         style: "compact",
         delay: 300,
         change: function() {
           var val = $(this).val().trim().toLowerCase();
           if (val === "") {
             dirList.treeList("filter", null);
             search.searchBox("count","");
           } else {
             var count = dirList.treeList("filter", function(item) {
               return item.label.toLowerCase().indexOf(val) > -1 || item.sublabel.toLowerCase().indexOf(val) > -1
             });
             search.searchBox("count",count + " / " + dirList.treeList("data").length);
           }
         }
       });

       flowHubUpdateFlows((treeListItems) => {
         items = treeListItems;
         dirList.treeList('data', treeListItems);
       });

       $('#node-input-refresh-list-but').on('click', function(e) {
         e.preventDefault();

         setTimeout( () => {
           flowHubUpdateFlows((treeListItems) => {
             items = treeListItems;
             dirList.treeList('data', treeListItems);
           });
         }, 300);
       });

       $("#node-input-import-flow-but").on("click", function(e) {
         if ( e ) { e.preventDefault(); }

         var notab = $('#node-input-notab').prop('checked');

         if ( $('#node-input-flowid').val().trim() == "" ||
              !$('#node-input-flowid').val() ) {
           return RED.notify(RED._("notification.warning", {
             message: "FlowID not provided, doing nothing."
           }), "warning");
         }

         $('#node-dialog-ok').trigger('click')

         $.get( "https://api.flowhub.org/v1/flows/" +
                $('#node-input-flowid').val() +
                "?cb=" + new Date().getTime() + "&v=" + 
                $('#node-input-flowrevision').val(), function(e,d) {
                  RED.clipboard.import();

                  setTimeout( () => {
                    var content = e;

                    if ( notab ) {
                      content = e.filter(function(o) {
                        return o.type != "tab"
                      });
                    }

                    $('#red-ui-clipboard-dialog-import-text').val(
                      JSON.stringify(content)
                    ).trigger("paste");
                  }, 300);
                });
       });

       if ( this.notab ) {
         $('#flowhubpull-dialog-import-opt-current').addClass('selected')
         $('#flowhubpull-dialog-import-opt-new').removeClass('selected')
        } else {
         $('#flowhubpull-dialog-import-opt-new').addClass('selected')
         $('#flowhubpull-dialog-import-opt-current').removeClass('selected')
       }
       
       $('#flowhubpull-dialog-import-opt-current').on('click', (e) => {
         e.preventDefault();
         $('#node-input-notab').prop('checked', true)
         $('#flowhubpull-dialog-import-opt-new').removeClass('selected')
         $('#flowhubpull-dialog-import-opt-current').addClass('selected')
       })

       $('#flowhubpull-dialog-import-opt-new').on('click', (e) => {
         e.preventDefault();
         $('#node-input-notab').prop('checked', false)
         $('#flowhubpull-dialog-import-opt-current').removeClass('selected')
         $('#flowhubpull-dialog-import-opt-new').addClass('selected')
       })
     },

     oneditcancel: function() {
     },

     oneditsave: function() {
     },

     labelStyle: function() {
       return this.name?"node_label_italic":"";
     },
   });
 })();
</script>

<script type="text/html" data-template-name="FlowHubPull">
    <div class="form-row">
        <input type="text" id="node-input-flowid" disabled="disabled"
               style="display:inline-block; width:40%; vertical-align:baseline;"
               placeholder="FlowId to Import">
        <button id="node-input-import-flow-but"
                class="red-ui-button">Import Flow</button>
        <input type="text" id="node-input-flowname" style="display: none;">

        <a id="flowhubpull-view-flow-link" style="color: blue; display: none; margin-left: 80px;" 
           target="_blank" href="">View Flow <i class="fa fa-external-link"></i></a>
    </div>

    <div class="form-row">
      <label>
            <span>Import to:</span>
      </label>

      <input type="checkbox" id="node-input-notab" style="display:none;">
      <span>
        <a id="flowhubpull-dialog-import-opt-current" class="red-ui-button toggle" href="#" data-i18n="clipboard.export.current">current flow</a>
        <a id="flowhubpull-dialog-import-opt-new" class="red-ui-button toggle" href="#" data-i18n="clipboard.import.newFlow">new flow</a>
      </span>
    </div>

    <div class="form-row node-input-target-row">
        <button id="node-input-refresh-list-but"
                class="red-ui-button"><i class="fa fa-refresh"></i> Refresh Flow List</button>
    </div>

    <div class="form-row node-input-target-row node-input-target-list-row"
         style="position: relative; min-height: 100px">
        <div style="position: absolute; top: -30px; right: 0px;">
            <input type="text" id="node-input-flowhubpull-target-filter">
        </div>

        <div id="node-input-flowhubpull-target-container-div"></div>
    </div>

    <div class="form-row">
        All flows are licensed under a copyleft <a style="color: blue;" target="_blank" href="https://raw.githubusercontent.com/gorenje/flows.flowhub.org/main/LICENSE">license <i class="fa fa-external-link"></i></a>,<br>
        hereby permission is given to use any flow for any purpose <br>
        <b>other than</b> for evil. No guarantee of purpose fulfillment<br>
        is made nor warrenty for failure - all risk is carried by the user.
    </div>

    <div class="form-row">
      <label for="node-input-flowrevision"><i class="fa fa-tag"></i> Revision</label>
      <input type="text" id="node-input-flowrevision" placeholder="Revision"/>
    </div>
    
    <div class="form-row">
      <hr/>
    </div>

    <div class="form-row">
      <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name">Name</span></label>
      <input type="text" id="node-input-name" placeholder="Name"/>
    </div>
</script>


<script type="text/html" data-help-name="FlowHubPull">
    <p>
        Import Flows from FlowHub.org. Opens the flow import dialog
        with flow data. Flow can be imported into a new tab or the
        existing tab.
    </p>
</script>
<!-- --- [red-module:@gregoriusrippenstein/node-red-contrib-flowhub/flowhubcfg] --- -->
<script type="text/javascript">
(function ($) {
   RED.nodes.registerType('FlowHubCfg', {
      category: 'config',
      hasUsers: false,
      defaults: {
        apiToken: { value: "FLOWHUB_API_TOKEN" },      
        apiTokenType: {   value: "env",   },
        fullname: { value: "" },
        email: { value: "" },
        flowid: { value: "" },
        flowrevision: { value: "" },
        notab: { value: false },
        pushcomment: { value: "" },
      },
      label: 'FlowHubCfg',
  });
})(jQuery);
</script>

<!-- The html for the config node info panel (in right sidebar) -->
<script type="text/x-red" data-template-name="FlowHubCfg">

   <p>Push current flow tab to FlowHub.org.<br>
      Flow tabs are exported as they <b>are in the editor</b>. What you see<br>
      is what you export, the deployed flow might differ. This allows flows to<br>
      be modified <b>without</b> having to be deployed.
    </p>
    
  <p>
      FlowHubPush is the twin to the FlowHubPull node and is responsible for<br>
      uploading the current flow tab to FlowHub. The Flow tab ID is used as<br>
      identifier. The current active flow tab will be uploaded.<br>
  </p>
  <p>
      Documentation on the flow should be included in the info box of the<br>
      flow. Double click on the flow tab opens the property window and<br>
      that's the documentation that will be hosted at FlowHub. Please provide<br>
      documentation otherwise or a flow that is so simple to understand<br>
      that it requires no documentation!
  </p>

  <p>
      Submission can either be done using an API token or using an email<br>
      and full name. See the property tab for details on the usage of this<br>
      service.
  </p>
</script>

<!-- --- [red-module:@gregoriusrippenstein/node-red-contrib-introspection/seeker] --- -->
<script type="text/javascript">
  RED.nodes.registerType('Seeker',{
    color: '#e5e4ef',
    icon: "font-awesome/fa-ship",
    category: 'introspection',
    paletteLabel: "Seeker",
    defaults: {
      name: {
        value:"",
      },
    },
    inputs:0,
    outputs:1,

    label: function() {
      return (this.name || this._def.paletteLabel);
    },

    labelStyle: function() {
      return this.name?"node_label_italic":"";
    },

    oneditprepare: function() {
      var that = this;

      this._resize = function() {
        var rows = $("#dialog-form>div:not(.node-input-target-list-row)");
        var height = $("#dialog-form").height();
        for (var i=0;i<rows.length;i++) {
          height -= $(rows[i]).outerHeight(true);
        }
        var editorRow = $("#dialog-form>div.node-input-target-list-row");
        editorRow.css("height",height+"px");
      };

      var search = $("#node-input-seeker-target-filter").searchBox({
        style: "compact",
        delay: 300,
        change: function() {
          var val = $(this).val().trim().toLowerCase();
          if (val === "") {
            dirList.treeList("filter", null);
            search.searchBox("count","");
          } else {
            var count = dirList.treeList("filter", function(item) {
              return item.label.toLowerCase().indexOf(val) > -1 || item.node.type.toLowerCase().indexOf(val) > -1
            });
            search.searchBox("count",count+" / "+items.length);
          }
        }
      });

      var dirList = $("#node-input-seeker-target-container-div").css({
        width: "100%",
        height: "100%"
      }).treeList({
        multi:true
      }).on("treelistitemmouseover", function(e, item) {
        if ( item.node) {
          if ( item.children) {
            item.node.highlighted = true;
            item.node.dirty = true;
            item.children.forEach( function(n) {
              n.node.highlighted = true;
              n.node.dirty = true;
            });
          } else {
            item.node.highlighted = true;
            item.node.dirty = true;
          }
          RED.view.redraw();
        }
      }).on("treelistitemmouseout", function(e, item) {

        if ( item.node ) {
          if ( item.children ) {
            item.node.highlighted = false;
            item.node.dirty = true;
            item.children.forEach( function(n) {
              n.node.highlighted = false;
              n.node.dirty = true;
            });
          } else {
            item.node.highlighted = false;
            item.node.dirty = true;
          }
          RED.view.redraw();
        }
      }).on('treelistselect', function(event, item) {
        if ( item.node ) {
          if ( item.children) {
            var preselected = item.children.map(function(n) {
              return n.node.id
            });

            RED.tray.hide();
            RED.view.selectNodes({
              selected: preselected,
              onselect: function(selection) {
                RED.tray.show();
              },
              oncancel: function() {
                RED.tray.show();
              }
            });

          } else {
            RED.workspaces.show(item.node.z,false,false,true);
            item.node.highlighted = true;
            item.node.dirty = true;
            RED.view.reveal(item.node.id,true)
          }

          RED.view.redraw();
        }
      });

      var nodePaths = [];

      var traverse = function( node, nodeIds ) {
        if ( nodeIds.indexOf(node.id) < 0 ) {

          switch( node.type ) {

          case "link call":
              RED.nodes.getNodeLinks(node).forEach( function(l) {
                traverse( l.target, [...nodeIds, node.id] );
              });

              node.links.forEach( function(lnkNdeId) {
                var dNode = RED.nodes.node(lnkNdeId);
                if ( !dNode ) { return }

                traverse( dNode, [...nodeIds, node.id] );
              });
              
              break;

          case "link out":
              node.links.forEach( function(lnkNdeId) {
                var dNode = RED.nodes.node(lnkNdeId);
                if ( !dNode ) { return }

                traverse( dNode, [...nodeIds, node.id] );
              });
              break;

          case "Sink":
            nodePaths.push(nodeIds);
            break;

          default:
            RED.nodes.getNodeLinks(node).forEach( function(l) {
              traverse( l.target, [...nodeIds, node.id] );
            })
          }
        }
      };

      RED.nodes.getNodeLinks(that).forEach( function(l) {
        traverse(l.target, [])
      });

      var items = [];
      var nodeItemMap = {};

      var listOfNodes = function(nodePaths) {
        var lenNodePaths = nodePaths.length;
        if ( lenNodePaths > 25 ) {
          var rdmIdx = Math.floor( Math.random() * lenNodePaths );
          /* Avoid duplication by taking a random range of 25 nodes */
          return [...nodePaths, ...nodePaths.slice(0,30)].slice(
            rdmIdx, rdmIdx + 25
          )
        } else {
          return nodePaths;
        }
      }

      listOfNodes(nodePaths).forEach( function (path) {
        var n = RED.nodes.node(path[0]);

        var nodeDef = RED.nodes.getType(n.type);
        var label;
        var sublabel = "Nodes: " + path.length;

        if (nodeDef) {
          var l = nodeDef.label;
          label = (typeof l === "function" ? l.call(n) : l)||"";

          if (sublabel.indexOf("subflow:") === 0) {
            return;
          }
        }

        if (!nodeDef || !label) {
          label = n.type;
        }

        var children = [];

        path.forEach( function(nId) {
          var nde = RED.nodes.node(nId);

          /* junctions can be undefined */
          if ( nde === undefined ) { return }

          var ndeDef = RED.nodes.getType(nde.type);
          var labelStr = nde.type;

          if ( ndeDef ) {
            labelStr = (typeof ndeDef.label === "function" ?
                        ndeDef.label.call(nde) : ndeDef.label) || nde.type ||"";
          }

          children.push(
            {
              "label":    labelStr,
              "node":     nde,
              "sublabel": nde.type
            }
          )
        });

        nodeItemMap[n.id] = {
          node: n,
          label: label,
          sublabel: sublabel,
          selected: false,
          checkbox: false,
          children: children
        };
        items.push(nodeItemMap[n.id]);
      });

      dirList.treeList('data',items);

      $("#node-input-seeker-target-select").on("click", function(e) {
        e.preventDefault();
        var preselected = dirList.treeList('selected').map(function(n) {
          return n.node.id
        });

        RED.tray.hide();
        RED.view.selectNodes({
          selected: preselected,
          onselect: function(selection) {
            RED.tray.show();
          },
          oncancel: function() {
            RED.tray.show();
          },
          filter: function(n) {
            return n.id !== that.id;
          }
        });
      })
    },

    oneditsave: function() {
    },

    oneditresize: function(size) {
      this._resize();
    }

});
</script>

<script type="text/html" data-template-name="Seeker">

  <div class="form-row node-input-target-row">
    <button id="node-input-seeker-target-select" class="red-ui-button">Show Selected</button>
  </div>

  <div class="form-row node-input-target-row node-input-target-list-row" style="position: relative; min-height: 100px">
    <div style="position: absolute; top: -30px; right: 0;"><input type="text" id="node-input-seeker-target-filter"></div>

    <div id="node-input-seeker-target-container-div"></div>
  </div>

  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name">Name</span></label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>

</script>


<script type="text/html" data-help-name="Seeker">
  <p>Ther Seeker seeks in the sink and presents all (max 25) paths that lead to the sink.</p>
</script>
<!-- --- [red-module:@gregoriusrippenstein/node-red-contrib-introspection/sink] --- -->
<script type="text/javascript">
  RED.nodes.registerType('Sink',{
    color: '#e5e4ef',
    icon: "font-awesome/fa-anchor",
    category: 'introspection',
    paletteLabel: "Sink",
    defaults: {
      name: {
        value:"",
      },
    },
    inputs:1,
    outputs:0,

    label: function() {
      return (this.name || this._def.paletteLabel);
    },

    labelStyle: function() {
      return this.name?"node_label_italic":"";
    },
});
</script>

<script type="text/html" data-template-name="Sink">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name">Name</span></label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>
</script>


<script type="text/html" data-help-name="Sink">
  <p>Sink is the end of a chain of nodes to complete a full text.</p>
</script>
<!-- --- [red-module:@gregoriusrippenstein/node-red-contrib-introspection/getflows] --- -->
<script type="text/javascript">
  RED.nodes.registerType('GetFlows',{
    color: '#e5e4ef',
    icon: "introspesubflow.svg",
    category: 'introspection',
    defaults: {
      name: {
        value:"",
      },
      flowVersion: {
        value: "v1"
      },
      useAuthentication: {
        value:false
      },
      apiUsername: {
        value: "",
      },
      apiUsernameType: {
        value: "env",
      },
      apiPassword: {
        value: "",
      },
      apiPasswordType: {
        value: "env",
      },
    },
    inputs:1,
    outputs:1,

    label: function() {
      return (this.name || this._def.paletteLabel);
    },

    labelStyle: function() {
      return this.name?"node_label_italic":"";
    },
    oneditprepare: function() {
      $("#node-input-apiUsername").typedInput({
        types:["env", "msg", "flow","global", "cred"],
        typeField: "#node-input-apiUsernameType"
      });

      $("#node-input-apiPassword").typedInput({
        types:["env", "msg", "flow","global", "env", "cred"],
        typeField: "#node-input-apiPasswordType"
      });

      if ( $('#node-input-useAuthentication').is(":checked") ) {
        $('#useAuthentication-input-fields').show();
      } else {
        $('#useAuthentication-input-fields').hide()
      }

      $('#node-input-useAuthentication').on( 'change', function() {
        if ( $('#node-input-useAuthentication').is(":checked") ) {
          $('#useAuthentication-input-fields').show();
        } else {
          $('#useAuthentication-input-fields').hide()
        }
      });
    },
  });
</script>

<script type="text/html" data-template-name="GetFlows">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>

    <div class="form-row">
      <label for="node-input-flowVersion">
        <i class="fa fa-tag"></i>
        <span>Flow Version</span>
      </label>

      <select id="node-input-flowVersion">
        <option value="v1" selected=selected>Version 1</option>
        <option value="v2">Version 2</option>
      </select>
    </div>

    <div class="form-row">
      <label for="node-input-useAuthentication">
        <i class="fa "></i>
        <span>Use Authentication?</span>
      </label>

      <input type="checkbox" id="node-input-useAuthentication"
             style="display:inline-block; width:15px; vertical-align:baseline;">
    </div>

    <div id="useAuthentication-input-fields" class="hidden">
      <div class="form-row">
        <label for="node-input-apiUsername">
          <i class="fa fa-tag"></i>
          Username
        </label>
        <input type="text" id="node-input-apiUsername">
        <input type="hidden" id="node-input-apiUsernameType">
      </div>

      <div class="form-row">
        <label for="node-input-apiPassword">
          <i class="fa fa-tag"></i>
          Password
        </label>
        <input type="text" id="node-input-apiPassword">
        <input type="hidden" id="node-input-apiPasswordType">
      </div>
    </div>
</script>


<script type="text/html" data-help-name="GetFlows">
  <p>Retrieves the current flow file from the server. This uses the Node-RED API and is therefore storage-method independent. Return value is a JSON.</p>
</script>
<!-- --- [red-module:@gregoriusrippenstein/node-red-contrib-introspection/sendflow] --- -->
<script type="text/javascript">
  RED.nodes.registerType('SendFlow',{
    color: '#e5e4ef',
    icon: "introspesubflow.svg",
    category: 'introspection',
    defaults: {
      name: {
        value:"",
      },
      hostUrl: {
        value: ""
      },
      flowVersion: {
        value: "v1"
      },
      useAuthentication: {
        value:false
      },
      apiUsername: {
        value: "",
      },
      apiUsernameType: {
        value: "env",
      },
      apiPassword: {
        value: "",
      },
      apiPasswordType: {
        value: "env",
      },
    },
    inputs:1,
    outputs:1,

    label: function() {
      return (this.name || this._def.paletteLabel);
    },

    labelStyle: function() {
      return this.name?"node_label_italic":"";
    },
    oneditprepare: function() {
      $("#node-input-apiUsername").typedInput({
        types:["env", "msg", "flow","global", "cred"],
        typeField: "#node-input-apiUsernameType"
      });

      $("#node-input-apiPassword").typedInput({
        types:["env", "msg", "flow","global", "env", "cred"],
        typeField: "#node-input-apiPasswordType"
      });

      if ( $('#node-input-useAuthentication').is(":checked") ) {
        $('#useAuthentication-input-fields').show();
      } else {
        $('#useAuthentication-input-fields').hide()
      }

      $('#node-input-useAuthentication').on( 'change', function() {
        if ( $('#node-input-useAuthentication').is(":checked") ) {
          $('#useAuthentication-input-fields').show();
        } else {
          $('#useAuthentication-input-fields').hide()
        }
      });
    },
  });
</script>

<script type="text/html" data-template-name="SendFlow">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>

    <div class="form-row">
        <label for="node-input-hostUrl"><i class="fa fa-tag"></i> Host</label>
        <input type="text" id="node-input-hostUrl" placeholder="Host URL">
    </div>

    <div class="form-row">
      <label for="node-input-flowVersion">
        <i class="fa fa-tag"></i>
        <span>Flow Version</span>
      </label>

      <select id="node-input-flowVersion">
        <option value="v1" selected=selected>Version 1</option>
        <option value="v2">Version 2</option>
      </select>
    </div>

    <div class="form-row">
      <label for="node-input-useAuthentication">
        <i class="fa "></i>
        <span>Use Authentication?</span>
      </label>

      <input type="checkbox" id="node-input-useAuthentication"
             style="display:inline-block; width:15px; vertical-align:baseline;">
    </div>

    <div id="useAuthentication-input-fields" class="hidden">
      <div class="form-row">
        <label for="node-input-apiUsername">
          <i class="fa fa-tag"></i>
          Username
        </label>
        <input type="text" id="node-input-apiUsername">
        <input type="hidden" id="node-input-apiUsernameType">
      </div>

      <div class="form-row">
        <label for="node-input-apiPassword">
          <i class="fa fa-tag"></i>
          Password
        </label>
        <input type="text" id="node-input-apiPassword">
        <input type="hidden" id="node-input-apiPasswordType">
      </div>
    </div>
</script>


<script type="text/html" data-help-name="SendFlow">
  <p>Send flow to another Node-RED instance.</p>
</script>
<!-- --- [red-module:@gregoriusrippenstein/node-red-contrib-introspection/clientcode] --- -->
<script type="text/javascript">

 RED.comms.subscribe('introspect:client-code-perform', (event,data) => {
   if ( data.msg == "execfunc" ) {

     var doSend = (data, nodeid, _msg) => {
       if ( typeof data == "object" ) {
         data = {
           ..._msg,
           ...data
         };
       }

       $.ajax({
         url:         "ClientCode/" + nodeid,
         type:        "POST",
         contentType: "application/json; charset=utf-8",
         data:        JSON.stringify(data),

         success: function (resp) {
         },

         error: function (jqXHR, textStatus, errorThrown) {
           RED.notify("ClientCode Communcation Failure: " +
                      nodeid + ": " + textStatus, {
             type: "error",
             id: nodeid,
             timeout: 3000
           });
         }
       });
     };

    var doStatus = (sts, nodeid, _msg) => {
       $.ajax({
         url:         "ClientCode/" + nodeid + "/status",
         type:        "POST",
         contentType: "application/json; charset=utf-8",
         data:        JSON.stringify(sts),

         success: function (resp) {
         },

         error: function (jqXHR, textStatus, errorThrown) {
           RED.notify("ClientCode Communcation Failure: " +
                      nodeid + ": " + textStatus, {
             type: "error",
             id: nodeid,
             timeout: 3000
           });
         }
       });
     }

     var doError = (msg, nodeid, _msg) => {
       RED.notify("ClientCode Failed: " + nodeid + ": " + msg, {
         type: "error",
         id: nodeid,
         timeout: 3000
       });

       console.log( "ClientCode: Error with node: " + nodeid + ": " + msg);
     };

     var nodeid = data.nodeid;
     var _msg = data._msg;
     var msg = data._msg;

     var node = {
       id:     data.nodeid,
       send:   (dt)  => { doSend(dt, nodeid, _msg)     },
       error:  (mg)  => { doError(mg, nodeid, _msg)    },
       status: (sts) => { doStatus(sts, nodeid, _msg)  }
     };

     var payload = data.payload;
     var topic = data.topic;

     eval( data.func );
   }
 });

  RED.nodes.registerType('ClientCode',{
    color: '#e5e4ef',
    icon: "introspesubflow.svg",
    category: 'introspection',
    paletteLabel: "ClientCode",
    defaults: {
      name: {
        value:"",
      },
      clientcode: {
        value: ""
      },
      format: {
        value: "javascript"
      }
    },
    inputs:1,
    outputs:1,

    label: function() {
      return (this.name || this._def.paletteLabel);
    },

    labelStyle: function() {
      return this.name?"node_label_italic":"";
    },

    oneditsave: function() {
      $('#node-input-clientcode').val(this.editor.getValue());
      this.editor.destroy();
      delete this.editor;
    },

    oneditcancel: function() {
      this.editor.destroy();
      delete this.editor;
    },

    oneditprepare: function() {
      const that = this;
      const stateId = RED.editor.generateViewStateId("node", this, "");

      this.editor = RED.editor.createEditor({
        id: 'node-input-clientcode-editor',
        mode: 'ace/mode/nrjavascript',
        stateId: stateId,
        globals: {
          msg:true,          
          RED: true,
          node: true,
          console: true,
          Buffer: true,
          setTimeout: true,
          clearTimeout: true,
          setInterval: true,
          clearInterval: true
        },
        value: $("#node-input-clientcode").val()
      });

      $("#node-input-format").on("change", function() {
        var mod = "ace/mode/"+$("#node-input-format").val();
        that.editor.getSession().setMode({
          path: mod,
          v: Date.now()
        });
      });

      RED.popover.tooltip($("#node-clientcode-expand-editor"), RED._("node-red:common.label.expand"));
      $("#node-clientcode-expand-editor").on("click", function (e) {
        e.preventDefault();
        const value = that.editor.getValue();
        that.editor.saveView();
        RED.editor.editText({
          mode: $("#node-input-format").val(),
          value: value,
          stateId: stateId,
          width: "Infinity",
          focus: true,
          complete: function (v, cursor) {
            that.editor.setValue(v, -1);
            setTimeout(function () {
              that.editor.restoreView();
              that.editor.focus();
            }, 250);
          }
        })
      })

    },

    oneditresize: function(size) {
      var rows = $("#dialog-form>div:not(.node-text-editor-row)");
      var height = $("#dialog-form").height();
      for (var i=0; i<rows.length; i++) {
        height -= $(rows[i]).outerHeight(true);
      }
      var editorRow = $("#dialog-form>div.node-text-editor-row");
      height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));
      $(".node-text-editor").css("height",height+"px");
      this.editor.resize();
    }
  });
</script>

<script type="text/html" data-template-name="ClientCode">
  <div class="form-row">
      <label for="node-input-name">
          <i class="fa fa-tag"></i>
          <span data-i18n="common.label.name">Name</span>
      </label>
      <input type="text" id="node-input-name" placeholder="Name">
  </div>

  <div class="form-row" style="position: relative; margin-bottom: 0px;">
      <label for="node-input-clientcode">
          <i class="fa fa-file-code-o"></i> Client Code
      </label>

      <div style="position: absolute; right:0;display:inline-block; text-align: right; font-size: 0.8em;">
          Syntax:
          <select id="node-input-format" style="width:110px; font-size: 10px !important;  height: 24px; padding:0;">
              <option value="handlebars">mustache</option>
              <option value="html">HTML</option>
              <option value="json">JSON</option>
              <option value="javascript">JavaScript</option>
              <option value="css">CSS</option>
              <option value="markdown">Markdown</option>
              <option value="php">PHP</option>
              <option value="python">Python</option>
              <option value="sql">SQL</option>
              <option value="yaml">YAML</option>
              <option value="text">None</option>
          </select>
          <button type="button" id="node-clientcode-expand-editor"
                  class="red-ui-button red-ui-button-small">
              <i class="fa fa-expand"></i>
          </button>
      </div>
  </div>

  <div class="form-row node-text-editor-row">
      <div style="height: 250px; min-height:150px;"
           class="node-text-editor"
           id="node-input-clientcode-editor" ></div>
  </div>

  <input type="hidden" id="node-input-clientcode" autofocus="autofocus">
</script>


<script type="text/html" data-help-name="ClientCode">
  <p>Execute Javascript code in the Node-RED frontend, triggered from the server.</p>
  
  The code is executed in the users browser and has the following enviornment defined:
  <pre>
  <code>
Variables:
  nodeid - id of this node
  _msg - a reference to the msg object passed to this node
  msg - alias for _msg
  node.id - id of this node, same as `nodeid` above
  payload - a reference to msg.payload as it was received by this node
  topic - a reference to the msg.topic as it was recieved by this node

Functionality:
  node.send({..}) - send data to the output port of this node
  node.error("msg") - generate an error for the node
  node.status( { fill: 'red', shape: 'dot', text: 'hello world'}) - generate a status for the node.
    </code>
   </pre>

    <p>
    This might be confusing since the code in the node <b>is not</b> 
    executed on the Node-RED server, rather it is executed in the client
    browser.
    <p>
    This of course makes no sense for flows that are executed "head less"
    on the server in the backgrond on some dark and stormy night. The ClientCode
    node is intended for immediate, frontend-only use.
    <p>
    An example flow with some use cases is included and can be accessed either via 
    the Import Flow dialog or accessed online <a style="color: blue" href="https://flowhub.org/f/e02ba6e534f7a0f4" target="_blank">at here <i class="fa fa-external-link"></i></a>.
</script>
<!-- --- [red-module:@gregoriusrippenstein/node-red-contrib-nodedev/nodedevops] --- -->
<script type="text/javascript">
  (function(){
  
    function sendToBackend(node,data = {}) {

      $.ajax({
        url:         "NodeDevOps/" + node.id,
        type:        "POST",
        contentType: "application/json; charset=utf-8",

        data: JSON.stringify(data),

        success: function (resp) {
          RED.notify("Node Developer Operation trigger", {
            type: "success",
            id: "NodeDevOps",
            timeout: 2000
          });
        },

        error: function (jqXHR, textStatus, errorThrown) {
          if (jqXHR.status == 404) {
            RED.notify("Node has not yet been deployed, please deploy.", "error");
          } else if (jqXHR.status == 405) {
            RED.notify("Not Allowed.", "error");
          } else if (jqXHR.status == 500) {
            RED.notify(node._("common.notification.error", {
              message: node._("inject.errors.failed")
            }), "error");
          } else if (jqXHR.status == 0) {
            RED.notify(node._("common.notification.error", {
              message: node._("common.notification.errors.no-response")
            }), "error");
          } else {
            RED.notify(node._("common.notification.error", {
              message: node._("common.notification.errors.unexpected", {
                status: jqXHR.status, message: textStatus }) }), "error");
          }
        }
      });
    }
  
  RED.nodes.registerType('NodeDevOps',{
    color: '#e5e4ef',
    icon: "font-awesome/fa-terminal",
    category: 'nodedev',
    defaults: {
      name: { value:"" },

      pname:        { value: "", required: true },
      pversion:     { value: "", required: true },
      pauthorname:  { value: "", required: true },
      pauthoremail: { value: "", required: true },
      pdescription: { value: "", required: true },

      noderedinstall: { value: false },
      randompackagename: { value: false },

      ignore_package_check: { value: false },

      gitcommit:         { value: false },
      gitcheckforchange: { value: false },
      githubowner:       { value: ""},
      githubrepo:        { value: ""},
      githubbranch:      { value: "main"},
      githubauthor:      { value: ""},
      githubauthoremail: { value: "" },
      githubmessage:     { value: "" },

      npmpublish: { value: false },
      npmunpublish: { value: false },
      npmotp: { value: ""},
    },

    inputs: 0,
    outputs: 1,

    label: function() {
      return (this.name || this._def.paletteLabel);
    },

    labelStyle: function() {
      return this.name?"node_label_italic":"";
    },

    onpaletteadd: function() {
    },

    oneditprepare: function() {

     $('#node-input-noderedinstall').on('change', () => {
          if ( $('#node-input-noderedinstall').is(":checked") ) {
              $("#noderedinstall-options").animate({opacity: 'show', height: 'show'}, 450);
          } else {
              $("#noderedinstall-options").animate({opacity: 'hide', height: 'hide'}, 450);
          }
     });

     $('#node-input-gitcommit').on('change', () => {
          if ( $('#node-input-gitcommit').is(":checked") ) {
              $("#github-options").animate({opacity: 'show', height: 'show'}, 450);
              $("#gitcommit-options").animate({opacity: 'show', height: 'show'}, 450);
              $('#node-input-gitcheckforchange').prop('checked',false)
          } else {
              $("#gitcommit-options").animate({opacity: 'hide', height: 'hide'}, 450);
              if ( !$('#node-input-gitcheckforchange').is(":checked") ) {
                $("#github-options").animate({opacity: 'hide', height: 'hide'}, 450);
              }
          }
     });

     $('#node-input-gitcheckforchange').on('change', () => {
          if ( $('#node-input-gitcheckforchange').is(":checked") ) {
              $("#github-options").animate({opacity: 'show', height: 'show'}, 450);
              $("#gitcommit-options").animate({opacity: 'hide', height: 'hide'}, 450);
              $('#node-input-gitcommit').prop('checked',false)
          } else {
            if ( !$('#node-input-gitcommit').is(":checked") ) {
              $("#github-options").animate({opacity: 'hide', height: 'hide'}, 450);
              $("#gitcommit-options").animate({opacity: 'hide', height: 'hide'}, 450);
            }
          }
     });

     $('#node-input-npmpublish').on('change', () => {
          if ( $('#node-input-npmpublish').is(":checked") ) {
              $("#npmpublish-options").animate({opacity: 'show', height: 'show'}, 450);
              $('#node-input-npmunpublish').prop('checked',false)
          } else {
            if ( !$('#node-input-npmunpublish').is(":checked") ) {
              $("#npmpublish-options").animate({opacity: 'hide', height: 'hide'}, 450);
            }
          }
     });

     $('#node-input-npmunpublish').on('change', () => {
          if ( $('#node-input-npmunpublish').is(":checked") ) {
              $("#npmpublish-options").animate({opacity: 'show', height: 'show'}, 450);
              $('#node-input-npmpublish').prop('checked',false)
          } else {
            if ( !$('#node-input-npmpublish').is(":checked") ) {
              $("#npmpublish-options").animate({opacity: 'hide', height: 'hide'}, 450);
            }
          }
     });

    },

    oneditcancel: function() {
    },

    oneditsave: function() {
    },

    onpaletteremove: function() {
    },


    button: {
      enabled: function() {
        return !this.changed
      },

      onclick: function () {
        if (this.changed) {
          return RED.notify(RED._("notification.warning", {
            message: RED._("notification.warnings.undeployedChanges")
          }), "warning");
        }

        var that = this;
        var data = {}

        Object.keys(that._def.defaults).forEach( kname => {
          data[kname] = that[kname]
        })
        
        sendToBackend(that, data)
      }
    },

  });
})();
</script>

<script type="text/html" data-template-name="NodeDevOps">
  <div class="form-row">
    <label for="node-input-name" style="min-width: 170px;"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name"/>
  </div>

  <hr/>
  
  <div class="form-row">
    <label for="node-input-pname" style="min-width: 150px;">Package Details:</label>
  </div>

  <div class="form-row">
    <label for="node-input-pname" style="min-width: 150px;"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-pname" placeholder="@username/node-red-contrib-somename"/>
  </div>

  <div class="form-row">
    <label for="node-input-pversion" style="min-width: 150px;"><i class="fa fa-tag"></i> Version</label>
    <input type="text" id="node-input-pversion" placeholder="0.0.1"/>
  </div>
  
  <div class="form-row">
    <label for="node-input-pauthorname" style="min-width: 150px;"><i class="fa fa-address-book-o"></i> Author Name</label>
    <input type="text" id="node-input-pauthorname" placeholder="Alfred E. Neumann"/>
  </div>

  <div class="form-row">
    <label for="node-input-pauthoremail" style="min-width: 150px;"><i class="fa fa-envelope-o"></i> Author Email</label>
    <input type="text" id="node-input-pauthoremail" placeholder="joe.blog@example.com"/>
  </div>

  <div class="form-row">
    <label for="node-input-pdescription" style="min-width: 150px;"><i class="fa fa-book"></i> Description</label>
    <input type="text" id="node-input-pdescription" placeholder="Package description"/>
  </div>

  <div class="form-row">
    <label for="node-input-ignore_package_check" style="min-width: 150px;"">
      <span>No package check?</span>
    </label>
    <input type="checkbox" id="node-input-ignore_package_check" style="display:inline-block; width:15px; vertical-align:baseline;">
  </div>

  <hr/>

  <div class="form-row">
    <label for="node-input-noderedinstall" style="min-width: 120px;">
              <span>Install locally?</span>
          </label>
    <input type="checkbox" id="node-input-noderedinstall" style="display:inline-block; width:15px; vertical-align:baseline;">
  </div>
  
  <div id="noderedinstall-options">
    <div class="form-row">
      <label for="node-input-randompackagename" style="min-width: 180px;">
                <span>Randomise Package Version?</span>
            </label>
      <input type="checkbox" id="node-input-randompackagename" style="margin-left: 10px; display:inline-block; width:15px; vertical-align:baseline;">
    </div>
  </div>

  <hr/>
  <div class="form-row">
    <label for="node-input-npmpublish" style="min-width: 120px;">
         <span>NPMjs: Publish</span>
    </label>
    <input type="checkbox" id="node-input-npmpublish" style="display:inline-block; width:15px; vertical-align:baseline;">
    <label for="node-input-npmunpublish" style="margin-left: 30px; min-width: 100px;">
           <span>Unpublish</span>
    </label>
    <input type="checkbox" id="node-input-npmunpublish" style="display:inline-block; width:15px; vertical-align:baseline;">
  </div>

  <div id="npmpublish-options">
    <div class="form-row">
      <label for="node-input-npmotp" style="min-width: 150px;"><i class="fa fa-tag"></i> One Time Password</label>
      <input type="text" id="node-input-npmotp" placeholder="111999"/>
    </div>
  </div>

  <hr />
  <div class="form-row">
      <label for="node-input-gitcommit" style="min-width: 120px;">
               <span>GitHub: Commit?</span>
      </label>
    <input type="checkbox" id="node-input-gitcommit" style="display:inline-block; width:15px; vertical-align:baseline;">
    <label for="node-input-gitcheckforchange" style="margin-left: 30px; min-width: 100px;">
                <span>What changed?</span>
     </label>
     <input type="checkbox" id="node-input-gitcheckforchange" style="display:inline-block; width:15px; vertical-align:baseline;">
  </div>


  <div id="github-options">
    <div class="form-row">
      <label for="node-input-githubowner" style="min-width: 150px;"><i class="fa fa-user-o"></i> GitHub Username</label>
      <input type="text" id="node-input-githubowner" placeholder="username"/>
    </div>
    <div class="form-row">
       <label for="node-input-githubrepo" style="min-width: 150px;"><i class="fa fa-paw"></i> Repository</label>
       <input type="text" id="node-input-githubrepo" placeholder=""/>
    </div>
    <div class="form-row">
       <label for="node-input-githubbranch" style="min-width: 150px;"><i class="fa fa-tree"></i> Branch</label>
       <input type="text" id="node-input-githubbranch" placeholder="main"/>
    </div>
  </div>

  <div id="gitcommit-options">
    <div class="form-row">
      <label for="node-input-githubmessage" style="min-width: 150px;"><i class="fa fa-tag"></i> Commit Message</label>
      <input type="text" id="node-input-githubmessage" placeholder="Initial Commit"/>
    </div>
    <div class="form-row">
      <label for="node-input-githubauthor" style="min-width: 150px;"><i class="fa fa-address-book-o"></i> Author Name</label>
      <input type="text" id="node-input-githubauthor" placeholder="Joe Blog"/>
    </div>
    <div class="form-row">
      <label for="node-input-githubauthoremail" style="min-width: 150px;"><i class="fa fa-envelope-o"></i> Author Email</label>
      <input type="text" id="node-input-githubauthoremail" placeholder="joe@spreads-the.love"/>
    </div>
  </div>
</script>

<script type="text/html" data-help-name="NodeDevOps">
  <p>NodeDevOps is the operations node that controals what happens with the package.</p>
  Possible actions that can happen are GitHub commits and diffs, NPM publish or unpublish and installing the package
  locally for local testing.

  Local installations can be uninstalled so that changes can tested and modified quickly.
</script>
<!-- --- [red-module:@gregoriusrippenstein/node-red-contrib-nodedev/nodefactory] --- -->
<script type="text/html" data-template-name="NodeFactory">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <div style="display: inline-block; width: calc(100% - 105px)"><input type="text" id="node-input-name" placeholder="Name"></div>
    </div>

    <div class="form-row">
        <label for="node-input-nodename"><i class="fa fa-tag"></i> Node Name</label>
        <div style="display: inline-block; width: calc(100% - 105px)"><input type="text" id="node-input-nodename" placeholder="Node Name">
        </div>
    </div> 

    <div class="form-row">
        <label for="node-input-category"><i class="fa fa-tag"></i> Node Category</label>
        <div style="display: inline-block; width: calc(100% - 105px)"><input type="text" id="node-input-category" placeholder="Node Category">
        </div>
    </div>

    <div id="node-input-row-style-colour" class="form-row">
        <label>Color</label>
     </div>

    <div id="node-input-row-icon-picker" class="form-row">
    </div>

    <div class="form-row">
        <label for="node-input-hasbutton">
            <span>Has button?</span>
        </label>
        <input type="checkbox" id="node-input-hasbutton" style="display:inline-block; width:15px; vertical-align:baseline;">

        <label for="node-input-minify">
            <span>Minify by default?</span>
        </label>
        <input type="checkbox" id="node-input-minify" style="margin-left: 10px; display:inline-block; width:15px; vertical-align:baseline;">
    </div>

    <div class="form-row">
        <label for="node-input-hasinput">
            <span>Has input port?</span>
        </label>
        <input type="checkbox" id="node-input-hasinput" style="display:inline-block; width:15px; vertical-align:baseline;">
    </div>

    <div class="form-row">
        <label for="node-input-outputcount">
            <i class="fa fa-tag"></i> Output ports
          </label>
        <select id="node-input-outputcount"></select>
    </div>

    <div class="form-row">
        <label for="node-input-summary">
          <i class="fa fa-tag"></i>
          <span>Summary (REQUIRED)</span>
        </label>
        <div style="height: 150px; min-height:150px; max-height: 150px;" class="node-text-editor" id="node-input-summary">
        </div>
    </div>

    <div class="form-row">
        <label for="node-input-description">
              <i class="fa fa-tag"></i>
              <span>Description (REQUIRED)</span>
            </label>
        <div style="height: 350px; min-height:350px; max-height: 350px;" class="node-text-editor" id="node-input-description">
        </div>
    </div>

    <div class="form-row">
        <label for="node-input-isplugin" style="min-width: 250px;">
                    <span>Plugin: Sidebar + Config?</span>
                </label>
        <input type="checkbox" id="node-input-isplugin" style="display:inline-block; width:15px; vertical-align:baseline;">
    </div>
    
    <div class="form-row">
        <label for="node-input-frt2bakcomm" style="min-width: 250px;">
                <span>Frontend to Backend communication?</span>
            </label>
        <input type="checkbox" id="node-input-frt2bakcomm" style="display:inline-block; width:15px; vertical-align:baseline;">
    </div>

    <div class="form-row">
        <label for="node-input-bak2frtcomm" style="min-width: 250px;">
                <span>Backend to Frontend communication?</span>
            </label>
        <input type="checkbox" id="node-input-bak2frtcomm" style="display:inline-block; width:15px; vertical-align:baseline;">
    </div>

    <div class="form-row">
        <label for="node-input-createmanifest" style="min-width: 250px;">
                <span>Create manifest?</span>
            </label>
        <input type="checkbox" id="node-input-createmanifest" style="display:inline-block; width:15px; vertical-align:baseline;">
    </div>

    <div class="form-row">
        <button id="node-input-generate-tmplnodes-but"
                     class="red-ui-button">Generate Template Nodes</button>
    </div>

</script>



<script type="text/javascript">
(function () {

    RED.comms.subscribe("nodedev:perform-autoimport-nodes", (event,data) => {
        if ( data.msg == "notify") {
            RED.notify(data.text, {
                type:    data.type,
                id:      data.id || "NodeFactory",
                timeout: data.timeout || 2000
            });
        }

        if ( data.msg == "autoimport" ) {
            setTimeout(() => {
                RED.clipboard.import();
            
                setTimeout(() => {
                    $('#red-ui-clipboard-dialog-import-text').val(
                    data.payload
                    ).trigger("paste");
                }, 300);
            },400)
        }
    });

    function postDataOff(node,data) {
        $.ajax({
            url: "NodeFactory/" + node.id,
            type: "POST",
            contentType: "application/json; charset=utf-8",

            data: JSON.stringify({
                node: data,
            }),

            success: function (resp) {
                $('#node-dialog-ok').trigger('click');

                RED.notify("Preparing Node...", {
                    type: "warning",
                    timeout: 2000
                });
            },

            error: function (jqXHR, textStatus, errorThrown) {
                if (jqXHR.status == 404) {
                    RED.notify("Node has not yet been deployed, please deploy.", "error");
                } else if (jqXHR.status == 405) {
                    RED.notify("Not Allowed.", "error");
                } else if (jqXHR.status == 500) {
                    RED.notify(node._("common.notification.error", {
                        message: node._("inject.errors.failed")
                    }), "error");
                } else if (jqXHR.status == 0) {
                    RED.notify(node._("common.notification.error", {
                        message: node._("common.notification.errors.no-response")
                    }), "error");
                } else {
                    RED.notify(node._("common.notification.error", {
                        message: node._("common.notification.errors.unexpected", {
                            status: jqXHR.status, message: textStatus
                        })
                    }), "error");
                }
            }
        });
    }

    function doSubmission(node) {
        let data = {};

        /* the data has not been stored on the node when this is called, 
            need to retrieve everything from the various fields...
        */
        data["summary"]     = node.editorSummary.getValue();
        data["description"] = node.editorDesc.getValue();
        
        data["color"]       = $('#node-input-colour').val();
        data["icon"]        = $('#red-ui-editor-node-icon').val();
        data["iconclass"]   = "fa " + data["icon"].split("/")[1]; /* Assume font-awesomeness */
        data["name"]        = $('#node-input-nodename').val();
        data["namelwr"]     = data["name"].toLowerCase();
        data["outputcount"] = $('#node-input-outputcount').val();
        data["category"]    = $('#node-input-category').val();

        data["hasbutton"]      = $('#node-input-hasbutton').is(":checked");
        data["minify"]         = $('#node-input-minify').is(":checked");
        data["hasinput"]       = $('#node-input-hasinput').is(":checked");
        data["bak2frtcomm"]    = $('#node-input-bak2frtcomm').is(":checked");
        data["frt2bakcomm"]    = $('#node-input-frt2bakcomm').is(":checked");
        data["createmanifest"] = $('#node-input-createmanifest').is(":checked");
        data["isplugin"]       = $('#node-input-isplugin').is(":checked");

        data["__task"]      = "generate_from_templates";

        postDataOff(node,data)        
    }

    function doButtonSubmission(node) {
        let data = {}

        Object.keys(node._def.defaults).forEach( attrname => {
            data[attrname] = node[attrname]
        })

        data["name"]      = node.nodename; // name clashes with the default 'name' attribute
        data["namelwr"]   = data["name"].toLowerCase();
        data["iconclass"] = "fa " + data["icon"].split("/")[1]; /* Assume font-awesomeness */
        data["__task"]    = "generate_from_templates";
        
        postDataOff(node,data)
    }

    RED.nodes.registerType('NodeFactory', {
        color: "#e5e4ef",
        category: 'nodedev',
        defaults: {
            name:           { value: "" },
            nodename:       { value: "", required: true },
            color:          { value: "#e5e4ef" },
            hasbutton:      { value: false },
            minify:         { value: false },
            hasinput:       { value: true },
            outputcount:    { value: 1 },
            category:       { value: "" },
            summary:        { value: "", required: true },
            description:    { value: "", required: true },
            icon:           { value: "font-awesome/fa-industry" },
            frt2bakcomm:    { value: false },
            bak2frtcomm:    { value: false },
            createmanifest: { value: false },
            isplugin:       { value: false },
        },
        inputs: 1,
        outputs: 1,
        icon: "font-awesome/fa-industry",
        label: function () {
            return this.name || this._def.paletteLabel;
        },
        labelStyle: function () {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function () {
            const that = this;
            const stateId = RED.editor.generateViewStateId("node", this, "");

            var sltObj = $('#node-input-outputcount');
            sltObj.html("");
            
            [0,1,2,3,4,5,6,7,8,9,10].forEach( function(v) {
                sltObj.append($('<option></option>').val(v).html(v));
            });
            
            sltObj.val(this.outputcount || "1");

            $('#node-input-generate-tmplnodes-but').on('click', (e) => {
                e.preventDefault()
                doSubmission(that)
            });

            var colorPalette = [
                "#DDAA99",
                "#3FADB5", "#87A980", "#A6BBCF",
                "#AAAA66", "#C0C0C0", "#C0DEED",
                "#C7E9C0", "#D7D7A0", "#D8BFD8",
                "#DAC4B4", "#DEB887", "#DEBD5C",
                "#E2D96E", "#E6E0F8", "#E7E7AE",
                "#E9967A", "#F3B567", "#FDD0A2",
                "#FDF0C2", "#FFAAAA", "#FFCC66",
                "#FFF0F0", "#FFFFFF"
            ];

            RED.editor.colorPicker.create({
                id: "node-input-colour",
                value: this.color || "#a4a4a4",
                defaultValue: "#a4a4a4",
                palette: colorPalette,
                cellWidth: 16,
                cellHeight: 16,
                cellMargin: 3,
                none: false,
                opacity: 1.0,
                sortPalette: function (a, b) { return a.l - b.l; }
            }).appendTo("#node-input-row-style-colour");

            $("#node-input-colour").on('change', function(ev) {
                var colour = $(this).val();
                var nodeDiv = $('.red-ui-search-result-node')
                nodeDiv.css('backgroundColor',colour);
                var borderColor = RED.utils.getDarkerColor(colour);
                if (borderColor !== colour) {
                        nodeDiv.css('border-color',borderColor);
                }
            });

            this.editorSummary = RED.editor.createEditor({
               id: 'node-input-summary',
               mode: 'ace/mode/markdown',
               value: $("#node-input-summary").val()
            });

            this.editorDesc = RED.editor.createEditor({
                id: 'node-input-description',
                mode: 'ace/mode/markdown',
                value: $("#node-input-description").val()
            });

            var node = this;
            var iconRow = $('#node-input-row-icon-picker');
            $('<label data-i18n="editor.settingIcon">').appendTo(iconRow);

            var iconButton = $('<button type="button" class="red-ui-button red-ui-editor-node-appearance-button">').appendTo(iconRow);
            $('<i class="fa fa-caret-down"></i>').appendTo(iconButton);
            var nodeDiv = $('<div>',{class:"red-ui-search-result-node"}).appendTo(iconButton);
            var colour = this.color || RED.utils.getNodeColor(node.type, node._def);
            var icon_url = RED.utils.getNodeIcon(node._def,node);
            nodeDiv.css('backgroundColor',colour);
            var borderColor = RED.utils.getDarkerColor(colour);
            if (borderColor !== colour) {
                nodeDiv.css('border-color',borderColor);
            }

            var iconContainer = $('<div/>',{class:"red-ui-palette-icon-container"}).appendTo(nodeDiv);
            RED.utils.createIconElement(icon_url, iconContainer, true);

            iconButton.on("click", function(e) {
                e.preventDefault();
                var iconPath;
                var icon = $("#red-ui-editor-node-icon").val()||"";
                if (icon) {
                    iconPath = RED.utils.separateIconPath(icon);
                } else {
                    iconPath = RED.utils.getDefaultNodeIcon(node._def, node);
                }
                var backgroundColor = RED.utils.getNodeColor(node.type, node._def);
                if (node.type === "subflow") {
                    backgroundColor = $("#red-ui-editor-node-color").val();
                }
                RED.editor.iconPicker.show(iconButton,backgroundColor,iconPath,false,function(newIcon) {
                    $("#red-ui-editor-node-icon").val(newIcon||"");
                    var icon_url = RED.utils.getNodeIcon(node._def,{type:node.type,icon:newIcon});
                    RED.utils.createIconElement(icon_url, iconContainer, true);
                });
            });

            RED.popover.tooltip(iconButton, function() {
                return $("#red-ui-editor-node-icon").val() || RED._("editor.default");
            });
            $('<input type="hidden" id="red-ui-editor-node-icon">').val(node.icon).appendTo(iconRow);
        },
        
        oneditsave: function () {
            this.color = $('#node-input-colour').val();
            $("#node-input-summary").val(this.editorSummary.getValue());
            $("#node-input-description").val(this.editorDesc.getValue());
            this.icon = $('#red-ui-editor-node-icon').val();

            this.editorSummary.destroy();
            this.editorDesc.destroy();
            delete this.editorSummary;
            delete this.editorDesc;
        },

        oneditcancel: function () {
            this.editorSummary.destroy();
            this.editorDesc.destroy();
            delete this.editorSummary;
            delete this.editorDesc;
        },

        onpaletteremove: function() {
        },

        oneditresize: function (size) {
        },

        button: {
            enabled: function() {
                return !this.changed
            },

            onclick: function () {
                if (this.changed) {
                    return RED.notify(RED._("notification.warning", {
                        message: RED._("notification.warnings.undeployedChanges")
                    }), "warning");
                }

                doButtonSubmission(this)
            }
        },
    });
})();

</script><script type="text/html" data-help-name="NodeFactory">
    <p>Generate node templates providing starting points for node development</p>
    The Node-Factory can be used to create example code for various types of Node-RED nodes.
</script>
<!-- --- [red-module:@gregoriusrippenstein/node-red-contrib-nodedev/pkgfile] --- -->
<script type="text/html" data-template-name="PkgFile">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <div style="display: inline-block; width: calc(100% - 105px)"><input type="text" id="node-input-name" placeholder="Name"></div>
    </div>

    <div class="form-row">
        <label for="node-input-filename"><i class="fa fa-tag"></i> Filename</label>
        <div style="display: inline-block; width: calc(100% - 105px)"><input type="text" id="node-input-filename" placeholder="dir1/dir2/file.txt"></div>
    </div>

    <div class="form-row" style="position: relative; margin-bottom: 0px;">
        <label for="node-input-template"><i class="fa fa-file-code-o"></i> Template</span></label>
        <input type="hidden" id="node-input-template" autofocus="autofocus">
        <div style="position: absolute; right:0;display:inline-block; text-align: right; font-size: 0.8em;">
            Syntax:
            <select id="node-input-format" style="width:110px; font-size: 10px !important;  height: 24px; padding:0;">
                <option value="handlebars">mustache</option>
                <option value="html">HTML</option>
                <option value="json">JSON</option>
                <option value="javascript">JavaScript</option>
                <option value="css">CSS</option>
                <option value="markdown">Markdown</option>
                <option value="php">PHP</option>
                <option value="python">Python</option>
                <option value="sql">SQL</option>
                <option value="yaml">YAML</option>
                <option value="xml">XML</option>
                <option value="base64">Base64</option>
                <option value="text">Text</option>
                <option value="typescript">TypeScript</option>
            </select>
            <button type="button" id="node-pkgfile-expand-editor" class="red-ui-button red-ui-button-small"><i class="fa fa-expand"></i></button>
        </div>
    </div>

    <div class="form-row node-text-editor-row">
        <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-pkgfile-editor" ></div>
    </div>
    
    <div class="form-row">
        <label for="node-input-syntax"><i class="fa fa-code"></i> Syntax</label>
        <select id="node-input-syntax" style="width:180px;">
            <option value="mustache">Mustache</option>
            <option value="plain">Plain</option>
        </select>
    </div>

</script>

<script type="text/javascript">
(function(){

    var returnInfo = (that) => {
        const escapeHTML = str =>
            str.replace(
                /[&<>'"]/g,
                tag =>
                ({
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    "'": '&#39;',
                    '"': '&quot;'
                }[tag] || tag)
            );

        let mth;
        
        switch(that.format) {
            case 'markdown':
            case 'text':
                return that.template
                
            case "json":
            case "yaml":
            case "javascript":
            case "css":
            case "sql":
                return ["```" + that.format, that.template, "```"].join("\n")

            case "php":
            case "python":
            case "html":
                return ["```" + that.format, escapeHTML(that.template), "```"].join("\n")
                
            case "xml":
                mth = (that.filename || "").match(/[.](svg)$/i)
                if ( mth ) {
                    return "<img src=\"data:image/svg+xml;base64," + btoa(that.template) + "\"/>"
                }
                break;

            case "base64":
                mth = (that.filename || "").match(/[.](png|jpg|jpeg|tiff|tif|gif|ico)$/i)
                if ( mth ) {
                    return "<img src=\"data:image/" + mth[1].toLowerCase() + ";base64," + that.template + "\"/>"
                }
                break;
        }
        
        return ""
    };

    RED.nodes.registerType('PkgFile',{
        color:"#e5e4ef",
        category: 'nodedev',
        defaults: {
            name: {value:""},
            filename: { value: ""},
            format: {value:"handlebars"},
            syntax: {value:"mustache"},
            template: {value:""},
            output: {value:"str"},
        },

        inputs:1,
        outputs:1,
        icon: "font-awesome/fa-file-o",
        info: function() { return returnInfo(this) },

        label: function() {
            return this.name || this.filename || this._def.paletteLabel;
        },

        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },

        oneditprepare: function() {
            const that = this;
            const stateId = RED.editor.generateViewStateId("node", this, "");

            if (!this.syntax) {
                this.syntax = 'mustache';
                $("#node-input-syntax").val(this.syntax);
            }

            this.editor = RED.editor.createEditor({
                id: 'node-input-pkgfile-editor',
                mode: 'ace/mode/html',
                stateId: stateId,
                value: $("#node-input-template").val()
            });

            $("#node-input-format").on("change", function() {
                var mod = "ace/mode/"+$("#node-input-format").val();
                that.editor.getSession().setMode({
                    path: mod,
                    v: Date.now()
                });
            });
            RED.popover.tooltip($("#node-pkgfile-expand-editor"), RED._("node-red:common.label.expand"));
            $("#node-pkgfile-expand-editor").on("click", function (e) {
                e.preventDefault();
                const value = that.editor.getValue();
                that.editor.saveView();
                RED.editor.editText({
                    mode: $("#node-input-format").val(),
                    value: value,
                    stateId: stateId,
                    width: "Infinity",
                    focus: true,
                    complete: function (v, cursor) {
                        that.editor.setValue(v, -1);
                        setTimeout(function () {
                            that.editor.restoreView();
                            that.editor.focus();
                        }, 250);
                    }
                })
            })
        },
        oneditsave: function() {
            $("#node-input-template").val(this.editor.getValue());
            this.editor.destroy();
            delete this.editor;
        },
        oneditcancel: function() {
            this.editor.destroy();
            delete this.editor;
        },
        oneditresize: function(size) {
            var rows = $("#dialog-form>div:not(.node-text-editor-row)");
            var height = $("#dialog-form").height();
            for (var i=0; i<rows.length; i++) {
                height -= $(rows[i]).outerHeight(true);
            }
            var editorRow = $("#dialog-form>div.node-text-editor-row");
            height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));
            $("#dialog-form .node-text-editor").css("height",height+"px");
            this.editor.resize();
        }
    });
})();
</script>
<!-- --- [red-module:@gregoriusrippenstein/node-red-contrib-nodedev/npmtarball] --- -->
<script type="text/javascript">
    RED.nodes.registerType('NpmTarBall', {
        category: 'nodedev',
        color: "#e5e4ef",
        defaults: {
            name: {
                value: ""
            }
        },
        inputs: 1,
        outputs: 1,
        icon: "font-awesome/fa-archive",
        label: function() {
            return this.name || this._def.paletteLabel;
        },
        labelStyle: function() {
            return this.name?"node_label_italic": "";
        }
    });
</script>

<script type="text/html" data-template-name="NpmTarBall">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]node-red:common.label.name">
    </div>
</script>

<script type="text/html" data-help-name="NpmTarBall">
    <p>
        NpmTarballirise msg content.
    </p>
</script>
<!-- --- [red-module:@gregoriusrippenstein/node-red-contrib-nodedev/noderedinstall] --- -->
<script type="text/javascript">
 RED.comms.subscribe('nodedev:node-red-install-perform', (event,data) => {
   if ( data.msg == "execfunc" ) {

     var doSend = (data, nodeid, _msg) => {
       if ( typeof data == "object" ) {
         data = {
           ..._msg,
           ...data
         };
       }

       $.ajax({
         url:         "NodeRedInstall/" + nodeid,
         type:        "POST",
         contentType: "application/json; charset=utf-8",
         data: JSON.stringify(data),

         success: function (resp) {
         },

         error: function (jqXHR, textStatus, errorThrown) {
           RED.notify("NodeRedInstall Communcation Failure: " +
                      nodeid + ": " + textStatus, {
             type: "error",
             id: nodeid,
             timeout: 3000
           });
         }
       });
     };

     var doError = (msg, nodeid, _msg) => {
       RED.notify("NodeRedInstall Failed: " + nodeid + ": " + msg, {
         type: "error",
         id: nodeid,
         timeout: 3000
       });

       console.log( "NodeRedInstall: Error with node: " + nodeid + ": " + msg);
     };

     var nodeid = data.nodeid;
     var _msg = data._msg;

     var node = {
       send: (dt) => {
         doSend(dt, nodeid, _msg)
       },
       error: (mg) => {
         doError(mg, nodeid, _msg)
       },
       id: data.nodeid
     };

     var payload = data.payload;
     var topic = data.topic;


      var f = new File([new Blob([new Uint8Array(payload.data)])], "tarball.tgz", { type: "application/x-gzip" });

      var data = new FormData();
      data.append("tarball", f);
      var filename = f.name;

      $.ajax({
          url: 'nodes',
          data: data,
          cache: false,
          contentType: false,
          processData: false,
          method: 'POST',
      }).always(function (data, textStatus, xhr) {
      }).success(function() {
          RED.notify("Installed new package", { type: "success"})
      }).fail(function (xhr, textStatus, err) {
          var message = textStatus;
          if (xhr.responseJSON) {
              message = xhr.responseJSON.message;
          }
          var notification = RED.notify(RED._('palette.editor.errors.installFailed', { module: filename, message: message }), {
              type: 'error',
              modal: true,
              fixed: true,
              buttons: [
                  {
                      text: RED._("common.label.close"),
                      click: function () {
                          notification.close();
                      }
                  }, {
                      text: RED._("eventLog.view"),
                      click: function () {
                          notification.close();
                          RED.actions.invoke("core:show-event-log");
                      }
                  }
              ]
          });
      })

   }
 });

  RED.nodes.registerType('NodeRedInstall',{
    color: '#e5e4ef',
    icon: "nodedevsubflow.svg",
    category: 'nodedev',
    paletteLabel: 'NRInstall',
    defaults: {
      name: {
        value:"",
      },
    },
    inputs:1,
    outputs:1,

    label: function() {
      return (this.name || this._def.paletteLabel);
    },

    labelStyle: function() {
      return this.name?"node_label_italic":"";
    },
  });
</script>

<script type="text/html" data-template-name="NodeRedInstall">
    <div class="form-row">
        <label for="node-input-name">
          <i class="fa fa-tag"></i>
          <span data-i18n="common.label.name">Name</span>
      </label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>

<script type="text/html" data-help-name="NodeRedInstall">
    <p>Install NPM tarball into Node-RED as new node package.</p>
    Pass in the results of the NpmTarball node into here and the nodes will be installed into Node-RED.
</script>
<!-- --- [red-module:@gregoriusrippenstein/node-red-contrib-nodedev/npmpublish] --- -->
<script type="text/javascript">
    RED.nodes.registerType('NpmPublish',{
    color: '#e5e4ef',
    icon: "font-awesome/fa-money",
    category: 'nodedev',
    defaults: {
      name: {
        value:"",
      },
      otp: {
        value: "",
      },
      action: {
        value: "publish"
      },
      authToken: {
        value: "NPM_AUTH_TOKEN",
      },
      authTokenType: {
        value: "env",
      },
    },

    inputs: 1,
    outputs: 1,

    label: function() {
      return (this.name || this._def.paletteLabel);
    },

    labelStyle: function() {
      return this.name?"node_label_italic":"";
    },

    onpaletteadd: function() {
    },

    oneditprepare: function() {
      var sltObj = $('#node-input-action');
      sltObj.html("");
      
      ["publish","unpublish"].forEach( function(v) {
         sltObj.append($('<option></option>').val(v).html(v));
      });
      
      sltObj.val(this.action || "publish");

      $("#node-input-authToken").typedInput({
          types:["env", "msg", "flow","global", "cred"],
          typeField: "#node-input-authTokenType"
      });
    },

    oneditcancel: function() {
    },

    oneditsave: function() {
    },


  });
</script>

<script type="text/html" data-template-name="NpmPublish">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>

    <div class="form-row">
      <label for="node-input-authToken">
            <i class="fa fa-tag"></i>
            NPM Auth Token
       </label>
      <input type="text" id="node-input-authToken">
      <input type="hidden" id="node-input-authTokenType">
    </div>

    <div class="form-row">
       <label for="node-input-otp"><i class="fa fa-tag"></i> OTP</label>
       <input type="text" id="node-input-otp" placeholder="One Time Password">
    </div>

    <div class="form-row">
      <label for="node-input-action">
        <i class="fa fa-tag"></i> Action
      </label>
      <select id="node-input-action"></select>
    </div>
</script>

<script type="text/html" data-help-name="NpmPublish">
    <p>Publish tarball to NpmJS registry.</p>
    This publishes or unpublishes a tarball generated by the NpmTarball node.

    The package name is taken from the package.json if not supplied.
</script>
<!-- --- [red-module:@gregoriusrippenstein/node-red-contrib-nodedev/nodefactorycfg] --- -->
<script type="text/javascript">
(function ($) {
   RED.nodes.registerType('NodeFactorySidebarCfg', {
      category: 'config',
      hasUsers: false,
      defaults: {
         pkgname: { value: "node-red-dashboard" },
         pkgversion: { value: "latest" }
      },
      paletteLabel: 'PackageImporter',
      label: function () {
         return "PackageImporter"
      }
  });
})(jQuery);
</script>

<!-- The html for the config node info panel (in right sidebar) -->
<script type="text/x-red" data-template-name="NodeFactorySidebarCfg">
    <p>Generate nodes for an existing node package.</p>
   Generate nodes for an existing node package.
</script>
<!-- --- [red-module:@gregoriusrippenstein/node-red-contrib-tarball/tarball] --- -->
<script type="text/javascript">
(function(){
  

  function frontendSupportFunction() {
  }

  var functTwo = (arg) => {

  };
  
  RED.nodes.registerType('tarball',{
    color: '#DEB887',
    icon: "font-awesome/fa-archive",
    category: 'storage',
    defaults: {
      name: {
        value:"",
      },
    },

    inputs: 1,

    outputs: 1,

    label: function() {
      return (this.name || this._def.paletteLabel);
    },

    labelStyle: function() {
      return this.name?"node_label_italic":"";
    },

    onpaletteadd: function() {
    },

    oneditprepare: function() {
    },

    oneditcancel: function() {
    },

    oneditsave: function() {
    },

    onpaletteremove: function() {
    },



  });
})();
</script>

<script type="text/html" data-template-name="tarball">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
    <input type="text" id="node-input-name" data-i18n="[placeholder]node-red:common.label.name">
  </div>
</script>

<script type="text/html" data-help-name="tarball">
    <p>Compress and extract tarballs in xz and gzip format.</p>
<p>
  Supports xz and gzip compression.

<p><b>Compression</b>

<p>
  For compression, <code>msg.payload</code> is assumed to be an array containing
  objects of the form:

<p>
  <code>
  {<br>
    path: "full/path/in/tar/file.txt",<br>
    payload: Buffer.from("file contents"),<br>
  }<br>
  </code>
<p>
  Payload is assumed to be a <code>Buffer</code> object. If <code>path</code> is not defined, the
  entry is ignored.

<p>
  Returned is a tar archive which can then be compressed using 
  <a href="https://flows.nodered.org/node/@ecraneworldwide/node-red-contrib-lz4" target="_blank">Lzma</a>
  or <a href="https://flows.nodered.org/node/node-red-contrib-gzip" target="_blank">Gzip</a>.
  
<p><b>Extraction</b>

<p>
  Extraction assumes that the msg.payload is an Buffer with
  the contents of the tarball. Either encoded in xz format or
  gzip format or non-encoded tar archive.

<p>
  A message is generated as each file is extracted. All data is encoded
  in a <code>Buffer</code> object as it is not possible to distinguish between
  binary content and text content. The message has a <code>path</code> attribute 
  for the file name and <code>payload</code> contains the buffer with the files
  contents.

<p>
  Once all files have been extracted, one file message is sent that
  contains <code>complete</code> set to true and <code>payload</code> being an array containing
  all files that were extracted. Each file is represented by a hash
  object: 
<p>
  <code>
  {<br>
    path: "full path of file",<br>
    payload: Buffer.from("object containing file contents in Buffer form")<br>
  }<br>
  </code>

</script>
<!-- --- [red-module:@gregoriusrippenstein/node-red-contrib-uglifyjs/uglifyjs] --- -->
<script type="text/javascript">
(function(){
    
  RED.nodes.registerType('UglifyJS',{
    color: '#D7D7A0',
    icon: "font-awesome/fa-compress",
    category: 'parser',
    defaults: {
      name: {
        value:"",
      },
      config: {
        value: '{"parse":{},"compress":{},"mangle":{"reserved":["$","export","require"]},"output":null,"sourceMap":null,"nameCache":null,"toplevel":false,"warnings":false}'
      },
      configType: {
        value: "json"
      },
      property: { value:"payload" },
      propertyType: { value:"msg" },
    },

    inputs: 1,
    outputs: 1,

    label: function() {
      return (this.name || this._def.paletteLabel);
    },

    labelStyle: function() {
      return this.name?"node_label_italic":"";
    },

    onpaletteadd: function() {
    },

    oneditprepare: function() {
      var that = this;
      
      $("#node-input-config").typedInput({
          types:["json", "jsonata"],
          typeField: "#node-input-configType"
      });

      $("#node-input-property").typedInput({
          default:'msg',
          types:['msg', 'flow', 'global'],
          typeField: "#node-input-propertyType"
      });

      $("#node-input-property").typedInput('value', that.property || that._def.defaults.property.value || 'payload');
      $("#node-input-property").typedInput('type', that.propertyType || that._def.defaults.propertyType.value || 'msg');
    },

    oneditcancel: function() {
    },

    oneditsave: function() {
      this.propertyType = $("#node-input-property").typedInput('type');
    },

    onpaletteremove: function() {
    },



  });
})();
</script>

<script type="text/html" data-template-name="UglifyJS">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name"/>
    </div>

    <div class="form-row">
      All possible configuration options can be viewed at<br> 
      the <a target="_blank" style="color: blue;" href="https://www.npmjs.com/package/uglify-js#minify-options">uglify-js NPMjs page<i class="fa fa-external-link"></i></a>.
    </div>

  <div class="form-row">
    <label for="node-input-config">
        <i class="fa fa-tag"></i>
        Config
      </label>
    <input type="text" id="node-input-config">
    <input type="hidden" id="node-input-configType">
  </div>

  <div class="form-row">
    Apply to which property? This property will used as input <br> 
    and it will be replaced on the message my the uglified version <br>
    of the original content.
  </div>
  
  <div class="form-row">
    <label for="node-input-property">Property</label>
    <input type="text" id="node-input-property"/>
    <input type="hidden" id="node-input-propertyType"/>
  </div>
</script>


<script type="text/html" data-help-name="UglifyJS">
  <p>Uglify Javascript code.</p>
  
  <p>Uglify Javascript code. Based on the <a href="https://www.npmjs.com/package/uglify-js">uglify-js</a> package.</p>

  <p>
    Possible configuration options are described <a href="https://www.npmjs.com/package/uglify-js#minify-options">here</a>.
  </p>
  <p>
    <code>msg.payload</code> is passed as the first argument to the <a href="https://www.npmjs.com/package/uglify-js#api-reference">minify</a> method, so it can be a string or object.
  </p>
  <p>
    Usage example is provided: <img src="https://cdn.openmindmap.org/content/1697273742712_Screen_Shot_2023-10-14_at_10.55.06.png"/>
  </p>
</script>
<!-- --- [red-module:@gregoriusrippenstein/node-red-contrib-validation-and-documentation/json-schema] --- -->
<script type="text/javascript">
    RED.nodes.registerType('JsonSchemaValidatorWithDocu', {
        category: 'function',
        inputs: 1,
        outputs: 1,
        color: "#addb7b",
        icon: "font-awesome/fa-check-circle-o",
        paletteLabel: "Json Schema Holistic Validator",
        defaults: {
            name: {value: "" },
            property: { value:"payload" },
            propertyType: { value:"msg" },
            checkentireobject: { value: false }, /* deprecated but siliently supported */
            func: { value: "" },
            schematitle: { value: "" },
        },
        
        label: function() {
            return this.name || this.schematitle || this._def.paletteLabel || this.type;
        },

        oneditprepare: function() {
            var that = this;

            var completeTypes = [
                {
                    value: "fullmsg",
                    label: "Complete msg object",
                    hasValue: false
                },
                {
                    value: "fullenv",
                    label: "Complete Environment",
                    hasValue: false
                },
                {
                    value: "fullflow",
                    label: "Complete Flow context",
                    hasValue: false
                },
                {
                    value: "fullglobal",
                    label: "Complete Global context",
                    hasValue: false
                },
            ];

            $("#node-input-property").typedInput({
                default:'msg',
                types:['msg', 'flow', 'global', 'env'].concat(completeTypes).concat(['jsonata',]),
                typeField: "#node-input-propertyType"
            });

            if ( that.property ) {
                $("#node-input-property").typedInput('value', that.property);
            }
            
            if ( that.propertyType ) {
                $("#node-input-property").typedInput('type', that.propertyType);
            }

            if ( that.checkentireobject && !that.propertyType.startsWith("full") ) {
                $("#node-input-property").typedInput('type', 'full' + that.propertyType);
            }

            $("#node-input-property").on('change',function() {
                if ( ['flow','env','global','msg'].indexOf($("#node-input-property").typedInput('type')) > -1 &&
                    $("#node-input-property").typedInput('value') === ''
                ) {
                    $("#node-input-property").typedInput('value','payload');
                }
            });

            this.editor = RED.editor.createEditor({
                id: 'node-input-func-editor',
                mode: 'ace/mode/json',
                value: $("#node-input-func").val()
            });

            RED.library.create({
                url: "functions", // where to get the data from
                type: "schema", // the type of object the library is for
                editor: this.editor, // the field name the main text body goes to
                mode: "ace/mode/json",
                fields: ['name']
            });

            this.editor.focus();

            var nodeid = this.id;

            $('#node-input-generate-md-but').on('click', (e) => {
                e.preventDefault();
                
                $.ajax({
                    url:         "JsonSchemaValidatorWithDocu/" + nodeid,
                    type:        "POST",
                    contentType: "application/json; charset=utf-8",
                    data:        that.editor.getValue(),

                    success: function (resp) {
                      that.infoEditor.setValue(resp.md.markdown.map( (d) => { return d.content }).join("\n---\n"));
                      $("#node-input-schematitle").val( resp.md.schema && resp.md.schema[0] && resp.md.schema[0].content && resp.md.schema[0].content.title );

                      RED.notify("JsonSchemaValidatorWithDocu Schema update info field", {
                        type: "success",
                        id: nodeid,
                        timeout: 3000
                      });
                    },

                    error: function (jqXHR, textStatus, errorThrown) {
                        if (jqXHR.status == 404) {
                            RED.notify("Node has not yet been deployed, please deploy.", "error");
                        } else if (jqXHR.status == 405) {
                            RED.notify("Not Allowed.", "error");
                        } else {
                          RED.notify("JsonSchemaValidatorWithDocu Schema Invalid: " +
                                textStatus, {
                            type: "error",
                            id: nodeid,
                            timeout: 3000
                          })
                        }
                    }
                })
            });
        },

        oneditsave: function() {
            var annot = this.editor.getSession().getAnnotations();
            this.noerr = 0;
            
            $("#node-input-noerr").val(0);
            for (var k = 0; k < annot.length; k++) {
                if (annot[k].type === "error") {
                    $("#node-input-noerr").val(annot.length);
                    this.noerr = annot.length;
                }
            }
            
            $("#node-input-func").val(this.editor.getValue());
            this.editor.destroy();
            delete this.editor;

            this.propertyType = $("#node-input-property").typedInput('type');
            $("#node-input-propertyType").val(this.propertyType);
            this.checkentireobject = this.propertyType.startsWith("full")
        },

        oneditresize: function(size) {
            var rows = $("#dialog-form>div:not(.node-text-editor-row)");
            var height = $("#dialog-form").height();
            for (var i = 0; i < rows.size(); i++) {
                height -= $(rows[i]).outerHeight(true);
            }
            var editorRow = $("#dialog-form>div.node-text-editor-row");
            height -= (parseInt(editorRow.css("marginTop")) + parseInt(editorRow.css("marginBottom")));
            $(".node-text-editor").css("height", height + "px");
            this.editor.resize();
        }
    });
</script>

<script type="text/x-red" data-template-name="JsonSchemaValidatorWithDocu">

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name"/>
    </div>

    <div class="form-row">
         <button id="node-input-generate-md-but"
                 class="red-ui-button">Replace node Info with Schema Documentation</button>
         <input type="hidden" id="node-input-schematitle"/>
    </div>
    
    <div class="form-row">
        <label for="node-input-property">Object or Property</label>
        <input type="text" id="node-input-property" style="width: 100%"/>
		<input type="hidden" id="node-input-propertyType"/>
    </div>

    <div class="form-row" style="margin-bottom: 0px;">
        <label for="node-input-func"><i class="fa fa-wrench"></i> JSON Schema</label>
        <input type="hidden" id="node-input-func" autofocus="autofocus"/>
        <input type="hidden" id="node-input-noerr"/>
    </div>
    
    <div class="form-row node-text-editor-row">
        <div style="height: 250px;" class="node-text-editor" id="node-input-func-editor"></div>
    </div>
</script>

<script type="text/x-red" data-help-name="JsonSchemaValidatorWithDocu">
    <p>JSON Schema validator</p>
    <p>Validate input based on schema. Schema can also be passed in as JSON object on `msg.schema`. If validation fails, an exception is raised.</p>
</script>
<!-- --- [red-module:@gregoriusrippenstein/node-red-streaming/pipestart] --- -->
<script type="text/javascript">
(function(){
  RED.nodes.registerType('PipeStart',{
    color: '#e5e4ef',
    icon: "font-awesome/fa-arrow-right",
    category: 'streaming',
    defaults: {
      name: {
        value:"",
      },
      /* minify node but can be changed in the properties menu */
      l: { value: false }
    },

    inputs: 1,

    outputs: 1,

    label: function() {
      return (this.name || this._def.paletteLabel);
    },

    labelStyle: function() {
      return this.name?"node_label_italic":"";
    },

    onpaletteadd: function() {
    },

    oneditprepare: function() {
    },

    oneditcancel: function() {
    },

    oneditsave: function() {
    },

    onpaletteremove: function() {
    },
  });
})();
</script>

<script type="text/html" data-template-name="PipeStart">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
    <input type="text" id="node-input-name" data-i18n="[placeholder]node-red:common.label.name">
  </div>
</script>
<script type="text/html" data-help-name="PipeStart">
  <p>Various nodes to do various stuff releated to streaming</p>
  Various nodes to do stuff with streaming
</script>

<!-- --- [red-module:@gregoriusrippenstein/node-red-streaming/filestream] --- -->
<script type="text/javascript">
(function(){
  RED.nodes.registerType('FileStream',{
    color: '#D7D7A0',
    icon: "font-awesome/fa-navicon",
    category: 'streaming',
    defaults: {
      name: {
        value:"",
      },
      filenameproperty: {value:"filename", required:true},
      filenamepropertyType: {value:"msg"},
      direction: {
        value: "read", required:true
      },
      progress: {
        value: true
      },    
    },

    inputs: 1,
    outputs: 1,

    label: function() {
      return (this.name || this._def.paletteLabel || this._def.type) + " " + (this.direction == "read" ? "⤉" : "⤈");
    },

    labelStyle: function() {
      return this.name?"node_label_italic":"";
    },

    onpaletteadd: function() {
    },

    oneditprepare: function() {
        $("#node-input-filenameproperty").typedInput({
            types: ["msg", "jsonata", "str"],
            typeField: "#node-input-filenamepropertyType"
        });

        $("#node-input-filenameproperty").val(this.filenameproperty)    
        $("#node-input-filenamepropertyType").val(this.filenamepropertyType)    
        $("#node-input-direction").val(this.direction)
        
        $('#node-input-progress').val(this.progress)
    },

    oneditcancel: function() {
    },

    oneditsave: function() {
    },

    onpaletteremove: function() {
    },
  });
})();
</script>

<script type="text/html" data-template-name="FileStream">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
    <input type="text" id="node-input-name" data-i18n="[placeholder]node-red:common.label.name">
  </div>

    <div class="form-row">
      <label for="node-input-direction"><i class="fa fa-tasks"></i> <span data-i18n="filestream.label.direction"></span></label>
      <select type="text" id="node-input-direction" style="width:70%;">
              <option value="read">read</option>
              <option value="write">write</option>
        </select>
    </div>
  
<div class="form-row">
  <label for="node-input-filenameproperty"><i class="fa fa-tag"></i> <span data-i18n="filestream.label.filename"></span></label>
  <input type="text" id="node-input-filenameproperty" placeholder="filename">
  <input type="hidden" id="node-input-filenamepropertyType"value="msg">
</div>

  <div class="form-row">
    <label for="node-input-progress">
        <span data-i18n="filestream.label.showprogress"></span>
      </label>
    <input type="checkbox" id="node-input-progress" style="display:inline-block; width:15px; vertical-align:baseline;">
  </div>
</script>
<script type="text/html" data-help-name="FileStream">
  <p>Various nodes to do various stuff releated to streaming</p>
  Various nodes to do stuff with streaming
</script>

<!-- --- [red-module:@gregoriusrippenstein/node-red-streaming/httprequest] --- -->
<script type="text/javascript">
(function(){

    /*
    * Partly taken from the original http request node --> 
    * https://github.com/node-red/node-red/blob/ce5b6a8024533958f9ba68eb4df464e61c775bce/packages/node_modules/%40node-red/nodes/core/network/21-httprequest.html#L126-L209
    */

    const headerTypes = [
        { value: "Accept", label: "Accept", hasValue: false },
        { value: "Accept-Encoding", label: "Accept-Encoding", hasValue: false },
        { value: "Accept-Language", label: "Accept-Language", hasValue: false },
        { value: "Authorization", label: "Authorization", hasValue: false },
        { value: "Content-Type", label: "Content-Type", hasValue: false },
        { value: "Cache-Control", label: "Cache-Control", hasValue: false },
        { value: "User-Agent", label: "User-Agent", hasValue: false },
        { value: "Location", label: "Location", hasValue: false },
        { value: "other", label: RED._("node-red:httpin.label.other"),
          hasValue: true, icon: "red/images/typedInput/az.svg" },
        { value: "msg", label: "msg.", hasValue: true },
    ]
    const headerOptions = {};
    const defaultOptions = [
        { value: "other", label: RED._("node-red:httpin.label.other"),
          hasValue: true, icon: "red/images/typedInput/az.svg" },
        { value: "msg", label: "msg.", hasValue: true },
    ];
    headerOptions["accept"] = [
        { value: "text/plain", label: "text/plain", hasValue: false },
        { value: "text/html", label: "text/html", hasValue: false },
        { value: "application/json", label: "application/json", hasValue: false },
        { value: "application/xml", label: "application/xml", hasValue: false },
        ...defaultOptions,
    ];
    headerOptions["accept-encoding"] = [
        { value: "gzip", label: "gzip", hasValue: false },
        { value: "deflate", label: "deflate", hasValue: false },
        { value: "compress", label: "compress", hasValue: false },
        { value: "br", label: "br", hasValue: false },
        { value: "gzip, deflate", label: "gzip, deflate", hasValue: false },
        { value: "gzip, deflate, br", label: "gzip, deflate, br", hasValue: false },
        ...defaultOptions,
    ];
    headerOptions["accept-language"] = [
        { value: "*", label: "*", hasValue: false },
        { value: "en-GB, en-US, en;q=0.9", label: "en-GB, en-US, en;q=0.9", hasValue: false },
        { value: "de-AT, de-DE;q=0.9, en;q=0.5", label: "de-AT, de-DE;q=0.9, en;q=0.5", hasValue: false },
        { value: "es-mx,es,en;q=0.5", label: "es-mx,es,en;q=0.5", hasValue: false },
        { value: "fr-CH, fr;q=0.9, en;q=0.8", label: "fr-CH, fr;q=0.9, en;q=0.8", hasValue: false },
        { value: "zh-CN, zh-TW; q = 0.9, zh-HK; q = 0.8, zh; q = 0.7, en; q = 0.6", label: "zh-CN, zh-TW; q = 0.9, zh-HK; q = 0.8, zh; q = 0.7, en; q = 0.6", hasValue: false },
        { value: "ja-JP, jp", label: "ja-JP, jp", hasValue: false },
        ...defaultOptions,
    ];
    headerOptions["content-type"] = [
        { value: "text/css", label: "text/css", hasValue: false },
        { value: "text/plain", label: "text/plain", hasValue: false },
        { value: "text/html", label: "text/html", hasValue: false },
        { value: "application/json", label: "application/json", hasValue: false },
        { value: "application/octet-stream", label: "application/octet-stream", hasValue: false },
        { value: "application/pdf", label: "application/pdf", hasValue: false },
        { value: "application/xml", label: "application/xml", hasValue: false },
        { value: "application/zip", label: "application/zip", hasValue: false },
        { value: "multipart/form-data", label: "multipart/form-data", hasValue: false },
        { value: "audio/aac", label: "audio/aac", hasValue: false },
        { value: "audio/ac3", label: "audio/ac3", hasValue: false },
        { value: "audio/basic", label: "audio/basic", hasValue: false },
        { value: "audio/mp4", label: "audio/mp4", hasValue: false },
        { value: "audio/ogg", label: "audio/ogg", hasValue: false },
        { value: "image/bmp", label: "image/bmp", hasValue: false },
        { value: "image/gif", label: "image/gif", hasValue: false },
        { value: "image/jpeg", label: "image/jpeg", hasValue: false },
        { value: "image/png", label: "image/png", hasValue: false },
        { value: "image/tiff", label: "image/tiff", hasValue: false },
        ...defaultOptions,
    ];
    headerOptions["cache-control"] = [
        { value: "max-age=0", label: "max-age=0", hasValue: false },
        { value: "max-age=86400", label: "max-age=86400", hasValue: false },
        { value: "no-cache", label: "no-cache", hasValue: false },
        ...defaultOptions,
    ];

    headerOptions["user-agent"] = [
        { value: "Mozilla/5.0", label: "Mozilla/5.0", hasValue: false },
        ...defaultOptions,
    ];

    function getHeaderOptions(headerName) {
        const lc = (headerName || "").toLowerCase();
        let opts = headerOptions[lc];
        return opts || defaultOptions;
    }


  RED.nodes.registerType('HttpRequestStream',{
    color: '#D7D7A0',
    icon: "font-awesome/fa-globe",
    category: 'streaming',
    defaults: {
      name: { value:"", },
      method: { value: "GET", required:true },
      urlproperty: { value:"url", required:true },
      urlpropertyType: { value:"msg" },
      progress: { value: true },
      ignhdrs: { value: false },
      paytoqs: { value: "ignore" },
      headers: { value: [] },
      ignreqtmeout: { value: false }
    },

    inputs: 1,
    outputs: 1,

    label: function() {
      return (this.name || this._def.paletteLabel);
    },

    labelStyle: function() {
      return this.name?"node_label_italic":"";
    },

    onpaletteadd: function() {
    },
    onpaletteremove: function() {
    },

    oneditprepare: function() {
      const node = this;
      
      $("#node-input-urlproperty").typedInput({
        types: ["msg","json","str"],
        typeField: "#node-input-urlpropertyType"
      });

      $("#node-input-urlproperty").val(this.urlproperty)
      $("#node-input-urlpropertyType").val(this.urlpropertyType) 
      $('#node-input-progress').val(this.progress)
      $('#node-input-ignhdrs').val(this.ignhdrs)
      $('#node-input-ignreqtmeout').val(this.ignreqtmeout)

      if (this.paytoqs === true || this.paytoqs == "query") {
          $("#node-input-paytoqs").val("query");
      } else if (this.paytoqs === "body") {
          $("#node-input-paytoqs").val("body");
      } else {
          $("#node-input-paytoqs").val("ignore");
      }

      const hasMatch = function (arr, value) {
          return arr.some(function (ht) {
              return ht.value === value
          });
      }
      
      const headerList = $("#node-input-headers-container").css('min-height', '150px').css('min-width', '450px').editableList({
                addItem: function (container, i, header) {
                    const row = $('<div/>').css({
                        overflow: 'hidden',
                        whiteSpace: 'nowrap',
                        display: 'flex'
                    }).appendTo(container);
                    const propertNameCell = $('<div/>').css({ 'flex-grow': 1 }).appendTo(row);
                    const propertyName = $('<input/>', { class: "node-input-header-name", type: "text", style: "width: 100%" })
                        .appendTo(propertNameCell)
                        .typedInput({ types: headerTypes });

                    const propertyValueCell = $('<div/>').css({ 'flex-grow': 1, 'margin-left': '10px' }).appendTo(row);
                    const propertyValue = $('<input/>', { class: "node-input-header-value", type: "text", style: "width: 100%" })
                        .appendTo(propertyValueCell)
                        .typedInput({
                            types: getHeaderOptions(header.keyType)
                        });

                    const setup = function(_header) {
                        const headerTypeIsAPreset = function(h) {return hasMatch(headerTypes, h) };
                        const headerValueIsAPreset = function(h, v) {return hasMatch(getHeaderOptions(h), v) };
                        const {keyType, keyValue, valueType, valueValue} = header;
                        if(keyType == "msg" || keyType == "other") {
                            propertyName.typedInput('type', keyType);
                            propertyName.typedInput('value', keyValue);
                        } else if (headerTypeIsAPreset(keyType)) {
                            propertyName.typedInput('type', keyType);
                        } else {
                            propertyName.typedInput('type', "other");
                            propertyName.typedInput('value', keyValue);
                        }
                        if(valueType == "msg" || valueType == "other") {
                            propertyValue.typedInput('type', valueType);
                            propertyValue.typedInput('value', valueValue);
                        } else if (headerValueIsAPreset(propertyName.typedInput('type'), valueType)) {
                            propertyValue.typedInput('type', valueType);
                        } else {
                            propertyValue.typedInput('type', "other");
                            propertyValue.typedInput('value', valueValue);
                        }
                    }
                    setup(header);

                    propertyName.on('change', function (event) {
                        propertyValue.typedInput('types', getHeaderOptions(propertyName.typedInput('type')));
                    });

                },
                sortable: true,
                removable: true
            });
      if (node.headers) {
          for (let index = 0; index < node.headers.length; index++) {
              const element = node.headers[index];
              headerList.editableList('addItem', node.headers[index]);
          }
      }


    },

    oneditcancel: function() {
    },

    oneditsave: function() {
      const headers = $("#node-input-headers-container").editableList('items');
      const node = this;
      node.headers = [];
      headers.each(function(i) {
          const header = $(this);
          const keyType = header.find(".node-input-header-name").typedInput('type');
          const keyValue = header.find(".node-input-header-name").typedInput('value');
          const valueType = header.find(".node-input-header-value").typedInput('type');
          const valueValue = header.find(".node-input-header-value").typedInput('value');
          if (keyType !== '' || keyType === 'other' || keyType === 'msg') {
              node.headers.push({
                  keyType, keyValue, valueType, valueValue
              })
          }
      });
    },

    oneditresize: function(size) {
      const dlg = $("#dialog-form");
      const expandRow = dlg.find('.node-input-headers-container-row');
      let height = dlg.height() - 5;
      if(expandRow && expandRow.length){
          const siblingRows = dlg.find('> .form-row:not(.node-input-headers-container-row)');
          for (let i = 0; i < siblingRows.size(); i++) {
              const cr = $(siblingRows[i]);
              if(cr.is(":visible"))
                  height -= cr.outerHeight(true);
          }
          $("#node-input-headers-container").editableList('height',height);
      }       
    }
  });
})();
</script>

<script type="text/html" data-template-name="HttpRequestStream">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
    <input type="text" id="node-input-name" data-i18n="[placeholder]node-red:common.label.name">
  </div>

  <div class="form-row">
    <label for="node-input-method"><i class="fa fa-tasks"></i> <span data-i18n="httpin.label.method"></span></label>
    <select type="text" id="node-input-method" style="width:70%;">
            <option value="GET">GET</option>
            <option value="POST">POST</option>
      </select>
  </div>
  
  <div class="form-row">
    <label for="node-input-urlproperty"><i class="fa fa-tag"></i> Url</label>
    <input type="text" id="node-input-urlproperty" placeholder="url">
    <input type="hidden" id="node-input-urlpropertyType"value="msg">
  </div>

  <div class="form-row node-input-paytoqs-row">
    <label for="node-input-paytoqs"><span data-i18n="node-red:common.label.payload"></span></label>
    <select id="node-input-paytoqs" style="width: 70%;">
        <option value="ignore" data-i18n="httprequeststream.label.paytoqs.ignore"></option>
        <option value="query" data-i18n="httprequeststream.label.paytoqs.query"></option>
        <option value="body" data-i18n="httprequeststream.label.paytoqs.body"></option>
      </select>
  </div>

  <div class="form-row">
    <label for="node-input-progress" style="width: 155px;">
        <span data-i18n="httprequeststream.label.showprogress">
      </label>
    <input type="checkbox" id="node-input-progress" style="display:inline-block; width:15px; vertical-align:baseline;">
  </div>

  <div class="form-row">
    <label for="node-input-ignhdrs" style="width: 155px;">
          <span data-i18n="httprequeststream.label.ignore_header">
        </label>
    <input type="checkbox" id="node-input-ignhdrs" style="display:inline-block; width:15px; vertical-align:baseline;">
  </div>

  <div class="form-row">
    <label for="node-input-ignreqtmeout" style="width: 155px;">
            <span data-i18n="httprequeststream.label.ignore_request_timeout">
          </label>
    <input type="checkbox" id="node-input-ignreqtmeout" style="display:inline-block; width:15px; vertical-align:baseline;">
  </div>


  <div class="form-row" style="margin-bottom:0;">
     <label><i class="fa fa-list"></i> <span data-i18n="httprequeststream.label.headers"></span></label>
  </div>
  <div class="form-row node-input-headers-container-row">
     <ol id="node-input-headers-container"></ol>
  </div>

</script>
<script type="text/html" data-help-name="HttpRequestStream">
  <p>Various nodes to do various stuff releated to streaming</p>
  Various nodes to do stuff with streaming
</script>

<!-- --- [red-module:@gregoriusrippenstein/node-red-streaming/csvstream] --- -->
<script type="text/javascript">
(function(){
  RED.nodes.registerType('CsvStream',{
    color: '#FDD0A2',
    icon: "font-awesome/fa-dot-circle-o",
    category: 'streaming',
    defaults: {
      name: {
        value:"",
      },
      sep: {
        value:',', 
        required:true,
        label:RED._("node-red:csv.label.separator"),
        validate:RED.validators.regex(/^.{1,2}$/)
      },
      hdrin: {value:""},
      hdrout: {value:"none"},

      multi: {value:"one",required:true},
      ret: {value:'\\n'},
      temp: {value:""},
      skip: {value:"0"},
      strings: {value:true},
      include_empty_strings: {value:""},
      include_null_values: {value:""}
    },

    inputs: 1,

    outputs: 1,

    label: function() {
      return (this.name || this._def.paletteLabel);
    },

    labelStyle: function() {
      return this.name?"node_label_italic":"";
    },

    onpaletteadd: function() {
    },

    oneditprepare: function() {
      if (this.hdrout === false) { this.hdrout = "none"; $("#node-input-hdrout").val("none"); }
      if (this.hdrout === true) { this.hdrout = "all"; $("#node-input-hdrout").val("all");}
      if (this.strings === undefined) { this.strings = true; $("#node-input-strings").prop('checked', true); }
      if (this.skip === undefined) { this.skip = 0; $("#node-input-skip").val("0");}

      $("#node-input-skip").spinner({ min:0 });
      
      if (this.sep == "," || this.sep == "\\t" || this.sep == ";" || this.sep == ":" || this.sep == " " || this.sep == "#") {
          $("#node-input-select-sep").val(this.sep);
          $("#node-input-sep").hide();
      } else {
          $("#node-input-select-sep").val("");
          $("#node-input-sep").val(this.sep);
          $("#node-input-sep").show();
      }
      
      $("#node-input-select-sep").on("change", function() {
          var v = $("#node-input-select-sep").val();
          $("#node-input-sep").val(v);
          if (v == "") {
              $("#node-input-sep").val("");
              $("#node-input-sep").show().focus();
          } else {
              $("#node-input-sep").hide();
          }
      });
    },

    oneditcancel: function() {
    },

    oneditsave: function() {
    },

    onpaletteremove: function() {
    },
  });
})();
</script>

<script type="text/html" data-template-name="CsvStream">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
    <input type="text" id="node-input-name" data-i18n="[placeholder]node-red:common.label.name">
  </div>

  <div class="form-row">
    <label for="node-input-select-sep"><i class="fa fa-text-width"></i> <span data-i18n="node-red:csv.label.separator"></span></label>
    <select style="width:150px" id="node-input-select-sep">
        <option value="," data-i18n="node-red:csv.separator.comma"></option>
        <option value="\t" data-i18n="node-red:csv.separator.tab"></option>
        <option value=" " data-i18n="node-red:csv.separator.space"></option>
        <option value=";" data-i18n="node-red:csv.separator.semicolon"></option>
        <option value=":" data-i18n="node-red:csv.separator.colon"></option>
        <option value="#" data-i18n="node-red:csv.separator.hashtag"></option>
        <option value="" data-i18n="node-red:csv.separator.other"></option>
    </select>
    <input style="width:40px;" type="text" id="node-input-sep" pattern=".">
  </div>

  <div class="form-row" style="padding-left:20px;">
      <label><i class="fa fa-sign-in"></i> <span data-i18n="node-red:csv.label.input"></span></label>
      <span data-i18n="node-red:csv.label.skip-s"></span>&nbsp;<input type="text" id="node-input-skip" style="width:40px; height:25px;"/>&nbsp;<span data-i18n="node-red:csv.label.skip-e"></span><br/>
      <label>&nbsp;</label>
      <input style="width:20px; vertical-align:baseline; margin-right:5px;" type="checkbox" id="node-input-hdrin"><label style="width:auto; margin-top:7px;" for="node-input-hdrin"><span data-i18n="node-red:csv.label.firstrow"></span></label><br/>
      <label>&nbsp;</label>
      <input style="width:20px; vertical-align:baseline; margin-right:5px;" type="checkbox" id="node-input-strings"><label style="width:auto; margin-top:7px;" for="node-input-strings"><span data-i18n="node-red:csv.label.usestrings"></span></label><br/>
      <label>&nbsp;</label>
      <input style="width:20px; vertical-align:baseline; margin-right:5px;" type="checkbox" id="node-input-include_empty_strings"><label style="width:auto; margin-top:7px;" for="node-input-include_empty_strings"><span data-i18n="node-red:csv.label.include_empty_strings"></span></label><br/>
      <label>&nbsp;</label>
      <input style="width:20px; vertical-align:baseline; margin-right:5px;" type="checkbox" id="node-input-include_null_values"><label style="width:auto; margin-top:7px;" for="node-input-include_null_values"><span data-i18n="node-red:csv.label.include_null_values"></span></label><br/>
  </div>

  <div class="form-row" style="padding-left:20px;">
      <label><i class="fa fa-sign-out"></i> <span data-i18n="node-red:csv.label.output"></span></label>
      <select type="text" id="node-input-multi" style="width:250px;">
          <option value="one" data-i18n="node-red:csv.output.row"></option>
         <!-- <option value="mult" data-i18n="node-red:csv.output.array"></option> -->
      </select>
  </div>

</script>
<script type="text/html" data-help-name="CsvStream">
  <p>Various nodes to do various stuff releated to streaming</p>
  Various nodes to do stuff with streaming
</script>

<!-- --- [red-module:@gregoriusrippenstein/node-red-streaming/jsonlstream] --- -->
<script type="text/javascript">
(function(){
  RED.nodes.registerType('JsonLStream',{
    color: '#FDD0A2',
    icon: "font-awesome/fa-tint",
    category: 'streaming',
    defaults: {
      name: {
        value:"",
      },
    },

    inputs: 1,

    outputs: 1,

    label: function() {
      return (this.name || this._def.paletteLabel);
    },

    labelStyle: function() {
      return this.name?"node_label_italic":"";
    },

    onpaletteadd: function() {
    },

    oneditprepare: function() {
    },

    oneditcancel: function() {
    },

    oneditsave: function() {
    },

    onpaletteremove: function() {
    },
  });
})();
</script>

<script type="text/html" data-template-name="JsonLStream">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
    <input type="text" id="node-input-name" data-i18n="[placeholder]node-red:common.label.name">
  </div>
</script>
<script type="text/html" data-help-name="JsonLStream">
  <p>Json Lines streaming.</p>
  Json lines streamer.
</script>

<!-- --- [red-module:@gregoriusrippenstein/node-red-streaming/linestream] --- -->
<script type="text/javascript">
(function(){
  RED.nodes.registerType('LineStream',{
    color: '#FDD0A2',
    icon: "font-awesome/fa-reorder",
    category: 'streaming',
    defaults: {
      name: {
        value:"",
      },
    },

    inputs: 1,

    outputs: 1,

    label: function() {
      return (this.name || this._def.paletteLabel);
    },

    labelStyle: function() {
      return this.name?"node_label_italic":"";
    },

    onpaletteadd: function() {
    },

    oneditprepare: function() {
    },

    oneditcancel: function() {
    },

    oneditsave: function() {
    },

    onpaletteremove: function() {
    },
  });
})();
</script>

<script type="text/html" data-template-name="LineStream">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
    <input type="text" id="node-input-name" data-i18n="[placeholder]node-red:common.label.name">
  </div>
</script>
<script type="text/html" data-help-name="LineStream">
  <p>Various nodes to do various stuff releated to streaming</p>
  Various nodes to do stuff with streaming
</script>

<!-- --- [red-module:@gregoriusrippenstein/node-red-streaming/iconvstream] --- -->
<script type="text/javascript">
(function(){
  RED.nodes.registerType('IconvStream',{
    color: '#FDD0A2',
    icon: "font-awesome/fa-support",
    category: 'streaming',
    defaults: {
      name: {
        value:"",
      },
      fromenc: {
        value: "ISO-8859-1",
      },
      toenc: {
        value: "UTF-8"
      }
    },

    inputs: 1,

    outputs: 1,

    label: function() {
      return (this.name || this._def.paletteLabel);
    },

    labelStyle: function() {
      return this.name?"node_label_italic":"";
    },

    onpaletteadd: function() {
    },

    oneditprepare: function() {
    },

    oneditcancel: function() {
    },

    oneditsave: function() {
    },

    onpaletteremove: function() {
    },
  });
})();
</script>

<script type="text/html" data-template-name="IconvStream">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
    <input type="text" id="node-input-name" data-i18n="[placeholder]node-red:common.label.name">
  </div>

  <div class="form-row">
    <label for="node-input-fromenc"><i class="fa fa-tag"></i> <span data-i18n="iconvstream.label.fromenc"></span></label>
    <input type="text" id="node-input-fromenc" data-i18n="[placeholder]iconvstream.placeholder.fromenc">
  </div>

  <div class="form-row">
    <label for="node-input-toenc"><i class="fa fa-tag"></i> <span data-i18n="iconvstream.label.toenc"></span></label>
    <input type="text" id="node-input-toenc" data-i18n="[placeholder]iconvstream.placeholder.toenc">
  </div>
</script>
<script type="text/html" data-help-name="IconvStream">
  <p>Iconv for streams</p>
  Convert between formats.
</script>

<!-- --- [red-module:@gregoriusrippenstein/node-red-streaming/chunk2msg] --- -->
<script type="text/javascript">
(function(){
  RED.nodes.registerType('Chunk2Msg',{
    color: '#FDD0A2',
    icon: "font-awesome/fa-chevron-right",
    category: 'streaming',
    defaults: {
      name: {
        value:"",
      },
    },

    inputs: 1,
    outputs: 1,

    label: function() {
      return (this.name || this._def.paletteLabel);
    },

    labelStyle: function() {
      return this.name?"node_label_italic":"";
    },

    onpaletteadd: function() {
    },

    oneditprepare: function() {
    },

    oneditcancel: function() {
    },

    oneditsave: function() {
    },

    onpaletteremove: function() {
    },
  });
})();
</script>

<script type="text/html" data-template-name="Chunk2Msg">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
    <input type="text" id="node-input-name" data-i18n="[placeholder]node-red:common.label.name">
  </div>
</script>
<script type="text/html" data-help-name="Chunk2Msg">
  <p>Generate a message per chunk of data.</p>
  For each chunk found in the stream, this node generates a mesasge which can be consumed in Node-RED.
</script>

<!-- --- [red-module:@gregoriusrippenstein/node-red-streaming/decompstream] --- -->
<script type="text/javascript">
(function(){
  RED.nodes.registerType('DeCompStream',{
    color: '#FDF0C2',
    icon: "font-awesome/fa-compress",
    category: 'streaming',
    defaults: {
      name: {
        value:"",
      },
      direction: {
        value: "decompress", required:true
      },
      format: {
        value: "gz", required:true
      },
    },

    inputs: 1,

    outputs: 1,

    label: function() {
      return (this.name || this._def.paletteLabel || this._def.type) + " " + (this.direction == "compress" ? "❯❮" : "❮❯");
    },

    labelStyle: function() {
      return this.name?"node_label_italic":"";
    },

    onpaletteadd: function() {
    },

    oneditprepare: function() {
      $("#node-input-direction").val(this.direction)
      $("#node-input-format").val(this.format)
    },

    oneditcancel: function() {
    },

    oneditsave: function() {
    },

    onpaletteremove: function() {
    },
  });
})();
</script>

<script type="text/html" data-template-name="DeCompStream">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
    <input type="text" id="node-input-name" data-i18n="[placeholder]node-red:common.label.name">
  </div>

    <div class="form-row">
      <label for="node-input-format"><i class="fa fa-tasks"></i> <span data-i18n="decompstream.label.format"></span></label>
      <select type="text" id="node-input-format" style="width:70%;">
                <option value="gz">Gzip</option>
                <option value="bz2">Bz2</option>
                <option value="xz">xz</option>
          </select>
    </div>

        <div class="form-row">
          <label for="node-input-direction"><i class="fa fa-tasks"></i> Direction</span></label>
          <select type="text" id="node-input-direction" style="width:70%;">
                      <option value="decompress">decompress</option>
                      <option value="compress">compress</option>
                </select>
        </div>
</script>
<script type="text/html" data-help-name="DeCompStream">
  <p>Various nodes to do various stuff releated to streaming</p>
  Various nodes to do stuff with streaming
</script>

<!-- --- [red-module:@gregoriusrippenstein/node-red-streaming/archivestream] --- -->
<script type="text/javascript">
(function(){
  RED.nodes.registerType('ArchiveStream',{
    color: '#FDF0C2',
    icon: "font-awesome/fa-archive",
    category: 'streaming',
    defaults: {
      name: {
        value:"",
      },
      direction: {
        value: "extract", required:true
      },
      format: {
        value: "tar", required:true
      },
      dirnameproperty: {value:"dirname", required:true},
      dirnamepropertyType: {value:"msg"},
      progress: {
        value: false
      },
    },

    inputs: 1,
    outputs: 1,

    label: function() {
      return (this.name || this._def.paletteLabel || this._def.type) + " " + (this.direction == "extract" ? "⤏" : "⤎")
    },

    labelStyle: function() {
      return this.name?"node_label_italic":"";
    },

    onpaletteadd: function() {
    },

    oneditprepare: function() {
      $("#node-input-direction").val(this.direction)
      $("#node-input-format").val(this.format)

      $("#node-input-dirnameproperty").typedInput({
        types: ["msg", "jsonata", "str"],
        typeField: "#node-input-dirnamepropertyType"
      });
      
      $("#node-input-dirnameproperty").val(this.dirnameproperty)
      $("#node-input-dirnamepropertyType").val(this.dirnamepropertyType)

      $('#node-input-progress').val(this.progress)
    },

    oneditcancel: function() {
    },

    oneditsave: function() {
    },

    onpaletteremove: function() {
    },
  });
})();
</script>

<script type="text/html" data-template-name="ArchiveStream">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
    <input type="text" id="node-input-name" data-i18n="[placeholder]node-red:common.label.name">
  </div>

  <div class="form-row">
    <label for="node-input-format"><i class="fa fa-tasks"></i> <span data-i18n="archivestream.label.format"></span></label>
    <select type="text" id="node-input-format" style="width:70%;">
      <option value="tar">Tar</option>
      <option value="zip">Zip</option>
    </select>
  </div>
  
  <div class="form-row">
    <label for="node-input-direction"><i class="fa fa-tasks"></i> <span data-i18n="archivestream.label.direction"></span></label>
    <select type="text" id="node-input-direction" style="width:70%;">
      <option value="extract">extract</option>
      <option value="compress">compress</option>
    </select>
  </div>

  <div class="form-row">
    <label for="node-input-dirnameproperty"><i class="fa fa-tag"></i> Dirname</label>
    <input type="text" id="node-input-dirnameproperty" placeholder="dirname">
    <input type="hidden" id="node-input-dirnamepropertyType"value="msg">
  </div>


  <div class="form-row">
    <label for="node-input-progress">
      <span data-i18n="archivestream.label.showprogress">
    </label>
    <input type="checkbox" id="node-input-progress" style="display:inline-block; width:15px; vertical-align:baseline;">
  </div>
</script>
<script type="text/html" data-help-name="ArchiveStream">
  <p>Various nodes to do various stuff releated to streaming</p>
  Various nodes to do stuff with streaming
</script>

<!-- --- [red-module:@gregoriusrippenstein/node-red-streaming/pipeend] --- -->
<script type="text/javascript">
(function(){
  RED.nodes.registerType('PipeEnd',{
    color: '#e5e4ef',
    icon: "font-awesome/fa-bullseye",
    category: 'streaming',
    defaults: {
      name: {
        value:"",
      },
      
      /* minify node but can be changed in the properties menu */
      l: { value: false }
    },

    inputs: 1,

    outputs: 1,

    label: function() {
      return (this.name || this._def.paletteLabel);
    },
    
    labelStyle: function() {
      return this.name?"node_label_italic":"";
    },

    onpaletteadd: function() {
    },

    oneditprepare: function() {
    },

    oneditcancel: function() {
    },

    oneditsave: function() {
    },

    onpaletteremove: function() {
    },
  });
})();
</script>

<script type="text/html" data-template-name="PipeEnd">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
    <input type="text" id="node-input-name" data-i18n="[placeholder]node-red:common.label.name">
  </div>
</script>
<script type="text/html" data-help-name="PipeEnd">
  <p>Various nodes to do various stuff releated to streaming</p>
  Various nodes to do stuff with streaming
</script>

<!-- --- [red-module:@martip/node-red-xlsx/xlsx] --- -->
<script type="text/html" data-template-name="xlsx">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</span></label>
    <input type="text" id="node-input-name" placeholder="Name" />
  </div>
  <hr align="middle"/>
  <div class="form-row">
    <label style="width:100%;">XLSX to Object options</span></label>
  </div>
  <div class="form-row" style="padding-left: 20px;">
    <label><i class="fa fa-sign-in"></i> Input</span></label>
    <select type="text" id="node-input-sheets" style="width:250px;">
      <option value="first">read the first sheet only</option>
      <option value="all">read all sheets</option>
    </select>
  </div>
  <div class="form-row" style="padding-left: 20px;">
    <label><i class="fa fa-sign-out"></i> Output</span></label>
    <select type="text" id="node-input-multi" style="width:250px;">
      <option value="one">a message per sheet</option>
      <option value="array">a single message [array]</option>
      <option value="object">a single message {object}</option>
    </select>
    <select type="text" id="node-input-parse" style="width:250px; display: none;">
      <option value="rows">an array of rows</option>
      <option value="map">a JSON object using a map</option>
    </select>
  </div>
  <div class="form-row" id="map-options" style="padding-left: 20px; display: none;">
    <label></label>
    <label style="width: 50px; margin-right: 10px; text-align: right;" for="node-input-map">Map</span></label>
    <input type="text" id="node-input-map" style="width: 185px;" />
  </div>  
</script>



<script type="text/javascript">
  RED.nodes.registerType('xlsx', {
      category: 'parser',
      color:'#DEBD5C',
      defaults: {
        name: { value: '' },
        sheets: { value: 'first', required: true },
        multi: { value: 'one', required: true },
        parse: { value: 'rows', required: true },
        map: { value: '' }
      },
      inputs: 1,
      outputs: 1,
      icon: 'xlsx.svg',
      label: function() {
        return this.name || 'xlsx' ;
      },
      labelStyle: function() {
        return this.name ? 'node_label_italic' : '';
      },
      paletteLabel: 'xlsx',
      oneditprepare: function() {
        $('#node-input-sheets').val(this.sheets);
        $('#node-input-multi').val(this.multi);
        $('#node-input-parse').val(this.parse);
        $('#node-input-sheets').on('change', function() {
          if ($('#node-input-sheets').val() === 'first') {
            $('#node-input-multi').val('one');
            $('#node-input-multi').hide();
            $('#node-input-parse').show().focus();
            $('#node-input-parse').change();
          } else {
            $('#node-input-parse').val('rows');
            $('#node-input-parse').hide();
            $('#schema-options').hide();
            $('#map-options').hide();
            $('#node-input-multi').show().focus();
          }
        });
        $('#node-input-parse').on('change', function() {
          const v = $('#node-input-parse').val();
          if (v === 'rows') {
            $('#map-options').hide();
          } else if (v === 'map') {
            $('#map-options').show();
          }
        });
        $('#node-input-map').typedInput({
          type:'json',
          types:['json']
        });

      }
  });
</script><script type="text/html" data-help-name="xlsx">
  <p>A function that parses the <code>msg.payload</code>, expected to be in XLSX format, using the <strong>read-excel-file</strong> package.</p>
  <h3>Inputs</h3>
  <dl class="message-properties">
    <dt>payload <span class="property-type">buffer</span></dt>
    <dd>The buffer of the XSLX file.</dd>
  </dl>
  <h3>Outputs</h3>
  <dl class="message-properties">
    <dt>filename <span class="property-type">string</span></dt>
    <dd>The name of the XSLX file.</dd>
  </dl>
  <dl class="message-properties">
    <dt>payload <span class="property-type">object | array</span></dt>
    <dd>The parsed XLSX file as an array or object</dd>
  </dl>
  <h3>Details</h3>
  <p>The node can process the first sheet or all the sheets of a workbook.</p>
  <p>By default, the node outputs an array of arrays (the rows of the sheet), for each processed sheet.</p>
  <p>When parsing only the first sheet, an optional JSON map can be provided: in this case, the output will be a JSON object (check the <strong>read-excel-file</strong> package documentation for more information; please note that the <i>schema</i> option is not implemented in this node).</p>
  <p>When parsing all the sheets in a workbook, the output is sent as a single message or as multiple messages (one for each sheet).</p>
  <p>If the output is sent as a single message, the payload will be an array of arrays or as an object, in which the keys are the names of the sheets.</p>
  <h3>References</h3>
  <ul>
    <li><a href="https://www.npmjs.com/package/read-excel-file">read-excel-file</a> - Details of the <strong>read-excel-file</strong> package</li>
  </ul>
  

</script>
<!-- --- [red-module:node-red-contrib-aedes/aedes-mqtt-broker] --- -->
<!--
  Copyright 2013,2014 IBM Corp.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/x-red" data-template-name="aedes broker">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]node-red:common.label.name">
    </div>
    <div class="form-row">
        <ul style="min-width: 600px; margin-bottom: 20px;" id="node-config-aedes-broker-tabs"></ul>
    </div>
    <div id="node-config-aedes-broker-tabs-content" style="min-height:150px;">
        <div id="aedes-broker-tab-connection" style="display:none">
            <div class="form-row">
                <label for="node-input-mqtt_port"><i class="fa fa-globe"></i> <span data-i18n="aedes-mqtt-broker.label.mqtt_port"></span></label>
                <input type="text" id="node-input-mqtt_port" data-i18n="[placeholder]aedes-mqtt-broker.placeholder.mqtt_port">
            </div>
            <div class="form-row">
                <label for="node-input-mqtt_ws_bind"><i class="fa fa-globe"></i> WS bind</label>
                <select id="node-input-mqtt_ws_bind" type="text" style="width:30%" text-center>
                <option value="path" default>path</option>
                <option value="port">port</option>
                </select>
            </div>
            <div class="form-row" id="node-input-mqtt_ws_path-label">
                <label for="node-input-mqtt_ws_path"><i class="fa fa-globe"></i> <span data-i18n="aedes-mqtt-broker.label.mqtt_ws_path"></label>
                <input type="text" id="node-input-mqtt_ws_path" data-i18n="[placeholder]aedes-mqtt-broker.placeholder.mqtt_ws_path">
            </div>
            <div class="form-row" id="node-input-mqtt_ws_port-label">
                <label for="node-input-mqtt_ws_port"><i class="fa fa-globe"></i> <span data-i18n="aedes-mqtt-broker.label.mqtt_ws_port"></label>
                <input type="text" id="node-input-mqtt_ws_port" data-i18n="[placeholder]aedes-mqtt-broker.placeholder.mqtt_ws_port">
            </div>
            <div class="form-row">
                <input type="checkbox" id="node-input-usetls" style="display: inline-block; width: auto; vertical-align: top;">
                <label for="node-input-usetls" style="width: auto" data-i18n="aedes-mqtt-broker.label.use-tls"></label>
                <div id="node-input-tls" class="hide">
                    <div class="form-row">
                        <label style="width: 120px;"><i class="fa fa-file-text-o"></i> <span data-i18n="aedes-mqtt-broker.label.cert"></span></label>
                        <span class="tls-input-data">
                            <label class="red-ui-button" for="node-input-certfile"><i class="fa fa-upload"></i> <span data-i18n="aedes-mqtt-broker.label.upload"></span></label>
                            <input class="hide" type="file" id="node-input-certfile">
                            <span id="tls-certname" style="width: calc(100% - 280px); overflow: hidden; line-height:34px; height:34px; text-overflow: ellipsis; white-space: nowrap; display: inline-block; vertical-align: middle;"> </span>
                            <button class="red-ui-button red-ui-button-small" id="tls-button-cert-clear" style="margin-left: 10px"><i class="fa fa-times"></i></button>
                        </span>
                        <input type="hidden" id="node-input-certname">
                        <input type="hidden" id="node-input-certdata">
                        <input class="hide tls-input-path" style="width: calc(100% - 170px);" type="text" id="node-input-cert" data-i18n="[placeholder]aedes-mqtt-broker.placeholder.cert">
                    </div>
                    <div class="form-row">
                        <label style="width: 120px;" for="node-input-key"><i class="fa fa-file-text-o"></i> <span data-i18n="aedes-mqtt-broker.label.key"></span></label>
                        <span class="tls-input-data">
                            <label class="red-ui-button" for="node-input-keyfile"><i class="fa fa-upload"></i> <span data-i18n="aedes-mqtt-broker.label.upload"></span></label>
                            <input class="hide" type="file" id="node-input-keyfile">
                            <span id="tls-keyname" style="width: calc(100% - 280px); overflow: hidden; line-height:34px; height:34px; text-overflow: ellipsis; white-space: nowrap; display: inline-block; vertical-align: middle;"> </span>
                            <button class="red-ui-button red-ui-button-small" id="tls-button-key-clear" style="margin-left: 10px"><i class="fa fa-times"></i></button>
                        </span>
                        <input type="hidden" id="node-input-keyname">
                        <input type="hidden" id="node-input-keydata">
                        <input class="hide tls-input-path" style="width: calc(100% - 170px);" type="text" id="node-input-key" data-i18n="[placeholder]tls.placeholder.key">
                    </div>
                </div>
            </div>
            <div class="form-row">
              <label for="node-input-persistence_bind"><i class="fa fa-globe"></i> <span data-i18n="aedes-mqtt-broker.label.persistence_bind"></label>
              <select id="node-input-persistence_bind" type="text" style="width:30%" text-center>
                  <option value="memory" data-i18n="aedes-mqtt-broker.label.persistence_memory" default></option>
                  <option value="mongodb" data-i18n="aedes-mqtt-broker.label.persistence_mongodb"></option>
                  <option value="level" data-i18n="aedes-mqtt-broker.label.persistence_level"></option>
              </select>
          </div>
            <div class="form-row" id="node-row-dburl" class="hide">
                <label for="node-input-dburl"><i class="fa fa-database"></i> <span data-i18n="aedes-mqtt-broker.label.dburl"></label>
                <input type="text" id="node-input-dburl" data-i18n="[placeholder]aedes-mqtt-broker.placeholder.dburl">
            </div>
        </div>
        <div id="aedes-broker-tab-security" style="display:none">
            <div class="form-row">
                <label for="node-input-username"><i class="fa fa-user"></i> <span data-i18n="node-red:common.label.username"></span></label>
                <input type="text" id="node-input-username" data-i18n="[placeholder]aedes-mqtt-broker.placeholder.username">
            </div>
            <div class="form-row">
                <label for="node-input-password"><i class="fa fa-lock"></i> <span data-i18n="node-red:common.label.password"></span></label>
                <input type="password" id="node-input-password" data-i18n="[placeholder]aedes-mqtt-broker.placeholder.password">
            </div>
        </div>
    </div>
</script>

<script type="text/javascript">
  RED.nodes.registerType('aedes broker', {
    category: 'network',
    defaults: {
      name: { value: '' },
      mqtt_port: { value: 1883, validate: RED.validators.number() },
      mqtt_ws_bind: { value: 'port', required: true },
      mqtt_ws_port: { value: null, required: false, validate: RED.validators.number(true) },
      mqtt_ws_path: { value: '', required: false },
      cert: {
        value: '',
        validate: function (v) {
          var currentKey = $('#node-input-key').val();
          if (currentKey === undefined) {
            currentKey = this.key;
          }
          return currentKey === '' || v !== '';
        }
      },
      key: {
        value: '',
        validate: function (v) {
          var currentCert = $('#node-input-cert').val();
          if (currentCert === undefined) {
            currentCert = this.cert;
          }
          return currentCert === '' || v !== '';
        }
      },
      certname: { value: '' },
      keyname: { value: '' },
      persistence_bind: { value: 'memory', required: true },
      dburl: { value: '', required: false },
      usetls: { value: false }
    },
    credentials: {
      username: { type: 'text' },
      password: { type: 'password' },
      certdata: { type: 'text' },
      keydata: { type: 'text' }
    },
    color: '#d8bfd8',
    inputs: 0,
    outputs: 2,
    icon: 'aedes.png',
    label: function () {
      return this.name || 'Aedes MQTT broker';
    },
    labelStyle: function () {
      return this.name ? 'node_label_italic' : '';
    },
    outputLabels: ['events', 'publish'],
    oneditprepare: function () {
      var tabs = RED.tabs.create({
        id: 'node-config-aedes-broker-tabs',
        onchange: function (tab) {
          $('#node-config-aedes-broker-tabs-content').children().hide();
          $('#' + tab.id).show();
        }
      });
      tabs.addTab({
        id: 'aedes-broker-tab-connection',
        label: this._('aedes-mqtt-broker.tabs-label.connection')
      });
      tabs.addTab({
        id: 'aedes-broker-tab-security',
        label: this._('aedes-mqtt-broker.tabs-label.security')
      });
      setTimeout(function () {
        tabs.resize();
      }, 0);

      if (typeof this.mqtt_ws_bind === 'undefined') {
        this.mqtt_ws_bind = 'port';
        $('#node-input-mqtt_ws_bind').text('Port');
      }
      $('#node-input-mqtt_ws_bind').on('change', function () {
        var wsPathLabel = $('#node-input-mqtt_ws_path-label');
        var wsPortLabel = $('#node-input-mqtt_ws_port-label');
        switch ($(this).val()) {
          case 'path':
            wsPathLabel.show();
            wsPortLabel.hide();
            break;
          case 'port':
            wsPathLabel.hide();
            wsPortLabel.show();
            break;
          default:
            wsPathLabel.hide();
            wsPortLabel.show();
            break;
        }
      });

      const persistenceInput = $('#node-input-persistence_bind');
      const dburlRow = $('#node-row-dburl');
      const dburl = this.dburl;
      persistenceInput.on('change', function () {
        switch ($(this).val()) {
          case 'memory':
            dburlRow.hide();
            break;
          case 'mongodb':
            dburlRow.show();
            break;
          case 'level':
            dburlRow.hide();
            break;
          case null:
            if (dburl) {
              this.persistence_bind = 'mongodb';
              persistenceInput.val('mongodb');
              dburlRow.show();
            } else {
              this.persistence_bind = 'memory';
              persistenceInput.val('memory');
              dburlRow.hide();
            }
            break;
        }
      });

      if (typeof this.usetls === 'undefined') {
        this.usetls = false;
        $('#node-input-usetls').prop('checked', false);
      }
      function updateTLSOptions () {
        if ($('#node-input-usetls').is(':checked')) {
          $('#node-input-tls').show();
        } else {
          $('#node-input-tls').hide();
        }
      }

      updateTLSOptions();

      function saveFile(property, file) {
        var dataInputId = '#node-input-' + property + 'data';
        var filenameInputId = '#node-input-' + property + 'name';
        var filename = file.name;
        var reader = new FileReader();
        reader.onload = function (event) {
          $('#tls-' + property + 'name').text(filename);
          $(filenameInputId).val(filename);
          $(dataInputId).val(event.target.result);
        };
        reader.readAsText(file, 'UTF-8');
      }
      $('#node-input-usetls').on('click', function () {
        updateTLSOptions();
      });
      $('#node-input-certfile').on('change', function () {
        saveFile('cert', this.files[0]);
      });
      $('#node-input-keyfile').on('change', function () {
        saveFile('key', this.files[0]);
      });
      function clearNameData(prop) {
        $('#tls-' + prop + 'name').text('');
        $('#node-input-' + prop + 'data').val('');
        $('#node-input-' + prop + 'name').val('');
      }
      $('#tls-button-cert-clear').on('click', function () {
        clearNameData('cert');
      });
      $('#tls-button-key-clear').on('click', function () {
        clearNameData('key');
      });

      function updateFileUpload() {
        $('.tls-input-data').show();
        $('.tls-input-path').hide();
      }
      $('#tls-certname').text(this.certname);
      $('#tls-keyname').text(this.keyname);
      $('#tls-caname').text(this.caname);
      updateFileUpload();
    },
    oneditsave: function () {
      if (!$('#node-input-usetls').is(':checked')) {
        $('#node-input-tls').val('');
      }
      $('#node-input-cert').val('');
      $('#node-input-key').val('');
    }
  });
</script>
<script type="text/x-red" data-help-name="aedes broker">
    <p>MQTT broker based on Barebone MQTT broker Aedes. You can use MQTT-in and MQTT-out nodes without an external broker like Mosquitto.</p>
    <h3>Outputs</h3>
        <dl class="message-properties">
            <dt>topic <span class="property-type">string</span></dt>
            <dd>the topic of the event.</dd>
            <dt>payload 1<span class="property-type">object</span></dt>
            <dd>the content of all events from the broker except publish.</dd>
            <dt>payload 2<span class="property-type">object</span></dt>
            <dd>the content of the publish events from the broker.</dd>

        </dl>
    <h3>Details</h3>
    <h3>References</h3>
        <ul>
            <li><a href="https://github.com/moscajs/aedes">Aedes</a> - Barebone MQTT broker that can run on any stream server, the node way</li>
        </ul>
</script>

<!-- --- [red-module:node-red-contrib-blockly/blockly] --- -->
<!--
  Copyright 2018, Bart Butenaers
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at
  http://www.apache.org/licenses/LICENSE-2.0
  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/javascript">
    function loadResourcesFromServer(node, language, categories) {
        var lastScriptToLoad;
        
        // When no categories are passed (e.g. when there is no config node selected), then use the default categories
        if (!categories) {
            categories = getDefaultBlocklyCategories();
        }
        
        // Create a deep clone of the original category array (from the config node), to make sure the original array isn't updated by this function
        categories = JSON.parse(JSON.stringify(categories));
        
        node.librariesLoaded = false;
        
        // Remove all the custom blockly scripts from the previous time.
        // Because suppose a library has been removed in the config screen, then it would otherwise still be loaded and be used by blockly.
        $('script[data-custom_blockly_library=true]').remove();

        // Make sure that all standard Blockly library files are loaded FIRST AND IN THE CORRECT ORDER, by adding a dummy category.
        // Don't use jQuery or script tags (see https://discourse.nodered.org/t/scope-of-variables-in-external-js-scripts/1048/2).
        // The en.js file should be loaded before the blocks_compressed.js library, to avoid "No message string for..." console warnings.
        categories.unshift({
            name: "Dummy category",
            files: [
                "blockly-contrib/npm/blockly/blockly_compressed.js",    // Creates a global Blockly variable
                "blockly-contrib/npm/blockly/msg/en.js",                // Fills the Blockly.Msg with english translations
                "blockly-contrib/npm/blockly/blocks_compressed.js",
                "blockly-contrib/npm/blockly/javascript_compressed.js",
                // When the npm package name contains a path separator (e.g. @blockly/plugin-workspace-search) then the frontend will
                // need to replace that separator by the string "___SEPARATOR___".  Otherwise the NGinx webserver installed together
                // with HomeAssistant will cause the Express.js routes to be messed up.
                // See https://github.com/bartbutenaers/node-red-contrib-blockly/issues/101
                "blockly-contrib/npm/@blockly___SEPARATOR___plugin-workspace-search/dist/index.js",
                "blockly-contrib/npm/@blockly___SEPARATOR___zoom-to-fit/dist/index.js",
                "blockly-contrib/npm/@blockly___SEPARATOR___workspace-backpack/dist/index.js",
                "blockly-contrib/npm/@blockly___SEPARATOR___toolbox-search/dist/index.js",
                "blockly-contrib/npm/@blockly___SEPARATOR___workspace-minimap/dist/index.js"
            ]
        });

        // When another (not-english) language has been selected, then the english files should be loaded first.
        // And afterwards the other language files will be loaded.  That way there won't be a problem if some of
        // the texts have not been translated: they will simply be showed in english.
        // Note that the standard blockly en.js file contains a statement to clear all the Blockly.msg messages,
        // which means this one needs to be loaded first.  And all translations also have to be reloaded afterwards ...
        if (language != "en") {
            categories.forEach(function(category) {
                (category.files || []).forEach(function(file) {
                    if(file.endsWith("/en.js")) {
                        var translationFile = file.replace("/en.js", "/" + language + ".js");
                        category.files.push(translationFile);
                    }
                });
            });
        }

        // As soon as the toolbox files have been loaded, the javascript files for the categories will be loaded.
        // The javascript files will be loaded synchronous, because there is a dependency order that needs to be fullfilled.
        // However the files will be loaded in background, so we need to wait for an event that indicates that the script is loaded...
        categories.forEach(function(category) {
            (category.files || []).forEach(function(file) {
                // Note that the english language files have already been handled above...
                if(file.endsWith(".js")) {
                    // Make sure that all Blockly library files are loaded in the correct order.
                    // Don't use jQuery (see https://discourse.nodered.org/t/scope-of-variables-in-external-js-scripts/1048/2)
                    lastScriptToLoad = document.createElement('script');
                    lastScriptToLoad.type="text/javascript";
                    lastScriptToLoad.async = false; // Force synchronous loading, to load them in the correct sequence
                    lastScriptToLoad.src = file; 
                    // Set a user attribute on the script element, to allow us to identify it afterwards as on of the blockly related libs
                    // https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement/dataset
                    lastScriptToLoad.dataset.custom_blockly_library = true;
                    document.head.appendChild(lastScriptToLoad);
                }
            });
        });
        
        // Currently only JS and XML files are allowed.  Not sure yet how to handle other types.
        categories.forEach(function(category) {
            (category.files || []).forEach(function(file) {                
                if(!file.endsWith(".js") && !file.endsWith(".xml")) {
                    console.log("Unknown resource type (" + file + ")");
                }
            });
        });
        
        // The workspace can only be created when all script files have been loaded, otherwise errors will occur...
        // By loading the standard Blockly library again, a new Blockly instance will be created which must be initialized here.
        // And then the language files can be loaded into the new empty Blockly.Msg
        lastScriptToLoad.onload = function() {
            node.librariesLoaded = true;
            
            Blockly.blocklyEditorVisible = true;

            // Make sure the Blockly datetime_convert_from_date block is always aware about the number of outputs
            Blockly.blocklyEditorLanguage = language;
                
            // Make sure the Blockly node_send and node_return_message blocks are already at the beginning aware about the number of outputs
            Blockly.nodeOutputs = node.outputs

            // The 'msg' variable represents the parameter from the Node-Red 'input' event.
            // By adding it as a reserved wordt in Javascript, we can avoid that users create their own 'msg' variable.
            // Idem for the 'global', 'flow' and 'context' memory in Node-Red.
            Blockly.JavaScript.addReservedWords(['msg', 'flow', 'context', 'global']);
            
            // Blockly has an onKeyDown handler, that handles a number of key combinations (ctrl-'C' to copy the selected
            // blocks, 'D' to delete the selected blocks, ctrl-'Z' to undo the last action).  However afterwards the keydown event
            // is passed to Node-Red which cannot handle it, resulting in errors in the log.
            // See https://github.com/bartbutenaers/node-red-contrib-blockly/issues/2
            // Make sure that Blockly only handles the keydown events when the Blockly editor is visible, and otherwise Node-Red will handle them.
            if (Blockly.blocklyEditorVisible === undefined) {
                Blockly.originalKeyDownHandler = Blockly.onKeyDown_;
                Blockly.onKeyDown_ = function(e) {
                    if (Blockly.blocklyEditorVisible) {
                        // Let Blockly handle the keydown event
                        Blockly.originalKeyDownHandler(e);
                        
                        // 
                        if (e.altKey || e.ctrlKey || e.metaKey) {
                            // Don't use meta keys during drags
                            if (!Blockly.mainWorkspace.isDragging()) {
                                // When pressing CTRL-V (paste) ...
                                if (e.keyCode == 86) {
                                    if (!Blockly.clipboardXml_ && Blockly.customClipboard) {
                                        // When the originalClipboardXml_ is null and the customClipboard is not empty, this means
                                        // we need to paste blocks that have been copied (to the customClipboard) in another node.
                                        var xmlDom = Blockly.Xml.textToDom(Blockly.customClipboard);
                                        Blockly.Xml.domToWorkspace(xmlDom, Blockly.mainWorkspace);
                                    }
                                }
                            }
                        }
                        
                        // Stop the events from propagating up the DOM tree
                        e.stopPropagation();
                    }
                }
            }
            
            if (document.implementation.createDocument) {
                // Create a new XML document (which represents a toolbox), and keep it as a global variable.
                // All toolbox.xml files will be loaded and combined into the XML document.  
                // As soon as the XML document is complete, the toolbox will be displayed.
                // In e.g. Chrome you can skip the third parameter, but e.g. in Firefox you need at least pass a null.
                node.toolboxXmlDocument = document.implementation.createDocument("https://developers.google.com/blockly/xml", "xml", null);
            }
            else {
                console.error('This browser cannot create a Blockly toolbox XML document (via createDocument)');
                return;
            }

            // Load the toolbox (XML) files for all categories.  This is done synchronous to make sure they are displayed in the specified order.
            categories.forEach(function(category) {
                (category.files || []).forEach(function(file) {                
                    if(file.endsWith(".xml")) {
                        var request = new XMLHttpRequest();
                        request.open('GET', file, false);  // `false` makes the request synchronous
                        request.send();
                    
                        if (request.readyState == 4 && request.status == 200) {
                            // Get all categories in the new XML document
                            var newCategories = request.responseXML.getElementsByTagName("category");
                    
                            // Iterate backwards since categories can be moved away from this list (to the toolbox)
                            // 2021-03-25 Jeff: changed to while-loop to accommadate nested categories
                            while (newCategories.length > 0) {
                                var newCategory = newCategories[0];
                                

                                // Get the category name
                                var name = newCategory.getAttribute('name');

                                // Try to find an existing category with the same name.
                                // Indeed multiple toolboxes can put blocks in the same category...
                                var existingCategory = node.toolboxXmlDocument.getElementsByName(name);
                                
                                if (existingCategory.length === 0) {
                                    // If the new category didn't exist yet in the toolbox, append the entire new category to the toolbox
                                    node.toolboxXmlDocument.documentElement.appendChild(newCategory);
                                }
                                else {
                                    var newBlocks = newCategory.children;

                                    // Move all the blocks (and their children) from the newCategory to the existingCategory.
                                    // Remark: appendChild will remove the block from newBlocks!
                                    while(newBlocks.length > 0) {
                                        existingCategory[0].appendChild(newBlocks[0]);
                                    }
                                    // Remove the category from newCategories so the next loop is clean
                                    newCategory.remove();
                                }
                            }
                        }
                        else {
                            console.error("The toolbox XML files for Blockly cannot be loaded"); 
                        }
                    }
                });
            });

            // // Add a 'Search' category at the end, which is linked automatically by Blockly to the toolbox-search plugin.
            const searchElement = document.createElementNS("http://www.w3.org/1999/xhtml", "category");
            searchElement.setAttribute("name", "Search");
            searchElement.setAttribute("kind", "search");
            // When the search input field is clicked, a blue background appears.
            // I tried to apply as color the same color as the background color (grey), but it doesn't help.
            // The same happens in the official plugin demo (https://google.github.io/blockly-samples/plugins/toolbox-search/test/index.html)
            searchElement.setAttribute("colour", "#B2B2B2"); // Same color as the background
            node.toolboxXmlDocument.documentElement.appendChild(searchElement);

            load_themes();

            // Create the workspace as soon as the last script has been loaded.  
            // This is possible because the scripts are loaded sequentially (via async = false)
            createWorkspace(node, node.workspaceXml);
        }
    }

    let theme_guard = false;

    async function load_themes() {

        if (theme_guard) {
            return;
        }

        theme_guard = true;

        // Load the themes
        let _themes = [
            "dark",
            "deuteranopia",
            "highcontrast",
            "modern",
            "tritanopia"
        ];

        // Ralph:
        // Initially Bart tried to import the Blockly Theme modules the conventional way:
        //   node.themeModule = await import("/blockly-contrib/npm/@blockly___SEPARATOR___theme-" + theme + "/dist/index.js");
        // This yet runs into "Cannot read properties of undefined (reading 'Blockly')".
        // Looks like there's an issue with the webpackUniversalModuleDefinition implementation. I found no way to compensate for this. Bad.
        // As "[...]/src/index.js" is the pure code file (not being wrapped into the webpackUniversalModuleDefinition stuff), I tried to import from there.
        // Fails as well, as "import Blockly from 'blockly/core'" cannot be resolved.
        // The good thing: We don't need this import at all! 'Blockly' is guaranteed to be already defined!
        // Fortunately, the Blockly Theme plugins follow a very simple & identical pattern - supporting the following hack:
        // * Get the script as text from the runtime.
        // * Remove "import Blockly from 'blockly/core';" from the script.
        // * Replace "export default ..." statement by a simple "return".
        // * Wrap this script into a self executing function, to assign its value to the "Blockly.Themes" object.
        // * Do those steps for all defined themes.
        // * Create a script tag and let it execute the generated code.
        // Works like a charm!

        let _script = ["Blockly.Themes = Blockly.Themes ?? {}"];
        _script.push("Blockly.Themes['classic'] = Blockly.Themes.Classic");

        for (const thm of _themes) {

            let request = new XMLHttpRequest();
            request.open('GET', `/blockly-contrib/npm/@blockly___SEPARATOR___theme-${thm}/src/index.js`, false);  // `false` makes the request synchronous
            request.send();
            if (request.readyState == 4 && request.status == 200) {
                let data = request.response;
                data = data.replace("import Blockly from 'blockly/core';", "");
                data = data.replace("export default Blockly.", "return Blockly.");
                _script.push(`Blockly.Themes["${thm}"] = (function() {${data}})();`);
            } else {
                console.log(`Failed to load plugin for Blockly Theme "${thm}": ${request.response}`);
            }
        }

        _script = _script.join(";\r\n");
        
        let script = document.createElement('script');
        script.type= "text/javascript";
        script.async = false; // Force synchronous loading, to load them in the correct sequence
        script.text = _script;
        script.dataset.custom_blockly_library = true;
        document.head.appendChild(script);

        theme_guard = false;
    }

    function createWorkspace(node, workspaceXml) {
        // Default settings in case no config node has been specified
        var showTrashcan     = true;
        var allowComments    = true;
        var showZoomControl  = true;
        var showMiniMap      = true;
        var horizontalLayout = false;
        var enableBackPack   = false;
        var toolboxPosition  = "start";
        var renderer         = "geras";
        var theme            = "classic";
        var configNodeId     = "";
        var backpackContents = [];

        // When a config node has been specified, then use the settings from that node
        if (node.selectedConfigNodeId && node.selectedConfigNodeId !== "_ADD_") {
            var configNode = RED.nodes.node(node.selectedConfigNodeId);
            
            if (configNode) {
                showTrashcan    = configNode.showTrashcan;
                allowComments   = configNode.allowComments;
                showZoomControl = configNode.showZoomControl;
                showMiniMap     = configNode.showMiniMap;
                renderer        = configNode.renderer;
                theme           = configNode.theme;
                enableBackPack  = configNode.enableBackPack;
                configNodeId    = configNode.id;
 
                // The toolboxPosition from the config screen determines two separate blockly settings!
                switch(configNode.toolboxPosition) {
                    case "left":
                        horizontalLayout = false;
                        toolboxPosition  = "start";                    
                        break;
                    case "right":
                        horizontalLayout = false;
                        toolboxPosition  = "end";   
                        break;
                    case "top":
                        horizontalLayout = true;
                        toolboxPosition  = "start";   
                        break;
                }
            }
        }
        
        // When previously a zoom-to-fit plugin has been activated, then clean it up
        if (node.zoomToFit) {
            node.zoomToFit.dispose();
            node.zoomToFit = null;
        }

        // Persist the backpack content, to make sure it can be restored in new workspace instances (e.g. when switching to full-screen mode).
        // If backpack is not enabled, further on a new workspace setting will be created without backpack ...
        if (enableBackPack) {
            // Note that the backpack instance is linked to this node (since the corresponding workspace instance is also stored in this node), 
            // but its content will be stored in the config node in the oneditsave...
            
            if (!node.backpack || configNodeId !== node.previousConfigNodeId) {
                if (node.selectedConfigNodeId && node.selectedConfigNodeId !== "_ADD_") {
                    var configNode = RED.nodes.node(node.selectedConfigNodeId);
                    if (configNode) {
                        // Start from scratch (starting from the backpack content stored in the config node) when:
                        // 1) There was previously no backpack activated in this node workspace, which means the user has enable the backpack now.
                        // 2) The config node has changed.  Since enableBackPack is true, the user has selected another config node with its own backpack enabled.
                        backpackContents = configNode.backpackContents;
                    }
                }
            }
            else {
                if (node.backpack) {
                    // We are still using the same config node.  Since the user might already have made changes to the config node backpack, we need
                    // to start again from the previous backpack instance in this workspace (since that would contain those changes).
                    // Otherwise all changes would be lost...
                    backpackContents = node.backpack.getContents();
                }
            }
        }
        
        // Remember the current config node id for the next time we arrive in this function
        node.previousConfigNodeId = configNodeId;
        
        // When previously a workspace-backpack plugin has been activated (for the previous workspace instance), then clean it up
        if (node.backpack) {
            node.backpack.dispose();
            node.backpack = null;
        }
        
        // Blockly requires an empty array for the content of an empty backpack (instead of undefined or null)
        if (!backpackContents) {
            backpackContents = [];
        }

        // When previously another workspace was already created, then cleanup that one first (to avoid displaying multiple workspaces).
        if (node.workspace) {
            node.workspace.dispose();
            node.workspace = null;
        }  

        // Ralph: This doesn't work!
        // try {
        //     // The theme plugins for Blockly are ES6 modules
        //     node.themeModule = await import("/blockly-contrib/npm/@blockly___SEPARATOR___theme-" + theme + "/dist/index.js");
        // }
        // catch (err) {
        //     console.error(err);
        // }

        // Only load the Blockly workspace when all libraries have been loaded yet, in order to avoid errors
        if (node.librariesLoaded == true) {
            // Create the workspace (with the specified settings)
            node.workspace = Blockly.inject('blocklyDiv', {
                grid: {
                    spacing: 25,
                    length: 3,
                    colour: '#ccc',
                    snap: true
                },     
                toolbox: node.toolboxXmlDocument.firstElementChild,
                zoom: {
                    controls: showZoomControl, 
                    wheel: true
                },
                renderer: renderer,
                theme: Blockly.Themes[theme],
                trashcan: showTrashcan,
                comments: allowComments,
                disable: true,
                scrollbars: true,
                horizontalLayout: horizontalLayout,
                toolboxPosition : toolboxPosition
            });
            
            // Enable the search bar on the workspace (via the workspace-search plugin)
            const workspaceSearch = new WorkspaceSearch(node.workspace);
            workspaceSearch.init();
            
            if (showZoomControl) {
                // Enable the zoom to fit control icon on the workspace (via the zoom-to-fit plugin)
                node.zoomToFit = new ZoomToFitControl(node.workspace);
                node.zoomToFit.init();
            }

            // Only show the minimap when the (fullscreen) tray is open, because the minimap is too big to fit into the node's config screen.
            if (showMiniMap && node.isTrayOpen) {
                // Enable the mini map on the workspace (via the workspace-minimap plugin)
                node.minimap = new PositionedMinimap(node.workspace);
                node.minimap.init();
            }

            if (enableBackPack) {
                // Enable the backpack icon on the workspace (via the workspace-backpack plugin)
                node.backpack = new Backpack(node.workspace);
                node.backpack.init();
                
                // Reload the previous backpack content, to make sure it stays the same in new workspace instances (e.g. when switching to full-screen mode)
                if (enableBackPack) {
                    // Show the required backpack content
                    node.backpack.setContents(backpackContents);
                }
            }
     
            // Trigger an event to indicate that a new Blockly workspace has been created.
            // Blockly doesn't offer such an event.  See https://groups.google.com/g/blockly/c/sSpvp_Kz-To
            // Such an event is required, because this node switches often its workspace (and some blocks need to be aware of that...).
            // Note that custom data needs to be passed via the 'detail' field...
            document.dispatchEvent(new CustomEvent("blocky_workspace_changed", {
                detail: {
                    newWorkspace: node.workspace
                }
            }));
            
            try {            
                // Load the workspace content again from the specified XML string
                var dom = Blockly.utils.xml.textToDom(workspaceXml);
                Blockly.Xml.domToWorkspace(dom, node.workspace); 
            }
            catch(err) {
                // We will arrive here when the current set of block libraries (as specified in the config node) doesn't support some blocks anymore.
                var errorText = "Some blocks will be removed from the workspace (because the current categories don't support them): " + err;
                
                // When the config screen of this node is openened, Node-RED will call twice the onchange handler of the config node.
                // To avoid that we would get the same error notification twice, we will skip one of both messages (during 1 second).
                if (node.errorNotificationTimer) {
                    clearTimeout(node.errorNotificationTimer);
                }
                node.errorNotificationTimer = setTimeout(function() {
                    RED.notify(errorText, "error");
                }, 500);

                // When some of the block definitions are missing, we will convert the workspace to Dom and back to workspace.
                // By doing that Blockly will remove the blocks without definition, and shows a workspace without those blocks.
                // That is much better compared to showing an empty workspace...
                // See https://groups.google.com/g/blockly/c/zdcUuRqWkxU/m/JfEdMv8MAQAJ
                var dom = Blockly.Xml.workspaceToDom(node.workspace);
                Blockly.Xml.domToWorkspace(dom, node.workspace);
            }
            
            // Make sure the workspace is sized correctly in the beginning
            resize(node);
            node.workspace.scrollCenter();
        }
    }
    
    function cleanup(node) {
        // Make sure that the Node-Red handles all keydown events again (e.g. 'D' to delete a node), instead of Blockly. 
        Blockly.blocklyEditorVisible = false;
        
        // When blocks are still available in Blockly's clipboard, Blockly CANNOT paste them in another workspace (of another node).
        // This means we can empty the clipboard (by setting it to null).  However we will store first a copy of their clipboard 
        // (as xml string) into our own custom clipboard, which we CAN use to paste in another workspace.
        if (Blockly.clipboardXml_) {
            Blockly.customClipboard = '<xml xmlns="https://developers.google.com/blockly/xml">' + Blockly.Xml.domToPrettyText(Blockly.clipboardXml_) + '</xml>';
            Blockly.clipboardXml_ = null;
        }
                            
        // When a copy is done in this blockly node, an error will occur if that content is pasted later in another blockly node.
        // Copy-paste across workspaces is not supported by Blockly (https://github.com/google/blockly/issues/334)
        Blockly.clipboardXml_ = null;
        Blockly.clipboardSource_ = null;

        // Cleanup the ACE editor
        node.aceEditor.destroy();
        delete node.aceEditor;

        // Jeff: Cleanup the XML editor 04/18/2021
        node.aceXMLEditor.destroy();
        delete node.aceXMLEditor;

        // When previously a zoom-to-fit plugin has been activated, then clean it up
        if (node.zoomToFit) {
            node.zoomToFit.dispose();
            node.zoomToFit = null;
        }

        // When previously a workspace-minimap plugin has been activated, then clean it up
        if (node.minimap) {
            node.minimap.dispose();
            node.minimap = null;
        }

        // When previously a workspace-backpack plugin has been activated (for the previous workspace instance), then clean it up
        if (node.backpack) {
            node.backpack.dispose();
            node.backpack = null;
        }

        // Cleanup the Blockly workspace
        node.workspace.dispose(); 
        delete node.workspace;
    }
    
    // See https://developers.google.com/blockly/guides/configure/web/resizable
    function resize(node) {        
        // Resize the Blockly workspace, as soon as available (i.e. not when called from oneditprepare).
        if (node.workspace) {
            var blocklyArea = document.getElementById('blocklyArea');
            var blocklyDiv = document.getElementById('blocklyDiv');

            // Compute the absolute coordinates and dimensions of blocklyArea.
            var element = blocklyArea;
            var x = 0;
            var y = 0;
            //do {
                x += element.offsetLeft;
                y += element.offsetTop;
            //    element = element.offsetParent;
            //} while (element);
            
            // Position blocklyDiv over blocklyArea.
            blocklyDiv.style.left = x + 'px';
            blocklyDiv.style.top = y + 'px';
            blocklyDiv.style.width = blocklyArea.offsetWidth + 'px';
            blocklyDiv.style.height = blocklyArea.offsetHeight + 'px';
            
            // Make sure the Blockly svg area is resized according the DIV element.
            // Blockly itself also calls svgResize underneath, but only when e.g. the toolbox changes size)
            Blockly.svgResize(node.workspace);
            
        }
    };
    
    function fillAceEditor(node) { 
        // Store the number of output ports in Blockly,  so the blocks can take that number into account (if required)
        //Blockly.nodeOutputs = $("#node-input-outputs").val();
    
        // Generate JavaScript code from the workspace content
        Blockly.JavaScript.INFINITE_LOOP_TRAP = null;
        var javascript = Blockly.JavaScript.workspaceToCode(node.workspace);
        
        // Show the generated Javascript code in the Ace editor
        node.aceEditor.setValue(javascript);
        
        // After setValue all code will be selected otherwise
        // Fix for clearSelection (see https://github.com/bartbutenaers/node-red-contrib-blockly/issues/74#issuecomment-862681796)
        node.aceEditor.moveCursorTo(0,0);
        
        /*
        // Count the number of (syntax) errors in the generated javascript code
        var errorCount = 0;
        var annotations = node.aceEditor.getSession().getAnnotations();
        for (var k=0; k < annotations.length; k++) {
            if (annotations[k].type === "error") {
                errorCount += annotations.length;
                break;
            }
        }
    
        // Give the "Javascript" tabsheet a red color if the generated javascript code contains (syntax) errors
        if (errorCount > 0) {
            $("#red-ui-tab-node-blockly-tab-javascript").css('background-color', "#EC7055");
        }
        else {
            // No (syntax) errors in the generated java
            $("#red-ui-tab-node-blockly-tab-javascript").css('background-color', "#FFFFFF");
        }
        */

    }


    function fillAceXMLEditor(node) {
        // Jeff: fill aceXMLEditor 04/18/2021
        // Store the number of output ports in Blockly,  so the blocks can take that number into account (if required)
        //Blockly.nodeOutputs = $("#node-input-outputs").val();

        // Generate JavaScript code from the workspace content
        var dom = Blockly.Xml.workspaceToDom(node.workspace);
        var loadedxml = Blockly.Xml.domToPrettyText(dom);
        // Show the generated XML code in the Ace editor
        node.aceXMLEditor.setValue(loadedxml);

        // After setValue all code will be selected otherwise
        // Fix for clearSelection (see https://github.com/bartbutenaers/node-red-contrib-blockly/issues/74#issuecomment-862681796)
        node.aceXMLEditor.moveCursorTo(0,0);
    }


    function reloadBlockly(node) {
        // Jeff: fill aceXMLEditor 04/18/2021
        var loadedXml = node.aceXMLEditor.getValue();
        //var dom = Blockly.Xml.textToDom(loadedXml);
        //node.workspace.clear();
        //Blockly.Xml.domToWorkspace(dom, node.workspace);
        createWorkspace(node, loadedXml);
    }

    RED.nodes.registerType('Blockly',{
        category: 'function',
        color: '#FFAAAA',       
        defaults: {
            // The generated Javascript code.
            // Make sure we start without (generated) javascript code, because the Blockly workspace is also empty for new nodes.
            // That way the (empty) Blockly workspace at startup is in sync with the (empty) Javascript tabsheet.
            func: {value:""},
            workspaceXml: {value:"<xml xmlns=\"https:\/\/developers.google.com\/blockly\/xml\"><\/xml>"}, // Needed for Blockly version "5.20210325.1". Can't be empty
            outputs: {value:1}, // Standard field that will be used by Node-Red to draw N output ports in the flow editor,
            timeout: {value:RED.settings.functionTimeout || 0},
            blocklyConfig: {type: "blockly-config", required: false}, // No default value (see https://discourse.nodered.org/t/default-config-node/46773/9?u=bartbutenaers)
            backpackContents: {value:[]},
            // Use the noerr property to let Node-RED know whether the generated Javascript contains a syntax error or not.
            // This way the flow editor knows whether a red triangle should be drawn for this node or not.
            // The noerr property will be filled in the oneditsave, since it is useless to check the code for syntax errors every time the validator is called.
            // Normally the generated function should never contain syntax errors, but due to an issue in the code generator in some block this might happen ...
            noerr: {value:0,required:true, validate:function(v) { return !v; }},
            name: {value:""}
        },
        inputs:1,
        outputs:1,
        icon: "font-awesome/fa-puzzle-piece",
        label: function() {
            return this.name||"Blockly";
        },
        oneditprepare: function() {
            var node = this;
            
            node.librariesLoaded = false;
            node.previousEnableBackPack = "none";
            node.isTrayOpen = false;

            // Show a default timeout value for older nodes 
            if(node.timeout === null || node.timeout === "" || (typeof node.timeout === "undefined")) {
                $("#node-input-timeout").val(RED.settings.functionTimeout || 0);
            }

            $("#node-input-outputs").spinner({
                min:1,
                change: function(event, ui) {
                    var value = this.value;
                    if (!value.match(/^\d+$/)) { value = 1;  }
                    else if (value < this.min) { value = this.min; }
                    if (value !== this.value) { $(this).spinner("value", value); }
                    
                    // Make sure the Blockly node_send and node_return_message blocks are always aware about the number of outputs
                    Blockly.nodeOutputs = parseInt(value);
                    
                    var blocks = node.workspace.getAllBlocks();
                    for(var i = 0; i < blocks.length; i++) {
                        if (blocks[i].type === "node_send" || blocks[i].type === "node_return_message") {
                            if( parseInt(blocks[i].getFieldValue('OUTPUT_NR')) > parseInt(value)) {
                                alert("There are '" + blocks[i].type.replace(/_/g, ' ') + "' blocks available that use a higher output number");
                                break;
                            }
                        }
                    }
                }
            });

            // 4294967 is max in node.js timeout.
            $("#node-input-timeout").spinner({
                min: 0,
                max: 4294967,
                change: function(event, ui) {
                    var value = this.value;
                    if(value == ""){
                        value = 0;
                    }
                    else
                    {
                        value = parseInt(value);
                    }
                    value = isNaN(value) ? 1 : value;
                    value = Math.max(value, parseInt($(this).attr("aria-valuemin")));
                    value = Math.min(value, parseInt($(this).attr("aria-valuemax")));
                    if (value !== this.value) { $(this).spinner("value", value); }
                }
            });

            node.aceEditor = RED.editor.createEditor({
                id: 'aceDiv',
                mode: 'ace/mode/nrjavascript', // serverside NodeRed editor
                value: node.func,
                readOnly: true,
                renderValidationDecorations: "on" // See https://discourse.nodered.org/t/show-errors-in-ace-and-monaco-editor/48529/12?u=bartbutenaers
            });
            node.aceEditor.setFontSize(14); 

            // Jeff: create XML editor
            node.aceXMLEditor = RED.editor.createEditor({
                id: 'aceXMLDiv',
                mode: 'ace/mode/xml',
                value: node.workspaceXml,
                readOnly: true
            });
            node.aceXMLEditor.setFontSize(12);
            // Jeff: invoke when either fillAceXMLEditor triggered or loaded XML from library
            node.aceXMLEditor.on("change", function () {
                var loadedXml = node.aceXMLEditor.getValue();
                // Jeff: it seems everytime anything loads to the editor it removes the previous contents and then inject the new contents.
                // so there are two changes. 
                if (loadedXml != "") {
                    Blockly.nodeOutputs = parseInt($("#node-input-outputs")[0].value);
                    createWorkspace(node, loadedXml);
                }
            });

            // Show three tabsheets
            var tabs = RED.tabs.create({
                id: "node-blockly-tabs",
                onchange: function(tab) {
                    // Show only the content (i.e. the children) of the selected tabsheet, and hide the others
                    $("#node-blockly-tabs-content").children().hide();
                    $("#" + tab.id).show();

                    // We will also arrive here when addTab is being called.  In that case it has on use to continue...
                    if (node.librariesLoaded) {
                        // Every time the ace editor is displayed, the Javascript code should be regenerated (from the Blockly workspace);
                        // and the xml editor should be refilled (from the Blockly workspace)
                        if (tab.id === "node-blockly-tab-javascript") {
                            fillAceXMLEditor(node);
                            fillAceEditor(node);
                        }
                        if (tab.id === "node-blockly-tab-xml") {
                            fillAceXMLEditor(node);
                        }
                        if (tab.id === "node-blockly-tab-workspace") {
                            reloadBlockly(node);
                        }
                    }
                }
            });
            tabs.addTab({
                id: "node-blockly-tab-workspace",
                label: "Editor"
            });

            // Put the expand button on top of the workspace tab
            let expand_button = $('<div style="position: absolute; left: calc(100% - 20px - 5px); top: -1px; z-index: 99;">');
            expand_button.append($('<button id="blocklyExpandDiv" class="red-ui-button red-ui-button-small"><i class="fa fa-expand"></i></button>'));
            $('#red-ui-tab-node-blockly-tab-workspace').append(expand_button);

            tabs.addTab({
                id: "node-blockly-tab-javascript",
                label: "Generated Javascript"
            });
            tabs.addTab({
                id: "node-blockly-tab-xml",
                label: "Generated XML"
            });
            
            // Store the loaded config node id (temporarliy) in the node, because the blockly-node's config screen will
            // be cleaned up before we navigate to the tray screen.  From then on the $("#node-input-blocklyConfig") won't be accessible anymore...
            // Don't use node.blocklyConfig for this purpose, because that need to be unchanged in case the "Cancel" button is clicked.
            node.selectedConfigNodeId = $("#node-input-blocklyConfig").val();

            // Need to wait for it to be rendered before the sizing of the tabs can be properly calculated
            setTimeout(function() {
                tabs.resize();
            }, 0);

            RED.library.create({
                url:"blockly_functions", // where to get the data from
                type:"Blockly", // the type of object the library is for
                // Jeff: load XML to aceXMLEditor instead aceEditor
                editor:node.aceXMLEditor, // the field name the main text body goes to
                mode:"ace/mode/xml",
                fields:['name','outputs','timeout']
            });
            

            // Display a tip if the Node-Red version is below 0.19.0
            var versionParts = RED.settings.version.split('.');
            if (versionParts[0] == 0 && versionParts[1] < 19) {
                $("#tip-version").show();
            } else {
                $("#tip-version").hide();
            }
            
            //Jeff: called when the expand button clicked
            var expandTemplate = 
            '<!-- Blockly editor -->'+
            '<div id="blocklyArea" style="width: 100%; height: 100%; min-height:350px;">'+
                '<div id="blocklyDiv"></div>'+
            '</div>'+
            '<div id="jsArea" class="form-row node-text-editor-row" style="width: 100%; height: 100%; min-height:350px; display: none;">'+
                '<div id="aceDiv" style="width: 100%; height: 100%;"></div>'+
            '</div>';

            var expandBlocklyHandler = function() {
                return function(e) {
                    e.preventDefault();
                    RED.view.state(RED.state.EDITING);
                    var trayOptions = {
                        title: "Blockly Workspace",
                        width: "Infinity",
                        buttons: [
                            {
                                id: "node-showBlocklyArea",
                                text: "Back to Blockly Editor",
                                click: function() {
                                    $("#jsArea").css("display","none");
                                    $("#blocklyArea").css("display","block");
                                    $("#node-showJSArea").css("display","block");
                                    $("#node-showBlocklyArea").css("display","none");
                                    var dom = Blockly.Xml.workspaceToDom(node.workspace);
                                    var loadedXml = Blockly.Xml.domToPrettyText(dom);

                                    createWorkspace(node, loadedXml);
                                }
                            },
                            {
                                id: "node-showJSArea",
                                text: "See Generated Javascript",
                                click: function() {
                                    $("#blocklyArea").css("display","none");
                                    $("#jsArea").css("display","block");
                                    $("#node-showBlocklyArea").css("display","block");
                                    $("#node-showJSArea").css("display","none");
                                    Blockly.JavaScript.INFINITE_LOOP_TRAP = null;
                                    var javascript = Blockly.JavaScript.workspaceToCode(node.workspace);
                                    node.jseditor.setValue(javascript);
                                    // Fix for clearSelection (see https://github.com/bartbutenaers/node-red-contrib-blockly/issues/74#issuecomment-862681796)
                                    node.jseditor.moveCursorTo(0,0);
                                }
                            },
                            {
                                id: "node-dialog-cancel",
                                text: RED._("common.label.cancel"),
                                click: function() {
                                    var loadedXml = node.loadedXml;
                                    node.isTrayOpen = false;
                                    //Jeff: re-create workspace after RED.tray.close finished
                                    RED.tray.close(() => createWorkspace(node, loadedXml));
                                }
                            },
                            {
                                id: "node-dialog-ok",
                                text: RED._("common.label.done"),
                                class: "primary",
                                click: function() {
                                    var dom = Blockly.Xml.workspaceToDom(node.workspace);
                                    var loadedXml = Blockly.Xml.domToPrettyText(dom);
                                    node.isTrayOpen = false;
                                    RED.tray.close(() => createWorkspace(node, loadedXml));
                                }
                            }
                        ],
                        resize: function(dimensions) {
                            var height = $("#blocklyArea").height();
                            var width = $("#blocklyArea").width();
                            $("#blocklyDiv").css("height",height+"px");
                            $("#blocklyDiv").css("width",width+"px");
                            Blockly.svgResize(node.workspace);
                            node.workspace.scrollCenter();
                        },
                        open: function(tray) {
                            $("#node-showBlocklyArea").css({"float":"left","display":"none"});
                            $("#node-showJSArea").css("float","left");
                            var trayBody = tray.find('.red-ui-tray-body');
                            //var blocklyAreaContent = $('<div id="blocklyArea" style="width: 100%; height: 100%; min-height:700px;"></div>').appendTo(trayBody);
                            //var blocklyDivContent = $('<div id="blocklyDiv"></div>').appendTo(blocklyAreaContent);
                            $(expandTemplate).appendTo(trayBody);
                            //Jeff: load workspace to a temp XML
                            var dom = Blockly.Xml.workspaceToDom(node.workspace);
                            node.loadedXml = Blockly.Xml.domToPrettyText(dom);

                            createWorkspace(node, node.loadedXml);
                            node.jseditor = RED.editor.createEditor({
                                id: 'aceDiv',
                                mode: 'ace/mode/nrjavascript', // serverside NodeRed editor
                                value: node.func,
                                readOnly: true
                            });
                            node.jseditor.setFontSize(14); 
                        },
                        close: function() {
                            delete node.loadedXml;   
                            node.jseditor.destroy();
                            delete node.jseditor;
                        },
                        show: function() {

                        }
                    }
                    node.isTrayOpen = true;
                    RED.tray.show(trayOptions);
                }
            }

            //Jeff: expand Blockly editing area
            $("#blocklyExpandDiv").on("click", expandBlocklyHandler());
            
            // When a new config is selected, a new Blockly workspace should be drawn (with the new config settings)        
            $("#node-input-blocklyConfig").on('change', function(event) {
                // Store the newly selected config node id (temporarliy) in the node, because the blockly-node's config screen will
                // be cleaned up before we navigate to the tray screen.  From then on the $("#node-input-blocklyConfig") won't be accessible anymore...
                // Don't use node.blocklyConfig for this purpose, because that need to be unchanged in case the "Cancel" button is clicked.
                node.selectedConfigNodeId = $("#node-input-blocklyConfig").val();
                
                var counter = 0;
                var language = "en";
                var categories;

                if (node.selectedConfigNodeId && node.selectedConfigNodeId !== "_ADD_") {
                    var configNode = RED.nodes.node(node.selectedConfigNodeId);
                    if (configNode) {
                        if (configNode.language) {
                            language = configNode.language;
                        }
                        
                        // Only when the "customize toolbox categories" checkbox is enabled (in the config node screen), we will use the custom categories.
                        if (configNode.customizeToolbox) {
                            categories = configNode.categories;
                        }
                    }
                }
                                    
                // Load all the files from the servers, as specified in the config node.
                // This also includes the language files.  At the start we have loaded the en.js files, because we are sure that all sentences
                // are available in english.  Afterwards other language files can be loaded, thus overwriting the english sentences.  By doing
                // it that way, missing sentences in the translations are not a problem (since those sentences will simply be displayed in english).
                // CAUTION: the "blockly-contrib/npm/blockly/msg/en.js" file contains a Blockly.Msg = {} , which means all previous loaded 
                // messages will be removed!
                if (node.workspace) {
                    // When there has been a previous workspace, show the content of that workspace.
                    // Because that workspace might have changes (which have not been stored yet into node.workspaceXml), which need to be kept

                    var dom = Blockly.Xml.workspaceToDom(node.workspace);
                    node.workspaceXml = Blockly.Xml.domToPrettyText(dom);
                }
                loadResourcesFromServer(node, language, categories);
            });
            // This is being called by Node-RED also $("#node-input-blocklyConfig").change();
        },
        oneditsave: function() {
            var node = this;
          
            // Store the number of output ports in Blockly,  so the blocks can take that number into account (if required)
            //Blockly.nodeOutputs = $("#node-input-outputs").val(); 
  
            // Generate JavaScript code from the workspace content, and store it in this node.
            // That way it can be send to the server, where it will be executed in the sandbox.
            Blockly.JavaScript.INFINITE_LOOP_TRAP = null;
            node.func = Blockly.JavaScript.workspaceToCode(node.workspace);
            
            // Store the workspace content as an xml string (which will produce a minimal ugly string).
            // To obtain a more readable (but larger) string, use Blockly.Xml.domToPrettyText instead.
            var dom = Blockly.Xml.workspaceToDom(node.workspace);
            node.workspaceXml = Blockly.Xml.domToPrettyText(dom); 
            
            // When the generated code contains an error, store a 1 in node.noerr.  That way the validator (of the node.noerr property)
            // can be used to show a red rectangle on the node in the flow editor.
            // Note that the standard function-node uses node.aceEditor.getSession().getAnnotations() for this purpose.  However that 
            // seemed not to work here, when the JS editor tabsheet has not been opened.  In that case we get the errors of the previous
            // JS code (that was loaded when the config screen opens).
            // Therefore we will use the function node constructor:
            try {
                node.noerr = 0;
                new Function(node.func);
            }
            catch(e) {
                if (e instanceof SyntaxError) {
                    node.noerr = 1;
                }
            }
            
            node.backpackContents = [];
            if (node.backpack) {
                // Store the current content of the backpack into the selected config node.
                if (node.selectedConfigNodeId && node.selectedConfigNodeId !== "_ADD_") {
                    var configNode = RED.nodes.node(node.selectedConfigNodeId);
    
                    if (configNode) {
                        configNode.backpackContents = node.backpack.getContents();
                        
                        // Let Node-RED know that the config node has become dirty, so the "Deploy" button will become active
                        // (because the user might only have changed the config node's backpack, and not changed this node)
                        configNode.dirty = true;
                        RED.nodes.dirty(true);
                    }
                }
            }

            cleanup(node);
        },
        oneditcancel: function() {
            var node = this;
            
            cleanup(node);
        },
        oneditresize: function (size) {
            var node = this;
            
            // Only execute this functionality as soon as the Blockly libraries have been loaded (i.e. the Blockly global variable exists)
            if (window.Blockly) {
                var height = $("#blocklyArea").height();
                var width = $("#blocklyArea").width();
                $("#blocklyDiv").css("height",height+"px");
                $("#blocklyDiv").css("width",width+"px");
                
                if (node.workspace) {
                    Blockly.svgResize(node.workspace);
                    //node.workspace.scrollCenter();
                }
            }
        }
    });
</script>

<script type="text/html" data-template-name="Blockly">

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name" style="width:70%;">
    </div>
    <div class="form-row">
        <label for="node-input-blocklyConfig"><i class="fa fa-cog"></i> Config</label>
        <!-- Node-Red will replace this input element by a drop-down (with available OnVif device configurations) -->
        <input type="text" id="node-input-blocklyConfig">
    </div>
    </br>
    <div class="form-row">
        <!-- Three tabsheets -->
        <ul style="background: #fff; min-width: 600px; margin-bottom: 20px;" id="node-blockly-tabs"></ul>
    </div>
    <div id="node-blockly-tabs-content" style="min-height: 350px">
        <div id="node-blockly-tab-workspace">
            <div class="form-row">
                <!-- Blockly editor -->
                <div id="blocklyArea" style="width: 100%; height: 450px; min-height:350px;">
                    <div id="blocklyDiv"></div>
                </div>
            </div>
        </div>
        <div id="node-blockly-tab-javascript">
            <div class="form-row node-text-editor-row">
                <!-- <div style="position: absolute; right:0; bottom:calc(100% + 3px);"><button id="node-function-expand-js" class="editor-button editor-button-small"><i class="fa fa-expand"></i></button></div>-->
                <!-- Ace editor for generated Javascript code -->
                <div id="aceDiv" style="width: 100%; height: 450px; min-height:350px;"></div>
            </div>
        </div>
        <div id="node-blockly-tab-xml">
            <div class="form-row node-text-editor-row">
                <!-- <div style="position: absolute; right:0; bottom:calc(100% + 3px);"><button id="node-function-expand-js" class="editor-button editor-button-small"><i class="fa fa-expand"></i></button></div>-->
                <!-- Ace XML editor for generated XML code -->
                <div id="aceXMLDiv" style="width: 100%; height: 450px; min-height:350px;">
                </div>
            </div>
        </div>
    </div>
    <div>
        <div class="form-row" style="display: inline-block; margin-right: 50px;">
            <label for="node-input-outputs"><i class="fa fa-random"></i> Outputs</label>
            <input id="node-input-outputs" style="width: 60px;" value="1">
        </div>
        <div class="form-row" style="display: inline-block;">
            <label for="node-input-timeout"><i class="fa fa-clock-o"></i> Timeout</label>
            <input id="node-input-timeout" style="width: 60px;">
        </div>
    </div>
    <div class="form-tips" id="tip-version" style="width: 100%;max-width: 100%;" hidden>Tip: The 'get node property' block cannot be used, since Node-red version 0.19.0 is minimal required.</div>
    </br>
</script>


<script type="text/html" data-help-name="Blockly">
    <p>A visual programming interface, to make programming a function node easier. Just drag and drop <a target="_blank" href="https://developers.google.com/blockly/">Blockly</a> 
    blocks to build your program logic, without having to write the Javascript code yourself.  The generated javascript code will be run against the messages being received by the node.</p>
    <p>The messages are passed in as a JavaScript object called <code>msg</code>.</p>
    <p>By convention it will have a <code>msg.payload</code> property containing the body of the message.</p>
    <p>The function is expected to return a message object (or multiple message objects), but can choose to return nothing in order to halt a flow.</p>
    <p>See <a target="_blank" href="https://github.com/bartbutenaers/node-red-contrib-blockly">Github</a> for a basic introduction on writing functions with Blockly, or our 
    <a target="_blank" href="https://github.com/bartbutenaers/node-red-contrib-blockly/wiki">wiki</a> pages for tutorials.  And lot's of other Blockly documentation (tutorials, video's, ...) can be found all over the internet.</p>
    <h3>Details</h3>
    <p>The Blockly editor contains the basic blocks provided by Google.  In addition a number of extra blocks have been provided.  A number of those extra blocks allow to communicate with the Node-Red API, similar to a normal function node.</p>
    <h3>CAUTION</h3>
    <p>Blockly is 1-based while Javascript is 0-based, which means that Blockly starts counting from 0 in a loop.  The numbers are <strong>automatically decremented</strong> (-1) in the generated code.</p>
</script>
<!-- --- [red-module:node-red-contrib-blockly/blockly-config] --- -->
<!--
  Copyright 2021, Bart Butenaers
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at
  http://www.apache.org/licenses/LICENSE-2.0
  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<script type="text/javascript">
    function getDefaultBlocklyCategories() {
        // Note that the same blockly-contrib/npm/node-red-contrib-blockly/messages/en.js is used for all our custom categories, since we use 
        // a single language file for all our categories.  Similar to how the Blockly team at Google does it, since that is easier for the
        // contributors that create translations in other languages...
        // By repeating the same language file, it is possible for users to remove some categories (while the remaining categories still keep
        // functioning correctly).
        return [{
                name: "Node-RED",
                files: [
                    "blockly-contrib/npm/node-red-contrib-blockly/lib/nodered/nodeRedBlocksCodeGen.js",
                    "blockly-contrib/npm/node-red-contrib-blockly/lib/nodered/nodeRedBlocksDefs.js",
                    "blockly-contrib/npm/node-red-contrib-blockly/lib/nodered/toolbox.xml",
                    "blockly-contrib/npm/node-red-contrib-blockly/messages/en.js"
                ]
            },
            {
                name: "Objects",
                files: [
                    "blockly-contrib/npm/node-red-contrib-blockly/lib/json/objectBlocksCodeGen.js",
                    "blockly-contrib/npm/node-red-contrib-blockly/lib/json/objectBlocksDefs.js",
                    "blockly-contrib/npm/node-red-contrib-blockly/lib/json/toolbox.xml",
                    "blockly-contrib/npm/node-red-contrib-blockly/messages/en.js"
                ]
            },
            {
                name: "Buffer",
                files: [
                    "blockly-contrib/npm/node-red-contrib-blockly/lib/buffer/bufferBlocksCodeGen.js",
                    "blockly-contrib/npm/node-red-contrib-blockly/lib/buffer/bufferBlocksDefs.js",
                    "blockly-contrib/npm/node-red-contrib-blockly/lib/buffer/toolbox.xml",
                    "blockly-contrib/npm/node-red-contrib-blockly/messages/en.js"
                ]
            },
            {
                name: "Date/time",
                files: [
                    // Inside this category we use a datepicker plugin, which is available as a separate NPM package.
                    // When the npm package name contains a path separator (e.g. @blockly/field-date) then the frontend will
                    // need to replace that separator by the string "___SEPARATOR___".  Otherwise the NGinx webserver installed together
                    // with HomeAssistant will cause the Express.js routes to be messed up.
                    // See https://github.com/bartbutenaers/node-red-contrib-blockly/issues/101
                    "blockly-contrib/npm/@blockly___SEPARATOR___field-date/dist/index.js",
                    "blockly-contrib/npm/node-red-contrib-blockly/lib/datetime/dateTimeBlocksCodeGen.js",
                    "blockly-contrib/npm/node-red-contrib-blockly/lib/datetime/dateTimeBlocksDefs.js",
                    "blockly-contrib/npm/node-red-contrib-blockly/lib/datetime/toolbox.xml",
                    "blockly-contrib/npm/node-red-contrib-blockly/messages/en.js"
                ]
            },
            {
                name: "Timer",
                files: [
                    "blockly-contrib/npm/node-red-contrib-blockly/lib/timer/timerBlocksCodeGen.js",
                    "blockly-contrib/npm/node-red-contrib-blockly/lib/timer/timerBlocksDefs.js",
                    "blockly-contrib/npm/node-red-contrib-blockly/lib/timer/toolbox.xml",
                    "blockly-contrib/npm/node-red-contrib-blockly/messages/en.js"
                ]
            },
            {
                name: "Blockly extension",
                files: [
                    // Extra blocks that we have developed to show inside the existing standard Blockly categories
                    "blockly-contrib/npm/node-red-contrib-blockly/lib/extra/extraBlocksCodeGen.js",
                    "blockly-contrib/npm/node-red-contrib-blockly/lib/extra/extraBlocksDefs.js",
                    "blockly-contrib/npm/node-red-contrib-blockly/lib/extra/toolbox.xml",
                    "blockly-contrib/npm/node-red-contrib-blockly/messages/en.js"
                ]
            },
            {
                name: "Blockly standard",
                files: [
                    // The Blockly block definitions and code generaters are included in blocks_compressed.js and javascript_compressed.js",
                    // which are offered by the Blockly team in the blockly NPM package.  Those files need to be loaded all the time, otherwise
                    // we end up with lots of errors everywhere in this node.  Also the standard en.js file needs to be loaded always first,
                    // because it contains a statement to clear ALL previously loaded messages.
                    // Therefore those files will be loaded always and NOT here!!
                    // However we have created our own toolbox.xml file, because you need to specify on your own which Blockly standard
                    // blocks need to be displayed in the toolbox.  Therefore the toolbox.xml file is part of the node-red-contrib-blockly node.
                    // This allows people to change this file to create their custom toolbox.
                    "blockly-contrib/npm/node-red-contrib-blockly/lib/basic/toolbox.xml"
                ]
            }
        ];
    }

    RED.nodes.registerType('blockly-config',{
        category: 'config',
        color: '#ff758d',
        defaults: {
            language: {value: "en"},
            showTrashcan: {value: true},
            allowComments: {value: true},
            showZoomControl: {value: true},
            showMiniMap: {value: true},
            enableBackPack: {value: false},
            // The backpackContents will be set by the Blockly nodes, but need to be defined here (otherwise it won't be persisted by Node-RED)
            backpackContents: {value: []},
            toolboxPosition: {value: "left"},
            renderer: {value: "geras"},
            theme: {value: "classic"},
            categories: {value: null},
            customizeToolbox: {value: false},
            name: {value: ""}
        },        
        inputs:1,
        outputs:1,
        icon: "font-awesome/fa-cog",
        label: function() {
            return this.name || "Blockly config";
        },
        oneditprepare: function() {
            var node = this;

            // Show by default theme "classic" for older nodes 
            if(node.theme === null || node.theme === "" || (typeof node.theme === "undefined")) {
                $("#node-config-input-theme").val("classic");
            }

            // Show tabsheets
            node.tabs = RED.tabs.create({
                id: "node-blockly-config-tabs",
                onchange: function(tab) {
                    // Show only the content (i.e. the children) of the selected tabsheet, and hide the others
                    $("#node-blockly-config-tabs-content").children().hide();
                    $("#" + tab.id).show();
                    
                    // Make sure that the editableList on this tab will fill the entire available area
                    //resizeDialog();
                }
            });
            node.tabs.addTab({
                id: "node-blockly-config-tab-settings",
                label: "Settings"
            });
            node.tabs.addTab({
                id: "node-blockly-config-tab-categories",
                label: "Categories"
            });
            
            $('#node-config-input-customizeToolbox').change(function() {
                // Enabling/disabling tabsheet is not supported by Node-RED (see https://discourse.nodered.org/t/disable-a-tabsheet-in-config-screen/32031)
                if (this.checked) {
                    // Enable the "categories" tabsheet
                    $("#red-ui-tab-node-blockly-config-tab-categories").css('pointer-events', "");
                    $("#red-ui-tab-node-blockly-config-tab-categories").css('opacity', "");
                }
                else {
                    // Disable the "categories" tabsheet
                    $("#red-ui-tab-node-blockly-config-tab-categories").css('pointer-events', "none");
                    $("#red-ui-tab-node-blockly-config-tab-categories").css('opacity', "0.4");
                }
            });
            $('#node-config-input-customizeToolbox').change();
            
            // The "categories" tabsheet is disabled by default, because it should only be used by advanced users!
            // Not supported by Node-RED (see https://discourse.nodered.org/t/disable-a-tabsheet-in-config-screen/32031)
            $("#red-ui-tab-node-blockly-config-tab-categories").css('pointer-events', "none");
            $("#red-ui-tab-node-blockly-config-tab-categories").css('opacity', "0.4");
            
            if (!node.categories) {
                // By default we expect all our categories need to be displayed.  Afterwards the user can modify this list if required.
                node.categories = getDefaultBlocklyCategories();
            }
            
            var categoriesList = $("#node-input-categories-container").css('min-height','200px').editableList({
                // Apply css to the parent div to have margins, to make sure the percentages of the headers match those of the html elements below.
                // Thanks to hotNipi for this tip !!!
                header: $("<div>").css({"margin-left":"28px","margin-right":"10x"}).append($.parseHTML(
                   "<div style='width:40%; display: inline-grid'><b>Category</b></div>" +
                   "<div style='width:40%; display: inline-grid'><b>Resources</b></div>")),
                addItem: function(container, i, category) {
                    // Add a new row to the editableList
                    var row = $('<div/>').appendTo(container);
                    
                    // Column 1 : Add an input field (type text) to the new row, that represents the category name
                    var nameField = $('<input/>',{class:"node-input-category-name",type:"text"}).css({"width":"40%","margin-left":"5px","margin-right":"5px"}).appendTo(row);
                    nameField.val(category.name || "");                   

                    // Column 2 : Add an typedinput field (type object) to the new row, that represents the category files (i.e. all the files that need to be downloaded to the frontend)
                    var filesField = $('<input/>',{class:"node-input-category-files",type:"text"}).css({"width":"40%","margin-left":"5px","margin-right":"5px"}).appendTo(row);
                    filesField.typedInput({types: ['json']});
                    filesField.typedInput("type", "json");
                    filesField.typedInput("value", JSON.stringify(category.files || []));
                },
                buttons: [{
                    label: "reset",
                    icon: "fa fa-refresh",
                    title: "reset to the default categories",
                    click: function(evt) { 
                        var answer = confirm("Do you really want to load the default categories/blocks?");
                        if (answer == true) {
                            $("#node-input-categories-container").editableList('empty');
                            var defaultCategories = getDefaultBlocklyCategories();
                            defaultCategories.forEach(function (category, index) {
                                categoriesList.editableList('addItem', category);
                            });
                        }
                    }
                }],
                removable: true,
                sortable: true
            });
            
            // Show all the categories (stored in this node) into the editableList
            if (node.categories) {
                node.categories.forEach(function (category, index) {
                    categoriesList.editableList('addItem', category);
                });
            }
        },
        oneditsave: function() {
            var node = this;

            // Copy all the categories from the editableList to this node
            node.categories = [];
            var categoriesList = $("#node-input-categories-container").editableList('items');
            categoriesList.each(function(i) {
                var category  = $(this);
                var name      = category.find(".node-input-category-name").val();
                var files     = JSON.parse(category.find(".node-input-category-files").typedInput('value'));
                
                node.categories.push({name:name, files:files});
            });
        },
        oneditresize: function(size) {
            ///resizeDialog(size);
        }
    });
</script>

<script type="text/html" data-template-name="blockly-config">
    <div class="form-row">
        <label for="node-config-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-config-input-name" placeholder="Name">
    </div>
    <br>
    <div class="form-row">
        <!-- Tabsheets -->
        <ul style="background: #fff; margin-bottom: 20px;" id="node-blockly-config-tabs"></ul>
    </div>
    <div id="node-blockly-config-tabs-content" style="min-height: 150px">
        <!-- Content of all tabsheets -->
        <div id="node-blockly-config-tab-settings" class="node-blockly-config-tab-content">
            <div class="form-row">
                <label for='node-config-input-showTrashcan'><i class='fa fa-trash'></i> Trashcan</label>
                <input type='checkbox' id='node-config-input-showTrashcan' style='width:auto ;border:none; vertical-align:baseline;' placeholder='0'>
                <span for='node-config-input-showTrashcan'> Show trashcan icon in workspace</span>
            </div>
            <div class="form-row">
                <label for='node-config-input-allowComments'><i class='fa fa-comment-o'></i> Comment</label>
                <input type='checkbox' id='node-config-input-allowComments' style='width:auto ;border:none; vertical-align:baseline;' placeholder='0'>
                <span for='node-config-input-allowComments'> Allow comments on blocks</span>
            </div>    
            <div class="form-row">
                <label for='node-config-input-showZoomControl'><i class='fa fa-binoculars'></i> Zoom</label>
                <input type='checkbox' id='node-config-input-showZoomControl' style='width:auto ;border:none; vertical-align:baseline;' placeholder='0'>
                <span for='node-config-input-showZoomControl'> Show zoom control icons in workspace</span>
            </div>
            <div class="form-row">
                <label for='node-config-input-showMiniMap'><i class='fa fa-map'></i> MiniMap</label>
                <input type='checkbox' id='node-config-input-showMiniMap' style='width:auto ;border:none; vertical-align:baseline;' placeholder='0'>
                <span for='node-config-input-showMiniMap'> Show a mini map in (expanded) workspace</span>
            </div>
            <div class="form-row">
                <label for='node-config-input-enableBackPack'><i class='fa fa-briefcase'></i> Backpack</label>
                <input type='checkbox' id='node-config-input-enableBackPack' style='width:auto ;border:none; vertical-align:baseline;' placeholder='0'>
                <span for='node-config-input-enableBackPack'> Show backpack icon in workspace</span>
            </div>
            <div class="form-row">
                <label for='node-config-input-customizeToolbox'><i class='fa fa-list'></i> Categories</label>
                <input type='checkbox' id='node-config-input-customizeToolbox' style='width:auto ;border:none; vertical-align:baseline;' placeholder='0'>
                <span for='node-config-input-customizeToolbox'> Customize toolbox categories (use with caution!)</span>
            </div>
            <div class="form-row">
                <label for="node-config-input-language"><i class="fa fa-globe"></i> Language</label>
                <select id="node-config-input-language">    
                    <!--<option value='ar'>العربية</option>-->
                    <!--<option value='be-tarask'>Taraškievica</option>-->
                    <!--<option value='br'>Brezhoneg</option>-->
                    <!--<option value='ca'>Català</option>-->
                    <!--<option value='cs'>Česky</option>-->
                    <!--<option value='da'>Dansk</option>-->
                    <!--<option value='de'>Deutsch</option>-->
                    <!--<option value='el'>Ελληνικά</option>-->
                    <option value='en'>English</option>
                    <!--<option value='es'>Español</option>-->
                    <!--<option value='et'>Eesti</option>-->
                    <!--<option value='fa'>فارسی</option>-->
                    <option value='fr'>Français</option>
                    <!--<option value='he'>עברית</option>-->
                    <!--<option value='hrx'>Hunsrik</option>-->
                    <!--<option value='hu'>Magyar</option>-->
                    <!--<option value='ia'>Interlingua</option>-->
                    <!--<option value='is'>Íslenska</option>-->
                    <!--<option value='it'>Italiano</option>-->
                    <option value='ja'>日本語</option>
                    <!--<option value='kab'>Kabyle</option>-->
                    <!--<option value='ko'>한국어</option>-->
                    <!--<option value='mk'>Македонски</option>-->
                    <!--<option value='ms'>Bahasa Melayu</option>-->
                    <!--<option value='nb'>Norsk Bokmål</option>-->
                    <option value='nl'>Nederlands, Vlaams</option>
                    <!--<option value='oc'>Lenga d\'òc</option>-->
                    <!--<option value='pl'>Polski</option>-->
                    <!--<option value='pms'>Piemontèis</option>-->
                    <!--<option value='pt-br'>Português Brasileiro</option>-->
                    <!--<option value='ro'>Română</option>-->
                    <option value='ru'>Русский</option>
                    <!--<option value='sc'>Sardu</option>-->
                    <!--<option value='sk'>Slovenčina</option>-->
                    <!--<option value='sr'>Српски</option>-->
                    <!--<option value='sv'>Svenska</option>-->
                    <!--<option value='ta'>தமிழ்</option>-->
                    <!--<option value='th'>ภาษาไทย</option>-->
                    <!--<option value='tlh'>tlhIngan Hol</option>-->
                    <!--<option value='tr'>Türkçe</option>-->
                    <!--<option value='uk'>Українська</option>-->
                    <!--<option value='vi'>Tiếng Việt</option>-->
                    <!--<option value='zh-hans'>简体中文</option>-->
                    <!--<option value='zh-hant'>正體中文</option>-->
                </select>
            </div>    
            <div class="form-row">
                <label for="node-config-input-toolboxPosition"><i class="fa fa-arrows"></i> Toolbox</label>
                <select id="node-config-input-toolboxPosition">
                    <option value="left">Left</option> 
                    <option value="right">Right</option>
                    <option value="top">Top</option>
                </select>
            </div> 
            <div class="form-row">
                <label for="node-config-input-renderer"><i class="fa fa-paint-brush"></i> Renderer</label>
                <select id="node-config-input-renderer">
                    <option value="geras">Geras</option> 
                    <option value="thrasos">Thrasos</option>
                    <option value="zelos">Zelos</option>
                </select>
            </div>
            <div class="form-row">
                <label for="node-config-input-theme"><i class="fa fa-paint-brush"></i> Theme</label>
                <select id="node-config-input-theme">
                    <option value="classic">Classic</option> 
                    <option value="dark">Dark</option>
                    <option value="deuteranopia">Deuteranopia</option>
                    <option value="highcontrast">High contrast</option>
                    <option value="modern">Modern</option>
                    <option value="tritanopia">Tritanopia</option>
                </select>
            </div>
        </div>
        <div id="node-blockly-config-tab-categories" class="node-blockly-config-tab-content">
            <div class="form-row">
                <!-- Table with blockly toolbox categories -->
                <ol id="node-input-categories-container" class="auto-height-container"></ol>
            </div>  
        </div>
    </div>            
</script>


<script type="text/html" data-help-name="blockly-config">
    <p><strong>Show trashcan icon in workspace:</strong><br/>
    If activated, a trash can icon will be displayed in the Blockly workspace.</p>
    <p><strong>Allow comments on blocks:</strong><br/>
    If activated, comments can be added to a block (via the right-click context menu).</p>
    <p><strong>Show zoom control icons in workspace:</strong><br/>
    If activated, zoom control icons will be displayed in the Blockly workspace.</p> 
    <p><strong>Show mini map in workspace:</strong><br/>
    If activated, a mini map will be displayed in the Blockly workspace (when extended to fullscreen).</p> 
    <p><strong>Show backpack icon in workspace:</strong><br/>
    If activated, a backpack icon will be displayed in the Blockly workspace.  Via this way you can manage your favorite blocks.</p> 
    <p><strong>Categories:</strong><br/>
    If activated, the toolbox categories can be customized.</p>
    <p style="color:#FF0000">CAUTION: if you remove block libraries (for blocks that are already being used in the workspace), then your workspace might become unusable!  Moreover when a new version of the Blockly node is published, then you most probably might not get our changes to the toolbox (e.g. a new category).  So this option should only be used by advanced users!</p>
    <p><strong>Language:</strong><br/>
    Specify in which language the text should appear in the workspace.</p>
    <p><strong>Toolbox:</strong><br/>
    Specify the location of the toolbox in the workspace (left, right or top).</p>
    <p><strong>Renderer:</strong><br/>
    Specify a renderer to determine how the blocks need to be drawed visually in the workspace (height, padding, border, ...):
    <ul>
        <li><i>Geras:</i> The default Blockly look and feel.</li>
        <li><i>Thrasos:</i></li>
        <li><i>Zelos:</i> A Scratch-like look and feel.</li>
    </ul></p>
    <p><strong>Theme:</strong><br/>
    Specify a theme to adjust the colors in the workspace:
    <ul>
        <li><i>Classic:</i> The default theme in Blockly.</li>
        <li><i>Dark:</i> A theme that uses darker colors than the default</li>
        <li><i>Deuteranopia:</i> A theme for people that have deuteranopia (the inability to perceive green light). This can also be used for people that have protanopia (the inability to perceive red light).</li>
        <li><i>Modern:</i> A slight variant of the default Blockly theme that uses darker borders and flatter blocks.</li>
        <li><i>High Contrast:</i> A theme that improves accessibility by using more contrasting colors and darker text to make blocks more legible.</li>
        <li><i>Tritanopia:</i> A theme for people that have tritanopia (the inability to perceive blue light).</li>
    </ul></p>
</script>
<!-- --- [red-module:node-red-contrib-cron-plus/cronplus] --- -->

<!--
MIT License

Copyright (c) 2019, 2020, 2021, 2022 Steve-Mcl

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.
-->

<script type="text/javascript">
/* global RED, $, jQuery */
/* global cartodb, L */
(function ($) {
    'use strict'

    /*
        cronBuilder - adapted for cron-plus from https://github.com/juliacscai/jquery-cron-quartz - License...
        The MIT License (MIT)
        Copyright (c) 2016 Julia Cai
    */

    const cronInputs = {
        period: '<div class="cron-select-period"><label></label><select class="cron-period-select"></select></div>',
        startTime: '<div class="cron-input cron-start-time">Start time <select class="cron-clock-hour"></select>:<select class="cron-clock-minute"></select></div>',
        container: '<div class="cron-input"></div>',
        minutes: {
            tag: 'cron-minutes',
            inputs: ['<p>Every <select class="cron-minutes-select"></select> minutes(s)</p>']
        },
        hourly: {
            tag: 'cron-hourly',
            inputs: ['<p><input type="radio" name="hourlyType" value="every"> Every <select class="cron-hourly-select"></select> hour(s)</p>',
                '<p><input type="radio" name="hourlyType" value="clock"> Every day at <select class="cron-hourly-hour"></select>:<select class="cron-hourly-minute"></select></p>']
        },
        daily: {
            tag: 'cron-daily',
            inputs: ['<p><input type="radio" name="dailyType" value="every"> Every <select class="cron-daily-select"></select> day(s)</p>',
                '<p><input type="radio" name="dailyType" value="clock"> Every week day</p>']
        },
        weekly: {
            tag: 'cron-weekly',
            inputs: ['<p><input type="checkbox" name="dayOfWeekMon"> Monday  <input type="checkbox" name="dayOfWeekTue"> Tuesday  ' +
                '<input type="checkbox" name="dayOfWeekWed"> Wednesday  <input type="checkbox" name="dayOfWeekThu"> Thursday</p>',
            '<p><input type="checkbox" name="dayOfWeekFri"> Friday  <input type="checkbox" name="dayOfWeekSat"> Saturday  ' +
                '<input type="checkbox" name="dayOfWeekSun"> Sunday</p>']
        },
        monthly: {
            tag: 'cron-monthly',
            inputs: ['<p><input type="radio" name="monthlyType" value="byDay"> Day <select class="cron-monthly-day"></select> of every <select class="cron-monthly-month"></select> month(s)</p>',
                '<p><input type="radio" name="monthlyType" value="byWeek"> The <select class="cron-monthly-nth-day"></select> ' +
                '<select class="cron-monthly-day-of-week"></select> of every <select class="cron-monthly-month-by-week"></select> month(s)</p>']
        },
        yearly: {
            tag: 'cron-yearly',
            inputs: ['<p><input type="radio" name="yearlyType" value="byDay"> Every <select class="cron-yearly-month"></select> <select class="cron-yearly-day"></select></p>',
                '<p><input type="radio" name="yearlyType" value="byWeek"> The <select class="cron-yearly-nth-day"></select> ' +
                '<select class="cron-yearly-day-of-week"></select> of <select class="cron-yearly-month-by-week"></select></p>']
        }
    }

    const periodOpts = arrayToOptions(['Minutes', 'Hourly', 'Daily', 'Weekly', 'Monthly', 'Yearly'])
    const minuteOpts = rangeToOptions(1, 59)
    const hourOpts = rangeToOptions(1, 24)
    const dayOpts = rangeToOptions(1, 31)
    const minuteClockOpts = rangeToOptions(0, 59, true)
    const hourClockOpts = rangeToOptions(0, 23, true)
    const dayInMonthOpts = rangeToOptions(1, 31)
    const monthOpts = arrayToOptions(['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
        [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12])
    const monthNumOpts = rangeToOptions(1, 12)
    const nthWeekOpts = arrayToOptions(['First', 'Second', 'Third', 'Forth', 'Last'], [1, 2, 3, 4, 'L'])
    const dayOfWeekOpts = arrayToOptions(['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'], ['MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT', 'SUN'])

    // Convert an array of values to options to append to select input
    function arrayToOptions (opts, values) {
        let inputOpts = ''
        for (let i = 0; i < opts.length; i++) {
            let value = opts[i]
            if (values != null) value = values[i]
            inputOpts += "<option value='" + value + "'>" + opts[i] + '</option>\n'
        }
        return inputOpts
    }

    // Convert an integer range to options to append to select input
    function rangeToOptions (start, end, isClock) {
        let inputOpts = ''; let label
        for (let i = start; i <= end; i++) {
            if (isClock && i < 10) label = '0' + i
            else label = i
            inputOpts += "<option value='" + i + "'>" + label + '</option>\n'
        }
        return inputOpts
    }

    // Add input elements to UI as defined in cronInputs
    function addInputElements ($baseEl, inputObj, onFinish) {
        $(cronInputs.container).addClass(inputObj.tag).appendTo($baseEl)
        $baseEl.children('.' + inputObj.tag).append(inputObj.inputs)
        if (typeof onFinish === 'function') onFinish()
    }

    const eventHandlers = {
        periodSelect: function () {
            const period = ($(this).val())
            const $selector = $(this).parent()
            $selector.siblings('div.cron-input').hide()
            $selector.siblings().find('select option').removeAttr('selected')
            $selector.siblings().find('select option:first').attr('selected', 'selected')
            $selector.siblings('div.cron-start-time').show()
            $selector.siblings('div.cron-start-time').children('select.cron-clock-hour').val('12')
            switch (period) {
            case 'Minutes':
                $selector.siblings('div.cron-minutes')
                    .show()
                    .find('select.cron-minutes-select').val('1')
                $selector.siblings('div.cron-start-time').hide()
                break
            case 'Hourly':{
                const $hourlyEl = $selector.siblings('div.cron-hourly')
                $hourlyEl.show()
                    .find('input[name=hourlyType][value=every]').prop('checked', true)
                $hourlyEl.find('select.cron-hourly-hour').val('12')
                $selector.siblings('div.cron-start-time').hide() }
                break
            case 'Daily':{
                const $dailyEl = $selector.siblings('div.cron-daily')
                $dailyEl.show()
                    .find('input[name=dailyType][value=every]').prop('checked', true) }
                break
            case 'Weekly':
                $selector.siblings('div.cron-weekly')
                    .show()
                    .find('input[type=checkbox]').prop('checked', false)
                break
            case 'Monthly':{
                const $monthlyEl = $selector.siblings('div.cron-monthly')
                $monthlyEl.show()
                    .find('input[name=monthlyType][value=byDay]').prop('checked', true) }
                break
            case 'Yearly':{
                const $yearlyEl = $selector.siblings('div.cron-yearly')
                $yearlyEl.show()
                    .find('input[name=yearlyType][value=byDay]').prop('checked', true) }
                break
            }
        }
    }

    // Public functions
    $.cronBuilder = function (el, options) {
        const base = this

        // Access to jQuery and DOM versions of element
        base.$el = $(el)
        base.el = el

        // Reverse reference to the DOM object
        base.$el.data('cronBuilder', base)

        // Initialization
        base.init = function () {
            base.options = $.extend({}, $.cronBuilder.defaultOptions, options)
            base.$el.append(cronInputs.period)
            base.$el.find('div.cron-select-period label').text(base.options.selectorLabel)
            base.$el.find('select.cron-period-select')
                .append(periodOpts)
                .bind('change', eventHandlers.periodSelect)

            addInputElements(base.$el, cronInputs.minutes, function () {
                base.$el.find('select.cron-minutes-select').append(minuteOpts)
            })

            addInputElements(base.$el, cronInputs.hourly, function () {
                base.$el.find('select.cron-hourly-select').append(hourOpts)
                base.$el.find('select.cron-hourly-hour').append(hourClockOpts)
                base.$el.find('select.cron-hourly-minute').append(minuteClockOpts)
            })

            addInputElements(base.$el, cronInputs.daily, function () {
                base.$el.find('select.cron-daily-select').append(dayOpts)
            })

            addInputElements(base.$el, cronInputs.weekly)

            addInputElements(base.$el, cronInputs.monthly, function () {
                base.$el.find('select.cron-monthly-day').append(dayInMonthOpts)
                base.$el.find('select.cron-monthly-month').append(monthNumOpts)
                base.$el.find('select.cron-monthly-nth-day').append(nthWeekOpts)
                base.$el.find('select.cron-monthly-day-of-week').append(dayOfWeekOpts)
                base.$el.find('select.cron-monthly-month-by-week').append(monthNumOpts)
            })

            addInputElements(base.$el, cronInputs.yearly, function () {
                base.$el.find('select.cron-yearly-month').append(monthOpts)
                base.$el.find('select.cron-yearly-day').append(dayInMonthOpts)
                base.$el.find('select.cron-yearly-nth-day').append(nthWeekOpts)
                base.$el.find('select.cron-yearly-day-of-week').append(dayOfWeekOpts)
                base.$el.find('select.cron-yearly-month-by-week').append(monthOpts)
            })

            base.$el.append(cronInputs.startTime)
            base.$el.find('select.cron-clock-hour').append(hourClockOpts)
            base.$el.find('select.cron-clock-minute').append(minuteClockOpts)

            if (typeof base.options.onChange === 'function') {
                base.$el.find('select, input').change(function () {
                    base.options.onChange(base.getExpression())
                })
            }

            base.$el.find('select.cron-period-select')
                .triggerHandler('change')
        }

        base.getExpression = function () {
            // var b = c.data("block");
            const sec = 0 // ignoring seconds by default
            const year = '*' // every year by default
            let dow = '?'
            let month = '*'; let dom = '*'
            let min = base.$el.find('select.cron-clock-minute').val()
            let hour = base.$el.find('select.cron-clock-hour').val()
            const period = base.$el.find('select.cron-period-select').val()
            switch (period) {
            case 'Minutes':
                {
                    const $selector = base.$el.find('div.cron-minutes')
                    const nmin = $selector.find('select.cron-minutes-select').val()
                    if (nmin > 1) min = '0/' + nmin
                    else min = '*'
                    hour = '*'
                }
                break

            case 'Hourly':
                {
                    const $selector = base.$el.find('div.cron-hourly')
                    if ($selector.find('input[name=hourlyType][value=every]').is(':checked')) {
                        min = 0
                        hour = '*'
                        const nhour = $selector.find('select.cron-hourly-select').val()
                        if (nhour > 1) hour = '0/' + nhour
                    } else {
                        min = $selector.find('select.cron-hourly-minute').val()
                        hour = $selector.find('select.cron-hourly-hour').val()
                    }
                }
                break

            case 'Daily':
                {
                    const $selector = base.$el.find('div.cron-daily')
                    if ($selector.find('input[name=dailyType][value=every]').is(':checked')) {
                        const ndom = $selector.find('select.cron-daily-select').val()
                        if (ndom > 1) dom = '1/' + ndom
                    } else {
                        dom = '?'
                        dow = 'MON-FRI'
                    }
                }
                break

            case 'Weekly':
                {
                    const $selector = base.$el.find('div.cron-weekly')
                    const ndow = []
                    if ($selector.find('input[name=dayOfWeekMon]').is(':checked')) { ndow.push('MON') }
                    if ($selector.find('input[name=dayOfWeekTue]').is(':checked')) { ndow.push('TUE') }
                    if ($selector.find('input[name=dayOfWeekWed]').is(':checked')) { ndow.push('WED') }
                    if ($selector.find('input[name=dayOfWeekThu]').is(':checked')) { ndow.push('THU') }
                    if ($selector.find('input[name=dayOfWeekFri]').is(':checked')) { ndow.push('FRI') }
                    if ($selector.find('input[name=dayOfWeekSat]').is(':checked')) { ndow.push('SAT') }
                    if ($selector.find('input[name=dayOfWeekSun]').is(':checked')) { ndow.push('SUN') }
                    dow = '*'
                    dom = '?'
                    if (ndow.length < 7 && ndow.length > 0) dow = ndow.join(',')
                }
                break

            case 'Monthly':
                {
                    const $selector = base.$el.find('div.cron-monthly')
                    let nmonth
                    let mnd
                    if ($selector.find('input[name=monthlyType][value=byDay]').is(':checked')) {
                        month = '*'
                        nmonth = $selector.find('select.cron-monthly-month').val()
                        dom = $selector.find('select.cron-monthly-day').val()
                        dow = '?'
                    } else {
                        mnd = $selector.find('select.cron-monthly-nth-day').val()
                        dow = $selector.find('select.cron-monthly-day-of-week').val() +
                                (mnd === 'L' ? 'L' : '#' + mnd)
                        nmonth = $selector.find('select.cron-monthly-month-by-week').val()
                        dom = '?'
                    }
                    if (nmonth > 1) month = '1/' + nmonth
                }
                break

            case 'Yearly':
                {
                    const $selector = base.$el.find('div.cron-yearly')
                    let ynd
                    if ($selector.find('input[name=yearlyType][value=byDay]').is(':checked')) {
                        dom = $selector.find('select.cron-yearly-day').val()
                        month = $selector.find('select.cron-yearly-month').val()
                        dow = '?'
                    } else {
                        ynd = $selector.find('select.cron-yearly-nth-day').val()
                        dow = $selector.find('select.cron-yearly-day-of-week').val() +
                                (ynd === 'L' ? 'L' : '#' + ynd)
                        month = $selector.find('select.cron-yearly-month-by-week').val()
                        dom = '?'
                    }
                }
                break

            default:
                break
            }
            return [sec, min, hour, dom, month, dow, year].join(' ')
        }

        base.init()
    }

    // Plugin default options
    $.cronBuilder.defaultOptions = {
        selectorLabel: 'Select period: '
    }

    // Plugin definition
    $.fn.cronBuilder = function (options) {
        return this.each(function () {
            // eslint-disable-next-line no-new
            (new $.cronBuilder(this, options))
        })
    }
}(jQuery));

(function () {
    RED._cron_plus_debug = false // set true at runtime to enable debug output
    let map, mapPopup, selectedLocation, selectedLocationInput
    const filesAdded = [] // list of files already added

    function toggleFullscreen(selector, callback) {
        callback = callback || function () {}
        const el = document.querySelector(selector || "#node-cronplus-tab-static-schedules");
        const $el = $(el)
        if (!document.fullscreenElement) {
            el.requestFullscreen().then(() => {
                $el.addClass('cron-plus-fullscreen-element').removeClass('cron-plus-expanded-element')
                callback()
            }).catch((err) => {
                if (callback) {
                    callback(err)
                } else {
                    alert( `Unable to get fullscreen mode: ${err.message}`, );
                }
            });
        } else {
            $el.removeClass('cron-plus-fullscreen-element').removeClass('cron-plus-expanded-element')
            try {
                document.exitFullscreen();
            } finally {
                callback()
            }
        }
    }

    function checkLoadJsCssFile (filename, filetype, callback) {
        if (filesAdded.indexOf(filename) === -1) {
            loadJsCssFile(filename, filetype, function () {
                filesAdded.push(filename)
                if (callback) callback()
            })
        } else {
            if (callback) callback()
        }
    }

    function loadJsCssFile (filename, filetype, callback) {
        let fileRef
        if (filetype === 'js') { // if filename is a external JavaScript file
            fileRef = document.createElement('script')
            fileRef.setAttribute('type', 'text/javascript')
            fileRef.setAttribute('src', filename)
        } else if (filetype === 'css') { // if filename is an external CSS file
            fileRef = document.createElement('link')
            fileRef.setAttribute('rel', 'stylesheet')
            fileRef.setAttribute('type', 'text/css')
            fileRef.setAttribute('href', filename)
        }
        if (typeof fileRef !== 'undefined') { document.getElementsByTagName('head')[0].appendChild(fileRef) }

        fileRef.onload = function () {
            if (callback) callback()
        }
    }

    function safeFloat (value, def) {
        if ((undefined === value) || (value === null)) {
            return def || 0.0
        }
        try {
            value = parseFloat(value)
        } catch (e) {
            value = def || 0.0
        }
        if (isNaN(value)) {
            return def || 0.0
        }
        return value
    }

    function isCronLike (expression) {
        if (typeof expression !== 'string') return false
        if (expression.indexOf('*') >= 0) return true
        const cleaned = expression.replace(/\s\s+/g, ' ')
        const spaces = cleaned.split(' ')
        return spaces.length >= 4 && spaces.length <= 6
    }

    function isDateSequenceLike (expression) {
        try {
            if (typeof expression !== 'string') return false
            if (expression.indexOf('*') >= 0) return false
            if (expression.indexOf('#') >= 0) return false
            if (expression.indexOf('?') >= 0) return false
            const cleaned = expression.replace(/\s\s+/g, ' ')
            const parts = cleaned.split(',')
            for (let index = 0; index < parts.length; index++) {
                let part = parts[index]
                if (parseInt(part) === part) part = parseInt(part)
                const d = new Date(part)
                const isDate = (d instanceof Date && !isNaN(d.valueOf()))
                if (!isDate) return false
            }
            return true
        } catch (error) {
            return false
        }
    }

    function showSidebarHelpPanel () {
        if (RED.sidebar.help) {
            RED.sidebar.help.show()//  >= V1.1.0
        } else {
            RED.sidebar.show('info')// <  V1.1.0
        }
    }

    function showCronHelp () {
        showSidebarHelpPanel()
        $('#cron-plus-expression-info').get(0).scrollIntoView()
    }

    function showSolarHelp () {
        showSidebarHelpPanel()
        $('#cron-plus-solar-events-info').get(0).scrollIntoView()
    }

    const getIdealDialogHeight = function () {
        return Math.min(800, ($(document).height() < 600) ? $(document).height() - 30 : $(document).height() - 100)
    }

    function initMap () {
        // create map popup dialog
        $('#cron-plus-map-dialog').dialog({
            classes: {
                'ui-dialog-content': 'cron-plus-map-dialog-content'
            },
            autoOpen: false,
            height: getIdealDialogHeight(),
            width: '75%',
            minWidth: 300,
            maxWidth: 1000,
            modal: true,
            buttons: {
                Cancel: function () {
                    $('#cron-plus-map-dialog').dialog('close')
                },
                OK: function () {
                    $('#cron-plus-map-dialog').dialog('close')
                    if (selectedLocation && selectedLocationInput) {
                        if (selectedLocationInput.typedInput('instance')) {
                            selectedLocationInput.typedInput('value', selectedLocation.lat + ' ' + selectedLocation.lng)
                        } else {
                            selectedLocationInput.val(selectedLocation.lat + ' ' + selectedLocation.lng)
                        }
                        selectedLocationInput.focus()
                        // if selectedLocationInput is a typedInput, trigger focus on that
                        if (selectedLocationInput.typedInput('instance')) {
                            selectedLocationInput.typedInput('focus')
                        }
                        selectedLocationInput.change()
                    }
                }
            },
            show: {
                effect: 'blind',
                duration: 500
            },
            // eslint-disable-next-line no-unused-vars
            open: function (event) {
                $(this).css('padding', '0px 0px 0px 0px')
                $('.ui-dialog-buttonpane').find('button:contains("OK")').addClass('primary')
                $('#cron-plus-map-dialog').dialog('option', 'height', getIdealDialogHeight())
                $('#cron-plus-dynamic-nodes-dialog').dialog('option', 'position', { my: 'center', at: 'center', of: window })
            },
            hide: {
                effect: 'explode',
                duration: 500
            },
            // eslint-disable-next-line no-unused-vars
            close: function (event, ui) {
                if (RED._cron_plus_debug) console.log('destroying map')
                if (map) map.remove()
            }
        })
    }

    function createMap (srcInput) {
        if (RED._cron_plus_debug) {
            console.log('createMap', srcInput)
        }
        $('.cron-plus-map-loading').hide()
        if (!window.L || navigator.onLine === false) {
            $('.cron-plus-map-not-loaded').show()
            $('#cron-plus-map').hide()
            return
        }
        $('#cron-plus-map').show()
        $('.cron-plus-map-not-loaded').hide()
        let lat, lon
        selectedLocationInput = srcInput
        function getInputValue () {
            if (selectedLocationInput.typedInput('instance')) {
                return selectedLocationInput.typedInput('value')
            }
            return selectedLocationInput.val()
        }
        const latlon = getInputValue()
        if (latlon && typeof latlon === 'string') {
            let splitChar = ' '
            if (latlon.includes(',')) splitChar = ','
            const arrLatlon = latlon.split(splitChar)
            if (arrLatlon.length >= 2) {
                lat = arrLatlon[0]
                lon = arrLatlon[1]
            }
        }
        if (RED._cron_plus_debug) console.log('createMap', lat, lon)
        let zoom = 3// by default, zoomed out
        let showPopupOnOpen = false
        if (lat && lon) {
            showPopupOnOpen = true
            zoom = 5// if location is set, zoom in a bit
        }
        lat = safeFloat(lat, 50.0)
        lon = safeFloat(lon, 0.0)
        if (RED._cron_plus_debug) console.log('lat/lon', lat, lon)
        selectedLocation = window.L.latLng(lat, lon)
        if (RED._cron_plus_debug) console.log('selectedLocation', selectedLocation.lat, selectedLocation.lng)

        // create leaflet map
        map = window.L.map('cron-plus-map', {
            zoomControl: true,
            center: selectedLocation, // [selectedLocation.lat,selectedLocation.lng],
            zoom
        })
        mapPopup = window.L.popup()

        map.on('click', function (e) {
            if (RED._cron_plus_debug) console.log(e)
            const normaliseLat = function (x) {
                while (x > 90.0 || x < -90.0) {
                    if (x > 90.0) { x = -(90.0 - (x - 90)) }
                    if (x < -90.0) { x = (90.0 - ((-x) - 90)) }
                }
                return x
            }
            const normaliseLng = function (x) {
                while (x > 180.0 || x < -180.0) {
                    if (x > 180.0) { x = -(180.0 - (x - 180)) }
                    if (x < -180.0) { x = (180.0 - ((-x) - 180)) }
                }
                return x
            }
            selectedLocation = {}
            selectedLocation.lat = normaliseLat(e.latlng.lat)
            selectedLocation.lng = normaliseLng(e.latlng.lng)
            const content =
            '<div><span>Lat:</span> <span>' + selectedLocation.lat + '</span></div>' +
                '<div><span>Lon:</span> <span>' + selectedLocation.lng + '</span></div>'
            showMapPopup(content, e.latlng.lat, e.latlng.lng, map)
        })

        function showMapPopup (content, lat, lon, map) {
            mapPopup
                .setLatLng([lat, lon])
                .setContent(content)
                .openOn(map)
        }

        // add a base layer
        const tileUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'
        const layer = L.tileLayer(tileUrl, {})
        layer.addTo(map)
        // add cartodb layer with one sublayer
        cartodb.createLayer(map, {
            user_name: 'node-red',
            type: 'namedmap',
            options: {
                named_map: {
                    name: 'node-red@cronplus',
                    params: {
                        color: '#5CA2D1'
                    },
                    layers: [{}]
                }
            }
        })
            .addTo(map)
            .done(function (layer) {
                layer.setInteraction(true)
                if (showPopupOnOpen) {
                    const content =
                        '<div><span>Lat:</span> <span>' + selectedLocation.lat + '</span></div>' +
                        '<div><span>Lon:</span> <span>' + selectedLocation.lng + '</span></div>'
                    showMapPopup(content, selectedLocation.lat, selectedLocation.lng, map)
                }

                // eslint-disable-next-line no-unused-vars
                layer.on('featureClick', function (e, latlng, pos, data, layer) {
                    if (RED._cron_plus_debug) console.log('click', latlng, data)
                })
                $('#cron-plus-map-dialog').dialog('option', 'position', { my: 'center', at: 'center', of: window })
            })
    }

    function showMap (srcInput) {
        $('#cron-plus-map-dialog').dialog('open')
        if (navigator.onLine === true) {
            $('.cron-plus-map-not-loaded').show()
            $('.cron-plus-map-loading').hide()
            $('#cron-plus-map').hide()
            const proto = location.protocol === 'https:' ? location.protocol : 'http:'
            checkLoadJsCssFile(proto + '//libs.cartocdn.com/cartodb.js/v3/3.11/themes/css/cartodb.css', 'css', function () {
                checkLoadJsCssFile(proto + '//libs.cartocdn.com/cartodb.js/v3/3.11/cartodb.uncompressed.js', 'js', function () {
                    createMap(srcInput)
                })
            })
        } else {
            $('.cron-plus-map-not-loaded').show()
            $('.cron-plus-map-loading').hide()
            $('#cron-plus-map').hide()
        }
    }

    function updateEditorLayout () {
         onSchedulesExpandCompress()

        if (RED._cron_plus_debug) console.log('cronplus-updateEditorLayout')
        const scheduleList = $('#node-cronplus-tab-static-schedules')
        const scheduleListFullScreen = scheduleList.css('position') === 'fixed' || document.fullscreenElement
        if (scheduleListFullScreen) {
            return // don't update layout if schedules are fullscreen
        }
        const dlg = $('#dialog-form')
        let height = dlg.height() - 5
        const expandRow = dlg.find('.form-row-auto-height')
        if (expandRow && expandRow.length) {
            const childRows = dlg.find('.form-row:not(.form-row-auto-height)')
            for (let i = 0; i < childRows.size(); i++) {
                const cr = $(childRows[i])
                if (cr.is(':visible')) { height -= cr.outerHeight(true) }
            }
            expandRow.css('height', height + 'px')
        }
        const show = $('#node-input-defaultLocation').typedInput('type') === 'default' || !$('#node-input-defaultLocation').typedInput('type')
        $('.cron-node-input-option-location-div').toggleClass('cron-plus-hide-per-location', !show)
    }

    $.widget('custom.combobox', {
        _create: function () {
            const that = this
            this.input = this.element
            this.input.addClass('red-ui-typedInput-input')
            this.elementDiv = $(this.input).wrap('<div>').parent().addClass('red-ui-typedInput-input-wrap')
            this.uiSelect = $(this.elementDiv).wrap($('<div>', { style: this.options.style })).parent()
            
            const attrStyle = this.options.style || this.element.attr('style')
            this.uiWidth = this.input.outerWidth()
            this.input.css('paddingLeft', 5)

            let m
            if ((m = /width\s*:\s*(calc\s*\(.*\)|\d+(%|px))/i.exec(attrStyle)) !== null) {
                this.input.css('width', 'calc(100% - 4px)')
                this.uiSelect.width(m[1])
                this.uiWidth = null
            } else {
                this.uiSelect.width(this.uiWidth)
            }

            ['Right', 'Left'].forEach(function (d) {
                const m = that.element.css('margin' + d)
                that.uiSelect.css('margin' + d, m)
                that.input.css('margin' + d, 1)
            })

            this.uiSelect.addClass('red-ui-typedInput-container')

            this.input.on('change', function () {
                that.validate()
            })

            this.button = $('<button tabindex="0" class="red-ui-typedInput-option-expand" style="display:inline-block;width: 20px"><span class="red-ui-typedInput-option-caret"><i class="red-ui-typedInput-icon fa fa-caret-down"></i></span></button>').appendTo(this.uiSelect)
            // this.buttonLabel = $('<span class="red-ui-typedInput-option-label"></span>').prependTo(this.button);
            this.button.on('click', function (event) {
                event.preventDefault()
                event.stopPropagation()
                that._showDropdownMenu()
            }).on('keydown', function (evt) {
                if (evt.keyCode === 40 /* down */) {
                    that._showDropdownMenu()
                }
                evt.stopPropagation()
            }).on('blur', function () {
                that.uiSelect.removeClass('red-ui-typedInput-focus')
            }).on('focus', function () {
                that.uiSelect.addClass('red-ui-typedInput-focus')
            })
            this.menu = this._createMenu(this.options.menu)
        },
        _createMenu: function (options) {
            if (RED._cron_plus_debug) console.log('combobox -> _createMenu  options:', options)
            const that = this
            this.disarmClick = false
            options = options || {}
            const menu = $('<div>').addClass('red-ui-typedInput-options red-ui-editor-dialog')
            const callback = options.options ? options.options.callback : null
            const beforeSelect = options.options ? options.options.beforeSelect : null
            const menuItems = options.menu || []
            menuItems.forEach(function (opt) {
                if (typeof opt === 'string') {
                    opt = { value: opt, label: opt }
                }
                const op = $('<a href="#"></a>').attr('value', opt.value).appendTo(menu)
                if (opt.label) {
                    op.text(opt.label)
                }
                if (opt.title) {
                    op.prop('title', opt.title)
                }
                if (opt.icon) {
                    if (opt.icon.indexOf('<') === 0) {
                        $(opt.icon).prependTo(op)
                    } else if (opt.icon.indexOf('/') !== -1) {
                        $('<img>', { src: opt.icon, style: 'margin-right: 4px; height: 18px;' }).prependTo(op)
                    } else {
                        $('<i>', { class: 'red-ui-typedInput-icon ' + opt.icon }).prependTo(op)
                    }
                } else {
                    op.css({ paddingLeft: '18px' })
                }
                if (!opt.icon && !opt.label) {
                    op.text(opt.value)
                }

                op.on('click', function (event) {
                    event.preventDefault()
                    event.stopPropagation()
                    let cancel = false
                    if (beforeSelect) {
                        cancel = beforeSelect(opt)
                    }
                    if (!cancel) {
                        if (callback) {
                            that.value(callback(opt.value))
                        } else {
                            that.value(opt.value)
                        }
                    }

                    that._hideMenu(menu)
                })
            })
            menu.css({ display: 'none' })
            menu.appendTo(document.body)

            menu.on('keydown', function (evt) {
                if (evt.keyCode === 40/* down */) {
                    evt.preventDefault()
                    $(this).children(':focus').next().trigger('focus')
                } else if (evt.keyCode === 38/* up */) {
                    evt.preventDefault()
                    $(this).children(':focus').prev().trigger('focus')
                } else if (evt.keyCode === 27/* escape */) {
                    evt.preventDefault()
                    that._hideMenu(menu)
                }
                evt.stopPropagation()
            })
            return menu
        },
        _showDropdownMenu: function () {
            if (this.menu) {
                this.menu.css({
                    minWidth: this.uiSelect.width()
                })
                this._showMenu(this.menu, this.button)
            }
        },
        _hideMenu: function (menu) {
            $(document).off('mousedown.red-ui-typedInput-close-property-select')
            menu.hide()
            menu.css({
                height: 'auto'
            })
            this.input.trigger('focus')
            // this.button.trigger("focus");
        },
        _showMenu: function (menu, relativeTo) {
            if (this.disarmClick) {
                this.disarmClick = false
                return
            }
            const that = this
            // var pos = relativeTo.offset();
            // var height = relativeTo.height();
            const pos = this.uiSelect.offset()
            const height = this.uiSelect.height()
            const menuHeight = menu.height()
            const menuWidth = menu.width()
            let top = (height + pos.top)
            let left = pos.left
            if (left + menuWidth > $(window).width()) {
                left -= (left + menuWidth) - $(window).width() + 5
            }
            if (top + menuHeight > $(window).height()) {
                top -= (top + menuHeight) - $(window).height() + 5
            }
            if (top < 0) {
                menu.height(menuHeight + top)
                top = 0
            }
            menu.css({
                top: top + 'px',
                left: (left) + 'px'
            })
            menu.slideDown(100)
            this._delay(function () {
                that.uiSelect.addClass('red-ui-typedInput-focus')
                $(document).on('mousedown.red-ui-typedInput-close-property-select', function (event) {
                    if (!$(event.target).closest(menu).length) {
                        that._hideMenu(menu)
                    }
                    if ($(event.target).closest(relativeTo).length) {
                        that.disarmClick = true
                        event.preventDefault()
                    }
                })
            })
        },
        _destroy: function () {
            if (this.menu) {
                this.menu.remove()
            }
            this.button.remove()
            this.element.unwrap()
            this.element.unwrap()
            this.input.removeClass('red-ui-typedInput-input')
        },
        value: function (value) {
            const that = this
            if (!arguments.length) {
                return that.input.val()
            } else {
                that.input.val(value)
                that.validate()
            }
        },
        validate: function () {
            let ok
            const value = this.value()
            const _validate = this.options.validate// || this.validate;
            if (!_validate || typeof _validate !== 'function') {
                ok = true
            } else {
                ok = _validate(value)
            }
            if (ok) {
                this.uiSelect.removeClass('input-error')
            } else {
                this.uiSelect.addClass('input-error')
            }
            return ok
        },
        showMenu: function () {
            this.button.show()
        },
        hideMenu: function () {
            this.button.hide()
        },
        show: function () {
            this.uiSelect.show()
        },
        hide: function () {
            this.uiSelect.hide()
        }
    })

    RED.nodes.registerType('cronplus', {
        category: 'input',
        icon: 'timer.png',
        color: '#a6bbcf',
        inputs: 1,
        outputs: 1,
        defaults: {
            name: { value: '' },
            // FUTURE config: { type: "CRON-PLUS Config" },
            outputField: { value: 'payload' },
            timeZone: { value: '' },
            persistDynamic: { value: undefined },
            storeName: { value: '' },
            commandResponseMsgOutput: { value: 'output1' },
            defaultLocation: { value: '' },
            defaultLocationType: { value: '' },
            outputs: { value: 1 },
            options: {
                value: [{ payload: '', topic: '', expression: '' }],
                validate: function (value) {
                    const dupCheck = {}
                    if (value.length) {
                        for (let i = 0; i < value.length; i++) {
                            if (!value[i].name && value[i].topic) {
                                value[i].name = value[i].topic
                            }
                            if (!value[i].name) {
                                console.warn('cron-plus: validation error - schedule name missing')
                                $('#node-input-option-container > li:nth-child(' + (i + 1) + ')  .node-input-option-name').addClass('input-error')
                                return false
                            } else {
                                $('#node-input-option-container > li:nth-child(' + (i + 1) + ')  .node-input-option-name').removeClass('input-error')
                            }
                            if (dupCheck[value[i].name]) {
                                console.warn("cron-plus: validation error - duplicate schedule named '" + value[i].name + "'")
                                $('#node-input-option-container > li:nth-child(' + (i + 1) + ')  .node-input-option-name').addClass('input-error')
                                return false
                            } else {
                                $('#node-input-option-container > li:nth-child(' + (i + 1) + ')  .node-input-option-name').removeClass('input-error')
                            }
                            dupCheck[value[i].name] = true
                            if (!value[i].expressionType || value[i].expressionType === 'cron') {
                                if (!value[i].expression) {
                                    console.warn('cron-plus: validation error - expression missing')
                                    // $("#node-input-option-container > li:nth-child(" + (i+1) + ")  .node-input-option-expressionType").addClass("input-error");
                                    return false
                                }
                            } else if (value[i].expressionType === 'solar') {
                                if (value[i].solarType !== 'all' && value[i].solarType !== 'selected') {
                                    console.warn("cron-plus: validation error - solarType is not 'all' or 'selected'")
                                    // $("#node-input-option-container > li:nth-child(" + (i+1) + ")  .node-input-option-solarType").addClass("input-error");
                                    return false
                                }
                                if (value[i].solarType === 'selected' && !value[i].solarEvents) {
                                    console.warn('cron-plus: validation error - solarEvents missing')
                                    return false
                                }
                            }
                        }
                    }
                    return true
                },
                required: true
            }
        },
        label: function () {
            return this.name || 'cron-plus'
        },
        outputLabels: function (index) {
            const node = this
            const fanOut = node.commandResponseMsgOutput === 'fanOut'
            const hasCommandOutputPin = !!((node.commandResponseMsgOutput === 'output2' || fanOut))
            const optionCount = node.options ? node.options.length : 0
            let dynOutputPinIndex = 0
            let cmdOutputPinIndex = hasCommandOutputPin ? 1 : 0
            if (fanOut) {
                dynOutputPinIndex = optionCount
                cmdOutputPinIndex = optionCount + 1
            }
            if (!fanOut && !hasCommandOutputPin) return 'All messages and events'
            if (!fanOut && hasCommandOutputPin && index === 0) return 'Static and Dynamic schedule messages'
            if (index === cmdOutputPinIndex) return 'Command responses only'
            if (index === dynOutputPinIndex) return 'Dynamic schedules only'
            const item = node.options && node.options[index]
            if (item) return item.name + ' (' + item.expressionType + ')'
        },

        oneditprepare: function () {
            if (RED._cron_plus_debug) { console.log('oneditprepare - cronplus') }
            const node = this
            const dupCheck = {}
            let selectedLocationInput = null

            node.commandResponseMsgOutput = ['output1', 'output2', 'fanOut'].indexOf(node.commandResponseMsgOutput) >= 0 ? node.commandResponseMsgOutput : 'output1'

            // eslint-disable-next-line no-undef
            initMap()
            
            // inherit/upgrade deprecated properties from config
            const hasStoreNameProperty = Object.prototype.hasOwnProperty.call(node, 'storeName') && typeof node.storeName === 'string'
            const hasDeprecatedPersistDynamic = Object.prototype.hasOwnProperty.call(node, 'persistDynamic') && typeof node.persistDynamic === 'boolean'
            if (hasStoreNameProperty) {
                // not an upgrade - accept node.storeName property value
            } else if (hasDeprecatedPersistDynamic) {
                // upgrade from older version
                node.storeName = node.persistDynamic ? 'file' : '' // default to file - that was the only option before
            }

            // populate store names
            const currentStore = node.storeName || ''
            $('#node-input-storeName').empty()
            $('#node-input-storeName').append(`<option value="">None: Don't persist state</option>`)
            $('#node-input-storeName').append(`<option value="file">File: local file system</option>`)
            RED.settings.context.stores.forEach(function(item){
                const defaultStore = RED.settings.hasOwnProperty('context') ? RED.settings.context.default : ''
                if (!item) {
                    return // skip empty store names
                }
                let name = item 
                if (item === defaultStore) {
                    name += ' (default)'
                }
                const opt = $(`<option value="${item}">${"Node Context: " + name}</option>`)
                $('#node-input-storeName').append(opt)
            })

            // if the store does not exist, add it to the dropdown and select it (appended with the text "NOT AVAILABLE!")
            if (currentStore && currentStore !== 'file' && RED.settings.context.stores.indexOf(currentStore) === -1) {
                const opt = $(`<option selected disabled style="color: var(--red-ui-text-color-error) !important;" value="${currentStore}">${"Node Context: " + currentStore + " (INVALID)"}</option>`)
                $('#node-input-storeName').append(opt)
            } else {
                // select the current option
                $('#node-input-storeName').val(currentStore)
            }

            // // hook up the persistDynamic change event - enable/disable storeName select
            // $("#node-input-persistDynamic").on("change", function(e) { 
            //     // $("#node-input-storeName").prop("disabled", !$(this).prop("checked"))
            //     $('#node-input-storeName').toggle($(this).prop("checked"))
            // });

            // create common location typed input
            $('#node-input-defaultLocation').typedInput({
                default: 'default',
                types: [
                    {
                        value: 'default',
                        label: 'Location per schedule',
                        hasValue: false,
                        icon: 'fa fa-map-marker'
                    },
                    {
                        value: 'fixed',
                        label: 'Fixed Location',
                        icon: 'fa fa-map-pin',
                        expand: function () {
                            // eslint-disable-next-line no-undef
                            showMap($('#node-input-defaultLocation'))
                        },
                        validate: function (v, opt) { return !!v && v.length >= 3 }
                    },
                    'env'
                ]
            })
            $('#node-input-defaultLocation').typedInput('type', node.defaultLocationType || 'default')
            $('#node-input-defaultLocation').typedInput('value', node.defaultLocation || '')
            $('#node-input-defaultLocation').on('change', function () {
                const show = $('#node-input-defaultLocation').typedInput('type') === 'default' || !$('#node-input-defaultLocation').typedInput('type')
                $('.cron-node-input-option-location-div').toggleClass('cron-plus-hide-per-location', !show)
            })

            // create the popup dialog for the cron builder
            $('#cron-plus-expression-builder-dialog').dialog({
                autoOpen: false,
                height: 300,
                width: 480,
                minWidth: 400,
                maxWidth: 600,
                modal: true,
                buttons: {
                    Cancel: function () {
                        $('#cron-plus-expression-builder-dialog').dialog('close')
                    },
                    OK: function () {
                        const val = $('#cron-plus-expression-builder').data('cronBuilder').getExpression()
                        const expressionField = $('#cron-plus-expression-builder-dialog').data('opener')
                        if (expressionField && expressionField.length) {
                            expressionField.combobox('value', val || '')
                            // expressionField.focus();
                        }
                        $('#cron-plus-expression-builder-dialog').dialog('close')
                    }
                },
                show: {
                    effect: 'blind',
                    duration: 500
                },
                // eslint-disable-next-line no-unused-vars
                open: function (event) {
                    // $(this).css('padding', '0px 0px 0px 0px');
                    $('.ui-dialog-buttonpane').find('button:contains("OK")').addClass('primary')
                    $('#cron-plus-expression-builder .cron-period-select').change()// cause cronBuilder UI to update
                },
                close: function () {
                    const expressionField = $('#cron-plus-expression-builder-dialog').data('opener')
                    if (expressionField && expressionField.data('customCombobox') && expressionField.data('customCombobox').input) {
                        // expressionField.combobox("value", val || "");
                        expressionField.data('customCombobox').input.focus()
                    }
                },
                hide: {
                    effect: 'explode',
                    duration: 500
                }
            })

            // build cron builder
            if (!$('#cron-plus-expression-builder').data('cronBuilder')) {
                $('#cron-plus-expression-builder').cronBuilder()
            }

            function StringBuilder () {
                const strings = []
                return {
                    push: function (value) {
                        if (value) {
                            if (value instanceof StringBuilder) {
                                strings.push(...value.strings)
                            } else if (Array.isArray(value)) {
                                strings.push(...value)
                            } else {
                                strings.push(value)
                            }
                        }
                        return this
                    },
                    clear: function () {
                        strings.length = 0
                        return this
                    },
                    toString: function (joiner = '\n') {
                        return strings.join(joiner)
                    }
                }
            }

            function drawDynamicSchedulesTable (nodeId, table, spinner, options, callback) {
                if (RED._cron_plus_debug) console.log('drawDynamicSchedulesTable...')
                const $table = $(table)
                const $spinner = $(spinner)
                $table.hide()
                $spinner.show()
                $table.empty()
                $.ajax({
                    type: 'POST',
                    url: 'cronplus/' + nodeId + '/getDynamic',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    dataType: 'json',
                    data: '{}' // dummy data
                })
                    .done(function (response) {
                        if (RED._cron_plus_debug) console.log('cronplus/' + nodeId + '/getDynamic => response:', response)

                        options = options || {}
                        if (options.width) $table.width(options.width)
                        if (options.height) $table.width(options.height)
                        if (options.class) $table.addClass(options.class)

                        if (!response || !response.length) {
                            $spinner.hide()
                            $table.show()
                            $('<div/>' + (options.emptyMessage || 'no data') + '<div>').css({padding: '12px', 'font-size': '24px'}).appendTo($table)
                            return
                        }

                        const itemsToHTML = (items) => {
                            const styleBuilder = new StringBuilder()
                            styleBuilder.push('<' + 'style' + '>')
                            styleBuilder.push('    .accordion-container{')
                            styleBuilder.push('        position: relative;')
                            styleBuilder.push('        width: 100%;')
                            styleBuilder.push('        height: auto;')
                            styleBuilder.push('    }')
                            styleBuilder.push('    .accordion-container .accordion-item{')
                            styleBuilder.push('        position: relative;')
                            styleBuilder.push('        width: 100%;')
                            styleBuilder.push('        height: auto;')
                            styleBuilder.push('        background-color: var(--red-ui-form-button-background);')
                            styleBuilder.push('    }')
                            styleBuilder.push('    .accordion-container .accordion-item > a{')
                            styleBuilder.push('        display: block;')
                            styleBuilder.push('        padding: 10px 15px;')
                            styleBuilder.push('        text-decoration: none;')
                            styleBuilder.push('        color: var(--red-ui-primary-text-color);')
                            styleBuilder.push('        font-weight: 600;')
                            styleBuilder.push('        border-bottom: 1px solid var(--red-ui-primary-border-color);')
                            styleBuilder.push('        -webkit-transition:all 0.2s linear;')
                            styleBuilder.push('        -moz-transition:all 0.2s linear;')
                            styleBuilder.push('        transition:all 0.2s linear;')
                            styleBuilder.push('    }')
                            styleBuilder.push('    .accordion-container .accordion-item > a.active{')
                            styleBuilder.push('        background-color: var(--red-ui-form-input-focus-color)')
                            styleBuilder.push('        color: var(--red-ui-primary-text-color);')
                            styleBuilder.push('    }')
                            styleBuilder.push('    .accordion-container .accordion-item > div{')
                            styleBuilder.push('        background-color: var(--red-ui-primary-background);')
                            styleBuilder.push('        border-bottom: 1px solid var(--red-ui-primary-border-color);')
                            styleBuilder.push('        display:none;')
                            styleBuilder.push('    }')
                            styleBuilder.push('    .accordion-container .accordion-item > div {')
                            styleBuilder.push('        padding: 10px 15px;')
                            styleBuilder.push('        margin: 0;')
                            styleBuilder.push('        color: var(--red-ui-primary-text-color);')
                            styleBuilder.push('    }')
                            styleBuilder.push('    div.accordion-container a > div {')
                            styleBuilder.push('        display: flex;')
                            styleBuilder.push('        flex-flow: row wrap;')
                            styleBuilder.push('        justify-content: space-around;')
                            styleBuilder.push('        padding: 0;')
                            styleBuilder.push('        margin: 0;')
                            styleBuilder.push('    }')
                            styleBuilder.push('    .accordion-container a > div > name,')
                            styleBuilder.push('    .accordion-container a > div > topic,')
                            styleBuilder.push('    .accordion-container a > div > desc{')
                            styleBuilder.push('        flex-grow: 2;')
                            styleBuilder.push('        flex: 2 0 5px;')
                            styleBuilder.push('        white-space: break-word;')
                            styleBuilder.push('        word-break: break-all;')
                            styleBuilder.push('        overflow: hidden;')
                            styleBuilder.push('        text-overflow: ellipsis;')
                            styleBuilder.push('        min-width: 0;')
                            styleBuilder.push('        padding: 0px 6px')
                            styleBuilder.push('    }')
                            styleBuilder.push('    .accordion-container a > div > name{')
                            styleBuilder.push('        flex-grow: 3;')
                            styleBuilder.push('    }')
                            styleBuilder.push('    .accordion-container a > div > topic{')
                            styleBuilder.push('        flex-grow: 3;')
                            styleBuilder.push('    }')
                            styleBuilder.push('    .accordion-container a > div > desc{')
                            styleBuilder.push('        flex-grow: 4;')
                            styleBuilder.push('    }')
                            styleBuilder.push('    .accordion-container  a .accordion-title > i {')
                            styleBuilder.push('        flex: 0 1 20px;')
                            styleBuilder.push('        -webkit-order: 0;')
                            styleBuilder.push('        -ms-flex-order: 0;')
                            styleBuilder.push('        order: 0;')
                            styleBuilder.push('        -webkit-flex: 0 1 auto;')
                            styleBuilder.push('        -ms-flex: 0 1 auto;')
                            styleBuilder.push('        -webkit-align-self: auto;')
                            styleBuilder.push('        -ms-flex-item-align: auto;')
                            styleBuilder.push('        align-self: auto;')
                            styleBuilder.push('    }')
                            styleBuilder.push('    .accordion-container a.active .accordion-title > :not(:first-child,:last-child){')
                            styleBuilder.push('        display: none;')
                            styleBuilder.push('    }')
                            styleBuilder.push('    .accordion-container a.active .accordion-title > name {')
                            styleBuilder.push('        flex: 2;')
                            styleBuilder.push('    }')
                            styleBuilder.push('    .accordion-container .accordion-content code {')
                            styleBuilder.push('        color: var(--red-ui-text-color-code);')
                            styleBuilder.push('    }')
                            styleBuilder.push('<' + '/style' + '>')

                            const scriptBuilder = new StringBuilder()
                            scriptBuilder.push('<' + 'script' + '>')
                            scriptBuilder.push('$(".accordion-container a").on("click", function() {')
                            scriptBuilder.push('    if ($(this).hasClass("active")) {')
                            scriptBuilder.push('    $(this).removeClass("active");')
                            scriptBuilder.push('    $(this).siblings("div").slideUp(200);')
                            scriptBuilder.push('    } else {')
                            scriptBuilder.push('    $(this).addClass("active");')
                            scriptBuilder.push('    $(this).siblings("div").slideDown(200);')
                            scriptBuilder.push('    }')
                            scriptBuilder.push('    $(".accordion-container a:not(.active) i")')
                            scriptBuilder.push('        .removeClass("fa-minus")')
                            scriptBuilder.push('        .addClass("fa-plus");')
                            scriptBuilder.push('    $(".accordion-container a.active i")')
                            scriptBuilder.push('        .removeClass("fa-plus")')
                            scriptBuilder.push('        .addClass("fa-minus");')
                            scriptBuilder.push('});')
                            scriptBuilder.push('<' + '/script' + '>')

                            const htmlBuilder = new StringBuilder()
                            htmlBuilder.push('<div class="accordion-container">')
                            items.forEach(item => {
                                htmlBuilder.push('  <div class="accordion-item">')
                                htmlBuilder.push('    <a href="#">')
                                htmlBuilder.push('      <div class="accordion-title">')
                                htmlBuilder.push(`        <name>${item.config.name}</name>`)
                                htmlBuilder.push(`        <topic>${item.config.topic}</topic>`)
                                htmlBuilder.push(`        <desc>${item.status.nextDescription}</desc>`)
                                htmlBuilder.push('        <i class="fa fa-plus"></i>')
                                htmlBuilder.push('      </div> ')
                                htmlBuilder.push('    </a>')
                                htmlBuilder.push('    <div class="accordion-content">')
                                htmlBuilder.push('      <p>')
                                htmlBuilder.push('        <code>config:</code>')
                                htmlBuilder.push('        <code>')
                                htmlBuilder.push(`          ${JSON.stringify(item.config, null, 1).replace(/\n/g, '')}`)
                                htmlBuilder.push('        </code>')
                                htmlBuilder.push('      </p>')
                                htmlBuilder.push('      <p>')
                                htmlBuilder.push('        <code>status:</code>')
                                htmlBuilder.push('        <code>')
                                htmlBuilder.push(`          ${JSON.stringify(item.status, null, 1).replace(/\n/g, '')}`)
                                htmlBuilder.push('        </code>')
                                htmlBuilder.push('      </p>')
                                htmlBuilder.push('    </div>')
                                htmlBuilder.push('  </div>')
                            })
                            htmlBuilder.push('</div>')
                            const stringBuilder = new StringBuilder()
                            stringBuilder.push(styleBuilder)
                            stringBuilder.push(htmlBuilder)
                            stringBuilder.push(scriptBuilder)
                            return stringBuilder.toString()
                        }

                        // tidy up date for display
                        const data = response.map(function (e, i) {
                            e.item = i + 1
                            if (e.type) {
                                e.payloadType = e.type
                                delete e.type
                            }
                            if (e.payloadType === 'default') e.payload = null

                            if (e.payload && isObject(e.payload)) {
                                try {
                                    e.payload = JSON.stringify(e.payload, undefined, 2)
                                } catch (error) {
                                    e.payload = typeof e.payload
                                }
                            }
                            return e
                        })

                        $table.html(itemsToHTML(data))
                        $table.show()
                        $spinner.hide()
                        if (callback) callback()
                    })
                    .fail(function (jqXHR, textStatus, errorThrown) {
                        if (callback) callback(errorThrown)
                        console.error(jqXHR, textStatus, errorThrown)
                    })
            }

            const dnRepositionResize = function () {
                const w = ($(document).width() < 1025) ? '95%' : '60%'
                if (RED._cron_plus_debug) console.log('dialog-open-drawDynamicSchedulesTable done - should now center and resize width', w)
                $('#cron-plus-dynamic-nodes-dialog').dialog('option', 'width', w)
                $('#cron-plus-dynamic-nodes-dialog').dialog('option', 'position', { my: 'center', at: 'center', of: window })
            }

            $('#cron-plus-dynamic-nodes-dialog').dialog({
                autoOpen: false,
                height: 630,
                minHeight: 400,
                minWidth: 300,
                modal: true,
                buttons: {
                    Refresh: function () {
                        const nodeId = $('#cron-plus-dynamic-nodes-dialog').data('_cron_node_id')
                        drawDynamicSchedulesTable(nodeId, '#cron-plus-dynamic-nodes-table-placeholder', '#cron-plus-dynamic-nodes-loader', {}, dnRepositionResize)
                    },
                    Close: function () {
                        $('#cron-plus-dynamic-nodes-dialog').dialog('close')
                    }
                },
                // eslint-disable-next-line no-unused-vars
                open: function (event) {
                    $(this).css('padding', '0px 0px 0px 0px')
                    $('.ui-dialog-buttonpane').find('button:contains("Close")').addClass('primary')
                    const nodeId = $('#cron-plus-dynamic-nodes-dialog').data('_cron_node_id')
                    dnRepositionResize()
                    drawDynamicSchedulesTable(nodeId, '#cron-plus-dynamic-nodes-table-placeholder', '#cron-plus-dynamic-nodes-loader', dnRepositionResize)
                },
                show: {
                    effect: 'fade',
                    duration: 250
                },
                hide: {
                    effect: 'fade',
                    duration: 250
                }
            })

            $('#cron-plus-dynamic-nodes-dialog').data('_cron_node_id', node.id)
            dnRepositionResize()

            let tzData
            $.ajax({
                type: 'POST',
                url: 'cronplus/0/tz',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                dataType: 'json',
                data: '{}' // dummy data
            })
                .done(function (data) {
                    tzData = data
                    $('#node-input-timeZone').autocomplete({
                        source: function (request, response) {
                            const matcher = new RegExp($.ui.autocomplete.escapeRegex(request.term), 'i')
                            response($.map(tzData, function (item) {
                                if (item && item.tz) {
                                    const label = (item.code ? item.code + ', ' : '') + item.tz + ' (UTC: ' + item.UTCOffset + ', DST: ' + item.UTCDSTOffset + ')'
                                    if (label && (!request.term || matcher.test(label))) {
                                        return {
                                            label,
                                            value: item
                                        }
                                    }
                                }
                            }))
                        },
                        minLength: 1,
                        open: function () {
                            $(this).removeClass('ui-corner-all').addClass('ui-corner-top')
                        },
                        close: function () {
                            $(this).removeClass('ui-corner-top').addClass('ui-corner-all')
                        },
                        focus: function (event, ui) {
                            event.preventDefault()
                            $('#node-input-timeZone').val(ui.item.label)
                        },
                        select: function (event, ui) {
                            event.preventDefault()
                            this.value = ui.item.value.tz
                        }
                    })
                })
                .fail(function (jqXHR, textStatus, errorThrown) {
                    console.error(jqXHR, textStatus, errorThrown)
                })

            const formatDateTimeWithTZ = function (date, tz) {
                if (!date) {
                    return ''
                }
                let dateString
                const o = {
                    timeZone: tz || undefined,
                    timeZoneName: 'short',
                    hour12: false,
                    year: 'numeric',
                    month: 'short',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                }
                try {
                    dateString = new Intl.DateTimeFormat('default', o).format(new Date(date))
                } catch (error) {
                    dateString = 'Error. Check timezone setting'
                }
                return dateString
            }

            const makeSolarChoice = function (value, label, tooltip) {
                return {
                    label,
                    value: value || label,
                    title: tooltip,
                    multiple: true
                }
            }

            const solarChoices = [
                makeSolarChoice('nightEnd', 'night end / astronomical dawn', 'night ends, astronomical twilight starts (-18°)'), // needed? same as astronomicalDawn
                // makeSolarChoice("astronomicalDawn", "astronomical dawn", "night ends, astronomical twilight starts (-18°)"),
                makeSolarChoice('nauticalDawn', 'nautical dawn', 'astronomical twilight ends, nautical twilight starts (-12°)'),
                makeSolarChoice('civilDawn', 'civil dawn / golden hour', 'nautical twilight ends, civil twilight and golden hour starts (-6°)'),
                // makeSolarChoice("morningGoldenHourStart", "golden hour starts", "when the sun is 6 degrees below the horizon (-6°)"), //needed? same as civilDawn
                makeSolarChoice('sunrise', 'sunrise', 'top edge of the sun appears on the horizon (-0.833°)'),
                makeSolarChoice('sunriseEnd', 'sunrise end', 'bottom edge of the sun touches the horizon (-0.3°)'),
                makeSolarChoice('morningGoldenHourEnd', 'morning golden hour ends', 'when the sun is 6 degrees above the horizon (6°)'),
                makeSolarChoice('solarNoon', 'solar noon', 'sun is at its highest position'),
                makeSolarChoice('eveningGoldenHourStart', 'evening golden hour start', 'when the sun is 6 degrees above the horizon (6°)'),
                makeSolarChoice('sunsetStart', 'sunset start', 'bottom edge of the sun touches the horizon (-0.3°)'),
                makeSolarChoice('sunset', 'sunset', 'civil twilight starts, sun disappears below the horizon (-0.833°)'),
                // makeSolarChoice("eveningGoldenHourEnd", "evening golden hour end","golden hour ends (-6°)"), //needed? same as civilDusk
                makeSolarChoice('civilDusk', 'civil dusk / golden hour end', 'civil twilight and golden hour ends, nautical twilight starts (-6°)'),
                makeSolarChoice('nauticalDusk', 'nautical dusk', 'nautical twilight ends, astronomical twilight starts (-12°)'),
                // makeSolarChoice("astronomicalDusk", "astronomical dusk", "astronomical twilight ends, night starts (-18°)"),
                makeSolarChoice('nightStart', 'astronomical dusk / night start', 'astronomical twilight ends, night starts (-18°)'), // needed? same as astronomicalDusk
                makeSolarChoice('nadir', 'solar midnight', 'when the sun is closest to nadir and the night is equidistant from dusk and dawn')
            ]

            function isObject (o) {
                return (typeof o === 'object' && o !== null)
            }

            /**
             * Apply defaults to the cron schedule object
             * @param {integer} optionIndex An index number to use for defaults
             * @param {object} option The option object to update
            */
            function applyOptionDefaults (optionIndex, option) {
                if (isObject(option) === false) {
                    return// no point in continuing
                }
                optionIndex = optionIndex == null ? 0 : optionIndex
                if (['cron', 'dates', 'solar'].indexOf(option.expressionType) < 0) {
                    // if expressionType is not cron or solar - it may be sunrise or sunset
                    if (option.expressionType === 'sunrise') {
                        option.solarEvents = option.solarEvents || 'sunrise'
                        option.expressionType = 'solar'
                    } else if (option.expressionType === 'sunset') {
                        option.solarEvents = option.solarEvents || 'sunset'
                        option.expressionType = 'solar'
                    } else {
                        if (!option.expression) {
                            option.expressionType = 'cron'
                        } else {
                            if (!isCronLike(option.expression)) {
                                option.expressionType = 'dates'
                            } else if (isDateSequenceLike(option.expression)) {
                                option.expressionType = 'dates'
                            } else {
                                option.expressionType = 'cron'
                            }
                        }
                    }
                }
                option.name = option.name || 'schedule' + (optionIndex + 1)
                option.topic = option.topic || 'topic' + (optionIndex + 1)
                option.payloadType = option.payloadType || option.type || 'default'
                delete option.type
                if (option.expressionType === 'cron' && !option.expression) option.expression = '0 * * * * * *'
                if (!option.solarType) option.solarType = option.solarEvents ? 'selected' : 'all'
                if (!option.solarEvents) option.solarEvents = 'sunrise,sunset'
                if (!option.location) option.location = ''
                // option.version = 1;
            }

            /**
             * Generate an option row on the UI
             * @param {integer} optionIndex the index number of this schedule
             * @param {object} option The option object to present
            */
            function generateOption (optionIndex, option) {
                if (RED._cron_plus_debug) { console.log('generating option', optionIndex, option) }
                applyOptionDefaults(optionIndex, option)
                function buildExpressionTip (title, desc, text, type) {
                    const helpFunc = type === 'solar' ? 'showSolarHelp();' : 'showCronHelp();'
                    const helpFuncPopOut = type === 'solar' ? "_popoutCronPlusHelp('cron-plus-solar-events-info');" : "_popoutCronPlusHelp('cron-plus-expression-info');"
                    const helpFuncHtml = '<span style="float: right">' +
                        '<button id="cron-plus-tt-help-button" class="cron-plus-link-button" onclick="' + helpFunc + '">help </button>&nbsp;' +
                        '<button class="cron-plus-link-button" onclick="' + helpFuncPopOut + '"> <i class="fa fa-external-link"></i></button></span>'
                    return '<div style="min-height:190px"><span style="font-size: 12px; font-weight: bold">' + title + '</span>' +
                        helpFuncHtml +
                        '<hr><div>' + desc + '</div>' +
                        '<pre class="cron-plus-form-tip form-tips">' + text + '</pre></div>'
                }
                function initTooltip (selector, type, pos) {
                    if (selector.typedInput('instance') && selector.typedInput('instance').input) {
                        selector = selector.typedInput('instance').input
                    }
                    const $selector = $(selector)
                    //clear any title attr to prevent default tooltip & permit the jquery tooltip plugin to work
                    $selector.attr('title', ' ')
                    $selector.off('mouseenter').tooltip({
                        show: { effect: 'fade' },
                        tooltipClass: 'cron-plus-expression-tip form-tips',
                        position: pos,
                        content: function () {
                            return buildExpressionTip('Expression...', 'Getting description...', '', type)
                        },
                        disabled: true
                    }).off('focusout').off('mouseleave').mouseleave(function (e) {
                        if (RED._cron_plus_debug) console.log('initTooltip--mouseleave')
                        if ($selector.is(':focus')) {
                            if (RED._cron_plus_debug) console.log("initTooltip--mouseleave selector:is(':focus')")
                            e.preventDefault()
                            e.stopImmediatePropagation()
                            // selector.tooltip('open');
                            return false
                        }
                    }).on('blur', function (e) {
                        if (RED._cron_plus_debug) console.log('initTooltip-->on-blur.  relatedTarget:', e.relatedTarget)
                        if (e.relatedTarget && e.relatedTarget.id === 'cron-plus-tt-help-button') {
                            if (RED._cron_plus_debug) console.log('blur-->e.relatedTarget.relatedTarget.className == "cron-plus-link-button"')
                            if (type === 'cron') { showCronHelp() } else if (type === 'solar') { showSolarHelp() }
                            $(this).focus()
                            return false
                        }
                        $(this).tooltip('close').tooltip('disable')
                    }).on('focusin change keyup', function (e) {
                        if (RED._cron_plus_debug) console.log('initTooltip--focusin change keyup', e)
                        const $this = $(this)

                        const $timeZone = $('#node-input-timeZone')
                        const $expressionType = $this.closest('li').find('.node-input-option-expressionType')
                        const expressionType = $expressionType.val()
                        const $location = $this.closest('li').find('.node-input-option-location')
                        const $expression = $this.closest('li').find('.node-input-option-expression')
                        let expression
                        if (expressionType === 'solar') {
                            const defLocation = $('#node-input-defaultLocation').typedInput('value')
                            const defLocationType = $('#node-input-defaultLocation').typedInput('type')
                            if (defLocationType === 'env' || defLocationType === 'fixed') {
                                expression = defLocation
                            } else {
                                expression = $location.typedInput('value')
                            }
                        } else {
                            expression = $expression.val()
                        }
                        if (!expression) {
                            $this.tooltip('close').tooltip('disable')
                            return
                        }
                        const $offset = $this.closest('li').find('.node-input-option-offset')
                        const $solarEvents = $this.closest('li').find('.node-input-option-solarEvents')
                        $this.tooltip('enable').tooltip('open')
                        $this.tooltip('option', 'position', pos)
                        $this.tooltip({
                            position: pos,
                            disabled: false,
                            show: { effect: 'fade' },
                            content: function (callback) {
                                if (RED._cron_plus_debug) console.log('initTooltip-->content')

                                const solarType = $solarEvents.typedInput('type')
                                const solarEvents = $solarEvents.typedInput('value')
                                const expressionType = $expressionType.val()
                                const offset = $offset.val()
                                const timeZone = $timeZone.val()
                                let titleHtml
                                const e = { expressionType }
                                if (timeZone) e.timeZone = timeZone
                                if (expressionType === 'solar') {
                                    titleHtml = (expr) => {
                                        const title = '<b>solar events</b> at <span class="cron-plus-expression">' + expr.slice(0, 100) + (expr.length > 100 ? '...' : '') + '</span>'
                                        // eslint-disable-next-line eqeqeq
                                        if (offset != null && offset !== '0' && offset !== 0) {
                                            titleHtml += '<b>'
                                            if (offset > 0) titleHtml += ' +'
                                            titleHtml += offset + ' minute'
                                            // eslint-disable-next-line eqeqeq
                                            if (offset != '1' && offset != '-1') titleHtml += 's'
                                            titleHtml += '</b>'
                                        }
                                        return title
                                    }
                                    e.offset = offset
                                    e.location = expression
                                    e.solarType = solarType
                                    e.solarEvents = solarEvents
                                    e.defaultLocationType = $('#node-input-defaultLocation').typedInput('type')
                                    e.defaultLocation = $('#node-input-defaultLocation').typedInput('value')
                                    e.flowId = node.z
                                    e.nodeId = node.id
                                    e.nodeGroupId = node.g
                                    const env = []
                                    if (node.g) {
                                        let gId = node.g
                                        let group = RED.nodes.group(gId)
                                        while (group) {
                                            if (group.env && group.env.length) {
                                                env.push(...group.env)
                                            }
                                            gId = group.g
                                            group = RED.nodes.group(gId)
                                        }
                                    }
                                    if (node.z && RED.nodes.workspace(node.z) && RED.nodes.workspace(node.z).env) {
                                        env.push(...RED.nodes.workspace(node.z).env)
                                    }
                                    e.env = env
                                } else {
                                    titleHtml = (expr) => 'Description of <span class="cron-plus-expression">' + expr.slice(0, 50) + (expr.length > 50 ? '...' : '') + '</span>'
                                    e.expression = expression
                                }
                                if (RED._cron_plus_debug) console.log('initTooltip-->Ajax start, e...', e)
                                $.ajax({
                                    type: 'POST',
                                    url: `cronplus/${node.id}/expressionTip`,
                                    headers: {
                                        'Accept': 'application/json',
                                        'Content-Type': 'application/json'
                                    },
                                    dataType: 'json',
                                    data: JSON.stringify(e)
                                })
                                    .done(function (data) {
                                        if (RED._cron_plus_debug) console.log('initTooltip-->Ajax done, data...', data)
                                        let nextInfo = ''
                                        const desc = data.description
                                        if (data.prettyNext) {
                                            nextInfo = 'Next event: ' + data.prettyNext
                                            if (data.nextDates && data.nextDates.length) {
                                                nextInfo = nextInfo + ' then...'
                                                const makeTR = function (x) {
                                                    let v = x; let s = '<i class="fa fa-clock-o"></i>'
                                                    if (typeof x === 'object' && x.timeOffset) {
                                                        v = x.timeOffset
                                                        s = x.event || 'unknown'
                                                    }
                                                    const fd = formatDateTimeWithTZ(v, timeZone)
                                                    v = fd || undefined
                                                    return '<tr><td>' + s + '</td><td>' + v + '</td></tr>'
                                                }
                                                const map1 = data.nextDates.map(makeTR)
                                                nextInfo += '<table class=>' + map1.join('\n') + '</table>'
                                            }
                                        }
                                        const okContent = function () {
                                            setTimeout(function () {
                                                if (RED._cron_plus_debug) console.log('initTooltip-->callback-->setTimeout--> option-->position')
                                                $this.tooltip('option', 'position', pos)
                                                $this.tooltip('enable').tooltip('open')
                                                $this.tooltip('option', 'position', pos)
                                            }, 200)
                                            const expr = data.expressionType === 'solar' ? data.location : data.expression
                                            return buildExpressionTip(titleHtml(expr), desc, nextInfo, expressionType)
                                        }
                                        callback(okContent)
                                        $this.tooltip('option', 'position', pos)
                                    })
                                    .fail(function (jqXHR, textStatus, errorThrown) {
                                        console.error(jqXHR, textStatus, errorThrown)
                                        const errContent = buildExpressionTip('Error...', 'Cannot get description from node-red', '', expressionType)
                                        callback(errContent)
                                    })
                            }
                        })
                    })
                }
                if (RED._cron_plus_debug) { console.log('setting up schedule fields') }
                // styles for the option row 1
                const nameStyle = 'display: flex; flex-grow: 0; flex-basis:128px; margin-right:5px;'
                const topicStyle = 'display: flex; flex-grow: 1; flex-basis: 140px; margin-right: 5px;'
                const payloadStyle = 'display: flex; flex-grow: 2; flex-basis: 250px;'
                // styles for the option row 2
                const scheduleTypeStyle = 'display: flex; flex-grow: 0; flex-basis:128px; margin-right:5px; padding-left: 2px; padding-right: 10px;' // padding hack for text alignment
                const row2Col2Style = 'display: flex; flex-grow: 1;'
                // row 2 col 2 child styles (for solar)
                const solarEventsStyle = 'display: flex; flex-grow: 1; flex-basis: 140px; margin-right: 5px;'
                const locationStyle = 'display: flex; flex-grow: 3; width:100%; margin-right:5px;'
                const solarOffsetStyle = 'display: flex; flex-grow: 0; flex-basis:180px;'

                // control buttons container styles
                const controlsContainerStyle = 'float: right; height: 74px; margin-left: 5px; flex-direction: column; display: flex; justify-content: space-evenly; align-items: center; border-left: var(--red-ui-form-button-background) 1px solid; padding-left: 5px;'

                // build options row
                const container = $('<li/>')
                // const container = $('<li/>', { style: 'max-width: 600px' })

                // row buttons
                const controlsContainer = $('<span/>', { style: controlsContainerStyle }).appendTo(container)
                const deleteButton = $('<a/>', { href: '#', class: 'editor-button editor-button-small', style: '' }).appendTo(controlsContainer)
                $('<i/>', { class: 'fa fa-remove' }).appendTo(deleteButton)
                RED.popover.tooltip(deleteButton, 'Delete');
                const sortHandle = $('<a/>', { href: '#', class: 'editor-button editor-button-small node-input-option-handle', style: 'cursor: grab' }).appendTo(controlsContainer)
                $('<i/>', { class: 'fa fa-bars' }).appendTo(sortHandle)
                RED.popover.tooltip(sortHandle, 'Move');

                // #### ROW 1 ####
                const row1 = $('<div style="display: flex; margin: 0px 0px 5px 0px"/>').appendTo(container)

                // generate the name field
                const nameClass = 'node-input-option-name' + ((!option.name || dupCheck[option.name]) ? ' input-error' : '')
                const nameField = $('<input/>', { class: nameClass, type: 'text', style: nameStyle, placeholder: 'name', title: 'name', value: option.name }).appendTo(row1)
                dupCheck[option.name] = true

                // generate the topic field
                const topicClass = 'node-input-option-topic' + ((!option.topic) ? ' input-error' : '')
                const topicField = $('<input/>', { class: topicClass, type: 'text', style: topicStyle, placeholder: 'topic', title: 'topic', value: option.topic }).appendTo(row1)

                // generate the payload field
                const payloadDiv = $('<div/>', { style: payloadStyle }).appendTo(row1)
                const payloadField = $('<input/>', { class: 'node-input-option-payload', type: 'text', style: 'width: 100%', placeholder: 'payload', value: option.payload || '' }).appendTo(payloadDiv)
                payloadField.typedInput({
                    default: option.payloadType || 'default',
                    types: [{
                        icon: 'fa fa-envelope',
                        value: 'default',
                        label: 'Default Payload',
                        hasValue: false
                    }, 'flow', 'global', 'str', 'num', 'bool', 'json', 'jsonata', 'bin', 'date', 'env']
                })

                // #### ROW 2 ####
                const row2 = $('<div style="display: flex; margin: 0px 0px 5px 0px"/>').appendTo(container)

                // generate a dropdown for schedule type
                const scheduleType = option.expressionType || 'cron'
                const scheduleTypeField = $('<select/>', { class: 'node-input-option-expressionType', type: 'text', placeholder: 'cron', style: scheduleTypeStyle }).appendTo(row2)
                $('<option />', { value: 'cron', text: 'cron' }).appendTo(scheduleTypeField)
                $('<option />', { value: 'dates', text: 'date sequence' }).appendTo(scheduleTypeField)
                $('<option />', { value: 'solar', text: 'solar events' }).appendTo(scheduleTypeField)
                scheduleTypeField.val(scheduleType)
                scheduleTypeField.prop('title', 'Expression Type')

                // generate cell2 
                const cell2Cron = $('<div>', { style: row2Col2Style}).appendTo(row2)
                const cell2Solar = $('<div>', { style: row2Col2Style}).appendTo(row2)


                // generate a combo for cron expression
                const expression = option.expression == null ? '0 * * * * * *' : option.expression
                const expressionClass = 'node-input-option-expression' + ((!expression) ? ' input-error' : '')
                const expressionMenuData = [
                    { label: 'Easy Expression Builder', value: 'EEB' },
                    { label: 'Every Second (* * * * * *)', value: '* * * * * *' },
                    { label: 'Every minute (0 * * * * *)', value: '0 * * * * *' },
                    { label: 'Every 10 minutes (0 */10 * * * *)', value: '0 */10 * * * *' },
                    { label: 'Every day at noon - 12pm (0 0 12 * * *)', value: '0 0 12 * * *' },
                    { label: 'Every 20 minutes, at 9:00 AM and 5:00 PM (0 */20 9,17 * * *)', value: '0 */20 9,17 * * *' },
                    { label: 'At 15, 30, and 45 minutes past the hour (0 15,30,45 * * * *)', value: '0 15,30,45 * * * *' },
                    { label: 'At 02:00 AM, on day 29 of Feb (0 0 2 29 FEB * 2020/4)', value: '0 0 2 29 FEB * 2020/4' },
                    { label: 'At 07:00 AM, on the 1st Mon of the month (0 0 7 * * MON#1 *)', value: '0 0 7 * * MON#1 *' },
                    { label: 'Every day at noon in Jan, Mar & Dec (0 0 12 * JAN,MAR,DEC *)', value: '0 0 12 * JAN,MAR,DEC *' },
                    { label: 'Every minute, on the 1st weekday of the month (* * 1W * *)', value: '* * 1W * *' },
                    { label: 'Every minute, on the third Tue of the month (* * * * Tue#3)', value: '* * * * Tue#3' },
                    { label: 'At 12:00 PM, on the last Monday of the month (0 12 * * MONL)', value: '0 12 * * MONL' }
                ]

                const expressionField = $('<input/>', {
                    class: expressionClass,
                    type: 'text',
                    placeholder: '* * * * * * *',
                    list: 'cron-expression-example-list',
                    title: 'cron expression',
                    value: option.expression
                })
                expressionField.appendTo(cell2Cron)

                // setup the expression combo
                expressionField.combobox({
                    style: 'width: 100%',
                    menu: {
                        menu: expressionMenuData,
                        options: {
                            beforeSelect: function (opt) {
                                if (opt && opt.value === 'EEB') {
                                    $('#cron-plus-expression-builder-dialog').data('opener', expressionField)
                                    $('#cron-plus-expression-builder-dialog').dialog('open')
                                    return true // return true to let widget know - we have handled this
                                }
                            }
                        }
                    },
                    validate: function (value) {
                        return (!!value) && value.length >= 9// better validation required?
                    }
                })
                try {
                    expressionField.combobox().button.prop('title', 'Expression examples...')
                    expressionField.combobox('instance').button.prop('title', 'Expression examples...')
                    // eslint-disable-next-line no-empty
                } catch (error) { }
                expressionField.combobox('value', option.expression || '')

                // generate the solar events field
                const solarEventsDiv = $('<div/>', { style: solarEventsStyle }).appendTo(cell2Solar)
                const solarEventsField = $('<input/>', { class: 'node-input-option-solarEvents', type: 'text', style: 'width: 100%', placeholder: 'select solar events', value: option.solarEvents || '' }).appendTo(solarEventsDiv)
                solarEventsField.typedInput({
                    default: 'all',
                    types: [
                        {
                            value: 'selected',
                            label: 'Selected Solar Events',
                            title: 'Selected Solar Events',
                            icon: 'fa fa-list',
                            showLabel: false,
                            multiple: true,
                            options: solarChoices,
                            default: ['sunrise', 'sunset']
                        },
                        {
                            value: 'all',
                            label: 'All Solar Events',
                            title: 'All Solar Events',
                            icon: 'fa fa-sun-o',
                            hasValue: false,
                            showLabel: true
                        }
                    ]
                })
                solarEventsField.typedInput('type', option.solarType || 'all')
                solarEventsField.typedInput('value', option.solarEvents || '')// added as setting value on invocation doesnt seem to set the "2 selected" text of the widget!

                // generate location
                const locationFieldDiv = $('<div/>', { class: 'cron-node-input-option-location-div', style: locationStyle }).appendTo(cell2Solar)
                const locationField = $('<input/>', { class: 'node-input-option-location', type: 'text', style: 'width: 100%', placeholder: 'lat lng', value: option.location || '' }).appendTo(locationFieldDiv)
                locationField.typedInput({
                    default: 'fixed',
                    types: [
                        {
                            value: 'fixed',
                            label: 'Fixed Location',
                            icon: 'fa fa-map-pin',
                            expand: function () {
                                // eslint-disable-next-line no-undef
                                showMap(locationField)
                            },
                            validate: function (v, opt) { return !!v && v.length >= 3 }
                        }
                    ]
                })
                locationField.typedInput('value', option.location || '')

                // const locationGroup = $('<div class="red-ui-typedInput-container node-input-option-location" style="' + locationStyle + '">' +
                //     '<button class="red-ui-typedInput-type-select" style="width:25px" title="Show Map..."><i class="fa fa-map-marker "> </i></button>' +
                //     '<div class="red-ui-typedInput-input red-ui-typedInput-input-wrap" style="left: 25px; right: 0px;">' +
                //     '<input class="red-ui-typedInput-input node-input-option-location" type="text" value="" placeholder="lat lng"></div> </div>')
                // const locationField = locationGroup.find('input')
                // const locationButton = locationGroup.find('button')
                // locationField.prop('title', 'Location coordinates...')
                // locationButton.prop('title', 'Show Map...')
                // if (!option.location) {
                //     locationGroup.addClass('input-error')
                // } else {
                //     locationField.val(option.location)
                // }
                // locationGroup.appendTo(cell2)

                // locationButton.on('click', function () {
                //     $('#cron-plus-map-dialog').dialog('open')
                //     selectedLocationInput = $(this).closest('li').find('.node-input-option-location')
                //     if (navigator.onLine === true) {
                //         $('.cron-plus-map-not-loaded').show()
                //         $('.cron-plus-map-loading').hide()
                //         $('#cron-plus-map').hide()
                //         const proto = location.protocol === 'https:' ? location.protocol : 'http:'
                //         checkLoadJsCssFile(proto + '//libs.cartocdn.com/cartodb.js/v3/3.11/themes/css/cartodb.css', 'css', function () {
                //             checkLoadJsCssFile(proto + '//libs.cartocdn.com/cartodb.js/v3/3.11/cartodb.uncompressed.js', 'js', function () {
                //             })
                //             createMap(selectedLocationInput)
                //         })
                //     } else {
                //         $('.cron-plus-map-not-loaded').show()
                //         $('.cron-plus-map-loading').hide()
                //         $('#cron-plus-map').hide()
                //     }
                // })

                // offset fields
                const offsetField = $('<input/>', { class: 'node-input-option-offset', type: 'number', min: -1439, max: 1439, style: solarOffsetStyle, value: option.offset || 0, placeholder: 'offset' }).appendTo(cell2Solar)
                offsetField.prop('title', 'Minutes Offset +/- 1439')

                // init tooltips
                initTooltip(offsetField, 'solar', { my: 'middle top', at: 'middle bottom+5', of: cell2Solar, collision: 'flipfit' })
                initTooltip(locationField, 'solar', { my: 'middle top', at: 'middle bottom+5', of: cell2Solar, collision: 'flipfit' })
                initTooltip(expressionField, 'cron', { my: 'middle top', at: 'middle bottom+5', of: cell2Cron, collision: 'flipfit' })

                // locationField.keyup(function () {
                //     const f = $(this)
                //     const fg = locationGroup
                //     if (f.val() && fg.hasClass('input-error')) {
                //         fg.removeClass('input-error')
                //     } else if (!f.val()) {
                //         fg.addClass('input-error')
                //     }
                // })

                nameField.keyup(function () {
                    if ($(this).val() && $(this).hasClass('input-error')) {
                        $(this).removeClass('input-error')
                    } else if (!$(this).val()) {
                        $(this).addClass('input-error')
                    }
                })

                // locationField.change(function () {
                //     if ($(this).val() && locationGroup.hasClass('input-error')) {
                //         locationGroup.removeClass('input-error')
                //     } else if (!$(this).val()) {
                //         locationGroup.removeClass('input-error')
                //     }
                // })

                topicField.keyup(function () {
                    if ($(this).val() && $(this).hasClass('input-error')) {
                        $(this).removeClass('input-error')
                    } else if (!$(this).val()) {
                        $(this).addClass('input-error')
                    }
                })

                deleteButton.click(function () {
                    container.fadeOut(200, function () {
                        $(this).remove()
                    })
                })

                scheduleTypeField.change(function () {
                    const value = scheduleTypeField.val()
                    const showLocationGroup = $('#node-input-defaultLocation').typedInput('type') === 'default' || !$('#node-input-defaultLocation').typedInput('type')
                    locationFieldDiv.toggleClass('cron-plus-hide-per-location', !showLocationGroup)
                    switch (value) {
                    case 'solar':
                        cell2Cron.hide()
                        cell2Solar.show()
                        break
                        case 'dates':
                        cell2Cron.show()
                        cell2Solar.hide()
                        expressionField.combobox('hideMenu')
                        break
                    default: // cron
                        cell2Cron.show()
                        cell2Solar.hide()
                        expressionField.combobox('showMenu')
                        break
                    }
                })
                scheduleTypeField.triggerHandler('change')
                $('#node-input-option-container').append(container)
            }

            $('#node-input-outputField').typedInput({ types: [{ label: 'msg.', value: 'str' }] })

            $('#node-input-add-option').click(function () {
                generateOption($('#node-input-option-container').children().length, {})
                $('#node-input-option-container-div').scrollTop($('#node-input-option-container-div').get(0).scrollHeight)
                // focus the input with class .node-input-option-name in the last li added
                $('#node-input-option-container').children().last().find('.node-input-option-name').focus().select()
            })

            $('#node-input-show-dynamic').click(function () {
                $('#cron-plus-dynamic-nodes-dialog').dialog('open')
            })

            removeEventListener("fullscreenchange", onSchedulesExpandCompress);
            addEventListener("fullscreenchange", onSchedulesExpandCompress)

            $('#cronplus-expand-schedules-button').click(function (evt) {
                const selector = '#node-cronplus-tab-static-schedules'
                if (evt) {
                    // prevent the default behaviour - we will handle it
                    evt.preventDefault()
                    evt.stopImmediatePropagation()
                }

                // if shift key or middle mouse button or already full screen then toggle full screen
                if (evt.shiftKey || evt.button === 1 /* middle button */ || document.fullscreenElement) {
                    toggleFullscreen(selector, function (err) {
                        updateEditorLayout()
                    })
                } else {
                    //CSS expansion/contraction
                    const el = $(selector)
                    const isSmall = el.css('position') !== 'fixed' && !document.fullscreenElement;
                    if (isSmall) {
                        // is small - make it big
                        el.addClass('cron-plus-expanded-element').removeClass('cron-plus-fullscreen-element')
                    } else {
                        // is big - make it small
                        el.removeClass('cron-plus-expanded-element').removeClass('cron-plus-fullscreen-element')
                    }
                    updateEditorLayout()
                }
            })

            for (let i = 0; i < this.options.length; i++) {
                const option = this.options[i]
                try {
                    generateOption(i, option)
                } catch (error) {
                    console.warn('generateOption caused an error: ', option, error)
                }
            }

            $('#node-input-option-container').sortable({
                axis: 'y',
                handle: '.node-input-option-handle',
                cursor: 'grabbing',
                cursorAt: { right: 5 },
                // placeholder: "ui-corner-all"
                snap: "#node-input-option-container", snapMode: "inner",
                forceHelperSize: true,
                forcePlaceholderSize: true,
                tolerance: 'pointer',
                appendTo:  $('#node-input-option-container'),
            })

            updateEditorLayout()

            // give the form a chance to render then remove the max width restriction
            setTimeout(function () {
                $('#node-cronplus-tab-static-schedules').css('max-width', '')
            }, 200)

        },
        oneditsave: function () {
            if (RED._cron_plus_debug) { console.log('oneditsave - cronplus') }
            removeEventListener("fullscreenchange", onSchedulesExpandCompress);
            const node = this
            const options = $('#node-input-option-container').children()
            delete node.persistDynamic // remove deprecated property

            node.options = []
            // eslint-disable-next-line no-unused-vars
            options.each(function (i) {
                const option = $(this)
                const o = {
                    name: option.find('.node-input-option-name').val(),
                    topic: option.find('.node-input-option-topic').val(),
                    payloadType: option.find('.node-input-option-payload').typedInput('type'),
                    payload: option.find('.node-input-option-payload').typedInput('value'),
                    expressionType: option.find('.node-input-option-expressionType').val(),
                    expression: option.find('.node-input-option-expression').val(),
                    location: option.find('.node-input-option-location').typedInput('value'),
                    offset: option.find('.node-input-option-offset').val(),
                    solarType: option.find('.node-input-option-solarEvents').typedInput('type') || 'all',
                    solarEvents: option.find('.node-input-option-solarEvents').typedInput('value')
                }
                if (option.find('.node-input-option-value').typedInput('type') === 'num') {
                    o.payload = Number(o.value)
                }
                if (option.find('.node-input-option-value').typedInput('type') === 'bool') {
                    // eslint-disable-next-line eqeqeq
                    o.payload = (o.value == 'true')
                }
                node.options.push(o)
            })
            const o = $('#node-input-commandResponseMsgOutput').val()
            node.commandResponseMsgOutput = ['output1', 'output2', 'fanOut'].indexOf(o) >= 0 ? o : 'output1'
            const fanOut = node.commandResponseMsgOutput === 'fanOut'
            node.outputs = node.commandResponseMsgOutput === 'output1' ? 1 : 2
            node.defaultLocationType = $('#node-input-defaultLocation').typedInput('type')
            node.defaultLocation = $('#node-input-defaultLocation').typedInput('value')
            if (fanOut && options && options.length) {
                node.outputs = options.length + 2 // in fanout mode, we add a separate output for dynamic schedules & command responses
            }
            $('#node-input-timeZone').off()
            $('#node-input-crontab').off()
        },
        oneditcancel: function() {
            if (RED._cron_plus_debug) { console.log('oneditcancel - cronplus') }
            removeEventListener("fullscreenchange", onSchedulesExpandCompress);
            $('#node-input-timeZone').off()
            $('#node-input-crontab').off()
        },
        button: {
            visible: function () {
                if (this.options && this.options.length === 1) {
                    return true
                }
                return false
            },
            enabled: function () {
                return !this.changed
            },
            onclick: function () {
                if  (RED._cron_plus_debug) { console.log('button.onclick - cronplus') }
                const node = this
                if (node.changed) {
                    return RED.notify(RED._('notification.warning', { message: RED._('notification.warnings.undeployedChanges') }), 'warning')
                }
                let label = node._def.label.call(node)
                if (label.length > 30) {
                    label = label.substring(0, 50) + '...'
                }
                label = label.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
                $.ajax({
                    url: 'cronplusinject/' + node.id,
                    type: 'POST',
                    // eslint-disable-next-line no-unused-vars
                    success: function (response) {
                        RED.notify(node._('inject.success', { label }), { type: 'success', id: 'inject' })
                    },
                    // eslint-disable-next-line no-unused-vars
                    error: function (jqXHR, textStatus, errorThrown) {
                        if (jqXHR.status === 404) {
                            RED.notify(node._('common.notification.error', { message: node._('common.notification.errors.not-deployed') }), 'error')
                        } else if (jqXHR.status === 500) {
                            RED.notify(node._('common.notification.error', { message: node._('inject.errors.failed') }), 'error')
                        } else if (jqXHR.status === 0) {
                            RED.notify(node._('common.notification.error', { message: node._('common.notification.errors.no-response') }), 'error')
                        } else {
                            RED.notify(node._('common.notification.error', { message: node._('common.notification.errors.unexpected', { status: jqXHR.status, message: textStatus }) }), 'error')
                        }
                    }
                })
            }
        },
        oneditresize: function () {
            // console.log("RESIZING")
            updateEditorLayout()
            // HACK for old versions of node-red - prior to typedInput resizing changed from code to CSS
            if (RED.settings.version && RED.settings.version.split('.')[0] < 1) {
                const tics = $('.red-ui-typedInput-container')
                if (tics && tics.length) {
                    for (let idx = 0; idx < tics.length; idx++) {
                        const element = $(tics[idx])
                        if (element && element.length && element.is(':visible')) {
                            element.css('display', 'inline-block')
                        }
                    }
                }
            }
        }
    })
})(jQuery)

function _popoutCronPlusHelp(tag) {
    const startTag = (name) => `<${name}>`
    const endTag = (name) => `</${name}>`
    const winHtml = `
        ${startTag('html')}
            ${startTag('head')}
                ${startTag('title')}cron-plus help${endTag('title')}
                ${startTag('style')}
                .fade-in {
                    transition: opacity 1.5s ease-in-out;
                }
                .hidden {
                    opacity: 0;
                    visibility: hidden;
                }
                ${endTag('style')}
            ${endTag('head')}
            ${startTag('body')}
                ${startTag('script')}
                    const styles = ${JSON.stringify([].map.call(document.querySelectorAll('[rel="stylesheet"]'), e =>  e.href ))}
                    const head = document.head || document.getElementsByTagName('head')[0]
                    styles.forEach(href => {
                        const el = document.createElement('link');
                        el.rel="stylesheet"
                        el.href = href
                        head.appendChild(el);
                    })
                ${endTag('script')}
                <div class="red-ui-editor help-content hidden" style="height: 100%">
                    <div class="red-ui-sidebar-info">
                        <div class="red-ui-sidebar-help-stack red-ui-panels" style="height: 100%;">
                            <div class="red-ui-panel" style="overflow-y: auto;height: 100%;">
                                <div class="red-ui-help" style="padding: 6px;height: 100%;">
                                    <h1 class="red-ui-help-title">cron-plus</h1>
                                    <div class="red-ui-help">
                                        <span class="red-ui-text-bidi-aware">
                                            ${RED.nodes.getNodeHelp('cronplus')}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                ${startTag('script')}
                    if (navigator.clipboard) {
                        document.querySelector('.cron-plus-link-button').classList.add('hidden')
                        const content = document.querySelector('.help-content');
                        content.classList.add('hidden')
                        content.classList.remove('hidden')
                        content.classList.add('fade-in')
                        const copyButtonLabel = "Copy"
                        const blocks = document.querySelectorAll("pre.cron-plus-code")
                        blocks.forEach((block) => {
                            const button = document.createElement("button")
                            button.innerText = copyButtonLabel
                            button.classList.add('cron-plus-copy-button')
                            button.addEventListener("click", copyCode)
                            block.appendChild(button)
                        })
                    }
                    async function copyCode(event) {
                        const button = event.srcElement
                        const pre = button.parentElement
                        const code = pre.querySelector("code")
                        const text = code.innerText
                        await navigator.clipboard.writeText(text)
                    }
                ${endTag('script')}
            ${endTag('body')}
        ${endTag('html')}`

    const BOM = new Uint8Array([0xEF,0xBB,0xBF])
    const winUrl = URL.createObjectURL(
        new Blob([BOM, winHtml], { encoding:"UTF-8",type:"text/html;charset=UTF-8" })
    )
    const win = window.open(
        winUrl + (tag ? '#' + tag : ''),
        'win',
        'width=800,height=600'
    )
}

function onSchedulesExpandCompress () {
    const selector = '#node-cronplus-tab-static-schedules'
    const el = $(selector)
    const $buttonExpandIcon = $('#cronplus-expand-schedules-button').find('i.fa')
    const isBig = el.css('position') === 'fixed' || document.fullscreenElement;
    if (isBig) {
        // is big - set the icon to compress & hide certain elements
        $buttonExpandIcon.removeClass('fa-expand').addClass('fa-compress')
        $('#node-input-show-dynamic').addClass('cron-plus-vanish-element')
    } else {
        // is small - set the icon to expand & show elements
        $buttonExpandIcon.removeClass('fa-compress').addClass('fa-expand')
        $('#node-input-show-dynamic').removeClass('cron-plus-vanish-element')
    }
}

</script>

<script type="text/html" data-template-name="cronplus">
    <style>
        #cron-plus-map > div.leaflet-map-pane > div.leaflet-objects-pane > div.leaflet-popup-pane > div > div.leaflet-popup-content-wrapper,
        #cron-plus-map > div.leaflet-map-pane > div.leaflet-objects-pane > div.leaflet-popup-pane > div > div.leaflet-popup-tip-container > div {
            background-color: var(--red-ui-primary-background);
            color: var(--red-ui-primary-text-color);
        }
        #cron-plus-map > div.leaflet-control-container > div.leaflet-top.leaflet-left > div > a.leaflet-control-zoom-in,
        #cron-plus-map > div.leaflet-control-container > div.leaflet-top.leaflet-left > div > a.leaflet-control-zoom-out {
            background-color: var(--red-ui-primary-background);
            color: var(--red-ui-primary-text-color);
        }

        .cron-select-period {
            padding: 5px 5px 0px 5px;
        }

        .cron-input {
            padding: 5px 5px 0px 5px;
        }

        .cron-select-period select,
        .cron-input select,
        .cron-input input[type=radio], 
        .cron-input input[type=checkbox] {
            margin-left: 5px;
            margin-right: 5px;
        }        

        table.cron-plus-table {
            border: solid 1px var(--red-ui-secondary-background);
            border-collapse: collapse;
            border-spacing: 0;
        }
        table.cron-plus-table th {
            background-color: var(--red-ui-primary-background);
            border: solid 1px var(--red-ui-secondary-background);
            color: var(--red-ui-primary-text-color);
            text-align: left;
        }
        table.cron-plus-table > tr > td {
            font-family: monospace;
            font-size: 10pt;
            border: solid 1px var(--red-ui-secondary-background);
            color: var(--red-ui-primary-text-color);
            background: var(--red-ui-tertiary-background);
        }
        .cron-plus-form-row > label {
            width: 120px !important;
        }
        .cron-plus-expression-tip {
            background: var(--red-ui-primary-background);
            color: var(--red-ui-primary-text-color);
            width: 100%;
            max-width: 500px;
            max-height: 300px;
            overflow: auto;
            font-size: 10px;
        }
        .cron-plus-form-tip {
            background: var(--red-ui-primary-background);
            color: var(--red-ui-primary-text-color);
            padding: 6px 6px;
            vertical-align: middle;
            font-size: 12px;
            line-height: 20px;
            box-sizing: border-box;
            overflow: auto;
            word-break: keep-all;
        }
        .cron-plus-form-tip > div {
            white-space: pre-wrap;
        }
        span .cron-plus-form-tip {
            border-radius: 2px;
            border: 1px solid var(--red-ui-secondary-background);
            border-radius: 4px;
            display: inline-block;
        }
        .cron-plus-form-tip-spacer {
            display: inline-block;
            width: 100px
        }
        .cron-plus-expression {
            font-family: monospace;
            padding-left: 5px;
            padding-right: 5px;
            text-align: left;
            height: 30px;
            vertical-align: middle;
            border-bottom: 1px solid var(--red-ui-primary-text-color)
        }
        #cron-plus-map {
            height: 100%;
            padding: 0;
            margin: 0;
        }
        .cron-plus-hide-per-location {
            display: none !important;
            visibility: hidden;
        }
        .cron-plus-hide-location {
            display: none !important;
            visibility: hidden;
        }
        .cron-plus-fullscreen-element {
            padding: 15px;
            z-index: 99999;
            background-color: var(--red-ui-form-background);
        }
        .cron-plus-expanded-element {
            position: fixed;
            z-index: 99999;
            top: 0px;
            left: 0px;
            bottom: 0px;
            right: 0px;
            visibility: visible;
            height: unset !important;
            width: unset !important;
            padding: 15px;
            margin: 0px;
            background-color: var(--red-ui-form-background);
        }
        .cron-plus-vanish-element {
            display: none !important;
            visibility: hidden !important;
        }
        .cron-plus-map-dialog-content {
            padding: 0px 0px 0px 0px;
        }
        .cron-plus-map-not-loaded {
            padding: 2px 10px 2px 10px;
        }
        .cron-plus-map-loading {
            padding: 2px 10px 2px 10px;
        }
        .cron-plus-coordinates {
            font-family: monospace;
            background: var(--red-ui-primary-text-color);
            color: var(--red-ui-primary-background);
            padding-left: 5px;
            padding-right: 5px;
            border: 1px solid var(--red-ui-secondary-background);
        }
        .cron-plus-link-button {
            background: none!important;
            border: none!important;
            padding: 0!important;
            cursor: pointer!important;
            color: var(--red-ui-primary-text-color);
        }
        .cron-plus-solar-events-table {
            font-size: smaller;
            padding: 0px !important;
            margin: 0px !important;
            width: 100%;
            overflow-wrap: break-word;
            border: 1px solid;
        }
        .cron-plus-solar-events-table tr td {
            border: 1px dotted;
        }
        .cron-plus-solar-events-table tr th {
            text-align: left;
            border: 1px dotted;
        }
        pre.cron-plus-code {
            white-space: pre;
            font-size: 9px;
            position: relative;
            overflow: auto;
            margin: 5px 0;
            padding: 1rem;
            border-radius: 4px;
        }
    </style>  

    <div id="cron-plus-map-dialog" style="display: none;" title="Choose location...">
        <div class="cron-plus-map-loading" >
            <h3>Attempting to load map... <i class="fa fa-spinner fa-spin" style="font-size:24px"></i></h3>
            <p>The interactive Map is loaded via CDN at client side (to minimise installation size) and therefore requires an internet connection. Please wait 1 moment.</p>
            <h4>Alternative ways to get coordinates...</h4>
            <ul> 
                <li>Visit <a href="https://www.latlong.net/" target="_blank" rel="noopener noreferrer">www.latlong.net</a> (on another device if required) then copy the "Lat Long" value provided into the cron-plus coordinates box</li>
                <li>Visit google maps, MSN maps, almost any other maps website on another device to get GPS or longitude latitude value</li>
                <li>Try one of the many longitude latitude apps available in the app store on your mobile phone</li>
                <li>Check your satnav device - it may show coordinates</li>
                <li>Use a topographic map</li>
                <li>Ask a friend</li>
            </ul>
            <h4>Accepted formats...</h4> 
            <ul>
                <li>Decimal Degrees E.g: <code class="cron-plus-coordinates">54.9992500,-1.4170300</code> or <code class="cron-plus-coordinates">54.9992500° N 1.4170300° W</code></li>
                <li>Degrees Minutes Seconds E.g: <code class="cron-plus-coordinates">54° 59' 57.3'' N 1° 25' 1.308'' W</code></li>
                <li>Decimal Minutes E.g: <code class="cron-plus-coordinates">54° 59.955' , -1° 25.0218'</code></li>
                <li>GPS E.g: <code class="cron-plus-coordinates">N54°59'57.3, W1°25'1.308"</code>, <code class="cron-plus-coordinates">54°59'57.3"N, 1°25'1.308"W</code>, <code class="cron-plus-coordinates">54d 59' 57" N 1d 25' 1" W</code> or <code class="cron-plus-coordinates">54:59:57.3N 1:25:1.308W</code></li>
            </ul>    
        </div>
        <div class="cron-plus-map-not-loaded"  style="display:hidden" >
            <h3>No internet on this device?</h3>
            <p>The interactive Map is loaded via CDN at client side (to minimise installation size) and therefore requires an internet connection. As you are seeing this message, it is likely this device does not have access to the internet.</p>
            <h4>Alternative ways to get coordinates...</h4>
            <ul> 
                <li>Visit <a href="https://www.latlong.net/" target="_blank" rel="noopener noreferrer">www.latlong.net</a> (on another device if required) then copy the "Lat Long" value provided into the cron-plus coordinates box</li>
                <li>Visit google maps, MSN maps, almost any other maps website on another device to get GPS or longitude latitude value</li>
                <li>Try one of the many longitude latitude apps available in the app store on your mobile phone</li>
                <li>Check your satnav device - it may show coordinates</li>
                <li>Use a topographic map</li>
                <li>Ask a friend</li>
            </ul>
            <h4>Accepted formats...</h4>
            <ul>
                <li>Decimal Degrees E.g: <code class="cron-plus-coordinates">54.9992500,-1.4170300</code> or <code class="cron-plus-coordinates">54.9992500° N 1.4170300° W</code></li>
                <li>Degrees Minutes Seconds E.g: <code class="cron-plus-coordinates">54° 59' 57.3'' N 1° 25' 1.308'' W</code></li>
                <li>Decimal Minutes E.g: <code class="cron-plus-coordinates">54° 59.955' , -1° 25.0218'</code></li>
                <li>GPS E.g: <code class="cron-plus-coordinates">N54°59'57.3, W1°25'1.308"</code>, <code class="cron-plus-coordinates">54°59'57.3"N, 1°25'1.308"W</code>, <code class="cron-plus-coordinates">54d 59' 57" N 1d 25' 1" W</code> or <code class="cron-plus-coordinates">54:59:57.3N 1:25:1.308W</code></li>
            </ul>
        </div>
        <div id="cron-plus-map"></div>
    </div>

    <div id="cron-plus-dynamic-nodes-dialog" style="display: none;" title="Dynamic schedules...">
        <div id="cron-plus-dynamic-nodes-table-placeholder"  style="display: flex;align-items: center;/*justify-content: center;*/">
        </div>
        <div id="cron-plus-dynamic-nodes-loader" style="position: absolute;  left: 46%;  top: 46%;">
            <i class="fa fa-spinner fa-spin" style="font-size:48px"></i>
        </div>
    </div>

    <div id="cron-plus-expression-builder-dialog" style="display: none;" title="Easy Expression Builder...">
        <div id="cron-plus-expression-builder" >
        </div>
    </div>

    <!-- For Rows -->
    <div class="form-row cron-plus-form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name">Name</span></label>
        <input type="text" id="node-input-name" style="width: calc(100% - 130px)" placeholder="Name">
    </div>
    <div class="form-row cron-plus-form-row">
        <label for="node-input-outputField"><i class="fa fa-sign-out"></i> Output property</label>
        <input type="text" id="node-input-outputField" style="width: calc(100% - 130px)" placeholder="payload">
    </div>
    <div class="form-row cron-plus-form-row">
        <label for="node-input-timeZone"><i class="fa fa-globe"></i> Timezone</label>
        <input type="text" id="node-input-timeZone" style="width: calc(100% - 130px)" placeholder="Leave empty for none/system">
    </div>
    <div class="form-row cron-plus-form-row">
        <label for="node-input-defaultLocation"><i class="fa fa-map-marker"></i> Location</label>
        <input type="text" id="node-input-defaultLocation" style="width: calc(100% - 130px)" placeholder="lat lng (optional)">
    </div>
    <div class="form-row cron-plus-form-row">
        <label for="node-input-commandResponseMsgOutput"><i class="fa fa-dot-circle-o"></i> Outputs</label>
        <select style="width: calc(100% - 130px)" id="node-input-commandResponseMsgOutput">
          <option value="output1">1 output: All messages to output 1</option>
          <option value="output2">2 outputs: Schedule messages to output 1, command responses to output 2</option>
          <option value="fanOut" >Fan out: Separate outputs for static, dynamic and command messages</option>
        </select>
    </div>
    <div class="form-row cron-plus-form-row">
        <label for="node-input-storeName"><i class="fa fa-database"></i> Save State</label>
        <select type="text" id="node-input-storeName" style="width: calc(100% - 130px);"></select>
    </div>

    <div id="node-cronplus-tab-static-schedules" class="form-row cron-plus-form-row form-row-auto-height"
        style="width: 100%; min-height: 200px; display: flex; flex-flow: column nowrap; max-width: min-content">
        <!-- Row 1 -->
        <div style="display: flex; justify-content: space-between;">
            <label for="node-input-option-container-div" style="vertical-align:top;flex-basis: 120px;">
                <i class="fa fa-list-alt"></i> 
                Schedules
            </label>
            <div style="flex-grow: 1; column-gap: 2px; margin-bottom: 2px; margin-top: 0px; display: flex; padding: 0px 0px 0px 4px;">
                <!-- Toolbar -->
                <a href="#" accesskey="a" title="Add a new schedule [A]" class="editor-button editor-button-small" id="node-input-add-option">
                    <span><i class="fa fa-plus" style="margin-right: 2px;"></i> <u>a</u>dd</span>
                </a>
                <a href="#"  accesskey="s" title="Show dynamic schedules [S]" class="editor-button editor-button-small" id="node-input-show-dynamic">
                    <span><i class="fa fa-table" style="margin-right: 2px;"></i> dynamic <u>s</u>chedules</span>
                </a>
                <a href="#" accesskey="x" class="editor-button editor-button-small" id="cronplus-expand-schedules-button" title="Hold the shift key for fullscreen [X]" style="margin-left: auto;">
                    <span class="expand-icon"><i class="fa fa-expand" style="margin-right: 2px;"></i> e<u>x</u>pand</span>
                </a>
            </div>
        </div>
        <!-- Row 2 (the list) -->
        <div class="red-ui-editableList-border red-ui-editableList-container" id="node-input-option-container-div"
            style="min-width: 300px;box-sizing: border-box;border-radius: 5px;padding: 5px;overflow-y:scroll;display: inline-block;height: calc(100% - -4px);min-height: 150px;">
            <ol id="node-input-option-container" style=" list-style-type:none; margin: 0;" class="ui-sortable"></ol>
        </div>
    </div>

</script>

<script type="text/html" data-help-name="cronplus">
    <style>
        .cron-plus-link-button {
            background: none!important;
            border: none!important;
            padding: 0!important;
            cursor: pointer!important;
            color: var(--red-ui-primary-text-color);
        }
        pre.cron-plus-code button.cron-plus-copy-button {
            position: absolute;
            padding: 2px;
            background-color: var(--red-ui-primary-text-color);
            color: var(--red-ui-primary-background);
            border: ridge 1px var(--red-ui-secondary-text-color);
            border-radius: 15px;
            opacity: 0.35;
            top: 0px;
            right: 4px;
            scale: 70%;
            transform-origin: right;
        }
        pre.cron-plus-code button.cron-plus-copy-button:hover{
            cursor: pointer;
            opacity: 0.9;
        }
        .red-ui-help pre.cron-plus-code {
            position: relative;
        }
    </style>
    <p>Schedule the injection of a payload to start a flow <span style="float: right"><button class="cron-plus-link-button" onclick="_popoutCronPlusHelp()">pop out <i class="fa fa-external-link"></i></button></span></p>
    <h3>Properties</h3>
    <dl class="message-properties">
        <h4>Output property</h4>
        <div style="padding-left: 15px">
            The <code>msg.</code> property to send the payload to.  Typically this would be payload.
        </div>
        <h4>Timezone (optional)</h4>
        <div style="padding-left: 15px">
            A timezone to use. Leave blank for system timezone. Alternatively, enter UTC or a timezone in the format of Region/Area (<a target="_blank" href="https://en.wikipedia.org/wiki/List_of_tz_database_time_zones">list</a>)
            <br>
            TIP: Timezone should be perceived from your own perspective. See the <a href="#understanding-timezone">Understanding Timezone</a> example below.
        </div>    
        <h4>Location (optional)</h4>
        <div style="padding-left: 15px">
            Here you can chose to set a common location for all solar events (optional)
        </div>    
        <h4>Outputs</h4>
        <div style="padding-left: 15px">
            <ul>
                <li>1 output: All messages to output 1 (schedules + command responses)</li>
                <li>2 outputs: Schedule messages to output 1, command responses to output 2</li>
                <li>Fan out: Separate outputs for static, dynamic and command messages</li>
            </ul>
        </div>    
        <h4>Persist dynamic schedules</h4>
        <div style="padding-left: 15px">
            Enabling this option causes dynamic schedules to be saved to file and re-loaded when the cron-plus node is loaded or re-deployed. <br>
            NOTES...
            <ul>
                <li>Any time an update to any dynamic schedule occurs, all dynamic schedules are saved to file</li>
                <li>The schedules are saved in a directory called <code>cronplusdata</code> under your node-red folder</li>
            </ul>
        </div>    
        <h4>Schedules</h4>
        <div style="padding-left: 15px">
            A table of schedules. Entries here are considered static and will be reloaded when node-red starts or the cron-plus node is (re)deployed.
        </div>
        <h4>Schedules - Name</h4>
        <div style="padding-left: 15px">
            The name is used to identify the schedule. Dynamic adjustments to an individual schedule will need to specify this name.
        </div>
        <h4>Schedules - Topic</h4>
        <div style="padding-left: 15px">
            The topic will be sent in <code>msg.topic</code> when the schedule triggers. This is to permit the flow to act on the triggered schedule.
        </div>
        <h4>Schedules - Payload</h4>
        <div style="padding-left: 15px">
            The value to send in the payload when the schedule triggers. (NOTE: the property that the payload gets written to is determined by "Output property").
        </div>
        <h4>Schedules - Type</h4>
        <div style="padding-left: 15px">
            The type determines what type of schedule. Options are <code>cron</code>, <code>dates sequence</code> or <code>solar events</code>
        </div>
        <h4 id="cron-plus-expression-info">Schedules - Expression</h4>
        <div style="padding-left: 15px">
            <i>NOTE: Only displayed when the type is set to <b>cron</b> or <b>date sequence</b></i><br>
            A CRON expression, a date, a comma separated list of dates or an array of dates<br><br>
            <p> Date or Date Sequence Format...<br>
                When you wish to use a fixed date or sequence of dates, the expression can be a string date, comma separated list of dates, an array of dates (The array can contain a mix of string, date objects and timestamps).
                When specifying a string date, you can use timezone e.g. "2020-01-01 00:00 GMT+2".
                You can even mix time zones e.g. "2020-01-01 00:00 GMT+2, 2020-01-01 00:00 GMT-7"
            </p>
            <p>CRON Format...</p>
            <pre style="white-space: pre; padding: 0px; font-size: smaller;"> * * * * * * *    Field              Allowed values    Special symbols
 | | | | | | |    -----------------  ---------------   ---------------
 `-|-|-|-|-|-|->  Second (optional)  0-59              * / , -
   `-|-|-|-|-|->  Minute             0-59              * / , -
     `-|-|-|-|->  Hour               0-23              * / , -
       `-|-|-|->  Day of Month       1-31              * / , - ? L W
         `-|-|->  Month              1-12 or JAN-DEC   * / , -
           `-|->  Day of Week        0-7 or SUN-SAT    * / , - ? L #
             `->  Year (optional)    1970-2099         * / , -</pre>
            <p>Notes...</p>
            <ul>
                <li><code>*</code> Asterisks indicate that the cron expression matches for all values of the field. For example, "*" in the minute field means every minute</li>
                <li><code>?</code> Question marks are used to specify 'no specific value' and is allowed for the day-of-month and day-of-week fields. It is used instead of the asterisk (*) for leaving either day-of-month or day-of-week blank.</li>
                <li><code>-</code> Hyphens are used to define ranges. For example, "10-12" in the hour field means the hours of 10, 11, and 12.</li>
                <li><code>,</code> Commas are used to separate items of a list. For example, "MON,WED,FRI" in the day-of-week field means the days Monday, Wednesday, and Friday.</li>
                <li><code>/</code> Forward slash are used to indicate increments. For example. "0/15" in the seconds field means the seconds 0, 15, 30, and 45. Additionally, "1/3" in the day-of-month field means every 3 days starting on the first day of the month.</li>
                <li><code>L</code> Short-hand for "last" and is allowed for the day-of-month and day-of-week fields. The "L" character has a different meaning in each of the two fields. For example, "L" in the day-of-month field means the last day of the month. If used in the day-of-week field, it means 7 or SAT. However, if used in the day-of-week field after another value, it means the last xxx day of the month. For example, "6L" in the day-of-week field means the last Friday of the month</li>
                <li><code>W</code> Short-hand for "weekday" and is allowed for the day-of-month field. The "W" character is used to specify the weekday nearest the given day. For example, "15W" in the day-of-month field means the nearest weekday to the 15th of the month. Therefore, if the 15th is a Saturday, the job runs on Friday the 14th. The "L" and "W" characters can be combined in the day-of-month field. For example, "LW" means the last weekday of the month.</li>
                <li><code>#</code> Hash marks specify constructs. For example, "6#3' in the day-of-week field means the third Friday of the month.</li>
            </ul>        
            <p>Examples...</p>
            <ul>
                <li><code>* * * * * *</code> Every Second</li>
                <li><code>0 * * * * *</code> Every minute</li>
                <li><code>0 */10 * * * *</code> Every 10 minutes</li>
                <li><code>0 */20 1 * * *</code> Every 20 minutes, between 01:00 AM and 01:59 AM</li>
                <li><code>0 15,30,45 * * * *</code> At 15, 30, and 45 minutes past the hour</li>
                <li><code>0 0 12 * * *</code> Every day at noon - 12pm</li>
                <li><code>0 0 2 29 FEB * 2020/4</code> At 02:00 AM, on day 29 of February (leap years)</li>
                <li><code>0 0 7 * * MON#1 *</code> At 07:00 AM, on the first Monday of the month</li>
                <li><code>0 0 12 * JAN,FEB,MAR,APR *</code> Every day at noon in January, February, March and April</li>
                <li><code>* * 1W * *</code> Every minute, on the first weekday of the month</li>
                <li><code>* * * * Tue#3</code> Every minute, on the third Tuesday of the month</li>
                <li><code>0 12 * * MONL</code> At 12:00 PM, on the last Monday of the month</li>
                <li>See <a href="https://github.com/jaclarke/cronosjs">here</a> for more examples and info</li>
            </ul>
        </div>
        <h4 id="cron-plus-solar-events-info">Schedules - Solar Events</h4>
        <div style="padding-left: 15px">
            <i>NOTE: Only displayed when the type is set to <b>solar events</b></i><br>
            The Solar Events field permits you to chose which solar events you want a schedule to fire upon.<br>
            Solar Events...
            <table class="cron-plus-solar-events-table">
                <tr><th>Event ID</th><th>Event</th><th>Information</th></tr>
                <tr><td>nightEnd</td><td>night end / astronomical dawn</td><td>night ends, astronomical twilight starts (-18°)</td></tr>
                <!-- <tr><td>astronomicalDawn</td><td>astronomical dawn</td><td>night ends, astronomical twilight starts (-18°)")</td></tr> -->
                <tr><td>nauticalDawn</td><td>nautical dawn</td><td>astronomical twilight ends, nautical twilight starts (-12°)</td></tr>
                <tr><td>civilDawn</td><td>civil dawn / golden hour</td><td>nautical twilight ends, civil twilight and golden hour starts (-6°)</td></tr>
                <!-- <tr><td>morningGoldenHourStart</td><td>golden hour starts</td><td>when the sun is 6 degrees below the horizon (-6°)")</td></tr> -->
                <tr><td>sunrise</td><td>sunrise</td><td>top edge of the sun appears on the horizon (-0.833°)</td></tr>
                <tr><td>sunriseEnd</td><td>sunrise end</td><td>bottom edge of the sun touches the horizon (-0.3°)</td></tr>
                <tr><td>morningGoldenHourEnd</td><td>morning golden hour ends</td><td>when the sun is 6 degrees above the horizon (6°)</td></tr>
                <tr><td>solarNoon</td><td>solar noon</td><td>sun is at its highest position</td></tr>
                <tr><td>eveningGoldenHourStart</td><td>evening golden hour start</td><td>when the sun is 6 degrees above the horizon (6°)</td></tr>
                <tr><td>sunsetStart</td><td>sunset start</td><td>bottom edge of the sun touches the horizon (-0.3°)</td></tr>
                <tr><td>sunset</td><td>sunset</td><td>civil twilight starts, sun disappears below the horizon (-0.833°)</td></tr>
                <!-- <tr><td>eveningGoldenHourEnd</td><td>evening golden hour end</td><td>golden hour ends (-6°)")</td></tr> -->
                <tr><td>civilDusk</td><td>civil dusk / golden hour end</td><td>civil twilight and golden hour ends, nautical twilight starts (-6°)</td></tr>
                <tr><td>nauticalDusk</td><td>nautical dusk</td><td>nautical twilight ends, astronomical twilight starts (-12°)</td></tr>
                <!-- <tr><td>astronomicalDusk</td><td>astronomical dusk</td><td>astronomical twilight ends, night starts (-18°)</td></tr> -->
                <tr><td>nightStart</td><td>astronomical dusk / night start</td><td>astronomical twilight ends, night starts (-18°)</td></tr>
                <tr><td>nadir</td><td>solar midnight</td><td>when the sun is closest to nadir and the night is equidistant from dusk and dawn</td></tr>
            </table>
        </div>
        <h4>Schedules - Location</h4>
        <div style="padding-left: 15px">
            <i>NOTE: Only displayed when the type is set to <b>solar events</b></i><br>
            The location field is expected to contain longitude and latitude coordinates for the calculation of solar events.<br>
            Accepted formats...
            <ul>
                <li>Decimal Degrees E.g: <code class="cron-plus-coordinates">54.9992500,-1.4170300</code> or <code class="cron-plus-coordinates">54.9992500° N 1.4170300° W</code></li>
                <li>Degrees Minutes Seconds E.g: <code class="cron-plus-coordinates">54° 59' 57.3'' N 1° 25' 1.308'' W</code></li>
                <li>Decimal Minutes E.g: <code class="cron-plus-coordinates">54° 59.955' , -1° 25.0218'</code></li>
                <li>GPS E.g: <code class="cron-plus-coordinates">N54°59'57.3, W1°25'1.308"</code>, <code class="cron-plus-coordinates">54°59'57.3"N, 1°25'1.308"W</code>, <code class="cron-plus-coordinates">54d 59' 57" N 1d 25' 1" W</code> or <code class="cron-plus-coordinates">54:59:57.3N 1:25:1.308W</code></li>
            </ul>
        </div>        
        <h4>Schedules - Offset</h4>
        <div style="padding-left: 15px">
            <i>NOTE: Only displayed when the type is set to <b>solar events</b></i><br>
            The offset field can be used to add a positive or negative offset in minutes to the sunrise or sunset time.
        </div>        

    </dl>
    <h3>Output</h3>
    <dl class="message-properties">
        <dt><i>payload (see 'Output property')</i> <span class="property-type">number|string|boolean|object|buffer</span></dt>
        <dd>msg.[Output property] will contain whatever is configured in 'payload'</dd>
        <dd>e.g. if 'Output property' is set to <b>data.value</b> then <code>msg.data.value</code> will contain the value of the <i>payload</i></dd>
        <dd>msg.topic will contain the name of the schedule. This simplifies separating out which schedule has triggered</dd>
        <dd>Additional properties are also added to the msg object. Check the debug output (use show complete msg)</dd>
    </dl>

    <h3>Inputs <i>(Advanced Usage)</i></h3>
    <dl class="message-properties">
        <dt><i>topic</i> <span class="property-type">string</span></dt>
        <dd>Most of the commands can be provided in the topic with the name of schedule in the payload (where appropriate). <br>Supported command topics... 
                    <ul>
                        <li>trigger</li>
                        <li>status</li>
                        <li>export</li>
                        <li>remove</li>
                        <li>pause</li>
                        <li>stop</li>
                        <li>start</li>
            </ul>
            This includes the <code>-all</code>, <code>-all-dynamic</code>, <code>-all-static</code>, <code>-active</code>,  <code>-active-dynamic</code>,  <code>-active-static</code>, <code>-inactive</code>, <code>-inactive-dynamic</code> and <code>-inactive-static</code> command topics (e.g. export-all, stop-all-dynamic, start-all-static, remove-inactive-dynamic)<br>
            See <a href="#cron-plus-commands-info">commands</a> below for details.
        </dd>
    </dl>
    <dl class="message-properties">
        <dt><i>payload</i> <span class="property-type">string|object|Array</span></dt>
        <dd>It is possible to dynamically add, remove and control schedules by injecting a payload into the node. The format of the payload object (or array of objects) depends on the operation. See below for details.</dd>
        <dd>
            <p><b>Adding one (or more) schedules</b><br>
                Example...<br>
                <pre class="cron-plus-code"><code>payload: [
  {
    "command": "add",
    "name": "every 6",
    "expression": "*/6 * * * * * *",
    "expressionType": "cron",
    "payloadType": "default",
    "limit": 3 
  },
  {
    "command": "add",
    "name": "new years eve 2030",
    "expression": "2030-01-01",
    "expressionType": "dates",
    "payloadType": "default"
  },
  {
    "command": "add",
    "name": "alarm1",
    "expressionType": "solar",
    "solarType": "selected",
    "solarEvents": "civilDawn,sunrise,sunset",
    "location": "54.999320540937035 -1.417407989501953",
    "offset": "-60",
    "payloadType": "str",
    "payload": "In 60 mins, it will be a great time to take photographs",
    "limit": null
  }
]</code></pre>
                
                <p><i>Details...</i><br>
                    Adding a CRON expression
                    <ul>
                        <li>Multiple schedules can be added if the payload is an array of objects</li>
                        <li>command: (string|required) The operation to perform - in this case "add"</li>
                        <li>name: (string|required) This will identify schedule</li>
                        <li>topic: (string|required) This will be used as the topic when the schedule triggers</li>
                        <li>expression: (string|required) A CRON expression, a date, a comma separated list of dates or an array of dates</li>
                        <li>expressionType: (string|optional) specify the schedule type. (if omitted, "cron" is the default)</li>
                        <li>payloadType: (string|optional) The payload type (e.g. 'default', 'flow', 'global', 'str', 'num', 'bool', 'json', 'bin', 'date' or 'env')</li>
                        <li>payload: (any|optional) What to send when schedule triggers</li>
                        <li>limit: (number|optional) Maximum number of times the schedule should trigger</li>
                    </ul><br>
                    Adding a date sequence
                    <ul>
                        <li>Multiple schedules can be added if the payload is an array of objects</li>
                        <li>command: (string|required) The operation to perform - in this case "add"</li>
                        <li>name: (string|required) This will identify schedule</li>
                        <li>topic: (string|required) This will be used as the topic when the schedule triggers</li>
                        <li>expression: (string|array|required) A date, a comma separated list of dates or an array of dates</li>
                        <li>expressionType: (string|required) specify the schedule type - in this case "dates"</li>
                        <li>payloadType: (string|optional) The payload type (e.g. 'default', 'flow', 'global', 'str', 'num', 'bool', 'json', 'bin', 'date' or 'env')</li>
                        <li>payload: (any|optional) What to send when schedule triggers</li>
                        <li>limit: (number|optional) Maximum number of times the schedule should trigger</li>
                    </ul><br>
                    Adding a solar event schedule
                    <ul>
                        <li>Multiple schedules can be added if the payload is an array of objects</li>
                        <li>command: (string|required) The operation to perform - in this case "add"</li>
                        <li>name: (string|required) This will identify schedule</li>
                        <li>topic: (string|required) This will be used as the topic when the schedule triggers</li>
                        <li>expressionType: (string|required) specify the schedule type. Set to "solar" for solar events</li>
                        <li>solarType: (string|required) specify the events to fire.  Accepted values are "all" or "selected"</li>
                        <li>solarEvents: (string|optional) specify the events to fire. Only required when solarType == "selected". Accepted values are listed under <b>Schedules - Solar Events</b> <a href="#cron-plus-solar-events-info">see above</a> </li>
                        <li>location: (string|required) longitude latitude, DNS, DMM or GPS coordinates for sunrise or sunset</li>
                        <li>offset: (number|optional) number of minutes to offset a sunrise or sunset</li>
                        <li>payloadType: (string|optional) The payload type (e.g. 'default', 'flow', 'global', 'str', 'num', 'bool', 'json', 'bin', 'date' or 'env')</li>
                        <li>payload: (any|optional) What to send when schedule triggers</li>
                        <li>limit: (number|optional) Maximum number of times the schedule should trigger</li>
                    </ul>
                </p>
            </p>
            <p><i>Notes...</i><br>
                <ul>
                    <li>This option has no output.</li>
                </ul>
            </p>

            <p id="cron-plus-commands-info"><b>Getting status of a schedule or removing / stopping / pausing / starting a schedule</b><br><br>
                Topic Method...<br>
                <pre class="cron-plus-code"><code>msg.topic = "command"; // command name - *see details below*,
msg.payload = "name"; //  name of the schedule</code></pre>
                Payload Method...<br>
                <pre class="cron-plus-code"><code>payload: {
  "command": "*see details below*",
  "name": "* name of schedule",
}</code></pre>
                <p><i>Details...</i><br>
                    <ul>
                        <li>command: (string|required) The operation to perform - this can be one of the following...
                            <ul>
                                <li>"trigger"</li>
                                <li>"status"</li>
                                <li>"export"</li>
                                <li>"remove"</li>
                                <li>"stop"</li>
                                <li>"pause"</li>
                                <li>"start"</li>
                            </ul>
                        </li>
                        <li>name: (string|optional) The name of the schedule to affect (not required when using the -all, -active or -inactive filters)</li>
                    </ul>
                </p>
                <p><i>Notes...</i><br>
                    <ul>
                        <li><code>trigger</code> fires schedule named in <code>msg.payload</code> </li>
                        <li><code>status</code> returns an object with the config and status of the named schedule</li>
                        <li><code>export</code> returns an object with the config of the named schedule</li>
                        <li><code>remove</code> will stop and remove the schedule. This option has no output.</li>
                        <li><code>stop</code> will stop the schedule specified by <code>name</code> and reset its internal counter. This option has no output.</li>
                        <li><code>pause</code> will stop the schedule specified by <code>name</code> but will not reset its internal counter. This option has no output.</li>
                        <li><code>start</code> will (re)start all schedules. Any schedule that reached its limit will start from the beginning. Paused schedules will resume. This option has no output.</li>
                        <li>FILTER: adding <code>-all</code> to any of these commands will operate on all schedules. e.g. <code>status-all</code> will return the status of all schedules</li>
                        <li>FILTER: adding <code>-all-dynamic</code> to any of these commands will only affect dynamic schedules e.g. <code>remove-all-dynamic</code> will remove all dynamic schedules</li>
                        <li>FILTER: adding <code>-all-static</code> to any of these commands will only affect static schedules e.g. <code>stop-all-static</code></li>
                        <li>FILTER: adding <code>-active</code> to status, export and remove commands will operate on all active schedules. e.g. <code>status-active</code> </li>
                        <li>FILTER: adding <code>-active-static</code> to status, export and remove commands will operate on all static schedules that are active. e.g. <code>status-active-static</code></li>
                        <li>FILTER: adding <code>-active-dynamic</code> to status, export and remove commands will operate on all dynamic schedules that are active. e.g. <code>status-active-dynamic</code></li>
                        <li>FILTER: adding <code>-inactive</code> to status, export and remove commands will operate on all inactive schedules. e.g. <code>status-inactive</code> </li>
                        <li>FILTER: adding <code>-inactive-static</code> to status, export and remove commands will operate on all static schedules that are inactive. e.g. <code>status-inactive-static</code></li>
                        <li>FILTER: adding <code>-inactive-dynamic</code> to status, export and remove commands will operate on all dynamic schedules that are inactive. e.g. <code>status-inactive-dynamic</code></li>
                    </ul>
                </p>
                <p><i>Examples...</i><br>
                    Example : Using a simple topic command to manually trigger a schedule named "schedule1"<br>
                    <pre class="cron-plus-code"><code>msg: {
  "topic": "trigger",
  "payload": "schedule1"
}</code></pre>                    
                    Example : Using a simple topic command to export all dynamically added schedules...<br>
                    <pre class="cron-plus-code"><code>msg: {
  "topic": "export-all-dynamic"
}</code></pre>                    
                    Example : Using a simple topic command to delete a schedule named "schedule1"<br>
                    <pre class="cron-plus-code"><code>msg: {
  "topic": "remove",
  "payload": "schedule1"
}</code></pre>                    
                    Example : Using a cmd payload to pause all schedules...<br>
                    <pre class="cron-plus-code"><code>payload: {
  "command": "pause-all"
}</code></pre> 
                    Example : Using a simple topic command to delete all dynamic schedules that have finished <br>
                    <pre class="cron-plus-code"><code>msg: {
  "topic": "remove-inactive-dynamic"
}</code></pre>                    
                </p>
            </p>
            </p>

                 

            <p><b>Describe</b><br>
                Example : cmd payload to describe a cron expression...<br>
                <pre class="cron-plus-code"><code>{
  "command": "describe",
  "expressionType": "cron",
  "expression": "0 */5 * * * MON *",
  "timeZone": "Europe/London"
}</code></pre>
                Example : cmd payload to get all solar event times + solar state at this time...<br>
<pre class="cron-plus-code"><code>{
  "command": "describe",
  "expressionType": "solar",
  "location": "54.9992500,-1.4170300",
  "solarType": "all",
  "timeZone": "Europe/London"
}</code></pre>
                Example : cmd payload to get 4 solar event times + solar for a specific point in time...<br>
    <pre class="cron-plus-code"><code>{
  "command": "describe",
  "expressionType": "solar",
  "time": "2020-03-22 18:40",
  "location": "54.9992500,-1.4170300",
  "solarType": "selected",
  "solarEvents": "civilDawn,sunrise,sunset,civilDusk",
  "timeZone": "Europe/London"
}</code></pre>
                <p><i>Details...</i><br>
                    Returns an object in payload containing human readable info for the given expression.
                    <ul>
                        <li>command: (string|required) The operation to perform</li>
                        <li>expression: (string|required) The expression to describe</li>
                        <li>timeZone: (string|optional) A timezone to use. Leave blank for system timezone. Alternatively, enter UTC or a timezone in the format of Region/Area (<a target="_blank" href="https://en.wikipedia.org/wiki/List_of_tz_database_time_zones">list</a>) </li>
                    </ul>
                </p>
            </p>                
        </dd>
        <dd>GENERAL NOTES...<br>
            <ul>
                <li>Adding a schedule with the same name as an existing schedule will replace the existing one</li>
                <li>Adding a schedule with property <code>"limit":3</code> will cause that schedule to be stopped after the third trigger. It can be started again by injecting a payload of <code>{"command":"start" "name": "schedule name"}</code></li>
                <li>Static (UI added) schedules can be also be updated by using the name specified in the UI</li>
                <li>When a cron-plus-plus node is modified and deployed (or node-red is restarted), dynamic entries are discarded and must be injected again</li>
                <li>When a cron-plus-plus node outputs a msg in response to a command, <code>msg.commandResponse</code> will be <code>true</code> to indicate the message is in response to a command and not a scheduled event</li>
                <li>When a cron-plus-plus node outputs a msg for a cron/solar event, <code>msg.scheduledEvent</code> will be <code>true</code> to indicate the message is due to a scheduled event and not a control response</li>
                <li>The status indicator will be shown as a "ring" for dynamic schedules or shown as a "dot" for static schedules</li>
                <li>if the payload is to "Default Payload", then the content of <code>msg.cronplus</code> is moved to <code>msg.payload</code></li>
            </ul>
        </dd>
    </dl>

    <h3 id="understanding-timezone">Understanding Timezone...</h3>
    <dl class="message-properties">
        <h4>Foreword</h4>
        <p>Timezone should be perceived from your current point of view. For example, regardless of where your node-red runs, you can "fake it" by setting the Timezone entry to your own Timezone location where/when you expect the event to occur.
        </p>

        <h4><b>Example 1...</b></h4>
        <p>Trigger a flow when the NYSE stock exchange starts and stops trading.
        </p>

        <h4 id="notes">NOTES</h4>
        <ul>
            <li>This example will work all year around but was written on 15th Apr with <code>GMT+1 / BST</code> and <code>GMT-4 / EDT</code> as a point of reference</li>
            <li>Server is in London (GMT+1 / BST)</li>
            <li>NYSE Stock exchange runs 09:30 ~ 16:00 Monday to Friday</li>
        </ul>

        <h4 id="details">DETAILS</h4>
        <ul>
            <li>NY time 09:30 (GMT-4 / EDT) - this is the time the market opens in New York</li>
            <li>Server time 14:30 (GMT+1 / BST equivalent) - the start event will happen at this time in london</li>
            <li>NY time 16:00 (GMT-4 / EDT) - this is the time the market closes in New York</li>
            <li>Server time 21:00 (GMT+1 / BST equivalent) - the stop event will happen at this time in london</li>
        </ul>

        <h4 id="setup">SETUP</h4>
        <ul>
            <li>Enter <code>America/New_York</code> in the <code>Timezone</code> field</li>
            <li>Add a new schedule...
                <ul>
                    <li>Field 1 (name)      : Enter &quot;NYSEOPEN &quot;</li>
                    <li>Field 2 (topic)     : Enter &quot;stocks/nyse/trading&quot;</li>
                    <li>Field 3 (payload)   : Select boolean - true</li>
                    <li>Field 4 (type)      : Select &quot;cron&quot;</li>
                    <li>Field 5 (expression): Enter the expression <code>0 30 9 * * 1-5</code></li>                    
                </ul>
            </li>
            <li>Add a new schedule...
                <ul>
                    <li>Field 1 (name)      : Enter &quot;NYSECLOSE &quot;</li>
                    <li>Field 2 (topic)     : Enter &quot;stocks/nyse/trading&quot;</li>
                    <li>Field 3 (payload)   : Select boolean - false</li>
                    <li>Field 4 (type)      : Select &quot;cron&quot;</li>
                    <li>Field 5 (expression): Enter the expression <code>0 0 16 * * 1-5</code></li>
                </ul>
            </li>
        </ul>  
        
        <p></p>         

        <h4><b>Example 2...</b></h4>
        <p>Get an reminder (in Moscow) to call my wife 30 mins after the sun rises in Cairo.</p>

        <h4 id="notes">NOTES</h4>
        <ul>
            <li>This example will work all year around but was written on 15th Apr as a point of reference</li>
            <li>Server is in London (GMT+1 / BST)</li>
            <li>My wife in on holiday in Cairo (GMT+2)
                <ul>
                    <li>sunrise is at 05:27 in Cairo on 15-Apr</li>
                </ul>
            </li>
            <li>I am away on business in Moscow (GMT+3)
                <ul>
                    <li>I need an alert to call wife 30 mins after Cairo sunrise</li>
                </ul>
            </li>
        </ul>

        <h4 id="details">DETAILS</h4>
        <ul>
            <li>Cairo sunrise time 05:27 (15-apr) - 30 mins later at 05:57, my wife expects a call.</li>
            <li>Server time 04:57 (GMT+1 equivalent) - the event will happen at this time in london</li>
            <li>Moscow time 06:57 (GMT+3 equivalent) - this is the time it will be in Moscow</li>
        </ul>

        <h4 id="setup">SETUP</h4>
        <ul>
            <li>Enter <code>Europe/Moscow</code> in the <code>Timezone</code> field</li>
            <li>Add a new schedule...
                <ul>
                    <li>Field 1 (name)    : Enter &quot;call reminder&quot;</li>
                    <li>Field 2 (topic)   : Enter &quot;call/wife&quot;</li>
                    <li>Field 3 (payload) : Select default</li>
                    <li>Field 4 (type)    : Select &quot;solar events&quot;</li>
                    <li>Field 5 (Events)  : Select &quot;sunrise&quot;</li>
                    <li>Field 6 (location): Enter the coordinates for sunrise location (Cairo) <code>30.04905845622014 31.229496002197262</code></li>
                    <li>Field 7 (offset)  : Enter an offset of 30 (allow her time to make a coffee)</li>
                </ul>
            </li>
        </ul>   

    </dl>
    
</script>
<!-- --- [red-module:node-red-contrib-gzip/markdown] --- -->
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/x-red" data-template-name="gzip">
    <div class="form-row">
	<label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
	<input type="text" id="node-input-name" data-i18n="[placeholder]node-red:common.label.name">
    </div>
</script>



<script type="text/javascript">
    RED.nodes.registerType('gzip',{
        category: 'function',
        color:"#DEBD5C",
        defaults: {
            name: {value:""}
        },
        inputs:1,
        outputs:1,
        icon: "gzip.png",
        label: function() {
            return this.name||"gzip";
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        }
    });
</script>
<script type="text/x-red" data-help-name="gzip">
    <p>If the input is a compressed buffer it tries to decompress to a utf8 string.</p>
    <p>If the input is a normal string it creates a compressed buffer.</p>
</script>
<!-- --- [red-module:node-red-contrib-i2c/i2c] --- -->

<script type="text/html" data-template-name="i2c scan">
    <div class="form-row">
        <label for="node-input-busno"><i class="fa fa-random"></i> Bus Number</label>
        /dev/i2c-<input id="node-input-busno" class="I2C-in-address" placeholder="[msg.bus]" min=0 max=7 style="width:40px; height:16px;">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
  	<div class="form-tips">Scan for connected devices on I2C.</div>
</script>



<script type="text/javascript">
    RED.nodes.registerType('i2c scan', {
        category: 'i2c bus',
        defaults: {
            name: {value:""},
            busno: {value:"1"}
        },
        color:"#E35253",
        inputs:1,
        outputs:2,
        icon: "serial.png",
        label: function() { return this.name||'i2c Scan'; },
        labelStyle: function() { return this.name?"node_label_italic":""; },
        oneditprepare: function() {
            if (this.busno === undefined) {
                $("#node-input-busno").val(1);
            }
            $("#node-input-busno").spinner({
                min:0,
                max:7
            });
        }
    });
</script>


<script type="text/html" data-template-name="i2c in">
    <div class="form-row">
        <label for="node-input-busno"><i class="fa fa-random"></i> Bus Number</label>
        /dev/i2c-<input id="node-input-busno" class="I2C-in-address" placeholder="[msg.bus]" min=0 max=7 style="width:40px; height:16px;">
    </div>
    <div class="form-row">
        <label for="node-input-address"><i class="fa fa-address-card-o"></i> Bus Address</label>
        <input type="number" id="node-input-address" class="I2C-in-address" placeholder="[msg.address]" min=3 max=127>
    </div>
    <div class="form-row">
        <label for="node-input-command"><i class="fa fa-empire"></i> Command</label>
        <input type="number" id="node-input-command" class="I2C-in-command" placeholder="[msg.command]" min=0 max=255>
    </div>
   <div class="form-row">
        <label for="node-input-count" alt="How many bytes will be returned"><i class="fa fa-sign-in"></i> Bytes</label>
        <input type="number" id="node-input-count" class="I2C-in-count" placeholder="number or msg.bytes" min=0 max=31>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>



<script type="text/javascript">
    RED.nodes.registerType('i2c in', {
        category: 'i2c bus',
        defaults: {
            name: {value:""},
            busno: {value:"1"},
            address: {value:"",required:false},
            command: {value:"",required:false},
            count: {value:"1",required:true}
        },
        color:"#E35253",
        inputs:1,
        outputs:1,
        icon: "serial.png",
        label: function() { return this.name||"i2c in"; },
        labelStyle: function() { return this.name?"node_label_italic":""; },
        oneditprepare: function() {
            if (this.busno === undefined) {
                $("#node-input-busno").val(1);
            }
            $("#node-input-busno").spinner({
                min:0,
                max:7
            });
        }
    });
</script>


<script type="text/html" data-template-name="i2c out">
    <div class="form-row">
        <label for="node-input-busno"><i class="fa fa-random"></i> Bus Number</label>
        /dev/i2c-<input id="node-input-busno" class="I2C-in-address" placeholder="[msg.bus]" min=0 max=7 style="width:40px; height:16px;">
    </div>
    <div class="form-row">
        <label for="node-input-address"><i class="fa fa-address-card-o"></i> Bus Address</label>
        <input type="number" id="node-input-address" class="I2C-out-address" placeholder="[msg.address]" min=3 max=127>
    </div>
    <div class="form-row">
        <label for="node-input-command"><i class="fa fa-empire"></i> Command</label>
        <input type="number" id="node-input-command" class="I2C-out-command" placeholder="[msg.command]" min=0 max=255>
    </div>
    <div class="form-row">
        <label for="node-input-payload"><i class="fa fa-envelope"></i> Payload</span></label>
        <input type="text" id="node-input-payload" style="width:70%">
        <input type="hidden" id="node-input-payloadType">
    </div>
    <div class="form-row">
        <label for="node-input-count" alt="Send number of bytes"><i class="fa fa-sign-out"></i> Send bytes</label>
        <input type="number" id="node-input-count" class="I2C-out-count" placeholder="number or msg.bytes" min=0 max=31>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>
 


<script type="text/javascript">
    RED.nodes.registerType('i2c out', {
        category: 'i2c bus',
        defaults: {
            name: {value:""},
            busno: {value:"1"},
            address: {value:"",required:false},
            command: {value:"", required:false},
            payload: {value:"payload", required:false, validate: RED.validators.typedInput("payloadType")},
            payloadType: {value:"msg"},
            count: {value:"1", required:false}
        },
        color:"#E35253",
        inputs:1,
        outputs:1,
        icon: "serial.png",
        align: "right",
        label: function() { return this.name||'i2c out'; },
        labelStyle: function() { return this.name?"node_label_italic":"";},
        oneditprepare: function() {
            if (this.payloadType == null) {
                this.payloadType = "msg";
            } else if (this.payloadType === 'string' ) {
                this.payloadType = "str";
            }

            if (this.busno === undefined) {
                $("#node-input-busno").val(1);
            }
            $("#node-input-busno").spinner({
                min:0,
                max:7
            });

            $("#node-input-payload").typedInput({
                default: 'msg',
                typeField: $("#node-input-payloadType"),
                types:['msg','flow','global','str','num','bool','json','bin']
            });
            $("#node-input-payload").typedInput('type',this.payloadType);
            $("#node-input-payloadType").val(this.payloadType);
            if ($("#node-input-payload").typedInput('type') === 'msg' &&
                $("#node-input-payload").typedInput('value') === ''
            ) {
                $("#node-input-payload").typedInput('value','payload');
            }
			
            $("#node-input-payload").on('change',function() {
                if ($("#node-input-payload").typedInput('type') === 'msg' &&
                    $("#node-input-payload").typedInput('value') === ''
                ) {
                    $("#node-input-payload").typedInput('value','payload');
                }
            });
        }
    });
</script>
<script type="text/html" data-help-name="i2c scan">
    <p>Scans local host for i2c devices.</p>
    <p>The first output contains an array of any addresses found.</p>
    <p>The second output sends each address as a separate message.</p>
</script><script type="text/html" data-help-name="i2c in">
    <p>Reads data from a local I2C port.</p>
    <p>It will put a buffer object into the <code>msg.payload</code>.</p>
</script><script type="text/html" data-help-name="i2c out">
    <p>Provides a connection to an outbound I2C address.</p>
    <p>Only the <code>msg.payload</code> is sent.</p>
    <p>address <b>0</b> means that you will broadcast to all I2C-units on the I2C bus.</p>
    <p>The <b>Send bytes</b> is used to set the number of bytes that will be used when the payload is a number.</p>
    <p>The <b>payload</b> and <b>msg.payload</b> can be a Buffer, Array, String or Integer.</p>	
</script>
<!-- --- [red-module:node-red-contrib-iconv/converter] --- -->
<!--
 Copyright 2017 Tiago Machado

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

		 http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->

<script type="text/x-red" data-template-name="converter">
    <div class="form-row">
        <label for="node-input-from"><i class="fa fa-sign-in"></i> <span data-i18n="converter.label.from"></span></label>
        <input type="text" id="node-input-from" data-i18n="[placeholder]converter.input.from">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="converter.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]converter.label.name">
    </div>
</script>



<script type="text/javascript">
    RED.nodes.registerType('converter',{
        category: 'function',
        color:"#DEBD5C",
        defaults: {
            name: {
                value:""
            },
            from: {
                value:"",
                required:true
            }
        },
        inputs:1,
        outputs:1,
        icon: "arrow-in.png",
        label: function() {
            return this.name||"charset";
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        }
    });
</script>
<script type="text/x-red" data-help-name="converter">
    <p>For decoding simply send a Buffer inside <code>msg.payload</code> and the choosed encoding format will be applied to convert it to pure Javascript chracter encoding.</p>
    <p>For encoding simply send a String inside <code>msg.payload</code> and the choosed encoding format will be applied to convert.</p>
    <ul>Supported Encodings</ul>
    <li>Node.js Native encodings: utf8, ucs2 / utf16le, ascii, binary, base64, hex</li>
    <li>Unicode: UTF-16BE, UTF-16 (with BOM)</li>
    <li>Windows codepages: 874, 1250-1258 (aliases: cpXXX, winXXX, windowsXXX)</li>
    <li>ISO codepages: ISO-8859-1 - ISO-8859-16</li>
    <li>IBM codepages: 437, 737, 775, 808, 850, 852, 855-858, 860-866, 869, 922, 1046, 1124, 1125, 1129, 1133, 1161-1163 (aliases cpXXX, ibmXXX)</li>
    <li>Mac codepages: maccroatian, maccyrillic, macgreek, maciceland, macroman, macromania, macthai, macturkish, macukraine, maccenteuro, macintosh</li>
    <li>KOI8 codepages: koi8-r, koi8-u, koi8-ru, koi8-t</li>
    <li>Miscellaneous: armscii8, rk1048, tcvn, georgianacademy, georgianps, pt154, viscii, iso646cn, iso646jp, hproman8, tis620</li>
    <li>Japanese: Shift_JIS, Windows-31j, Windows932, EUC-JP</li>
    <li>Chinese: GB2312, GBK, GB18030, Windows936, EUC-CN</li>
    <li>Korean: KS_C_5601, Windows949, EUC-KR</li>
    <li>Taiwan/Hong Kong: Big5, Big5-HKSCS, Windows950</li>
</script>
<!-- --- [red-module:node-red-contrib-osc/osc] --- -->
<!--
  Copyright 2016 Nicholas Humfrey, Nathanaël Lécaudé.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/x-red" data-template-name="osc">
    <div class="form-row">
        <label for="node-input-path"><i class="icon-tasks"></i> Path</label>
        <input type="text" id="node-input-path" placeholder="OSC Path">
    </div>
    <div class="form-row">
        <label><i class="fa fa-list"></i> Metadata</span></label>
        <input type="checkbox" id="node-input-metadata" style="display: inline-block; width: auto; vertical-align: top;">
        Include metadata
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-tips">Tip: leave path blank if you want to set using <b>msg.topic</b>.</div>
</script>



<script type="text/javascript">
    RED.nodes.registerType('osc',{
        category: 'function',
        color:"#0099FF",
        defaults: {
            name: {value:""},
            path: {value:""},
            metadata: {value: false}
        },
        inputs:1,
        outputs:1,
        icon: "bridge-dash.png",
        align: "left",
        label: function() {
            return this.name||"osc";
        }
    });
</script>

<script type="text/x-red" data-help-name="osc">
    <p>Decode and encode messages using the Open Sound Control (OSC) protocol.</p>
    <p>The OSC node is transport independant meaning you will need to use it with
    Node-RED&#39;s built-in input and output objects like udp, tcp, websocket or serial.</p>

    <h1>Receiving</h1>
    <p>If the node receives a <code>Buffer</code> as <code>msg.payload</code> it will convert
    it and place the OSC address in <code>msg.topic</code> and the received arguments
    in <code>msg.payload.</code></p>
    <p>When "Include metadata" checkbox is checked, the OSC node will send an object
    with the type of the value along the value:</p>
    <pre>
    {
        "type": "f",
        "value": 33.4
    }
    </pre>

    <h1>Sending</h1>
    <p>If the node receives a valid OSC path as <code>msg.topic</code> and data as
    <code>msg.payload</code> it will convert the data to a <code>Buffer</code> that can be
    sent via tcp, udp, websocket or serial. You can also override <code>msg.topic</code>
    by setting the path in the node&#39;s properties.</p>
    <p>To send or receive via tcp or serial you will need the
    <a href="http://flows.nodered.org/node/node-red-contrib-slip" target='blank'>node-red-contrib-slip</a> object.
</script>
<!-- --- [red-module:node-red-contrib-postgresql/postgresql] --- -->
<script type="text/x-red" data-template-name="postgreSQLConfig">
	<div class="form-row">
		<label for="node-config-input-name">
			<i class="fa fa-tag"></i>
			<span data-i18n="postgresql.label.name"></span>
		</label>
		<input type="text" id="node-config-input-name" data-i18n="[placeholder]postgresql.placeholder.name" />
	</div>
	<div class="form-row">
		<ul style="background: #fff; min-width: 600px; margin-bottom: 20px;" id="postgresql-config-tabs"></ul>
	</div>
	<div id="postgresql-config-tabs-content" style="min-height: 170px;">
		<div id="postgresql-config-tab-connection" style="display: none;">
			<div class="form-row">
				<label for="node-config-input-host">
					<i class="fa fa-server"></i>
					<span data-i18n="postgresql.label.host"></span>
				</label>
				<input type="text" id="node-config-input-host" data-i18n="[placeholder]postgresql.placeholder.host" style="width: 80%;" />
				<input type="hidden" id="node-config-input-hostFieldType" />
			</div>
			<div class="form-row">
					<label for="node-config-input-port">
						<span data-i18n="postgresql.label.port"></span>
					</label>
					<input type="text" id="node-config-input-port" data-i18n="[placeholder]postgresql.placeholder.port" style="width: 80%;" />
					<input type="hidden" id="node-config-input-portFieldType" />
				</div>
			<div class="form-row">
				<label for="node-config-input-database">
					<i class="fa fa-database"></i>
					<span data-i18n="postgresql.label.database"></span>
				</label>
				<input type="text" id="node-config-input-database" data-i18n="[placeholder]postgresql.placeholder.database" style="width: 80%;" />
				<input type="hidden" id="node-config-input-databaseFieldType" />
			</div>
			<div class="form-row">
				<label for="node-config-input-ssl" style="width: auto;margin-right: 72px;">
					<span data-i18n="postgresql.label.ssl"></span>
				</label>
				<input type="text" id="node-config-input-ssl" style="display: inline-block; width: auto; vertical-align: top;" />
				<input type="hidden" id="node-config-input-sslFieldType" />
			</div>
		</div>
		<div id="postgresql-config-tab-security" style="display: none;">
			<div class="form-row">
				<label for="node-config-input-user">
					<i class="fa fa-user"></i>
					<span data-i18n="postgresql.label.user"></span>
				</label>
				<input type="text" id="node-config-input-user" data-i18n="[placeholder]postgresql.placeholder.user" style="width: 80%;" />
				<input type="hidden" id="node-config-input-userFieldType" />
			</div>
			<div class="form-row">
				<label for="node-config-input-password">
					<i class="fa fa-lock"></i>
					<span data-i18n="postgresql.label.password"></span>
				</label>
				<input type="password" id="node-config-input-password" data-i18n="[placeholder]postgresql.placeholder.password" style="width: 80%;" />
				<input type="hidden" id="node-config-input-passwordFieldType" />
			</div>
		</div>
		<div id="postgresql-config-tab-pool" style="display: none;">
			<div class="form-row">
				<label data-i18n="[title]postgresql.title.applicationName" for="node-config-input-applicationName">
					<i class="fa fa-tag"></i>
					<span data-i18n="postgresql.label.applicationName"></span>
				</label>
				<input type="text" id="node-config-input-applicationName" data-i18n="[placeholder]postgresql.placeholder.applicationName" style="width: 80%;" />
				<input type="hidden" id="node-config-input-applicationNameType" />
			</div>
			<div class="form-row">
				<label data-i18n="[title]postgresql.title.max" for="node-config-input-max" style="width: 150px;">
					<i class="fa fa-thermometer-full"></i>
					<span data-i18n="postgresql.label.max"></span>
				</label>
				<input type="text" id="node-config-input-max" data-i18n="[placeholder]postgresql.placeholder.max" style="width: 60%;" />
				<input type="hidden" id="node-config-input-maxFieldType" />
			</div>
			<div class="form-row">
				<label for="node-config-input-idle" style="width: 150px;">
					<i class="fa fa-hourglass-half"></i>
					<span data-i18n="postgresql.label.idle"></span>
				</label>
				<input type="text" id="node-config-input-idle" data-i18n="[placeholder]postgresql.placeholder.idle" style="width: 60%;" />
				<input type="hidden" id="node-config-input-idleFieldType" />
			</div>
			<div class="form-row">
				<label for="node-config-input-connectionTimeout" style="width: 150px;">
					<i class="fa fa-hourglass-half"></i>
					<span data-i18n="postgresql.label.connectionTimeout" ></span>
				</label>
				<input type="text" id="node-config-input-connectionTimeout" data-i18n="[placeholder]postgresql.placeholder.connectionTimeout" style="width: 60%;" />
				<input type="hidden" id="node-config-input-connectionTimeoutFieldType" />
			</div>
		</div>
	</div>
</script>

<script type="text/javascript">
	/* global RED:false, $:false */
	RED.nodes.registerType('postgreSQLConfig', {
		category: 'config',
		defaults: {
			name: {
				value: '',
			},
			host: {
				value: '127.0.0.1',
			},
			hostFieldType: {
				value: 'str',
			},
			port: {
				value: 5432,
			},
			portFieldType: {
				value: 'num',
			},
			database: {
				value: 'postgres',
			},
			databaseFieldType: {
				value: 'str',
			},
			ssl: {
				value: false,
			},
			sslFieldType: {
				value: 'bool',
			},
			applicationName: {
				value: '',
			},
			applicationNameType: {
				value: 'str',
			},
			max: {
				value: 10,
			},
			maxFieldType: {
				value: 'num',
			},
			idle: {
				value: 1000,
			},
			idleFieldType: {
				value: 'num',
			},
			connectionTimeout: {
				value: 10000,
			},
			connectionTimeoutFieldType: {
				value: 'num',
			},
			user: {
				value: '',
			},
			userFieldType: {
				value: 'str',
			},
			password: {
				value: '',
			},
			passwordFieldType: {
				// TODO: https://nodered.org/docs/creating-nodes/credentials
				value: 'str',
			},
		},
		label: function () {
			return this.name || this.user + '@' + this.host + ':' + this.port + '/' + this.database;
		},
		labelStyle: function () {
			return this.name ? 'node_label_italic' : '';
		},
		oneditprepare: function () {
			const tabs = RED.tabs.create({
				id: 'postgresql-config-tabs',
				onchange: function (tab) {
					$('#postgresql-config-tabs-content').children().hide();
					$('#' + tab.id).show();
				},
			});
			tabs.addTab({
				id: 'postgresql-config-tab-connection',
				label: this._('postgresql.tab.connection'),
			});
			tabs.addTab({
				id: 'postgresql-config-tab-security',
				label: this._('postgresql.tab.security'),
			});
			tabs.addTab({
				id: 'postgresql-config-tab-pool',
				label: this._('postgresql.tab.pool'),
			});
			$('#node-config-input-host').typedInput({
				default: 'str',
				types: ['str', 'global', 'env'],
				typeField: $('#node-config-input-hostFieldType'),
			});
			$('#node-config-input-port').typedInput({
				default: 'num',
				types: ['num', 'global', 'env'],
				typeField: $('#node-config-input-portFieldType'),
			});
			$('#node-config-input-database').typedInput({
				default: 'str',
				types: ['str', 'global', 'env'],
				typeField: $('#node-config-input-databaseFieldType'),
			});
			$('#node-config-input-ssl').typedInput({
				default: 'bool',
				types: ['bool', 'global', 'env', 'json'],
				typeField: $('#node-config-input-sslFieldType'),
			});
			$('#node-config-input-user').typedInput({
				default: 'str',
				types: ['str', 'global', 'env'],
				typeField: $('#node-config-input-userFieldType'),
			});
			$('#node-config-input-password')
				.typedInput({
					default: 'str',
					types: ['str', 'global', 'env'],
					typeField: $('#node-config-input-passwordFieldType'),
				});
			$('#node-config-input-applicationName').typedInput({
				default: 'str',
				types: ['str', 'global', 'env'],
				typeField: $('#node-config-input-applicationNameType'),
			});
			$('#node-config-input-max').typedInput({
				default: 'num',
				types: ['num', 'global'],
				typeField: $('#node-config-input-maxFieldType'),
			});
			$('#node-config-input-lin').typedInput({
				default: 'num',
				types: ['num', 'global'],
				typeField: $('#node-config-input-linFieldType'),
			});
			$('#node-config-input-idle').typedInput({
				default: 'num',
				types: ['num', 'global'],
				typeField: $('#node-config-input-idleFieldType'),
			});
			$('#node-config-input-connectionTimeout').typedInput({
				default: 'num',
				types: ['num', 'global'],
				typeField: $('#node-config-input-connectionTimeoutFieldType'),
			});
		},
	});
</script>
<script type="text/x-red" data-template-name="postgresql">
	<div class="form-row">
		<label for="node-input-name">
			<i class="icon-tag"></i>
			<span data-i18n="postgresql.label.name"></span>
		</label>
		<input type="text" id="node-input-name" data-i18n="[placeholder]node-red:common.label.name" />
	</div>
	<div class="form-row">
		<label for="node-input-postgreSQLConfig">
			<i class="fa fa-server"></i>
			<span data-i18n="postgresql.label.server"></span>
		</label>
		<input type="text" id="node-input-postgreSQLConfig" />
	</div>
	<div class="form-row">
		<input type="checkbox" id="node-input-split" style="display: inline-block; width: auto; vertical-align: top;" />
		<label for="node-input-split" style="width: auto;">
			<span data-i18n="postgresql.label.split"></span>
		</label>
	</div>
	<div class="form-row">
		<label for="node-input-rowsPerMsg">
			<span data-i18n="postgresql.label.rowsPerMsg"></span>
		</label>
		<input type="number" id="node-input-rowsPerMsg" placeholder="1" value="1" min="1" />
	</div>
	<div class="form-row" style="position: relative; margin-bottom: 0px;">
		<label for="node-input-query">
			<i class="fa fa-file-code-o"></i>
			<span data-i18n="postgresql.label.query"></span>
		</label>
		<input type="hidden" id="node-input-query" autofocus="autofocus" />
	</div>
	<div class="form-row node-text-editor-row">
		<div style="height: 300px; min-height: 150px;" class="node-text-editor" id="node-input-editor"></div>
	</div>
</script>

<script type="text/javascript">
	/* global RED:false, $:false */
	RED.nodes.registerType('postgresql', {
		category: 'storage',
		color: '#5b85a7',
		defaults: {
			name: {
				value: '',
			},
			query: {
				value: 'SELECT * FROM ;',
			},
			postgreSQLConfig: {
				type: 'postgreSQLConfig',
				required: true,
			},
			split: {
				value: false,
			},
			rowsPerMsg: {
				value: 1,
			},
			outputs: {
				value: 1,
			},
		},
		inputs: 1,
		icon: 'postgresql.png',
		align: 'left',
		label: function () {
			return this.name || 'postgresql';
		},
		labelStyle: function () {
			return this.name ? 'node_label_italic' : '';
		},
		oneditprepare: function () {
			$('#node-input-split').prop('checked', this.split);
			$('#node-input-rowsPerMsg').value = this.split ? this.rowsPerMsg : 1;
			this.editor = RED.editor.createEditor({
				id: 'node-input-editor',
				mode: 'ace/mode/sql',
				value: $('#node-input-query').val(),
			});
			this.editor.focus();
		},
		oneditsave: function () {
			$('#node-input-query').val(this.editor.getValue());
			delete this.editor;
		},
	});
</script>
<script type="text/x-red" data-help-name="postgresql">
	<p>
		<a href="https://github.com/alexandrainst/node-red-contrib-postgresql">node-red-contrib-postgresql</a>
		is a Node-RED node to query a <a href="https://www.postgresql.org/">PostgreSQL</a> 🐘 database.
	</p>

	<h3>Outputs</h3>
	<p>The response (rows) is provided in <code>msg.payload</code> as an array.</p>
	<p>
		An exception is if the <em>Split results</em> option is enabled and the <em>Number of rows per message</em> is set to 1,
		then <code>msg.payload</code> is not an array but the single-row response.
	</p>
	<p>
		Additional information is provided as <code>msg.pgsql.rowCount</code> and <code>msg.pgsql.command</code>.
		See the <a href="https://node-postgres.com/apis/result">underlying documentation</a> for details.
	</p>
	<p>In the case of multiple queries, then <code>msg.pgsql</code> is an array.</p>

	<h3>Inputs</h3>
	<h4>SQL query template</h4>
	<p>This node uses the <a href="https://github.com/janl/mustache.js">Mustache template system</a> to generate queries based on the message:</p>
<pre>
-- INTEGER id column
SELECT * FROM table WHERE id = {{{ msg.id }}}

-- TEXT id column
SELECT * FROM table WHERE id = '{{{ msg.id }}}'
</pre>

	<h4>Dynamic SQL queries</h4>
	<p>As an alternative to using the query template above, this node also accepts an SQL query via the <code>msg.query</code> parameter.</p>

	<h4>Parameterized queries</h4>
	<p>Parameters for parameterized queries can be passed as an array <code>msg.params</code>:</p>
<pre>
// In a function, provide parameters for the parameterized query
msg.params = [ msg.id ];
</pre>

<pre>
-- In this node, use a parameterized query
SELECT * FROM table WHERE id = $1
</pre>

<h4>Parameterized queries</h4>
<p>
	As an alternative to numeric parameters,
	named parameters for parameterized queries can be passed as a parameter object <code>msg.queryParameters</code>:
</p>
<pre>
// In a function, provide parameters for the named parameterized query
msg.queryParameters.id = msg.id;
</pre>

<pre>
-- In this node, use a named parameterized query
SELECT * FROM table WHERE id = $id;
</pre>

<p>
	<em>Note</em>: named parameters are not natively supported by PostgreSQL, and this library just emulates them,
	so this is less robust than numeric parameters.
</p>

	<h4>Dynamic PostgreSQL connection parameters</h4>
	<p>
		If the information about which database server to connect and how needs to be dynamic,
		it is possible to pass a <a href="https://node-postgres.com/apis/client">custom client configuration</a> in the message:
	</p>

<pre>
msg.pgConfig = {
  user?: string, // default process.env.PGUSER || process.env.USER
  password?: string, //or function, default process.env.PGPASSWORD
  host?: string, // default process.env.PGHOST
  database?: string, // default process.env.PGDATABASE || process.env.USER
  port?: number, // default process.env.PGPORT
  connectionString?: string, // e.g. postgres://user:password@host:5432/database
  ssl?: any, // passed directly to node.TLSSocket, supports all tls.connect options
  types?: any, // custom type parsers
  statement_timeout?: number, // number of milliseconds before a statement in query will time out, default is no timeout
  query_timeout?: number, // number of milliseconds before a query call will timeout, default is no timeout
  application_name?: string, // The name of the application that created this Client instance
  connectionTimeoutMillis?: number, // number of milliseconds to wait for connection, default is no timeout
  idle_in_transaction_session_timeout?: number, // number of milliseconds before terminating any session with an open idle transaction, default is no timeout
};
</pre>
	<p>
		However, this does not use a <a href="https://node-postgres.com/features/pooling">connection pool</a>, and is therefore less efficient.
		It is therefore recommended in most cases not to use <code>msg.pgConfig</code> at all and instead stick to the built-in configuration node.
	</p>

	<h3>Backpressure</h3>
	<p>
		This node supports <em>backpressure</em> / <em>flow control</em>:
		when the <em>Split results</em> option is enabled, it waits for a <em>tick</em> before releasing the next batch of lines,
		to make sure the rest of your Node-RED flow is ready to process more data
		(instead of risking an out-of-memory condition), and also conveys this information upstream.
	</p><p>
		So when the <em>Split results</em> option is enabled, this node will only output one message at first,
		and then awaits a message containing a truthy <code>msg.tick</code> before releasing the next message.
	</p><p>
		To make this behaviour potentially automatic (avoiding manual wires),
		this node declares its ability by exposing a truthy <code>node.tickConsumer</code> for downstream nodes to detect this feature,
		and a truthy <code>node.tickProvider</code> for upstream nodes.
		Likewise, this node detects upstream nodes using the same back-pressure convention, and automatically sends ticks.
	</p>

	<h3>Sequences for split results</h3>
	<p>
		When the <em>Split results</em> option is enabled (streaming), the messages contain some information following the conventions
		for <a href="https://nodered.org/docs/user-guide/messages#message-sequences"><em>messages sequences</em></a>.
	</p>

<pre>
{
  payload: '...',
    parts: {
      id: 0.1234, // sequence ID, randomly generated (changes for every sequence)
      index: 5, // incremented for each message of the same sequence
      count: 6, // total number of messages; only available in the last message of a sequence
      parts: {}, // optional upstream parts information
    },
    complete: true, // True only for the last message of a sequence
}
</pre>

</script>

<!-- --- [red-module:node-red-contrib-web-babylonjs/scene] --- -->
<script type="text/javascript">
    RED.nodes.registerType('scene',{
        category: 'config',
        defaults: {
            name: {value:"default",required:true},
            configContext: {},
            overlay: { value: false },
        },
        label: function() {
            return this.name;
        }
    });
</script>

<script type="text/html" data-template-name="scene">
    <div class="form-row">
        <label for="node-config-input-name"><i class="icon-bookmark"></i> Name</label>
        <input type="text" id="node-config-input-name">
    </div>
    <div class="form-row">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-config-input-overlay" style="display:inline-block; width:auto; vertical-align:top;">
        <label for="node-config-input-overlay" style="width:70%;">Overlay</label>
    </div>    
</script>
<!-- --- [red-module:node-red-contrib-web-babylonjs/material] --- -->
<script type="text/javascript">
    RED.nodes.registerType('material',{
        category: 'config',
        defaults: {
            name: {value:"default",required:true},
            diffuse: { required:true},
            specular: {required: false},
            alpha: { required:true},
            configContext: {},
        },
        label: function() {
            return this.name;
        }
    });
</script>

<script type="text/html" data-template-name="material">
    <div class="form-row">
        <label for="node-config-input-name"><i class="icon-bookmark"></i> Name</label>
        <input type="text" id="node-config-input-name">
    </div>
    <div class="form-row">
        <label for="node-config-input-diffuse"><i class="icon-bookmark"></i> Diffuse</label>
        <input type="color" id="node-config-input-diffuse">
    </div>
    <div class="form-row">
        <label for="node-config-input-specular"><i class="icon-bookmark"></i> Specular</label>
        <input type="color" id="node-config-input-specular">
    </div>    
    <!-- TODO Check what the heck going wrong with class form-row ?!!!!! I suck at CSS-->
    <div style="display:flex; flex-direction: row; justify-content: lef; align-items: center">
        <label for="node-config-input-alpha" style="margin-right: 70px;">Alpha</label>
        <input id="node-config-input-alpha" type="range" min="0" max="1" value="1" step="0.1"  oninput="document.getElementById('outval').value=this.value"/>
        <!-- TODO  find a better way to visualize slider value-->
        <output id="outval" style="margin-left: 50px"> </output>

    </div>
    

</script>
<!-- --- [red-module:node-red-contrib-web-babylonjs/sphere] --- -->
<script type="text/javascript">
    RED.nodes.registerType('sphere', {
        category: '3D',
        color: '#D8BFD8',
        defaults: {
            scene: { value: "", type: "scene", required: true },
            material: { value: "", type: "material", required: false },
            name_conf_a: { value: "", required: true },
            segments_conf_n: { value: 32, validate: RED.validators.number() },
            diameter_conf_n: { value: 1, validate: RED.validators.number() },
            diameterX_conf_n: {},
            diameterY_conf_n: {},
            diameterZ_conf_n: {},
            arc_conf_n: { value: 1, validate: RED.validators.number() },
            slice_conf_n: { value: 1, validate: RED.validators.number() },
            updatable_conf_b: { value: false },
            sideOrientation_conf_a: { value: "DEFAULTSIDE" },
            pos_x: {value: 0},
            pos_y: {value: 0},
            pos_z: {value: 0},
            scale_x: {value: 1},
            scale_y: {value: 1},
            scale_z: {value: 1},
            rot_x: {value: 0},
            rot_y: {value: 0},
            rot_z: {value: 0}
        },
        inputs: 1,
        outputs: 1,
        icon: "babylon.png",
        label: function () {
            return this.name_conf_a || "sphere";
        },
        oneditprepare: function () {
            function setUpSection(sectionId, isExpanded) {
                var basicSection = $(sectionId);
                var paletteHeader = basicSection.find('.red-ui-palette-header');
                var twistie = paletteHeader.find('i');
                var sectionContent = basicSection.find('.section-content');

                function toggleSection(expanded) {
                    twistie.toggleClass('expanded', expanded);
                    sectionContent.toggle(expanded);
                }
                paletteHeader.on("click", function(e) {
                    e.preventDefault();
                    var isExpanded = twistie.hasClass('expanded');
                    toggleSection(!isExpanded);
                });
                toggleSection(isExpanded);
            }
            setUpSection('#sphere-section-basic', true);
            setUpSection('#sphere-section-parameters', false);
            setUpSection('#sphere-section-initial', true);
        }
    });
</script>

<script type="text/html" data-template-name="sphere">

            <div class="form-row">
                <label for="node-input-name_conf_a"><i class="icon-tag"></i> Name</label>
                <input type="text" id="node-input-name_conf_a" placeholder="Name"/>
            </div>
            <div id="sphere-section-basic">
                <div class="red-ui-palette-header">
                    <i class="fa fa-angle-down"></i><span>Basic Configuration</span>
                </div>
                <div class="section-content" style="padding:10px 0 0 10px">
                    <div class="form-row">
                        <label for="node-input-scene"><i class="fa fa-tag"></i>Scene</label>
                        <input type="select" id="node-input-scene" placeholder="Scene"/>
                    </div>
                    <div class="form-row">
                        <label for="node-input-material"><i class="fa fa-tag"></i>Material</label>
                        <input type="select" id="node-input-material" placeholder="Material"/>
                    </div>
                    <div class="form-row">
                        <label>&nbsp;</label>
                        <input type="checkbox" id="node-input-updatable_conf_b" style="display:inline-block; width:auto; vertical-align:top;">
                        <label for="node-input-updatable_conf_b" style="width:70%;">Updatable</label>
                    </div>
                    <div class="form-row">
                        <label for="node-input-sideOrientation_conf_a"><i class="icon-tag"></i> SideOrientation</label>
                        <select type="text" id="node-input-sideOrientation_conf_a">
                                <option value="0">FRONTSIDE</option>
                                <option value="1">BACKSIDE</option>
                                <option value="2">DOUBLESIDE</option>
                        </select>    
                    </div>
                </div>
            </div>
            <!-- Add Sphere Parameters Section  here -->
            <div id="sphere-section-parameters">
                <div class="red-ui-palette-header">
                    <i class="fa fa-angle-down"></i><span>Sphere Parameters</span>
                </div>
                <div class="section-content" style="padding:10px 0 0 10px">
                    <div class="form-row">
                        <label for="node-input-diameter_conf_n"><i class="icon-tag"></i> Diameter</label>
                        <input type="text" id="node-input-diameter_conf_n"/>
                    </div>        
                    <div class="form-row">
                        <label for="node-input-segments_conf_n"><i class="icon-tag"></i> Segments</label>
                        <input type="text" id="node-input-segments_conf_n"/>
                    </div>    
                    <div class="form-row">
                        <label for="node-input-diameterX_conf_n"><i class="icon-tag"></i> DiameterX</label>
                        <input type="text" id="node-input-diameterX_conf_n">
                    </div>
                    <div class="form-row">
                        <label for="node-input-diameterY_conf_n"><i class="icon-tag"></i> DiameterY</label>
                        <input type="text" id="node-input-diameterY_conf_n">
                    </div>
                    <div class="form-row">
                        <label for="node-input-diameterZ_conf_n"><i class="icon-tag"></i> DiameterZ</label>
                        <input type="text" id="node-input-diameterZ_conf_n">
                    </div>            
                    <div class="form-row">
                        <label for="node-input-arc_conf_n"><i class="icon-tag"></i> Arc</label>
                        <input type="text" id="node-input-arc_conf_n">
                    </div>            
                    <div class="form-row">
                        <label for="node-input-slice_conf_n"><i class="icon-tag"></i> Slice</label>
                        <input type="text" id="node-input-slice_conf_n">
                    </div>
                </div>        
            </div>    
            <!-- Add Initial Position Orientation Here Parameters Section  here -->
            <div id="sphere-section-initial">
                <div class="red-ui-palette-header">
                    <i class="fa fa-angle-down"></i><span>Sphere Initial</span>
                </div>
                <div class="section-content" style="padding:10px 0 0 10px">
                    <div class="form-row">
                        <p><i class="icon-tag"></i> Position </p>
                    </div>
                    <div style="display:flex; flex-direction: row; justify-content: lef; align-items: center">
                        <label for="node-input-pos_x" style="margin-right: 20px;">X: </label>
                        <input id="node-input-pos_x" type="text" style="width: 60px;margin-right: 30px; "/>
                        <label for="node-input-pos_y" style="margin-right: 20px;">Y: </label>
                        <input id="node-input-pos_y" type="text" style="width: 60px;margin-right: 30px;"/>
                        <label for="node-input-pos_z" style="margin-right: 20px;">Z: </label>
                        <input id="node-input-pos_z" type="text" style="width: 60px"/>
                    </div>
                    <br/>
                    <div class="form-row">
                        <p><i class="icon-tag"></i> Scale </p>
                    </div>      
                    <div style="display:flex; flex-direction: row; justify-content: lef; align-items: center">
                        <label for="node-input-scale_x" style="margin-right: 20px;">X: </label>
                        <input id="node-input-scale_x" type="text" style="width: 60px;margin-right: 30px; "/>
                        <label for="node-input-scale_y" style="margin-right: 20px;">Y: </label>
                        <input id="node-input-scale_y" type="text" style="width: 60px;margin-right: 30px;"/>
                        <label for="node-input-scale_z" style="margin-right: 20px;">Z: </label>
                        <input id="node-input-scale_z" type="text" style="width: 60px"/>
                    </div>     
                    <br/>
                    <div class="form-row">
                        <p><i class="icon-tag"></i> Rotation (Degree)</p>
                    </div>      
                    <div style="display:flex; flex-direction: row; justify-content: lef; align-items: center">
                        <label for="node-input-rot_x" style="margin-right: 20px;">X: </label>
                        <input id="node-input-rot_x" type="text" style="width: 60px;margin-right: 30px; "/>
                        <label for="node-input-rot_y" style="margin-right: 20px;">Y: </label>
                        <input id="node-input-rot_y" type="text" style="width: 60px;margin-right: 30px;"/>
                        <label for="node-input-rot_z" style="margin-right: 20px;">Z: </label>
                        <input id="node-input-rot_z" type="text" style="width: 60px"/>
                    </div>                      
                </div>
        
            </div>
        


</script>

<script type="text/html" data-help-name="sphere">
    <p>Create a primitive sphere object</p>
    <p> for more information refer to </p> <a href="https://doc.babylonjs.com/babylon101/discover_basic_elements#sphere"> Visit the official babylonjs</a>
</script>
<!-- --- [red-module:node-red-contrib-web-babylonjs/box] --- -->
<script type="text/javascript">
    RED.nodes.registerType('box',{
        category: '3D',
        color: '#D8BFD8',
        defaults: {
            scene: {value:"", type:"scene"},    
            material: {value:"", type: "material", required: false},
            name_conf_a: { value: "", required: true },
            size_conf_n: { value: 1 ,validate:RED.validators.number()},
            height_conf_n: {},
            width_conf_n: {},
            depth_conf_n: {},
            updatable_conf_b: { value: false },
            sideOrientation_conf_a: { value: "DEFAULTSIDE" },
            pos_x: {value: 0},
            pos_y: {value: 0},
            pos_z: {value: 0},
            scale_x: {value: 1},
            scale_y: {value: 1},
            scale_z: {value: 1},
            rot_x: {value: 0},
            rot_y: {value: 0},
            rot_z: {value: 0}
        },
        inputs: 1,
        outputs: 1,
        icon: "babylon.png",
        label: function() {
            return this.name_conf_a||"box";
        },
        oneditprepare: function () {
            function setUpSection(sectionId, isExpanded) {
                var basicSection = $(sectionId);
                var paletteHeader = basicSection.find('.red-ui-palette-header');
                var twistie = paletteHeader.find('i');
                var sectionContent = basicSection.find('.section-content');

                function toggleSection(expanded) {
                    twistie.toggleClass('expanded', expanded);
                    sectionContent.toggle(expanded);
                }
                paletteHeader.on("click", function(e) {
                    e.preventDefault();
                    var isExpanded = twistie.hasClass('expanded');
                    toggleSection(!isExpanded);
                });
                toggleSection(isExpanded);
            }
            setUpSection('#box-section-basic', true);
            setUpSection('#box-section-parameters', false);
            setUpSection('#box-section-initial', false);
        }        
    });
</script>

<script type="text/html" data-template-name="box">

    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name_conf_a" placeholder="Name">
    </div>
    <div id="box-section-basic">
        <div class="red-ui-palette-header">
            <i class="fa fa-angle-down"></i><span>Basic Configuration</span>
        </div>    
        <div class="section-content" style="padding:10px 0 0 10px">
            <div class="form-row">
                <label for="node-input-scene"><i class="fa fa-tag"></i>Scene</label>
                <input type="select" id="node-input-scene" placeholder="Scene"/>
            </div>
            <div class="form-row">
                <label for="node-input-material"><i class="fa fa-tag"></i>Material</label>
                <input type="select" id="node-input-material" placeholder="Material"/>
            </div>    
            <div class="form-row">
                <label>&nbsp;</label>
                <input type="checkbox" id="node-input-updatable_conf_b" style="display:inline-block; width:auto; vertical-align:top;">
                <label for="node-input-updatable_conf_b" style="width:70%;">Updatable</label>
            </div>   

            <div class="form-row">
                <label for="node-input-sideOrientation_conf_a"><i class="icon-tag"></i> SideOrientation</label>
                <select type="text" id="node-input-sideOrientation_conf_a">
                        <option value="0">FRONTSIDE</option>
                        <option value="1">BACKSIDE</option>
                        <option value="2">DOUBLESIDE</option>
                </select>    
            </div>   
        </div>
    </div>
    <div id="box-section-parameters">
        <div class="red-ui-palette-header">
            <i class="fa fa-angle-down"></i><span>Box Parameters</span>
        </div>
        <div class="section-content" style="padding:10px 0 0 10px">
            <div class="form-row">
                <label for="node-input-size_conf_n"><i class="icon-tag"></i> Size</label>
                <input type="text" id="node-input-size_conf_n"/>
            </div>  
    
            <div class="form-row">
                <label for="node-input-height_conf_n"><i class="icon-tag"></i> Height</label>
                <input type="text" id="node-input-height_conf_n"/>
            </div>  
            <div class="form-row">
                <label for="node-input-width_conf_n"><i class="icon-tag"></i> Width</label>
                <input type="text" id="node-input-width_conf_n"/>
            </div>    
            <div class="form-row">
                <label for="node-input-depth_conf_n"><i class="icon-tag"></i> Depth</label>
                <input type="text" id="node-input-depth_conf_n"/>
            </div>    
        </div>
    </div>
    <!-- Add Initial Position Orientation Here Parameters Section  here -->
    <div id="box-section-initial">
        <div class="red-ui-palette-header">
            <i class="fa fa-angle-down"></i><span>Box Initial</span>
        </div>
        <div class="section-content" style="padding:10px 0 0 10px">
            <div class="form-row">
                <p><i class="icon-tag"></i> Position </p>
            </div>
            <div style="display:flex; flex-direction: row; justify-content: lef; align-items: center">
                <label for="node-input-pos_x" style="margin-right: 20px;">X: </label>
                <input id="node-input-pos_x" type="text" style="width: 60px;margin-right: 30px; "/>
                <label for="node-input-pos_y" style="margin-right: 20px;">Y: </label>
                <input id="node-input-pos_y" type="text" style="width: 60px;margin-right: 30px;"/>
                <label for="node-input-pos_z" style="margin-right: 20px;">Z: </label>
                <input id="node-input-pos_z" type="text" style="width: 60px"/>
            </div>  
            <br/>
            <div class="form-row">
                <p><i class="icon-tag"></i> Scale </p>
            </div>      
            <div style="display:flex; flex-direction: row; justify-content: lef; align-items: center">
                <label for="node-input-scale_x" style="margin-right: 20px;">X: </label>
                <input id="node-input-scale_x" type="text" style="width: 60px;margin-right: 30px; "/>
                <label for="node-input-scale_y" style="margin-right: 20px;">Y: </label>
                <input id="node-input-scale_y" type="text" style="width: 60px;margin-right: 30px;"/>
                <label for="node-input-scale_z" style="margin-right: 20px;">Z: </label>
                <input id="node-input-scale_z" type="text" style="width: 60px"/>
            </div>     
            <br/>
            <div class="form-row">
                <p><i class="icon-tag"></i> Rotation (Degree)</p>
            </div>      
            <div style="display:flex; flex-direction: row; justify-content: lef; align-items: center">
                <label for="node-input-rot_x" style="margin-right: 20px;">X: </label>
                <input id="node-input-rot_x" type="text" style="width: 60px;margin-right: 30px; "/>
                <label for="node-input-rot_y" style="margin-right: 20px;">Y: </label>
                <input id="node-input-rot_y" type="text" style="width: 60px;margin-right: 30px;"/>
                <label for="node-input-rot_z" style="margin-right: 20px;">Z: </label>
                <input id="node-input-rot_z" type="text" style="width: 60px"/>
            </div>                           
        </div>
    </div>  
    
</script>

<script type="text/x-red" data-help-name="box">
    <p>Create a primitive box object</p>
</script>
<!-- --- [red-module:node-red-contrib-web-babylonjs/plane] --- -->
<script type="text/javascript">
    RED.nodes.registerType('plane',{
        category: '3D',
        color: '#D8BFD8',
        defaults: {
            scene: {value:"", type:"scene"},
            material: {value:"", type: "material", required: false},
            name_conf_a: { value: "", required: true },
            size_conf_n: { value: 1 ,validate:RED.validators.number()},
            height_conf_n: {},
            width_conf_n: {},
            depth_conf_n: {},
            updatable_conf_b: { value: false },
            sideOrientation_conf_a: { value: "DEFAULTSIDE" },
            pos_x: {value: 0},
            pos_y: {value: 0},
            pos_z: {value: 0},
            scale_x: {value: 1},
            scale_y: {value: 1},
            scale_z: {value: 1},
            rot_x: {value: 0},
            rot_y: {value: 0},
            rot_z: {value: 0}
        },
        inputs: 1,
        outputs: 1,
        icon: "babylon.png",
        label: function() {
            return this.name_conf_a||"plane";
        },
        oneditprepare: function () {
            function setUpSection(sectionId, isExpanded) {
                var basicSection = $(sectionId);
                var paletteHeader = basicSection.find('.red-ui-palette-header');
                var twistie = paletteHeader.find('i');
                var sectionContent = basicSection.find('.section-content');

                function toggleSection(expanded) {
                    twistie.toggleClass('expanded', expanded);
                    sectionContent.toggle(expanded);
                }
                paletteHeader.on("click", function(e) {
                    e.preventDefault();
                    var isExpanded = twistie.hasClass('expanded');
                    toggleSection(!isExpanded);
                });
                toggleSection(isExpanded);
            }
            setUpSection('#plane-section-basic', true);
            setUpSection('#plane-section-parameters', false);
            setUpSection('#plane-section-initial', false);
        }
    });
</script>

<script type="text/html" data-template-name="plane">
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name_conf_a" placeholder="Name">
    </div>
  
    <div id="plane-section-basic">
        <div class="red-ui-palette-header">
            <i class="fa fa-angle-down"></i><span>Basic Configuration</span>
        </div>
        <div class="section-content" style="padding:10px 0 0 10px">    
            <div class="form-row">
                <label for="node-input-scene"><i class="fa fa-tag"></i>Scene</label>
                <input type="select" id="node-input-scene" placeholder="Scene"/>
            </div>
            <div class="form-row">
                <label for="node-input-material"><i class="fa fa-tag"></i>Material</label>
                <input type="select" id="node-input-material" placeholder="Material"/>
            </div>    

            <div class="form-row">
                <label>&nbsp;</label>
                <input type="checkbox" id="node-input-updatable_conf_b" style="display:inline-block; width:auto; vertical-align:top;">
                <label for="node-input-updatable_conf_b" style="width:70%;">Updatable</label>
            </div>    
            <div class="form-row">
                <label for="node-input-sideOrientation_conf_a"><i class="icon-tag"></i> SideOrientation</label>
                <select type="text" id="node-input-sideOrientation_conf_a">
                    <option value="0">FRONTSIDE</option>
                    <option value="1">BACKSIDE</option>
                    <option value="2">DOUBLESIDE</option>
                </select>
            </div>  
        </div>
    </div>

    <div id="plane-section-parameters">
        <div class="red-ui-palette-header">
            <i class="fa fa-angle-down"></i><span>Plane Parameters</span>
        </div>
        <div class="section-content" style="padding:10px 0 0 10px">
            <div class="form-row">
                <label for="node-input-size_conf_n"><i class="icon-tag"></i> Size</label>
                <input type="text" id="node-input-size_conf_n"/>
            </div>      
            <div class="form-row">
                <label for="node-input-height_conf_n"><i class="icon-tag"></i> Height</label>
                <input type="text" id="node-input-height_conf_n"/>
            </div>  
            <div class="form-row">
                <label for="node-input-width_conf_n"><i class="icon-tag"></i> Width</label>
                <input type="text" id="node-input-width_conf_n"/>
            </div>    
            <div class="form-row">
                <label for="node-input-depth_conf_n"><i class="icon-tag"></i> Depth</label>
                <input type="text" id="node-input-depth_conf_n"/>
            </div>
        </div>
    </div>
     
    <div id="plane-section-initial">
        <div class="red-ui-palette-header">
            <i class="fa fa-angle-down"></i><span>Plane Initial</span>
        </div>
        <div class="section-content" style="padding:10px 0 0 10px">
            <div class="form-row">
                <p><i class="icon-tag"></i> Position </p>
            </div>
            <div style="display:flex; flex-direction: row; justify-content: lef; align-items: center">
                <label for="node-input-pos_x" style="margin-right: 20px;">X: </label>
                <input id="node-input-pos_x" type="text" style="width: 60px;margin-right: 30px; "/>
                <label for="node-input-pos_y" style="margin-right: 20px;">Y: </label>
                <input id="node-input-pos_y" type="text" style="width: 60px;margin-right: 30px;"/>
                <label for="node-input-pos_z" style="margin-right: 20px;">Z: </label>
                <input id="node-input-pos_z" type="text" style="width: 60px"/>
            </div>   
            <br/>
            <div class="form-row">
                <p><i class="icon-tag"></i> Scale </p>
            </div>      
            <div style="display:flex; flex-direction: row; justify-content: lef; align-items: center">
                <label for="node-input-scale_x" style="margin-right: 20px;">X: </label>
                <input id="node-input-scale_x" type="text" style="width: 60px;margin-right: 30px; "/>
                <label for="node-input-scale_y" style="margin-right: 20px;">Y: </label>
                <input id="node-input-scale_y" type="text" style="width: 60px;margin-right: 30px;"/>
                <label for="node-input-scale_z" style="margin-right: 20px;">Z: </label>
                <input id="node-input-scale_z" type="text" style="width: 60px"/>
            </div>     
            <br/>
            <div class="form-row">
                <p><i class="icon-tag"></i> Rotation (Degree)</p>
            </div>      
            <div style="display:flex; flex-direction: row; justify-content: lef; align-items: center">
                <label for="node-input-rot_x" style="margin-right: 20px;">X: </label>
                <input id="node-input-rot_x" type="text" style="width: 60px;margin-right: 30px; "/>
                <label for="node-input-rot_y" style="margin-right: 20px;">Y: </label>
                <input id="node-input-rot_y" type="text" style="width: 60px;margin-right: 30px;"/>
                <label for="node-input-rot_z" style="margin-right: 20px;">Z: </label>
                <input id="node-input-rot_z" type="text" style="width: 60px"/>
            </div>                       
        </div>
    </div>
</script>

<script type="text/x-red" data-help-name="plane">
    <p>Create a primitive plane object</p>
</script>
<!-- --- [red-module:node-red-contrib-web-babylonjs/cone] --- -->
<script type="text/javascript">
    RED.nodes.registerType('cone',{
        category: '3D',
        color: '#D8BFD8',
        defaults: {
            scene: { value: "", type: "scene", required: true },
            material: {value:"", type: "material", required: false},
            name_conf_a: { value: "", required: true },
            height_conf_n: { value: 2, validate: RED.validators.number() },
            diameterTop_conf_n: { value: 1, validate: RED.validators.number() },
            diameterBottom_conf_n: { value: 1, validate: RED.validators.number() },
            diameter_conf_n: { value: 1, validate: RED.validators.number() },
            tessellation_conf_n: { value: 24, validate: RED.validators.number() },
            subdivisions_conf_n: { value: 1, validate: RED.validators.number() },
            arc_conf_n: { value: 1, validate: RED.validators.number() },
            updatable_conf_b: { value: false },
            sideOrientation_conf_a: { value: "DEFAULTSIDE" },
            pos_x: {value: 0},
            pos_y: {value: 0},
            pos_z: {value: 0},
            scale_x: {value: 1},
            scale_y: {value: 1},
            scale_z: {value: 1},
            rot_x: {value: 0},
            rot_y: {value: 0},
            rot_z: {value: 0}
        },
        inputs: 1,
        outputs: 1,
        icon: "babylon.png",
        label: function() {
            return this.name_conf_a||"cone";
        },
        oneditprepare: function () {
            function setUpSection(sectionId, isExpanded) {
                var basicSection = $(sectionId);
                var paletteHeader = basicSection.find('.red-ui-palette-header');
                var twistie = paletteHeader.find('i');
                var sectionContent = basicSection.find('.section-content');

                function toggleSection(expanded) {
                    twistie.toggleClass('expanded', expanded);
                    sectionContent.toggle(expanded);
                }
                paletteHeader.on("click", function(e) {
                    e.preventDefault();
                    var isExpanded = twistie.hasClass('expanded');
                    toggleSection(!isExpanded);
                });
                toggleSection(isExpanded);
            }
            setUpSection('#cone-section-basic', true);
            setUpSection('#cone-section-parameters', false);
            setUpSection('#cone-section-initial', false);
        }
    });
</script>

<script type="text/html" data-template-name="cone">
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name_conf_a" placeholder="Name">
    </div>

    <div id="cone-section-basic">
        <div class="red-ui-palette-header">
            <i class="fa fa-angle-down"></i><span>Basic Configuration</span>
        </div>
        <div class="section-content" style="padding:10px 0 0 10px">
            <div class="form-row">
                <label for="node-input-scene"><i class="fa fa-tag"></i>Scene</label>
                <input type="select" id="node-input-scene" placeholder="Scene"/>
            </div>
            <div class="form-row">
                <label for="node-input-material"><i class="fa fa-tag"></i>Material</label>
                <input type="select" id="node-input-material" placeholder="Material"/>
            </div> 
            <div class="form-row">
                <label>&nbsp;</label>
                <input type="checkbox" id="node-input-updatable_conf_b" style="display:inline-block; width:auto; vertical-align:top;">
                <label for="node-input-updatable_conf_b" style="width:70%;">Updatable</label>
            </div>    
            <div class="form-row">
                <label for="node-input-sideOrientation_conf_a"><i class="icon-tag"></i> SideOrientation</label>
                <select type="text" id="node-input-sideOrientation_conf_a">
                    <option value="0">FRONTSIDE</option>
                    <option value="1">BACKSIDE</option>
                    <option value="2">DOUBLESIDE</option>
                </select>
            </div> 
        </div>
    </div>     

    <div id="cone-section-parameters">
        <div class="red-ui-palette-header">
            <i class="fa fa-angle-down"></i><span>Cone Parameters</span>
        </div>
        <div class="section-content" style="padding:10px 0 0 10px">
            <div class="form-row">
                <label for="node-input-height_conf_n"><i class="icon-tag"></i> Height</label>
                <input type="text" id="node-input-height_conf_n"/>
            </div>  
            <div class="form-row">
                <label for="node-input-diameterTop_conf_n"><i class="icon-tag"></i> Diameter Top</label>
                <input type="text" id="node-input-diameterTop_conf_n"/>
            </div>    
            <div class="form-row">
                <label for="node-input-diameterBottom_conf_n"><i class="icon-tag"></i> Diameter Bottom</label>
                <input type="text" id="node-input-diameterBottom_conf_n"/>
            </div> 

            <div class="form-row">
                <label for="node-input-diameter_conf_n"><i class="icon-tag"></i> Diameter</label>
                <input type="text" id="node-input-diameter_conf_n"/>
            </div> 
            <div class="form-row">
                <label for="node-input-tessellation_conf_n"><i class="icon-tag"></i> Tessellation</label>
                <input type="text" id="node-input-tessellation_conf_n"/>
            </div> 
            <div class="form-row">
                <label for="node-input-subdivisions_conf_n"><i class="icon-tag"></i> Subdivisions</label>
                <input type="text" id="node-input-subdivisions_conf_n"/>
            </div>    
            <div class="form-row">
                <label for="node-input-arc_conf_n"><i class="icon-tag"></i> Arc</label>
                <input type="text" id="node-input-arc_conf_n"/>
            </div>  
        </div>
    </div> 

    <div id="cone-section-initial">
        <div class="red-ui-palette-header">
            <i class="fa fa-angle-down"></i><span>Cone Initial</span>
        </div>
        <div class="section-content" style="padding:10px 0 0 10px">
            <div class="form-row">
                <p><i class="icon-tag"></i> Position </p>
            </div>
            <div style="display:flex; flex-direction: row; justify-content: lef; align-items: center">
                <label for="node-input-pos_x" style="margin-right: 20px;">X: </label>
                <input id="node-input-pos_x" type="text" style="width: 60px;margin-right: 30px; "/>
                <label for="node-input-pos_y" style="margin-right: 20px;">Y: </label>
                <input id="node-input-pos_y" type="text" style="width: 60px;margin-right: 30px;"/>
                <label for="node-input-pos_z" style="margin-right: 20px;">Z: </label>
                <input id="node-input-pos_z" type="text" style="width: 60px"/>
            </div>
            <br/>
            <div class="form-row">
                <p><i class="icon-tag"></i> Scale </p>
            </div>      
            <div style="display:flex; flex-direction: row; justify-content: lef; align-items: center">
                <label for="node-input-scale_x" style="margin-right: 20px;">X: </label>
                <input id="node-input-scale_x" type="text" style="width: 60px;margin-right: 30px; "/>
                <label for="node-input-scale_y" style="margin-right: 20px;">Y: </label>
                <input id="node-input-scale_y" type="text" style="width: 60px;margin-right: 30px;"/>
                <label for="node-input-scale_z" style="margin-right: 20px;">Z: </label>
                <input id="node-input-scale_z" type="text" style="width: 60px"/>
            </div>     
            <br/>
            <div class="form-row">
                <p><i class="icon-tag"></i> Rotation (Degree) </p>
            </div>      
            <div style="display:flex; flex-direction: row; justify-content: lef; align-items: center">
                <label for="node-input-rot_x" style="margin-right: 20px;">X: </label>
                <input id="node-input-rot_x" type="text" style="width: 60px;margin-right: 30px; "/>
                <label for="node-input-rot_y" style="margin-right: 20px;">Y: </label>
                <input id="node-input-rot_y" type="text" style="width: 60px;margin-right: 30px;"/>
                <label for="node-input-rot_z" style="margin-right: 20px;">Z: </label>
                <input id="node-input-rot_z" type="text" style="width: 60px"/>
            </div>       
        </div>
    </div>
    
</script>

<script type="text/x-red" data-help-name="cone">
    <p>Create a primitive cone/cylinder object</p>
</script>
<!-- --- [red-module:node-red-contrib-web-babylonjs/transform] --- -->
<script type="text/javascript">
    RED.nodes.registerType('transform', {
        category: '3D',
        color: '#D8BFD8',
        defaults: {
            name: { value: "position", required: true },
            relative: { value: false },
            xaxis: { value: 0},
            yaxis: { value: 0},
            zaxis: { value: 0},
            pivot_x: {value: 0},
            pivot_y: {value: 0},
            pivot_z: {value: 0},
        },
        inputs: 1,
        outputs: 1,
        icon: "babylon.png",
        label: function () {
            return this.name || "transform";
        }
    });
</script>
<script type="text/javascript">

</script>
<script type="text/html" data-template-name="transform">
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <!-- This logic was intented to enable for further sophisticated transformation pattern, that require futher different params as of now will use only simple logic !-->
        <select type="text" id="node-input-name" onchange = '(function(){  var nodeInput = document.getElementById("node-input-name");  var positionSection = document.getElementById("position-section");  positionSection.style.display = (nodeInput.value == "position" || nodeInput.value == "scale" || nodeInput.value == "rotate") ? "block" : "none";})()'>
                <option value="position">position</option>
                <option value="rotate">rotate</option>
                <option value="scale">scale</option>
        </select>
    </div>
    <div class="form-row">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-relative" style="display:inline-block; width:auto; vertical-align:top;">
        <label for="node-input-relative" style="width:70%;">Relative</label>
    </div>
    <div id="transformation-vector">
        <div class="red-ui-palette-header">
            <i class="fa fa-angle-down"></i>Transformation Vector</span>
        </div>
        <div class="section-content" style="padding:10px 0 0 10px" id="position-section">
            <div class="form-row">
                <label for="node-input-xaxis" style="width:5%"><i class="fa fa-tag"></i> X</label>
                <input type="text" style="width:10%" id="node-input-xaxis">
                <label for="node-input-yaxis" style="width:5%"><i class="fa fa-tag"></i> Y</label>
                <input type="text" style="width:10%" id="node-input-yaxis">
                <label for="node-input-zaxis" style="width:5%"><i class="fa fa-tag"></i> Z</label>
                <input type="text" style="width:10%" id="node-input-zaxis">
            </div>
        </div>
    </div>
    <div id="transformation-vector">
        <div class="red-ui-palette-header">
            <i class="fa fa-angle-down"></i>Pivot</span>
        </div>
        <div class="section-content" style="padding:10px 0 0 10px" id="position-section">
            <div class="form-row">
                <label for="node-input-pivot_x" style="width:5%"><i class="fa fa-tag"></i> X</label>
                <input type="text" style="width:10%" id="node-input-pivot_x">
                <label for="node-input-pivot_y" style="width:5%"><i class="fa fa-tag"></i> Y</label>
                <input type="text" style="width:10%" id="node-input-pivot_y">
                <label for="node-input-pivot_z" style="width:5%"><i class="fa fa-tag"></i> Z</label>
                <input type="text" style="width:10%" id="node-input-pivot_z">
            </div>
        </div>
    </div>    

</script>


<script type="text/html" data-help-name="transform">
    <p>A node to identify transformation Type </p>
    <ul>
        <li>position</li>
        <li>rotate</li>
        <li>scale</li>
    </ul>
    <p> Relative, by default the transformation is absolute, but with this check box you can make it relative </p>
</script>
<!-- --- [red-module:node-red-contrib-web-babylonjs/events] --- -->
<script type="text/javascript">
    RED.nodes.registerType('events', {
        category: '3D',
        color: '#D8BFD8',
        defaults: {
            name: { required: true },
        },
        outputs: 1,
        icon: "babylon.png",
        label: function () {
            return this.name || "events";
        }
    });
</script>
<script type="text/javascript">

</script>
<script type="text/html" data-template-name="events">
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>        
        <input type="text"  id="node-input-name">
    </div>
</script>


<script type="text/html" data-help-name="events">
    <p>A node to Capture Scene Events like keyboards </p>
</script>
<!-- --- [red-module:node-red-contrib-zip/zip] --- -->
<!--
  Copyright 2017 Guilherme Francescon

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/x-red" data-template-name="zip">
	<div class="form-row">
		<label for="node-input-mode"><i class="fa fa-sliders"></i> <span data-i18n="zip.label.mode"></span></label>
		<select type="text" id="node-input-mode">
			<option value="compress" data-i18n="zip.mode.compress"></option>
			<option value="decompress" data-i18n="zip.mode.decompress"></option>
		</select>
	</div>
    <div class="form-row" id="node-form-row-zip-filename" style="display: none">
        <label for="node-input-filename"><i class="fa fa-file"></i> <span data-i18n="zip.label.filename"></span></label>
        <input type="text" id="node-input-filename" data-i18n="[placeholder]zip.label.filename">
    </div>
    <div class="form-row" id="node-form-row-zip-compressionLevel" style="display: none">
        <label for="node-input-compressionlevel"><i class="fa fa-compress"></i> <span data-i18n="zip.label.compressionlevel"></span></label>
        <select type="text" id="node-input-compressionlevel">
            <option value="0" data-i18n="zip.label.level.no"></option>
            <option value="1" data-i18n="zip.label.level.fast"></option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6" data-i18n="zip.label.level.default"></option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9" data-i18n="zip.label.level.best"></option>
        </select>
    </div>
	<div class="form-row" id="node-form-row-zip-outasstring" style="display: none">
		<label>&nbsp;</label>
		<input type="checkbox" id="node-input-outasstring" style="display: inline-block; width: auto; vertical-align: top;">
		<label for="node-input-outasstring" style="width:70%;"><span data-i18n="zip.label.outasstring"></span></label>
	</div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="zip.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]zip.label.name">
    </div>
</script>



<script type="text/javascript">
    RED.nodes.registerType('zip',{
        category: 'function',
        color:"#DEBD5C",
        defaults: {
            name: {value: ""},
            mode: {value: "compress"},
            filename: {value: ""},
            compressionlevel: {value: 6},
            outasstring: {value: false}
        },
        inputs:1,
        outputs:1,
        icon: "zip.png",
        label: function() {
            return this.name||this._('zip.mode.' + this.mode).toLowerCase();
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            var filenameRow = $('#node-form-row-zip-filename');
            var compressionRow = $('#node-form-row-zip-compressionLevel');
            var outasstringRow = $('#node-form-row-zip-outasstring');
            var modeInput = $('#node-input-mode');

            if (this.compressionlevel === undefined) {
                this.compressionlevel = 6;
                $('#node-input-compressionlevel').val(6);
            }

            function updateUi() {
                switch(modeInput.val()) {
                    case "compress":
                        outasstringRow.hide();
                        filenameRow.show();
                        compressionRow.show();
                        break;
                    case "decompress":
                        outasstringRow.show();
                        filenameRow.hide();
                        compressionRow.hide();
                        break;
                }
            }

            modeInput.change(updateUi);
            updateUi();
        }
    });
</script>
<script type="text/x-red" data-help-name="zip">
    <p>Reads and creates ZIP files</p>

    <h3>Inputs</h3>
    <p><i>Compress</i> mode</p>
	<dl class="message-properties">
		<dt>payload<span class="property-type">string | Buffer</span></dt>
		<dd>
            The content to be compressed
		</dd>

		<dt>filename<span class="property-type">string</span></dt>
		<dd>
            Used to specify the file name that represents the content specified on <code>payload</code>.
            Used only if the field in the configuration of the node is left empty
		</dd>
    </dl>

    <p><i>Decompress</i> mode</p>
	<dl class="message-properties">
		<dt>payload<span class="property-type">Buffer</span></dt>
		<dd>
            A Buffer containing the ZIP file content to be decompressed
		</dd>
    </dl>

    <h3>Outputs</h3>
    <p><i>Compress</i> mode</p>
	<dl class="message-properties">
		<dt>payload<span class="property-type">Buffer</span></dt>
		<dd>
            A Buffer with the ZIP file content
		</dd>
    </dl>

    <p><i>Decompress</i> mode</p>
	<dl class="message-properties">
        <span>
            Array of objects, each representing a file in the ZIP file, 
            with the following properties:
        </span>
		<dt>payload<span class="property-type">Buffer | string</span></dt>
		<dd>
            The content of the file. If <i>Output payload as String</i>
            is set, the Buffer is converted to string
        </dd>
        
		<dt>filename<span class="property-type">string</span></dt>
		<dd>
            The name of the file
		</dd>
    </dl>
    

    <h3>Details</h3>
    <p>
        Node to zip one or more files given their contents (<i>Compress</i> mode), or unzips a file, returning all files 
        inside it (<i>Decompress</i> mode).
    </p>
    <p>
        When in <i>Compress</i> mode, the compression level can be set in the node's configuration, with 0 meaning no
        compression at all, 1 meaning fastest method (but poor compression), and 9 meaning best compression (but poor performance)
    </p>
    <p>
        Also in <i>Compress</i> mode, the node accepts an array of objects in <code>payload</code>, each with a <code>payload</code> and a 
        <code>filename</code> property, that represents each a file that will be in the resulting zip file
    </p>


</script>
<!-- --- [red-module:node-red-dashboard/ui_base] --- -->
<style>
    :root {
        --nr-db-dark-text: #444;
        --nr-db-light-text: #eee;
        --nr-db-disabled-text: #999;
        --nr-db-mid-grey: #7f7f7f;
    }
    .nr-db-sb {
        position: absolute;
        top: 1px;
        bottom: 2px;
        left: 1px;
        right: 1px;
        overflow-y: auto;
        padding: 10px;
    }
    .nr-db-sb .form-row label {
        display: block;
        width: auto;
    }
    .nr-db-sb .form-row input,
    .nr-db-sb .form-row select {
        width: calc(100% - 100px);
        margin-bottom:0;
    }
    .nr-db-sb .compact {
        margin-bottom: 8px !important;
    }
    .nr-db-sb .red-ui-editableList-container {
        padding: 0;
        min-height: 250px;
        height: auto;
    }
    .nr-db-sb-tab-list {
        min-height: 250px;
        height: auto;
    }
    .nr-db-sb-tab-list li {
        padding: 0;
    }
    .nr-db-sb-tab-list-item {
        border-radius: 4px;
        color: var(--red-ui-primary-text-color, var(--nr-db-dark-text));
    }
    .nr-db-sb-list-header {
        cursor: pointer;
        position:relative;
        color: var(--red-ui-header-text-color, var(--nr-db-dark-text));
        padding:3px;
        white-space: nowrap;
    }
    .nr-db-sb-list-header:hover {
        color: var(--red-ui-secondary-text-color-hover, var(--nr-db-dark-text));
    }
    .nr-db-sb-title-hidden {
        text-decoration: line-through;
    }
    .nr-db-sb-title-disabled {
        color: var(--red-ui-secondary-text-color-disabled, var(--nr-db-disabled-text));
    }
    .nr-db-sb-tab-list-header {
        background: var(--red-ui-primary-background, var(--nr-db-light-text));
        padding:5px;
    }
    .nr-db-sb-group-list-header:hover,
    .nr-db-sb-widget-list-header:hover {
        background: var(--red-ui-secondary-background-hover, var(--nr-db-light-text));
    }
    .nr-db-sb-list-chevron {
        width: 15px;
        text-align: center;
        margin: 3px 5px 3px 5px;
    }
    .nr-db-sb-tab-list-item .red-ui-editableList-container {
        border-radius: 0;
        border: none;
        height: auto !important;
        min-height: unset;
    }
    .nr-db-sb-list-handle {
        vertical-align: top;
        opacity: 0;
        cursor: move;
    }
    .nr-db-sb-list-header:hover>.nr-db-sb-list-handle,
    .nr-db-sb-list-header:hover>.nr-db-sb-list-header-button-group {
        opacity: 1;
    }
    .nr-db-sb-list-header-button-group {
        opacity: 0;
    }
    .nr-db-sb-list-handle  {
        color: var(--red-ui-tertiary-text-color, var(--nr-db-light-text));
        padding:5px;
    }
    .nr-db-sb-tab-list-header>.nr-db-sb-list-chevron  {
        margin-left: 0px;
        transition: transform 0.2s ease-in-out;
    }
    .nr-db-sb-group-list-header>.nr-db-sb-list-chevron {
        margin-left: 20px;
        transition: transform 0.2s ease-in-out;
    }
    .nr-db-sb-group-list {
        min-height: 10px;
    }
    .nr-db-sb-group-list li {
        border-bottom-color: var(--red-ui-secondary-border-color, var(--nr-db-light-text));
    }
    .nr-db-sb-group-list>li.ui-sortable-helper {
        border-top: 1px solid var(--red-ui-secondary-border-color, var(--nr-db-light-text));
    }
    .nr-db-sb-group-list>li:last-child {
        border-bottom: none;
    }
    .nr-db-sb-widget-list>li {
        border: none !important;
    }
    .nr-db-sb-group-list>li>.red-ui-editableList-item-handle {
        left: 10px;
    }
    .nr-db-sb-list-button-group {
        position: absolute;
        right: 3px;
        top: 0px;
        z-index: 2;
    }
    .nr-db-sb-list-header-button-group {
        position: absolute;
        right: 3px;
        top: 4px;
    }
    .nr-db-sb-list-header-button {
        margin-left: 5px;
    }
    .nr-db-sb li.ui-sortable-helper {
        opacity: 0.9;
    }
    .nr-db-sb-widget-icon {
        margin-left: 56px;
    }
    .nr-db-sb-icon {
        margin-right: 10px;
    }
    .nr-db-sb-link {
        display: inline-block;
        padding-left: 20px;
    }
    .nr-db-sb-link-name-container .fa-external-link {
      margin-right: 10px;
    }
    .nr-db-sb-link-url {
        font-size: 0.8em;
        color: var(--red-ui-secondary-text-color, var(--nr-db-mid-grey));
    }
    span.nr-db-color-pick-container {
        max-width: 50px;
        border-radius: 3px;
        margin-left: 15px;
    }
    input.nr-db-field-themeColor[type="color"] {
        width: 60px !important;
        padding: 0px;
        height: 20px;
        box-shadow: none;
        position: absolute;
        right: 36px;
        border-radius: 3px !important;
        border: solid 1px var(--red-ui-form-input-border-color, #ccc);
        -webkit-appearance: none;
        font-size: smaller;
        text-align: center;
    }
    input.nr-db-field-themeColor::-webkit-color-swatch {
        border: none;
    }
    .red-ui-tabs {
        margin-bottom: 15px;
    }
    .red-ui-tab.hidden {
        display: none;
    }
    #dashboard-tabs-list li a:hover {
        cursor: pointer;
    }
    #dash-link-button {
        background: none;
        border: none;
        margin-top: 3px;
        display: inline-block;
        margin: 3px 0px 0px 3px;
        height: 32px;
        line-height: 29px;
        max-width: 200px;
        overflow: hidden;
        white-space: nowrap;
        position: relative;
        padding: 0px 7px 0px 7px;
    }
    ul.red-ui-dashboard-theme-styles {
        list-style: none;
    }
    ul.red-ui-dashboard-theme-styles li {
        margin-bottom: 6px;
    }
    .nr-db-resetIcon {
        margin: 3px 6px 0px 6px;
        float: right;
        color: var(--red-ui-secondary-text-color, var(--nr-db-mid-grey));
        opacity: 0.8;
        display: block;
    }
    .nr-db-resetIcon:hover {
        cursor: pointer;
    }
    #nr-db-field-font {
        margin-left: 2em;
        width: calc(100% - 81px);
    }
    .nr-db-theme-label {
        font-weight: bold;
    }
    #custom-theme-library-container .btn-group {
        margin-bottom: 10px;
    }
</style>

<!-- Dashboard layout tool -->
<link rel="stylesheet" href="./ui_base/gs/gridstack.min.css">
<link rel="stylesheet" href="./ui_base/css/gridstack-extra.min.css">
<style>
.grid-stack {
    background-color: var(--red-ui-primary-background, #f8f8f8);
    border: solid 2px var(--red-ui-tertiary-border-color, #C0C0C0);
    margin: auto;
    min-height: 42px;
    display: table-cell;
    background-image: linear-gradient(var(--red-ui-tertiary-border-color, #C0C0C0) 1px, transparent 0),
                      linear-gradient(90deg, var(--red-ui-tertiary-border-color, #C0C0C0) 1px, transparent 0);
    background-size: 40px 43px;
}
.grid-stack>.grid-stack-item>.grid-stack-item-content {
    top: 3px;
    left: 5px;
    right: 5px;
    bottom: 3px;
}
.grid-stack-item-content {
    color: #2c3e50;
    text-align: center;
    background-color: #b0dfe3;
    border-radius: 2px;
    font-family: 'Helvetica Neue', Arial, Helvetica, sans-serif;
    white-space: nowrap;
    font-size: 12px;
    opacity: 0.7;
}
.grid-stack-item {
    cursor: move;
}
.nr-dashboard-layout-container-fluid {
  width: 100%;
  padding-right: 0px;
  padding-left: 0px;
  margin-right: 0px;
  margin-left: 0px;
}
.nr-dashboard-layout-row {
  width: 100%;
  display: -ms-flexbox;
  display: flex;
  -ms-flex-wrap: wrap;
  flex-wrap: wrap;
  margin-right: 0px;
  margin-left: 0px;
}
.nr-dashboard-layout-span12 {
  width: 98.4%;
  padding: 2px;
  margin-left: 2px;
}
.nr-dashboard-layout-span6 {
  width: 49.2%;
  padding: 2px;
  margin-left: 2px;
}
.nr-dashboard-layout-span4 {
  width: 32.7%;
  padding: 2px;
  margin-left: 2px;
}
.nr-dashboard-layout-span3 {
  width: 24.3%;
  padding: 2px;
  margin-left: 2px;
}
.nr-dashboard-layout-span2 {
  width: 16.0%;
  padding: 2px;
  margin-left: 2px;
}
.nr-dashboard-layout-resize-disable {
    cursor: pointer;
    float: right;
    position: relative;
    z-index: 90;
    margin-right: 4px;
}
.nr-dashboard-layout-resize-enable {
    cursor: pointer;
    float: right;
    position: relative;
    z-index: 90;
    margin-right: 1px;
}
.grid-stack>.ui-state-disabled {
    opacity: 1;
    background-image: none;
}
.grid-stack>.grid-stack-item>.ui-resizable-handle {
    z-index: 90;
    margin-right: -7px;
}
</style>


<script type="text/javascript">
(function($) {
    var editSaveEventHandler;
    var nodesAddEventHandler;
    var nodesRemoveEventHandler;
    var layoutUpdateEventHandler; // Dashboard layout tool
    var uip = 'ui';
    var attemptedVendorLoad = false;
    var ensureDashboardNode;

    var isTabLockSupported = ((typeof RED.workspaces.isLocked) === "function"); // check for new Node-RED version

    function notifyLocked() {
        RED.notify("Can't change tab with nodes in locked tab");
    }

    // check if specified tab is locked
    function isLockedTab(id) {
        if (!isTabLockSupported) {
            return false;
        }
        return (RED.workspaces.isLocked(id));
    }

    // check if some node in tab placed on locked tab
    function isLocked(id) {
        if (!isTabLockSupported) {
            return false;
        }
        const tab = getTabDataFromNodes(id);
        const groups = tab.groups;
        for (let i = 0; i < groups.length; i++) {
            const group = groups[i];
            const widgets = group.widgets;
            for (let j = 0; j < widgets.length; j++) {
                const widget = RED.nodes.node(widgets[j].id);
                if (RED.workspaces.isLocked(widget.z)) {
                    return true;
                }
            }
        }
        return false;
    }

    var loadTinyColor = function(path) {
        $.ajax({ url: path,
            success: function (data) {
                var jsScript = document.createElement("script");
                jsScript.type = "application/javascript";
                jsScript.src = path;
                document.body.appendChild(jsScript);
                //console.log('Tiny Color Loaded:',path);
            },
            error: function (xhr, ajaxOptions, thrownError) {
                if (xhr.status === 404 && !attemptedVendorLoad) {
                    loadTinyColor('/'+uip+'/vendor/tinycolor2/dist/tinycolor-min.js');
                    attemptedVendorLoad = true;
                }
                //console.log('Tiny Color Failed to load:',path);
            }
        });
    }

    // convert to i18 text
    function c_(x) {
        return RED._("node-red-dashboard/ui_base:ui_base."+x);
    }

    // Try to load dist version first
    // then if fails, load non dist version
    loadTinyColor('ui_base/js/tinycolor-min.js');
    //loadTinyColor('ui_base/tinycolor2/dist/tinycolor-min.js');

    // Dashboard layout tool
    // Load gridstack library
    var loadGsLib = function(path, callback) {
        $.ajax({ url: path,
            success: function (data) {
                var jsScript = document.createElement("script");
                jsScript.type = "application/javascript";
                jsScript.src = path;
                document.body.appendChild(jsScript);
                if (callback) { callback(); }
            },
            error: function (xhr, ajaxOptions, thrownError) {
                // TODO
            }
        });
    };

    loadGsLib('ui_base/gs/gridstack.min.js', function() {
        loadGsLib('ui_base/gs/gridstack.jQueryUI.min.js', null)
    });

    var tabDatas; // Layout editing tab data
    var oldSpacer; // Spacer not needed after editing
    var widthChange; // Group width change
    var widgetResize; // Change widget event
    var widgetDrag; // Drag wiget event

    var MAX_GROUP_WIDTH = 50; // The maximum width is 30

    /////////////////////////////////////////////////////////
    // Get widget under specified tab from node information
    /////////////////////////////////////////////////////////
    function getTabDataFromNodes(tabID) {
        var nodes = RED.nodes.createCompleteNodeSet(false);
        var tab = {};
        // Tab information
        for (var cnt = 0; cnt < nodes.length; cnt++) {
            if (nodes[cnt].id == tabID) {
                if (nodes[cnt].type == "ui_tab" || nodes[cnt].type == "ui_link") {
                    tab = {
                        id: nodes[cnt].id,
                        name: nodes[cnt].name,
                        type: nodes[cnt].type,
                        order: nodes[cnt].order,
                        groups: []
                    };
                    break;
                }
            }
        }
        // Group information
        for (var cnt = 0; cnt < nodes.length; cnt++) {
            if (nodes[cnt].type == "ui_group" && nodes[cnt].tab == tabID) {
                var group = {
                    id: nodes[cnt].id,
                    name: nodes[cnt].name,
                    type: nodes[cnt].type,
                    order: nodes[cnt].order,
                    width: nodes[cnt].width,
                    widgets: []
                };
                tab.groups.push(group);
            }
        }
        // Widget information
        var groupsIdx = {};
        for  (var cnt = 0; cnt < tab.groups.length; cnt++) {
            groupsIdx[tab.groups[cnt].id] = tab.groups[cnt];
        }
        for (var cnt = 0; cnt < nodes.length; cnt++) {
            var group = groupsIdx[nodes[cnt].group];
            if (group != null && (/^ui_/.test(nodes[cnt].type) && nodes[cnt].type !== 'ui_link' && nodes[cnt].type !== 'ui_toast' && nodes[cnt].type !== 'ui_ui_control' && nodes[cnt].type !== 'ui_audio' && nodes[cnt].type !== 'ui_base' && nodes[cnt].type !== 'ui_group' && nodes[cnt].type !== 'ui_tab')) {
                var widget = {
                    id: nodes[cnt].id,
                    type: nodes[cnt].type,
                    order: nodes[cnt].order,
                    width: nodes[cnt].width,
                    height: nodes[cnt].height,
                    auto: nodes[cnt].width == 0 ? true : false
                };
                group.widgets.push(widget);

                if (!isLayoutToolSupported(nodes[cnt].type)) {
                    console.log("LayoutTool warning: Unsupported widget. Widget="+JSON.stringify(widget));
                }
            }
        }
        return tab;
    }

    //////////////////////////////////////////////////
    // Update node information in the edited widget
    ////////////////////////////////////////////////////
    function putTabDataToNodes() {
        // Delete old flow spacer node
        for (var cnt = 0; cnt < oldSpacer.length; cnt++) {
            RED.nodes.remove(oldSpacer[cnt]);
            RED.nodes.dirty(true);
            RED.view.redraw(true);
        }

        var t_groups = tabDatas.groups;
        for (var cnt1 = 0; cnt1 < t_groups.length; cnt1++) {
            var n_group = RED.nodes.node(t_groups[cnt1].id);
            n_group.width = t_groups[cnt1].width;
            var t_widgets = t_groups[cnt1].widgets;
            for (var cnt2 = 0; cnt2 < t_widgets.length; cnt2++) {
                var n_widget = RED.nodes.node(t_widgets[cnt2].id);
                if (n_widget != null) {
                    if (n_widget.group !== n_group.id) {
                        var oldGroupNode = RED.nodes.node(n_widget.group);
                        if (oldGroupNode) {
                            var index = oldGroupNode.users.indexOf(n_widget);
                            oldGroupNode.users.splice(index,1);
                        }
                        n_widget.group = n_group.id;
                        n_group.users.push(n_widget);
                    }
                    n_widget.order = t_widgets[cnt2].order;
                    if (t_widgets[cnt2].auto === true ) {
                        n_widget.width = 0;
                        n_widget.height = 0;
                    } else {
                        n_widget.width = t_widgets[cnt2].width;
                        n_widget.height = t_widgets[cnt2].height;
                    }

                    n_widget.changed = true;
                    n_widget.dirty = true;
                    RED.editor.validateNode(n_widget);
                    RED.events.emit("layout:update",n_widget);
                    RED.nodes.dirty(true);
                    RED.view.redraw(true);
                }
                else {
                    // Add a spacer node
                    if (t_widgets[cnt2].type === 'ui_spacer') {
                        var spaceNode = {
                            _def: RED.nodes.getType("ui_spacer"),
                            type: "ui_spacer",
                            hasUsers: false,
                            users: [],
                            id: RED.nodes.id(),
                            tab: tabDatas.id,
                            group: n_group.id,
                            order: t_widgets[cnt2].order,
                            name: "spacer",
                            width: t_widgets[cnt2].width,
                            height: t_widgets[cnt2].height,
                            z: RED.workspaces.active(),
                            label: function() { return this.name + " " + this.width + "x" + this.height; }
                        };
                        RED.nodes.add(spaceNode);
                        RED.editor.validateNode(spaceNode);
                        RED.nodes.dirty(true);
                        RED.view.redraw(true);
                    }
                }
            };
        }
        RED.sidebar.info.refresh();
    }

    ////////////////////////////////////////
    // Sort by order
    ////////////////////////////////////////
    function compareOrder(a, b) {
        var r = 0;
        if (a.order < b.order) { r = -1; }
        else if (a.order > b.order) { r = 1; }
        return r;
    }

    ////////////////////////////////////////
    // Sort by XY
    ////////////////////////////////////////
    function compareXY(a, b) {
        var r = 0;
        if (a.y < b.y) { r = -1; }
        else if (a.y > b.y) { r = 1; }
        else if (a.x < b.x) { r = -1; }
        else if (a.x > b.x) { r = 1; }
        return r;
    }

    ///////////////////////////////////////////////////////
    // Placeable location search (placed in the upper left)
    ///////////////////////////////////////////////////////
    function search_point(width, height, maxWidth, maxHeight, tbl) {
        for (var y=0; y < maxHeight; y++) {
            for (var x=0; x < maxWidth; x++) {
                if (check_matrix(x, y, width, height, maxWidth, tbl)) {
                    fill_matrix(x, y, width, height, maxWidth, tbl);
                    return  {x:x, y:y};
                }
            }
        }
        return false;
    }
    // Check placement position
    function check_matrix(px, py, width, height, maxWidth, tbl) {
        if (px+width > maxWidth) return false;
        for (var y=py; y < py+height; y++) {
            for (var x=px; x<px+width; x++) {
                if (tbl[maxWidth*y+x]) return false;
            }
        }
        return true;
    }
    // Mark the placement position
    function fill_matrix(px, py, width, height, maxWidth, tbl) {
        for (var y=py; y < py+height; y++) {
            for (var x=px; x < px+width; x++) {
                tbl[maxWidth*y+x] = 1;
            }
        }
    }

    ////////////////////////////////////////////////////
    // Apply edit result to tab information for editing
    ////////////////////////////////////////////////////
    function saveGridDatas() {
        var groups = tabDatas.groups;
        for (var cnt = 0; cnt < groups.length; cnt++) {
            // Get layout editing results
            var gridID = '#grid'+cnt;
            var serializedData = [];
            $(gridID+'.grid-stack > .grid-stack-item:visible').each( function (index) {
                el = $(this);
                var node = el.data('_gridstack_node');
                serializedData.push({
                    id: el[0].dataset.noderedid,
                    type: el[0].dataset.noderedtype,
                    group: groups[cnt].id,
                    width: Number(node.width),
                    height: Number(node.height),
                    x: node.x,
                    y: node.y,
                    auto: (el[0].dataset.noderedsizeauto == 'true') ? true : false
                });
            });

            var width = Number(groups[cnt].width);
            var height = 0;

            // Search group height
            for (var i=0; i < serializedData.length; i++) {
                var wd = serializedData[i];
                if (height < wd.y + wd.height) {
                    height = wd.y + wd.height;
                }
            }

            // Place widget on table
            var tbl = new Array(width * height);
            for (var i = 0; i< tbl.length; i++) {
                tbl[i]=0;
            }
            for (var i = 0; i < serializedData.length; i++) {
                var wd = serializedData[i];
                for (var y = wd.y; y < wd.y+wd.height; y++) {
                    for (var x = wd.x; x < wd.x+wd.width; x++) {
                        tbl[width*y+x]=1;
                    }
                }
            }

            // Add Spacer to Blank
            for (var y = 0; y < height; y++) {
                var spacerAdded = false;
                for (var x = 0; x < width; x++) {
                    if (tbl[width*y+x]===0) {
                        if (!spacerAdded) {
                            // Add 1x1 spacer
                            serializedData.push({
                                x: x,
                                y: y,
                                z: RED.workspaces.active(),
                                width: 1,
                                height: 1,
                                name: 'spacer',
                                type: 'ui_spacer'
                            });
                            spacerAdded = true;
                        } else {
                            // Extend the spacer width by 1
                            serializedData[serializedData.length-1].width += 1;
                        }
                    } else {
                        spacerAdded = false;
                    }
                }
            }

            // Sort Gridstack objects by x, y information
            serializedData.sort(compareXY);

            // Delete x and y elements as information for sorting, and give order
            var order = 0;
            for (i in serializedData) {
                order++;
                delete serializedData[i].x;
                delete serializedData[i].y;
                serializedData[i].order = order;
            }

            // Update widget information in group with edited data
            var group = groups[cnt];
            delete group.widgets;
            group.widgets = serializedData;
        }

        // Save process call
        putTabDataToNodes();
    };

    ////////////////////////////////////////////////////
    // Get default height for automatic settings
    ////////////////////////////////////////////////////
    function getDefaultHeight(nodeID, groupWidth) {
        var redNode = RED.nodes.node(nodeID);
        var height = 1;

        if (redNode.type === 'ui_gauge') {
            if (redNode.gtype === 'gage') {
                height = Math.round(groupWidth/2)+1;
            } else if (redNode.gtype === 'wave') {
                if (groupWidth < 3) {
                    height = 1;
                } else {
                    height = Math.round(groupWidth*0.75);
                }
            } else { // donut or compass
                if (groupWidth < 3) {
                    height = 1;
                } else if (groupWidth < 11) {
                    height = groupWidth - 1;
                } else {
                    height = Math.round(groupWidth*0.95);
                }
            }
        } else if (redNode.type === 'ui_chart') {
            height = Math.floor(groupWidth/2)+1;
        } else if (redNode.type === 'ui_form') {
            // var optNum = redNode.options.length; // Sub widget number
            // if (redNode.label) {
            //     height = optNum + 2; // Label and Button
            // } else {
            //     height = optNum + 1; // Button only
            // }
            height = redNode.rowCount
        } else if (redNode.type === 'ui_lineargauge') {
            if (redNode.unit && redNode.name) {
                height = 5;
            } else {
                height = 4;
            }
        } else if (redNode.type === 'ui_list') {
            height = 5;
        } else if (redNode.type === 'ui_vega') {
            height = 5;
        }
        return height;
    }

    /////////////////////////////
    // Grid width change
    ////////////////////////////
    var changeGroupWidth = function(id) {
        var widthID = '#change-width'+id;
        var gridID = '#grid'+id;
        $(widthID).spinner( {
            min: 1,
            max: MAX_GROUP_WIDTH,
            spin: function(event, ui) {
                // Search current maximum width
                var serializedData = [];
                $(gridID+'.grid-stack > .grid-stack-item:visible').each( function (index) {
                    el = $(this);
                    var node = el.data('_gridstack_node');
                    serializedData.push({
                        width: Number(node.width),
                        x: node.x,
                        auto: (el[0].dataset.noderedsizeauto == 'true') ? true : false
                    });
                });
                var maxWidth = 0;
                for (var i=0; i < serializedData.length; i++) {
                    var wd = serializedData[i];
                    if (wd.auto == false) {
                        if (maxWidth < wd.x + wd.width) {
                            maxWidth = wd.x + wd.width;
                        }
                    }
                }
                var width = ui.value;
                if (width < maxWidth) {
                    width = maxWidth;
                }

                var grid = $(gridID+'.grid-stack').data('gridstack');
                $(gridID+'.grid-stack').css("width", width * 40);
                $(gridID+'.grid-stack').css("background-size", 100/width+"% 43px");
                grid.setColumn(tabDatas.groups[id].width, true);
                grid.setColumn(width, true);
                tabDatas.groups[id].width = width;

                $(gridID+'.grid-stack > .grid-stack-item:visible').each( function(idx, el) {
                    el = $(el);
                    var node = el.data('_gridstack_node');
                    var auto = (el[0].dataset.noderedsizeauto == 'true') ? true : false;
                    var type = el[0].dataset.noderedtype;
                    grid.resizable(el, !auto);
                    if (auto === true) {
                        grid.resize(el, width, getDefaultHeight(node.id, width));
                    }
                });

                if (width !== ui.value) {
                    event.stopPropagation();
                    event.preventDefault();
                }
            }
        });
    };

    //////////////////////////////////
    // Move between groups of widgets
    //////////////////////////////////
    function handleMove(grid) {
        return function(ev, prevWidget, newWidget) {
            var elem = newWidget.el[0];
            if (elem.getAttribute("data-noderedsizeauto") === "true") {
                var id = elem.getAttribute("data-noderedid");
                var width = grid.grid.column;
                var height = getDefaultHeight(id, width);
                grid.move(elem, 0, newWidget.y);
                grid.resize(elem, width, height);

                var en = $(elem).find('.nr-dashboard-layout-resize-enable');
                en.off('click');
                en.on('click',layoutResizeEnable);
                en[0].setAttribute("title",c_("layout.auto"));
            }
            else {
                var ds = $(elem).find('.nr-dashboard-layout-resize-disable');
                ds.off('click');
                ds.on('click',layoutResizeDisable);
                ds[0].setAttribute("title",c_("layout.manual"));
            }
        };
    }

    //////////////////////////////////////////
    // Widget size change (start event)
    //////////////////////////////////////////
    var resizeGroupWidget = function(id) {
        var gridID = '#grid'+id;
        var grid = $(gridID+'.grid-stack').data('gridstack');
        $(gridID+'.grid-stack').on('resizestart', function(event, ui) {
            // Reset group width
            grid.setColumn(tabDatas.groups[id].width, true);
        });
    }

    //////////////////////////////////////////
    // Widget drag (start event)
    //////////////////////////////////////////
    var dragGroupWidget = function(id) {
        var gridID = '#grid'+id;
        var grid = $(gridID+'.grid-stack').data('gridstack');
        $(gridID+'.grid-stack').on('dragstart', function(event, ui) {
            // Reset group width
            grid.setColumn(tabDatas.groups[id].width, true);
        });
    }

    //////////////////////////////////////////
    // Layout resize Disable (Auto:false)
    //////////////////////////////////////////
    var layoutResizeDisable = function(e) {
        var target = $(e.target);
        var el = target.parents('.grid-stack-item:visible');
        var grid = target.parents('.grid-stack').data('gridstack');
        var node = el.data('_gridstack_node');
        var id = Number(target.parents('.grid-stack').attr('id').slice(4));
        var width = Number(tabDatas.groups[id].width);
        var nodeID = el[0].dataset.noderedid;
        var height = getDefaultHeight(nodeID, width);

        grid.move(el, 0, node.y);
        grid.resize(el, width, height);
        grid.resizable(el, false);
        el.find('.nr-dashboard-layout-resize-disable').off('click');
        el.attr({'data-noderedsizeauto':'true'});
        target.removeClass().addClass('fa fa-unlock nr-dashboard-layout-resize-enable');
        el.find('.nr-dashboard-layout-resize-enable')[0].setAttribute("title",c_("layout.auto"));
        el.find('.nr-dashboard-layout-resize-enable').on('click',layoutResizeEnable);
    }

    //////////////////////////////////////////
    // Layout resize Enable (Auto:true)
    //////////////////////////////////////////
    var layoutResizeEnable = function(e) {
        var target = $(e.target);
        var el = target.parents('.grid-stack-item:visible');
        var grid = target.parents('.grid-stack').data('gridstack');

        grid.resizable(el, true);
        el.find('.nr-dashboard-layout-resize-enable').off('click');
        el.attr({'data-noderedsizeauto':'false'});
        target.removeClass().addClass('fa fa-lock nr-dashboard-layout-resize-disable');
        el.find('.nr-dashboard-layout-resize-disable')[0].setAttribute("title",c_("layout.manual"));
        el.find('.nr-dashboard-layout-resize-disable').on('click',layoutResizeDisable);
    }

    //////////////////////////////////////////
    // Check dashboard layout tool supported
    //////////////////////////////////////////
    function isLayoutToolSupported(nodeType) {
        if (nodeType.indexOf("ui_") !== 0) {
            return false;
        }
        else {
            return true;
        }
    }

    RED.nodes.registerType('ui_base', {
            category: 'config',
            defaults: {
                name: {},
                theme: {},
                site: {}
            },
            hasUsers: false,
            paletteLabel: 'Dashboard',
            label: function() { return this.name || 'Node-RED Dashboard'; },
            labelStyle: function() { return this.name ? "node_label_italic" : ""; },
            onpaletteremove: function() {
                RED.sidebar.removeTab("dashboard");
                RED.events.off("editor:save",editSaveEventHandler);
                RED.events.off("nodes:add",nodesAddEventHandler);
                RED.events.off("nodes:remove",nodesRemoveEventHandler);
                RED.events.off("layout:update",layoutUpdateEventHandler); // Dashboard layout tool
            },
            onpaletteadd: function() {
                var globalDashboardNode = null;
                var editor;
                var baseStyles = ['base-color'];
                var configurableStyles = ['page-titlebar-backgroundColor', 'page-backgroundColor', 'page-sidebar-backgroundColor',
                'group-textColor', 'group-borderColor', 'group-backgroundColor',
                'widget-textColor', 'widget-backgroundColor','widget-borderColor'];
                var baseFontName = "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif";
                var aTheme = {primary:"indigo", accents:"blue", warn:"red", background:"grey", palette:"light"};
                // tiny colour implementation
                var colours = {
                    leastReadable: function(base, colours) {
                        var least = tinycolor.readability(base, colours[0]);
                        var leastColor = colours[0];
                        for (var i=1; i<colours.length; i++) {
                            var readability = tinycolor.readability(base, colours[i]);
                            if (readability < least) {
                                least = readability;
                                leastColor = colours[i];
                            }
                        }
                        return leastColor;
                    },
                    whiteGreyMostReadable: function (base) {
                        var rgb = tinycolor(base).toRgb();
                        var level = ((rgb.r*299) + (rgb.g*587) + (rgb.b*114))/1000;
                        var readable = (level >= 128) ? '#111111' : '#eeeeee';
                        return readable;
                    },
                    whiteBlackLeastReadable: function(base) {
                        return this.leastReadable(base, ["#000000", "#ffffff"]);
                    },
                    calculate_page_backgroundColor: function(base) {
                        var pageBackground = "#fafafa";
                        var theme = "light";
                        if (globalDashboardNode && globalDashboardNode.hasOwnProperty("theme") && globalDashboardNode.theme.hasOwnProperty("name")) {
                            theme = globalDashboardNode.theme.name.split('-')[1];
                        }
                        if (theme === "dark") {
                            pageBackground = "#111111";
                        }
                        else if (theme === "custom") {
                            var whiteOrBlack = this.whiteBlackLeastReadable(base);
                            if (whiteOrBlack === "#000000") { pageBackground = "#111111"; }
                        }
                        return pageBackground;
                    },
                    calculate_page_sidebar_backgroundColor: function(base) {
                        if (this.whiteBlackLeastReadable(base) === "#000000") { return "#333333"; }
                        else { return "#ffffff"; }
                    },
                    calculate_page_titlebar_backgroundColor: function(base) {
                        return base;
                    },
                    calculate_group_textColor: function(base) {
                        var groupTextColour = tinycolor(base).lighten(15).toHexString();
                        //if (this.whiteBlackLeastReadable(base) === "#ffffff") { groupTextColour = "#000000"; }
                        return groupTextColour;
                    },
                    calculate_group_backgroundColor: function(base) {
                        var groupBackground = "#ffffff";
                        var theme = "light";
                        if (globalDashboardNode && globalDashboardNode.hasOwnProperty("theme") && globalDashboardNode.theme.hasOwnProperty("name")) {
                            theme = globalDashboardNode.theme.name.split('-')[1];
                        }
                        if (theme === "dark") {
                            groupBackground = "#333333";
                        }
                        else if (theme === "custom") {
                            var whiteOrBlack = this.whiteBlackLeastReadable(base);
                            if (whiteOrBlack === "#000000") { groupBackground = "#333333"; }
                        }
                        return groupBackground;
                    },
                    calculate_group_borderColor: function(base) {
                        var groupBackground = this.calculate_group_backgroundColor(base);
                        return this.leastReadable(groupBackground, ["#ffffff", "#555555"]);
                    },
                    calculate_widget_textColor: function(base) {
                        //most readable against group background
                        var groupBackground = this.calculate_group_backgroundColor(base);
                        return tinycolor.mostReadable(groupBackground, ["#111111", "#eeeeee"]).toHexString();
                    },
                    calculate_widget_backgroundColor: function(base) {
                        //return tinycolor(base).darken(5).toHexString()
                        return tinycolor(base).toHexString();
                    },
                    calculate_widget_borderColor: function(base) {
                        var widgetBorder = "#ffffff";
                        var theme = "light";
                        if (globalDashboardNode && globalDashboardNode.hasOwnProperty("theme") && globalDashboardNode.theme.hasOwnProperty("name")) {
                            theme = globalDashboardNode.theme.name.split('-')[1];
                        }
                        if (theme === "dark") {
                            widgetBorder = "#333333";
                        }
                        else if (theme === "custom") {
                            var whiteOrBlack = this.whiteBlackLeastReadable(base);
                            if (whiteOrBlack === "#000000") { widgetBorder = "#333333"; }
                        }
                        return widgetBorder;
                    },
                    calculate_base_font: function(base) {
                        return baseFontName;
                    }
                }
                var sizes = {
                    sx: 48, // width of <1> grid square
                    sy: 48, // height of <1> grid square
                    gx: 6, // gap between groups
                    gy: 6, // gap between groups
                    cx: 6, // gap between components
                    cy: 6, // gap between components
                    px: 0, // padding of group's cards
                    py: 0  // padding of group's cards
                };

                ensureDashboardNode = function(createMissing) {
                    if (globalDashboardNode !== null) {
                        // Check if it has been deleted beneath us
                        var n = RED.nodes.node(globalDashboardNode.id);
                        if (n === null) { globalDashboardNode = null; }
                    }

                    // Find the old dashboard node
                    if (globalDashboardNode === null) {
                        var bases = [];
                        RED.nodes.eachConfig(function(n) {
                            if (n.type === 'ui_base') { bases.push(n); }
                        });

                        // make sure we only have one ui_base node
                        // at the moment this will just use our existing one - deleting any new base node and theme
                        // at some point we may want to make this an option to select one or the other.
                        while (bases.length > 1) {
                            var n = bases.pop();
                            console.log("Removing ui_base node "+n.id);
                            RED.nodes.remove(n.id);
                            RED.nodes.dirty(true);
                        }

                        if (bases.length === 1) { globalDashboardNode = bases[0]; }

                        // If there is no dashboard node, ensure we create it after
                        // initialising
                        var noDashboardNode = (globalDashboardNode === null);

                        // set up theme state
                        var themeState = {};
                        var baseColor = "#0094CE"
                        for (var i=0; i<baseStyles.length; i++) {
                            themeState[baseStyles[i]] = { default:baseColor, value:baseColor, edited:false };
                        }
                        for (var j = 0; j < configurableStyles.length; j++) {
                            var underscore = configurableStyles[j].split("-").join("_");
                            var colour = colours['calculate_'+underscore](baseColor);
                            themeState[configurableStyles[j]] = {value:colour, edited:false};
                        }
                        themeState["base-font"] = {value:baseFontName};

                        var missingFields = (!globalDashboardNode || !globalDashboardNode.theme || !globalDashboardNode.site || !globalDashboardNode.site.sizes );

                        if (missingFields && createMissing) {
                            var lightTheme = {
                                default: baseColor,
                                baseColor: baseColor,
                                baseFont: baseFontName,
                                edited: false
                            }
                            var darkTheme = {
                                default: "#097479",
                                baseColor: "#097479",
                                baseFont: baseFontName,
                                edited: false
                            }
                            var customTheme = {
                                name: 'Untitled Theme 1',
                                default: "#4B7930",
                                baseColor: "#4B7930",
                                baseFont: baseFontName
                            }
                            var oldThemeName;
                            if (globalDashboardNode && typeof(globalDashboardNode.theme === 'string')) { oldThemeName = globalDashboardNode.theme; }

                            var theme = {
                                name: oldThemeName || "theme-light",
                                lightTheme: lightTheme,
                                darkTheme: darkTheme,
                                customTheme: customTheme,
                                themeState: themeState,
                                angularTheme: aTheme
                            }

                            var site_name = c_("site.title");
                            var site_date_format = c_("site.date-format");
                            var site = { name:site_name, hideToolbar:"false", allowSwipe:"false", lockMenu:"false", allowTempTheme:"true", dateFormat:site_date_format, sizes:sizes };
                            if (globalDashboardNode !== null) {
                                if (typeof globalDashboardNode.site !== "undefined") {
                                    site = {
                                        name: globalDashboardNode.site.name || globalDashboardNode.name,
                                        hideToolbar: globalDashboardNode.site.hideToolbar,
                                        lockMenu: globalDashboardNode.site.lockMenu,
                                        allowSwipe: globalDashboardNode.site.allowSwipe,
                                        allowTempTheme: globalDashboardNode.site.allowTempTheme,
                                        dateFormat: globalDashboardNode.site.dateFormat,
                                        sizes: globalDashboardNode.site.sizes
                                    }
                                }
                                if (globalDashboardNode.theme.hasOwnProperty("angularTheme")) {
                                    aTheme = globalDashboardNode.theme.angularTheme;
                                }
                                else { globalDashboardNode.theme.angularTheme = aTheme; }
                            }

                            if (noDashboardNode) {
                                globalDashboardNode = {
                                    id: RED.nodes.id(),
                                    _def: RED.nodes.getType("ui_base"),
                                    type: "ui_base",
                                    site: site,
                                    theme: theme,
                                    users: []
                                }
                                RED.nodes.add(globalDashboardNode);
                                RED.editor.validateNode(globalDashboardNode);
                            }
                            else {
                                globalDashboardNode["_def"] = RED.nodes.getType("ui_base");
                                globalDashboardNode.site = site;
                                globalDashboardNode.theme = theme;
                                delete globalDashboardNode.name;
                            }
                            $("#nr-db-field-font").val(baseFontName);
                            RED.nodes.dirty(true);
                        }
                    }
                }

                var content = $("<div>").css({"position":"relative","height":"100%"});
                var mainContent = $("<div>",{class:"nr-db-sb"}).appendTo(content);
                var form = $('<form class="dialog-form">').appendTo(mainContent);

                // Dashboard Tabs markup
                var divTab = $('<div class="red-ui-tabs">').appendTo(form);
                var ulDashboardTabs = $('<ul id="dashboard-tabs-list"></ul>').appendTo(divTab);
                var layout_label = c_("label.layout");
                var site_label = c_("label.site");
                var theme_label = c_("label.theme");
                var angular_label = c_("label.angular");
                var liLayoutTab = $('<li class="red-ui-tab" style="width:70px;"><a class="red-ui-tab-label" title="Layout"><span>'+layout_label+'</span></a></li>').appendTo(ulDashboardTabs);
                var liSiteTab = $('<li class="red-ui-tab" style="width:70px;"><a class="red-ui-tab-label" title="Site" style="width:60px;"><span>'+site_label+'</span></a></li>').appendTo(ulDashboardTabs);
                var liThemeTab = $('<li class="red-ui-tab" style="width:70px;"><a class="red-ui-tab-label" title="Theme" style="width:80px;"><span>'+theme_label+'</span></a></li>').appendTo(ulDashboardTabs);
                var liAngularTab = $('<li class="red-ui-tab" style="width:70px;"><a class="red-ui-tab-label" title="Angular" style="width:80px;"><span>'+angular_label+'</span></a></li>').appendTo(ulDashboardTabs);

                // Link out to dashboard
                $.getJSON('uisettings',function(data) {
                    if (data.hasOwnProperty("path")) { uip = data.path; }
                    var lnk = document.location.host+RED.settings.httpNodeRoot+"/"+uip;
                    var re = new RegExp('\/{1,}','g');
                    lnk = lnk.replace(re,'/');
                    if (!RED.hasOwnProperty("actions")) {
                        RED.keyboard.add("*",/* d */ 68,{ctrl:true, shift:true},function() { window.open(document.location.protocol+"//"+lnk, "nr-dashboard") });
                    }
                    else {
                        RED.actions.add("dashboard:show-dashboard",function() { window.open(document.location.protocol+"//"+lnk, "nr-dashboard") });
                        RED.keyboard.add("*","ctrl-shift-d","dashboard:show-dashboard");
                    }
                    $('<span id="dash-link-button" class="editor-button" style="position:absolute; right:0px;"><i class="fa fa-external-link"></i></span>')
                    .click(function(evt) {
                        window.open(document.location.protocol+"//"+lnk);
                        evt.preventDefault();
                    })
                    .appendTo(ulDashboardTabs);
                });

                // Dashboard Tab containers
                var layoutTab = $('<div id="dashboard-layout" style="height:calc(100% - 48px)">').appendTo(form);
                var siteTab = $('<div id="dashboard-site" style="display:none;">').appendTo(form);
                var themeTab = $('<div id="dashboard-theme" style="display:none;">').appendTo(form);
                var angularTab = $('<div id="dashboard-angular" style="display:none;">').appendTo(form);

                ulDashboardTabs.children().first().addClass("active");

                // Tab logic
                var onTabClick = function() {
                    //Toggle tabs
                    ulDashboardTabs.children().removeClass("active");
                    ulDashboardTabs.children().css({"transition": "width 100ms"});
                    $(this).parent().addClass("active");

                    var selectedTab = $(this)[0].title;
                    if (selectedTab === 'Layout') {
                        themeTab.hide();
                        siteTab.hide();
                        angularTab.hide();
                        layoutTab.show();
                    }
                    else if (selectedTab === 'Angular') {
                        themeTab.hide();
                        siteTab.hide();
                        angularTab.show();
                        layoutTab.hide();
                    }
                    else if (selectedTab === 'Theme') {
                        layoutTab.hide();
                        siteTab.hide();
                        angularTab.hide();
                        themeTab.show();
                        if ($("#nr-db-field-theme option:selected").val() === 'theme-custom') { themeSettingsContainer.show(); }
                        else { themeSettingsContainer.hide(); }
                    }
                    else {
                        layoutTab.hide();
                        themeTab.hide();
                        angularTab.hide();
                        siteTab.show();
                    }
                }

                ulDashboardTabs.find("li.red-ui-tab a").on("click",onTabClick)

                // Site Tab
                var divTitle = $('<div>',{class:"form-row compact"}).appendTo(siteTab);
                $('<div>').html('<b>'+c_("label.title")+'</b>').appendTo(divTitle);
                $('<input type="text" id="nr-db-field-title">').val(site_name).css("width","100%")
                .on("change", function() {
                    if (!globalDashboardNode || globalDashboardNode.site.name !== $(this).val()) {
                        //ensureDashboardNode(true);
                        globalDashboardNode.site.name = $(this).val();
                    }
                    RED.nodes.dirty(true);
                })
                .appendTo(divTitle);

                var divHideToolbar = $('<div>',{class:"form-row compact"}).appendTo(siteTab);
                $('<div>').html('<b>'+c_("label.options")+'</b>').appendTo(divHideToolbar);
                $('<select id="nr-db-field-hideToolbar">')
                .css("width","100%")
                .append($('<option>', { value:"false", text:c_("title-bar.show"), selected:true }))
                .append($('<option>', { value:"true", text:c_("title-bar.hide") }))
                .val("false")
                .on("change", function() {
                    if (!globalDashboardNode || globalDashboardNode.site.hideToolbar !== $(this).val()) {
                        //ensureDashboardNode(true);
                        globalDashboardNode.site.hideToolbar = $(this).val();
                    }
                    RED.nodes.dirty(true);
                })
                .appendTo(divHideToolbar);

                var divLockMenu = $('<div>',{class:"form-row compact"}).appendTo(siteTab);
                $('<select id="nr-db-field-lockMenu">')
                .css("width","100%")
                .append($('<option>', { value:"false", text:c_("lock.clicked"), selected:true }))
                .append($('<option>', { value:"true", text:c_("lock.locked") }))
                .append($('<option>', { value:"icon", text:c_("lock.locked-icon") }))
                .val("false")
                .on("change", function() {
                    if (!globalDashboardNode || globalDashboardNode.site.lockMenu !== $(this).val()) {
                        //ensureDashboardNode(true);
                        globalDashboardNode.site.lockMenu = $(this).val();
                    }
                    RED.nodes.dirty(true);
                })
                .appendTo(divLockMenu);

                var divAllowSwipe = $('<div>',{class:"form-row compact"}).appendTo(siteTab);
                $('<select id="nr-db-field-allowSwipe">')
                .css("width","100%")
                .append($('<option>', { value:"false", text:c_("swipe.no-swipe"), selected:true }))
                .append($('<option>', { value:"true", text:c_("swipe.allow-swipe") }))
                .append($('<option>', { value:"mouse", text:c_("swipe.allow-swipe-mouse") }))
                .append($('<option>', { value:"menu", text:c_("swipe.show-menu") }))
                .val("false")
                .on("change", function() {
                    if (!globalDashboardNode || globalDashboardNode.site.allowSwipe !== $(this).val()) {
                        //ensureDashboardNode(true);
                        globalDashboardNode.site.allowSwipe = $(this).val();
                        RED.nodes.dirty(true);
                    }
                })
                .appendTo(divAllowSwipe);

                var divAllowTempTheme = $('<div>',{class:"form-row compact"}).appendTo(siteTab);
                $('<select id="nr-db-field-allowTempTheme">')
                .css("width","100%")
                .append($('<option>', { value:"true", text:c_("temp.allow-theme"), selected:true }))
                .append($('<option>', { value:"false", text:c_("temp.no-theme") }))
                .append($('<option>', { value:"none", text:c_("temp.none") }))
                .val("true")
                .on("change", function() {
                    if (!globalDashboardNode || globalDashboardNode.site.allowTempTheme !== $(this).val()) {
                        //ensureDashboardNode(true);
                        globalDashboardNode.site.allowTempTheme = $(this).val();
                    }
                    if ($('#nr-db-field-allowTempTheme').val() === "none") {
                        ulDashboardTabs.children().eq(2).addClass("hidden");
                        ulDashboardTabs.children().eq(3).removeClass("hidden");
                    }
                    else {
                        ulDashboardTabs.children().eq(2).removeClass("hidden");
                        ulDashboardTabs.children().eq(3).addClass("hidden");
                    }
                    RED.nodes.dirty(true);
                })
                .appendTo(divAllowTempTheme);

                var site_name = c_("site.title");
                var site_date_format = c_("site.date-format");
                var divDateFormat = $('<div>',{class:"form-row"}).appendTo(siteTab);
                $('<div>').html('<b>'+c_("label.date-format")+'</b>')
                .css("width","80%")
                .css("display","inline-block")
                .appendTo(divDateFormat);
                $('<div>').html("<a href='https://momentjs.com/docs/#/displaying/format/' target='_new'><i class='fa fa-info-circle' style='color:var(--red-ui-secondary-text-color, grey);'></i></a>")
                .css("display","inline-block")
                .css("margin-right","6px")
                .css("float","right")
                .appendTo(divDateFormat);
                $('<input type="text" id="nr-db-field-dateFormat">').val(site_date_format).css("width","100%")
                .on("change", function() {
                    if (!globalDashboardNode || globalDashboardNode.site.dateFormat !== $(this).val()) {
                        //ensureDashboardNode(true);
                        globalDashboardNode.site.dateFormat = $(this).val();
                    }
                    RED.nodes.dirty(true);
                })
                .appendTo(divDateFormat);

                var divSetSizes = $('<div>',{class:"form-row"}).appendTo(siteTab);
                $('<span style="width:45%; display:inline-block">').html('<b>'+c_("label.sizes")+'</b>').appendTo(divSetSizes);
                $('<span style="width:25%; display:inline-block; font-size:smaller">').text(c_("label.horizontal")).appendTo(divSetSizes);
                $('<span style="width:20%; display:inline-block; font-size:smaller">').text(c_("label.vertical")).appendTo(divSetSizes);
                $('<i id="sizes-reset" class="fa fa-undo nr-db-resetIcon"></i>')
                .css({opacity:1.0})
                .click(function(e) {
                    $("#nr-db-field-sx").val(sizes.sx); globalDashboardNode.site.sizes.sx = sizes.sx;
                    $("#nr-db-field-sy").val(sizes.sy); globalDashboardNode.site.sizes.sy = sizes.sy;
                    $("#nr-db-field-px").val(sizes.px); globalDashboardNode.site.sizes.px = sizes.px;
                    $("#nr-db-field-py").val(sizes.py); globalDashboardNode.site.sizes.py = sizes.py;
                    $("#nr-db-field-gx").val(sizes.gx); globalDashboardNode.site.sizes.gx = sizes.gx;
                    $("#nr-db-field-gy").val(sizes.gy); globalDashboardNode.site.sizes.gy = sizes.gy;
                    $("#nr-db-field-cx").val(sizes.cx); globalDashboardNode.site.sizes.cx = sizes.cx;
                    $("#nr-db-field-cy").val(sizes.cy); globalDashboardNode.site.sizes.cy = sizes.cy;
                    RED.nodes.dirty(true);
                })
                .appendTo(divSetSizes);

                $('<br/><span style="width:45%; display:inline-block">').text(c_("label.widget-size")).appendTo(divSetSizes);
                $('<input type="number" name="sx" min="24" id="nr-db-field-sx">').val(48).css("width","20%")
                .on("change", function() {
                    //ensureDashboardNode(true);
                    globalDashboardNode.site.sizes.sx=Number($(this).val()); RED.nodes.dirty(true); } )
                .appendTo(divSetSizes);
                $('<span style="width:5%; display:inline-block">').text(' ').appendTo(divSetSizes);
                $('<input type="number" name="sy" min="24" id="nr-db-field-sy">').val(48).css("width","20%")
                .on("change", function() {
                    //ensureDashboardNode(true);
                    globalDashboardNode.site.sizes.sy=Number($(this).val()); RED.nodes.dirty(true); } )
                .appendTo(divSetSizes);

                $('<br/><span style="width:45%; display:inline-block">').text(c_("label.widget-spacing")).appendTo(divSetSizes);
                $('<input type="number" name="cx" min="0" id="nr-db-field-cx">').val(6).css("width","20%")
                .on("change", function() {
                    //ensureDashboardNode(true);
                    globalDashboardNode.site.sizes.cx=Number($(this).val()); RED.nodes.dirty(true); } )
                .appendTo(divSetSizes);
                $('<span style="width:5%; display:inline-block">').text(' ').appendTo(divSetSizes);
                $('<input type="number" name="cy" min="0" id="nr-db-field-cy">').val(6).css("width","20%")
                .on("change", function() {
                    //ensureDashboardNode(true);
                    globalDashboardNode.site.sizes.cy=Number($(this).val()); RED.nodes.dirty(true); } )
                .appendTo(divSetSizes);

                $('<br/><span style="width:45%; display:inline-block">').text(c_("label.group-padding")).appendTo(divSetSizes);
                $('<input type="number" name="px" min="0" id="nr-db-field-px">').val(0).css("width","20%")
                .on("change", function() {
                    //ensureDashboardNode(true);
                    globalDashboardNode.site.sizes.px=Number($(this).val()); RED.nodes.dirty(true); } )
                .appendTo(divSetSizes);
                $('<span style="width:5%; display:inline-block">').text(' ').appendTo(divSetSizes);
                $('<input type="number" name="py" min="0" id="nr-db-field-py">').val(0).css("width","20%")
                .on("change", function() {
                    //ensureDashboardNode(true);
                    globalDashboardNode.site.sizes.py=Number($(this).val()); RED.nodes.dirty(true); } )
                .appendTo(divSetSizes);

                $('<br/><span style="width:45%; display:inline-block">').text(c_("label.group-spacing")).appendTo(divSetSizes);
                $('<input type="number" name="gx" min="0" id="nr-db-field-gx">').val(6).css("width","20%")
                .on("change", function() {
                    //ensureDashboardNode(true);
                    globalDashboardNode.site.sizes.gx=Number($(this).val()); RED.nodes.dirty(true); } )
                .appendTo(divSetSizes);
                $('<span style="width:5%; display:inline-block">').text(' ').appendTo(divSetSizes);
                $('<input type="number" name="gy" min="0" id="nr-db-field-gy">').val(6).css("width","20%")
                .on("change", function() {
                    //ensureDashboardNode(true);
                    globalDashboardNode.site.sizes.gy=Number($(this).val()); RED.nodes.dirty(true); } )
                .appendTo(divSetSizes);

                // Angular Theme Tab
                var changed = function() {
                    ensureDashboardNode(true);
                    globalDashboardNode.theme.angularTheme = aTheme;
                    RED.nodes.dirty(true);
                }

                var angColorList = ["red", "pink", "purple", "deep-purple", "indigo", "blue", "light-blue", "cyan", "teal", "green", "light-green", "lime", "yellow", "amber", "orange", "deep-orange", "brown", "grey", "blue-grey"];
                var angColors = "";
                angColorList.forEach(function(c) { angColors += '<option value="' + c + '">' + c + '</option>'; });

                var divPrimStyle = $('<div>',{class:"form-row"}).appendTo(angularTab);
                $('<span style="width:45%; display:inline-block">')
                    .html('<b>'+c_("style.primary")+'</b>')
                    .appendTo(divPrimStyle);
                $('<i id="ang-reset" class="fa fa-undo nr-db-resetIcon"></i>')
                    .css({opacity:1.0})
                    .click(function(e) {
                        $("#nr-db-field-angPrimary").val("indigo");
                        globalDashboardNode.theme.angularTheme.primary = "indigo";
                        RED.nodes.dirty(true);
                    })
                    .appendTo(divPrimStyle);
                $('<select id="nr-db-field-angPrimary">'+angColors+'</select>')
                    .css("width","100%")
                    .val(aTheme.primary)
                    .on("change", function() { aTheme.primary = $(this).val(); changed(); })
                    .appendTo(divPrimStyle);

                var divAccStyle = $('<div>',{class:"form-row"}).appendTo(angularTab);
                $('<span style="width:45%; display:inline-block">')
                    .html('<b>'+c_("style.accents")+'</b>')
                    .appendTo(divAccStyle);
                $('<i id="ang-reset" class="fa fa-undo nr-db-resetIcon"></i>')
                    .css({opacity:1.0})
                    .click(function(e) {
                        $("#nr-db-field-angAccents").val("blue");
                        globalDashboardNode.theme.angularTheme.accents = "blue";
                        RED.nodes.dirty(true);
                    })
                    .appendTo(divAccStyle);
                $('<select id="nr-db-field-angAccents">'+angColors+'</select>')
                    .css("width","100%")
                    .val(aTheme.accents)
                    .on("change", function() { aTheme.accents = $(this).val(); changed(); })
                    .appendTo(divAccStyle);

                var divWarnStyle = $('<div>',{class:"form-row"}).appendTo(angularTab);
                $('<span style="width:45%; display:inline-block">')
                    .html('<b>'+c_("style.warnings")+'</b>')
                    .appendTo(divWarnStyle);
                $('<i id="ang-reset" class="fa fa-undo nr-db-resetIcon"></i>')
                    .css({opacity:1.0})
                    .click(function(e) {
                        $("#nr-db-field-angWarn").val("red");
                        globalDashboardNode.theme.angularTheme.warn = "red";
                        RED.nodes.dirty(true);
                    })
                    .appendTo(divWarnStyle);
                $('<select id="nr-db-field-angWarn">'+angColors+'</select>')
                    .css("width","100%")
                    .val(aTheme.warn)
                    .on("change", function() { aTheme.warn = $(this).val(); changed(); })
                    .appendTo(divWarnStyle);

                var divBackStyle = $('<div>',{class:"form-row"}).appendTo(angularTab);
                $('<span style="width:45%; display:inline-block">')
                    .html('<b>'+c_("style.background")+'</b>')
                    .appendTo(divBackStyle);
                $('<i id="ang-reset" class="fa fa-undo nr-db-resetIcon"></i>')
                    .css({opacity:1.0})
                    .click(function(e) {
                        $("#nr-db-field-angBackground").val("grey");
                        globalDashboardNode.theme.angularTheme.background = "grey";
                        RED.nodes.dirty(true);
                    })
                    .appendTo(divBackStyle);
                $('<select id="nr-db-field-angBackground">'+angColors+'</select>')
                    .css("width","100%")
                    .val(aTheme.background)
                    .on("change", function() { aTheme.background = $(this).val(); changed(); })
                    .appendTo(divBackStyle);

                var divPalStyle = $('<div>',{class:"form-row"}).appendTo(angularTab);
                $('<span style="width:45%; display:inline-block">')
                    .html('<b>'+c_("style.palette")+'</b>')
                    .appendTo(divPalStyle);
                var lightdark = '<option value="light">' +c_("style.light")+ '</option>';
                lightdark += '<option value="dark">' +c_("style.dark")+ '</option>';
                $('<select id="nr-db-field-angLook">'+lightdark+'</select>')
                    .css("width","100%")
                    .val(aTheme.palette)
                    .on("change", function() { aTheme.palette = $(this).val(); changed(); })
                    .appendTo(divPalStyle);

                // Theme Tab
                // For all customisable styles, generate and apply the css
                var generateColours = function(base) {
                    var theme = globalDashboardNode.theme.name.split('-')[1];
                    if (!globalDashboardNode.theme.themeState.hasOwnProperty["base-font"]) {
                        if (globalDashboardNode.theme[theme+"Theme"].baseFont === "Helvetica Neue") {
                            globalDashboardNode.theme[theme+"Theme"].baseFont = baseFontName;
                        }
                        globalDashboardNode.theme.themeState["base-font"] = {value:globalDashboardNode.theme[theme+"Theme"].baseFont};
                        $("#nr-db-field-font").val(globalDashboardNode.theme[theme+"Theme"].baseFont);
                    }
                    for (var i=0; i<configurableStyles.length; i++) {
                        var styleID = configurableStyles[i];
                        var underscore = styleID.split("-").join("_");
                        if (!globalDashboardNode.theme.themeState.hasOwnProperty(styleID)) {
                            globalDashboardNode.theme.themeState[styleID] = {value:"#fff",edited:false};
                        }
                        if (!globalDashboardNode.theme.themeState[styleID].edited || globalDashboardNode.theme[theme+'Theme'].reset) {
                            var colour = colours['calculate_'+underscore](base);
                            globalDashboardNode.theme.themeState[styleID].value = colour;
                        }
                        setColourPickerColour(styleID, globalDashboardNode.theme.themeState[styleID].value, globalDashboardNode.theme.themeState[styleID].edited);
                    }
                    globalDashboardNode.theme[theme+'Theme'].reset = false;
                }

                var divThemeStyle = $('<div>',{class:"form-row"}).appendTo(themeTab);
                $('<label class="nr-db-theme-label">').text(c_("theme.style")).appendTo(divThemeStyle);
                var themeSelection = $('<select id="nr-db-field-theme">'+
                    '<option value="theme-light">'+c_("style.light")+'</option>'+
                    '<option value="theme-dark">'+c_("style.dark")+'</option>'+
                    '<option value="theme-custom">'+c_("style.custom")+'</option>'+
                    '</select>')
                .css("width","100%")
                .on("change", function() {
                    if (!globalDashboardNode || globalDashboardNode.theme.name !== $(this).val()) {
                        //ensureDashboardNode(true);
                        var theme = globalDashboardNode.theme.name.split('-')[1];
                        var baseColour = globalDashboardNode.theme[theme+'Theme'].baseColor;
                        var baseFont = globalDashboardNode.theme[theme+'Theme'].baseFont;
                        globalDashboardNode.theme.name = $(this).val();
                        theme = globalDashboardNode.theme.name.split('-')[1];
                        if (theme !== "custom") {
                            baseColour = globalDashboardNode.theme[theme+'Theme'].default;
                        }
                        else { baseColour = globalDashboardNode.theme[theme+'Theme'].baseColor; }
                        setColourPickerColour("base-color", baseColour);
                        globalDashboardNode.theme.themeState['base-color'].value = baseColour;
                        globalDashboardNode.theme.themeState['base-color'].default = baseColour;
                        globalDashboardNode.theme.themeState['base-font'] = {value:baseFont};
                        $("#nr-db-field-font").val(baseFont);
                        globalDashboardNode.theme[theme+'Theme'].reset = true;
                        //generate colours for all colour settings from base colour
                        generateColours(baseColour);
                        RED.nodes.dirty(true);
                    }
                    $('#base-color-reset').remove();
                    if ($(this).val() === 'theme-custom') {
                        $("#custom-theme-library-container").show(); //TODO undo this at some point
                        $("#custom-theme-settings").show();
                        //addResetButton('base-color', baseSettingsUl.children());
                    }
                    else {
                        $("#custom-theme-library-container").hide();
                        $("#custom-theme-settings").hide();
                        addLightAndDarkResetButton('base-color', baseSettingsUl.children().first());
                    }
                })
                .appendTo(divThemeStyle);

                var customThemeLibraryContainer = $('<div id="custom-theme-library-container">').appendTo(themeTab);
                $('<label class="nr-db-theme-label">').text(c_("theme.custom-profile")).appendTo(customThemeLibraryContainer);
                $('<input type="text" id="ui-sidebar-name" style="vertical-align:top;" placeholder="profile name (not blank)">')
                .val(c_("theme.custom-profile-name"))
                .on("change", function() {
                    if (!globalDashboardNode || globalDashboardNode.theme.customTheme.name !== $(this).val()) {
                        //ensureDashboardNode(true);
                        globalDashboardNode.theme.customTheme.name = $(this).val();
                        if (editor) {
                            editor.setValue(JSON.stringify({theme:globalDashboardNode.theme.themeState, site:globalDashboardNode.site}),1);
                            RED.nodes.dirty(true);
                        }
                    }
                })
                .keyup(function() {
                    if ($(this).val().length === 0) {
                        $("#custom-theme-library-container div").css("pointer-events","none");
                    }
                    else { $("#custom-theme-library-container div").css("pointer-events","inherit"); }
                })
                .appendTo(customThemeLibraryContainer);
                $('<input type="hidden" id="nr-db-field-format">').appendTo(customThemeLibraryContainer);
                $('<div style="display:none;" class="node-text-editor" id="nr-db-field-format-editor"></div>').appendTo(customThemeLibraryContainer);

                var baseThemeSettingsContainer = $('<div id="base-theme-settings">').appendTo(themeTab);

                var baseSettings = $('<div>',{class:"form-row"}).appendTo(baseThemeSettingsContainer);
                $('<label class="nr-db-theme-label">').text(c_("theme.base-settings")).appendTo(baseSettings);
                var baseSettingsUl = $('<ul id="base-settings-ul" class="red-ui-dashboard-theme-styles"></ul>').appendTo(baseSettings);

                var baseColourItem = $('<li class="red-ui-dashboard-theme-item"><span>'+c_("base.colour")+'</span></li>').appendTo(baseSettingsUl);
                var spanColorContainer = $('<span class="nr-db-color-pick-container"></span>').appendTo(baseColourItem);

                $('<input id="base-color" class="nr-db-field-themeColor" type="color" value="#ffffff"/>')
                .on("change", function() {
                    //ensureDashboardNode(true);
                    var value = $(this).val();
                    var lightThemeMatch = globalDashboardNode.theme.lightTheme.baseColor === value;
                    var darkThemeMatch = globalDashboardNode.theme.darkTheme.baseColor === value;
                    var customThemeMatch = globalDashboardNode.theme.customTheme.baseColor === value;
                    if (!globalDashboardNode || !lightThemeMatch || !darkThemeMatch || !customThemeMatch) {
                        var theme = globalDashboardNode.theme.name.split('-')[1];
                        globalDashboardNode.theme[theme+'Theme'].baseColor = value;
                        if (globalDashboardNode.theme.name === 'theme-light' || globalDashboardNode.theme.name === 'theme-dark') {
                            //for light and dark themes, reset the colours
                            globalDashboardNode.theme[theme+'Theme'].reset = true;
                        }
                        generateColours(value);
                        editor.setValue(JSON.stringify({theme:globalDashboardNode.theme.themeState, site:globalDashboardNode.site}),1);
                        colourPickerChangeHandler($(this).attr('id'), value);
                    }
                })
                .appendTo(spanColorContainer);

                var baseFontItem = $('<li class="red-ui-dashboard-theme-item"><span>'+c_("base.font")+'</span></li>').appendTo(baseSettingsUl);
                var fontSelector = $('<select id="nr-db-field-font">'+
                    '<option value="'+baseFontName+'" style="font-family:'+baseFontName+'">'+c_("font.system")+'</option>'+
                    '<option value="Arial,Arial,Helvetica,sans-serif" style="font-family:Arial,Arial,Helvetica,sans-serif">Arial</option>'+
                    '<option value="Arial Black,Arial Black,Gadget,sans-serif" style="font-family:Arial Black,Arial Black,Gadget,sans-serif">Arial Black</option>'+
                    '<option value="Arial Narrow,Nimbus Sans L,sans-serif" style="font-family:Arial Narrow,Nimbus Sans L,sans-serif">Arial Narrow</option>'+
                    '<option value="Century Gothic,CenturyGothic,AppleGothic,sans-serif" style="font-family:Century Gothic,CenturyGothic,AppleGothic,sans-serif">Century Gothic</option>'+
                    '<option value="Copperplate,Copperplate Gothic Light,fantasy" style="font-family:Copperplate,Copperplate Gothic Light,fantasy;">Copperplate</option>'+
                    '<option value="Courier,monospace" style="font-family:Courier,monospace;">Courier</option>'+
                    '<option value="Georgia,Georgia,serif" style="font-family:Georgia,Georgia,serif">Georgia</option>'+
                    '<option value="Gill Sans,Geneva,sans-serif" style="font-family:Gill Sans,Geneva,sans-serif;">Gill Sans</option>'+
                    //'<option value="Helvetica Neue,Helvetica,sans-serif" style="font-family:Helvetica Neue,Helvetica,sans-serif">Helvetica Neue</option>'+
                    '<option value="Impact,Impact,Charcoal,sans-serif" style="font-family:Impact,Impact,Charcoal,sans-serif">Impact</option>'+
                    '<option value="Lucida Sans Typewriter,Lucida Console,Monaco,monospace" style="font-family:Lucida Console,Monaco,monospace">Lucida Console</option>'+
                    '<option value="Lucida Sans Unicode,Lucida Grande,sans-serif" style="font-family:Lucida Sans Unicode,Lucida Grande,sans-serif">Lucida Sans</option>'+
                    '<option value="Palatino Linotype,Palatino,Book Antiqua,serif" style="font-family:Palatino Linotype,Palatino,Book Antiqua,serif">Palatino Linotype</option>'+
                    '<option value="Tahoma,Geneva,sans-serif" style="font-family:Tahoma,Geneva,sans-serif">Tahoma</optionstyle="font-family:>'+
                    '<option value="Times New Roman,Times,serif" style="font-family:Times New Roman,Times,serif">Times New Roman</option>'+
                    '<option value="Trebuchet MS,Helvetica,sans-serif" style="font-family:Trebuchet MS,Helvetica,sans-serif">Trebuchet MS</option>'+
                    '<option value="Verdana,Verdana,Geneva,sans-serif" style="font-family:Verdana,Verdana,Geneva,sans-serif">Verdana</option>'+
                    '</select>')
                    .on("change", function() {
                        //ensureDashboardNode(true);
                        var theme = globalDashboardNode.theme.name.split('-')[1];
                        globalDashboardNode.theme[theme+'Theme'].baseFont = $(this).val();
                        globalDashboardNode.theme.themeState['base-font'] = {value:$(this).val()};
                        RED.nodes.dirty(true);
                    })
                    .appendTo(baseFontItem);

                var themeSettingsContainer = $('<div id="custom-theme-settings">').appendTo(themeTab);

                // Markup
                // Page styles
                var divPageStyle = $('<div>',{class:"form-row"}).appendTo(themeSettingsContainer);
                $('<label class="nr-db-theme-label">').text(c_("theme.page-settings")).appendTo(divPageStyle);
                var pageStyles = $('<ul class="red-ui-dashboard-theme-styles"></ul>').appendTo(themeSettingsContainer);
                addCustomisableStyle('page-titlebar-backgroundColor', c_("theme.page.title"), pageStyles);
                addCustomisableStyle('page-backgroundColor', c_("theme.page.page"), pageStyles);
                addCustomisableStyle('page-sidebar-backgroundColor', c_("theme.page.side"), pageStyles);

                // Group styles
                var divGroupStyle = $('<div>',{class:"form-row"}).appendTo(themeSettingsContainer);
                $('<label class="nr-db-theme-label">').text(c_("theme.group-settings")).appendTo(divGroupStyle);
                var groupStyles = $('<ul class="red-ui-dashboard-theme-styles"></ul>').appendTo(themeSettingsContainer);
                addCustomisableStyle('group-textColor', c_("theme.group.text"), groupStyles);
                addCustomisableStyle('group-borderColor', c_("theme.group.border"), groupStyles);
                addCustomisableStyle('group-backgroundColor', c_("theme.group.background"), groupStyles);

                // Widget styles
                var divWidgetStyle = $('<div>',{class:"form-row"}).appendTo(themeSettingsContainer);
                $('<label class="nr-db-theme-label">').text(c_("theme.widget-settings")).appendTo(divWidgetStyle);
                var widgetStyles = $('<ul class="red-ui-dashboard-theme-styles"></ul>').appendTo(themeSettingsContainer);
                addCustomisableStyle('widget-textColor', c_("theme.widget.text"), widgetStyles);
                addCustomisableStyle('widget-backgroundColor', c_("theme.widget.colour"), widgetStyles);
                addCustomisableStyle('widget-borderColor', c_("theme.widget.background"), widgetStyles);

                function addCustomisableStyle(id, name, parentUl) {
                    var styleLi = $('<li class="red-ui-dashboard-theme-item"><span>'+name+'</span></li>').appendTo(parentUl);
                    var spanColorContainer = $('<span class="nr-db-color-pick-container"></span>').appendTo(styleLi);
                    $('<input id="'+id+'" class="nr-db-field-themeColor" type="color" value="#ffffff"/>')
                    .on("change", function() {
                        colourPickerChangeHandler($(this).attr('id'), $(this).val());
                    })
                    .appendTo(spanColorContainer);
                    addResetButton(id, styleLi);
                }

                function colourPickerChangeHandler(id, value) {
                    $("#"+id).css("background-color", value);
                    $("#"+id+"-reset").css({opacity:1});
                    globalDashboardNode.theme.themeState[id].edited = true;
                    globalDashboardNode.theme.themeState[id].value = value;
                    if (editor) {
                        editor.setValue(JSON.stringify({theme:globalDashboardNode.theme.themeState, site:globalDashboardNode.site}),1);
                    }
                    RED.nodes.dirty(true);
                }

                function addResetButton(id, parent) {
                    var resetToDefault = $('<i id="'+id+'-reset" class="fa fa-undo nr-db-resetIcon"></i>')
                    .css({opacity:0.2})
                    .click(function(e) { resetClick(e); })
                    .appendTo(parent);
                }

                function addLightAndDarkResetButton(id, parent) {
                    if ($("#" + id + "-reset").length === 0) {
                        var resetToDefault = $('<i id="'+id+'-reset" class="fa fa-undo nr-db-resetIcon"></i>')
                        .css({opacity:1})
                        .click(function(e) { lightAndDarkResetClick(e); })
                        .appendTo(parent);
                        globalDashboardNode.theme[globalDashboardNode.theme.name.split('-')[1] + 'Theme'].edited = true;
                    }
                }

                function lightAndDarkResetClick(e) {
                    var elementID = e.target.id.split('-reset')[0];
                    var key = globalDashboardNode.theme.name.split('-')[1] + 'Theme';
                    //sanity check - light and dark only allow base-color-reset
                    if (elementID === 'base-color') { // && globalDashboardNode.theme[key].edited) {
                        var defaultColor = globalDashboardNode.theme[key].default;
                        globalDashboardNode.theme[key].reset = true;
                        generateColours(defaultColor);
                        setColourPickerColour(elementID, defaultColor);
                        $("#"+elementID+"-reset").css({opacity:0.2});
                        globalDashboardNode.theme.themeState[elementID].value = defaultColor;
                        globalDashboardNode.theme[key].baseColor = defaultColor;
                        globalDashboardNode.theme[key].edited = false;
                        RED.nodes.dirty(true);
                    }
                }

                function resetClick(e) {
                    //take off -reset
                    var elementID = e.target.id.split('-reset')[0];
                    if (globalDashboardNode.theme.themeState[elementID].edited) {
                        var defaultColor = globalDashboardNode.theme.themeState['base-color'].value;
                        var colour;
                        //set colour
                        if (elementID === 'base-color') {
                            colour = defaultColor;
                            generateColours(colour);
                        }
                        else {
                            var underscore = elementID.split('-').join('_');
                            colour = colours['calculate_'+underscore](defaultColor);
                        }
                        setColourPickerColour(elementID, colour);
                        $("#"+elementID+"-reset").css({opacity:0.2});
                        globalDashboardNode.theme.themeState[elementID].edited = false;
                        globalDashboardNode.theme.themeState[elementID].value = colour;
                        RED.nodes.dirty(true);
                    }
                }

                function setColourPickerColour(id, val, ed) {
                    $("#"+id).val(val);
                    $("#"+id).css("background-color", val);
                    //call mostReadableGreyWhite to set text colour
                    var textColor = colours.whiteGreyMostReadable(val);
                    $("#"+id).css("color", textColor);
                    if (ed === true) { $("#"+id+"-reset").css({opacity:1}); }
                    else { $("#"+id+"-reset").css({opacity:0.2}); }
                }

                //Layout Tab
                var divTabs = $('<div>',{class:"form-row",style:"position:relative"}).appendTo(layoutTab);
                $('<label>').html('<b>'+c_("layout.tab-and-link")+'</b>').appendTo(divTabs);

                var buttonGroup = $('<div>',{class:"nr-db-sb-list-button-group"}).appendTo(divTabs);

                //Toggle expand buttons
                $('<a href="#" class="editor-button editor-button-small nr-db-sb-list-header-button"><i class="fa fa-angle-double-up"></i></a>')
                .click(function(evt) {
                    tabContainer.find(".nr-db-sb-group-list-container").slideUp().addClass('nr-db-sb-collapsed');
                    tabContainer.find(".nr-db-sb-tab-list-header>.nr-db-sb-list-chevron").css({"transform":"rotate(-90deg)"});
                    evt.preventDefault();
                })
                .appendTo(buttonGroup);
                $('<a href="#" class="editor-button editor-button-small nr-db-sb-list-header-button"><i class="fa fa-angle-double-down"></i></a>')
                .click(function(evt) {
                    tabContainer.find(".nr-db-sb-group-list-container").slideDown().removeClass('nr-db-sb-collapsed');
                    tabContainer.find(".nr-db-sb-tab-list-header>.nr-db-sb-list-chevron").css({"transform":""});
                    evt.preventDefault();
                })
                .appendTo(buttonGroup);

                //Add item button
                $('<a href="#" class="editor-button editor-button-small nr-db-sb-list-header-button"><i class="fa fa-plus"></i> '+c_("layout.tab")+'</a>')
                .click(function(evt) {
                    tabContainer.editableList('addItem',{type: 'ui_tab'});
                    evt.preventDefault();
                })
                .appendTo(buttonGroup);
                $('<a href="#" class="editor-button editor-button-small nr-db-sb-list-header-button"><i class="fa fa-plus"></i> '+c_("layout.link")+'</a>')
                .click(function(evt) {
                    tabContainer.editableList('addItem',{type: 'ui_link'});
                    evt.preventDefault();
                })
                .appendTo(buttonGroup);

                var tabLists = {};
                var groupLists = {};

                // toggle slide tab group content
                var titleToggle = function (id,content,chevron) {
                    return function(evt) {
                        if (content.is(":visible")) {
                            content.slideUp();
                            chevron.css({"transform":"rotate(-90deg)"});
                            content.addClass('nr-db-sb-collapsed');
                            listStates[id] = false;
                        }
                        else {
                            content.slideDown();
                            chevron.css({"transform":""});
                            content.removeClass('nr-db-sb-collapsed');
                            listStates[id] = true;
                        }
                    };
                }

                var addTabOrLinkItem = function(container,i,item) {
                    ensureDashboardNode(true);
                    // create node if needed
                    if (!item.node) {
                        var defaultItem = {
                            'ui_tab': {
                                _def: RED.nodes.getType('ui_tab'),
                                type: 'ui_tab',
                                users: [],
                                icon: 'dashboard',
                                name: 'Tab'
                            },
                            'ui_link': {
                                _def: RED.nodes.getType('ui_link'),
                                type: 'ui_link',
                                users: [],
                                icon: 'open_in_browser',
                                name: 'Link',
                                target: 'newtab'
                            }
                        }
                        item.node = defaultItem[item.type]
                        item.node.id = RED.nodes.id()
                        item.node.order = i+1
                        item.node.name += ' '+item.node.order
                        listElements[item.node.id] = container;
                        if (item.type === 'ui_tab') {
                            item.groups = [];
                        }
                        RED.nodes.add(item.node);
                        RED.editor.validateNode(item.node);
                        RED.history.push({
                            t:'add',
                            nodes:[item.node.id],
                            dirty:RED.nodes.dirty()
                        });
                        RED.nodes.dirty(true);
                    }
                    else if (item.type === undefined) {
                        item.type = item.node.type
                    }

                    listElements[item.node.id] = container;
                    if (RED.nodes.hasOwnProperty('updateConfigNodeUsers')) {
                        RED.nodes.updateConfigNodeUsers(item.node);
                    }

                    // title
                    var titleRow = $('<div>',{class:"nr-db-sb-list-header nr-db-sb-tab-list-header"}).appendTo(container);
                    switch (item.type) {
                        case 'ui_tab': {
                            container.addClass("nr-db-sb-tab-list-item");
                            $('<i class="nr-db-sb-list-handle nr-db-sb-tab-list-handle fa fa-bars"></i>').appendTo(titleRow);
                            var chevron = $('<i class="fa fa-angle-down nr-db-sb-list-chevron">',{style:"width:10px;"}).appendTo(titleRow);
                            var tabicon = "fa-object-group";
                            //var tabicon = item.node.disabled ? "fa-window-close-o" : item.node.hidden ? "fa-eye-slash" : "fa-object-group";
                            $('<i>',{class:"nr-db-sb-icon nr-db-sb-tab-icon fa "+tabicon}).appendTo(titleRow);
                            var tabhide = item.node.hidden ? " nr-db-sb-title-hidden" : "";
                            var tabable = item.node.disabled ? " nr-db-sb-title-disabled" : "";
                            $('<span>',{class:"nr-db-sb-title"+tabhide+tabable}).text(item.node.name||"").appendTo(titleRow);
                            break;
                        }
                        case 'ui_link': {
                            $('<i class="nr-db-sb-list-handle fa fa-bars"></i>').appendTo(titleRow);
                            var title = $('<div class="nr-db-sb-link">').appendTo(titleRow);
                            var nameContainer = $('<div class="nr-db-sb-link-name-container">').appendTo(title);
                            $('<i class="fa fa-external-link"></i>').appendTo(nameContainer);
                            $('<span class="nr-db-sb-link-name">').text(item.node.name||"untitled").appendTo(nameContainer);
                            $('<div class="nr-db-sb-link-url">').text(item.node.link||"http://").appendTo(title);
                            break;
                        }
                    }
                    // buttons
                    var buttonGroup = $('<div>',{class:"nr-db-sb-list-header-button-group",id: item.node.id}).appendTo(titleRow);
                    if (item.type === 'ui_tab') {
                        var addGroupButton = $('<a href="#" class="nr-db-sb-tab-add-group-button editor-button editor-button-small nr-db-sb-list-header-button" ><i class="fa fa-plus"></i> '+c_("layout.group")+'</a>').appendTo(buttonGroup);
                    }
                    var editButton = $('<a href="#" class="nr-db-sb-tab-edit-button editor-button  editor-button-small nr-db-sb-list-header-button"><i class="fa fa-pencil"></i> '+c_("layout.edit")+'</a>').appendTo(buttonGroup);
                    editButton.on('click',function(evt) {
                        if (isLocked(item.node.id)) {
                            evt.stopPropagation();
                            evt.preventDefault();
                            notifyLocked();
                            return;
                        }
                        RED.editor.editConfig("", item.type, item.node.id);
                        evt.stopPropagation();
                        evt.preventDefault();
                    });

                    // Dashboard layout tool
                    if (item.type === 'ui_tab') {
                        var layoutButton = $('<a href="#" class="nr-db-sb-tab-edit-layout-button editor-button editor-button-small nr-db-sb-list-header-button"><i class="fa fa-pencil"></i> '+c_("layout.layout")+'</a>').appendTo(buttonGroup);
                        layoutButton.on('click',function(evt) {
                            if (isLocked(item.node.id)) {
                                evt.stopPropagation();
                                evt.preventDefault();
                                notifyLocked();
                                return;
                            }
                            var editTabName = item.node.name ? item.node.name : item.node.id;
                            var trayOptions = {
                                title: c_("layout.layout-editor") + " : " + editTabName,
                                width: Infinity,
                                buttons: [
                                    {
                                        id: "node-dialog-cancel",
                                        text: RED._("common.label.cancel"),
                                        click: function() {
                                            // clean editor
                                            RED.tray.close();
                                        }
                                    },
                                    {
                                        id: "node-dialog-ok",
                                        text: RED._("common.label.done"),
                                        class: "primary",
                                        click: function() {
                                            // Save data after editing
                                            saveGridDatas();
                                            RED.tray.close();
                                        }
                                    }
                                ],
                                resize: function(dimensions) {},
                                open: function(tray) {
                                    // Get widget of specified tab from node information
                                    tabDatas = getTabDataFromNodes(item.node.id);
                                    // The width that can be handled by Layout is up to MAX_GROUP_WIDTH
                                    // Groups exceeding the maximum width are not supported.
                                    var tmpGroups = tabDatas.groups;
                                    tmpGroups.sort(compareOrder);
                                    var groups = [];
                                    for (var cnt = 0; cnt < tmpGroups.length; cnt++) {
                                        if (tmpGroups[cnt].width <= MAX_GROUP_WIDTH) {
                                            groups.push(tmpGroups[cnt]);
                                        }
                                    }
                                    tabDatas.groups = groups;

                                    var editor = $('<div></div>',{addClass: 'nr-dashboard-layout-container-fluid'});
                                    var row =  $('<div></div>',{addClass: 'nr-dashboard-layout-row'});
                                    var span_num = Math.floor(12 / groups.length); // bootstrap grid 12 splits
                                    span_num = span_num < 2 ? 2 : span_num; // max 6 groups per row
                                    for (var cnt = 0; cnt < groups.length; cnt++) {
                                        if (cnt !=0 && (cnt % 6) == 0) {
                                            editor.append(row);
                                            editor.append('<div><br></div>');
                                            row = $('<div></div>',{addClass: 'nr-dashboard-layout-row'});
                                        }
                                        var span = $('<div></div>',{addClass: 'nr-dashboard-layout-span' + span_num});
                                        var groupName = groups[cnt].name ? groups[cnt].name : groups[cnt].id;
                                        var title = $('<div></div>', {
                                            style: "margin-top:2px; margin-bottom:2px;"
                                        });
                                        var title_group = $('<div></div>', {
                                            title: groupName,
                                            style: "margin-left:4px; margin-right:8px; overflow:hidden;"
                                        }).appendTo(title);
                                        $("<b/>").text(groupName).appendTo(title_group);
                                        var title_width = $('<div></div>', {
                                            style: "text-align:right; margin-right:8px;"
                                        }).appendTo(title);
                                        $("<span/>", {
                                            style: "margin_right: 8px;"
                                        }).text(c_("layout.width")+': ').appendTo(title_width);
                                        var changeWidth = $('<input>', {
                                            id: 'change-width' + cnt,
                                            value: groups[cnt].width,
                                            style: 'width:30px;',
                                            readonly: true,
                                            'node-id': groups[cnt].id,
                                        });
                                        title_width.append(changeWidth);

                                        title.css('white-space','nowrap');
                                        title.css('overflow','hidden');
                                        var gridstack = $('<div></div>', {
                                            id: 'grid'+cnt,
                                            addClass: 'grid-stack'
                                        });
                                        span.append(title);
                                        span.append(gridstack);
                                        row.append(span);
                                    }
                                    if (groups.length != 0) {
                                        editor.append(row);
                                    }

                                    // Show layout editor in tray
                                    var trayBody = tray.find('.red-ui-tray-body, .editor-tray-body');
                                    trayBody.css('overflow','auto');
                                    trayBody.append(editor);

                                    /////////////////////////////////////////
                                    // Editor screen generation
                                    /////////////////////////////////////////
                                    oldSpacer = [];
                                    widthChange = [];
                                    widgetResize = [];
                                    widgetDrag = [];
                                    for (var cnt=0; cnt < groups.length; cnt++) {
                                        // Gridstack.js option
                                        var options = {
                                            acceptWidgets: true,
                                            alwaysShowResizeHandle: true,
                                            cellHeight: 42,
                                            disableOneColumnMode : true,
                                            float: true,
                                            verticalMargin: 1
                                        };
                                        var gridID='#grid' + cnt;
                                        // gridstack generation
                                        $(gridID).gridstack(options);

                                        // Clear the contents of Grid
                                        var grid = $(gridID+'.grid-stack').data('gridstack');
                                        grid.removeAll();
                                        $(gridID).on("dropped", handleMove(grid));

                                        // Set the width of the display area of gridstack
                                        var groupWidth = Number(groups[cnt].width);
                                        $(gridID+'.grid-stack').css("width", groupWidth * 40);
                                        $(gridID+'.grid-stack').css("background-size", 100/groupWidth+"% 43px");
                                        $(gridID+'.grid-stack').attr("node-id", groups[cnt].id);
                                        $(gridID+'.grid-stack').attr("grid-column", groups[cnt].width);
                                        grid.setColumn(groupWidth, true);

                                        // Determination of placement position of widget of Grid
                                        var widgets = groups[cnt].widgets;
                                        widgets.sort(compareOrder);

                                        var tbl = {};
                                        for (var cnt2 = 0; cnt2 < widgets.length; cnt2++) {
                                            // Set default value when there is auto width
                                            if (widgets[cnt2].auto == true) {
                                                widgets[cnt2].width = groupWidth;
                                            // Adjust to the group width
                                            } else if (widgets[cnt2].width > groupWidth) {
                                                widgets[cnt2].width = groupWidth;
                                            }
                                            // Auto support
                                            if (widgets[cnt2].auto === true || widgets[cnt2].type === 'ui_form') {
                                                widgets[cnt2].height = getDefaultHeight(widgets[cnt2].id, groupWidth);
                                            }
                                            // Calculate coordinates to be placed
                                            var point = search_point(Number(widgets[cnt2].width), Number(widgets[cnt2].height), groupWidth, 256, tbl);
                                            if (point) {
                                                widgets[cnt2].x = point.x;
                                                widgets[cnt2].y = point.y;
                                            }
                                        }

                                        var items = GridStackUI.Utils.sort(widgets);
                                        items.forEach(function (node) {
                                            var minHeight = null;
                                            var maxHeight = null;
                                            // ui_form is fixed to height 2
                                            if (node.type === 'ui_form') {
                                                minHeight = node.height;
                                                maxHeight = node.height;
                                            }
                                            if (node.type !== 'ui_spacer') {
                                                var dispNode = RED.nodes.node(node.id);
                                                var dispType = dispNode._def.paletteLabel;
                                                var dispLabel = dispNode._def.label;
                                                try {
                                                    dispLabel = (typeof dispLabel === "function" ? dispLabel.call(dispNode) : dispLabel)||"";
                                                }
                                                catch(err) {
                                                    console.log("Definition error: " + node.type + ".label",err);
                                                    dispLabel = dispType;
                                                }

                                                var item = $('<div></div>', {
                                                    'data-noderedtype': node.type,
                                                    'data-noderedid': node.id,
                                                    'data-nodereddisptype': dispType,
                                                    'data-nodereddisplabel': dispLabel,
                                                    'data-noderedsizeauto': node.auto
                                                });
                                                var itemContent = $('<div></div>', {
                                                    addClass: 'grid-stack-item-content',
                                                    title: dispLabel + ':' + dispType
                                                });

                                                if (node.auto === true) {
                                                    itemContent.append('<i class="fa fa-unlock nr-dashboard-layout-resize-enable" title="'+c_("layout.auto")+'"></i>');
                                                } else {
                                                    itemContent.append('<i class="fa fa-lock nr-dashboard-layout-resize-disable" title="'+c_("layout.manual")+'"></i>');
                                                }
                                                itemContent.append('<b>'+ dispLabel +'</b><br/>'+ dispType);
                                                item.append(itemContent);
                                                grid.addWidget(
                                                    item,
                                                    node.x, node.y, node.width, node.height, false, null, null,
                                                    minHeight, maxHeight, node.id);
                                            } else {
                                                // Record the spacer node ID to be deleted
                                                oldSpacer.push(node.id);
                                            }
                                        });

                                        $(gridID+'.grid-stack > .grid-stack-item:visible').each( function(idx, el) {
                                            el = $(el);
                                            var node = el.data('_gridstack_node');
                                            var auto = (el[0].dataset.noderedsizeauto == 'true') ? true : false;
                                            grid.resizable(el, !auto);
                                        });

                                        // Group width change
                                        widthChange.push(new changeGroupWidth(cnt));
                                        // Resize widget in group (start event)
                                        widgetResize.push(new resizeGroupWidget(cnt));
                                        // Dragging widgets in a group (start event)
                                        widgetDrag.push(new dragGroupWidget(cnt));
                                    }
                                    $('.grid-stack>.grid-stack-item>.grid-stack-item-content>.nr-dashboard-layout-resize-disable').on('click',layoutResizeDisable);
                                    $('.grid-stack>.grid-stack-item>.grid-stack-item-content>.nr-dashboard-layout-resize-enable').on('click',layoutResizeEnable);
                                },
                                close: function() {},
                                show: function() {}
                            };
                            RED.tray.show(trayOptions);
                            evt.stopPropagation();
                            evt.preventDefault();
                        });
                    }

                    if (item.type === 'ui_tab') {
                        var content = $('<div>',{class:"nr-db-sb-group-list-container"}).appendTo(container);

                        // ui_tab group chevron
                        if (listStates.hasOwnProperty(item.node.id) && !listStates[item.node.id]) {
                            content.hide();
                            chevron.css({"transform":"rotate(-90deg)"});
                            content.addClass('nr-db-sb-collapsed');
                            listStates[item.node.id] = false;
                        }
                        else {
                            listStates[item.node.id] = true;
                        }
                        titleRow.click(titleToggle(item.node.id,content,chevron));

                        // ui_tab group list
                        var ol = $('<ol>',{class:"nr-db-sb-group-list"}).appendTo(content).editableList({
                            sortable:".nr-db-sb-group-list-header",
                            addButton: false,
                            height: 'auto',
                            connectWith: ".nr-db-sb-group-list",
                            addItem: function(container,i,group) {
                                if (!group.node) {
                                    group.node = {
                                        id: RED.nodes.id(),
                                        _def: RED.nodes.getType("ui_group"),
                                        type: "ui_group",
                                        users: [],
                                        tab: item.node.id,
                                        order: i+1,
                                        name: "Group "+(i+1),
                                        width: 6,
                                        disp: true
                                    };
                                    listElements[group.node.id] = container;
                                    RED.nodes.add(group.node);
                                    RED.editor.validateNode(group.node);
                                    group.widgets = [];
                                    RED.history.push({
                                        t:'add',
                                        nodes:[group.node.id],
                                        dirty:RED.nodes.dirty()
                                    });
                                    RED.nodes.dirty(true);
                                    if (RED.nodes.hasOwnProperty('updateConfigNodeUsers')) {
                                        RED.nodes.updateConfigNodeUsers(group.node);
                                    }
                                }
                                else {
                                    if (group.node.order === undefined) {
                                        group.node.order = i+1;
                                    }
                                }
                                var groupNode = group.node;
                                elementParents[groupNode] = item.node.id;
                                var titleRow = $('<div>',{class:"nr-db-sb-list-header nr-db-sb-group-list-header"}).appendTo(container);
                                $('<i class="nr-db-sb-list-handle nr-db-sb-group-list-handle fa fa-bars"></i>').appendTo(titleRow);
                                var chevron = $('<i class="fa fa-angle-down nr-db-sb-list-chevron">',{style:"width:10px;"}).appendTo(titleRow);
                                $('<i class="nr-db-sb-icon nr-db-sb-group-icon fa fa-table"></i>').appendTo(titleRow);
                                var title = $('<span class="nr-db-sb-title">').text(groupNode.name||groupNode.id||"").appendTo(titleRow);
                                listElements[groupNode.id] = container;
                                var buttonGroup = $('<div>',{class:"nr-db-sb-list-header-button-group",id:groupNode.id}).appendTo(titleRow);
                                var spacerButton = $('<a href="#" class="editor-button editor-button-small nr-db-sb-list-header-button"><i class="fa fa-plus"></i> '+c_("layout.spacer")+'</a>').appendTo(buttonGroup);
                                spacerButton.on('click',function(evt) {
                                    if (isLocked(item.node.id)) {
                                        evt.stopPropagation();
                                        evt.preventDefault();
                                        notifyLocked();
                                        return;
                                    }
                                    var spaceNode = {
                                        _def: RED.nodes.getType("ui_spacer"),
                                        type: "ui_spacer",
                                        hasUsers: false,
                                        users: [],
                                        id: RED.nodes.id(),
                                        tab: item.node.name,
                                        group: group.node.id,
                                        order: i+1,
                                        name: "spacer",
                                        width: 1,
                                        height:1,
                                        z: RED.workspaces.active(),
                                        label: function() { return "spacer " + this.width + "x" + this.height; }
                                    };
                                    RED.nodes.add(spaceNode);
                                    RED.editor.validateNode(spaceNode);
                                    RED.history.push({
                                        t:'add',
                                        nodes:[spaceNode.id],
                                        dirty:RED.nodes.dirty()
                                    });
                                    RED.nodes.dirty(true);
                                    RED.view.redraw();
                                    evt.stopPropagation();
                                    evt.preventDefault();
                                });
                                var editButton = $('<a href="#" class="nr-db-sb-edit-group-button editor-button editor-button-small nr-db-sb-list-header-button"><i class="fa fa-pencil"></i> '+c_("layout.edit")+'</a>').appendTo(buttonGroup);
                                var content = $('<div>',{class:"nr-db-sb-widget-list-container"}).appendTo(container);
                                if (!listStates.hasOwnProperty(groupNode.id) || !listStates[groupNode.id]) {
                                    content.hide();
                                    chevron.css({"transform":"rotate(-90deg)"});
                                    content.addClass('nr-db-sb-collapsed');
                                    listStates[groupNode.id] = false;
                                }
                                else {
                                    listStates[groupNode.id] = true;
                                }

                                var ol = $('<ol>',{class:"nr-db-sb-widget-list"}).appendTo(content).editableList({
                                    sortable:".nr-db-sb-widget-list-header",
                                    addButton: false,
                                    height: 'auto',
                                    connectWith: ".nr-db-sb-widget-list",
                                    addItem: function(container,i,widgetNode) {
                                        elementParents[widgetNode.id] = groupNode.id;
                                        var titleRow = $('<div>',{class:"nr-db-sb-list-header nr-db-sb-widget-list-header"}).appendTo(container);
                                        $('<i class="nr-db-sb-list-handle nr-db-sb-widget-list-handle fa fa-bars"></i>').appendTo(titleRow);
                                        $('<i class="nr-db-sb-icon nr-db-sb-widget-icon fa fa-picture-o"></i>').click(function(e) { e.preventDefault(); RED.search.show(widgetNode.id); }).appendTo(titleRow);
                                        var l = widgetNode._def.label;
                                        try {
                                            l = (typeof l === "function" ? l.call(widgetNode) : l)||"";
                                        }
                                        catch(err) {
                                            console.log("Definition error: "+d.type+".label",err);
                                            l = d.type;
                                        }
                                        var title = $('<span class="nr-db-sb-title">').text(l).appendTo(titleRow);
                                        listElements[widgetNode.id] = container;
                                        var buttonGroup = $('<div>',{class:"nr-db-sb-list-header-button-group"}).appendTo(titleRow);
                                            var editButton = $('<a href="#" class="editor-button editor-button-small nr-db-sb-list-header-button"><i class="fa fa-pencil"></i> '+c_("layout.edit")+'</a>').appendTo(buttonGroup);
                                            container.on('mouseover',function() {
                                            widgetNode.highlighted = true;
                                            widgetNode.dirty = true;
                                            RED.view.redraw();
                                        });
                                        container.on('mouseout',function() {
                                            widgetNode.highlighted = false;
                                            widgetNode.dirty = true;
                                            RED.view.redraw();
                                        });
                                        editButton.on('click',function(evt) {
                                            if (isLockedTab(widgetNode.z)) {
                                                evt.stopPropagation();
                                                evt.preventDefault();
                                                notifyLocked();
                                                return;
                                            }
                                            RED.editor.edit(widgetNode);
                                            evt.stopPropagation();
                                            evt.preventDefault();
                                        });
                                    },
                                    sortItems: function(items) {
                                        if (isLocked(item.node.id)) {
                                            $(ol).editableList("cancel");
                                            notifyLocked();
                                            return;
                                        }
                                        var historyEvents = [];
                                        items.each(function(i,el) {
                                            var node = el.data('data');
                                            var hev = {
                                                t:'edit',
                                                node:node,
                                                changes:{
                                                    order:node.order,
                                                    group:node.group
                                                },
                                                dirty:node.dirty,
                                                changed:node.changed
                                            };
                                            historyEvents.push(hev);
                                            var changed = false;
                                            if (node.order !== i+1) {
                                                node.order = i+1;
                                                changed = true;
                                            }
                                            if (node.group !== group.node.id) {
                                                var oldGroupNode = RED.nodes.node(node.group);
                                                if (oldGroupNode) {
                                                    var index = oldGroupNode.users.indexOf(node);
                                                    oldGroupNode.users.splice(index,1);
                                                }
                                                node.group = group.node.id;
                                                group.node.users.push(node);
                                                changed = true;
                                            }
                                            if (changed) {
                                                node.dirty = true;
                                                node.changed = true;
                                            }
                                        })
                                        RED.history.push({
                                            t:'multi',
                                            events: historyEvents
                                        });
                                        RED.nodes.dirty(true);
                                        RED.view.redraw();
                                    }
                                });
                                ol.css("min-height","5px");
                                if (groupNode.id) {
                                    groupLists[groupNode.id] = ol;
                                }
                                titleRow.click(titleToggle(groupNode.id,content,chevron));
                                editButton.on('click',function(evt) {
                                    if (isLocked(item.node.id)) {
                                        evt.stopPropagation();
                                        evt.preventDefault();
                                        notifyLocked();
                                        return;
                                    }
                                    RED.editor.editConfig("", groupNode.type, groupNode.id);
                                    evt.stopPropagation();
                                    evt.preventDefault();
                                });
                                group.widgets.forEach(function(widget) {
                                    ol.editableList('addItem',widget);
                                })
                            },
                            sortItems: function(items) {
                                var historyEvents = [];
                                items.each(function(i,el) {
                                    var groupData = el.data('data');
                                    var node = groupData.node;
                                    var hev = {
                                        t:'edit',
                                        node:node,
                                        changes:{
                                            order:node.order,
                                            tab:node.tab
                                        },
                                        dirty:node.dirty,
                                        changed:node.changed
                                    };
                                    historyEvents.push(hev);
                                    var changed = false;
                                    if (node.order !== i+1) {
                                        node.order = i+1;
                                        changed = true;
                                    }
                                    if (changed) {
                                        node.dirty = true;
                                        node.changed = true;
                                    }
                                    if (node.tab !== item.node.id) {
                                        var oldTabNode = RED.nodes.node(node.tab);
                                        if (oldTabNode) {
                                            var index = oldTabNode.users.indexOf(node);
                                            oldTabNode.users.splice(index,1);
                                        }
                                        node.tab = item.node.id;
                                        item.node.users.push(node);
                                        changed = true;
                                    }
                                })
                                RED.history.push({
                                    t:'multi',
                                    events: historyEvents
                                });
                                RED.nodes.dirty(true);
                                RED.view.redraw();
                            }
                        })
                        tabLists[item.node.id] = ol;

                        addGroupButton.click(function(evt) {
                            if (isLocked(item.node.id)) {
                                evt.stopPropagation();
                                evt.preventDefault();
                                notifyLocked();
                                return;
                            }
                            ol.editableList('addItem',{});
                            evt.stopPropagation();
                            evt.preventDefault();
                        });
                        item.groups.forEach(function(group) {
                            ol.editableList('addItem',group);
                        });
                    }
                }

                var tabContainer = $('<ol>',{class:"nr-db-sb-tab-list"}).appendTo(divTabs).editableList({
                    sortable:".nr-db-sb-tab-list-header",
                    addButton: false,
                    addItem: addTabOrLinkItem,
                    sortItems: function(items) {
                        var historyEvents = [];
                        items.each(function(i,el) {
                            var itemData = el.data('data');
                            var node = itemData.node;
                            var hev = {
                                t:'edit',
                                node:node,
                                changes:{
                                    order:node.order
                                },
                                dirty:node.dirty,
                                changed:node.changed
                            }
                            historyEvents.push(hev);
                            var changed = false;
                            if (node.order !== i+1) {
                                node.order = i+1;
                                changed = true;
                            }
                            if (changed) {
                                node.dirty = true;
                                node.changed = true;
                            }
                        })
                        RED.history.push({
                            t:'multi',
                            events: historyEvents
                        });
                        RED.nodes.dirty(true);
                        RED.view.redraw();
                    }
                });

                var orphanedWidgets = $('<div>',{class:"form-row"}).appendTo(layoutTab);
                $('<span><i class="fa fa-info-circle"></i> There <span id="nr-db-missing-group-count"></span> not in a group. Click <a id="nr-db-add-missing-groups" href="#">here</a> to create the missing groups</span>').appendTo(orphanedWidgets);
                orphanedWidgets.find('a').click(function(event) {
                    var unknownGroups = {};
                    RED.nodes.eachNode(function(node) {
                        if (/^ui_/.test(node.type) && node.type !== 'ui_link' && node.type !== 'ui_toast' && node.type !== 'ui_ui_control') {
                            if (!RED.nodes.node(node.group)) {
                                var g = node.group || "_BLANK_";
                                unknownGroups[g] = unknownGroups[g] || [];
                                unknownGroups[g].push(node);
                            }
                        }
                    });
                    var tab = null;
                    var tabs = tabContainer.editableList('items');
                    tabs.first().each(function(i,el) {
                        var tabData = el.data('data');
                        tab = tabData.node;
                    });

                    var hev = [];
                    if (tab === null) {
                        tab = {
                            id: RED.nodes.id(),
                            _def: RED.nodes.getType("ui_tab"),
                            type: "ui_tab",
                            users: [],
                            order: 0,
                            name: "Tab",
                            icon: "dashboard"
                        };
                        RED.nodes.add(tab);
                        RED.editor.validateNode(tab);
                        hev.push(tab.id);
                    }
                    for (var groupId in unknownGroups) {
                        if (unknownGroups.hasOwnProperty(groupId)) {
                            var groupNode = {
                                id: RED.nodes.id(),
                                _def: RED.nodes.getType("ui_group"),
                                type: "ui_group",
                                users: [],
                                tab: tab.id,
                                order: i+1,
                                name: (groupId==="_BLANK_"?"Group":groupId),
                                width: 6,
                                disp: true
                            };
                            hev.push(groupNode.id);
                            RED.nodes.add(groupNode);
                            RED.editor.validateNode(groupNode);
                            if (RED.nodes.hasOwnProperty('updateConfigNodeUsers')) {
                                RED.nodes.updateConfigNodeUsers(groupNode);
                            }
                            var widgets = unknownGroups[groupId];
                            for (var i=0; i<widgets.length; i++) {
                                widgets[i].group = groupNode.id;
                                widgets[i].changed = true;
                                widgets[i].dirty = true;
                                if (RED.nodes.hasOwnProperty('updateConfigNodeUsers')) {
                                    RED.nodes.updateConfigNodeUsers(widgets[i]);
                                }
                                RED.editor.validateNode(widgets[i]);
                            }
                        }
                    }
                    RED.history.push({
                        t:'add',
                        nodes: hev,
                        dirty:RED.nodes.dirty()
                    });
                    RED.nodes.dirty(true);
                    refresh();
                    refreshOrphanedWidgets();
                    RED.view.redraw();
                    event.preventDefault();
                });

                var listElements = {};
                var dashboard = [];
                var listStates = {};
                var elementParents = {};
                var awaitingGroups = {};
                var awaitingTabs = {};

                function getCurrentList() {
                    var currentList = [];
                    var tabs = tabContainer.editableList('items');
                    var open = false;
                    tabs.each(function(i,el) {
                        var tabData = el.data('data');
                        var tab = [];
                        var groups = el.find('.nr-db-sb-group-list').editableList('items');
                        groups.each(function(j,el) {
                            var group = [];
                            var groupData = el.data('data');
                            var widgets = el.find('.nr-db-sb-widget-list').editableList('items');
                            widgets.each(function(k,el) {
                                var widgetData = el.data('data');
                                group.push(widgetData.id);
                            })
                            tab.push({id:groupData.node.id, widgets:group});
                        });
                        currentList.push({id:tabData.node.id,groups:tab});
                    });
                    return currentList;
                }

                function refreshOrphanedWidgets() {
                    var unknownGroups = {};
                    var count = 0;
                    RED.nodes.eachNode(function(node) {
                        if (/^ui_/.test(node.type) && node.type !== 'ui_link' && node.type !== 'ui_toast' && node.type !== 'ui_ui_control' && (node.type === 'ui_template' && node.templateScope !== 'global')) {
                            if (!RED.nodes.node(node.group)) {
                                var g = node.group || "_BLANK_";
                                unknownGroups[g] = unknownGroups[g] || [];
                                unknownGroups[g].push(node);
                                count++;
                            }
                        }
                    });

                    if (count > 0) {
                        orphanedWidgets.show();
                        $("#nr-db-missing-group-count").text((count===1?"is ":"are ")+count+" widget"+(count === 1?"":"s"))
                    }
                    else {
                        orphanedWidgets.hide();
                    }
                }

                function refresh() {
                    var currentList = getCurrentList();
                    dashboard = [];
                    var tabs = {};
                    var groups = {};
                    var elements = [];
                    var groupElements = {};
                    var tabGroups = {};
                    var groupId;
                    var group;
                    var tabId;
                    var tab;
                    var unknownGroups = 0;
                    // Find all the tabs and groups
                    RED.nodes.eachConfig(function(node) {
                        switch (node.type) {
                            case 'ui_tab':
                            case 'ui_link': {
                                tabs[node.id] = node;
                                //tabContainer.editableList('addItem',node);
                                break;
                            }
                            case 'ui_group': {
                                groups[node.id] = node;
                                break;
                            }
                            case 'ui_spacer': {
                                if (groups.hasOwnProperty(node.group)) {
                                    groupElements[node.group] = groupElements[node.group]||[];
                                    groupElements[node.group].push(node);
                                }
                                break;
                            }
                        }
                    });
                    for (groupId in groups) {
                        if (groups.hasOwnProperty(groupId)) {
                            group = groups[groupId];
                            if (tabs.hasOwnProperty(group.tab)) {
                                // This group belongs to a tab
                                tabGroups[group.tab] = tabGroups[group.tab]||[];
                                tabGroups[group.tab].push(group);
                            }
                            else {
                                unknownGroups++;
                            }
                        }
                    }
                    // Find all ui widgets - list them by their group id
                    RED.nodes.eachNode(function(node) {
                        if (/^ui_/.test(node.type)) {
                            if (groups.hasOwnProperty(node.group)) {
                                groupElements[node.group] = groupElements[node.group]||[];
                                groupElements[node.group].push(node);
                            }
                            else if ((node.type !== 'ui_toast')&&(node.type !== 'ui_ui_control')&&(node.type === 'ui_template' && node.templateScope !== 'global')) {
                                unknownGroups++;
                            }
                        }
                    });
                    if (unknownGroups > 0) {
                        $("#nr-db-missing-group-count").text((unknownGroups===1?"is ":"are ")+unknownGroups+" widget"+(unknownGroups === 1?"":"s"))
                        orphanedWidgets.show();
                    }
                    else {
                        orphanedWidgets.hide();
                    }
                    // Sort each group's array of widgets
                    for (groupId in groupElements) {
                        if (groupElements.hasOwnProperty(groupId)) {
                            group = groupElements[groupId];
                            groupElements[groupId] = group.map(function(v,i) { return {n:v,i:i} }).sort(function(A,B) {
                                if (A.n.order < B.n.order) { return A.n.order!==0?-1:1;}
                                if (A.n.order > B.n.order) { return B.n.order!==0?1:-1;}
                                return A.i - B.i;
                            }).map(function(v) { return v.n})
                        }
                    }
                    // Sort each tabs's array of groups
                    for (tabId in tabGroups) {
                        if (tabGroups.hasOwnProperty(tabId)) {
                            tab = tabGroups[tabId];
                            tabGroups[tabId] = tab.map(function(v,i) { return {n:v,i:i} }).sort(function(A,B) {
                                if (A.n.order < B.n.order) { return -1;}
                                if (A.n.order > B.n.order) { return 1;}
                                return A.i - B.i;
                            }).map(function(v) { return v.n})
                        }
                    }
                    var tabIds = Object.keys(tabs).map(function(v,i) { return {n:tabs[v],i:i} }).sort(function(A,B) {
                        if (A.n.order < B.n.order) { return -1;}
                        if (A.n.order > B.n.order) { return 1;}
                        return A.i - B.i;
                    }).map(function(v) { return v.n.id});
                    tabIds.forEach(function(tabId) {
                        var tab = {node:tabs[tabId],groups:[]};
                        if (tabGroups[tabId]) {
                            tabGroups[tabId].forEach(function(groupNode) {
                                var group = {node:groupNode,widgets:[]};
                                if (groupElements[groupNode.id]) {
                                    group.widgets = groupElements[groupNode.id];
                                }
                                tab.groups.push(group);
                            });
                        }
                        dashboard.push(tab);
                    });
                    var newList = dashboard.map(function(t) {
                        return {
                            id: t.node.id,
                            groups: t.groups.map(function(g) {
                                return {
                                    id: g.node.id,
                                    widgets: g.widgets.map(function(w) {
                                        return w.id;
                                    })
                                }
                            })
                        }
                    });
                    if (JSON.stringify(newList)!=JSON.stringify(currentList)) {
                        listElements = {};
                        groupLists = {};
                        tabLists = {};
                        tabs = {};
                        groups = {};
                        elementParents = {};
                        tabContainer.empty();
                        dashboard.forEach(function(tab) {
                            tabContainer.editableList('addItem',tab);
                        });
                    }
                    //ensureDashboardNode(true);
                    if (globalDashboardNode) {
                        $("#nr-db-field-title").val(globalDashboardNode.site.name);
                        $("#nr-db-field-allowSwipe").val(globalDashboardNode.site.allowSwipe || "false");
                        $("#nr-db-field-allowTempTheme").val(globalDashboardNode.site.allowTempTheme || "true");
                        $("#nr-db-field-hideToolbar").val(globalDashboardNode.site.hideToolbar || "false");
                        $("#nr-db-field-dateFormat").val(globalDashboardNode.site.dateFormat);

                        if (typeof globalDashboardNode.site.sizes !== "object") {
                            globalDashboardNode.site.sizes = sizes;
                        }
                        $("#nr-db-field-sx").val(globalDashboardNode.site.sizes.sx);
                        $("#nr-db-field-sy").val(globalDashboardNode.site.sizes.sy);
                        $("#nr-db-field-px").val(globalDashboardNode.site.sizes.px);
                        $("#nr-db-field-py").val(globalDashboardNode.site.sizes.py);
                        $("#nr-db-field-cx").val(globalDashboardNode.site.sizes.cx);
                        $("#nr-db-field-cy").val(globalDashboardNode.site.sizes.cy);
                        $("#nr-db-field-gx").val(globalDashboardNode.site.sizes.gx);
                        $("#nr-db-field-gy").val(globalDashboardNode.site.sizes.gy);

                        if (typeof globalDashboardNode.theme.angularTheme !== "object") {
                            globalDashboardNode.theme.angularTheme = aTheme;
                        }
                        $("#nr-db-field-angPrimary").val(globalDashboardNode.theme.angularTheme.primary || "indigo");
                        $("#nr-db-field-angAccents").val(globalDashboardNode.theme.angularTheme.accents || "blue");
                        $("#nr-db-field-angWarn").val(globalDashboardNode.theme.angularTheme.warn || "red");
                        $("#nr-db-field-angBackground").val(globalDashboardNode.theme.angularTheme.background || "grey");
                        $("#nr-db-field-angLook").val(globalDashboardNode.theme.angularTheme.palette || "light");

                        $("#nr-db-field-theme").val(globalDashboardNode.theme.name);
                        $("#ui-sidebar-name").val(globalDashboardNode.theme.customTheme.name);
                        if (globalDashboardNode.theme.name === 'theme-custom') {
                            $("#custom-theme-library-container").show();
                            $("#custom-theme-settings").show();
                        }
                        else {
                            $("#custom-theme-library-container").hide();
                            $("#custom-theme-settings").hide();
                        }
                        if ($('#nr-db-field-allowTempTheme').val() === "none") {
                            ulDashboardTabs.children().eq(2).addClass("hidden");
                            ulDashboardTabs.children().eq(3).removeClass("hidden");
                        }
                        else {
                            ulDashboardTabs.children().eq(2).removeClass("hidden");
                            ulDashboardTabs.children().eq(3).addClass("hidden");
                        }

                        //set colour start
                        if (typeof globalDashboardNode.theme.name !== "string") {
                            globalDashboardNode.theme.name = "theme-light";
                        }
                        var currentTheme = globalDashboardNode.theme.name.split("-")[1];
                        var startingValue = globalDashboardNode.theme[currentTheme+"Theme"].baseColor;
                        setColourPickerColour("base-color", startingValue);
                        $("#nr-db-field-font").val(globalDashboardNode.theme[currentTheme+"Theme"].baseFont);
                        generateColours(startingValue);
                        if (globalDashboardNode.theme.name === 'theme-light' || globalDashboardNode.theme.name === 'theme-dark') {
                            addLightAndDarkResetButton('base-color', $('#base-settings-ul').children().first());
                        }

                        if (editor === undefined) {
                            editor = RED.editor.createEditor({
                                id: 'nr-db-field-format-editor',
                                mode: 'ace/mode/javascript',
                                value: JSON.stringify({theme:globalDashboardNode.theme.themeState, site:globalDashboardNode.site})
                            });

                            RED.library.create({
                                url:"themes", // where to get the data from
                                type:"theme", // the type of object the library is for
                                editor: editor, // the field name the main text body goes to
                                mode:"ace/mode/javascript",
                                fields:['name'],
                                elementPrefix:"ui-sidebar-"
                            });
                        }

                        editor.on('input', function() {
                            // Check for any changes on the editor object
                            // i.e. has the theme been customised compared
                            // to what is stored
                            var editorObject = JSON.parse(editor.getValue());

                            //Update theme object if necessary
                            if (JSON.stringify(editorObject.theme) !== JSON.stringify(globalDashboardNode.theme.themeState)) {
                                globalDashboardNode.theme.themeState = editorObject.theme;
                                if ($("#ui-sidebar-name").val() !== globalDashboardNode.theme.customTheme.name) {
                                    globalDashboardNode.theme.customTheme.name = $("#ui-sidebar-name").val();
                                    globalDashboardNode.theme.customTheme.baseColor = globalDashboardNode.theme.themeState["base-color"].value;
                                    setColourPickerColour("base-color", globalDashboardNode.theme.customTheme.baseColor);
                                    generateColours(globalDashboardNode.theme.themeState["base-color"].value);
                                    RED.nodes.dirty(true);
                                }
                            }
                            if (JSON.stringify(aTheme) !== JSON.stringify(globalDashboardNode.theme.angularTheme)) {
                                globalDashboardNode.theme.angularTheme = aTheme;
                            }

                            //Update site object if necessary
                            if (JSON.stringify(editorObject.site) !== JSON.stringify(globalDashboardNode.site)) {
                                globalDashboardNode.site = editorObject.site;
                                $("#nr-db-field-title").val(globalDashboardNode.site.name);
                                $("#nr-db-field-hideToolbar").val(globalDashboardNode.site.hideToolbar);
                                $("#nr-db-field-allowSwipe").val(globalDashboardNode.site.allowSwipe);
                                $("#nr-db-field-allowTempTheme").val(globalDashboardNode.site.allowTempTheme);
                                $("#nr-db-field-dateFormat").val(globalDashboardNode.site.dateFormat);
                                $("#nr-db-field-sx").val(globalDashboardNode.site.sizes.sx);
                                $("#nr-db-field-sy").val(globalDashboardNode.site.sizes.sy);
                                $("#nr-db-field-px").val(globalDashboardNode.site.sizes.px);
                                $("#nr-db-field-py").val(globalDashboardNode.site.sizes.py);
                                $("#nr-db-field-gx").val(globalDashboardNode.site.sizes.gx);
                                $("#nr-db-field-gy").val(globalDashboardNode.site.sizes.gy);
                                $("#nr-db-field-cx").val(globalDashboardNode.site.sizes.cx);
                                $("#nr-db-field-cy").val(globalDashboardNode.site.sizes.cy);
                                RED.nodes.dirty(true);
                            }
                        });
                    }
                    awaitingGroups = {};
                    awaitingTabs = {};
                }

                RED.sidebar.addTab({
                    id: "dashboard",
                    label: c_("label.dashboard"),
                    name: "Dashboard",
                    content: content,
                    closeable: true,
                    pinned: true,
                    iconClass: "fa fa-bar-chart",
                    disableOnEdit: true,
                    onchange: function() { refresh(); }
                });

                editSaveEventHandler = function(node) {
                    if (/^ui_/.test(node.type)) {
                        if (node.type === "ui_tab" || node.type === "ui_group") {
                            if (listElements[node.id]) {
                                // Existing element
                                listElements[node.id].children(".nr-db-sb-list-header").find(".nr-db-sb-title").text(node.name||node.id);
                                if (node.type === "ui_group") {
                                    refresh();
                                }
                                else {
                                    if (node.hidden === true) { listElements[node.id].children(".nr-db-sb-list-header").find(".nr-db-sb-title").addClass('nr-db-sb-title-hidden'); }
                                    else { listElements[node.id].children(".nr-db-sb-list-header").find(".nr-db-sb-title").removeClass('nr-db-sb-title-hidden'); }
                                    if (node.disabled === true) { listElements[node.id].children(".nr-db-sb-list-header").find(".nr-db-sb-title").addClass('nr-db-sb-title-disabled'); }
                                    else { listElements[node.id].children(".nr-db-sb-list-header").find(".nr-db-sb-title").removeClass('nr-db-sb-title-disabled'); }
                                }
                            }
                            else if (node.type === "ui_tab") {
                                // Adding a tab
                                tabContainer.editableList('addItem',{node:node,groups:[]})
                            }
                            else {
                                // Adding a group
                                if (tabLists[node.tab]) {
                                    tabLists[node.tab].editableList('addItem',{node:node,widgets:[]})
                                }
                            }
                        }
                        else if (node.type === "ui_link") {
                            if (listElements[node.id]) {
                                var container = listElements[node.id];
                                container.find(".nr-db-sb-link-name").text(node.name||"untitled");
                                container.find(".nr-db-sb-link-url").text(node.link);
                            }
                        }
                        else {
                            refreshOrphanedWidgets();
                            if (listElements[node.id]) {
                                if (node.group != elementParents[node.id]) {
                                    // Moved to a different group
                                    if (groupLists[elementParents[node.id]]) {
                                        groupLists[elementParents[node.id]].editableList('removeItem',listElements[node.id].data('data'))
                                    }
                                    if (groupLists[node.group]) {
                                        groupLists[node.group].editableList('removeItem',node)
                                        groupLists[node.group].editableList('addItem',node);
                                    }
                                }
                                else {
                                    var l = node._def.label;
                                    try {
                                        l = (typeof l === "function" ? l.call(node) : l)||"";
                                    }
                                    catch(err) {
                                        console.log("Definition error: "+d.type+".label",err);
                                        l = d.type;
                                    }
                                    listElements[node.id].children(".nr-db-sb-list-header").find(".nr-db-sb-title").text(l);
                                }
                            }
                            else {
                                if (groupLists[node.group]) {
                                    if (node.order === 0) { node.order = groupLists[node.group].editableList('length'); }
                                    groupLists[node.group].editableList('addItem',node);
                                }
                            }
                        }
                    }
                };
                RED.events.on("editor:save",editSaveEventHandler);

                // Dashboard layout tool
                layoutUpdateEventHandler = function(node) {
                    if (/^ui_/.test(node.type) && node.type !== 'ui_link' && node.type !== 'ui_toast' && node.type !== 'ui_ui_control' && node.type !== 'ui_audio' && node.type !== 'ui_base' && node.type !== 'ui_group' && node.type !== 'ui_tab') {
                        if (listElements[node.id]) {
                            if (node.group != elementParents[node.id]) {
                                // Moved to a different group
                                if (groupLists[elementParents[node.id]]) {
                                    groupLists[elementParents[node.id]].editableList('removeItem',listElements[node.id].data('data'))
                                }
                                if (groupLists[node.group]) {
                                    groupLists[node.group].editableList('removeItem',node)
                                    groupLists[node.group].editableList('addItem',node);
                                    groupLists[node.group].editableList('sort',function(a,b) {return a.order-b.order;});
                                }
                            }
                            else {
                                groupLists[node.group].editableList('sort',function(a,b) {return a.order-b.order;});
                            }
                        }
                    }
                };
                RED.events.on("layout:update",layoutUpdateEventHandler);

                var pendingAdd = [];
                var pendingAddTimer = null;

                function handlePendingAdds() {
                    var hasTabs = false;
                    var hasGroups = false;
                    pendingAdd.sort(function(A,B) {
                        hasTabs = hasTabs || A.type === "ui_tab" || B.type === "ui_tab";
                        hasGroups = hasGroups || A.type === "ui_group" || B.type === "ui_group";
                        if (A.type === B.type) {
                            return 0;
                        }
                        if (A.type === "ui_tab") {
                            return -1;
                        }
                        else if (B.type === "ui_tab") {
                            return 1;
                        }
                        else if (A.type === "ui_group") {
                            return -1;
                        }
                        else if (B.type === "ui_group") {
                            return 1;
                        }
                        return 0
                    });
                    var updateList = {};
                    for (var i=0; i<pendingAdd.length; i++) {
                        var node = pendingAdd[i];
                        if (listElements[node.id]) {
                            continue;
                        }
                        if (node.type === "ui_tab") {
                            tabContainer.editableList('addItem',{node:node,groups:[]});
                        }
                        else {
                            if (hasTabs) {
                                // We've added some tabs, need to give jquery time to add the lists
                                pendingAdd = pendingAdd.slice(i);
                                pendingAddTimer = setTimeout(handlePendingAdds,50);
                                return;
                            }
                            if (node.type === "ui_group") {
                                if (tabLists[node.tab]) {
                                    tabLists[node.tab].editableList('addItem',{node:node,widgets:[]});
                                }
                            }
                            else {
                                if (hasGroups) {
                                    // We've added some tabs, need to give jquery time to add the lists
                                    pendingAdd = pendingAdd.slice(i);
                                    pendingAddTimer = setTimeout(handlePendingAdds,50);
                                    return;
                                }
                                if (groupLists[node.group]) {
                                    groupLists[node.group].editableList('addItem',node)
                                    if (node.order >= 0) {
                                        updateList[node.group] = true;
                                    }
                                }
                                else {
                                    refreshOrphanedWidgets();
                                }
                            }
                        }
                    }
                    Object.keys(updateList).forEach(function (group) {
                        var list = groupLists[group];
                        if (list) {
                            list.editableList("sort", function(a,b) {return a.order-b.order;});
                        }
                    });
                    pendingAdd = [];
                }

                nodesAddEventHandler = function(node) {
                    if (/^ui_/.test(node.type) && !listElements[node.id]) {
                        pendingAdd.push(node);
                        clearTimeout(pendingAddTimer);
                        pendingAddTimer = setTimeout(handlePendingAdds,100);
                    }
                };
                RED.events.on("nodes:add", nodesAddEventHandler);

                nodesRemoveEventHandler = function(node) {
                    if (/^ui_/.test(node.type)) {
                        if (node.type === "ui_tab" || node.type === "ui_link") {
                            if (listElements[node.id]) {
                                tabContainer.editableList('removeItem',listElements[node.id].data('data'));
                                delete tabLists[node.id];
                            }
                        }
                        else if (node.type === "ui_group") {
                            if (tabLists[node.tab] && listElements[node.id]) {
                                tabLists[node.tab].editableList('removeItem',listElements[node.id].data('data'));
                            }
                            delete groupLists[node.id];
                        }
                        else {
                            if (groupLists[node.group]) {
                                groupLists[node.group].editableList('removeItem',node)
                            }
                        }
                        refreshOrphanedWidgets();
                        delete listElements[node.id];
                    }
                };
                RED.events.on("nodes:remove", nodesRemoveEventHandler);
            }
        });

    $.widget("nodereddashboard.elementSizerByNum", {
        _create: function() {
            var that = this;
            var has_height = this.options.has_height;
            var pos = this.options.pos;
            var c_width = has_height ? '15%' : '6%';
            var container = $('<div>').css({
                position: 'absolute',
                background: 'var(--red-ui-secondary-background, white)',
                padding: '10px 10px 10px 10px',
                border: '1px solid var(--red-ui-primary-border-color, grey)',
                zIndex: '20',
                borderRadius: "4px",
                display:"none",
                width: c_width
            }).appendTo(document.body);
            var box0 = $("<div>").css({
                fontSize: '13px',
                color: 'var(--red-ui-tertiary-text-color, #aaa)',
                float: 'left',
                paddingTop: '1px'
            }).appendTo(container);

            var width = $(this.options.width).val();
            var height = has_height ? $(this.options.height).val() : undefined;
            var max_w = '';
            var groupNode = this.options.groupNode;
            if(groupNode) {
                max_w = 'max="'+groupNode.width+'"';
            }
            width = (width > 0) ? width : 1;
            height = (height > 0) ? height : 1;
            var in0 = $('<input type="number" min="1" '+max_w+'>')
                .css("width", has_height ? "40%" : "100%")
                .val(width)
                .appendTo(box0);
            if(has_height) {
                var pad = $('<span>')
                    .text(" x ")
                    .appendTo(box0);
                var in1 = $('<input type="number" min="1">')
                    .css("width", "40%")
                    .val(height)
                    .appendTo(box0);
            }
            var closeTimer;
            var closeFunc = function() {
                var w = in0.val();
                var h = has_height ? in1.val() : undefined;
                var label = that.options.label;
                label.text(w+(has_height ? (' x '+h) : ''));
                $(that.options.width).val(w).change();
                if(has_height) {
                    $(that.options.height).val(h).change();
                }
                that.destroy();
            };
            container.keypress(function(e) {
                if(e.which === 13) { // pressed ENTER
                    container.fadeOut(100, closeFunc);
                }
            });
            container.on('mouseleave', function(e) {
                closeTimer = setTimeout(function() {
                    container.fadeOut(200, closeFunc);
                }, 100);
            });
            container.on('mouseenter', function(e) {
                clearTimeout(closeTimer);
            });
            container.css({
                top: (pos.top -10)+"px",
                left: (pos.left +10)+"px"
            });
            container.fadeIn(200);
        }
    });

    $.widget( "nodereddashboard.elementSizer", {
        _create: function() {
            var that = this;
            var gridWidth = 6;
            var width = parseInt($(this.options.width).val()||0);
            var height = parseInt(this.options.hasOwnProperty('height')?$(this.options.height).val():"1")||0;
            var hasAuto = (!this.options.hasOwnProperty('auto') || this.options.auto);

            this.element.css({
                minWidth: this.element.height()+4
            });
            var auto_text = c_("auto");
            var sizeLabel = (width === 0 && height === 0)?auto_text:width+(this.options.hasOwnProperty('height')?" x "+height:"");
            this.element.text(sizeLabel).on('mousedown',function(evt) {
                evt.stopPropagation();
                evt.preventDefault();

                var width = parseInt($(that.options.width).val()||0);
                var height = parseInt(that.options.hasOwnProperty('height')?$(that.options.height).val():"1")||0;
                var maxWidth = 0;
                var maxHeight;
                var fixedWidth = false;
                var fixedHeight = false;
                var group = $(that.options.group).val();
                if (group) {
                    var groupNode = RED.nodes.node(group);
                    if (groupNode) {
                        gridWidth = Math.max(6,groupNode.width,+width);
                        maxWidth = groupNode.width || gridWidth;
                        fixedWidth = true;
                    }
                    maxHeight = Math.max(6,+height+1);
                }
                else {
                    gridWidth = Math.max(12,+width);
                    maxWidth = gridWidth;
                    maxHeight = 1;
                    fixedHeight = true;
                }

                var pos = $(this).offset();
                var container = $('<div>').css({
                    position: 'absolute',
                    background: 'var(--red-ui-secondary-background, white)',
                    padding: '5px 10px 10px 10px',
                    border: '1px solid var(--red-ui-primary-border-color, grey)',
                    zIndex: '20',
                    borderRadius: "4px",
                    display:"none"
                }).appendTo(document.body);

                var closeTimer;
                container.on('mouseleave',function(evt) {
                    closeTimer = setTimeout(function() {
                        container.fadeOut(200, function() { $(this).remove(); });
                    },100)
                });
                container.on('mouseenter',function() {
                    clearTimeout(closeTimer);
                })

                var label = $("<div>").css({
                    fontSize: '13px',
                    color: 'var(--red-ui-tertiary-text-color, #aaa)',
                    float: 'left',
                    paddingTop: '1px'
                }).appendTo(container).text((width === 0 && height === 0)?auto_text:(width+(that.options.hasOwnProperty('height')?" x "+height:"")));
                label.hover(function() {
                    $(this).css('text-decoration', 'underline');
                }, function() {
                    $(this).css('text-decoration', 'none');
                });

                label.click(function(e) {
                    var group = $(that.options.group).val();
                    var groupNode = null;
                    if(group) {
                        groupNode = RED.nodes.node(group);
                        if(groupNode === null) {
                            return;
                        }
                    }
                    $(that).elementSizerByNum({
                        width: that.options.width,
                        height: that.options.height,
                        groupNode: groupNode,
                        pos: pos,
                        label: that.element,
                        has_height: that.options.hasOwnProperty('height')
                    });
                    closeTimer = setTimeout(function() {
                        container.fadeOut(200, function() {
                            $(this).remove();
                        });
                    },100)
                });

                var buttonRow = $('<div>',{style:"text-align:right; height:25px;"}).appendTo(container);

                if (hasAuto) {
                    var button = $('<a>',{href:"#",class:"editor-button editor-button-small",style:"margin-bottom:5px"})
                    .text(auto_text)
                    .appendTo(buttonRow)
                    .on('mouseup',function(evt) {
                        that.element.text(auto_text)
                        $(that.options.width).val(0).change();
                        $(that.options.height).val(0).change();
                        evt.preventDefault();
                        container.fadeOut(200, function() { $(this).remove(); });
                    });
                }

                var cellBorder = "1px dashed var(--red-ui-secondary-border-color, lightGray)";
                var cellBorderExisting = "1px solid gray";
                var cellBorderHighlight = "1px dashed var(--red-ui-primary-border-color, black)";
                var rows = [];
                function addRow(i) {
                    var row = $('<div>').css({padding:0,margin:0,height:"25px","box-sizing":"border-box"}).appendTo(container);
                    rows.push(row);
                    cells.push([])
                    for (var j=0; j<gridWidth; j++) {
                        addCell(i,j);
                    }
                }
                function addCell(i,j) {
                    var row = rows[i];
                    var cell = $('<div>').css({
                        display:"inline-block",
                        width: "25px",
                        height: "25px",
                        borderRight: (j===(width-1)&&i<height)?cellBorderExisting:cellBorder,
                        borderBottom: (i===(height-1)&&j<width)?cellBorderExisting:cellBorder,
                        boxSizing: "border-box",
                        cursor:"pointer",
                        background: (j<maxWidth)?"var(--red-ui-secondary-background, #fff)" : "var(--red-ui-node-background-placeholder, #eee)"
                    }).appendTo(row);
                    cells[i].push(cell);
                    if (j===0) {
                        cell.css({borderLeft:((i<=height-1)?cellBorderExisting:cellBorder)});
                    }
                    if (i===0) {
                        cell.css({borderTop:((j<=width-1)?cellBorderExisting:cellBorder)});
                    }
                    if (j<maxWidth) {
                        cell.data("w",j);
                        cell.data("h",i);
                        cell.on("mouseup",function() {
                            that.element.text(($(this).data("w")+1)+(that.options.hasOwnProperty('height')?" x "+($(this).data("h")+1):""))
                            $(that.options.width).val($(this).data("w")+1).change();
                            $(that.options.height).val($(this).data("h")+1).change();
                            container.fadeOut(200, function() { $(this).remove(); });
                        });
                        cell.on("mouseover",function() {
                            var w = $(this).data("w");
                            var h = $(this).data("h");
                            label.text((w+1)+(that.options.hasOwnProperty('height')?" x "+(h+1):""));
                            for (var y = 0; y<maxHeight; y++) {
                                for (var x = 0; x<maxWidth; x++) {
                                    cells[y][x].css({
                                        background: (y<=h && x<=w)?'var(--red-ui-secondary-background-selected, #ddd)' : 'var(--red-ui-secondary-background, #fff)',
                                        borderLeft: (x===0&&y<=h)?cellBorderHighlight:(x===0)?((y<=height-1)?cellBorderExisting:cellBorder):'',
                                        borderTop: (y===0&&x<=w)?cellBorderHighlight:(y===0)?((x<=width-1)?cellBorderExisting:cellBorder):'',
                                        borderRight: (x===w&&y<=h)?cellBorderHighlight:((x===width-1&&y<=height-1)?cellBorderExisting:cellBorder),
                                        borderBottom: (y===h&&x<=w)?cellBorderHighlight:((y===height-1&&x<=width-1)?cellBorderExisting:cellBorder)
                                    })
                                }
                            }
                            if (!fixedHeight && h === maxHeight-1) {
                                addRow(maxHeight++)
                            }
                            if (!fixedWidth && w === maxWidth-1) {
                                maxWidth++;
                                gridWidth++;
                                for (var r=0; r<maxHeight; r++) {
                                    addCell(r,maxWidth-1);
                                }
                            }
                        })
                    }
                }
                var cells = [];
                for (var i=0; i<maxHeight; i++) {
                    addRow(i);
                }
                container.css({
                    top:(pos.top)+"px",
                    left:(pos.left)+"px"
                });
                container.fadeIn(200);
            })
        }
    });
})(jQuery);
</script>

<script type="text/html" data-template-name="ui_base">
    <div class='form-row'>
        This <i>ui_base</i> node is the main node that all<br/>other dashboard widget nodes communicate to.<br/>
        <br/>One instance is required to support the dashboard.<br/>
        <br/>If you have no dashboard you can delete this node.<br/>
        It will be re-created automatically if required.<br/>
    </div>
</script>
<script type="text/html" data-help-name="ui_base">
</script>

<!-- --- [red-module:node-red-dashboard/ui_button] --- -->
<script type="text/javascript">
    RED.nodes.registerType('ui_button',{
        category: RED._("node-red-dashboard/ui_base:ui_base.label.category"),
        color: 'rgb(176, 223, 227)',
        defaults: {
            name: {value: ''},
            group: {type: 'ui_group', required: true},
            order: {value: 0},
            width: {value: 0, validate: function(v) {
                    var width = v||0;
                    var currentGroup = $('#node-input-group').val()||this.group;
                    var groupNode = RED.nodes.node(currentGroup);
                    var valid = !groupNode || +width <= +groupNode.width;
                    $("#node-input-size").toggleClass("input-error",!valid);
                    return valid;
                }
            },
            height: {value: 0},
            passthru: {value: false},
            label: {value: 'button'},
            tooltip: {value: ''},
            color: {value: ''},
            bgcolor: {value: ''},
            className: {value: ''},
            icon: {value: ''},
            payload: {value: '',validate: (RED.validators.hasOwnProperty('typedInput')?RED.validators.typedInput('payloadType'):function(v) { return true})},
            payloadType: { value: 'str'},
            topic:  {value: 'topic', validate: (RED.validators.hasOwnProperty('typedInput')?RED.validators.typedInput('topicType'):function(v) { return true})},
            topicType: {value: 'msg'}
        },
        inputs:1,
        outputs:1,
        outputLabels: function() { if (this.payloadType === "str") {
            return this.payload;
        } else {return this.payloadType; } },
        icon: "ui_button.png",
        paletteLabel: 'button',
        label: function() { return this.name || (~this.label.indexOf("{{") ? null : this.label) || 'button'; },
        labelStyle: function() { return this.name?"node_label_italic":""; },
        oneditprepare: function() {
            $("#node-input-size").elementSizer({
                width: "#node-input-width",
                height: "#node-input-height",
                group: "#node-input-group"
            });
            $('#node-input-payload').typedInput({
                default: 'str',
                typeField: $("#node-input-payloadType"),
                types: ['str','num','bool','json','bin','date','flow','global']
            });
            $('#node-input-topic').typedInput({
                default: 'str',
                typeField: $("#node-input-topicType"),
                types: ['str','msg','flow','global']
            });
        }
    });
</script>

<script type="text/html" data-template-name="ui_button">
	<div class="form-row">
        <label for="node-input-group"><i class="fa fa-table"></i> <span data-i18n="ui_button.label.group"></label>
        <input type="text" id="node-input-group">
    </div>
    <div class="form-row">
        <label><i class="fa fa-object-group"></i> <span data-i18n="ui_button.label.size"></label>
        <input type="hidden" id="node-input-width">
        <input type="hidden" id="node-input-height">
        <button class="editor-button" id="node-input-size"></button>
    </div>
    <div class="form-row">
        <label for="node-input-icon"><i class="fa fa-picture-o"></i> <span data-i18n="ui_button.label.icon"></label>
        <input type="text" id="node-input-icon" data-i18n="[placeholder]ui_button.label.optionalIcon">
    </div>
    <div class="form-row">
        <label for="node-input-label"><i class="fa fa-i-cursor"></i> <span data-i18n="ui_button.label.label"></label>
        <input type="text" id="node-input-label" data-i18n="[placeholder]ui_button.label.optionalLabel">
    </div>
    <div class="form-row">
        <label for="node-input-tooltip"><i class="fa fa-info-circle"></i> <span data-i18n="ui_button.label.tooltip"></label>
        <input type="text" id="node-input-tooltip" data-i18n="[placeholder]ui_button.label.optionalTooltip">
    </div>
    <div class="form-row">
        <label for="node-input-color"><i class="fa fa-tint"></i> <span data-i18n="ui_button.label.color"></label>
        <input type="text" id="node-input-color" data-i18n="[placeholder]ui_button.label.optionalColor">
    </div>
    <div class="form-row">
        <label for="node-input-bgcolor"><i class="fa fa-tint"></i>  <span data-i18n="ui_button.label.background"></label>
        <input type="text" id="node-input-bgcolor" data-i18n="[placeholder]ui_button.label.optionalBackgroundColor">
    </div>
    <div class="form-row">
        <label style="width:auto" for="node-input-payload"><i class="fa fa-envelope-o"></i> <span data-i18n="ui_button.label.whenClicked"></label>
    </div>
    <div class="form-row">
        <label for="node-input-payload" style="padding-left: 25px; margin-right: -25px"><span data-i18n="ui_button.label.payload"></label>
        <input type="text" id="node-input-payload" style="width:70%">
        <input type="hidden" id="node-input-payloadType">
    </div>
    <div class="form-row">
        <label for="node-input-topic" style="padding-left: 25px; margin-right: -25px"><span data-i18n="ui_button.label.topic"></label>
        <input type="text" id="node-input-topic">
        <input type="hidden" id="node-input-topicType">
    </div>
    <div class="form-row">
        <label style="width:auto" for="node-input-passthru"><i class="fa fa-arrow-right"></i> <span data-i18n="ui_button.label.emulateClick"></label>
        <input type="checkbox" id="node-input-passthru" style="display:inline-block; width:auto; vertical-align:top;">
    </div>
    <div class="form-row">
        <label for="node-input-className"><i class="fa fa-code"></i>  <span data-i18n="ui_button.label.className"></label>
        <input type="text" id="node-input-className" data-i18n="[placeholder]ui_button.label.classNamePlaceholder"/>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="node-red:common.label.name"></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]node-red:common.label.name">
    </div>
</script>
<script type="text/html" data-help-name="ui_button">
    <p>Adds a button to the user interface.</p>
    <p>Clicking the button generates a message with <code>msg.payload</code> set to the <b>Payload</b> field.
    If no payload is specified, the node id is used.</p>
	<p>The <b>Size</b> defaults to  3 by 1.</p>
    <p>The <b>Icon</b> can be defined, as either a <a href="https://klarsys.github.io/angular-material-icons/" target="_blank">Material Design icon</a>
    <i>(e.g. 'check', 'close')</i> or a <a href="https://fontawesome.com/v4.7.0/icons/" target="_blank">Font Awesome icon</a>
    <i>(e.g. 'fa-fire')</i>, or a <a href="https://github.com/Paul-Reed/weather-icons-lite/blob/master/css_mappings.md">Weather icon</a>.
    You can use the full set of google material icons if you add 'mi-' to the icon name. e.g. 'mi-videogame_asset'.</p>
    <p>The colours of the text and background may be set. They can also be set by a message property by setting
    the field to the name of the property, for example <code>{{background}}</code>.
    You don't need to prepend the <i>msg.</i> part of the property name.</p>
    <p>The label and icon can also be set by a message property by setting
    the field to the name of the property, for example <code>{{topic}}</code> or <code>{{myicon}}</code>.</p>
    <p>If set to pass through mode a message arriving on the input will act like pressing the button.
    The output payload will be as defined in the node configuration.</p>
    <p>The incoming <b>topic</b> field can be used to set the <code>msg.topic</code> property that is output.</p>
    <p>Setting <code>msg.enabled</code> to <code>false</code> will disable the button.</p>
    <p>If a <b>Class</b> is specified, it will be added to the parent card. This way you can style the card and the elements inside it with custom CSS. The Class can be set at runtime by setting a <code>msg.className</code> string property.</p>
</script>

<!-- --- [red-module:node-red-dashboard/ui_dropdown] --- -->
<script type="text/javascript">
    RED.nodes.registerType('ui_dropdown',{
        category: RED._("node-red-dashboard/ui_base:ui_base.label.category"),
        color: 'rgb(176, 223, 227)',
        defaults: {
            name: {value: ''},
            label: {value: ''},
            tooltip: {value: ''},
            place: {value: 'Select option'},
            group: {type: 'ui_group', required:true},
            order: {value: 0},
            width: {value: 0, validate: function(v) {
                    var width = v||0;
                    var currentGroup = $('#node-input-group').val()||this.group;
                    var groupNode = RED.nodes.node(currentGroup);
                    var valid = !groupNode || +width <= +groupNode.width;
                    $("#node-input-size").toggleClass("input-error",!valid);
                    return valid;
                }
            },
            height: {value: 0},
            passthru: {value: true},
            multiple: {value: false},
            options: {value:[{value: '', label : ''}],
                validate:function(v) {
                    var unique = new Set(v.map(function(o) {return o.value;}));
                    return v.length == unique.size;
                }},
            payload: {value: ''},
            topic: {value: 'topic', validate: (RED.validators.hasOwnProperty('typedInput')?RED.validators.typedInput('topicType'):function(v) { return true})},
            topicType: {value: 'msg'},
            className: {value: ''}
        },
        inputs:1,
        outputs:1,
        icon: "ui_dropdown.png",
        paletteLabel: 'dropdown',
        label: function() { return this.name || (~this.label.indexOf("{{") ? null : this.label) || 'dropdown'; },
        labelStyle: function() { return this.name?"node_label_italic":""; },
        oneditprepare: function() {
            if (this.multiple === undefined) {
                $("#node-input-multiple").prop('checked', false);;
            }
            $("#node-input-size").elementSizer({
                width: "#node-input-width",
                height: "#node-input-height",
                group: "#node-input-group"
            });
            var un = new Set(this.options.map(function(o) {return o.value}));
            if (this.options.length == un.size) { $("#valWarning").hide(); }
            else { $("#valWarning").show(); }

            function generateOption(i, option) {
                var container = $('<li/>',{style:"background: var(--red-ui-secondary-background, #fff); margin:0; padding:8px 0px 0px; border-bottom: 1px solid var(--red-ui-form-input-border-color, #ccc);"});
                var row = $('<div/>').appendTo(container);
                var row2 = $('<div/>',{style:"padding-top:5px; padding-left:175px;"}).appendTo(container);
                var row3 = $('<div/>',{style:"padding-top:5px; padding-left:120px;"}).appendTo(container);

                $('<i style="color: var(--red-ui-form-text-color, #eee); cursor:move; margin-left:3px;" class="node-input-option-handle fa fa-bars"></i>').appendTo(row);

                var valueField = $('<input/>',{class:"node-input-option-value",type:"text",style:"margin-left:7px; width:calc(50% - 32px);", placeholder: 'Value',value:option.value}).appendTo(row).typedInput({default:option.type||'str',types:['str','num','bool']});
                var labelField = $('<input/>',{class:"node-input-option-label",type:"text",style:"margin-left:7px; width:calc(50% - 32px);", placeholder: 'Label', value:option.label}).appendTo(row);

                var finalspan = $('<span/>',{style:"float:right; margin-right:8px;"}).appendTo(row);
                var deleteButton = $('<a/>',{href:"#",class:"editor-button editor-button-small", style:"margin-top:7px; margin-left:5px;"}).appendTo(finalspan);
                $('<i/>',{class:"fa fa-remove"}).appendTo(deleteButton);

                deleteButton.click(function() {
                    container.css({"background":"var(--red-ui-secondary-background-inactive, #fee)"});
                    container.fadeOut(300, function() {
                        $(this).remove();
                    });
                });

                $("#node-input-option-container").append(container);
            }

            $("#node-input-add-option").click(function() {
                generateOption($("#node-input-option-container").children().length+1, {});
                $("#node-input-option-container-div").scrollTop($("#node-input-option-container-div").get(0).scrollHeight);
            });

            for (var i=0; i<this.options.length; i++) {
                var option = this.options[i];
                generateOption(i+1,option);
            }

            $( "#node-input-option-container" ).sortable({
                axis: "y",
                handle:".node-input-option-handle",
                cursor: "move"
            });

            $('#node-input-topic').typedInput({
                default: 'str',
                typeField: $("#node-input-topicType"),
                types: ['str','msg','flow','global']
            });
        },
        oneditsave: function() {
            var options = $("#node-input-option-container").children();
            var node = this;
            node.options = [];
            options.each(function(i) {
                var option = $(this);
                var o = {
                    label: option.find(".node-input-option-label").val(),
                    value: option.find(".node-input-option-value").typedInput('value'),
                    type: option.find(".node-input-option-value").typedInput('type')
                };
                if (option.find(".node-input-option-value").typedInput('type') === "num") {
                    o.value = Number(o.value);
                }
                if (option.find(".node-input-option-value").typedInput('type') === "bool") {
                    o.value = (o.value == "true");
                }
                node.options.push(o);
            });
        },
        oneditresize: function() {
        }
    });
</script>

<script type="text/html" data-template-name="ui_dropdown">
    <div class="form-row">
        <label for="node-input-group"><i class="fa fa-table"></i> Group</label>
        <input type="text" id="node-input-group">
    </div>
    <div class="form-row">
        <label><i class="fa fa-object-group"></i> Size</label>
        <input type="hidden" id="node-input-width">
        <input type="hidden" id="node-input-height">
        <button class="editor-button" id="node-input-size"></button>
    </div>
    <div class="form-row">
        <label for="node-input-label"><i class="fa fa-tag"></i> Label</label>
        <input type="text" id="node-input-label" placeholder="optional label">
    </div>
    <div class="form-row">
        <label for="node-input-tooltip"><i class="fa fa-info-circle"></i> Tooltip</label>
        <input type="text" id="node-input-tooltip" placeholder="optional tooltip">
    </div>
    <div class="form-row">
        <label for="node-input-place"><i class="fa fa-tag"></i> Placeholder</label>
        <input type="text" id="node-input-place" placeholder="optional placeholder">
    </div>
    <div class="form-row node-input-option-container-row" style="margin-bottom: 0px;width: 100%">
        <label for="node-input-width" style="vertical-align:top"><i class="fa fa-list-alt"></i> Options</label>
        <div id="node-input-option-container-div" style="box-sizing:border-box; border-radius:5px; height:257px; padding:5px; border:1px solid var(--red-ui-form-input-border-color, #ccc); overflow-y:scroll; display:inline-block; width:calc(70% + 15px);">
            <span id="valWarning" style="color: var(--red-ui-text-color-error, #910000)"><b>All Values must be unique.</b></span>
            <ol id="node-input-option-container" style="list-style-type:none; margin:0;"></ol>
        </div>
    </div>
    <div class="form-row">
        <a href="#" class="editor-button editor-button-small" id="node-input-add-option" style="margin-top:4px; margin-left:103px;"><i class="fa fa-plus"></i> <span>option</span></a>
    </div>
    <div class="form-row">
        <label style="width:auto" for="node-input-multiple"><i class="fa fa-th-list"></i> Allow multiple selections from list: </label>
        <input type="checkbox" checked id="node-input-multiple" style="display:inline-block; width:auto; vertical-align:top;">
    </div>
    <div class="form-row">
        <label style="width:auto" for="node-input-passthru"><i class="fa fa-arrow-right"></i> If <code>msg</code> arrives on input, pass through to output: </label>
        <input type="checkbox" checked id="node-input-passthru" style="display:inline-block; width:auto; vertical-align:top;">
    </div>
    <div class="form-row">
        <label for="node-input-topic"><i class="fa fa-tasks"></i> Topic</label>
        <input type="text" id="node-input-topic" placeholder="optional msg.topic">
        <input type="hidden" id="node-input-topicType">
    </div>
    <div class="form-row">
        <label for="node-input-className"><i class="fa fa-code"></i>  Class</label>
        <input type="text" id="node-input-className" placeholder="Optional CSS class name(s) for widget"/>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>
</script>
<script type="text/html" data-help-name="ui_dropdown">
    <p>Adds a dropdown select box to the user interface.</p>
    <p>Multiple value / label pairs can be added as required. If the label is not specified the
    value will be used for both.</p>
    <p>The configured value of the selected item will be returned as <code>msg.payload</code>.</p>
    <p>Setting <code>msg.payload</code> to one of the item values will preset the choice in the dropdown.
    If using the multi-select option then the payload should be an array of values.</p>
    <p>Optionally the user search term can deleted if the <code>msg.resetSearch</code> property is present and set to <i>true</i>.</p>
    <p>Optionally the <b>Topic</b> field can be used to set the <code>msg.topic</code> property.</p>
    <p>The Options may be configured by inputting <code>msg.options</code> containing an array.
    If just text then the value will be the same as the label, otherwise you can specify both by
    using an object of <code>"label":"value"</code> pairs :</p>
    <code>[ "Choice 1", "Choice 2", {"Choice 3":"3"} ]</code>
    <p></p>
    <p>If the "Allow multiple selections" output option is enabled - the result will be returned as an array instead of a string.</p>
    <p>If a <b>Class</b> is specified, it will be added to the parent card. This way you can style the card and the elements inside it with custom CSS. The Class can be set at runtime by setting a <code>msg.className</code> string property.</p>
</script>

<!-- --- [red-module:node-red-dashboard/ui_switch] --- -->
<script type="text/javascript">
    RED.nodes.registerType('ui_switch',{
        category: RED._("node-red-dashboard/ui_base:ui_base.label.category"),
        color: 'rgb(176, 223, 227)',
        defaults: {
            name: {value: ''},
            label: {value: 'switch'},
            tooltip: {value: ''},
            group: {type: 'ui_group', required: true},
            order: {value: 0},
            width: {value: 0, validate: function(v) {
                    var width = v||0;
                    var currentGroup = $('#node-input-group').val()||this.group;
                    var groupNode = RED.nodes.node(currentGroup);
                    var valid = !groupNode || +width <= +groupNode.width;
                    $("#node-input-size").toggleClass("input-error",!valid);
                    return valid;
                }
            },
            height: {value: 0},
            passthru: {value: true},
            decouple: {value: "false"},
            topic: {value: 'topic', validate: (RED.validators.hasOwnProperty('typedInput')?RED.validators.typedInput('topicType'):function(v) { return true})},
            topicType: {value: 'msg'},
            style: {value: ''},
            onvalue: {value: true, required:true, validate: (RED.validators.hasOwnProperty('typedInput')?RED.validators.typedInput('onvalueType'):function(v) { return true})},
            onvalueType: {value: 'bool'},
            onicon: {value: '' },
            oncolor: {value: ''},
            offvalue: {value: false, required:true, validate: (RED.validators.hasOwnProperty('typedInput')?RED.validators.typedInput('offvalueType'):function(v) { return true})},
            offvalueType: {value: 'bool'},
            officon: {value: ''},
            offcolor: {value: ''},
            animate: {value: false},
            className: {value: ''}
        },
        inputs:1,
        outputs:1,
        icon: "ui_switch.png",
        paletteLabel: 'switch',
        label: function() { return this.name || (~this.label.indexOf("{{") ? null : this.label) || 'switch'; },
        labelStyle: function() { return this.name?"node_label_italic":""; },
        oneditprepare: function() {
            $("#node-input-size").elementSizer({
                width: "#node-input-width",
                height: "#node-input-height",
                group: "#node-input-group"
            });
            $('#node-input-custom-icons').on("change", function() {
                if ($('#node-input-custom-icons').val() === "default") {
                    $(".form-row-custom-icons").hide();
                }
                else {
                    $(".form-row-custom-icons").show();
                }
            });

            if (this.onicon !== "" || this.oncolor !== "" || this.officon !=="" || this.offcolor !== "") {
                $('#node-input-custom-icons').val('custom');
            }
            else {
                $(".form-row-custom-icons").hide();
                $('#node-input-custom-icons').change();
            }

            $('#node-input-onvalue').typedInput({
                default: 'str',
                typeField: $("#node-input-onvalueType"),
                types: ['str','num','bool','json','bin','date','flow','global']
            });

            $('#node-input-offvalue').typedInput({
                default: 'str',
                typeField: $("#node-input-offvalueType"),
                types: ['str','num','bool','json','bin','date','flow','global']
            });

            $('#node-input-topic').typedInput({
                default: 'str',
                typeField: $("#node-input-topicType"),
                types: ['str','msg','flow','global']
            });

            $('#node-input-passthru').on("change", function() {
                if (this.checked) {
                    $('.form-row-decouple').hide();
                    $('#node-input-decouple').val("false");
                }
                else {
                    $('.form-row-decouple').show();
                }
            });
        },
        oneditsave: function() {
            if ($('#node-input-custom-icons').val() === 'default') {
                $('#node-input-onicon').val('');
                $('#node-input-officon').val('');
                $('#node-input-oncolor').val('');
                $('#node-input-offcolor').val('');
            }
        }
    });
</script>

<script type="text/html" data-template-name="ui_switch">
	<div class="form-row">
        <label for="node-input-group"><i class="fa fa-table"></i> Group</label>
        <input type="text" id="node-input-group">
    </div>
    <div class="form-row">
        <label><i class="fa fa-object-group"></i> Size</label>
        <input type="hidden" id="node-input-width">
        <input type="hidden" id="node-input-height">
        <button class="editor-button" id="node-input-size"></button>
    </div>
    <div class="form-row">
        <label for="node-input-label"><i class="fa fa-i-cursor"></i> Label</label>
        <input type="text" id="node-input-label">
    </div>
    <div class="form-row">
        <label for="node-input-tooltip"><i class="fa fa-info-circle"></i> Tooltip</label>
        <input type="text" id="node-input-tooltip" placeholder="optional tooltip">
    </div>
    <div class="form-row">
        <label for="node-input-custom-icons"><i class="fa fa-picture-o"></i> Icon</label>
        <select id="node-input-custom-icons" style="width:35%">
            <option value="default">Default</option>
            <option value="custom">Custom</option>
        </select>
        <span style="width:auto; padding-left:20px" class="form-row-custom-icons" for="node-input-animate"> Animate
        <input type="checkbox" checked id="node-input-animate" style="display:inline-block; width:auto; vertical-align:baseline;"></span>
    </div>
    <div class="form-row form-row-custom-icons">
        <label for="node-input-onicon" style="text-align:right;"><i class="fa fa-toggle-on"></i> On Icon</label>
        <input type="text" id="node-input-onicon" style="width:120px">
        <label for="node-input-oncolor" style="width:50px; text-align:right;">Colour</label>
        <input type="text" id="node-input-oncolor" style="width:120px">
    </div>
    <div class="form-row form-row-custom-icons">
        <label for="node-input-officon" style="text-align:right;"><i class="fa fa-toggle-off"></i> Off Icon</label>
        <input type="text" id="node-input-officon" style="width:120px">
        <label for="node-input-offcolor" style="width:50px; text-align:right;">Colour</label>
        <input type="text" id="node-input-offcolor" style="width:120px">
    </div>
    <div class="form-row">
        <label style="width:auto" for="node-input-passthru"><i class="fa fa-arrow-right"></i> Pass through <code>msg</code> if payload matches valid state: </label>
        <input type="checkbox" checked id="node-input-passthru" style="display:inline-block; width:auto; vertical-align:top;">
    </div>
    <div class="form-row form-row-decouple">
        <label for="node-input-decouple"><i class="fa fa-toggle-on"></i> Indicator</label>
        <select id="node-input-decouple" style="display: inline-block; vertical-align: middle; width:70%;">
            <option value="false">Switch icon shows state of the output</option>
            <option value="true">Switch icon shows state of the input</option>
        </select>
    </div>
    <div class="form-row">
        <label style="width:auto" for="node-input-onvalue"><i class="fa fa-envelope-o"></i> When clicked, send:</label>
    </div>
    <div class="form-row">
        <label for="node-input-onvalue" style="padding-left:25px; margin-right:-25px">On Payload</label>
        <input type="text" id="node-input-onvalue" style="width:70%">
        <input type="hidden" id="node-input-onvalueType">
    </div>
    <div class="form-row">
        <label for="node-input-offvalue" style="padding-left:25px; margin-right:-25px">Off Payload</label>
        <input type="text" id="node-input-offvalue" style="width:70%">
        <input type="hidden" id="node-input-offvalueType">
    </div>
    <div class="form-row">
        <label for="node-input-topic" style="padding-left:25px; margin-right:-25px">Topic</label>
        <input type="text" id="node-input-topic">
        <input type="hidden" id="node-input-topicType">
    </div>
    <div class="form-row">
        <label for="node-input-className"><i class="fa fa-code"></i>  Class</label>
        <input type="text" id="node-input-className" placeholder="Optional CSS class name(s) for widget"/>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>
</script>
<script type="text/html" data-help-name="ui_switch">
    <p>Adds a switch to the user interface.</p>
	<p>Each change in the state of the switch will generate
    a <code>msg.payload</code> with the specified <b>On</b> and <b>Off</b> values.</p>
    <p>The <b>On/Off Color</b> and <b>On/Off Icon</b> are optional fields. If they are all present, the default
    toggle switch will be replaced with the relevant icons and their respective colors.</p>
    <p>The <b>On/Off Icon</b> field can be either a <a href="https://klarsys.github.io/angular-material-icons/" target="_blank">Material Design icon</a>
    <i>(e.g. 'check', 'close')</i> or a <a href="https://fontawesome.com/v4.7.0/icons/" target="_blank">Font Awesome icon</a>
    <i>(e.g. 'fa-fire')</i>, or a <a href="https://github.com/Paul-Reed/weather-icons-lite/blob/master/css_mappings.md">Weather icon</a>.
    You can use the full set of google material icons if you add 'mi-' to the icon name. e.g. 'mi-videogame_asset'.</p>
    <p>In pass through mode the switch state can be updated by an incoming <code>msg.payload</code> with the specified values,
    that must also match the specified type (number, string, etc). When not in passthrough mode then the icon can either
    track the state of the output - or the input msg.payload, in order to provide a closed loop feedback.</p>
    <p>The label can also be set by a message property by setting
    the field to the name of the property, for example <code>{{msg.topic}}</code>.</p>
    <p>If a <b>Topic</b> is specified, it will be added to the output as <code>msg.topic</code>.</p>
    <p>Setting <code>msg.enabled</code> to <code>false</code> will disable the switch widget.</p>
    <p>If a <b>Class</b> is specified, it will be added to the parent card. This way you can style the card and the elements inside it with custom CSS. The Class can be set at runtime by setting a <code>msg.className</code> string property.</p>
</script>

<!-- --- [red-module:node-red-dashboard/ui_slider] --- -->
<script type="text/javascript">
    RED.nodes.registerType('ui_slider',{
        category: RED._("node-red-dashboard/ui_base:ui_base.label.category"),
        color: 'rgb(176, 223, 227)',
        defaults: {
            name: {value: ''},
            label: {value: 'slider'},
            tooltip: {value: ''},
            group: {type: 'ui_group', required: true},
            order: {value: 0},
            width: {value: 0, validate: function(v) {
                    var width = v||0;
                    var currentGroup = $('#node-input-group').val()||this.group;
                    var groupNode = RED.nodes.node(currentGroup);
                    var valid = !groupNode || +width <= +groupNode.width;
                    $("#node-input-size").toggleClass("input-error",!valid);
                    return valid;
                }
            },
            height: {value: 0},
            passthru: {value: true},
            outs: {value: 'all'},
            topic: {value: 'topic', validate: (RED.validators.hasOwnProperty('typedInput')?RED.validators.typedInput('topicType'):function(v) { return true})},
            topicType: {value: 'msg'},
            min: {value: 0, required:true, validate:RED.validators.number()},
            max: {value: 10, required:true, validate:RED.validators.number()},
            step: {value: 1},
            className: {value: ''}
        },
        inputs:1,
        outputs:1,
        outputLabels: function() { return this.min+" - "+this.max; },
        icon: "ui_slider.png",
        paletteLabel: 'slider',
        label: function() { return this.name || (~this.label.indexOf("{{") ? null : this.label) || 'slider'; },
        labelStyle: function() { return this.name?"node_label_italic":""; },
        oneditprepare: function() {
            $("#node-input-size").elementSizer({
                width: "#node-input-width",
                height: "#node-input-height",
                group: "#node-input-group"
            });
            $('#node-input-topic').typedInput({
                default: 'str',
                typeField: $("#node-input-topicType"),
                types: ['str','msg','flow','global']
            });
            if (!$("#node-input-outs").val()) { $("#node-input-outs").val("all") }
        }
    });
</script>

<script type="text/html" data-template-name="ui_slider">
	<div class="form-row">
        <label for="node-input-group"><i class="fa fa-table"></i> Group</label>
        <input type="text" id="node-input-group">
    </div>
    <div class="form-row">
        <label><i class="fa fa-object-group"></i> Size</label>
        <input type="hidden" id="node-input-width">
        <input type="hidden" id="node-input-height">
        <button class="editor-button" id="node-input-size"></button>
    </div>
    <div class="form-row">
        <label for="node-input-label"><i class="fa fa-i-cursor"></i> Label</label>
        <input type="text" id="node-input-label">
    </div>
    <div class="form-row">
        <label for="node-input-tooltip"><i class="fa fa-info-circle"></i> Tooltip</label>
        <input type="text" id="node-input-tooltip" placeholder="optional tooltip">
    </div>
    <div class="form-row">
        <label for="node-input-min"><i class="fa fa-arrows-h"></i> Range</label>
        <span for="node-input-min">min</span>
        <input type="text" id="node-input-min" style="width:60px">
        <span for="not-input-max" style="margin-left:22px;">max</span>
        <input type="text" id="node-input-max" style="width:60px">
        <span for="not-input-step" style="margin-left:22px;">step</span>
        <input type="text" id="node-input-step" style="width:60px">
    </div>
    <div class="form-row">
        <label for="node-input-outs"><i class="fa fa-sign-out"></i> Output</label>
        <select id="node-input-outs" style="width:204px">
            <option value="all">continuously while sliding</option>
            <option value="end">only on release</option>
        </select>
    </div>
    <div class="form-row">
        <label style="width:auto" for="node-input-passthru"><i class="fa fa-arrow-right"></i> If <code>msg</code> arrives on input, pass through to output: </label>
        <input type="checkbox" checked id="node-input-passthru" style="display:inline-block; width:auto; vertical-align:top;">
    </div>
    <div class="form-row">
        <label style="width:auto" for="node-input-payload"><i class="fa fa-envelope-o"></i> When changed, send:</label>
    </div>
    <div class="form-row">
        <label style="padding-left:25px; margin-right:-25px">Payload</label>
        <label style="width:auto">Current value</label>
    </div>
    <div class="form-row">
        <label for="node-input-topic" style="padding-left:25px; margin-right:-25px">Topic</label>
        <input type="text" id="node-input-topic">
    </div>
    <div class="form-row">
        <label for="node-input-className"><i class="fa fa-code"></i>  Class</label>
        <input type="text" id="node-input-className" placeholder="Optional CSS class name(s) for widget"/>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name">
        <input type="hidden" id="node-input-topicType">
    </div>
</script>
<script type="text/html" data-help-name="ui_slider">
    <p>Adds a slider widget to the user interface.</p>
	<p>The user can change its value between the limits (<b>min</b> and <b>max</b>). Each value change
    will generate a message with the value set as <b>payload</b>.</p>
    <p>A vertical slider can be created by setting the size so that the height is greater than the width.</p>
    <p>The slider can be reversed by setting the min value larger than the max value. e.g. min 100, max 0.</p>
    <p>If a <b>Topic</b> is specified, it will be added as <code>msg.topic</code>.</p>
    <p>An input <code>msg.payload</code> will be converted to a number, and used to preset a value.
    The <b>min</b> value will be used if conversion fails,
    and it will update the user interface. If the value changes, it will also be passed to the output.</p>
    <p>The label can also be set by a message property by setting
    the field to the name of the property, for example <code>{{msg.topic}}</code>.</p>
    <p>Setting <code>msg.enabled</code> to <code>false</code> will disable the slider output.</p>
    <p>If a <b>Class</b> is specified, it will be added to the parent card. This way you can style the card and the elements inside it with custom CSS. The Class can be set at runtime by setting a <code>msg.className</code> string property.</p>
</script>

<!-- --- [red-module:node-red-dashboard/ui_numeric] --- -->
<script type="text/javascript">
    RED.nodes.registerType('ui_numeric',{
        category: RED._("node-red-dashboard/ui_base:ui_base.label.category"),
        color: 'rgb(176, 223, 227)',
        defaults: {
            name: {value: ''},
            label: {value: 'numeric'},
            tooltip: {value: ''},
            group: {type: 'ui_group', required: true},
            order: {value: 0},
            width: {value: 0, validate: function(v) {
                    var width = v||0;
                    var currentGroup = $('#node-input-group').val()||this.group;
                    var groupNode = RED.nodes.node(currentGroup);
                    var valid = !groupNode || +width <= +groupNode.width;
                    $("#node-input-size").toggleClass("input-error",!valid);
                    return valid;
                }
            },
            height: {value: 0},
            wrap: {value: false},
            passthru: {value: true},
            topic: {value: 'topic', validate: (RED.validators.hasOwnProperty('typedInput')?RED.validators.typedInput('topicType'):function(v) { return true})},
            topicType: {value: 'msg'},
            format: {value: '{{value}}'},
            min: {value: 0, required: true, validate: RED.validators.number()},
            max: {value: 10, required: true, validate: RED.validators.number()},
            step: {value: 1},
            className: {value: ''}
        },
        inputs:1,
        outputs:1,
        outputLabels: function() { return this.min+" - "+this.max; },
        icon: "ui_numeric.png",
        paletteLabel: 'numeric',
        label: function() { return this.name || (~this.label.indexOf("{{") ? null : this.label) || 'numeric'; },
        labelStyle: function() { return this.name?"node_label_italic":""; },
        oneditprepare: function() {
            $("#node-input-size").elementSizer({
                width: "#node-input-width",
                height: "#node-input-height",
                group: "#node-input-group"
            });
            $('#node-input-topic').typedInput({
                default: 'str',
                typeField: $("#node-input-topicType"),
                types: ['str','msg','flow','global']
            });
        }
    });
</script>

<script type="text/html" data-template-name="ui_numeric">
	<div class="form-row">
        <label for="node-input-group"><i class="fa fa-table"></i> Group</label>
        <input type="text" id="node-input-group">
    </div>
    <div class="form-row">
        <label><i class="fa fa-object-group"></i> Size</label>
        <input type="hidden" id="node-input-width">
        <input type="hidden" id="node-input-height">
        <button class="editor-button" id="node-input-size"></button>
    </div>
    <div class="form-row">
        <label for="node-input-label"><i class="fa fa-i-cursor"></i> Label</label>
        <input type="text" id="node-input-label">
    </div>
    <div class="form-row">
        <label for="node-input-tooltip"><i class="fa fa-info-circle"></i> Tooltip</label>
        <input type="text" id="node-input-tooltip" placeholder="optional tooltip">
    </div>
    <div class="form-row">
        <label for="node-input-format"><i class="fa fa-i-cursor"></i> Value Format</label>
        <input type="text" id="node-input-format" placeholder="{{value}}">
    </div>
    <div class="form-row">
        <label for="node-input-min"><i class="fa fa-arrows-h"></i> Range</label>
        <span for="node-input-min">min</span>
        <input type="text" id="node-input-min" style="width:60px">
        <span for="not-input-max" style="margin-left:22px;">max</span>
        <input type="text" id="node-input-max" style="width:60px">
        <span for="not-input-step" style="margin-left:22px;">step</span>
        <input type="text" id="node-input-step" style="width:60px">
    </div>
    <div class="form-row">
        <label style="width:auto" for="node-input-wrap"><i class="fa fa-refresh"></i> Wrap value from max to min and min to max.</label>
        <input type="checkbox" id="node-input-wrap" style="display:inline-block; width:auto; vertical-align:top;">
    </div>
    <div class="form-row">
        <label style="width:auto" for="node-input-passthru"><i class="fa fa-arrow-right"></i> If <code>msg</code> arrives on input, pass through to output: </label>
        <input type="checkbox" checked id="node-input-passthru" style="display:inline-block; width:auto; vertical-align:top;">
    </div>
    <div class="form-row">
        <label style="width:auto" for="node-input-payload"><i class="fa fa-envelope-o"></i> When changed, send:</label>
    </div>
    <div class="form-row">
        <label style="padding-left:25px; margin-right:-25px">Payload</label>
        <label style="width:auto">Current value</label>
    </div>
    <div class="form-row">
        <label for="node-input-topic" style="padding-left:25px; margin-right:-25px">Topic</label>
        <input type="text" id="node-input-topic">
        <input type="hidden" id="node-input-topicType">
    </div>
    <div class="form-row">
        <label for="node-input-className"><i class="fa fa-code"></i>  Class</label>
        <input type="text" id="node-input-className" placeholder="Optional CSS class name(s) for widget"/>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>
</script>
<script type="text/html" data-help-name="ui_numeric">
    <p>Adds a numeric input widget to the user interface.</p>
	<p>The user can set the value between
    the limits (<b>min</b> and <b>max</b>). Each value change will generate a <code>msg.payload</code>.</p>
    <p>If <b>Topic</b> is specified, it will be added as <code>msg.topic</code>.<p>
    <p>Any input <code>msg.payload</code> will be converted to a number, the <b>min</b> value will be used if conversion fails,
    and it will update the user interface. If the value changes, it will also be passed to the output.</p>
    <p>The <b>Value Format</b> field can be used to change the displayed format. For example, a <b>Value Format</b>
    of <code>{{value}} %</code>
    with a value of <b>23</b> will show <b>23 %</b> on the user interface. The <b>Value Format</b> field can contain
    HTML or Angular filters to format the output (eg: <code>&amp;deg;</code> will show the degree symbol).</p>
    <p>Setting the Value Format field to <code>{{msg.payload}}</code> will make the input field editable so you can type in a number.</p>
    <p>The label can also be set by a message property by setting
    the field to the name of the property, for example <code>{{msg.topic}}</code>.</p>
    <p>Setting <code>msg.enabled</code> to <code>false</code> will disable the widget output.</p>
    <p>If a <b>Class</b> is specified, it will be added to the parent card. This way you can style the card and the elements inside it with custom CSS. The Class can be set at runtime by setting a <code>msg.className</code> string property.</p>
</script>

<!-- --- [red-module:node-red-dashboard/ui_text_input] --- -->
<script type="text/javascript">
    RED.nodes.registerType('ui_text_input',{
        category: RED._("node-red-dashboard/ui_base:ui_base.label.category"),
        color: 'rgb(176, 223, 227)',
        defaults: {
            name: {value: ''},
            label: {value: ''},
            tooltip: {value: ''},
            group: {type: 'ui_group', required: true},
            order: {value: 0},
            width: {value: 0, validate: function(v) {
                    var width = v||0;
                    var currentGroup = $('#node-input-group').val()||this.group;
                    var groupNode = RED.nodes.node(currentGroup);
                    var valid = !groupNode || +width <= +groupNode.width;
                    $("#node-input-size").toggleClass("input-error",!valid);
                    return valid;
                }
            },
            height: {value: 0},
            passthru: {value: true},
            mode: {value: 'text', required: true},
            delay: {value: 300, validate: RED.validators.number()},
            topic: {value: 'topic', validate: (RED.validators.hasOwnProperty('typedInput')?RED.validators.typedInput('topicType'):function(v) { return true})},
            sendOnBlur: {value: true},
	        className: {value: ''},
            topicType: {value: 'msg'}
        },
        inputs:1,
        outputs:1,
        outputLabels: function() { return this.mode; },
        icon: "ui_text.png",
        paletteLabel: 'text input',
        label: function() { return this.name || (~this.label.indexOf("{{") ? null : this.label) || this.mode+' input'; },
        labelStyle: function() { return this.name?"node_label_italic":""; },
        oneditprepare: function() {
            $("#node-input-size").elementSizer({
                width: "#node-input-width",
                height: "#node-input-height",
                group: "#node-input-group"
            });
            $('#node-input-topic').typedInput({
                default: 'str',
                typeField: $("#node-input-topicType"),
                types: ['str','msg','flow','global']
            });
        }
    });
</script>

<script type="text/html" data-template-name="ui_text_input">
	<div class="form-row">
        <label for="node-input-group"><i class="fa fa-table"></i> Group</label>
        <input type="text" id="node-input-group">
    </div>
    <div class="form-row">
        <label><i class="fa fa-object-group"></i> Size</label>
        <input type="hidden" id="node-input-width">
        <input type="hidden" id="node-input-height">
        <button class="editor-button" id="node-input-size"></button>
    </div>
    <div class="form-row">
        <label for="node-input-label"><i class="fa fa-i-cursor"></i> Label</label>
        <input type="text" id="node-input-label">
    </div>
    <div class="form-row">
        <label for="node-input-tooltip"><i class="fa fa-info-circle"></i> Tooltip</label>
        <input type="text" id="node-input-tooltip" placeholder="optional tooltip">
    </div>
    <div class="form-row">
        <label for="node-input-mode"><i class="fa fa-keyboard-o"></i> Mode</label>
        <select style="width:128px" id="node-input-mode">
            <option value="text">text input</option>
            <option value="email">email address</option>
            <option value="password">password</option>
            <option value="number">number</option>
            <option value="tel">telephone input</option>
            <option value="color">color picker</option>
            <option value="time">time picker</option>
            <option value="datetime-local">datetime picker</option>
            <option value="week">week picker</option>
            <option value="month">month picker</option>
            <!-- <option value="date">date picker</option> -->
        </select>
        <label for="node-input-delay" style="text-align:right; width:100px"><i class="fa fa-clock-o"></i> Delay (ms)</label>
        <input type="text" style="width:58px" id="node-input-delay">
    </div>
    <div class="form-row">
        <label style="width:auto" for="node-input-passthru"><i class="fa fa-arrow-right"></i> If <code>msg</code> arrives on input, pass through to output: </label>
        <input type="checkbox" checked id="node-input-passthru" style="display:inline-block; width:auto; vertical-align:top;">
    </div>
    <div class="form-row">
        <label style="width:auto" for="node-input-sendOnBlur">Send value on focus leave: </label>
        <input type="checkbox" checked id="node-input-sendOnBlur" style="display:inline-block; width:auto; vertical-align:top;">
    </div>
    <div class="form-row">
        <label style="width:auto" for="node-input-payload"><i class="fa fa-envelope-o"></i> When changed, send:</label>
    </div>
    <div class="form-row">
        <label style="padding-left: 25px; margin-right: -25px">Payload</label>
        <label style="width:auto">Current value</label>
    </div>
    <div class="form-row">
        <label for="node-input-topic" style="padding-left: 25px; margin-right: -25px">Topic</label>
        <input type="text" id="node-input-topic">
        <input type="hidden" id="node-input-topicType">
    </div>
    <div class="form-row">
        <label for="node-input-className"><i class="fa fa-code"></i>  Class</label>
        <input type="text" id="node-input-className" placeholder="Optional CSS class name(s) for widget"/>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>
    <div class="form-tips">Setting <b>Delay</b> to 0 waits for Enter or Tab key, to send input.</span></div>
</script>
<script type="text/html" data-help-name="ui_text_input">
  <p>Adds a text input field to the user interface. Mode can be regular text, email or color picker.</p>
  <p>Any input is sent as <code>msg.payload</code>. If set to ‘pass through mode’ an arriving <code>msg.payload</code>
      will be used if it is different from the existing text in the input field. This allows you to preset
      the text of the input field.</p>
  <p>The <b>Delay</b> <i>(default : 300ms)</i> sets the amount of time in milliseconds before the output is sent.
  Setting to <code>0</code> waits for "Enter" or "Tab" key to send. Enter will send payload but remain in focus.
  Tab will send payload and move to next field. Clicking elsewhere will also send the payload.</p>
  <p>The email mode will color in red if it is not a valid address and will return undefined.</p>
  <p>The time input type returns a number of milliseconds from midnight.</p>
  <p>Not all browsers support the <i>week</i> and <i>month</i> input types, and may return <i>undefined</i>.
  Please test your target browser(s) before use.</p>
  <p>If a <b>Topic</b> is specified, it will be added as <code>msg.topic</code>.</p>
  <p>Setting <code>msg.enabled</code> to <code>false</code> will disable the input.</p>
  <p>If a <b>Class</b> is specified, it will be added to the parent card. This way you can style the card and the elements inside it with custom CSS. The Class can be set at runtime by setting a <code>msg.className</code> string property.</p>
</script>

<!-- --- [red-module:node-red-dashboard/ui_date_picker] --- -->
<script type="text/javascript">
    RED.nodes.registerType('ui_date_picker',{
        category: RED._("node-red-dashboard/ui_base:ui_base.label.category"),
        color: 'rgb(176, 223, 227)',
        defaults: {
            name: {value: ''},
            label: {value: 'date'},
            group: {type: 'ui_group', required: true},
            order: {value: 0},
            width: {value: 0, validate: function(v) {
                    var width = v||0;
                    var currentGroup = $('#node-input-group').val()||this.group;
                    var groupNode = RED.nodes.node(currentGroup);
                    var valid = !groupNode || +width <= +groupNode.width;
                    $("#node-input-size").toggleClass("input-error",!valid);
                    return valid;
                }
            },
            height: {value: 0},
            passthru: {value: true},
            topic: {value: 'topic', validate: (RED.validators.hasOwnProperty('typedInput')?RED.validators.typedInput('topicType'):function(v) { return true})},
            topicType: {value: 'msg'},
            className: {value: ''}
        },
        inputs:1,
        outputs:1,
        outputLabels: ["epoch mS"],
        icon: "ui_date_picker.png",
        paletteLabel: 'date picker',
        label: function() { return this.name || (~this.label.indexOf("{{") ? null : this.label) || 'date picker'; },
        labelStyle: function() { return this.name?"node_label_italic":""; },
        oneditprepare: function() {
            $("#node-input-size").elementSizer({
                width: "#node-input-width",
                height: "#node-input-height",
                group: "#node-input-group"
            });
            $('#node-input-topic').typedInput({
                default: 'str',
                typeField: $("#node-input-topicType"),
                types: ['str','msg','flow','global']
            });
        }
    });
</script>

<script type="text/html" data-template-name="ui_date_picker">
	<div class="form-row">
        <label for="node-input-group"><i class="fa fa-table"></i> Group</label>
        <input type="text" id="node-input-group">
    </div>
    <div class="form-row">
        <label><i class="fa fa-object-group"></i> Size</label>
        <input type="hidden" id="node-input-width">
        <input type="hidden" id="node-input-height">
        <button class="editor-button" id="node-input-size"></button>
    </div>
    <div class="form-row">
        <label for="node-input-label"><i class="fa fa-i-cursor"></i> Label</label>
        <input type="text" id="node-input-label">
    </div>
    <div class="form-row">
        <label style="width:auto" for="node-input-passthru"><i class="fa fa-arrow-right"></i> If <code>msg</code> arrives on input, pass through to output: </label>
        <input type="checkbox" checked id="node-input-passthru" style="display:inline-block; width:auto; vertical-align:top;">
    </div>
    <div class="form-row">
        <label style="width:auto" for="node-input-payload"><i class="fa fa-envelope-o"></i> When changed, send:</label>
    </div>
    <div class="form-row">
        <label style="padding-left:25px; margin-right:-25px">Payload</label>
        <label style="width:auto">Current value</label>
    </div>
    <div class="form-row">
        <label for="node-input-topic" style="padding-left:25px; margin-right:-25px">Topic</label>
        <input type="text" id="node-input-topic">
        <input type="hidden" id="node-input-topicType">
    </div>
    <div class="form-row">
        <label for="node-input-className"><i class="fa fa-code"></i>  Class</label>
        <input type="text" id="node-input-className" placeholder="Optional CSS class name(s) for widget"/>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>
</script>
<script type="text/html" data-help-name="ui_date_picker">
    <p>Adds a date picker widget to the user interface.</p>
    <p>The date display can be formatted in the Dashboard - Site tab using <a href="https://momentjs.com/docs/#/displaying/">
    moment.js</a> formatting. For example <code>MM/DD/YYYY</code>, <code>Do MMM YYYY</code> or <code>YYYY-MM-DD</code>.</p>
    <p>Setting <code>msg.enabled</code> to <code>false</code> will disable the input.</p>
    <p>If a <b>Class</b> is specified, it will be added to the parent card. This way you can style the card and the elements inside it with custom CSS. The Class can be set at runtime by setting a <code>msg.className</code> string property.</p>
</script>

<!-- --- [red-module:node-red-dashboard/ui_colour_picker] --- -->
<script type="text/javascript">
    RED.nodes.registerType('ui_colour_picker',{
        category: RED._("node-red-dashboard/ui_base:ui_base.label.category"),
        color: 'rgb(176, 223, 227)',
        defaults: {
            name: {value: ''},
            label: {value: ''},
            group: {type: 'ui_group', required: true},
            format: {value: 'hex'},
            outformat: {value: 'string'},
            showSwatch: {value: true},
            showPicker: {value: false},
            showValue: {value: false},
            showHue: {value: false},
            showAlpha: {value: false},
            showLightness: {value: true},
            square: {value: "false"},
            dynOutput: {value: "false"},
            order: {value: 0},
            width: {value: 0, validate: function(v) {
                    var width = v||0;
                    var currentGroup = $('#node-input-group').val()||this.group;
                    var groupNode = RED.nodes.node(currentGroup);
                    var valid = !groupNode || +width <= +groupNode.width;
                    $("#node-input-size").toggleClass("input-error",!valid);
                    return valid;
                }
            },
            height: {value: 0},
            passthru: {value: true},
            topic: {value: 'topic', validate: (RED.validators.hasOwnProperty('typedInput')?RED.validators.typedInput('topicType'):function(v) { return true})},
            topicType: {value: 'msg'},
            className: {value: ''}
        },
        inputs:1,
        outputs:1,
        outputLabels: function() { return this.format; },
        icon: "ui_colour_picker.png",
        paletteLabel: 'colour picker',
        label: function() { return this.name || (~this.label.indexOf("{{") ? null : this.label) || 'colour picker'; },
        labelStyle: function() { return this.name?"node_label_italic":""; },
        oneditprepare: function() {
            if (this.square === undefined) {
                this.square = "false";
                $("#node-input-square").val("false");
            }
            $("#node-input-square").on("change", function() {
                if ($("#node-input-square").val() === "false") {
                    $("#node-input-showLightness").prop('checked', true);
                    $("#node-input-showHue").prop('checked', false);
                }
                else {
                    $("#node-input-showLightness").prop('checked', false);
                    $("#node-input-showHue").prop('checked', true);
                }
            });
            $("#node-input-size").elementSizer({
                width: "#node-input-width",
                height: "#node-input-height",
                group: "#node-input-group"
            });
            $("#node-input-format").on("change", function() {
                if ($(this).val() === "hex") {
                    $("#node-alpha-control").hide();
                }
                else {
                    $("#node-alpha-control").show();
                }
            });
            $('#node-input-topic').typedInput({
                default: 'str',
                typeField: $("#node-input-topicType"),
                types: ['str','msg','flow','global']
            });
        },
        oneditsave: function() {
            if (!$("#node-input-showPicker").is(':checked') && !$("#node-input-showValue").is(':checked')) {
                $("#node-input-showSwatch").prop('checked', true);
                this.showSwatch = true;
            }
        }
    });
</script>

<script type="text/html" data-template-name="ui_colour_picker">
    <div class="form-row">
        <label for="node-input-group"><i class="fa fa-table"></i> Group</label>
        <input type="text" id="node-input-group">
    </div>
    <div class="form-row">
        <label><i class="fa fa-object-group"></i> Size</label>
        <input type="hidden" id="node-input-width">
        <input type="hidden" id="node-input-height">
        <button class="editor-button" id="node-input-size"></button>
    </div>
    <div class="form-row">
        <label for="node-input-label"><i class="fa fa-i-cursor"></i> Label</label>
        <input type="text" id="node-input-label">
    </div>
    <div class="form-row">
        <label for="node-input-format"><i class="fa fa-keyboard-o"></i> Format</label>
        <select id="node-input-format" style="width:156px;">
            <option value="hex">hex</option>
            <option value="hex8">hex8</option>
            <option value="hsl">hsl</option>
            <option value="hsv">hsv</option>
            <option value="rgb">rgb</option>
        </select>
        <select id="node-input-square" style="width:130px; margin-left:30px">
            <option value="false">round</option>
            <option value="true">square</option>
        </select>
    </div>
    <div class="form-row">
        <label>&nbsp;</label> Show hue slider : <input type="checkbox" id="node-input-showHue" style="display:inline-block; width:auto; vertical-align:baseline;">
        <br/>
        <label>&nbsp;</label> Show lightness slider : <input type="checkbox" id="node-input-showLightness" style="display:inline-block; width:auto; vertical-align:baseline;">
        <br/>
        <span id="node-alpha-control"><label>&nbsp;</label> Show transparency slider : <input type="checkbox" id="node-input-showAlpha" style="display:inline-block; width:auto; vertical-align:baseline;"></span>
    </div>
    <div class="form-row">
        If width is 4 or greater:<br/>
        <label>&nbsp;</label>
        Always show swatch : <input type="checkbox" checked id="node-input-showSwatch" style="display:inline-block; width:auto; vertical-align:top;">
        <br/>
        <label>&nbsp;</label>
        Always show picker : <input type="checkbox" checked id="node-input-showPicker" style="display:inline-block; width:auto; vertical-align:top;">
        <br/>
        <label>&nbsp;</label>
        Always show value field : <input type="checkbox" checked id="node-input-showValue" style="display:inline-block; width:auto; vertical-align:top;">
    </div>
    <div class="form-row">
        <label style="width:auto" for="node-input-passthru"><i class="fa fa-arrow-right"></i> If <code>msg</code> arrives on input, pass through to output: </label>
        <input type="checkbox" checked id="node-input-passthru" style="display:inline-block; width:auto; vertical-align:top;">
    </div>
    <div class="form-row">
        <label for="node-input-dynOutput"><i class="fa fa-envelope-o"></i> Send</label>
        <select id="node-input-dynOutput" style="width:60%">
            <option value="false">one value when released/closed</option>
            <option value="true">multiple values during editing</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-outformat" style="padding-left: 25px; margin-right: -25px">Payload</label>
        <select id="node-input-outformat" style="width:60%">
            <option value="string">current value as a string</option>
            <option value="object">current value as an object</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-topic" style="padding-left: 25px; margin-right: -25px">Topic</label>
        <input type="text" id="node-input-topic" placeholder="optional topic">
        <input type="hidden" id="node-input-topicType">
    </div>
    <div class="form-row">
        <label for="node-input-className"><i class="fa fa-code"></i>  Class</label>
        <input type="text" id="node-input-className" placeholder="Optional CSS class name(s) for widget"/>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>
</script>
<script type="text/html" data-help-name="ui_colour_picker">
    <p>Adds a colour picker to the dashboard.</p>
    <p>If the group width is 4 or greater then the picker can be set to be visible at all times.</p>
    <p><b>Format</b> can be rgb, hex, hex8, hsv, or hsl. Transparency is supported for all except hex.</p>
    <p>If a <b>Topic</b> is specified, it will be added as <code>msg.topic</code>.</p>
    <p>Setting <code>msg.enabled</code> to <code>false</code> will disable the input.</p>
    <p>If set to ‘pass through mode’ a message arriving on the input will be evaluated for any colour format available
        as Format. If the conversion fails #000000 will be used.</p>
    <p>If a <b>Class</b> is specified, it will be added to the parent card. This way you can style the card and the elements inside it with custom CSS. The Class can be set at runtime by setting a <code>msg.className</code> string property.</p>
</script>

<!-- --- [red-module:node-red-dashboard/ui_form] --- -->
<script type="text/javascript">
    RED.nodes.registerType('ui_form',{
        category: RED._("node-red-dashboard/ui_base:ui_base.label.category"),
        color: 'rgb(176, 223, 227)',
        defaults: {
            name: {value: ''},
            label: {value: ''},
            group: {type: 'ui_group', required: true},
            order: {value: 0},
            width: {value: 0, validate: function(v) {
                    var width = v||0;
                    var currentGroup = $('#node-input-group').val()||this.group;
                    var groupNode = RED.nodes.node(currentGroup);
                    var valid = !groupNode || +width <= +groupNode.width;
                    $("#node-input-size").toggleClass("input-error",!valid);
                    return valid;
                }
            },
            height: {value: 0},
            options: {value:[{value:'', label :'', type:'', required:true}], validate:function(value) {
                    if (value.length ) {
                        for (var i = 0; i < value.length; i++) {
                            if (!value[i].value) {
                                return false;
                            }
                        }
                    }
                    else {
                        return false;
                    }
                    return true;
                }, required:true},
            formValue:{value:{}},
            payload: {value: ''},
            submit: {value: "submit"},
            cancel: {value: "cancel"},
            topic: {value: 'topic', validate: (RED.validators.hasOwnProperty('typedInput')?RED.validators.typedInput('topicType'):function(v) { return true})},
            topicType: {value: 'msg'},
            splitLayout: {value:''},
            className: {value: ''}
        },
        inputs:1,
        outputs:1,
        icon: "ui_form.png",
        paletteLabel: 'form',
        label: function() { return this.name || this.label || 'form'; },
        labelStyle: function() { return this.name?"node_label_italic":""; },
        oneditprepare: function() {
            if ($("#node-input-submit").val() === null) { $("#node-input-submit").val("submit"); }
            if ($("#node-input-cancel").val() === null) { $("#node-input-cancel").val("cancel"); }
            $("#node-input-size").elementSizer({
                width: "#node-input-width",
                height: "#node-input-height",
                group: "#node-input-group"
            });

            this.resizeRule = function(option,newWidth) {
                //option.find(".node-input-option-type").width(newWidth);
                //  option.find(".node-input-option-label").width(newWidth);
                //  option.find(".node-input-option-value").width(newWidth);
            }

            function generateOption(i, option) {
                var container = $('<li/>',{style:"margin:0; padding:8px 0px 0px; border-bottom:1px solid var(--red-ui-form-input-border-color, #ccc);"});
                var row = $('<div/>').appendTo(container);
                var row2 = $('<div/>',{style:"padding-top:5px; padding-left:175px;"}).appendTo(container);
                var row3 = $('<div/>',{style:"padding-top:5px; padding-left:120px;"}).appendTo(container);

                $('<i style="cursor:move; margin-left:3px;" class="node-input-option-handle fa fa-bars"></i>').appendTo(row);

                var labelField = $('<input/>',{class:"node-input-option-label", type:"text", style:"margin-left:7px; width:20%;", placeholder: RED._("node-red-dashboard/ui_form:ui_form.label.egName"), value:option.label}).appendTo(row);//.typedInput({default:'str',types:['str', 'num']});
                var valueClass ="node-input-option-value"
                if (!option.value) { valueClass ="node-input-option-value input-error"; }
                var valueField = $('<input/>',{class:valueClass, type:"text", style:"margin-left:7px; width:20%;", placeholder: RED._("node-red-dashboard/ui_form:ui_form.label.egName2"), value:option.value}).appendTo(row);//.typedInput({default:'str',types:['str','num','bool']});
                valueField.keyup(function() {
                    if ($(this).val() && $(this).hasClass('input-error')) {
                        $(this).removeClass('input-error')
                    }
                    else {
                        if (!$(this).val()) {
                            $(this).addClass('input-error')
                        }
                    }

                });
                // var typeField = $('<input/>',{class:"node-input-option-type",type:"text",style:"margin-left: 7px; width: 135px;", placeholder: 'Type', value:option.type}).appendTo(row).typedInput({default:'str',types:['str', 'num']});
                var typeField = $('<select/>',{class:"node-input-option-type",type:"text",style:"margin-left:7px; width:16%"}).appendTo(row);//.typedInput({default:'str',types:['str', 'num']});

                var arr = [
                  {val : "text", text: RED._("node-red-dashboard/ui_form:ui_form.label.text")},
                  {val : "multiline", text: RED._("node-red-dashboard/ui_form:ui_form.label.multiline")},
                  {val : "number", text: RED._("node-red-dashboard/ui_form:ui_form.label.number")},
                  {val : "email", text: RED._("node-red-dashboard/ui_form:ui_form.label.email")},
                  {val : "password", text: RED._("node-red-dashboard/ui_form:ui_form.label.password")},
                  {val : "checkbox", text: RED._("node-red-dashboard/ui_form:ui_form.label.checkbox")},
                  {val : "switch", text: RED._("node-red-dashboard/ui_form:ui_form.label.switch")},
                  {val : "date", text: RED._("node-red-dashboard/ui_form:ui_form.label.date")},
                  {val : "time", text: RED._("node-red-dashboard/ui_form:ui_form.label.time")}
                ];

                //var sel = $('<select>').appendTo('body');
                $(arr).each(function() {
                    var isSelected= false;
                    if (option.type == this.val) {
                        isSelected = true;
                    }
                    typeField.append($("<option>").attr('value',this.val).text(this.text).prop('selected',isSelected));
                });

                //var labelForRequried = $('<span/>',{style:"margin: 10px;"}).text('Required').appendTo(row);
                var requiredContainer= $('<div/>',{style:"display:inline-block; height:34px; width:13%; vertical-align: middle"}).appendTo(row);
                var requiredInnerContainer= $('<div/>',{style:"left:35%; position:relative; width:30px"}).appendTo(requiredContainer);
                var reqRow=$("<label />",{class:"switch",style:"top:10px; width:30px;"}).appendTo(requiredInnerContainer);
                //var required = $('<input/>',{class:"node-input-option-required",style:"margin: 5px;width:19%",type:"checkbox", checked:option.required}).appendTo(row);//labelForRequried);//.typedInput({default:'str',types:['str', 'num']});
                var required = $('<input/>',{class:"node-input-option-required", type:"checkbox", checked:option.required, style:"vertical-align:top;"}).appendTo(reqRow);//labelForRequried);//.typedInput({default:'str',types:['str', 'num']});
                var reqDiv=$("<div />",{class:"slider round"}).appendTo(reqRow);
                var vis = option.rows ? 'visible' : 'hidden';
                var rowsField = $('<input/>',{class:"node-input-option-rows", type:"number", style:"width:10%;", placeholder:'Rows', value:option.rows }).css('visibility',vis).appendTo(row);

                var finalspan = $('<div/>',{style:"display:inline-block; width:5%;"}).appendTo(row);
                var deleteButton = $('<a/>',{href:"#",class:"editor-button", style:"font-size:1.3em; left:45%; position:relative;"}).appendTo(finalspan);
                $('<i/>',{class:"fa fa-trash-o"}).appendTo(deleteButton);

                typeField.change(function(e){
                    if (e.target.value != 'multiline') {
                        rowsField.val(undefined)
                        option.rows = null;
                        rowsField.css('visibility','hidden')
                    } else {
                        rowsField.css('visibility','visible')
                        if (!rowsField[0].value) rowsField[0].value = 3;
                    }

                })

                deleteButton.click(function() {
                    container.find(".node-input-option-value").removeAttr('required')
                    container.css({"background":"var(--red-ui-secondary-background-inactive, #fee)"});
                    container.fadeOut(300, function() {
                        $(this).remove();
                    });
                });

                $("#node-input-option-container").append(container);
            }

            $("#node-input-add-option").click(function() {
                generateOption($("#node-input-option-container").children().length+1, {});
                $("#node-input-option-container-div").scrollTop($("#node-input-option-container-div").get(0).scrollHeight);
            });

            for (var i=0; i<this.options.length; i++) {
                var option = this.options[i];
                generateOption(i+1,option);
            }

            $('#node-input-topic').typedInput({
                default: 'str',
                typeField: $("#node-input-topicType"),
                types: ['str','msg','flow','global']
            });

            $( "#node-input-option-container" ).sortable({
                axis: "y",
                handle:".node-input-option-handle",
                cursor: "move"
            });
        },
        oneditsave: function() {
            var options = $("#node-input-option-container").children();
            var node = this;
            node.options = [];
            node.formValue = {};
            options.each(function(i) {
                var option = $(this);
                var o = {
                    label: option.find(".node-input-option-label").val(),//typedInput('value'),
                    value: option.find(".node-input-option-value").val(),//typedInput('value'),
                    type: option.find(".node-input-option-type").val(),//typedInput('value')
                    required: option.find(".node-input-option-required").is(':checked'),
                    rows: parseInt(option.find(".node-input-option-rows").val())
                };
                // o.value= o.value||o.label||(o.type+"_"+i);
                node.formValue[o.value]= o.type == "checkbox" || o.type == "switch" ? false : "";
                node.options.push(o);
            });
        },
        oneditresize: function() {
            var options = $("#node-input-option-container").children();
            var newWidth = ($("#node-input-option-container").width() - 175)/2;
            var node = this;
            options.each(function(i) {
                node.resizeRule($(this),newWidth);
            });
        }
    });
</script>
<script type="text/html" data-template-name="ui_form">

<style>
.switch {
    position: relative;
    display: inline-block;
    width: 30px;
    height: 18px;
}

.switch input {display:none;}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--red-ui-tertiary-border-color, #ccc);
    -webkit-transition: .4s;
    transition: .4s;
}

.slider:before {
    position: absolute;
    content: "";
    height: 15px;
    width: 15px;
    left: 2px;
    bottom: 2px;
    background-color: var(--red-ui-secondary-background, white);
    -webkit-transition: .4s;
    transition: .4s;
}

input:checked + .slider {
    background-color: #910000;
}

input:focus + .slider {
    box-shadow: 0 0 1px #2196F3;
}

input:checked + .slider:before {
    -webkit-transform: translateX(11px);
    -ms-transform: translateX(11px);
    transform: translateX(11px);
}

/* Rounded sliders */
.slider.round {
    border-radius: 34px;
}

.slider.round:before {
    border-radius: 50%;
}
</style>

    <div class="form-row">
        <label for="node-input-group"><i class="fa fa-table"></i> <span data-i18n="ui_form.label.group"></label>
        <input type="text" id="node-input-group">
    </div>
    <div class="form-row">
        <label><i class="fa fa-object-group"></i> <span data-i18n="ui_form.label.size"></label>
        <input type="hidden" id="node-input-width">
        <input type="hidden" id="node-input-height">
        <button class="editor-button" id="node-input-size"></button>
    </div>
    <div class="form-row">
        <label for="node-input-label"><i class="fa fa-tag"></i> <span data-i18n="ui_form.label.label"></label>
        <input type="text" id="node-input-label" data-i18n="[placeholder]ui_form.label.optionalLabel">
    </div>
    <div class="form-row node-input-option-container-row" style="margin-bottom:0px; width:100%; min-width:520px">
        <label style="vertical-align:top;"><i class="fa fa-list-alt"></i> <span data-i18n="ui_form.label.formElements"></label>
        <div style="display:inline-block; width:78%; border:1px solid var(--red-ui-form-input-border-color, #ccc); border-radius:5px; box-sizing:border-box;">
          <div class="red-ui-tray-header" style="width:100%; display: inline-block; padding-top:10px; padding-bottom:10px; border-top:0px solid; border-radius:5px 5px 0 0; border-bottom:1px solid var(--red-ui-form-input-border-color, #ccc);">
              <div style="width:94%; display:inline-block; margin-left:27px">
                <div style="width:20%; text-align:center; float:left;" data-i18n="ui_form.label.label"></span></div>
                <div style="width:20%; text-align:center; float:left; margin-left:9px" data-i18n="node-red:common.label.name"></div>
                <div style="margin-left:7px; width:16%; text-align:center; float:left; margin-left:9px" data-i18n="ui_form.label.type"></div>
                <div style="width:16%; text-align:center; float:left;" data-i18n="ui_form.label.required"></div>
                <div style="width:10%; text-align:center; float:left;" data-i18n="ui_form.label.rows"></div>
                <div style="width:12%; text-align:center; float:left;" data-i18n="ui_form.label.remove"></div>
              </div>
          </div>
          <div id="node-input-option-container-div" style=" height: 257px; padding: 5px; overflow-y:scroll;">
            <ol id="node-input-option-container" style=" list-style-type:none; margin: 0;"></ol>
          </div>
        </div>
    </div>
    <div class="form-row">
        <a href="#" class="editor-button editor-button-small" id="node-input-add-option" style="margin-top: 4px; margin-left: 103px;"><i class="fa fa-plus"></i> <span data-i18n="ui_form.label.element"></span></a>
    </div>
    <div class="form-row">
        <label for="node-input-submit"><i class="fa fa-square"></i> <span data-i18n="ui_form.label.buttons"></label>
        <i class="fa fa-thumbs-o-up"></i> <input type="text" id="node-input-submit" data-i18n="[placeholder]ui_form.label.submitButtonText" style="width:35%;">
        <span style="margin-left:16px"><i class="fa fa-thumbs-o-down"></i></span>
        <input type="text" id="node-input-cancel" data-i18n="[placeholder]ui_form.label.cancelButtonText" style="width:35%;">
    </div>
    <div class="form-row">
        <label for="node-input-splitLayout"></label>
        <input type="checkbox" id="node-input-splitLayout" style="display:inline-block; width:auto; vertical-align:top;">
        <span data-i18n="ui_form.label.splitLayout">
    </div>
    <div class="form-row">
        <label for="node-input-topic"><i class="fa fa-tasks"></i> <span data-i18n="ui_form.label.topic"></label>
        <input type="text" id="node-input-topic" data-i18n="[placeholder]ui_form.label.optionalMsgTopic">
        <input type="hidden" id="node-input-topicType">
    </div>
    <div class="form-row">
        <label for="node-input-className"><i class="fa fa-code"></i>  <span data-i18n="ui_form.label.className"></label>
        <input type="text" id="node-input-className" data-i18n="[placeholder]ui_form.label.classNamePlaceholder"/>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="node-red:common.label.name"></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]node-red:common.label.name">
    </div>
</script>
<script type="text/html" data-help-name="ui_form">
    <p>Adds a form to user interface.</p>
    <p>Helps to collect multiple value from the user on submit button click as an object in <code>msg.payload</code> </p>
    <p>Multiple input elements can be added using add elements button</p>
    <p>Each element contains following components:</p>
    <ul>
        <li> <b>Label</b> : Value that will be the label of the element in the user interface</li>
        <li> <b>Name</b> : Represents the key (variable name) in the <code>msg.payload</code> in which the value of the corresponding element present</li>
        <li> <b>Type</b> : Drop down option to select the type of input element</li>
        <li> <b>Required</b> : On switching on the user has to supply the value before submitting</li>
        <li> <b>Rows</b> : number of UI rows for multiline text input</li>
        <li> <b>Delete</b> : To remove the current element from the form</li>
    </ul>
    <p>Optionally the <b>Topic</b> field can be used to set the <code>msg.topic</code> property.</p>
    <p>The Cancel button can be hidden by setting it's value to be blank "".</p>
    <p>If a <b>Class</b> is specified, it will be added to the parent card. This way you can style the card and the elements inside it with custom CSS. The Class can be set at runtime by setting a <code>msg.className</code> string property.</p>
</script>

<!-- --- [red-module:node-red-dashboard/ui_text] --- -->
<script type="text/javascript">
    const fonts = [
        {
            value: "Arial,Arial,Helvetica,sans-serif",
            name: "Arial" 
        },
        {
            value: "Arial Black,Arial Black,Gadget,sans-serif",
            name: "Arial Black" 
        },
        {
            value: "Arial Narrow,Nimbus Sans L,sans-serif",
            name: "Arial Narrow" 
        },
        {
            value: "Century Gothic,CenturyGothic,AppleGothic,sans-serif",
            name: "Century Gothic" 
        },
        {
            value: "Copperplate,Copperplate Gothic Light,fantasy",
            name: "Copperplate" 
        },
        {
            value: "Courier,monospace",
            name: "Courier" 
        },
        {
            value: "Georgia,Georgia,serif",
            name: "Georgia" 
        },
        {
            value: "Gill Sans,Geneva,sans-serif",
            name: "Gill Sans" 
        },
        {
            value: "Impact,Impact,Charcoal,sans-serif",
            name: "Impact" 
        },
        {
            value: "Lucida Sans Typewriter,Lucida Console,Monaco,monospace", 
            name: "Lucida Console" 
        },
        {
            value: "Lucida Sans Unicode,Lucida Grande,sans-serif",
            name: "Lucida Sans" 
        },
        {
            value: "Palatino Linotype,Palatino,Book Antiqua,serif", 
            name: "Palatino Linotype" 
        },
        {
            value: "Tahoma,Geneva,sans-serif",
            name: "Tahoma" 
        },
        {
            value: "Times New Roman,Times,serif",
            name: "Times New Roman" 
        },
        {
            value: "Trebuchet MS,Helvetica,sans-serif",
            name: "Trebuchet MS" 
        },
        {
            value: "Verdana,Verdana,Geneva,sans-serif",
            name: "Verdana" 
        },
    ];


    RED.nodes.registerType('ui_text',{
        category: RED._("node-red-dashboard/ui_base:ui_base.label.category"),
        color: 'rgb(119, 198, 204)',
        defaults: {
            group: {type: 'ui_group', required:true},
            order: {value: 0},
            width: {value: 0, validate: function(v) {
                    var width = v||0;
                    var currentGroup = $('#node-input-group').val()||this.group;
                    var groupNode = RED.nodes.node(currentGroup);
                    var valid = !groupNode || +width <= +groupNode.width;
                    $("#node-input-size").toggleClass("input-error",!valid);
                    return valid;
                }
            },
            height: {value: 0},
            name: {value: ''},
            label: {value: 'text'},
            format: {value: '{{msg.payload}}'},
            layout: {value:'row-spread'},
            className: {value: ''},

            style: { value: false },
            font: { value: "" },
            fontSize: { value: 16 },
            color: { value: "#000" },
        },
        inputs:1,
        outputs:0,
        align: "right",
        icon: "ui_text.png",
        paletteLabel: 'text',
        label: function() { return this.name || (~this.label.indexOf("{{") ? null : this.label) || 'text'; },
        labelStyle: function() { return this.name?"node_label_italic":""; },
        oneditprepare: function() {
            $("#node-input-size").elementSizer({
                width: "#node-input-width",
                height: "#node-input-height",
                group: "#node-input-group"
            });

            $(".nr-db-text-layout-"+(this.layout||'row-spread')).addClass('selected');

            [ ".nr-db-text-layout-row-left",".nr-db-text-layout-row-center",".nr-db-text-layout-row-right",
              ".nr-db-text-layout-row-spread",".nr-db-text-layout-col-center"].forEach(function(id) {
                    $(id).click(function(e) {
                        $(".nr-db-text-layout").removeClass('selected');
                        $(this).addClass('selected');
                        $('#node-input-layout').val(id.substring(".nr-db-text-layout-".length));
                        e.preventDefault();
                    })
              });

            const select = $("#node-select-font");
            fonts.forEach((font) => {
                var name = font.name;
                var val = font.value;
                $("<option/>", {
                    value: val,
                }).text(name).appendTo(select);
            });
            $(select).change(() => {
                const val = $("#node-select-font").val();
                $("#node-input-font").val(val);
                $("#node-test-text").css({
                    "font-family": val,
                }); 
            });
            $(select).val(this.font);
            $(select).change();

            $("#node-input-fontSize").spinner({
                min: 1,
                max: 100,
                spin: () => {
                    const val = $("#node-input-fontSize").val();
                    $("#node-test-text").css({
                        "font-size": val +"px",
                    }); 
                }
            });
            if (this.fontSize) {
                $("#node-test-text").css({
                    "font-size": this.fontSize +"px",
                }); 
            }

            $("#node-input-color").change(() => {
                const val = $("#node-input-color").val();
                $("#node-test-text").css({
                    "color": val,
                }); 
            });
            if (this.color) {
                $("#node-test-text").css({
                    "color": this.color
                }); 
            }

            $("#node-input-style").change(() => {
                const val = $("#node-input-style").prop("checked");
                if (val) {
                    $("#node-styles").show();
                }
                else {
                    $("#node-styles").hide();
                }
            });
            $("#node-input-style").change();

        }
    });
</script>

<script type="text/html" data-template-name="ui_text">
    <div class="form-row">
        <label for="node-input-group"><i class="fa fa-table"></i> Group</label>
        <input type="text" id="node-input-group">
    </div>
    <div class="form-row">
        <label><i class="fa fa-object-group"></i> Size</label>
        <input type="hidden" id="node-input-width">
        <input type="hidden" id="node-input-height">
        <button class="editor-button" id="node-input-size"></button>
    </div>
    <div class="form-row">
        <label for="node-input-label"><i class="fa fa-i-cursor"></i> Label</label>
        <input type="text" id="node-input-label">
    </div>
    <div class="form-row">
        <label for="node-input-format"><i class="fa fa-i-cursor"></i> Value format</label>
        <input type="text" id="node-input-format" placeholder="{{msg.payload}}">
    </div>
    <div class="form-row">
        <label style="vertical-align: top"><i class="fa fa-th-large"></i> Layout</label>
        <div style="display:inline-block">
        <input type="hidden" id="node-input-layout"><input type="hidden" id="node-input-layoutAlign">
        <div>
            <a href="#" class="nr-db-text-layout nr-db-text-layout-row nr-db-text-layout-row-left">
                <span class="nr-db-text-layout-label">label</span>
                <span class="nr-db-text-layout-value">value</span>
                <div class="nr-db-text-layout-checkbox"></div>
            </a>
            <a href="#" class="nr-db-text-layout nr-db-text-layout-row nr-db-text-layout-row-center">
                <span class="nr-db-text-layout-label">label</span>
                <span class="nr-db-text-layout-value">value</span>
                <div class="nr-db-text-layout-checkbox"></div>
            </a>
            <a href="#" class="nr-db-text-layout nr-db-text-layout-row nr-db-text-layout-row-right">
                <span class="nr-db-text-layout-label">label</span>
                <span class="nr-db-text-layout-value">value</span>
                <div class="nr-db-text-layout-checkbox"></div>
            </a>
        </div>
        <div>
            <a href="#" class="nr-db-text-layout nr-db-text-layout-row nr-db-text-layout-row-spread">
                <span class="nr-db-text-layout-label">label</span>
                <span class="nr-db-text-layout-value">value</span>
                <div class="nr-db-text-layout-checkbox"></div>
            </a>
            <a href="#" class="nr-db-text-layout nr-db-text-layout-col nr-db-text-layout-col-center">
                <span class="nr-db-text-layout-label">label</span>
                <span class="nr-db-text-layout-value">value</span>
                <div class="nr-db-text-layout-checkbox"></div>
            </a>
        </div>
        </div>
    </div>

    <div class="form-row">
        <label><i class="fa fa-cog"></i> Style</label>
        <input type="checkbox" id="node-input-style" style="display: inline-block; width: auto; vertical-align: top;"/>
        <label for="node-input-style" style="width: 70%;"> Apply Style</label>
    </div>

    <div id="node-styles">
        <div class="form-row">
            <label for="node-input-font"><i class="fa fa-font"></i>  Font</label>
            <select id="node-select-font">
            </select>
            <input type="hidden" id="node-input-font"/>
        </div>
        <div class="form-row">
            <label for="node-input-fontSize"><i class="fa fa-text-height"></i>  Text Size</label>
            <input id="node-input-fontSize" value="16" style="width: 50px;"/>
        </div>
        <div class="form-row">
            <label for="node-input-color"><i class="fa fa-tint"></i>  Text Color</label>
            <input type="color" id="node-input-color" style="width: 50px;"/>
        </div>
        <div class="form-row">
            <label>&nbsp;</label>
            <input id="node-test-text" value="Enter Sample Here"/ style="width: 280px;">
        </div>
    </div>

    <div class="form-row">
        <label for="node-input-className"><i class="fa fa-code"></i>  Class</label>
        <input type="text" id="node-input-className" placeholder="Optional CSS class name(s) for widget"/>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>


</script>
<style>
    .nr-db-text-layout {
        position:relative;
        display: inline-block;
        width: 90px;
        height: 60px;
        border-radius:3px;
        border:1px solid var(--red-ui-form-input-border-color, #bbb);
        cursor:pointer;
        color: #666;
        margin-right: 10px;
        margin-bottom: 10px;
    }
    .nr-db-text-layout.selected, .nr-db-text-layout:hover {
        border-color: var(--red-ui-form-input-border-selected-color, #333);
        color: var(--red-ui-secondary-text-color-selected, #333);
    }
    .nr-db-text-layout span {
        position: absolute;
    }
    .nr-db-text-layout-value {
        font-weight: bold;
    }
    .nr-db-text-layout-row span { top: 20px; }
    .nr-db-text-layout-row-left .nr-db-text-layout-label { left: 2px; }
    .nr-db-text-layout-row-left .nr-db-text-layout-value { left: 34px; }
    .nr-db-text-layout-row-spread .nr-db-text-layout-label { left: 2px; }
    .nr-db-text-layout-row-spread .nr-db-text-layout-value { right: 2px; }
    .nr-db-text-layout-row-center .nr-db-text-layout-label { left: 11px; }
    .nr-db-text-layout-row-center .nr-db-text-layout-value { right: 11px; }
    .nr-db-text-layout-row-right .nr-db-text-layout-label { right: 40px; }
    .nr-db-text-layout-row-right .nr-db-text-layout-value { right: 2px; }

    .nr-db-text-layout-col span { width: 90px;  text-align: center; left: 0px;}
    .nr-db-text-layout-col-center .nr-db-text-layout-label { top: 12px; }
    .nr-db-text-layout-col-center .nr-db-text-layout-value { top: 26px; }
    .nr-db-text-layout-checkbox {
        display: none;
        width: 10px;
        height: 10px;
        border-radius: 10px;
        border: 1px solid var(--red-ui-primary-border-color, #bbb);
        position: absolute;
        right: -5px;
        top: -5px;
        background: var(--red-ui-secondary-background, #fff);
    }
    .nr-db-text-layout.selected .nr-db-text-layout-checkbox {
        display:inline-block;
        box-shadow: inset 0px 0px 0px 2px #fff;
        background: #333;
        border-color: #333;
    }

</style>
<script type="text/html" data-help-name="ui_text">
    <p>Will display a non-editable text field on the user interface.</p>
    <p>Each received <code>msg.payload</code> will update the text based on the provided <b>Value Format</b>.</p>
    <p>The <b>Value Format</b> field can be used to change the displayed format and can contain valid HTML and
    <a href="https://scotch.io/tutorials/all-about-the-built-in-angularjs-filters" target="_blank">Angular filters</a>.</p>
    <p>For example: <code>{{value | uppercase}} &amp;deg;</code> will uppercase the payload text and add the degree symbol.</p>
    <p>The label can also be set by a message property by setting
    the field to the name of the property, for example <code>{{msg.topic}}</code>.</p>
    <p>The following icon fonts are also available: <a href="https://klarsys.github.io/angular-material-icons/" target="_blank">Material Design icon</a>
        <i>(e.g. 'check', 'close')</i> or a <a href="https://fontawesome.com/v4.7.0/icons/" target="_blank">Font Awesome icon</a>
        <i>(e.g. 'fa-fire')</i>, or a <a href="https://github.com/Paul-Reed/weather-icons-lite/blob/master/css_mappings.md">Weather icon</a>.
        You can use the full set of google material icons if you add 'mi-' to the icon name. e.g. 'mi-videogame_asset'.</p>
    <p>The widget also has a class of <code>nr-dashboard-widget-{the_widget_label_with_underscores}</code> which can be used for additional 
        styling if required. You may need to use the <i>!important</i> flag to override the theme.</p>
    <p>If a <b>Class</b> is specified, it will be added to the parent card. This way you can style the card and the elements inside it with custom CSS. The Class can be set at runtime by setting a <code>msg.className</code> string property.</p>
</script>

<!-- --- [red-module:node-red-dashboard/ui_gauge] --- -->
<style>
    input.gauge-color {
        width: 100px;
        text-align: center;
    }
    input.gauge-color::-webkit-color-swatch {
        border: none;
    }
</style>
<script type="text/javascript">
    RED.nodes.registerType('ui_gauge',{
        category: RED._("node-red-dashboard/ui_base:ui_base.label.category"),
        color: 'rgb(119, 198, 204)',
        defaults: {
            name: {value: ''},
            group: {type: 'ui_group', required: true},
            order: {value: 0},
            width: {value: 0, validate: function(v) {
                    var width = v || 0;
                    var currentGroup = $('#node-input-group').val() || this.group;
                    var groupNode = RED.nodes.node(currentGroup);
                    var valid = !groupNode || +width <= +groupNode.width;
                    $("#node-input-size").toggleClass("input-error",!valid);
                    return valid;
                }
            },
            height: {value: 0},
            gtype: {value: 'gage'},
            title: {value: 'gauge'},
            label: {value: 'units'},
            format: {value: '{{value}}'},
            min: {value: 0, required: true, validate: RED.validators.number()},
            max: {value: 10, required: true, validate: RED.validators.number()},
            colors: {value: ["#00B500","#E6E600","#CA3838"]},
            seg1: {value: ""},
            seg2: {value: ""},
            diff: {value: false},
            className: {value: ''}
        },
        inputs:1,
        outputs:0,
        inputLabels: function() { return this.min+" - "+this.max; },
        align: "right",
        icon: "ui_gauge.png",
        paletteLabel: 'gauge',
        label: function() { return this.name || (~this.title.indexOf("{{") ? null : this.title) || ((this.gtype === "gage") ? "gauge" : this.gtype) || 'gauge'; },
        labelStyle: function() { return this.name?"node_label_italic":""; },
        oneditprepare: function() {
            var setColour = function(id, value) {
                $(id).val(value);
                $(id).css("background-color", value);
                var rgb = tinycolor(value).toRgb();
                var level = ((rgb.r*299) + (rgb.g*587) + (rgb.b*114))/1000;
                var textColor = (level >= 128) ? '#111111' : '#eeeeee';
                $(id).css("color", textColor);
            }
            $(".gauge-color").on("change", function() {
                setColour("#"+$(this).attr("id"), $(this).val());
            });

            var defaultColors = ['#00B500', '#E6E600', '#CA3838'];

            if (this.colors) {
                for (var i=0; i<this.colors.length; i++) {
                    var value = this.colors[i] || defaultColors[i];
                    setColour("#node-input-color"+(i+1), value);
                }
            }
            else {
                for (var j=0; j<defaultColors.length; j++) {
                    setColour("#node-input-color"+(j+1), defaultColors[j]);
                }
            }
            if (this.gtype === undefined) {
                this.gtype = "gage";
                $("#node-input-gtype").val("gage");
            }
            $("#node-input-size").elementSizer({
                width: "#node-input-width",
                height: "#node-input-height",
                group: "#node-input-group"
            });
            $("#node-input-gtype").on("change", function() {
                if (($(this).val() === "compass") || ($(this).val() === "wave")) {
                    $("#ui-gauge-colours").hide();
                    $("#ui-gauge-segments").hide();
                }
                else {
                    $("#ui-gauge-colours").show();
                    $("#ui-gauge-segments").show();
                }
                if ($(this).val() === "gage") {
                    $("#ui-gauge-diff").show();
                }
                else { $("#ui-gauge-diff").hide(); }
            });
            $("#node-input-min").on("change", function() {
                $("#seg-min").text($(this).val());
            });
            $("#node-input-max").on("change", function() {
                $("#seg-max").text($(this).val());
            });
        },
        oneditsave: function() {
            this.colors = [$("#node-input-color1").val(),$("#node-input-color2").val(),$("#node-input-color3").val()];
        }
    });
</script>

<script type="text/html" data-template-name="ui_gauge">
    <div class="form-row">
        <label for="node-input-group"><i class="fa fa-table"></i> Group</label>
        <input type="text" id="node-input-group">
    </div>
    <div class="form-row">
        <label><i class="fa fa-object-group"></i> Size</label>
        <input type="hidden" id="node-input-width">
        <input type="hidden" id="node-input-height">
        <button class="editor-button" id="node-input-size"></button>
    </div>
    <div class="form-row">
        <label for="node-input-gtype"><i class="fa fa-list"></i> Type</label>
        <select id="node-input-gtype" style="width:150px">
            <option value="gage">Gauge</option>
            <option value="donut">Donut</option>
            <option value="compass">Compass</option>
            <option value="wave">Level</option>
        </select>
    </div>
    <div id="ui-gauge-labels">
        <div class="form-row">
            <label for="node-input-title"><i class="fa fa-i-cursor"></i> Label</label>
            <input type="text" id="node-input-title">
        </div>
        <div class="form-row" id="ui-gauge-format">
            <label for="node-input-format"><i class="fa fa-i-cursor"></i> Value format</label>
            <input type="text" id="node-input-format" placeholder="{{value}}">
        </div>
        <div class="form-row" id="ui-gauge-units">
            <label for="node-input-label"><i class="fa fa-i-cursor"></i> Units</label>
            <input type="text" id="node-input-label" placeholder="optional sub-label">
        </div>
    </div>
    <div class="form-row">
        <label for="node-input-min">Range</label>
        <span for="node-input-min">min</span>
        <input type="text" id="node-input-min" style="width:80px">
        <span for="node-input-max" style="margin-left:20px;">max</span>
        <input type="text" id="node-input-max" style="width:80px">
    </div>
    <div class="form-row" id="ui-gauge-colours">
        <label for="node-input-color1">Colour gradient</label>
        <input type="color" id="node-input-color1" class="gauge-color" style="width:100px;"/>
        <input type="color" id="node-input-color2" class="gauge-color" style="width:100px;"/>
        <input type="color" id="node-input-color3" class="gauge-color" style="width:100px;"/>
    </div>
    <div class="form-row" id="ui-gauge-segments">
        <label>Sectors</label>
        <span id="seg-min" style="display:inline-block; width:40px;">0</span>...
        <input type="text" id="node-input-seg1" style="text-align:center; width:87px;" placeholder="optional"> ...
        <input type="text" id="node-input-seg2" style="text-align:center; width:87px;" placeholder="optional"> ...
        <span id="seg-max" style="display:inline-block; width:40px; text-align:right">10</span>
    </div>
    <div class="form-row" id="ui-gauge-diff">
        <label></label> Fill gauge from centre.
        <input type="checkbox" id="node-input-diff" style="display:inline-block; width:auto; vertical-align:top;">
    </div>
    <div class="form-row">
        <label for="node-input-className"><i class="fa fa-code"></i>  Class</label>
        <input type="text" id="node-input-className" placeholder="Optional CSS class name(s) for widget"/>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>
</script>
<script type="text/html" data-help-name="ui_gauge">
    <p>Adds a gauge type widget to the user interface.</p>
    <p>The <code>msg.payload</code> is searched for a numeric <i>value</i> and is formatted in accordance with
    the defined <b>Value Format</b>, which can then be formatted using
    <a href="https://docs.angularjs.org/api/ng/filter" target="_blank">Angular filters</a>.</p>
    <p>For example : <code>{{value | number:1}}%</code> will round the value to one decimal place and append a % sign.</p>
    <p>The colours of each of 3 sectors can be specified and the gauge will blend between them.
    The colours should be specified in hex (#rrggbb) format.</p>
    <p>If you specify numbers for the sectors then the colours changes per sector.
    If not specified the colours are blended across the total range.</p>
    <p>The gauge has several modes. Regular gauge, donut, compass and wave.</p>
    <p>The label can also be set by a message property by setting
    the field to the name of the property, for example <code>{{msg.topic}}</code>.</p>
    <p>If a <b>Class</b> is specified, it will be added to the parent card. This way you can style the card and the elements inside it with custom CSS. The Class can be set at runtime by setting a <code>msg.className</code> string property.</p>
</script>

<!-- --- [red-module:node-red-dashboard/ui_chart] --- -->
<style>
    input.series-color {
        width: 100px;
        text-align: center;
    }
    input.series-color::-webkit-color-swatch {
        border: none;
    }
</style>
<script type="text/javascript">
    RED.nodes.registerType('ui_chart',{
        category: RED._("node-red-dashboard/ui_base:ui_base.label.category"),
        color: 'rgb(119, 198, 204)',
        defaults: {
            name: {value: ''},
            group: {type: 'ui_group', required: true},
            order: {value: 0},
            width: {value: 0, validate: function(v) {
                    var width = v||0;
                    var currentGroup = $('#node-input-group').val()||this.group;
                    var groupNode = RED.nodes.node(currentGroup);
                    var valid = !groupNode || +width <= +groupNode.width;
                    $("#node-input-size").toggleClass("input-error",!valid);
                    return valid;
                }},
            height: {value: 0},
            label: {value: 'chart'},
            chartType: {value: 'line'},
            legend: {value: 'false'},
            xformat: {value: 'HH:mm:ss'},
            interpolate: {value: 'linear', required:true},
            nodata: {value: ''},
            dot: {value: false},
            ymin: {value: '', validate:function(value) { return value === '' || RED.validators.number(); }},
            ymax: {value: '', validate:function(value) { return value === '' || RED.validators.number(); }},
            removeOlder: {value: 1, validate:RED.validators.number(), required:true},
            removeOlderPoints: {value: '', validate:function(value) { return value === '' || RED.validators.number(); }},
            removeOlderUnit: {value: '3600', required:true},
            cutout: {value: 0},
            useOneColor: {value: false},
            useUTC: {value: false},
            colors: {value: ['#1F77B4', '#AEC7E8', '#FF7F0E', '#2CA02C', '#98DF8A', '#D62728', '#FF9896', '#9467BD', '#C5B0D5']},
            outputs: {value: 1},
            useDifferentColor: {value: false},
            className: {value: ''}
        },
        inputs:1,
        outputs:1,
        inputLabels: function() { return this.chartType; },
        outputLabels: ["chart state"],
        align: "right",
        icon: "ui_chart.png",
        paletteLabel: 'chart',
        label: function() { return this.name || (~this.label.indexOf("{{") ? null : this.label) || 'chart'; },
        labelStyle: function() { return this.name?"node_label_italic":""; },
        oneditprepare: function() {
            var oldouts = this.outputs;
            if (RED.nodes.filterLinks({source:{id:this.id},sourcePort:1}).length > 0) { this.outputs = 2; }
            else { this.outputs = 1; }
            if (this.outputs !== oldouts) { this.changed = true; }
            if (!$("#node-input-chartType").val()) {
                $("#node-input-chartType").val("line");
            }
            $("#node-input-size").elementSizer({
                width: "#node-input-width",
                height: "#node-input-height",
                group: "#node-input-group"
            });
            $("#node-input-chartType").on("change", function() {
                $("#legend-show").hide();
                $("#show-useDifferentColor").hide();
                if ($(this).val() === "horizontalBar") {
                    $("#y-label-show").hide();
                    $("#x-label-show").show();
                }
                else {
                    $("#y-label-show").show();
                    $("#x-label-show").hide();
                }
                if ($(this).val() === "line") {
                    $("#x-axis-show").show();
                    $("#x-axis-label-show").show();
                    $("#interpolate-show").show();
                    $("#legend-show").show();
                    $("#y-axis-show").show();
                    $("#hole-size-show").hide();
                    $("#show-dot-field").show();
                    $("#show-useOneColor").hide();
                }
                else {
                    $("#x-axis-show").hide();
                    $("#x-axis-label-show").hide();
                    $("#interpolate-show").hide();
                    $("#show-dot-field").hide();
                    if (($(this).val() === "bar")||($(this).val() === "horizontalBar")) {
                        $("#show-useOneColor").show();
                        $("#legend-show").show();
                    }
                    else {
                        $("#show-useOneColor").hide();
                    }
                    if ($(this).val() === "pie") {
                        $("#y-axis-show").hide();
                        $("#legend-show").show();
                        $("#hole-size-show").show();
                    }
                    else if ($(this).val() === "polar-area") {
                        $("#y-axis-show").show();
                        $("#legend-show").show();
                        $("#hole-size-show").hide();
                        $("#show-useDifferentColor").show();
                    }
                    else if ($(this).val() === "radar") {
                        $("#y-axis-show").show();
                        $("#legend-show").show();
                        $("#hole-size-show").hide();
                    }
                    else {
                        $("#y-axis-show").show();
                        $("#hole-size-show").hide();
                    }
                }

            });
            var setColour = function(id, value) {
                $(id).val(value);
                $(id).css("background-color", value);
                var rgb = tinycolor(value).toRgb();
                var level = ((rgb.r*299) + (rgb.g*587) + (rgb.b*114))/1000;
                var textColor = (level >= 128) ? '#111111' : '#eeeeee';
                $(id).css("color", textColor);
            }
            $(".series-color").on("change", function() {
                setColour("#"+$(this).attr("id"), $(this).val());
            });
            var oval = $("#node-input-xformat").val();
            if (!oval) { $("#node-input-xformat").val("HH:mm:ss"); }
            var odef = 'custom';
            if (oval === "HH:mm:ss") { odef = oval; }
            if (oval === "HH:mm") { odef = oval; }
            if (oval === "Y-M-D") { odef = oval; }
            if (oval === "D/M") { odef = oval; }
            if (oval === "dd HH:mm") { odef = oval; }
            if (oval === "auto") { odef = oval; }
            var ohms = {value: "HH:mm:ss", label: RED._("node-red-dashboard/ui_chart:ui_chart.label.HHmmss"), hasValue: false};
            var ohm = {value: "HH:mm", label: RED._("node-red-dashboard/ui_chart:ui_chart.label.HHmm"), hasValue: false};
            var oymd = {value: "Y-M-D", label: RED._("node-red-dashboard/ui_chart:ui_chart.label.yearMonthDate"), hasValue: false};
            var odm = {value: "D/M", label: RED._("node-red-dashboard/ui_chart:ui_chart.label.dateMonth"), hasValue: false};
            var oahm = {value: "dd HH:mm", label: RED._("node-red-dashboard/ui_chart:ui_chart.label.dayHHmm"), hasValue: false};
            var ocus = {value: "custom", label: RED._("node-red-dashboard/ui_chart:ui_chart.label.custom"), icon: "red/images/typedInput/az.png"};
            var oaut = {value: "auto", label: RED._("node-red-dashboard/ui_chart:ui_chart.label.automatic"), hasValue: false};
            $("#node-input-xformat").typedInput({
                default: odef,
                types:[ ohms, ohm, oahm, odm, oymd, ocus, oaut ]
            });
            var defaultColors = ['#1F77B4', '#AEC7E8', '#FF7F0E', '#2CA02C', '#98DF8A', '#D62728', '#FF9896', '#9467BD', '#C5B0D5'];

            if (this.colors) {
                for (var i=0; i<this.colors.length; i++) {
                    var value = this.colors[i] || defaultColors[i];
                    setColour("#node-input-color"+(i+1), value);
                }
            }
            else {
                for (var c=0; c<defaultColors.length; c++) {
                    setColour("#node-input-color"+(c+1), defaultColors[c]);
                }
            }

        },
        oneditsave: function() {
            if ($("#node-input-xformat").typedInput('type') !== 'custom') {
                $("#node-input-xformat").val($("#node-input-xformat").typedInput('type'));
            }
            this.colors = [$("#node-input-color1").val(),$("#node-input-color2").val(),$("#node-input-color3").val(),
            $("#node-input-color4").val(),$("#node-input-color5").val(),$("#node-input-color6").val(),
            $("#node-input-color7").val(),$("#node-input-color8").val(),$("#node-input-color9").val()];
        }
    });
</script>

<script type="text/html" data-template-name="ui_chart">
    <div class="form-row">
        <label for="node-input-group"><i class="fa fa-table"></i> <span data-i18n="ui_chart.label.group"></label>
        <input type="text" id="node-input-group">
    </div>
    <div class="form-row">
        <label><i class="fa fa-object-group"></i> <span data-i18n="ui_chart.label.size"></label>
        <input type="hidden" id="node-input-width">
        <input type="hidden" id="node-input-height">
        <button class="editor-button" id="node-input-size"></button>
    </div>
    <div class="form-row">
        <label for="node-input-label"><i class="fa fa-i-cursor"></i> <span data-i18n="ui_chart.label.label"></label>
        <input type="text" id="node-input-label" data-i18n="[placeholder]ui_chart.label.optionalChartTitle">
    </div>
    <div class="form-row">
        <label for="node-input-removeOlder"><i class="fa fa-line-chart"></i> <span data-i18n="ui_chart.label.type"></label>
        <select id="node-input-chartType" style="width:159px; font-family:'FontAwesome','Helvetica Neue', Helvetica, Arial, sans-serif">
            <option value="line" data-i18n="[html]ui_chart.label.lineChart"></option>
            <option value="bar" data-i18n="[html]ui_chart.label.barChart"></option>
            <option value="horizontalBar" data-i18n="[html]ui_chart.label.barChartH"></option>
            <option value="pie" data-i18n="[html]ui_chart.label.pieChart"></option>
            <option value="polar-area" data-i18n="[html]ui_chart.label.polarAreaChart"></option>
            <option value="radar" data-i18n="[html]ui_chart.label.radarChart"></option>
        </select>
        <div id="show-dot-field" style="display:inline-block;">
            <input type="checkbox" id="node-input-dot" style="display:inline-block; width:auto; vertical-align:baseline; margin-left:40px; margin-right:5px;"><span data-i18n="ui_chart.label.enlargePoints">
        </div>
    </div>
    <div class="form-row" id="x-axis-show">
        <label for="node-input-removeOlder" data-i18n="ui_chart.label.xAxis"></label>
        <label for="node-input-removeOlder" style="width:auto" data-i18n="ui_chart.label.last"></label>
        <input type="text" id="node-input-removeOlder" style="width:50px;">
        <select id="node-input-removeOlderUnit" style="width:80px;">
            <option value="1" data-i18n="ui_chart.label.seconds"></option>
            <option value="60" data-i18n="ui_chart.label.minutes"></option>
            <option value="3600" data-i18n="ui_chart.label.hours"></option>
            <option value="86400" data-i18n="ui_chart.label.days"></option>
            <option value="604800" data-i18n="ui_chart.label.weeks"></option>
        </select>
        <label for="node-input-removeOlderPoints" style="width:auto; margin-left:10px; margin-right:10px;" data-i18n="ui_chart.label.or"></label>
        <input type="text" id="node-input-removeOlderPoints" style="width:60px;" placeholder="1000">
        <span style="margin-left:5px;" data-i18n="ui_chart.label.points"></span>
    </div>
    <div class="form-row" id="x-axis-label-show">
        <label for="node-input-xformat" data-i18n="ui_chart.label.xAxisLabel"></label>
        <input type="text" id="node-input-xformat" style="width:250px;">
        <input type="checkbox" id="node-input-useUTC" style="display:inline-block; width:auto; vertical-align:baseline; margin-left:8px; margin-right:4px;"> <span data-i18n="ui_chart.label.asUTC"></span>
    </div>
    <div class="form-row" id="y-axis-show">
        <label id="y-label-show" for="node-input-ymin" data-i18n="ui_chart.label.yAxis"></label>
        <label id="x-label-show" for="node-input-ymin" data-i18n="ui_chart.label.xAxis"></label>
        <label for="node-input-ymin" style="width:auto" data-i18n="ui_chart.label.min"></label>
        <input type="text" id="node-input-ymin" style="width:92px">
        <label for="node-input-ymax" style="width:auto; margin-left:20px;" data-i18n="ui_chart.label.max"></label>
        <input type="text" id="node-input-ymax" style="width:92px">
    </div>
    <div class="form-row" id="legend-show">
        <label for="node-input-legend" data-i18n="ui_chart.label.legend"></label>
        <select id="node-input-legend" style="width:120px;">
            <option value="false" data-i18n="ui_chart.label.none"></option>
            <option value="true" data-i18n="ui_chart.label.show"></option>
        </select>
        <span id="interpolate-show">&nbsp;&nbsp;&nbsp;&nbsp;<span data-i18n="ui_chart.label.interpolate"></span>
            <select id="node-input-interpolate" style="width:120px;">
                <option value="linear" data-i18n="ui_chart.label.linear"></option>
                <option value="step" data-i18n="ui_chart.label.step"></option>
                <option value="bezier" data-i18n="ui_chart.label.bezier"></option>
                <option value="cubic" data-i18n="ui_chart.label.cubic"></option>
                <option value="monotone" data-i18n="ui_chart.label.cubicMono"></option>
            </select>
        </span>
        <span id="hole-size-show">&nbsp;&nbsp;&nbsp;&nbsp;<span data-i18n="ui_chart.label.cutout"></span>
            <input type="text" id="node-input-cutout" style="width:35px"> %
        </span>
    </div>
    <div id="show-useOneColor" style="display:none; height:24px;">
        <input type="checkbox" id="node-input-useOneColor" style="display:inline-block; width:auto; vertical-align:baseline; margin-left:105px; margin-right:5px;"><span data-i18n="ui_chart.label.useFirstColourForAllBars"></span>
    </div>
    <div class="form-row" id="ui-chart-colours">
        <label for="node-input-color1" data-i18n="ui_chart.label.seriesColours"></label>
        <input type="color" id="node-input-color1" class="series-color" style="width:100px;"/>
        <input type="color" id="node-input-color2" class="series-color" style="width:100px;"/>
        <input type="color" id="node-input-color3" class="series-color" style="width:100px;"/>
        <div style="margin-top:5px; margin-left:104px;">
            <input type="color" id="node-input-color4" class="series-color" style="width:100px;"/>
            <input type="color" id="node-input-color5" class="series-color" style="width:100px;"/>
            <input type="color" id="node-input-color6" class="series-color" style="width:100px;"/>
        </div>
        <div style="margin-top:5px; margin-left:104px;">
            <input type="color" id="node-input-color7" class="series-color" style="width:100px;"/>
            <input type="color" id="node-input-color8" class="series-color" style="width:100px;"/>
            <input type="color" id="node-input-color9" class="series-color" style="width:100px;"/>
        </div>
    </div>
    <div id="show-useDifferentColor" class="form-row">
         <label></label>
         <input type="checkbox" id="node-input-useDifferentColor" style="display:inline-block; width:auto; vertical-align:top;">
             <span data-i18n="ui_chart.label.useDifferentColor"></span>
         </input>
    </div>
    <div class="form-row">
        <label for="node-input-nodata" data-i18n="ui_chart.label.blankLabel"></label>
        <input type="text" id="node-input-nodata" data-i18n="[placeholder]ui_chart.label.displayThisTextBeforeValidDataArrives">
    </div>
    <div class="form-row">
        <label for="node-input-className"><i class="fa fa-code"></i>  <span data-i18n="ui_chart.label.className"></span></label>
        <input type="text" id="node-input-className" data-i18n="[placeholder]ui_chart.label.classNamePlaceholder"/>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="node-red:common.label.name"></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]node-red:common.label.name">
    </div>
</script>
<script type="text/html" data-help-name="ui_chart">
    <p>Plots the input values on a chart. This can either be a time based line chart, a bar chart (vertical or horizontal),
    or a pie chart.</p>
    <p>Each input <code>msg.payload</code> value will be converted to a number. If the
    conversion fails, the message is ignored.</p>
    <p>Minimum and Maximum <b>Y</b> axis values are optional. The graph will auto-scale to any values received.</p>
    <p>Multiple series can be shown on the same chart by using a different <code>msg.topic</code>
    value on each input message. Multiple bars of the same series can be shown by using the <code>msg.label</code> property.</p>
    <p>The <b>X</b> axis defines a time window or a maximum number of points to display. Older data will be automatically removed from the graph.
    The axis labels can be formatted using a <a href="https://momentjs.com/docs/#/displaying/format/" target="_blank">
    Moment.js time formatted</a> string.</p>
    <p>Inputting a <code>msg.payload</code> containing a blank array <code>[]</code> will clear the chart.</p>
    <p>See <b><a href="https://github.com/node-red/node-red-dashboard/blob/master/Charts.md" target="_new">this information</a></b>
    for how to pre-format data to be passed in as a complete chart.</p>
    <p>The <b>Blank label</b> field can be used to display some text before any valid data is received.</p>
    <p>The label can also be set by a message property by setting
    the field to the name of the property, for example <code>{{msg.topic}}</code>.</p>
    <p>The node output contains an array of the chart state that can be persisted if needed. This can be passed
    into the chart node to re-display the persisted data.</p>
    <p>If a <b>Class</b> is specified, it will be added to the parent card. This way you can style the card and the elements inside it with custom CSS. The Class can be set at runtime by setting a <code>msg.className</code> string property.</p>
</script>

<!-- --- [red-module:node-red-dashboard/ui_audio] --- -->
<!DOCTYPE html>

<script type="text/javascript">
(function() {
    var myvoice = 0;
    var voices;
    RED.nodes.registerType('ui_audio',{
        category: RED._("node-red-dashboard/ui_base:ui_base.label.category"),
        paletteLabel: 'audio out',
        color: 'rgb(119, 198, 204)',
        defaults: {
            name: {value:""},
            group: {type: 'ui_group', required: true},
            voice: {value:""},
            always: {value:""}
        },
        inputs:1,
        outputs:0,
        icon: "feed.png",
        align: "right",
        label: function() { return this.name||"audio out"; },
        labelStyle: function() { return this.name?"node_label_italic":""; },
        onpaletteadd: function() {
            if ('speechSynthesis' in window) { voices = window.speechSynthesis.getVoices(); }
        },
        oneditprepare: function() {
            if ('speechSynthesis' in window) {
                voices = window.speechSynthesis.getVoices();
                for (i = 0; i < voices.length ; i++) {
                    //console.log(i,voices[i].name,voices[i].lang,voices[i].voiceURI,voices[i].default);
                    var option = document.createElement('option');
                    option.textContent = i + " : " + voices[i].name + ' (' + voices[i].lang + ')';
                    if (voices[i].default) { option.textContent += ' -- DEFAULT'; }
                    option.setAttribute('value', voices[i].voiceURI);
                    document.getElementById("node-input-voice").appendChild(option);
                }
                $('#node-input-voice').val(this.voice || 0);
            }
            else {
                $('#voice-input-row').hide();
            }

            $("#node-input-voice").on("change", function() {
                myvoice = this.voice = $("#node-input-voice").val();
            });
        }
    });
})();
</script>

<script type="text/html" data-template-name="ui_audio">
    <div class="form-row">
        <label for="node-input-group"><i class="fa fa-table"></i> Group</label>
        <input type="text" id="node-input-group">
    </div>
    <div class="form-row" id="voice-input-row">
        <label for="node-input-voice"><i class="fa fa-language"></i> TTS Voice</label>
        <select id="node-input-voice" style="width:70%"></select>
    </div>
    <div class="form-row">
        <label for="node-input-always"></label>
        <input type="checkbox" checked id="node-input-always" style="display:inline-block; width:auto; vertical-align:top;">
        Play audio when window not in focus.
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>
<script type="text/html" data-help-name="ui_audio">
    <p>Plays audio or text to speech (TTS) in the dashboard.</p>
    <p>To work the dashboard web page must be open.</p>
    <p>Expects <code>msg.payload</code> to contain a buffer of a <b>wav</b> or <b>mp3</b> file.</p>
    <p>If your browser has native support for Text-to-Speech then a <code>msg.payload</code>
    can also be a <b>string</b> to be read aloud.</p>
    <p>Optionally setting <code>msg.level</code> from 0 to 100 will change the volume from 0 to 100%. Default is 100%.
    In audio mode you can go up to 300, but you may get distortion.</p>
    <p>When a <code>msg.reset</code> is available with value <code>true</code>, then playback of the current audio fragment will be stopped.</p>
    <p>The <b>node status</b> reflects the current playback status:
    <ul>
        <li><b>started:</b> the audio fragment playback has been started.</li>
        <li><b>reset:</b> the audio fragment playback has been reset (i.e. stopped before completed).</li>
    </ul>
    As soon as the audio fragment playback is completed, the node status will be cleared automatically.</p>
</script>

<!-- --- [red-module:node-red-dashboard/ui_toast] --- -->
<script type="text/javascript">
    RED.nodes.registerType('ui_toast', {
        category: RED._("node-red-dashboard/ui_base:ui_base.label.category"),
        color: 'rgb(119, 198, 204)',
        defaults: {
            position: {value: 'top right'},
            displayTime: {value: '3'},
            highlight: {value: ''},
            sendall: {value: true},
            outputs: {value: 0},
            ok: {value: 'OK', required: true},
            cancel: {value: ''},
            raw: {value: false},
            className: {value: ''},
            topic: {value: ''},
            name: {value: ''}
        },
        inputs:1,
        outputs:0,
        align: "right",
        icon: "ui_toast.png",
        paletteLabel: 'notification',
        label: function() { return this.name || (this.position==="prompt" ? "show dialog" : (this.position==="dialog" ? "show dialog" : "show notification")); },
        labelStyle: function() { return this.name?"node_label_italic":""; },
        oneditprepare: function() {
            $("#node-input-position").on("change", function() {
                if ($("#node-input-position option:selected").val() === 'dialog') {
                    $("#node-toast-displaytime").hide();
                    $("#node-toast-highlightcolor").hide();
                    $("#node-toast-sendall").hide();
                    $("#node-dialog-displayok").show();
                    $("#node-dialog-displaycancel").show();
                    $("#node-dialog-topic").show();
                }
                else if ($("#node-input-position option:selected").val() === 'prompt') {
                    $("#node-toast-displaytime").hide();
                    $("#node-toast-highlightcolor").hide();
                    $("#node-toast-sendall").hide();
                    $("#node-dialog-displayok").show();
                    $("#node-dialog-displaycancel").show();
                    $("#node-dialog-topic").show();
                    if (typeof $("#node-input-cancel").val() !== "string" || $("#node-input-cancel").val() === "" ) {
                        $("#node-input-cancel").val("Cancel");
                    }
                }
                else {
                    $("#node-toast-displaytime").show();
                    $("#node-toast-highlightcolor").show();
                    $("#node-toast-sendall").show();
                    $("#node-dialog-displayok").hide();
                    $("#node-dialog-displaycancel").hide();
                    $("#node-dialog-topic").show();
                }
            });
        },
        oneditsave: function() {
            if ($("#node-input-position option:selected").val() === 'dialog') { this.outputs = 1; }
            else if ($("#node-input-position option:selected").val() === 'prompt') { this.outputs = 1; }
            else { this.outputs = 0; }
        }
    });
</script>

<script type="text/html" data-template-name="ui_toast">
    <div class="form-row">
        <label for="node-input-position"><i class="fa fa-th-large"></i> Layout</label>
        <select type="text" id="node-input-position" style="display:inline-block; width:70%; vertical-align:baseline;">
            <option value="top right">Top Right</option>
            <option value="bottom right">Bottom Right</option>
            <option value="top left">Top Left</option>
            <option value="bottom left">Bottom Left</option>
            <option value="dialog">OK / Cancel Dialog</option>
            <option value="prompt">OK / Cancel Dialog with Input</option>
        </select>
    </div>
    <div class="form-row" id="node-toast-displaytime">
        <label for="node-input-displayTime"><i class="fa fa-clock-o"></i> Timeout (S)</label>
        <input type="text" id="node-input-displayTime" placeholder="[msg.timeout]">
    </div>
    <div class="form-row" id="node-toast-highlightcolor">
        <label for="node-input-highlight"><i class="fa fa-square-o"></i> Border</label>
        <input type="text" id="node-input-highlight" placeholder="(optional) border highlight colour">
    </div>
    <div class="form-row" id="node-toast-sendtoall">
        <label style="width:auto" for="node-input-sendall"><i class="fa fa-arrow-right"></i> Send to all browser sessions. </label>
        <input type="checkbox" checked id="node-input-sendall" style="display:inline-block; width:auto; vertical-align:baseline;">
    </div>
    <div class="form-row" id="node-dialog-displayok">
        <label for="node-input-ok"><i class="fa fa-check"></i> Default action label</label>
        <input type="text" id="node-input-ok" placeholder="label for OK button">
    </div>
    <div class="form-row" id="node-dialog-displaycancel">
        <label for="node-input-cancel"><i class="fa fa-times"></i> Secondary action label</label>
        <input type="text" id="node-input-cancel" placeholder="(optional label for Cancel button)">
    </div>
    <div class="form-row" id="node-toast-raw">
        <label style="width:auto" for="node-input-raw"><i class="fa fa-exclamation-triangle"></i> Accept raw HTML/JavaScript input in msg.payload to format popup.</label>
        <input type="checkbox" id="node-input-raw" style="display:inline-block; width:auto; vertical-align:baseline;">
    </div>
    <div class="form-row" id="node-dialog-className">
        <label for="node-input-className"><i class="fa fa-code"></i> Class</label>
        <input type="text" id="node-input-className" placeholder="[msg.className]">
    </div>
    <div class="form-row" id="node-dialog-topic">
        <label for="node-input-topic"><i class="fa fa-tasks"></i> Topic</label>
        <input type="text" id="node-input-topic" placeholder="[msg.topic]">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-tips"><b>Note</b>: checking <i>Accept raw HTML/JavaScript</i> can allow injection of code.
    Ensure the input comes from trusted sources.</span></div>
</script>
<script type="text/html" data-help-name="ui_toast">
    <p>Shows <code>msg.payload</code> as a popup notification or OK / Cancel dialog
    message on the user interface.</p>
    <p>If a <code>msg.topic</code> is available it will be used as the title.</p>
    <p>If you do not set an optional border highlight colour, then it can be set dynamically by <code>msg.highlight</code>.</p>
    <p>You may also configure the position and duration of the toast notifications. If you leave the timeout blank
    it can be set by <code>msg.timeout</code>. This does not apply to OK/Cancel dialogs.
    <p>The dialog returns a <code>msg.payload</code> string of whatever you configure
    the button label(s) to be. The second (cancel) button is optional, as is the return
    value of <code>msg.topic</code>.</p>
    <p>If you select 'OK, Cancel and Input' mode then <code>msg.payload</code> will contain
    any text input by the user, rather than the OK button text.</p>
    <p>The OK and Cancel button labels can be replaced by using <code>msg.ok</code> and <code>msg.cancel</code></p>
    <p>Sending a blank payload will remove any active dialog without sending any data.</p>
    <p>If a <b>Class</b> is specified, it will be added to the parent element. This way you can style the card and the elements inside it with custom CSS.</p>
</script>

<!-- --- [red-module:node-red-dashboard/ui_ui_control] --- -->
<script type="text/javascript">
(function () {
    // convert to i18 text
    function c_(x) {
        return RED._("node-red-dashboard/ui_ui_control:ui_ui_control."+x);
    }

    RED.nodes.registerType('ui_ui_control', {
        category: RED._("node-red-dashboard/ui_base:ui_base.label.category"),
        color: 'rgb( 63, 173, 181)',
        defaults: {
            name: {value:""},
            events: {value:"all"}
        },
        inputs:1,
        outputs:1,
        align: "right",
        icon: "ui_link.png",
        paletteLabel: 'ui control',
        label: function() { return this.name || "ui control"; },
        labelStyle: function() { return this.name?"node_label_italic":""; },
        outputLabels: function() { return this.events; },
        oneditprepare: function() {
            var node = this;
            var sel = $("#node-input-events");
            for (var name of ["all", "change", "connect"]) {
                var text = c_("events."+name);
                $("<option/>").val(name).text(text).appendTo(sel);
            }
            $(sel).val(node.events);
        },
    });
})();
</script>

<script type="text/html" data-template-name="ui_ui_control">
    <div class="form-row">
        <label for="node-input-events"><i class="fa fa-sign-out"></i> <span data-i18n="ui_ui_control.label.output"></span></label>
        <select id="node-input-events" style="width:70%;">
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="ui_ui_control.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]ui_ui_control.placeholder.name">
    </div>
</script>
<script type="text/html" data-help-name="ui_ui_control">
    <p>Allows dynamic control of the Dashboard.</p>
    <p>The default function is to change the currently displayed tab. <code>msg.payload</code>
    should either be an object of the form <code>{"tab":"my_tab_name"}</code>, or just be the <b>tab name</b>
    or <b>numeric index</b> (from 0) of the tab or link to be displayed.</p>
    <p>Sending a blank tab name "" will refresh the current page.
    You can also send "+1" for next tab and "-1" for previous tab.</p>
    <p>Dashboard pages (i.e. "tabs") can be controlled by sending a <code>msg.payload</code> object with the format
    <pre>{"tabs": {"hide": "tab_name_to_hide", "disable": ["secret_tab", "unused_stuff"]}}</pre>.
    There are 2 toggle states available: <b>show</b>/<b>hide</b> and <b>enable</b>/<b>disable</b></p>
    <p>Visibility of individual groups of widgets can controlled by a payload like
    <pre>{"group": {"hide": ["tab_name_group_name_with_underscores"], "show": ["reveal_another_group"], "focus": true}}</pre>
    where <b>focus</b> is optional and will cause the screen to scroll to show that group if required. 
    You can also use properties `open` and `close` to set the state of a group that can be controlled by the user. The group
    names are the IDs of the groups and are typically formed from the <i>tab name</i> plus <i>group name</i> joined with
    underscores replacing all spaces.</p>
    <p>When any browser client connects or loses connection, changes tab, or expands or collapses a group this node will emit a <code>msg</code> containing:</p>
    <ul>
    <li><code>payload</code> - <i>connect</i>, <i>lost</i>, <i>change</i>, or <i>group</i>.
    <li><code>socketid</code> - the ID of the socket (this will change every time the browser reloads the page).
    <li><code>socketip</code> - the ip address from where the connection originated.
    <li><code>tab</code> - the number of the tab. (only for 'change' event).
    <li><code>name</code> - the name of the tab. (only for 'change' event).
    <li><code>group</code> - the name of the group. (only for 'group' event).
    <li><code>open</code> - the state of the group. (only for 'group' event).
    </ul>
    <p>Optional - report only connect events - useful to use to trigger a resend of data to a new client without needing to filter out other events.</p>
</script>

<!-- --- [red-module:node-red-dashboard/ui_template] --- -->
<script type="text/javascript">
    // convert to i18 text
    function c_(x) {
        return RED._("node-red-dashboard/ui_template:ui_template."+x);
    }

    RED.nodes.registerType('ui_template',{
        category: RED._("node-red-dashboard/ui_base:ui_base.label.category"),
        color: 'rgb( 63, 173, 181)',
        defaults: {
            group: {type: 'ui_group', required:false},
            name: {value: ''},
            order: {value: 0},
            width: {value: 0, validate: function(v) {
                    var valid = true
                    if (this.templateScope !== 'global') {
                        var width = v||0;
                        var currentGroup = $('#node-input-group').val()||this.group;
                        var groupNode = RED.nodes.node(currentGroup);
                        valid = !groupNode || +width <= +groupNode.width;
                        $("#node-input-size").toggleClass("input-error",!valid);
                    }
                    return valid;
                }},
            height: {value: 0},
            format: {value: '<div ng-bind-html="msg.payload"></div>'},
            storeOutMessages: {value: true},
            fwdInMessages: {value: true},
            resendOnRefresh: {value: true},
            templateScope: {value: 'local'},
            className: {value: ''}
        },
        inputs:1,
        outputs:1,
        icon: "ui_template.png",
        paletteLabel: 'template',
        label: function() { return this.name || 'template'; },
        labelStyle: function() { return this.name?"node_label_italic":""; },
        oneditprepare: function() {
            if (RED.editor.hasOwnProperty("editText") && typeof RED.editor.editText === "function") {
                $("#node-template-expand-editor").show();
            }
            else {
                $("#node-template-expand-editor").hide();
            }
            var that = this;
            $("#node-input-size").elementSizer({
                width: "#node-input-width",
                height: "#node-input-height",
                group: "#node-input-group"
            });

            if (typeof this.storeOutMessages === 'undefined') {
                this.storeOutMessages = true;
                $('#node-input-storeOutMessages').prop('checked', true);
            }

            if (typeof this.fwdInMessages === 'undefined') {
                this.fwdInMessages = true;
                $('#node-input-fwdInMessages').prop('checked', true);
            }

            if (typeof this.templateScope === 'undefined') {
                this.templateScope = 'local';
                $('#node-input-templateScope').val(this.templateScope);
            }

            $('#node-input-templateScope').on('change', function() {
                if ($('#node-input-templateScope').val() === 'global') {
                    $('#template-row-group, #template-row-size, #template-pass-store, #template-row-class').hide();
                    that._def.defaults.group.required = false;
                }
                else {
                    $('#template-row-group, #template-row-size, #template-pass-store, #template-row-class').show();
                    that._def.defaults.group.required = true;
                }

                var rows = $("#dialog-form>div:not(.node-text-editor-row)");
                var height = $("#dialog-form").height();
                for (var i=0; i<rows.size(); i++) {
                    height = height - $(rows[i]).outerHeight(true);
                }
                if ($('#node-input-templateScope').val() === "global") { height += 240; }
                var editorRow = $("#dialog-form>div.node-text-editor-row");
                height -= (parseInt(editorRow.css("marginTop")) + parseInt(editorRow.css("marginBottom")));
                $(".node-text-editor").css("height",height+"px");
                if (this.editor) { this.editor.resize(); }
            })

            this.editor = RED.editor.createEditor({
                id: 'node-input-format-editor',
                mode: 'ace/mode/html',
                value: $("#node-input-format").val()
            });

            RED.library.create({
                url:"uitemplates", // where to get the data from
                type:"ui_template", // the type of object the library is for
                editor:this.editor, // the field name the main text body goes to
                mode:"ace/mode/html",
                fields:['name']
            });

            this.editor.focus();

            RED.popover.tooltip($("#node-template-expand-editor"),c_("label.expand"));

            $("#node-template-expand-editor").on("click", function(e) {
                e.preventDefault();
                var value = that.editor.getValue();
                RED.editor.editText({
                    mode: 'html',
                    value: value,
                    width: "Infinity",
                    cursor: that.editor.getCursorPosition(),
                    complete: function(v,cursor) {
                        that.editor.setValue(v, -1);
                        that.editor.gotoLine(cursor.row+1,cursor.column,false);
                        setTimeout(function() { that.editor.focus(); },300);
                    }
                })
            })
        },
        oneditsave: function() {
            var annot = this.editor.getSession().getAnnotations();
            this.noerr = 0;
            $("#node-input-noerr").val(0);
            for (var k=0; k < annot.length; k++) {
                if (annot[k].type === "error") {
                    $("#node-input-noerr").val(annot.length);
                    this.noerr = annot.length;
                }
            }
            $("#node-input-format").val(this.editor.getValue());
            this.editor.destroy();
            delete this.editor;
        },
        oneditcancel: function() {
            this.editor.destroy();
            delete this.editor;
        },
        oneditresize: function(size) {
            var rows = $("#dialog-form>div:not(.node-text-editor-row)");
            var height = $("#dialog-form").height();
            for (var i=0; i<rows.size(); i++) {
                height = height - $(rows[i]).outerHeight(true);
            }
            if ($('#node-input-templateScope').val() === "global") { height += 232; }
            var editorRow = $("#dialog-form>div.node-text-editor-row");
            height -= (parseInt(editorRow.css("marginTop")) + parseInt(editorRow.css("marginBottom")));
            $(".node-text-editor").css("height",height+"px");
            this.editor.resize();
        }
    });
</script>

<script type="text/html" data-template-name="ui_template">
    <div class="form-row">
        <label for="node-input-format"><span data-i18n="ui_template.label.type"></span></label>
        <select style="width:76%" id="node-input-templateScope">
            <option value="local" data-i18n="ui_template.label.local"></option>
            <option value="global" data-i18n="ui_template.label.global"></option>
        </select>
    </div>
	<div class="form-row" id="template-row-group">
        <label for="node-input-group"><i class="fa fa-table"></i> <span data-i18n="ui_template.label.group"></span></label>
        <input type="text" id="node-input-group">
    </div>
    <div class="form-row" id="template-row-size">
        <label><i class="fa fa-object-group"></i> <span data-i18n="ui_template.label.size"></span></label>
        <input type="hidden" id="node-input-width">
        <input type="hidden" id="node-input-height">
        <button class="editor-button" id="node-input-size"></button>
    </div>
    <div class="form-row" id="template-row-class">
        <label for="node-input-className"><i class="fa fa-code"></i>  <span data-i18n="ui_template.label.className"></label>
        <input type="text" id="node-input-className" data-i18n="[placeholder]ui_template.label.classNamePlaceholder"/>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
        <div style="display:inline-block; width:calc(100% - 105px)">
            <input type="text" id="node-input-name" data-i18n="[placeholder]node-red:common.label.name">
        </div>
    </div>
    <div class="form-row" style="margin-bottom:0px;">
        <label for="node-input-format"><i class="fa fa-copy"></i> <span data-i18n="ui_template.label.template"></span></label>
        <input type="hidden" id="node-input-format">
        <button id="node-template-expand-editor" class="red-ui-button red-ui-button-small" style="float:right"><i class="fa fa-expand"></i></button>
    </div>
    <div class="form-row node-text-editor-row">
        <div style="height:250px; min-height:100px" class="node-text-editor" id="node-input-format-editor" ></div>
    </div>
    <div id="template-pass-store">
        <div class="form-row" style="margin-bottom:0px;">
            <input type="checkbox" id="node-input-fwdInMessages" style="display:inline-block; margin-left:8px; width:auto; vertical-align:top;">
            <label for="node-input-fwdInMessages" style="width:70%;"> <span data-i18n="ui_template.label.pass-through"></span></label>
        </div>
        <div class="form-row" style="margin-bottom:0px;">
            <input type="checkbox" id="node-input-storeOutMessages" style="display:inline-block; margin-left:8px; width:auto; vertical-align:top;">
            <label for="node-input-storeOutMessages" style="width:70%;"> <span data-i18n="ui_template.label.store-state"></span></label>
        </div>
        <div class="form-row" style="margin-bottom:0px;">
            <input type="checkbox" id="node-input-resendOnRefresh" style="display:inline-block; margin-left:8px; width:auto; vertical-align:top;">
            <label for="node-input-resendOnRefresh" style="width:70%;"> <span data-i18n="ui_template.label.resend"></span></label>
        </div>
    </div>
</script>
<script type="text/html" data-help-name="ui_template">
    <p>The template widget can contain any valid html and Angular/Angular-Material directives.</p>
    <p>This node can be used to create a dynamic user interface element that changes its appearance
    based on the input message and can send back messages to Node-RED.</p>
    <p><b>For example:</b><br>
    <pre style="font-size:smaller;">&lt;div layout=&quot;row&quot; layout-align=&quot;space-between&quot;&gt;
  &lt;p&gt;The number is&lt;/p&gt;
  &lt;font color=&quot;{{((msg.payload || 0) % 2 === 0) ? 'green' : 'red'}}&quot;&gt;
    {{(msg.payload || 0) % 2 === 0 ? 'even' : 'odd'}}
  &lt;/font&gt;
&lt;/div&gt;</pre>
    Will display if the number received as <code>msg.payload</code> is even or odd. It will also
    change the color of the text to green if the number is even or red if odd.<br/>
    The next example shows how to set a unique id for your template, pick up the default theme colour,
    and watch for any incoming message.</p>
    <pre style="font-size:smaller;">
&lt;div id="{{'my_'+$id}}" style="{{'color:'+theme.base_color}}"&gt;Some text&lt;/div&gt;
&lt;script&gt;
(function(scope) {
  scope.$watch('msg', function(msg) {
    if (msg) {
      // Do something when msg arrives
      $("#my_"+scope.$id).html(msg.payload);
    }
  });
})(scope);
&lt;/script&gt;</pre>
    <p>Templates made in this way can be copied and remain independent of each other.</p>
    <p><b>Sending a message:</b><br>
    <pre style="font-size:smaller;">
&lt;script&gt;
var value = "hello world";
// or overwrite value in your callback function ...
this.scope.action = function() { return value; }
&lt;/script&gt;
&lt;md-button ng-click=&quot;send({payload:action()})&quot;&gt;
    Click me to send a hello world
&lt;/md-button&gt;</pre>
    Will display a button that when clicked will send a message with the payload <code>'Hello world'</code>.</p>
    <p><b>Using <code>msg.template</code>:</b><br>
    You can also define the template content via <code>msg.template</code>, so you can use external files for example.<br>
    Template will be reloaded on input if it has changed.<br>
    Code written in the Template field will be ignored when <code>msg.template</code> is present.</p>
    <p>The following icon fonts are available: <a href="https://klarsys.github.io/angular-material-icons/" target="_blank">Material Design icon</a>
    <i>(e.g. 'check', 'close')</i> or a <a href="https://fontawesome.com/v4.7.0/icons/" target="_blank">Font Awesome icon</a>
    <i>(e.g. 'fa-fire')</i>, or a <a href="https://github.com/Paul-Reed/weather-icons-lite/blob/master/css_mappings.md">Weather icon</a>.
    You can use the full set of Google material icons if you add 'mi-' to the icon name. e.g. 'mi-videogame_asset'.</p>
    <p>If a <b>Class</b> is specified, it will be added to the parent card. This way you can style the card and the elements inside it with custom CSS. The Class can be set at runtime by setting a <code>msg.className</code> string property.</p>
</script>

<!-- --- [red-module:node-red-dashboard/ui_link] --- -->
<script type="text/javascript">
    RED.nodes.registerType('ui_link',{
        category: 'config',
        color: 'rgb( 63, 173, 181)',
        defaults: {
            name: {value: 'Google'},
            link: {value: 'https://www.google.com'},
            icon: {value: 'open_in_browser'},
            target: {value: 'newtab', validate :function() { return true; }},
            order: {value: 0},
            className: {value: ''}
        },
        inputs:0,
        outputs:0,
        hasUsers: false,
        align: "right",
        icon: "ui_link.png",
        paletteLabel: 'link',
        label: function() { return this.name || 'link'; },
        labelStyle: function() { return this.name?"node_label_italic":""; },
        oneditprepare: function() {
            document.getElementById('node-config-input-target-opentab').checked = (this.target === 'newtab');
            document.getElementById('node-config-input-target-openiframe').checked = (this.target === 'iframe');
            document.getElementById('node-config-input-target-openthis').checked = (this.target === 'thistab');
        },
        oneditsave : function () {
            var t = 'iframe';
            if (document.getElementById('node-config-input-target-opentab').checked) { t = 'newtab'; }
            if (document.getElementById('node-config-input-target-openthis').checked) { t = 'thistab'; }
            this.target = t;
        },
        onadd: function() {
            //console.log("PING");
        }
    });
</script>

<script type="text/html" data-template-name="ui_link">
    <div class="form-row">
        <label for="node-config-input-name"><i class="fa fa-tag"></i> <span data-i18n="ui_link.label.name"></span></label>
        <input type="text" id="node-config-input-name">
    </div>
    <div class="form-row">
        <label for="node-input-className"><i class="fa fa-code"></i>  <span data-i18n="ui_link.label.className"></label>
        <input type="text" id="node-input-className" data-i18n="[placeholder]ui_link.label.classNamePlaceholder"/>
    </div>
    <div class="form-row">
        <label for="node-config-input-link"><i class="fa fa-link"></i> <span data-i18n="ui_link.label.link"></span></label>
        <input type="text" id="node-config-input-link">
    </div>
    <div class="form-row">
        <label for="node-config-input-icon"><i class="fa fa-image"></i> <span data-i18n="ui_link.label.icon"></span></label>
        <input type="text" id="node-config-input-icon">
    </div>
    <div class="form-row">
        <label><i class="fa fa-link"></i> <span data-i18n="ui_link.label.open-in"></span></label>
        <input type="radio" id="node-config-input-target-opentab" name="open-link-method" style="width:20px; margin-top:0px; margin-bottom:5px" checked>
        <label for="node-config-input-target-opentab" data-i18n="ui_link.label.new-tab"></label><br/>
        <input type="radio" id="node-config-input-target-openthis" name="open-link-method" style="width:20px; margin-left:104px; margin-top:0px; margin-bottom:5px">
        <label for="node-config-input-target-openthis" data-i18n="ui_link.label.this-tab"></label><br/>
        <input type="radio" id="node-config-input-target-openiframe" name="open-link-method" style="width:20px; margin-left:104px; margin-top:0px; margin-bottom:5px">
        <label for="node-config-input-target-openiframe" data-i18n="ui_link.label.iframe"></label>
    </div>
    <div class="form-tips" data-i18n="[html]ui_link.tip"></div>
</script>
<script type="text/html" data-help-name="ui_link">
    <p>The <b>Icon</b> can be defined, as either a <a href="https://klarsys.github.io/angular-material-icons/" target="_blank">Material Design icon</a>
    <i>(e.g. 'check', 'close')</i> or a <a href="https://fontawesome.com/v4.7.0/icons/" target="_blank">Font Awesome icon</a>
    <i>(e.g. 'fa-fire')</i>, or a <a href="https://github.com/Paul-Reed/weather-icons-lite/blob/master/css_mappings.md">Weather icon</a>.
    You can use the full set of google material icons if you add 'mi-' to the icon name. e.g. 'mi-videogame_asset'.</p>
    <p>The <b>Open in</b> field controls whether the link opens in a <i>New Tab</i>, or if the link is opened within an <i>iframe</i> on the same page. Some sites, including Google, do not allow the rendering of their page inside an iframe. If you select the <i>iframe</i> option and the site does not show, this is simply because that site forbids the use of it inside an iframe.</p>
    <p>If a <b>Class</b> is specified, it will be added to the parent card. This way you can style the card and the elements inside it with custom CSS. The Class can be set at runtime by setting a <code>msg.className</code> string property.</p>
</script>

<!-- --- [red-module:node-red-dashboard/ui_tab] --- -->
<script type="text/javascript">
    // convert to i18 text
    function c_ui_tab(x) {
        return RED._("node-red-dashboard/ui_tab:ui_tab."+x);
    }

    RED.nodes.registerType('ui_tab',{
        category: 'config',
        defaults: {
            name: {value: c_ui_tab("label.home")},
            icon: {value: 'dashboard'},
            order: {value: 0},
            disabled: {value: false},
            hidden: {value: false}
        },
        paletteLabel: 'dashboard tab',
        label: function() { return this.name || c_ui_tab("label.tab"); },
        sort: function(A,B) {
            return A.order - B.order;
        },
        oneditprepare: function() {
            $("#node-config-input-disabled-btn").on("click", function(e) {
                var i = $(this).find("i");
                var active = i.hasClass("fa-toggle-on");
                var newCls = "fa fa-toggle-" + (active ? "off" : "on");
                i.attr("class", newCls);
                $("#node-config-input-disabled").prop('checked',active);

                var newTxt = c_ui_tab(active ? "label.disabled" : "label.enabled");
                $("#node-config-input-disabled-label").text(newTxt);

                var info = $("#node-config-input-disabled-info");
                var done = active ? info.show() : info.hide();
            });
            if (this.disabled) {
                $("#node-config-input-disabled-btn").click();
            }
            else {
                $("#node-config-input-disabled-label").text(c_ui_tab("label.enabled"));
            }

            $("#node-config-input-hidden-btn").on("click", function(e) {
                var i = $(this).find("i");
                var active = i.hasClass("fa-toggle-on");
                var newCls = "fa fa-toggle-" + (active ? "off" : "on");
                i.attr("class", newCls);
                $("#node-config-input-hidden").prop('checked',active);

                var newTxt = c_ui_tab(active ? "label.hidden" : "label.visible");
                $("#node-config-input-hidden-label").text(newTxt);

                var info = $("#node-config-input-hidden-info");
                var done = active ? info.show() : info.hide();
            });
            if (this.hidden) {
                $("#node-config-input-hidden-btn").click();
            }
            else {
                $("#node-config-input-hidden-label").text(c_ui_tab("label.visible"));
            }
        },
        oneditsave: function() {
            this.disabled = $("#node-config-input-disabled").prop("checked");
            this.hidden = $("#node-config-input-hidden").prop("checked");
        }
    });
</script>

<script type="text/html" data-template-name="ui_tab">
    <div class="form-row">
        <label for="node-config-input-name"><i class="fa fa-tag"></i> <span data-i18n="ui_tab.label.name"></span></label>
        <input type="text" id="node-config-input-name">
    </div>
    <div class="form-row">
        <label for="node-config-input-icon"><i class="fa fa-file-image-o"></i> <span data-i18n="ui_tab.label.icon"></span></label>
        <input type="text" id="node-config-input-icon">
    </div>
    <div class="form-row">
        <label for="node-config-input-disabled-btn"><i class="fa fa-ban"></i> <span data-i18n="ui_tab.label.state"></span></label>
        <button id="node-config-input-disabled-btn" class="editor-button" style="width:100px; margin-right:6px;"><i class="fa fa-toggle-on"></i> <span id="node-config-input-disabled-label"></span></button>
        <input type="checkbox" id="node-config-input-disabled" style="display:none;"/>
        <span id="node-config-input-disabled-info" data-i18n="[html]ui_tab.info.disabled" style="display:none;"></span>
    </div>
    <div class="form-row">
        <label for="node-config-input-hidden-btn"><i class="fa fa-eye-slash"></i> <span data-i18n="ui_tab.label.navmenu"></span></label>
        <button id="node-config-input-hidden-btn" class="editor-button" style="width:100px; margin-right:6px;"><i class="fa fa-toggle-on"></i> <span id="node-config-input-hidden-label"></span></button>
        <input type="checkbox" id="node-config-input-hidden" style="display:none;"/>
        <span id="node-config-input-hidden-info" data-i18n="[html]ui_tab.info.hidden" style="display:none;"></span>
    </div>
    <div class="form-tips" data-i18n="[html]ui_tab.tip"></div>
</script>
<script type="text/html" data-help-name="ui_tab">
    <p>Tab configuration for Dashboard</p>
    <p><b>Disabled</b> pages are not included in the Dashboard app, and are therefore not functional.
       The tab name still appears in the Navigation Menu (unless it is also hidden).
    </p>
    <p><b>Hidden</b> pages are not listed in the Left-hand Navigation Menu.
       However, they are still active in the Dashboard, and can be shown by using a `ui_control` msg.
    </p>
    <p>The <b>Icon</b> field can be either a <a href="https://klarsys.github.io/angular-material-icons/" target="_blank">Material Design icon</a>
    <i>(e.g. 'check', 'close')</i> or a <a href="https://fontawesome.com/v4.7.0/icons/" target="_blank">Font Awesome icon</a>
    <i>(e.g. 'fa-fire')</i>, or a <a href="https://github.com/Paul-Reed/weather-icons-lite/blob/master/css_mappings.md">Weather icon</a>.
    You can use the full set of google material icons if you add 'mi-' to the icon name. e.g. 'mi-videogame_asset'.</p>
</script>

<!-- --- [red-module:node-red-dashboard/ui_group] --- -->
<script type="text/javascript">
    // convert to i18 text
    function c_ui_group(x) {
        return RED._("node-red-dashboard/ui_group:ui_group."+x);
    }

    RED.nodes.registerType('ui_group',{
        category: 'config',
        defaults: {
            name: {value: c_ui_group("label.default")},
            tab: {type:"ui_tab", required: true },
            order: {value: 0},
            disp: {value: true},
            width: {value: 6},
            collapse: {value: false},
            disabled: {value: false},
            hidden: {value: false},
            className: {value: ''},
        },
        sort: function(A,B) {
            if (A.tab !== B.tab) {
                var tabA = RED.nodes.node(A.tab);
                var tabB = RED.nodes.node(B.tab);
                if (!tabA && tabB) {
                    return -1;
                }
                else if (tabA && !tabB) {
                    return 1;
                }
                else {
                    return tabA.order - tabB.order;
                }
            }
            return A.order - B.order;
        },
        paletteLabel: 'dashboard group',
        label: function() {
            var tabNode = RED.nodes.node(this.tab);
            if (tabNode) {
                return "["+(tabNode.name||c_ui_group("label.tab"))+"] " + (this.name || c_ui_group("label.group"));
            }
            return "["+c_ui_group("label.unassigned")+"] " + (this.name || c_ui_group("label.group"));
        },
        labelStyle: function() { return this.name?"node_label_italic":""; },
        oneditprepare: function() {
            $("#node-input-size").elementSizer({
                width: "#node-config-input-width",
                auto: false
            });
            $("#node-config-input-disp").on("change", function() {
                if ($("#node-config-input-disp").is(":checked")) {
                    $("#group-collapse-flag").show();
                }
                else {
                    $("#group-collapse-flag").hide();
                    $("#node-config-input-collapse").prop("checked",false);
                }
            });
        }
    });
</script>

<script type="text/html" data-template-name="ui_group">
    <div class="form-row">
        <label for="node-config-input-name"><i class="fa fa-tag"></i> <span data-i18n="ui_group.label.name"></span></label>
        <input type="text" id="node-config-input-name">
    </div>
    <div class="form-row">
        <label for="node-config-input-tab"><i class="fa fa-table"></i> <span data-i18n="ui_group.label.tab"></span></label>
        <input type="text" id="node-config-input-tab">
    </div>
    <div class="form-row">
        <label for="node-config-input-className"><i class="fa fa-code"></i>  <span data-i18n="ui_group.label.className"></label>
        <input type="text" id="node-config-input-className" data-i18n="[placeholder]ui_group.label.classNamePlaceholder"/>
    </div>
    <div class="form-row">
        <label for="node-config-input-width"><i class="fa fa-arrows-h"></i> <span data-i18n="ui_group.label.width"></span></label>
        <input type="hidden" id="node-config-input-width">
        <button class="editor-button" id="node-input-size"></button>
    </div>
    <div class="form-row">
        <input style="margin:8px 0 10px 102px; width:20px;" type="checkbox" checked id="node-config-input-disp"> <label style="width:auto" for="node-config-input-disp"><span data-i18n="ui_group.display-name"></span></label>
    </div>
    <div class="form-row" id="group-collapse-flag">
        <input style="margin:8px 0 10px 102px; width:20px;" type="checkbox" id="node-config-input-collapse"> <label style="width:auto" for="node-config-input-collapse"><span data-i18n="ui_group.collapse-name"></span></label>
    </div>
</script>
<script type="text/html" data-help-name="ui_group">
    <p>Group</p>
    <p>If a <b>Class</b> is specified, it will be added to the parent card. This way you can style the card and the elements inside it with custom CSS. The Class can be set at runtime by setting a <code>msg.className</code> string property.</p>
</script>

<!-- --- [red-module:node-red-dashboard/ui_spacer] --- -->
<script type="text/javascript">
    RED.nodes.registerType('ui_spacer', {
        category: 'config',
        color: '#D4F0F8',
        defaults: {
            name: {value: "spacer"},
            group: {type: 'ui_group', required:true},
            order: {value: 0},
            width: {value: 0, validate: function(v) {
                    var width = v||0;
                    var currentGroup = $('#node-input-group').val()||this.group;
                    var groupNode = RED.nodes.node(currentGroup);
                    var valid = !groupNode || +width <= +groupNode.width;
                    $("#node-input-size").toggleClass("input-error",!valid);
                    return valid;
                }
            },
            height: {value: 0},
            className: {value: ''}
        },
        z: RED.workspaces.active(),
        inputs:0,
        outputs:0,
        hasUsers: false,
        icon: "ui_spacer.png",
        paletteLabel: 'spacer',
        label: function() { return this.name + " " + this.width + "x" + this.height; },
        labelStyle: function() { return this.name?"node_label_italic":""; },
        oneditprepare: function() {
            $("#node-input-size").elementSizer({
                width: "#node-input-width",
                height: "#node-input-height",
                group: "#node-input-group"
            });
        },
        oneditsave: function() {
            this.width = $("#node-input-width").val();
            this.height = $("#node-input-height").val();
        }
    });
</script>

<script type="text/html" data-template-name="ui_spacer">
    <div class="form-row">
        <label for="node-input-group"><i class="fa fa-table"></i> Group</label>
        <input type="text" id="node-input-group">
    </div>
    <div class="form-row">
        <label><i class="fa fa-object-group"></i> Size</label>
        <input type="hidden" id="node-input-width">
        <input type="hidden" id="node-input-height">
        <button class="editor-button" id="node-input-size"></button>
    </div>
    <div class="form-row">
        <label for="node-input-className"><i class="fa fa-code"></i>  Class</label>
        <input type="text" id="node-input-className" placeholder="Optional CSS class name(s) for widget"/>
    </div>
</script>
<script type="text/html" data-help-name="ui_spacer">
    <p>If a <b>Class</b> is specified, it will be added to the parent card. This way you can style the card and the elements inside it with custom CSS. The Class can be set at runtime by setting a <code>msg.className</code> string property.</p>
</script>

<!-- --- [red-module:node-red-node-base64/base64] --- -->

<script type="text/html" data-template-name="base64">
    <div class="form-row">
        <label for="node-input-action"><i class="fa fa-dot-circle-o"></i> <span data-i18n="base64.label.action"></span></label>
        <select style="width:70%" id="node-input-action">
            <option value="" data-i18n="base64.convert.buffer"></option>
            <option value="str" data-i18n="base64.convert.encode"></option>
            <option value="b64" data-i18n="base64.convert.decode"></option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-property"><i class="fa fa-ellipsis-h"></i> <span data-i18n="node-red:common.label.property"></span></label>
        <input type="text" id="node-input-property" style="width:70%;"/>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]node-red:common.label.name">
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('base64',{
        category: 'parser',
        color:"#DEBD5C",
        defaults: {
            name: {value:""},
            action: {value:""},
            property: {value:"payload",required:true}
        },
        inputs:1,
        outputs:1,
        icon: "parser-base64.png",
        label: function() {
            return this.name||"base64";
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            if (this.property === undefined) {
                $("#node-input-property").val("payload");
            }
            $("#node-input-property").typedInput({default:'msg',types:['msg']});
        }
    });
</script>
<script type="text/html" data-help-name="base64">
    <p>A function that converts the chosen property (default <code>msg.payload</code>) to and from base64 format.</p>
    <p>If the input is a buffer it converts it to a Base64 encoded string.</p>
    <p>If the input is a Base64 string it converts it back to a binary buffer.</p>
    <p>You can also fix coding into base64, and base64 to buffer if required.</p>
    <p>Note: Using "Encode to Base64" will encode an already encoded string.</p>
</script>

<!-- --- [red-module:node-red-node-markdown/markdown] --- -->

<script type="text/html" data-template-name="markdown">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>



<script type="text/javascript">
    RED.nodes.registerType('markdown',{
        category: 'parser',
        color:"#DEBD5C",
        defaults: {
            name: {value:""}
        },
        inputs:1,
        outputs:1,
        icon: "parser-markdown.png",
        label: function() {
            return this.name||"markdown";
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        }
    });
</script>
<script type="text/html" data-help-name="markdown">
    <p>A function that converts the <code>msg.payload</code> in markdown format to html.</p>
    <p>If the input is a string it converts it to html.</p>
    <p>All other message types are ignored.</p>
    <p>Uses the markdown-it library - You can see a demo
        <a href="https://markdown-it.github.io/">here</a>.</p>
    <p>It is configured with html, linkify and typographer options turned on.</p>

</script>